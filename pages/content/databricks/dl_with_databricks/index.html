<!doctype html><html style="overflow:auto;height:auto;width:auto;"><head><title>deep_learning_with_databricks</title><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><style>@font-face {
	font-family: Asana;
	src: url("fonts/Asana-Math.otf") format("opentype");
}

@font-face {
	font-family: Asana-Math;
	src: url("fonts/Asana-math-mode.otf") format("opentype");
}

@font-face {
	font-family: Asana-Mathbb;
	src: url("fonts/types-generated/Asana-mathbb.otf") format("opentype");
}

@font-face {
	font-family: Asana-Mathit;
	src: url("fonts/types-generated/Asana-mathit.otf") format("opentype");
}

@font-face {
	font-family: Asana-Mathcal;
	src: url("fonts/types-generated/Asana-mathcal.otf") format("opentype");
}

@font-face {
	font-family: Asana-Mathscr;
	src: url("fonts/types-generated/Asana-mathscr.otf") format("opentype");
}

@font-face {
	font-family: Asana-Mathfrak;
	src: url("fonts/types-generated/Asana-mathfrak.otf") format("opentype");
}

@font-face {
	font-family: Asana-Mathsf;
	src: url("fonts/types-generated/Asana-mathsf.otf") format("opentype");
}

@font-face {
	font-family: Asana-Mathtt;
	src: url("fonts/types-generated/Asana-mathtt.otf") format("opentype");
}

@font-face {
	font-family: Asana-Mathrm;
	src: url("fonts/types-generated/Asana-mathrm.otf") format("opentype");
}

@font-face {
	font-family: 'FontAwesome';
	src: url('fonts/icomoon.eot');
	src: url('fonts/icomoon.eot') format('embedded-opentype'), url('fonts/icomoon.woff') format('woff'), url('fonts/icomoon.ttf') format('truetype'), url('fonts/icomoon.svg') format('svg');
	font-weight: normal;
	font-style: normal;
}

/**
Latin Modern
**/

@font-face {
	font-family: LatinModern;
	src: url("fonts/latinmodern-math.otf") format("opentype");
}

@font-face {
	font-family: LatinModern-Math;
	src: url("fonts/latinmodern-math-mode.otf") format("opentype");
}

@font-face {
	font-family: LatinModern-Mathbb;
	src: url("fonts/types-generated/latinmodern-mathbb.otf") format("opentype");
}

@font-face {
	font-family: LatinModern-Mathit;
	src: url("fonts/types-generated/latinmodern-mathit.otf") format("opentype");
}

@font-face {
	font-family: LatinModern-Mathcal;
	src: url("fonts/types-generated/latinmodern-mathcal.otf") format("opentype");
}

@font-face {
	font-family: LatinModern-Mathscr;
	src: url("fonts/types-generated/latinmodern-mathscr.otf") format("opentype");
}

@font-face {
	font-family: LatinModern-Mathfrak;
	src: url("fonts/types-generated/latinmodern-mathfrak.otf") format("opentype");
}

@font-face {
	font-family: LatinModern-Mathsf;
	src: url("fonts/types-generated/latinmodern-mathsf.otf") format("opentype");
}

@font-face {
	font-family: LatinModern-Mathtt;
	src: url("fonts/types-generated/latinmodern-mathtt.otf") format("opentype");
}

@font-face {
	font-family: LatinModern-Mathrm;
	src: url("fonts/types-generated/latinmodern-mathrm.otf") format("opentype");
}

/***********************************************************/

/**
Thicker Latin Modern
**/

@font-face {
	font-family: ThickerLm;
	src: url("fonts/thickerlm-math.otf") format("opentype");
}

@font-face {
	font-family: ThickerLm-Math;
	src: url("fonts/thickerlm-math-mode.otf") format("opentype");
}

@font-face {
	font-family: ThickerLm-Mathbb;
	src: url("fonts/types-generated/thickerlm-mathbb.otf") format("opentype");
}

@font-face {
	font-family: ThickerLm-Mathit;
	src: url("fonts/types-generated/thickerlm-mathit.otf") format("opentype");
}

@font-face {
	font-family: ThickerLm-Mathcal;
	src: url("fonts/types-generated/thickerlm-mathcal.otf") format("opentype");
}

@font-face {
	font-family: ThickerLm-Mathscr;
	src: url("fonts/types-generated/thickerlm-mathscr.otf") format("opentype");
}

@font-face {
	font-family: ThickerLm-Mathfrak;
	src: url("fonts/types-generated/thickerlm-mathfrak.otf") format("opentype");
}

@font-face {
	font-family: ThickerLm-Mathsf;
	src: url("fonts/types-generated/thickerlm-mathsf.otf") format("opentype");
}

@font-face {
	font-family: ThickerLm-Mathtt;
	src: url("fonts/types-generated/thickerlm-mathtt.otf") format("opentype");
}

@font-face {
	font-family: ThickerLm-Mathrm;
	src: url("fonts/types-generated/thickerlm-mathrm.otf") format("opentype");
}

/***********************************************************/

/* Computer Modern */

@font-face {
	font-family: 'Computer Modern Sans';
	src: url('fonts/others-text-mode/computer-modern/Sans/cmunss.otf') format("opentype");
	font-weight: normal;
	font-style: normal;
}

@font-face {
	font-family: 'Computer Modern Sans';
	src: url('fonts/others-text-mode/computer-modern/Sans/cmunsx.otf') format("opentype");
	font-weight: bold;
	font-style: normal;
}

@font-face {
	font-family: 'Computer Modern Sans';
	src: url('fonts/others-text-mode/computer-modern/Sans/cmunsi.otf') format("opentype");
	font-weight: normal;
	font-style: italic;
}

@font-face {
	font-family: 'Computer Modern Sans';
	src: url('fonts/others-text-mode/computer-modern/Sans/cmunso.otf') format("opentype");
	font-weight: bold;
	font-style: italic;
}

@font-face {
	font-family: 'Computer Modern Serif';
	src: url('fonts/others-text-mode/computer-modern/Serif/cmunrm.otf') format("opentype");
	font-weight: normal;
	font-style: normal;
}

@font-face {
	font-family: 'Computer Modern Serif';
	src: url('fonts/others-text-mode/computer-modern/Serif/cmunbx.otf') format("opentype");
	font-weight: bold;
	font-style: normal;
}

@font-face {
	font-family: 'Computer Modern Serif';
	src: url('fonts/others-text-mode/computer-modern/Serif/cmunti.otf') format("opentype");
	font-weight: normal;
	font-style: italic;
}

@font-face {
	font-family: 'Computer Modern Serif';
	src: url('fonts/others-text-mode/computer-modern/Serif/cmunbi.otf') format("opentype");
	font-weight: bold;
	font-style: italic;
}

@font-face {
	font-family: 'Computer Modern Typewriter';
	src: url('fonts/others-text-mode/computer-modern/Typewriter/cmuntt.otf') format("opentype");
	font-weight: normal;
	font-style: normal;
}

@font-face {
	font-family: 'Computer Modern Typewriter';
	src: url('fonts/others-text-mode/computer-modern/Typewriter/cmuntb.otf') format("opentype");
	font-weight: bold;
	font-style: normal;
}

@font-face {
	font-family: 'Computer Modern Typewriter';
	src: url('fonts/others-text-mode/computer-modern/Typewriter/cmunit.otf') format("opentype");
	font-weight: normal;
	font-style: italic;
}

@font-face {
	font-family: 'Computer Modern Typewriter';
	src: url('fonts/others-text-mode/computer-modern/Typewriter/cmuntx.otf') format("opentype");
	font-weight: bold;
	font-style: italic;
}

/**/

/**
Sans Math + Liberation Font
**/

@font-face {
	font-family: Sans;
	src: url("fonts/Sans-Math.otf") format("opentype");
}

@font-face {
	font-family: Sans-Math;
	src: url("fonts/Sans-Math-mode.otf") format("opentype");
}

@font-face {
	font-family: Sans-Bold;
	src: url("fonts/types-generated/Sans-bold.otf") format("opentype");
	font-weight: bold;
}

@font-face {
	font-family: Sans-Mathbb;
	src: url("fonts/types-generated/Asana-mathbb.otf") format("opentype");
}

@font-face {
	font-family: Sans-Mathit;
	src: url("fonts/types-generated/Sans-mathit.otf") format("opentype");
}

@font-face {
	font-family: Sans-Mathcal;
	src: url("fonts/types-generated/Asana-mathcal.otf") format("opentype");
}

@font-face {
	font-family: Sans-Mathscr;
	src: url("fonts/types-generated/Asana-mathscr.otf") format("opentype");
}

@font-face {
	font-family: Sans-Mathfrak;
	src: url("fonts/types-generated/Asana-mathfrak.otf") format("opentype");
}

@font-face {
	font-family: Sans-Mathsf;
	src: url("fonts/types-generated/Asana-mathsf.otf") format("opentype");
}

@font-face {
	font-family: Sans-Mathtt;
	src: url("fonts/types-generated/Asana-mathtt.otf") format("opentype");
}

@font-face {
	font-family: Sans-Mathrm;
	src: url("fonts/types-generated/Asana-mathrm.otf") format("opentype");
}

@font-face {
	font-family: Sans-Mathbf;
	src: url("fonts/types-generated/Sans-mathbf.otf") format("opentype");
	font-weight: bold;
}

/***********************************************************/</style><style>

compositeblock {
  display: inline-block;
  position: relative;
  text-align: left;
  unicode-bidi: isolate;
}
compositeblock.middle {
  vertical-align: middle;
}
latex-symbol-icon {
  display: inline-block;
  padding: 2px;
  border: 1px solid transparent;
  cursor: pointer;
}
latex-symbol-icon:hover,
latex-symbol-icon.selected {
  background: white;
  border: 1px solid lightgray;
}
inline {
  display: inline-block;
}
base-line-indicator {
  display: inline-block;
  overflow: hidden;
  width: 0px;
  height: inherit;
}

math-type .constant-text > constant-text {
  margin-left: 0.2em;
  margin-right: 0.2em;
}
math-type .constant-text > constant-text.close-left {
  margin-left: 0;
}
math-type .constant-text > constant-text.close-right {
  margin-right: 0;
}



/**different context*/
/**different context*/
math-type ref-tag {
  position: absolute;
  right: 5px;
  top: 50%;
  transform: translate(0, -50%);
  z-index: 8;
  cursor: pointer;
}
math-type ref-tag > label {
  cursor: pointer;
}
math-type ref-tag:hover {
  text-decoration: underline;
}
math-type ref-tag.line-tag {
  transition: background 0.4s;
}
math-type ref-tag.empty-line-tag {
  opacity: 0.5;
  animation: fadein 0.5s;
}
math-type tr.math-row ref-tag {
  left: calc(100% + 20px);
  right: unset;
}
@keyframes fadein {
  0% {
    opacity: 0;
  }
  70% {
    opacity: 0;
  }
  100% {
    opacity: 0.5;
  }
}







.color-picker no-color-select {
  display: block;
  text-align: center;
  /* width: 100%; */
  /* height: 20px; */
  background: white;
  border: 1px solid lightgray;
  margin-bottom: 2px;
  color: gray;
  padding: 2px;
  cursor: default;
  border-radius: 0;
  padding-bottom: 2px;
  margin-bottom: 3px;
  margin-left: -1px;
  margin-right: -1px;
  font-size: 13px;
}
.color-picker no-color-select:hover {
  color: black;
}
.color-picker color-select {
  position: absolute;
  top: 30px;
  left: 0px;
  background: white;
}

/**we use alpha as we have problem with background (without alpha) in Electron version (older Chrome) **/
/* z-index region*/
/**different context*/
/**different context*/
math-type editarea.no-area-container,
math-type editarea.text-mode,
math-type area-container,
math-type .print-as-area-container {
  display: flex;
  flex-direction: column;
  align-items: stretch;
}
math-type editarea.no-area-container > line,
math-type editarea.text-mode > line,
math-type area-container > line,
math-type .print-as-area-container > line {
  min-width: 0.3em;
  position: relative;
  display: block;
  width: 100%;
  align-items: baseline;
  flex-wrap: wrap;
  box-sizing: border-box;
  flex-wrap: nowrap;
  line-height: 1.2;
  white-space: nowrap;
}
math-type editarea.no-area-container > line block,
math-type editarea.text-mode > line block,
math-type area-container > line block,
math-type .print-as-area-container > line block {
  white-space: pre;
}
math-type editarea.no-area-container > line.single-block > blocks > baselineblock,
math-type editarea.text-mode > line.single-block > blocks > baselineblock,
math-type area-container > line.single-block > blocks > baselineblock,
math-type .print-as-area-container > line.single-block > blocks > baselineblock {
  display: none;
}
math-type editarea.no-area-container > line > blocks,
math-type editarea.text-mode > line > blocks,
math-type area-container > line > blocks,
math-type .print-as-area-container > line > blocks {
  /**
            Different between inline and inline-block is about whether Section Text will be wrap in next wrapped line 
            */
  display: inline-block;
  text-align: left;
}
math-type editarea.no-area-container > line.root,
math-type editarea.text-mode > line.root,
math-type area-container > line.root,
math-type .print-as-area-container > line.root,
math-type editarea.no-area-container > line.text-mode,
math-type editarea.text-mode > line.text-mode,
math-type area-container > line.text-mode,
math-type .print-as-area-container > line.text-mode {
  display: block;
  font-style: normal;
}
math-type editarea.no-area-container > line.root > prefix,
math-type editarea.text-mode > line.root > prefix,
math-type area-container > line.root > prefix,
math-type .print-as-area-container > line.root > prefix,
math-type editarea.no-area-container > line.text-mode > prefix,
math-type editarea.text-mode > line.text-mode > prefix,
math-type area-container > line.text-mode > prefix,
math-type .print-as-area-container > line.text-mode > prefix {
  white-space: pre;
  display: inline-block;
  cursor: default;
  text-align: left;
}
math-type editarea.no-area-container > line.root > blocks,
math-type editarea.text-mode > line.root > blocks,
math-type area-container > line.root > blocks,
math-type .print-as-area-container > line.root > blocks,
math-type editarea.no-area-container > line.text-mode > blocks,
math-type editarea.text-mode > line.text-mode > blocks,
math-type area-container > line.text-mode > blocks,
math-type .print-as-area-container > line.text-mode > blocks {
  /** should not wrap here*/
  align-items: baseline;
  box-sizing: border-box;
}
math-type editarea.no-area-container > line.root > blocks > block,
math-type editarea.text-mode > line.root > blocks > block,
math-type area-container > line.root > blocks > block,
math-type .print-as-area-container > line.root > blocks > block,
math-type editarea.no-area-container > line.text-mode > blocks > block,
math-type editarea.text-mode > line.text-mode > blocks > block,
math-type area-container > line.text-mode > blocks > block,
math-type .print-as-area-container > line.text-mode > blocks > block {
  white-space: pre-wrap;
  white-space: break-spaces;
}
math-type editarea.no-area-container > line.root.full-line-block-inside > prefix,
math-type editarea.text-mode > line.root.full-line-block-inside > prefix,
math-type area-container > line.root.full-line-block-inside > prefix,
math-type .print-as-area-container > line.root.full-line-block-inside > prefix,
math-type editarea.no-area-container > line.text-mode.full-line-block-inside > prefix,
math-type editarea.text-mode > line.text-mode.full-line-block-inside > prefix,
math-type area-container > line.text-mode.full-line-block-inside > prefix,
math-type .print-as-area-container > line.text-mode.full-line-block-inside > prefix {
  float: left;
  vertical-align: top;
}
math-type editarea.no-area-container > line.root.full-line-block-inside > blocks,
math-type editarea.text-mode > line.root.full-line-block-inside > blocks,
math-type area-container > line.root.full-line-block-inside > blocks,
math-type .print-as-area-container > line.root.full-line-block-inside > blocks,
math-type editarea.no-area-container > line.text-mode.full-line-block-inside > blocks,
math-type editarea.text-mode > line.text-mode.full-line-block-inside > blocks,
math-type area-container > line.text-mode.full-line-block-inside > blocks,
math-type .print-as-area-container > line.text-mode.full-line-block-inside > blocks {
  display: block;
  width: 100%;
}
math-type editarea.no-area-container > line.root.full-line-block-inside > blocks > baselineblock,
math-type editarea.text-mode > line.root.full-line-block-inside > blocks > baselineblock,
math-type area-container > line.root.full-line-block-inside > blocks > baselineblock,
math-type .print-as-area-container > line.root.full-line-block-inside > blocks > baselineblock,
math-type editarea.no-area-container > line.text-mode.full-line-block-inside > blocks > baselineblock,
math-type editarea.text-mode > line.text-mode.full-line-block-inside > blocks > baselineblock,
math-type area-container > line.text-mode.full-line-block-inside > blocks > baselineblock,
math-type .print-as-area-container > line.text-mode.full-line-block-inside > blocks > baselineblock {
  display: inline-block;
  float: left;
}
math-type editarea.no-area-container > line.root.has-rtl.align-justify,
math-type editarea.text-mode > line.root.has-rtl.align-justify,
math-type area-container > line.root.has-rtl.align-justify,
math-type .print-as-area-container > line.root.has-rtl.align-justify,
math-type editarea.no-area-container > line.text-mode.has-rtl.align-justify,
math-type editarea.text-mode > line.text-mode.has-rtl.align-justify,
math-type area-container > line.text-mode.has-rtl.align-justify,
math-type .print-as-area-container > line.text-mode.has-rtl.align-justify {
  direction: rtl;
}
math-type editarea.no-area-container > line.root.section,
math-type editarea.text-mode > line.root.section,
math-type area-container > line.root.section,
math-type .print-as-area-container > line.root.section,
math-type editarea.no-area-container > line.text-mode.section,
math-type editarea.text-mode > line.text-mode.section,
math-type area-container > line.text-mode.section,
math-type .print-as-area-container > line.text-mode.section {
  text-align: left;
}
math-type editarea.no-area-container > line.root.section > blocks,
math-type editarea.text-mode > line.root.section > blocks,
math-type area-container > line.root.section > blocks,
math-type .print-as-area-container > line.root.section > blocks,
math-type editarea.no-area-container > line.text-mode.section > blocks,
math-type editarea.text-mode > line.text-mode.section > blocks,
math-type area-container > line.text-mode.section > blocks,
math-type .print-as-area-container > line.text-mode.section > blocks {
  /**
                    Different between inline and inline-block is about whether Section Text will be wrap in next wrapped line 
                    */
  display: inline;
}
math-type editarea.no-area-container > line.root.section.has-rtl,
math-type editarea.text-mode > line.root.section.has-rtl,
math-type area-container > line.root.section.has-rtl,
math-type .print-as-area-container > line.root.section.has-rtl,
math-type editarea.no-area-container > line.text-mode.section.has-rtl,
math-type editarea.text-mode > line.text-mode.section.has-rtl,
math-type area-container > line.text-mode.section.has-rtl,
math-type .print-as-area-container > line.text-mode.section.has-rtl {
  direction: rtl;
}
math-type editarea.no-area-container > line.root.section.has-rtl > prefix,
math-type editarea.text-mode > line.root.section.has-rtl > prefix,
math-type area-container > line.root.section.has-rtl > prefix,
math-type .print-as-area-container > line.root.section.has-rtl > prefix,
math-type editarea.no-area-container > line.text-mode.section.has-rtl > prefix,
math-type editarea.text-mode > line.text-mode.section.has-rtl > prefix,
math-type area-container > line.text-mode.section.has-rtl > prefix,
math-type .print-as-area-container > line.text-mode.section.has-rtl > prefix {
  direction: rtl;
  order: 1;
}
math-type editarea.no-area-container > line.root.theorem,
math-type editarea.text-mode > line.root.theorem,
math-type area-container > line.root.theorem,
math-type .print-as-area-container > line.root.theorem,
math-type editarea.no-area-container > line.text-mode.theorem,
math-type editarea.text-mode > line.text-mode.theorem,
math-type area-container > line.text-mode.theorem,
math-type .print-as-area-container > line.text-mode.theorem {
  padding-top: 0.3em;
  padding-bottom: 0.3em;
}
math-type editarea.no-area-container > line > prefix,
math-type editarea.text-mode > line > prefix,
math-type area-container > line > prefix,
math-type .print-as-area-container > line > prefix {
  text-align: right;
}
math-type editarea.no-area-container > line.has-indent,
math-type editarea.text-mode > line.has-indent,
math-type area-container > line.has-indent,
math-type .print-as-area-container > line.has-indent {
  display: flex;
  justify-content: flex-start;
}
math-type editarea.no-area-container > line.has-rtl.has-indent > prefix,
math-type editarea.text-mode > line.has-rtl.has-indent > prefix,
math-type area-container > line.has-rtl.has-indent > prefix,
math-type .print-as-area-container > line.has-rtl.has-indent > prefix {
  direction: rtl;
  order: 1;
}
math-type editarea.no-area-container > line.has-rtl.has-indent.indent-0,
math-type editarea.text-mode > line.has-rtl.has-indent.indent-0,
math-type area-container > line.has-rtl.has-indent.indent-0,
math-type .print-as-area-container > line.has-rtl.has-indent.indent-0 {
  padding-left: 0;
  padding-right: 30px;
}
math-type editarea.no-area-container > line.has-rtl.has-indent.indent-1,
math-type editarea.text-mode > line.has-rtl.has-indent.indent-1,
math-type area-container > line.has-rtl.has-indent.indent-1,
math-type .print-as-area-container > line.has-rtl.has-indent.indent-1 {
  padding-left: 0;
  padding-right: 65px;
}
math-type editarea.no-area-container > line.has-rtl.has-indent.indent-2,
math-type editarea.text-mode > line.has-rtl.has-indent.indent-2,
math-type area-container > line.has-rtl.has-indent.indent-2,
math-type .print-as-area-container > line.has-rtl.has-indent.indent-2 {
  padding-left: 0;
  padding-right: 105px;
}
math-type editarea.no-area-container > line.has-rtl.has-indent.indent-3,
math-type editarea.text-mode > line.has-rtl.has-indent.indent-3,
math-type area-container > line.has-rtl.has-indent.indent-3,
math-type .print-as-area-container > line.has-rtl.has-indent.indent-3 {
  padding-left: 0;
  padding-right: 145px;
}
math-type editarea.no-area-container > line.has-rtl.has-indent.indent-4,
math-type editarea.text-mode > line.has-rtl.has-indent.indent-4,
math-type area-container > line.has-rtl.has-indent.indent-4,
math-type .print-as-area-container > line.has-rtl.has-indent.indent-4 {
  padding-left: 0;
  padding-right: 185px;
}
math-type editarea.no-area-container > line.indent-0,
math-type editarea.text-mode > line.indent-0,
math-type area-container > line.indent-0,
math-type .print-as-area-container > line.indent-0 {
  padding-left: 30px;
}
math-type editarea.no-area-container > line.indent-1,
math-type editarea.text-mode > line.indent-1,
math-type area-container > line.indent-1,
math-type .print-as-area-container > line.indent-1 {
  padding-left: 65px;
}
math-type editarea.no-area-container > line.indent-2,
math-type editarea.text-mode > line.indent-2,
math-type area-container > line.indent-2,
math-type .print-as-area-container > line.indent-2 {
  padding-left: 105px;
}
math-type editarea.no-area-container > line.indent-3,
math-type editarea.text-mode > line.indent-3,
math-type area-container > line.indent-3,
math-type .print-as-area-container > line.indent-3 {
  padding-left: 145px;
}
math-type editarea.no-area-container > line.indent-4,
math-type editarea.text-mode > line.indent-4,
math-type area-container > line.indent-4,
math-type .print-as-area-container > line.indent-4 {
  padding-left: 185px;
}
math-type editarea.no-area-container > line.math-container-selected,
math-type editarea.text-mode > line.math-container-selected,
math-type area-container > line.math-container-selected,
math-type .print-as-area-container > line.math-container-selected {
  outline: 1px solid rgba(93, 92, 92, 0.3);
}
math-type editarea.no-area-container > line.math-container,
math-type editarea.text-mode > line.math-container,
math-type area-container > line.math-container,
math-type .print-as-area-container > line.math-container {
  font-family: 'Asana';
  justify-content: center;
  text-align: center;
  text-align-last: auto;
  display: flex;
}
math-type editarea.no-area-container > line.math-container block,
math-type editarea.text-mode > line.math-container block,
math-type area-container > line.math-container block,
math-type .print-as-area-container > line.math-container block {
  white-space: pre;
}
math-type editarea.no-area-container > line.align-center,
math-type editarea.text-mode > line.align-center,
math-type area-container > line.align-center,
math-type .print-as-area-container > line.align-center {
  text-align: center;
  text-align-last: auto;
}
math-type editarea.no-area-container > line.align-center.has-indent,
math-type editarea.text-mode > line.align-center.has-indent,
math-type area-container > line.align-center.has-indent,
math-type .print-as-area-container > line.align-center.has-indent {
  justify-content: center;
}
math-type editarea.no-area-container > line.align-center.section,
math-type editarea.text-mode > line.align-center.section,
math-type area-container > line.align-center.section,
math-type .print-as-area-container > line.align-center.section {
  text-align: center;
  text-align-last: auto;
}
math-type editarea.no-area-container > line.align-center > blocks,
math-type editarea.text-mode > line.align-center > blocks,
math-type area-container > line.align-center > blocks,
math-type .print-as-area-container > line.align-center > blocks {
  text-align: center;
  text-align-last: auto;
}
math-type editarea.no-area-container > line.align-justify,
math-type editarea.text-mode > line.align-justify,
math-type area-container > line.align-justify,
math-type .print-as-area-container > line.align-justify {
  text-align: justify;
}
math-type editarea.no-area-container > line.align-justify.section,
math-type editarea.text-mode > line.align-justify.section,
math-type area-container > line.align-justify.section,
math-type .print-as-area-container > line.align-justify.section {
  text-align: justify;
}
math-type editarea.no-area-container > line.align-justify > blocks,
math-type editarea.text-mode > line.align-justify > blocks,
math-type area-container > line.align-justify > blocks,
math-type .print-as-area-container > line.align-justify > blocks {
  text-align: justify;
}
math-type editarea.no-area-container > line.align-left,
math-type editarea.text-mode > line.align-left,
math-type area-container > line.align-left,
math-type .print-as-area-container > line.align-left {
  text-align: left;
}
math-type editarea.no-area-container > line.align-left > blocks,
math-type editarea.text-mode > line.align-left > blocks,
math-type area-container > line.align-left > blocks,
math-type .print-as-area-container > line.align-left > blocks {
  text-align: left;
}
math-type editarea.no-area-container > line.align-right,
math-type editarea.text-mode > line.align-right,
math-type area-container > line.align-right,
math-type .print-as-area-container > line.align-right {
  text-align: right;
}
math-type editarea.no-area-container > line.align-right.has-indent,
math-type editarea.text-mode > line.align-right.has-indent,
math-type area-container > line.align-right.has-indent,
math-type .print-as-area-container > line.align-right.has-indent {
  justify-content: flex-end;
}
math-type editarea.no-area-container > line.align-right.section,
math-type editarea.text-mode > line.align-right.section,
math-type area-container > line.align-right.section,
math-type .print-as-area-container > line.align-right.section {
  text-align: right;
}
math-type editarea.no-area-container > line.align-right > blocks,
math-type editarea.text-mode > line.align-right > blocks,
math-type area-container > line.align-right > blocks,
math-type .print-as-area-container > line.align-right > blocks {
  text-align: right;
}
math-type editarea.no-area-container > line > blocks > block,
math-type editarea.text-mode > line > blocks > block,
math-type area-container > line > blocks > block,
math-type .print-as-area-container > line > blocks > block {
  display: inline;
}
math-type editarea.no-area-container,
math-type area-container {
  align-items: initial;
}
math-type editarea.root-editor {
  align-items: initial;
  display: block;
  color: black;
  fill: black;
  stroke: black;
  border-color: black;
}
math-type editarea.root-editor.read-only {
  cursor: default;
}
math-type editarea.root-editor.read-only block {
  cursor: default;
}
math-type editarea.root-editor > area-container {
  display: block;
}
math-type area-container {
  width: 100%;
}
math-type block {
  cursor: text;
}
math-type editarea {
  box-sizing: border-box;
  display: flex;
  overflow-x: visible;
  align-items: center;
  justify-content: center;
  flex-direction: row;
  flex-wrap: nowrap;
}
math-type editarea block {
  cursor: text;
}
math-type editarea.high-order {
  position: relative;
  z-index: 10;
}
math-type editarea.selected {
  outline: 1px solid rgba(93, 92, 92, 0.3);
}
math-type editarea.bordered {
  outline: 1px solid rgba(93, 92, 92, 0.3);
}
math-type editarea.center > area-container > line,
math-type editarea.center > line {
  justify-content: center;
  text-align: center;
  text-align-last: auto;
}
math-type editarea.left > area-container > line,
math-type editarea.left > line {
  justify-content: flex-start;
  text-align: left;
}
math-type editarea.right > area-container > line,
math-type editarea.right > line {
  justify-content: flex-end;
  text-align: right;
}
math-type editarea > area-baseline {
  width: 0;
  overflow: hidden;
  display: inline-block;
  float: left;
}
math-type setting.mt-common-dialog.line-tag-setting {
  transform: translate(0, -100%);
  position: absolute;
  font-family: serif;
  font-size: 11px;
  top: -4px;
  left: -10px;
  outline: none;
}
math-type setting.mt-common-dialog.line-tag-setting i {
  font-style: normal;
  padding: 1px 3px;
}
baselineblock {
  height: 0px;
  display: inline-block;
  width: 0;
  overflow: hidden;
}
baselineblock.inline {
  display: inline;
}
emptyblock {
  white-space: pre;
}
composite {
  display: inline-block;
}
block.Binary {
  padding: 0 0.2em;
}
block.Relation {
  padding: 0 0.3em;
}
block.Punctuation {
  padding-right: 0.2em;
}




check-box-wrapper {
  display: block;
  font-size: 11px;
  color: gray;
  cursor: pointer;
}
check-box-wrapper.disabled {
  color: lightgray;
}
check-box-wrapper.disabled check-box-rect {
  border: 1px solid #e2e1e1;
  color: lightgray;
}
check-box-wrapper.disabled check-box-rect:hover {
  border: 1px solid #e2e1e1;
}
check-box-wrapper.mobile-tablet check-box-rect {
  margin-top: -3px;
  width: 16px;
  height: 15px;
  font-size: 13px;
}
check-box-wrapper.mobile-tablet check-box-rect > i {
  left: 2px;
  top: 1px;
}
check-box-wrapper check-box-rect {
  width: 1.4em;
  height: 1.35em;
  border: 1px solid #c3c2c2;
  position: relative;
  display: inline-flex;
  font-size: 11px;
  color: green;
  background: white;
  justify-content: center;
  align-items: center;
}
check-box-wrapper check-box-rect:hover {
  border: 1px solid gray;
}
check-box-wrapper.unchecked check-box-rect > i {
  visibility: hidden;
}

vcomposed-symbol {
  display: flex;
  width: 100%;
  height: 100%;
  overflow: hidden;
  flex-direction: column;
}
vcomposed-symbol > start {
  display: block;
  float: left;
  overflow: hidden;
  margin-bottom: -0.02em;
}
vcomposed-symbol > middle-center {
  overflow: hidden;
  margin-top: -0.02em;
  margin-bottom: -0.02em;
}
vcomposed-symbol > middle {
  display: block;
  flex-grow: 1;
  position: relative;
  overflow: hidden;
  margin-top: -0.02em;
  margin-bottom: -0.02em;
}
vcomposed-symbol > middle > fixed {
  display: block;
  position: absolute;
  left: 0;
  top: 0;
}
vcomposed-symbol > middle > fixed > inside {
  display: block;
  overflow: hidden;
}
vcomposed-symbol > end {
  margin-top: -0.02em;
  display: block;
  overflow: hidden;
}


.open-brace,
.close-brace {
  padding: 0 0.1em;
  width: 0.5em;
  min-width: 0.5em;
}
.open-brace > start,
.close-brace > start {
  min-height: 0.75em;
  height: 0.75em;
}
.open-brace > middle-center,
.close-brace > middle-center {
  min-height: 0.6em;
  height: 0.6em;
}
.open-brace > end,
.close-brace > end {
  min-height: 0.75em;
  height: 0.75em;
}
.open-bracket,
.close-bracket {
  width: 0.43em;
  min-width: 0.43em;
}
.open-bracket > start,
.close-bracket > start {
  height: 0.5em;
  min-height: 0.5em;
}
.open-bracket > end,
.close-bracket > end {
  height: 0.7em;
  min-height: 0.7em;
}
.open-parenthesis,
.close-parenthesis {
  width: 0.45em;
  min-width: 0.45em;
}
.open-parenthesis > start,
.close-parenthesis > start {
  min-height: 0.85em;
  height: 0.85em;
}
.open-parenthesis > end,
.close-parenthesis > end {
  min-height: 0.8em;
  height: 0.8em;
}
.open-floor,
.close-floor {
  width: 0.45em;
  min-width: 0.45em;
}
.open-floor > end,
.close-floor > end {
  height: 0.35em;
  min-height: 0.35em;
}
.open-ceil,
.close-ceil {
  width: 0.45em;
  min-width: 0.45em;
}
.open-ceil > start,
.close-ceil > start {
  height: 0.5em;
  min-height: 0.5em;
}
.open-vert,
.close-vert {
  width: 0.3em;
  min-width: 0.3em;
}
.open-Vert,
.close-Vert {
  width: 0.5em;
  min-width: 0.5em;
}
.open-uparrow,
.close-uparrow {
  width: 0.45em;
  min-width: 0.45em;
}
.open-uparrow > start,
.close-uparrow > start {
  height: 0.5em;
  min-height: 0.5em;
}
.open-downarrow,
.close-downarrow {
  width: 0.45em;
  min-width: 0.45em;
}
.open-downarrow > end,
.close-downarrow > end {
  height: 0.4em;
  min-height: 0.4em;
}
.open-updownarrow,
.close-updownarrow {
  width: 0.45em;
  min-width: 0.45em;
}
.open-updownarrow > start,
.close-updownarrow > start {
  height: 0.5em;
  min-height: 0.5em;
}
.open-updownarrow > end,
.close-updownarrow > end {
  height: 0.4em;
  min-height: 0.4em;
}
.open-Uparrow,
.close-Uparrow {
  width: 0.7em;
  min-width: 0.7em;
}
.open-Uparrow > start,
.close-Uparrow > start {
  height: 0.5em;
  min-height: 0.5em;
}
.open-Downarrow,
.close-Downarrow {
  width: 0.7em;
  min-width: 0.7em;
}
.open-Downarrow > end,
.close-Downarrow > end {
  height: 0.5em;
  min-height: 0.5em;
}
.open-Updownarrow,
.close-Updownarrow {
  width: 0.6em;
  min-width: 0.6em;
}
.open-Updownarrow > start,
.close-Updownarrow > start {
  height: 0.5em;
  min-height: 0.5em;
}
.open-Updownarrow > end,
.close-Updownarrow > end {
  height: 0.5em;
  min-height: 0.5em;
}

/**we use alpha as we have problem with background (without alpha) in Electron version (older Chrome) **/
/* z-index region*/
/**different context*/
/**different context*/
opensymbolblock,
closesymbolblock,
.middle-vert-symbol {
  display: inline-flex;
  align-items: center;
  position: relative;
  text-align: left;
  margin-top: 0.1em;
  margin-bottom: 0.1em;
}
opensymbolblock.normal,
closesymbolblock.normal,
.middle-vert-symbol.normal {
  margin-top: 0;
  margin-bottom: 0;
}
opensymbolblock > hidden-span,
closesymbolblock > hidden-span,
.middle-vert-symbol > hidden-span {
  visibility: hidden;
  width: 0px;
}
opensymbolblock[type='brace'],
closesymbolblock[type='brace'],
.middle-vert-symbol[type='brace'] {
  margin-left: 0.05em;
  margin-right: 0.05em;
  overflow: visible;
}
opensymbolblock[type='brace'] > svg,
closesymbolblock[type='brace'] > svg,
.middle-vert-symbol[type='brace'] > svg {
  overflow: visible;
  width: 0.5em;
  height: 100%;
}
opensymbolblock[type='parenthesis'] > svg,
closesymbolblock[type='parenthesis'] > svg,
.middle-vert-symbol[type='parenthesis'] > svg {
  width: 0.5em;
  height: 100%;
}
opensymbolblock[type='bracket'] > svg,
closesymbolblock[type='bracket'] > svg,
.middle-vert-symbol[type='bracket'] > svg {
  width: 0.5em;
  height: 100%;
}
opensymbolblock[type='angle'].sm-1 > svg,
closesymbolblock[type='angle'].sm-1 > svg,
.middle-vert-symbol[type='angle'].sm-1 > svg {
  width: 0.3em;
}
opensymbolblock[type='angle'].sm-2 > svg,
closesymbolblock[type='angle'].sm-2 > svg,
.middle-vert-symbol[type='angle'].sm-2 > svg {
  width: 0.45em;
}
opensymbolblock[type='angle'] > svg,
closesymbolblock[type='angle'] > svg,
.middle-vert-symbol[type='angle'] > svg {
  width: 0.6em;
  height: 100%;
}
opensymbolblock[type='slash'] > svg,
closesymbolblock[type='slash'] > svg,
.middle-vert-symbol[type='slash'] > svg {
  width: 0.7em;
  height: 100%;
}
opensymbolblock > bracket-span,
closesymbolblock > bracket-span,
.middle-vert-symbol > bracket-span {
  display: block;
}
opensymbolblock > vcomposed-symbol,
closesymbolblock > vcomposed-symbol,
.middle-vert-symbol > vcomposed-symbol,
opensymbolblock > bracket-span,
closesymbolblock > bracket-span,
.middle-vert-symbol > bracket-span {
  height: 100%;
  width: 100%;
  font-style: normal;
}
opensymbolblock > brace-span,
closesymbolblock > brace-span,
.middle-vert-symbol > brace-span {
  visibility: hidden;
  display: inline-block;
  padding: 0 0.1em;
}
opensymbolblock,
.middle-vert-symbol {
  margin-left: 0.07em;
}
opensymbolblock.normal,
.middle-vert-symbol.normal {
  margin-left: 0;
}
opensymbolblock[type='vert'],
.middle-vert-symbol[type='vert'],
opensymbolblock.middle-vert-symbol,
.middle-vert-symbol.middle-vert-symbol {
  margin-left: 0.05em;
  margin-right: 0.05em;
}
opensymbolblock[type='vert'] > svg,
.middle-vert-symbol[type='vert'] > svg,
opensymbolblock.middle-vert-symbol > svg,
.middle-vert-symbol.middle-vert-symbol > svg {
  width: 0.4em;
  height: 100%;
}
opensymbolblock[type='parenthesis'] > svg,
.middle-vert-symbol[type='parenthesis'] > svg {
  margin-right: -0.1em;
}
closesymbolblock {
  margin-right: 0.07em;
}
closesymbolblock.normal {
  margin-right: 0;
}
closesymbolblock[type='vert'] {
  margin-left: 0.05em;
  margin-right: 0.05em;
}
closesymbolblock[type='vert'] > svg {
  width: 0.4em;
  height: 100%;
}
closesymbolblock[type='parenthesis'] > svg {
  margin-left: -0.1em;
}

opensymbolblock[type=empty] > empty,
closesymbolblock[type=empty] > empty {
  width: 2px;
  height: 100%;
  display: block;
}
opensymbolblock[type=empty] > empty.normal-size,
closesymbolblock[type=empty] > empty.normal-size {
  height: 1em;
}
opensymbolblock[type=empty] > empty.line-selected,
closesymbolblock[type=empty] > empty.line-selected {
  background-color: lightgray;
}

.dirac-bracket-symbol > div > .oangle,
.dirac-bracket-symbol > div > .cangle {
  align-self: stretch;
  width: 0.55em;
  position: relative;
  margin-top: 0.1em;
  margin-bottom: -0.1em;
}
.dirac-bracket-symbol > div > .oangle > svg,
.dirac-bracket-symbol > div > .cangle > svg {
  position: absolute;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
}
.dirac-bracket-symbol > div > .vert {
  align-self: stretch;
  width: 0.25em;
  position: relative;
  margin-top: 0.1em;
  margin-bottom: -0.1em;
}
.dirac-bracket-symbol > div > .vert > svg {
  position: absolute;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
}
.dirac-bracket-symbol > div > editarea.first {
  min-width: 0.3em;
  padding-right: 0.1em;
}
.dirac-bracket-symbol > div > editarea.last {
  min-width: 0.3em;
  padding-left: 0.1em;
}
.dirac-bracket-symbol > div > editarea.middle {
  min-width: 0.3em;
  padding-left: 0.1em;
  padding-right: 0.1em;
}

cancel-symbol > editarea {
  display: inline-flex;
}
cancel-symbol > svg {
  position: absolute;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: visible;
}

/**we use alpha as we have problem with background (without alpha) in Electron version (older Chrome) **/
/* z-index region*/
/**different context*/
/**different context*/
math-type compositeblock.frac-slashed-symbol.frac-inline {
  font-size: 0.75em;
}
math-type compositeblock.fraction-symbol {
  margin-left: 0.1em;
  margin-right: 0.1em;
  vertical-align: baseline;
}
math-type compositeblock.fraction-symbol.frac-inline {
  font-size: 0.75em;
}
math-type compositeblock.fraction-symbol > .enumerator {
  float: left;
  width: 100%;
  clear: both;
}
math-type compositeblock.fraction-symbol > .denominator {
  margin-top: -5px;
  float: left;
  width: 100%;
}
math-type compositeblock.fraction-symbol > .frac-line {
  clear: both;
  pointer-events: none;
}
math-type compositeblock.fraction-symbol > .frac-line > inline {
  display: inline-block;
  width: 100%;
  vertical-align: 0.25em;
  border-bottom: solid 1px;
}
math-type compositeblock.fraction-symbol > editarea {
  border: 0px;
  min-width: 0.6em;
  text-align: center;
  text-align-last: auto;
}
math-type compositeblock.fraction-symbol > editarea > area-container > line,
math-type compositeblock.fraction-symbol > editarea > line {
  justify-content: center;
  text-align: center;
  text-align-last: auto;
}
math-type compositeblock.fraction-symbol > editarea-line {
  text-align: center;
  text-align-last: auto;
}

.stackrel-icon {
  margin: auto;
  display: flex;
  align-items: center;
  flex-direction: column;
}
.stackrel-icon .square {
  width: 6px;
  height: 6px;
  border-style: solid;
  border-width: 1px;
  border-color: gray;
}
.stackrel-icon .distance {
  margin-top: 3px;
}

/**we use alpha as we have problem with background (without alpha) in Electron version (older Chrome) **/
/* z-index region*/
/**different context*/
/**different context*/
math-type .stackrel-symbol.selected {
  outline: 1px solid rgba(93, 92, 92, 0.3);
}
math-type .stackrel-symbol > .cur-value {
  clear: both;
  display: inline-flex;
  width: 100%;
}
math-type .stackrel-symbol > .top {
  float: left;
  clear: both;
  width: 100%;
  font-size: 0.7em;
}

/**we use alpha as we have problem with background (without alpha) in Electron version (older Chrome) **/
/* z-index region*/
/**different context*/
/**different context*/
math-type .underset-symbol > .center {
  display: inline-flex;
  width: 100%;
}
math-type .underset-symbol > .bottom {
  float: left;
  display: block;
  width: 100%;
  font-size: 0.7em;
}

/**we use alpha as we have problem with background (without alpha) in Electron version (older Chrome) **/
/* z-index region*/
/**different context*/
/**different context*/
math-type .over-under-set-symbol.selected {
  outline: 1px solid rgba(93, 92, 92, 0.3);
}
math-type .over-under-set-symbol > .top {
  display: flex;
  float: left;
  clear: both;
  width: 100%;
}
math-type .over-under-set-symbol > .top > line {
  font-size: 0.7em;
}
math-type .over-under-set-symbol > .middle {
  display: inline-flex;
  width: 100%;
  clear: both;
}
math-type .over-under-set-symbol > .middle.select {
  border-bottom: none;
}
math-type .over-under-set-symbol > .bottom {
  display: flex;
  float: left;
  width: 100%;
}
math-type .over-under-set-symbol > .bottom > line {
  font-size: 0.7em;
}

expandable-component.thickness item-option.thickness-option {
  width: 40px;
  height: 12px;
}
expandable-component.thickness svg {
  stroke: gray;
  stroke-width: 1px;
  fill: none;
}
expandable-component.thickness thickness {
  position: relative;
  display: flex;
  height: 100%;
}
expandable-component.thickness thickness > svg.thickness {
  width: 25px;
  height: 100%;
  position: static;
}
expandable-component.thickness thickness > svg.thickness line {
  stroke: gray;
  stroke-width: 1px;
}
expandable-component.thickness thickness > svg.thickness path {
  fill: #d2cfcf;
  stroke: none;
}



/**we use alpha as we have problem with background (without alpha) in Electron version (older Chrome) **/
/* z-index region*/
/**different context*/
/**different context*/
math-type .textcircled > div > editarea {
  text-align: center;
  text-align-last: auto;
}
math-type .textcircled > div > editarea > area-container > line,
math-type .textcircled > div > editarea > line {
  justify-content: center;
  text-align: center;
  text-align-last: auto;
}

/**we use alpha as we have problem with background (without alpha) in Electron version (older Chrome) **/
/* z-index region*/
/**different context*/
/**different context*/
.math-container-symbol {
  margin-top: 0.3em;
  margin-bottom: 0.3em;
  display: inline-flex;
}
.math-container-symbol.inline {
  margin-top: 0px;
  margin-bottom: 0px;
}
.math-container-symbol.selected {
  background-color: rgba(76, 175, 80, 0.05);
  outline: 1px solid #c1d4c1;
}
.math-container-symbol.display {
  display: block;
}
.math-container-symbol.display.selected {
  background-color: rgba(76, 175, 80, 0.05);
  outline: none;
}
.math-container-symbol.display > editarea {
  width: 100%;
  flex-grow: 1;
  display: block;
  text-align: center;
  text-align-last: auto;
}
.math-container-symbol.display > editarea > area-container > line,
.math-container-symbol.display > editarea > line {
  justify-content: center;
  text-align: center;
  text-align-last: auto;
}
.math-container-symbol.display > editarea > area-container > line {
  padding-top: 8px;
  padding-bottom: 8px;
}

/**we use alpha as we have problem with background (without alpha) in Electron version (older Chrome) **/
/* z-index region*/
/**different context*/
/**different context*/
.math-container-symbol > editarea.multiline {
  display: block;
  flex-grow: 1;
  text-align: center;
  text-align-last: auto;
}
.math-container-symbol > editarea.multiline > area-container > line,
.math-container-symbol > editarea.multiline > line {
  justify-content: center;
  text-align: center;
  text-align-last: auto;
}
.math-container-symbol > editarea.multiline > line:last-child {
  justify-content: flex-end;
  text-align: right;
}
.math-container-symbol > editarea.multiline > line:first-child {
  justify-content: flex-start;
  text-align: left;
}

/**we use alpha as we have problem with background (without alpha) in Electron version (older Chrome) **/
/* z-index region*/
/**different context*/
/**different context*/
math-type .icon-sqrt,
.auto-complete-external-area .icon-sqrt {
  display: flex;
  margin: auto;
  font-size: 12px;
}
math-type .icon-sqrt .square,
.auto-complete-external-area .icon-sqrt .square {
  margin-top: 3px;
  margin-right: -6px;
}
math-type .icon-sqrt .square-expand,
.auto-complete-external-area .icon-sqrt .square-expand {
  background-color: #f7f7f7;
}
math-type .icon-sqrt .align-end,
.auto-complete-external-area .icon-sqrt .align-end {
  margin-top: 8px;
}
math-type .icon-sqrt .line,
.auto-complete-external-area .icon-sqrt .line {
  width: 10px;
  border-top: solid 1px black;
  margin-top: 6px;
}
math-type .icon-sqrt .big-square,
.auto-complete-external-area .icon-sqrt .big-square {
  margin-top: 11px;
  margin-left: -8px;
}
math-type .sqrt-symbol {
  white-space: nowrap;
  align-items: stretch;
  position: relative;
}
math-type .sqrt-symbol > add {
  opacity: 0.5;
  background-color: #f7f7f7;
  border: 1px solid #c3c2c2;
  color: gray;
  display: block;
  position: absolute;
  font-size: 0.6em;
  cursor: pointer;
  margin-left: -0.4em;
  z-index: 999;
  opacity: 0.7;
  left: 50%;
  top: -0.5em;
  left: 0.5em;
}
math-type .sqrt-symbol > add:hover {
  border-color: gray;
  opacity: 1;
}
math-type .sqrt-symbol > add > i {
  display: block;
  height: 1em;
  padding: 0.1em 0.15em;
  padding-bottom: 0;
  width: 0.8em;
}
math-type .sqrt-symbol text {
  fill: black;
}
math-type .sqrt-symbol > sqrt-edit {
  position: relative;
  order: 3;
  display: inline-block;
  align-self: flex-end;
}
math-type .sqrt-symbol > sqrt-edit > sqrt-symbol-line {
  overflow: visible;
  z-index: 1;
  width: 100%;
  height: 100%;
  display: block;
  position: absolute;
  left: 0;
  top: 0;
  pointer-events: none;
}
math-type .sqrt-symbol > sqrt-edit > sqrt-symbol-line > svg {
  overflow: visible;
  width: 100%;
  height: 1em;
}
math-type .sqrt-symbol > sqrt-edit > area-container > line {
  width: 1em;
  position: relative;
}
math-type .sqrt-symbol > sqrt-edit > editarea,
math-type .sqrt-symbol > sqrt-edit > editarea-line {
  z-index: 2;
  display: inline-block;
  min-width: 0.5em;
  margin-left: 1em;
}
math-type .sqrt-symbol > sqrt-top {
  position: relative;
  z-index: 2;
  vertical-align: bottom;
  padding-bottom: 0.95em;
  align-self: flex-end;
  display: inline-block;
}
math-type .sqrt-symbol > sqrt-top.selected {
  outline: 1px solid rgba(93, 92, 92, 0.3);
}
math-type .sqrt-symbol > sqrt-top > editarea {
  font-size: 0.7em;
  border: none 0px;
  min-width: 0.5em;
  display: flex;
  float: right;
  text-align: center;
  text-align-last: auto;
}
math-type .sqrt-symbol > sqrt-top > editarea > line {
  justify-content: center;
  text-align: center;
  text-align-last: auto;
}





/**we use alpha as we have problem with background (without alpha) in Electron version (older Chrome) **/
/* z-index region*/
/**different context*/
/**different context*/
image-viewer {
  width: 100%;
}
image-viewer.inline {
  width: auto;
}
image-viewer .image-content {
  cursor: pointer;
  text-align: left;
}
image-viewer detail list-items-options div {
  border: 1px solid transparent;
  cursor: pointer;
  margin-left: 3px;
  padding: 0 2px 0 2px;
}
image-viewer detail list-items-options div:hover {
  background-color: white;
  border: 1px solid lightgray;
}
image-viewer detail list-items-options div.selected {
  background-color: white;
  border: 1px solid lightgray;
}
image-viewer image-container {
  display: flex;
  flex-direction: column;
}
image-viewer image-container img {
  position: absolute;
}
image-viewer image-container.center {
  align-items: center;
}
image-viewer image-container.left {
  align-items: flex-start;
}
image-viewer image-container.right {
  align-items: flex-end;
}
.resize-box {
  position: absolute;
  width: 8px;
  height: 8px;
  border-width: 1px;
  border-color: gray;
  border-style: solid;
  background-color: white;
  z-index: 999;
}
.resize-box.mobile-tablet {
  width: 16px;
  height: 16px;
}
.resize-box.hide {
  display: none;
}
topleft {
  top: 0;
  left: 0;
  margin-left: -5px;
  margin-top: -5px;
  cursor: nwse-resize;
}
topleft.mobile-tablet {
  margin-left: -8px;
  margin-top: -8px;
}
topright {
  top: 0;
  right: 0;
  margin-right: -5px;
  margin-top: -5px;
  cursor: nesw-resize;
}
topright.mobile-tablet {
  margin-right: -8px;
  margin-top: -8px;
}
topmiddle {
  top: 0;
  left: 50%;
  margin-left: -5px;
  margin-top: -5px;
  cursor: ns-resize;
}
topmiddle.mobile-tablet {
  margin-left: -8px;
  margin-top: -8px;
}
leftmiddle {
  top: 50%;
  left: 0;
  margin-left: -5px;
  margin-top: -5px;
  cursor: ew-resize;
}
leftmiddle.mobile-tablet {
  margin-left: -8px;
  margin-top: -8px;
}
rightmiddle {
  top: 50%;
  right: 0;
  margin-right: -5px;
  margin-top: -5px;
  cursor: ew-resize;
}
rightmiddle.mobile-tablet {
  margin-right: -8px;
  margin-top: -8px;
}
bottomleft {
  bottom: 0;
  left: 0;
  margin-left: -5px;
  margin-bottom: -5px;
  cursor: nesw-resize;
}
bottomleft.mobile-tablet {
  margin-left: -8px;
  margin-bottom: -8px;
}
bottomright {
  bottom: 0;
  right: 0;
  margin-right: -5px;
  margin-bottom: -5px;
  cursor: nwse-resize;
}
bottomright.mobile-tablet {
  margin-right: -8px;
  margin-bottom: -8px;
}
bottommiddle {
  bottom: 0;
  left: 50%;
  margin-left: -5px;
  margin-bottom: -5px;
  cursor: ns-resize;
}
bottommiddle.mobile-tablet {
  margin-left: -8px;
  margin-bottom: -8px;
}
.ghost-viewer {
  outline: 1px dotted gray;
  width: 100%;
  height: 100%;
  display: block;
}

compositeblock.image-container {
  position: relative;
  width: 100%;
  margin-top: 10px;
  margin-bottom: 10px;
}
compositeblock.image-container > image-viewer {
  display: block;
}
compositeblock.image-container.inline {
  width: auto;
  margin-top: 0;
  margin-bottom: 0;
  display: inline-block;
}
.image-caption > line.text-mode:first-child {
  display: inline;
}
.image-caption > line.text-mode:first-child > blocks {
  display: inline;
}
.add-caption {
  opacity: 0.85;
  text-align: "center";
  color: #1155cc;
  cursor: pointer;
  position: absolute;
  bottom: -35px;
  left: 50%;
  transform: translate(-50%, 0);
  z-index: 10;
  font-size: 13px;
  background: white;
  border: 1px solid lightgray;
  padding: 5px;
}
.add-caption:hover {
  opacity: 1;
}

/**we use alpha as we have problem with background (without alpha) in Electron version (older Chrome) **/
/* z-index region*/
/**different context*/
/**different context*/
math-type .power-index-symbol-container {
  margin-right: 0.06em;
  margin-left: 0.03em;
}
math-type .power-index-symbol-container.has-power > .power-value {
  margin-left: 0.04em;
}
math-type .power-index-symbol-container > .power-value,
math-type .pre-script-symbol-container > .power-value {
  /*margin-bottom: -2px;*/
  float: left;
  clear: both;
  text-align: left;
}
math-type .power-index-symbol-container > .power-value.small > line,
math-type .pre-script-symbol-container > .power-value.small > line {
  margin-bottom: -0.35em;
}
math-type .power-index-symbol-container > .power-value > line,
math-type .pre-script-symbol-container > .power-value > line {
  font-size: 0.7em;
}
math-type .power-index-symbol-container > .power-value > area-container > line,
math-type .pre-script-symbol-container > .power-value > area-container > line,
math-type .power-index-symbol-container > .power-value > line,
math-type .pre-script-symbol-container > .power-value > line {
  justify-content: flex-start;
  text-align: left;
}
math-type .power-index-symbol-container > middle-base,
math-type .pre-script-symbol-container > middle-base {
  display: block;
  clear: both;
  height: 1em;
}
math-type .power-index-symbol-container > middle-base > inline,
math-type .pre-script-symbol-container > middle-base > inline {
  display: inline-block;
}
math-type .power-index-symbol-container > .index-value,
math-type .pre-script-symbol-container > .index-value {
  float: left;
  text-align: left;
}
math-type .power-index-symbol-container > .index-value > line,
math-type .pre-script-symbol-container > .index-value > line {
  font-size: 0.7em;
}
math-type .power-index-symbol-container > .index-value > area-container > line,
math-type .pre-script-symbol-container > .index-value > area-container > line,
math-type .power-index-symbol-container > .index-value > line,
math-type .pre-script-symbol-container > .index-value > line {
  justify-content: flex-start;
  text-align: left;
}
math-type .power-index-symbol-container > editarea-block.index-value,
math-type .pre-script-symbol-container > editarea-block.index-value,
math-type .power-index-symbol-container > editarea-line.index-value,
math-type .pre-script-symbol-container > editarea-line.index-value {
  font-size: 0.7em;
}
math-type .power-index-symbol-container > editarea-block.power-value,
math-type .pre-script-symbol-container > editarea-block.power-value,
math-type .power-index-symbol-container > editarea-line.power-value,
math-type .pre-script-symbol-container > editarea-line.power-value {
  font-size: 0.7em;
}
math-type .pre-script-symbol-container > .power-value {
  float: right;
}
math-type .pre-script-symbol-container > .index-value {
  float: right;
}
.icon-power-index-symbol {
  display: flex;
  margin: auto;
  width: 20px;
  padding-bottom: 6px;
}
.icon-power-index-symbol .square-up {
  margin-top: 4px;
}
.icon-power-index-symbol .square-down {
  margin-top: 14px;
  margin-left: -6px;
}
.icon-power-index-symbol .align-end {
  margin-top: 4px;
}
.icon-power-symbol {
  display: flex;
  margin: auto;
  width: 20px;
  padding-bottom: 6px;
}
.icon-power-symbol .square {
  margin-top: 4px;
}
.icon-power-symbol .align-end {
  margin-top: 4px;
}
.icon-index-symbol {
  display: flex;
  margin: auto;
  width: 20px;
  padding-bottom: 6px;
}
.icon-index-symbol .square {
  margin-top: 14px;
  margin-left: 0px;
}
.icon-index-symbol .align-end {
  margin-top: 4px;
}

/**we use alpha as we have problem with background (without alpha) in Electron version (older Chrome) **/
/* z-index region*/
/**different context*/
/**different context*/
.matrix-symbol.matrix-like > matrix > table > tbody > tr > td {
  padding-bottom: 0.1em;
  padding-top: 0.1em;
}
.matrix-symbol.matrix-like > matrix > table > tbody > tr.hline {
  border-top: 1px solid;
}
.matrix-symbol.matrix-like > matrix > table > tbody > tr:last-child.last-hline {
  border-bottom: 1px solid;
}
.matrix-symbol {
  /* must be flex to have vertical center align , unless figure out another way */
  display: inline-flex;
  align-items: center;
}
.matrix-symbol > matrix > table > tbody > tr > td > .sbd {
  position: absolute;
  left: -1px;
  top: -1px;
  right: -1px;
  bottom: -1px;
  pointer-events: none;
  background: none;
}
.matrix-symbol.selected > matrix > table > tbody > tr > td > .sbd {
  border-top: 1px solid rgba(93, 92, 92, 0.15);
  border-left: 1px solid rgba(93, 92, 92, 0.15);
}
.matrix-symbol.selected > matrix > table > tbody > tr > td > .sbd.sbd-lr {
  border-bottom: 1px solid rgba(93, 92, 92, 0.15);
}
.matrix-symbol.selected > matrix > table > tbody > tr > td > .sbd.sbd-lc {
  border-right: 1px solid rgba(93, 92, 92, 0.15);
}
.matrix-symbol > base-line-indicator {
  height: inherit;
  margin-top: -0.18em;
}
.matrix-symbol matrixclosesymbol,
.matrix-symbol matrixopensymbol {
  font-style: normal;
  color: black;
  position: relative;
}
.matrix-symbol matrixclosesymbol > span,
.matrix-symbol matrixopensymbol > span {
  visibility: hidden;
  display: inline-block;
}
.matrix-symbol matrixclosesymbol > svg,
.matrix-symbol matrixopensymbol > svg {
  overflow: visible;
  font-size: 15px;
  width: 100%;
  height: 100%;
  position: absolute;
  top: 0;
  left: 0;
}
.matrix-symbol matrixclosesymbol > svg text,
.matrix-symbol matrixopensymbol > svg text {
  fill: black;
}
.matrix-symbol > matrix.matrix > table > tbody > tr > td {
  padding: 0 0.3em;
}
.matrix-symbol > matrix {
  display: flex;
  position: relative;
  float: left;
  align-items: flex-start;
  break-inside: avoid;
}
.matrix-symbol > matrix > svg {
  width: 0.6em;
  /*init height, willl be changed by inline style*/
  height: 3px;
  overflow: visible;
  align-self: flex-start;
}
.matrix-symbol > matrix > vcomposed-symbol {
  height: inherit;
  align-self: stretch;
}
.matrix-symbol > matrix > table {
  border: 1px solid transparent;
  border-collapse: collapse;
}
.matrix-symbol > matrix > table > tbody > tr {
  box-sizing: border-box;
}
.matrix-symbol > matrix > table > tbody > tr.smaller {
  font-size: 0.75em;
}
.matrix-symbol > matrix > table > tbody > tr > td {
  position: relative;
  border: 1px dotted transparent;
  box-sizing: border-box;
  padding: 0 0.3em;
  vertical-align: baseline;
}
.matrix-symbol > matrix > table > tbody > tr > td > .editor-cell {
  display: inline-block;
  width: 100%;
}
.matrix-symbol > matrix > table > tbody > tr > td.vline {
  border-left: 1px solid;
}
.matrix-symbol > matrix > table > tbody > tr > td:last-child.last-vline {
  border-right: 1px solid;
}
.matrix-symbol > matrix > table > tbody > tr > td > .editor-cell {
  min-width: 0.5em;
  text-align: center;
  text-align-last: auto;
}
.matrix-symbol > matrix > table > tbody > tr > td > .editor-cell > area-container > line,
.matrix-symbol > matrix > table > tbody > tr > td > .editor-cell > line {
  justify-content: center;
  text-align: center;
  text-align-last: auto;
}
.matrix-symbol > matrix.matrix > table {
  margin-left: -0.2em;
  margin-right: -0.2em;
}
.matrix-symbol > matrix.matrix > table > tbody > tr > td > .editor-cell {
  text-align: center;
  text-align-last: auto;
}
.matrix-symbol > matrix.matrix > table > tbody > tr > td > .editor-cell > area-container > line,
.matrix-symbol > matrix.matrix > table > tbody > tr > td > .editor-cell > line {
  justify-content: center;
  text-align: center;
  text-align-last: auto;
}
.matrix-symbol > matrix.array > table > tbody > tr > td > .editor-cell.left {
  text-align: left;
}
.matrix-symbol > matrix.array > table > tbody > tr > td > .editor-cell.left > area-container > line,
.matrix-symbol > matrix.array > table > tbody > tr > td > .editor-cell.left > line {
  justify-content: flex-start;
  text-align: left;
}
.matrix-symbol > matrix.array > table > tbody > tr > td > .editor-cell.center {
  text-align: center;
  text-align-last: auto;
}
.matrix-symbol > matrix.array > table > tbody > tr > td > .editor-cell.center > area-container > line,
.matrix-symbol > matrix.array > table > tbody > tr > td > .editor-cell.center > line {
  justify-content: center;
  text-align: center;
  text-align-last: auto;
}
.matrix-symbol > matrix.array > table > tbody > tr > td > .editor-cell.right {
  text-align: right;
}
.matrix-symbol > matrix.array > table > tbody > tr > td > .editor-cell.right > area-container > line,
.matrix-symbol > matrix.array > table > tbody > tr > td > .editor-cell.right > line {
  justify-content: flex-end;
  text-align: right;
}
.matrix-symbol > matrix.gathered > table > tbody > tr > td:nth-child(2n+3) {
  padding-left: 1em;
}
.matrix-symbol > matrix.gathered line {
  text-align: center;
  text-align-last: auto;
}
.matrix-symbol > matrix.aligned > table > tbody > tr > td {
  padding: 0;
}
.matrix-symbol > matrix.aligned > table > tbody > tr > td:nth-child(2n+3) {
  padding-left: 1em;
}
.matrix-symbol > matrix.aligned > table > tbody > tr > td:nth-child(2n+1) > .editor-cell {
  text-align: right;
}
.matrix-symbol > matrix.aligned > table > tbody > tr > td:nth-child(2n+1) > .editor-cell > area-container > line,
.matrix-symbol > matrix.aligned > table > tbody > tr > td:nth-child(2n+1) > .editor-cell > line {
  justify-content: flex-end;
  text-align: right;
}
.matrix-symbol > matrix.aligned > table > tbody > tr > td:nth-child(2n) > .editor-cell {
  text-align: left;
}
.matrix-symbol > matrix.aligned > table > tbody > tr > td:nth-child(2n) > .editor-cell > area-container > line,
.matrix-symbol > matrix.aligned > table > tbody > tr > td:nth-child(2n) > .editor-cell > line {
  justify-content: flex-start;
  text-align: left;
}
.matrix-symbol > matrix > border-design {
  position: absolute;
  left: 0;
  top: 0;
  right: 0;
  bottom: 0;
  display: block;
  background-color: rgba(255, 255, 255, 0.7);
  z-index: 10;
}
.matrix-symbol > matrix > border-design > border-line {
  cursor: pointer;
  position: absolute;
  /*border:1px solid gray;*/
}
.matrix-symbol > matrix > border-design > border-line > horizontal-line {
  border-top: 1px solid #eceaea;
  display: block;
  position: absolute;
  top: 50%;
  width: 100%;
  height: 1px;
  margin-top: 0;
  left: 0;
}
.matrix-symbol > matrix > border-design > border-line > vertical-line {
  border-left: 1px solid #eceaea;
  display: block;
  position: absolute;
  left: 50%;
  width: 1px;
  height: 100%;
  top: 0;
}
.matrix-symbol > matrix > border-design > border-line > vertical-line.enabled {
  border-top: 1px solid;
}
.matrix-symbol > matrix > border-design > border-line:hover > horizontal-line {
  border-top: 1px solid gray;
}
.matrix-symbol > matrix > border-design > border-line:hover > vertical-line {
  border-left: 1px solid gray;
}
.matrix-symbol > matrix > border-design > border-line.enabled > horizontal-line {
  border-top: 1px solid;
}
.matrix-symbol > matrix > border-design > border-line.enabled > vertical-line {
  border-left: 1px solid;
}
.matrix-symbol > matrix > setting {
  padding: 7px;
  position: absolute;
  top: -6px;
  font-family: "Segoe UI", Arial, Verdana, sans-serif;
  transform: translate(0, -100%);
  left: 0;
}
.matrix-symbol > matrix > setting > main-setting {
  display: flex;
  flex-direction: row;
}
.matrix-symbol > matrix > setting > main-setting styled-select {
  display: block;
  background-color: white;
}
.fa-table.array-settings {
  border: 1px solid lightgray;
  padding: 3px 5px;
  font-size: 14px;
  color: gray;
  cursor: pointer;
  /*margin-left: 5px;*/
}
.fa-table.array-settings:hover {
  color: black;
  background: white;
}
.matrix-icon {
  display: flex;
}
.matrix-icon .square {
  margin-top: 2px;
}
.matrix-icon .display-flex {
  display: flex;
}

/**we use alpha as we have problem with background (without alpha) in Electron version (older Chrome) **/
/* z-index region*/
/**different context*/
/**different context*/
.matrix-symbol.case-symbol > matrix > table > tbody > tr > td,
.matrix-symbol.square-case-symbol > matrix > table > tbody > tr > td {
  padding: 0 0.2em;
}
.matrix-symbol.case-symbol > matrix > table > tbody > tr > td.non-select,
.matrix-symbol.square-case-symbol > matrix > table > tbody > tr > td.non-select {
  user-select: none;
  width: 0.2em;
  padding: 0;
}
.matrix-symbol.case-symbol > matrix > table > tbody > tr > td > .editor-cell,
.matrix-symbol.square-case-symbol > matrix > table > tbody > tr > td > .editor-cell {
  text-align: left;
}
.matrix-symbol.case-symbol > matrix > table > tbody > tr > td > .editor-cell > area-container > line,
.matrix-symbol.square-case-symbol > matrix > table > tbody > tr > td > .editor-cell > area-container > line,
.matrix-symbol.case-symbol > matrix > table > tbody > tr > td > .editor-cell > line,
.matrix-symbol.square-case-symbol > matrix > table > tbody > tr > td > .editor-cell > line {
  justify-content: flex-start;
  text-align: left;
}
.case-icon {
  display: flex;
  font-size: 18px;
  line-height: 18px;
}
.case-icon .square {
  margin-top: 2px;
}
.case-icon .display-flex {
  display: flex;
}

/**we use alpha as we have problem with background (without alpha) in Electron version (older Chrome) **/
/* z-index region*/
/**different context*/
/**different context*/
.matrix-symbol.dr-case-symbol > matrix > table > tbody > tr > td {
  padding: 0 0.2em;
}
.matrix-symbol.dr-case-symbol > matrix > table > tbody > tr > td.selected {
  border: 1px solid #e0e0e0;
}
.matrix-symbol.dr-case-symbol > matrix > table > tbody > tr > td > .editor-cell {
  text-align: left;
}
.matrix-symbol.dr-case-symbol > matrix > table > tbody > tr > td > .editor-cell > area-container > line,
.matrix-symbol.dr-case-symbol > matrix > table > tbody > tr > td > .editor-cell > line {
  justify-content: flex-start;
  text-align: left;
}
.case-icon {
  display: flex;
  font-size: 18px;
  line-height: 18px;
}
.case-icon .square {
  margin-top: 2px;
}
.case-icon .display-flex {
  display: flex;
}

.array-icon .square {
  margin-top: 2px;
}
.array-icon .display-flex {
  display: flex;
}

.matrix-like.binom > .binom > table > tbody > tr > td {
  padding: 0;
}
.matrix-like.binom > .binom > table > tbody > tr > td line {
  text-align: center;
  text-align-last: auto;
}

/**we use alpha as we have problem with background (without alpha) in Electron version (older Chrome) **/
/* z-index region*/
/**different context*/
/**different context*/
.matrix-symbol.align-symbol {
  /*display flex because to make sure it's spend whole line*/
  display: flex;
  justify-content: center;
  margin-top: 10px;
  margin-bottom: 10px;
  width: 100%;
}
.matrix-symbol.align-symbol.selected {
  background-color: rgba(76, 175, 80, 0.05);
}
.matrix-symbol.align-symbol > matrix > setting > main-setting {
  margin-bottom: 0px;
}
.matrix-symbol.align-symbol > matrix > bulb {
  left: 50%;
}
.matrix-symbol.align-symbol > matrix > setting {
  margin-left: 20px;
}
.matrix-symbol.align-symbol > matrix.align {
  width: 100%;
  display: block;
}
.matrix-symbol.align-symbol > matrix > table > tbody > tr > td {
  padding: 0;
  vertical-align: baseline;
  border: 1px solid transparent;
}
.matrix-symbol.align-symbol > matrix > table > tbody > tr > td > .editor-cell {
  /* should align start and area-container level (instead of line level)
                as for lazy rendering, we need to have exact line width */
}
.matrix-symbol.align-symbol > matrix > table > tbody > tr > td > .editor-cell > area-container {
  align-items: flex-start;
}
.matrix-symbol.align-symbol > matrix > table > tbody > tr > td > .editor-cell > area-container > line {
  width: auto;
  text-align: left;
}
.matrix-symbol.align-symbol > matrix > table > tbody > tr > td.align-right > .editor-cell {
  /* should align start and area-container level (instead of line level)
                as for lazy rendering, we need to have exact line width */
}
.matrix-symbol.align-symbol > matrix > table > tbody > tr > td.align-right > .editor-cell > area-container {
  align-items: flex-end;
}
.matrix-symbol.align-symbol > matrix > table > tbody > tr > td.align-right > .editor-cell > area-container > line {
  width: auto;
  text-align: right;
}
.matrix-symbol.align-symbol > matrix > table > tbody > tr > td.non-select {
  border: none;
  user-select: none;
}
.matrix-symbol.align-symbol > matrix > table > tbody > tr > td.expand {
  width: 100%;
}
.matrix-symbol.align-symbol > matrix > table > tbody > tr > td.selected {
  border: 1px solid #e0e0e0;
}
.matrix-symbol.align-symbol > matrix > table > tbody > tr > td > .editor-cell {
  min-width: 1.5em;
}
.matrix-symbol.align-symbol > matrix > table > tbody > tr > td > tupple {
  width: 100%;
  display: flex;
  justify-content: center;
  align-items: baseline;
}

/**we use alpha as we have problem with background (without alpha) in Electron version (older Chrome) **/
/* z-index region*/
/**different context*/
/**different context*/
.matrix-symbol.gather-symbol {
  /*display flex because to make sure it's spend whole line*/
  display: flex;
  justify-content: center;
  margin-top: 10px;
  margin-bottom: 10px;
  width: 100%;
}
.matrix-symbol.gather-symbol.selected {
  background-color: rgba(76, 175, 80, 0.05);
}
.matrix-symbol.gather-symbol > matrix.gather {
  width: 100%;
  display: block;
}
.matrix-symbol.gather-symbol > matrix > setting > main-setting {
  margin-bottom: 0px;
}
.matrix-symbol.gather-symbol > matrix > bulb {
  left: -1em;
}
.matrix-symbol.gather-symbol > matrix > setting {
  margin-left: 20px;
}
.matrix-symbol.gather-symbol > matrix > table > tbody > tr > td {
  padding: 0;
  vertical-align: baseline;
  border: 1px solid transparent;
  text-align: center;
  text-align-last: auto;
}
.matrix-symbol.gather-symbol > matrix > table > tbody > tr > td.non-select {
  user-select: none;
  width: 1.5em;
  border: none;
}
.matrix-symbol.gather-symbol > matrix > table > tbody > tr > td.expand {
  width: 100%;
}
.matrix-symbol.gather-symbol > matrix > table > tbody > tr > td.selected {
  border: 1px solid #e0e0e0;
}
.matrix-symbol.gather-symbol > matrix > table > tbody > tr > td line {
  text-align: center;
  text-align-last: auto;
}
.matrix-symbol.gather-symbol > matrix > table > tbody > tr > td > .editor-cell {
  min-width: 1.5em;
  /* should align start and area-container level (instead of line level)
                as for lazy rendering, we need to have exact line width */
}
.matrix-symbol.gather-symbol > matrix > table > tbody > tr > td > .editor-cell > area-container {
  align-items: center;
}
.matrix-symbol.gather-symbol > matrix > table > tbody > tr > td > .editor-cell > area-container > line {
  width: auto;
}
.matrix-symbol.gather-symbol > matrix > table > tbody > tr > td > tupple {
  width: 100%;
  display: flex;
  justify-content: center;
  align-items: baseline;
}

math-type compositeblock.table-symbol {
  width: 100%;
  display: flex;
}
math-type compositeblock.table-symbol.cap-above {
  flex-direction: column;
}
math-type .matrix-symbol > matrix.table {
  width: 100%;
  flex-direction: column;
  align-items: stretch;
}
math-type .matrix-symbol > matrix.table > table {
  table-layout: fixed;
  border: unset;
  width: 100%;
}
math-type .matrix-symbol > matrix.table > table > tbody > tr > td {
  vertical-align: top;
  padding: 0;
  position: relative;
}
math-type .cell-border-box {
  position: absolute;
  left: -1px;
  top: -1px;
  width: 100%;
  height: 100%;
}
.table-caption > line.text-mode:first-child {
  display: inline;
}
.table-caption > line.text-mode:first-child > blocks {
  display: inline;
}

editarea.lttb.text-mode > line.text-mode > blocks {
  text-align: inherit;
}



math-type compositeblock.table-of-content {
  display: block;
  width: 100%;
}
math-type compositeblock.table-of-content > toc-wrapper {
  position: relative;
  width: 100%;
  display: block;
  cursor: default;
}
math-type compositeblock.table-of-content > toc-wrapper .toc-setting-icons {
  display: none;
  position: absolute;
  left: -65px;
  width: 70px;
  top: -20px;
  bottom: 0;
  font-size: 1em;
  z-index: 999;
  padding-top: 20px;
}
math-type compositeblock.table-of-content > toc-wrapper .toc-setting-icons > .icon-refresh,
math-type compositeblock.table-of-content > toc-wrapper .toc-setting-icons > .icon-settings {
  border: 1px solid #c3c2c2;
  padding: 0.3em;
  padding-top: 0.1em;
  line-height: 1.2;
  padding-bottom: 0;
  cursor: pointer;
  background-color: #f7f7f7;
  color: gray;
  width: 12px;
  display: inline-block;
  margin-left: 5px;
}
math-type compositeblock.table-of-content > toc-wrapper:hover .toc-setting-icons {
  display: block;
}
math-type compositeblock.table-of-content > toc-wrapper > editarea.toc-ea.text-mode {
  width: 100%;
  cursor: default;
  display: block;
}
math-type compositeblock.table-of-content > toc-wrapper > editarea.toc-ea.text-mode > line.text-mode {
  display: block;
  width: auto;
  cursor: default;
  padding-left: 1em;
  padding-right: 15px;
  font-style: unset;
}
math-type compositeblock.table-of-content > toc-wrapper > editarea.toc-ea.text-mode > line.text-mode > a > blocks,
math-type compositeblock.table-of-content > toc-wrapper > editarea.toc-ea.text-mode > line.text-mode > blocks {
  display: block;
}
math-type compositeblock.table-of-content > toc-wrapper > editarea.toc-ea.text-mode > line.text-mode > a > prefix,
math-type compositeblock.table-of-content > toc-wrapper > editarea.toc-ea.text-mode > line.text-mode > prefix {
  display: none;
}
math-type compositeblock.table-of-content > toc-wrapper > editarea.toc-ea.text-mode > line.text-mode.has-rtl {
  padding-left: 15px;
  padding-right: 1em;
}
math-type compositeblock.table-of-content > toc-wrapper > editarea.toc-ea.text-mode > line.text-mode.has-rtl > a > blocks,
math-type compositeblock.table-of-content > toc-wrapper > editarea.toc-ea.text-mode > line.text-mode.has-rtl > blocks {
  text-align: right;
}
math-type compositeblock.table-of-content > toc-wrapper > editarea.toc-ea.text-mode > line.text-mode.has-rtl a > blocks > compositeblock.toc-page-number-symbol,
math-type compositeblock.table-of-content > toc-wrapper > editarea.toc-ea.text-mode > line.text-mode.has-rtl > blocks > compositeblock.toc-page-number-symbol {
  float: left;
  padding-left: 0;
  margin-right: 0;
  margin-left: 0;
  padding-right: 0.5em;
}
math-type compositeblock.table-of-content > toc-wrapper > editarea.toc-ea.text-mode > line.text-mode > block,
math-type compositeblock.table-of-content > toc-wrapper > editarea.toc-ea.text-mode > line.text-mode > a > block,
math-type compositeblock.table-of-content > toc-wrapper > editarea.toc-ea.text-mode > line.text-mode > blocks > block,
math-type compositeblock.table-of-content > toc-wrapper > editarea.toc-ea.text-mode > line.text-mode a > blocks > block {
  white-space: pre-wrap;
  white-space: break-spaces;
  cursor: pointer;
  font-style: unset;
}
math-type compositeblock.table-of-content > toc-wrapper > editarea.toc-ea.text-mode > line.text-mode > a > blocks > compositeblock.toc-page-number-symbol,
math-type compositeblock.table-of-content > toc-wrapper > editarea.toc-ea.text-mode > line.text-mode > blocks > compositeblock.toc-page-number-symbol {
  float: right;
  padding-left: 0.5em;
  margin-right: 0;
}

.icon-integral-symbol {
  margin: auto 4px auto auto;
  display: flex;
  flex-direction: row-reverse;
  font-size: 12px;
}
.icon-integral-symbol .square-up {
  border-width: 1px;
  margin-top: 0px;
}
.icon-integral-symbol .square-down {
  border-width: 1px;
  margin-top: 21px;
  margin-left: -10px;
}
.icon-integral-symbol .align-end {
  margin-top: 6px;
}

/**we use alpha as we have problem with background (without alpha) in Electron version (older Chrome) **/
/* z-index region*/
/**different context*/
/**different context*/
math-type .limit-type {
  position: relative;
}
math-type .limit-type > add {
  opacity: 0.5;
  background-color: #f7f7f7;
  border: 1px solid #c3c2c2;
  color: gray;
  display: block;
  position: absolute;
  font-size: 0.6em;
  cursor: pointer;
  margin-left: -0.4em;
  z-index: 999;
  opacity: 0.7;
  top: -0.5em;
  left: 50%;
  top: -1.4em;
  left: 0.6em;
  align-items: flex-start;
}
math-type .limit-type > add:hover {
  border-color: gray;
  opacity: 1;
}
math-type .limit-type > add > i {
  display: block;
  height: 1em;
  padding: 0.1em 0.15em;
  padding-bottom: 0;
  width: 0.8em;
}
math-type .limit-type > .to,
math-type .limit-type > .from {
  float: left;
  clear: both;
}
math-type .limit-type > .to > line,
math-type .limit-type > .from > line,
math-type .limit-type > .to > editarea > line,
math-type .limit-type > .from > editarea > line {
  font-size: 0.7em;
}
math-type .limit-type > editarea-line,
math-type .limit-type > editarea-block {
  font-size: 0.7em;
}
math-type .limit-type > symbol {
  display: block;
  clear: both;
  pointer-events: none;
}
math-type .limit-type > symbol > span {
  white-space: nowrap;
  pointer-events: none;
}
math-type .limit-type > setting {
  background-color: #f7f7f7;
  border: 1px solid #c3c2c2;
  color: gray;
  opacity: 0.5;
  opacity: 1;
  position: absolute;
  left: 50%;
  top: -2em;
  font-size: 0.6em;
  margin-left: -0.6em;
  padding: 0 0.2em;
  cursor: pointer;
}
math-type .limit-type > setting:hover {
  border-color: gray;
  opacity: 1;
}
math-type .limit-type > setting:hover {
  border: 1px solid gray;
}
math-type .limit-type > setting > i {
  transform: rotate(-60deg);
}
math-type .limit-type.limit-kind > setting > i {
  transform: rotate(45deg);
}
math-type .limit-type.limit-kind > symbol {
  text-align: center;
  text-align-last: auto;
}
math-type .limit-type.limit-kind > .from,
math-type .limit-type.limit-kind > .to {
  width: 100%;
  text-align: center;
  text-align-last: auto;
}
math-type .limit-type.limit-kind > .from > line,
math-type .limit-type.limit-kind > .to > line {
  justify-content: center;
  text-align: center;
  text-align-last: auto;
}
math-type .limit-type.limit-kind > empty.from {
  height: 0;
  margin-top: -0.75em;
}
math-type .limit-type.limit-kind > empty.from > editarea.selected > line,
math-type .limit-type.limit-kind > empty.from > editarea-block.selected,
math-type .limit-type.limit-kind > empty.from > editarea-line.selected {
  background-color: white;
  text-align: center;
  text-align-last: auto;
}
math-type .limit-type.limit-kind > empty.to {
  height: 0;
  text-align: center;
  text-align-last: auto;
}
math-type .limit-type.limit-kind > empty.to > editarea.selected > line,
math-type .limit-type.limit-kind > empty.to > editarea-block.selected,
math-type .limit-type.limit-kind > empty.to > editarea-line.selected {
  background-color: white;
  text-align: center;
  text-align-last: auto;
}
math-type .integral-like-symbol.inline > symbol {
  font-size: 1em;
}
math-type .integral-like-symbol.int-ml {
  margin-left: -0.5em;
}
math-type .integral-like-symbol.oint-ml {
  margin-left: -0.3em;
}
math-type .integral-like-symbol > symbol {
  font-size: 1.5em;
}
math-type .integral-like-symbol > symbol > span {
  line-height: 1.4em;
}

/**we use alpha as we have problem with background (without alpha) in Electron version (older Chrome) **/
/* z-index region*/
/**different context*/
/**different context*/
math-type .limit-type.lim-like-symbol {
  margin-left: 0.2em;
  margin-right: 0.2em;
}
math-type .limit-type.lim-like-symbol.close-left {
  margin-left: 0;
}
math-type .limit-type.lim-like-symbol.close-right {
  margin-right: 0;
}
math-type .limit-type.lim-like-symbol.limit-kind > empty.from > editarea {
  margin-top: -0.4em;
}
math-type .lim-like-symbol > add {
  left: 50%;
  top: -1em;
}
math-type .lim-like-symbol > symbol.inf {
  text-decoration: underline;
}
math-type .lim-like-symbol > symbol.sup {
  text-decoration: overline;
}
math-type .lim-like-symbol.non-limit-kind > editarea.from,
math-type .lim-like-symbol.non-limit-kind > editarea.to {
  margin-left: 1.47em;
}
math-type .lim-like-symbol.non-limit-kind > editarea.from.from-lim,
math-type .lim-like-symbol.non-limit-kind > editarea.to.to-lim {
  margin-left: 1.5435em;
}
math-type .lim-like-symbol.non-limit-kind > editarea.from.from-liminf,
math-type .lim-like-symbol.non-limit-kind > editarea.to.to-liminf {
  margin-left: 3.15em;
}
math-type .lim-like-symbol.non-limit-kind > editarea.from.from-limsup,
math-type .lim-like-symbol.non-limit-kind > editarea.to.to-limsup {
  margin-left: 3.528em;
}
math-type .lim-like-symbol.non-limit-kind > editarea.from.from-sup,
math-type .lim-like-symbol.non-limit-kind > editarea.to.to-sup {
  margin-left: 1.6905em;
}
math-type .lim-like-symbol.non-limit-kind > editarea.from.from-varlimsup,
math-type .lim-like-symbol.non-limit-kind > editarea.to.to-varlimsup {
  margin-left: 1.5435em;
}
math-type .lim-like-symbol.non-limit-kind > editarea-block.from,
math-type .lim-like-symbol.non-limit-kind > editarea-block.to {
  margin-left: 2.072em;
}
math-type .lim-like-symbol.non-limit-kind > editarea-block.from.from-lim,
math-type .lim-like-symbol.non-limit-kind > editarea-block.to.to-lim {
  margin-left: 2.1756em;
}
math-type .lim-like-symbol.non-limit-kind > editarea-block.from.from-liminf,
math-type .lim-like-symbol.non-limit-kind > editarea-block.to.to-liminf {
  margin-left: 4.44em;
}
math-type .lim-like-symbol.non-limit-kind > editarea-block.from.from-limsup,
math-type .lim-like-symbol.non-limit-kind > editarea-block.to.to-limsup {
  margin-left: 4.9728em;
}
math-type .lim-like-symbol.non-limit-kind > editarea-block.from.from-sup,
math-type .lim-like-symbol.non-limit-kind > editarea-block.to.to-sup {
  margin-left: 2.3828em;
}
math-type .lim-like-symbol.non-limit-kind > editarea-block.from.from-varlimsup,
math-type .lim-like-symbol.non-limit-kind > editarea-block.to.to-varlimsup {
  margin-left: 2.1756em;
}



/**we use alpha as we have problem with background (without alpha) in Electron version (older Chrome) **/
/* z-index region*/
/**different context*/
/**different context*/
math-type .limit-type.summation-like-symbol.limit-kind > empty.from {
  margin-top: -0.3em;
}
math-type .limit-type.summation-like-symbol.limit-kind > empty.from > editarea,
math-type .limit-type.summation-like-symbol.limit-kind > empty.from > editarea-block {
  margin-top: -0.2em;
}
math-type .summation-like-symbol.inline > add {
  top: -1.1em;
}
math-type .summation-like-symbol.inline > symbol {
  font-size: 1em;
}
math-type .summation-like-symbol.inline > symbol > span {
  vertical-align: 0.15em;
}
math-type .summation-like-symbol {
  padding-right: 0.15em;
}
math-type .summation-like-symbol > symbol {
  font-size: 1.5em;
}
math-type .summation-like-symbol > symbol > span {
  vertical-align: 0.1em;
  line-height: 1.4em;
}
math-type .summation-like-symbol > add {
  top: -1.5em;
}
math-type .summation-like-symbol > .custom-symbol {
  font-weight: bold;
}

hcomposed-symbol {
  display: flex;
  width: 100%;
  height: 100%;
  overflow: hidden;
}
hcomposed-symbol > start {
  display: block;
  float: left;
  overflow: hidden;
}
hcomposed-symbol > middle {
  display: block;
  flex-grow: 1;
  white-space: nowrap;
  position: relative;
  overflow: hidden;
}
hcomposed-symbol > middle > fixed {
  display: block;
  position: absolute;
  left: 0;
  top: 0;
}
hcomposed-symbol > middle > fixed > inside {
  display: inline-block;
  overflow: hidden;
}
hcomposed-symbol > end {
  display: block;
  overflow: hidden;
}

/**we use alpha as we have problem with background (without alpha) in Electron version (older Chrome) **/
/* z-index region*/
/**different context*/
/**different context*/
math-type .arrow-like-symbol {
  padding: 0 0.2em;
}
math-type .arrow-like-symbol > arrow-like-simple > add {
  opacity: 0.5;
  background-color: #f7f7f7;
  border: 1px solid #c3c2c2;
  color: gray;
  display: block;
  position: absolute;
  font-size: 0.6em;
  cursor: pointer;
  margin-left: -0.4em;
  z-index: 999;
  opacity: 0.7;
  top: -0.5em;
  left: 50%;
  left: 0.8em;
  top: -0.7em;
}
math-type .arrow-like-symbol > arrow-like-simple > add:hover {
  border-color: gray;
  opacity: 1;
}
math-type .arrow-like-symbol > arrow-like-simple > add > i {
  display: block;
  height: 1em;
  padding: 0.1em 0.15em;
  padding-bottom: 0;
  width: 0.8em;
}
math-type .arrow-like-symbol > middle {
  display: block;
  text-align: center;
  text-align-last: auto;
  clear: both;
  width: 100%;
  position: relative;
}
math-type .arrow-like-symbol > middle > inside {
  display: inline-block;
  height: 0.55em;
  width: 100%;
}
math-type .arrow-like-symbol > middle > inside > hcomposed-symbol {
  position: absolute;
  top: 0.4em;
  left: 0;
}
math-type .arrow-like-symbol > editarea.sright-1 {
  padding-left: 0.55em;
  padding-right: 0.25em;
}
math-type .arrow-like-symbol > editarea.sleft-1 {
  padding-left: 0.25em;
  padding-right: 0.55em;
}
math-type .arrow-like-symbol > editarea.small-margin {
  padding-left: 0.4em;
  padding-right: 0.4em;
}
math-type .arrow-like-symbol > editarea.large-padding {
  margin: 0 1.3em;
}
math-type .arrow-like-symbol > editarea > line {
  font-size: 0.7em;
}
math-type .arrow-like-symbol > .top {
  float: left;
  width: 100%;
  clear: both;
  margin-bottom: -0.5em;
  z-index: 1;
  position: relative;
}
math-type .arrow-like-symbol > .top.space-1,
math-type .arrow-like-symbol > .top.up-space-1-lower-space-2 {
  margin-bottom: -0.4em;
}
math-type .arrow-like-symbol > .bottom {
  margin-top: -0.45em;
  float: left;
  width: 100%;
}
math-type .arrow-like-symbol > .bottom.space-1,
math-type .arrow-like-symbol > .bottom.lower-space-1 {
  margin-top: -0.35em;
}
math-type .arrow-like-symbol > .bottom.space-2,
math-type .arrow-like-symbol > .bottom.up-space-1-lower-space-2 {
  margin-top: -0.25em;
}

.over-icon {
  margin: auto;
  width: 12px;
  font-size: 13px;
}

/**we use alpha as we have problem with background (without alpha) in Electron version (older Chrome) **/
/* z-index region*/
/**different context*/
/**different context*/
math-type .over-arrow-symbol > arrow-symbol {
  display: block;
  margin-right: -0.05em;
  position: relative;
}
math-type .over-arrow-symbol > arrow-symbol > hcomposed-symbol {
  position: absolute;
}
math-type .over-arrow-symbol > arrow-symbol > arrow-wrapper {
  margin-right: -0.2em;
}
math-type .over-arrow-symbol > editarea {
  display: inline-flex;
  text-align: center;
  text-align-last: auto;
}
math-type .over-arrow-symbol > editarea > area-container > line,
math-type .over-arrow-symbol > editarea > line {
  justify-content: center;
  text-align: center;
  text-align-last: auto;
}
math-type .over-arrow-symbol > editarea-block {
  min-width: 0.5em;
  text-align: center;
  text-align-last: auto;
  display: inline-block;
}

/**we use alpha as we have problem with background (without alpha) in Electron version (older Chrome) **/
/* z-index region*/
/**different context*/
/**different context*/
math-type .over-line-symbol {
  margin-left: 0.05em;
  margin-right: 0.05em;
}
math-type .over-line-symbol > editarea {
  display: inline-flex;
  min-width: 0.5em;
}
math-type .over-line-symbol > editarea-line {
  min-width: 0.5em;
  display: inline-block;
  text-align: center;
  text-align-last: auto;
}
math-type .over-line-symbol > line-border {
  display: block;
  position: relative;
}
math-type .over-line-symbol > line-border > hcomposed-symbol {
  position: absolute;
}
math-type .over-line-symbol > line-border > svg {
  position: absolute;
  width: 100%;
  height: 100%;
}

brace-top-wrapper {
  display: flex;
  flex-direction: row;
  height: 100%;
  font-family: Asana-Math, Asana;
}
brace-top-wrapper > middle-wrapper {
  flex-grow: 1;
  position: relative;
  overflow: hidden;
}
brace-top-wrapper > middle-wrapper > fixed {
  display: block;
  position: absolute;
  left: 0;
  top: 0;
}
brace-top-wrapper > middle-wrapper > fixed > middle-inside {
  overflow: hidden;
}
brace-top-wrapper first,
brace-top-wrapper middle,
brace-top-wrapper last {
  overflow: hidden;
  position: relative;
}
brace-top-wrapper first {
  min-width: 0.7em;
  width: 0.7em;
}
brace-top-wrapper > middle {
  min-width: 0.6em;
  width: 0.6em;
}
brace-top-wrapper > last {
  min-width: 0.7em;
  width: 0.7em;
}
bracket-top-wrapper {
  display: flex;
  flex-direction: column;
  width: 100%;
  font-family: Asana-Math, Asana;
}
bracket-top-wrapper > first,
bracket-top-wrapper middle,
bracket-top-wrapper last {
  overflow: hidden;
  position: relative;
}
bracket-top-wrapper > first {
  height: 0.5em;
  min-height: 0.5em;
}
bracket-top-wrapper middle-wrapper {
  flex-grow: 1;
  position: relative;
  overflow: hidden;
}
bracket-top-wrapper middle-wrapper > fixed {
  overflow: hidden;
  position: absolute;
  left: 0;
  top: 0;
}
bracket-top-wrapper middle-wrapper > fixed > middle {
  display: block;
  overflow: hidden;
}
bracket-top-wrapper > last {
  height: 0.65em;
  min-height: 0.65em;
}
parenthesis-top-wrapper {
  display: flex;
  flex-direction: column;
  width: 100%;
  font-family: Asana-Math, Asana;
}
parenthesis-top-wrapper > first,
parenthesis-top-wrapper middle,
parenthesis-top-wrapper last {
  overflow: hidden;
  position: relative;
  height: 1em;
  min-height: 1em;
}
parenthesis-top-wrapper > first {
  min-height: 0.9em;
  height: 0.9em;
}
parenthesis-top-wrapper middle-wrapper {
  flex-grow: 1;
  position: relative;
  overflow: hidden;
}
parenthesis-top-wrapper middle-wrapper > fixed {
  position: absolute;
  top: 0;
  left: 0;
}
parenthesis-top-wrapper middle-wrapper > fixed > middle {
  display: block;
  overflow: hidden;
}
parenthesis-top-wrapper > last {
  min-height: 1em;
  height: 1em;
}

/**we use alpha as we have problem with background (without alpha) in Electron version (older Chrome) **/
/* z-index region*/
/**different context*/
/**different context*/
math-type .over-brace-symbol {
  position: relative;
}
math-type .over-brace-symbol > add {
  opacity: 0.5;
  background-color: #f7f7f7;
  border: 1px solid #c3c2c2;
  color: gray;
  display: block;
  position: absolute;
  font-size: 0.6em;
  cursor: pointer;
  margin-left: -0.4em;
  z-index: 999;
  opacity: 0.7;
  top: -0.5em;
  left: 50%;
  top: -1.5em;
  margin-left: -0.6em;
}
math-type .over-brace-symbol > add:hover {
  border-color: gray;
  opacity: 1;
}
math-type .over-brace-symbol > add > i {
  display: block;
  height: 1em;
  padding: 0.1em 0.15em;
  padding-bottom: 0;
  width: 0.8em;
}
math-type .over-brace-symbol > top-brace {
  pointer-events: none;
  display: block;
  min-width: 1.1em;
  position: relative;
  clear: both;
  margin-bottom: -0.1em;
  font-style: normal;
  font-weight: normal;
}
math-type .over-brace-symbol > top-brace > brace-top-wrapper {
  position: absolute;
  top: 0;
  left: 0;
  left: 50%;
  transform: translate(-50%, 0);
}
math-type .over-brace-symbol > editarea {
  display: inline-flex;
  width: 100%;
  align-self: center;
  clear: both;
}
math-type .over-brace-symbol > editarea.overValue {
  font-size: 0.7em;
  float: left;
  width: 100%;
  margin-bottom: 0.1em;
}

.icon-hat {
  margin: auto;
  width: 12px;
  font-size: 12px;
}
.icon-hat .square {
  margin-top: -3px;
}

.under-arc-symbol {
  display: inline-block;
}
.under-arc-symbol > editarea {
  display: inline-flex;
}
.under-arc-symbol > symbol {
  display: block;
  width: 100%;
  position: relative;
}
.under-arc-symbol > symbol > svg {
  position: absolute;
  left: 0;
  top: 0;
  display: block;
  width: 100%;
  height: 100%;
}

/**we use alpha as we have problem with background (without alpha) in Electron version (older Chrome) **/
/* z-index region*/
/**different context*/
/**different context*/
math-type .under-line-symbol > editarea {
  display: inline-flex;
}
math-type .under-line-symbol > line-border {
  display: block;
  position: relative;
  float: left;
  width: 100%;
}
math-type .under-line-symbol > line-border > svg {
  position: absolute;
  width: 100%;
  height: 100%;
}

/**we use alpha as we have problem with background (without alpha) in Electron version (older Chrome) **/
/* z-index region*/
/**different context*/
/**different context*/
math-type compositeblock.under-brace-symbol {
  display: inline-flex;
  flex-flow: column;
  position: relative;
}
math-type compositeblock.under-brace-symbol > add {
  opacity: 0.5;
  background-color: #f7f7f7;
  border: 1px solid #c3c2c2;
  color: gray;
  display: block;
  position: absolute;
  font-size: 0.6em;
  cursor: pointer;
  margin-left: -0.4em;
  z-index: 999;
  opacity: 0.7;
  top: -0.5em;
  left: 50%;
  top: 3em;
}
math-type compositeblock.under-brace-symbol > add:hover {
  border-color: gray;
  opacity: 1;
}
math-type compositeblock.under-brace-symbol > add > i {
  display: block;
  height: 1em;
  padding: 0.1em 0.15em;
  padding-bottom: 0;
  width: 0.8em;
}
math-type compositeblock.under-brace-symbol > bottom-brace {
  pointer-events: none;
  display: block;
  position: relative;
  min-width: 1.3em;
  font-style: normal;
  font-weight: normal;
}
math-type compositeblock.under-brace-symbol > bottom-brace > brace-top-wrapper {
  position: absolute;
  top: 0;
  left: 0;
  left: 50%;
  transform: translate(-50%, 0);
}
math-type compositeblock.under-brace-symbol > editarea {
  margin-left: 0.15em;
  margin-right: 0.15em;
  align-self: center;
}
math-type compositeblock.under-brace-symbol > editarea.underValue {
  font-size: 0.7em;
}
.under-brace-icon {
  width: 12px;
  margin: auto;
  font-size: 12px;
}
.under-brace-icon .brace-wrapper {
  margin-top: -14px;
}


math-type .operator-name > editarea {
  margin-left: 0.2em;
  margin-right: 0.2em;
  display: inline-flex;
}
math-type .operator-name > editarea.close-left {
  margin-left: 0;
}
math-type .operator-name > editarea.close-right {
  margin-right: 0;
}

.math-group > editarea {
  float: left;
}
.group-icon .rectangle {
  width: 23px;
  height: 12px;
  border-style: solid;
  border-width: 1px;
  text-align: center;
  border-color: gray;
  font-family: fantasy;
  color: black;
  padding-top: 1px;
  font-size: 9px;
  line-height: 14px;
  vertical-align: middle;
  margin: auto;
}

/**we use alpha as we have problem with background (without alpha) in Electron version (older Chrome) **/
/* z-index region*/
/**different context*/
/**different context*/
math-type compositeblock.over-symbol {
  position: relative;
}
math-type compositeblock.over-symbol > symbol {
  font-family: Asana-Math, Asana, Arial;
  height: 8em;
  display: block;
  text-align: center;
  text-align-last: auto;
  position: relative;
}
math-type compositeblock.over-symbol > symbol > inner {
  display: block;
  position: absolute;
  text-align: center;
  text-align-last: auto;
  width: 100%;
  height: 100%;
  left: 0;
  top: 0;
}
math-type compositeblock.over-symbol > symbol.dot > inner.left-sign,
math-type compositeblock.over-symbol > symbol.ring > inner.left-sign {
  transform: translate(-0.07em, 0);
}
math-type compositeblock.over-symbol > symbol.dot > inner.right-sign,
math-type compositeblock.over-symbol > symbol.ring > inner.right-sign {
  transform: translate(0.2em, 0);
}
math-type compositeblock.over-symbol > symbol.dot > inner,
math-type compositeblock.over-symbol > symbol.ring > inner {
  transform: translate(0.05em, 0);
}
math-type compositeblock.over-symbol > symbol.small-hat > inner.left-sign,
math-type compositeblock.over-symbol > symbol.small-tilde > inner.left-sign {
  transform: translate(-0.04em, 0);
}
math-type compositeblock.over-symbol > symbol.small-hat > inner.right-sign,
math-type compositeblock.over-symbol > symbol.small-tilde > inner.right-sign {
  transform: translate(0.15em, 0);
}
math-type compositeblock.over-symbol > symbol.small-hat > inner.ignore-shift,
math-type compositeblock.over-symbol > symbol.small-tilde > inner.ignore-shift {
  transform: translate(0, 0);
}
math-type compositeblock.over-symbol > symbol.small-hat > inner,
math-type compositeblock.over-symbol > symbol.small-tilde > inner {
  transform: translate(0.05em, 0);
}
math-type compositeblock.over-symbol > symbol.acute > inner.left-sign {
  transform: translate(-0.04em, 0);
}
math-type compositeblock.over-symbol > symbol.acute > inner.right-sign {
  transform: translate(0.25em, 0);
}
math-type compositeblock.over-symbol > symbol.acute > inner {
  transform: translate(0.1em, 0);
}
math-type compositeblock.over-symbol > symbol.grave,
math-type compositeblock.over-symbol > symbol.breve,
math-type compositeblock.over-symbol > symbol.acute {
  font-family: 'Times New Roman', Times, serif;
}
math-type compositeblock.over-symbol > symbol.grave > inner.left-sign,
math-type compositeblock.over-symbol > symbol.breve > inner.left-sign,
math-type compositeblock.over-symbol > symbol.check > inner.left-sign {
  transform: translate(-0.07em, 0);
}
math-type compositeblock.over-symbol > symbol.grave > inner.right-sign,
math-type compositeblock.over-symbol > symbol.breve > inner.right-sign,
math-type compositeblock.over-symbol > symbol.check > inner.right-sign {
  transform: translate(0.17em, 0);
}
math-type compositeblock.over-symbol > symbol.ddddot {
  min-width: 0.9em;
}
math-type compositeblock.over-symbol > symbol.dddot {
  min-width: 0.7em;
}

.math-xx > editarea {
  float: left;
}

math-type .big-delimiter-symbol {
  display: inline-flex;
  align-items: center;
  position: relative;
  margin: 0.1em 0;
}
math-type .big-delimiter-symbol big-delimiter.big-open {
  margin-left: 0.09em;
}
math-type .big-delimiter-symbol big-delimiter.big-close {
  margin-right: 0.07em;
}
math-type .big-delimiter-symbol > base-line-indicator {
  height: inherit;
}
math-type .big-delimiter-symbol > big-delimiter > svg {
  height: 100%;
  width: 100%;
}
math-type .big-delimiter-symbol > big-delimiter > bulb {
  left: -10px;
}
math-type .big-delimiter-symbol > big-delimiter > setting {
  width: 158px;
  display: flex;
  position: absolute;
  left: 0;
  top: -40px;
}
math-type .big-delimiter-symbol > big-delimiter > setting > .select-box-container {
  margin-right: 4px;
}
math-type .big-delimiter-symbol > big-delimiter > setting > .select-box-container:last-child {
  margin-right: 0px;
}

select-buttons {
  font-size: 13px;
  color: gray;
  display: block;
}
select-buttons > sb-item {
  display: inline-block;
  padding: 2px 2px;
  cursor: pointer;
  border: 1px solid transparent;
  /*box-sizing: border-box;*/
}
select-buttons > sb-item.selected {
  background-color: white;
  border: 1px solid lightgray;
}
select-buttons > sb-item:hover {
  border: 1px solid lightgray;
}
select-buttons > sb-item.disabled {
  opacity: 0.3;
  cursor: default;
  border: 1px solid transparent;
}
select-buttons > sb-item.disabled:hover {
  background-color: inherit;
  border: 1px solid transparent;
}

tabs-container tab-item {
  color: gray;
}
tabs-container tab-item:hover {
  color: black;
}

expandable-component.button-action {
  cursor: pointer;
  color: gray;
  fill: gray;
}
expandable-component.button-action:hover,
expandable-component.button-action.selected {
  color: black;
  fill: black;
}
expandable-component.button-action:hover label-display,
expandable-component.button-action.selected label-display {
  border: 1px solid #e2e0e0;
}
expandable-component.button-action label-display {
  font-size: 12px;
  padding-top: 5px;
  display: flex;
  border: 1px solid transparent;
  padding-left: 2px;
  padding-right: 2px;
  margin-top: 0px;
  padding-bottom: 4px;
  cursor: pointer;
}
expandable-component.button-action label-display > i {
  padding-left: 5px;
  padding-top: 1px;
}
expandable-component.button-action label-item-container > label-item:hover {
  background-color: #bfe4bd;
}
expandable-component.button-action label-item-container > label-item.ignore-select {
  background-color: inherit;
  cursor: default;
}
expandable-component.button-action.button-style label-display {
  background: white;
  border: 1px solid lightgray;
}
expandable-component.button-action.button-style:hover,
expandable-component.button-action.button-style.selected {
  color: gray;
}
expandable-component.button-action.button-style:hover label-display,
expandable-component.button-action.button-style.selected label-display {
  background: #f7f6f6;
}

g.group-box-move {
  opacity: 0.2;
}
g.group-box-move:hover {
  opacity: 0.8;
}




.math-diagram .intersections-group {
  stroke-width: 2px;
  stroke: black;
  fill: transparent;
  cursor: move;
}

/**we use alpha as we have problem with background (without alpha) in Electron version (older Chrome) **/
/* z-index region*/
/**different context*/
/**different context*/
math-type compositeblock.math-diagram > math-diagram {
  background: white;
}
math-type compositeblock.math-diagram {
  cursor: default;
  width: 100%;
  /** display block as if inline block, it will be disapear in some cases*/
  display: block;
}
math-type compositeblock.math-diagram .connection-point {
  cursor: crosshair;
}
math-type compositeblock.math-diagram .connection-point g {
  fill-opacity: 0.6;
}
math-type compositeblock.math-diagram .connection-point:hover g {
  fill-opacity: 1;
}
math-type compositeblock.math-diagram .text-diagram-editor editarea.text-mode.non-wrap > line.text-mode {
  font-size: unset;
}
math-type compositeblock.math-diagram .text-diagram-editor editarea.text-mode.non-wrap > line.text-mode > block {
  white-space: pre;
}
math-type compositeblock.math-diagram .text-diagram-editor editarea.text-mode.non-wrap > line.text-mode > blocks > block {
  white-space: pre;
}
math-type compositeblock.math-diagram > math-diagram {
  border: 1px solid transparent;
}
math-type compositeblock.math-diagram > math-diagram > clip-region > zoom-region {
  display: block;
  width: 100%;
  height: 100%;
}
math-type compositeblock.math-diagram > math-diagram > clip-region > zoom-region > svg {
  position: absolute;
  width: 100%;
  height: 100%;
  left: 0;
  top: 0;
}
math-type compositeblock.math-diagram .add-label {
  fill: gray;
}
math-type compositeblock.math-diagram .add-label:hover {
  fill: black;
}
math-type compositeblock.math-diagram .diagram-editor {
  margin: 0 2px;
}
math-type compositeblock.math-diagram .control-point-guide {
  stroke: lightgray;
  stroke-width: 0.5px;
  pointer-events: none;
}
math-type compositeblock.math-diagram .connection-group {
  stroke: black;
  fill: none;
}
math-type compositeblock.math-diagram .arrow-line {
  cursor: move;
}
math-type compositeblock.math-diagram .mobile-tablet .shape .transparent,
math-type compositeblock.math-diagram .mobile-tablet .composite-shape .transparent {
  stroke-width: 10px;
}
math-type compositeblock.math-diagram .shape,
math-type compositeblock.math-diagram .composite-shape {
  stroke-width: 1px;
  fill: none;
  cursor: move;
}
math-type compositeblock.math-diagram .shape .transparent,
math-type compositeblock.math-diagram .composite-shape .transparent {
  pointer-events: visiblePainted;
  stroke-width: 6px;
  stroke: transparent;
  stroke-dasharray: none;
  fill: none;
}
math-type compositeblock.math-diagram .mobile-tablet .connection.transparent,
math-type compositeblock.math-diagram .mobile-tablet .connection.transparent > line,
math-type compositeblock.math-diagram .mobile-tablet .connection.transparent > path {
  stroke-width: 10px;
}
math-type compositeblock.math-diagram .connection {
  stroke-width: 1px;
  fill: none;
  cursor: move;
}
math-type compositeblock.math-diagram .connection.transparent,
math-type compositeblock.math-diagram .connection.transparent > line,
math-type compositeblock.math-diagram .connection.transparent > path {
  pointer-events: visiblePainted;
  stroke-width: 6px;
  stroke: transparent;
  stroke-dasharray: none;
  fill: none;
}
math-type compositeblock.math-diagram .frame {
  stroke-width: 1px;
  fill: transparent;
}
math-type math-diagram {
  display: block;
  position: relative;
  width: 100%;
  height: 300px;
}
math-type math-diagram position-container {
  position: absolute;
  width: 1px;
  height: 1px;
  display: block;
}
math-type math-diagram dg-editor-container {
  position: absolute;
  min-width: 0.85em;
  border-collapse: border-box;
}
math-type math-diagram coverlayer {
  position: absolute;
  background: transparent;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  z-index: 2;
  cursor: move;
}
math-type math-diagram connection-point {
  position: absolute;
  display: block;
  height: 6px;
  width: 6px;
  background: lightgray;
  border: 1px solid gray;
  bottom: -10px;
  left: 50%;
  margin-left: -3px;
  cursor: e-resize;
}
math-type .diagram-caption > line.text-mode:first-child {
  display: inline;
}
math-type .diagram-caption > line.text-mode:first-child > blocks {
  display: inline;
}


.plot-input-style-settings {
  opacity: 0.5;
}
.plot-input-style-settings:hover {
  opacity: 1;
}

.psa-cn .ps-hint {
  opacity: 0;
  transition: opacity 0.3s linear;
}
.psa-cn:hover .ps-hint {
  opacity: 0.6;
}

.role-toolbar-wrapper.dg-full-view tool-bar too-bar-container {
  justify-content: start;
  width: auto;
  min-width: 0;
}
.role-toolbar-wrapper.dg-full-view diagram-settings {
  width: auto;
}

.dg-items-bar-container item {
  display: inline-block;
  padding: 3px;
  fill: gray;
  stroke: gray;
}
.dg-items-bar-container item,
.dg-items-bar-container item-option {
  border: 1px transparent solid;
}
.dg-items-bar-container item:hover,
.dg-items-bar-container item-option:hover {
  border: 1px #c4c1c1 solid;
  background: white;
}

/**we use alpha as we have problem with background (without alpha) in Electron version (older Chrome) **/
/* z-index region*/
/**different context*/
/**different context*/
math-type compositeblock.theorem {
  display: block;
}
math-type compositeblock.theorem.selected {
  outline: 1px solid rgba(93, 92, 92, 0.3);
}
math-type theorem-name {
  min-width: 20px;
  display: inline;
}
math-type theorem-name > line.text-mode:first-child {
  display: inline;
}
math-type editarea.text-mode.edit-theorem-content {
  min-width: 100px;
  display: inline;
  font-style: italic;
}
math-type editarea.text-mode.edit-theorem-content > line.text-mode:first-child {
  display: inline;
}
math-type editarea.text-mode.edit-theorem-content > line.text-mode:first-child > blocks {
  display: inline;
}
math-type editarea.text-mode.edit-theorem-content > line.text-mode > block {
  font-style: italic;
}
math-type editarea.text-mode.edit-theorem-content > line.text-mode > blocks > block {
  font-style: italic;
}
math-type editarea.text-mode.edit-theorem-content.normal > line.text-mode > block {
  font-style: normal;
}
math-type editarea.text-mode.edit-theorem-content.normal > line.text-mode > blocks > block {
  font-style: normal;
}
math-type editarea.text-mode.edit-theorem-content .qed-symbol {
  line-height: 1em;
}
.deletable {
  cursor: pointer;
}
.deletable:hover {
  color: red;
}

.regular-checkbox:hover {
  background-color: #f3f2f2;
}

@media print {
  code[class*="language-"],
  pre[class*="language-"] {
    text-shadow: none !important;
  }
}
math-type .code-section prefix.code-line-number {
  color: #a9a7a7;
  width: 2.5em;
  display: inline-block;
  flex-shrink: 0;
}
math-type .code-section prefix.code-line-number.prefix-l10 {
  width: 1.5em;
}
math-type .code-section prefix.code-line-number.prefix-l100 {
  width: 2em;
}
math-type .code-section .code-line-blocks-container {
  white-space: pre-wrap;
  white-space: break-spaces;
}
math-type .code-section .code-line-blocks-container block.token {
  white-space: pre-wrap;
  white-space: break-spaces;
}
math-type .code-section line.text-mode.code-section-line {
  display: flex;
  flex-direction: row;
  line-height: 1.5;
}

/**
 * prism.js default theme for JavaScript, CSS and HTML
 * Based on dabblet (http://dabblet.com)
 * @author Lea Verou
 */
.code-section.theme-default editarea {
  color: black;
}
.code-section.theme-default .token.comment,
.code-section.theme-default .token.prolog,
.code-section.theme-default .token.doctype,
.code-section.theme-default .token.cdata {
  color: slategray;
}
.code-section.theme-default .token.punctuation {
  color: #999;
}
.code-section.theme-default .namespace {
  opacity: 0.7;
}
.code-section.theme-default .token.property,
.code-section.theme-default .token.tag,
.code-section.theme-default .token.boolean,
.code-section.theme-default .token.number,
.code-section.theme-default .token.constant,
.code-section.theme-default .token.symbol,
.code-section.theme-default .token.deleted {
  color: #905;
}
.code-section.theme-default .token.selector,
.code-section.theme-default .token.attr-name,
.code-section.theme-default .token.string,
.code-section.theme-default .token.char,
.code-section.theme-default .token.builtin,
.code-section.theme-default .token.inserted {
  color: #690;
}
.code-section.theme-default .token.operator,
.code-section.theme-default .token.entity,
.code-section.theme-default .token.url,
.code-section.theme-default .language-css .token.string,
.code-section.theme-default .style .token.string {
  color: #9a6e3a;
}
.code-section.theme-default .token.atrule,
.code-section.theme-default .token.attr-value,
.code-section.theme-default .token.keyword {
  color: #07a;
}
.code-section.theme-default .token.function,
.code-section.theme-default .token.class-name {
  color: #DD4A68;
}
.code-section.theme-default .token.regex,
.code-section.theme-default .token.important,
.code-section.theme-default .token.important1,
.code-section.theme-default .token.variable {
  color: #e90;
}
.code-section.theme-default .token.important,
.code-section.theme-default .token.bold,
.code-section.theme-default .token.bold1 {
  font-weight: bold;
}
.code-section.theme-default .token.italic,
.code-section.theme-default .token.italic1 {
  font-style: italic;
}
.code-section.theme-default .token.entity {
  cursor: help;
}

/**
 * prism.js default theme for JavaScript, CSS and HTML
 * Based on dabblet (http://dabblet.com)
 * @author Lea Verou
 */
.code-section.theme-tomorrow-night {
  /**
 * prism.js tomorrow night eighties for JavaScript, CoffeeScript, CSS and HTML
 * Based on https://github.com/chriskempson/tomorrow-theme
 * @author Rose Pritchard
 */
}
.code-section.theme-tomorrow-night editarea {
  caret-color: #ccc;
}
.code-section.theme-tomorrow-night editarea {
  color: #ccc;
}
.code-section.theme-tomorrow-night .token.comment,
.code-section.theme-tomorrow-night .token.block-comment,
.code-section.theme-tomorrow-night .token.prolog,
.code-section.theme-tomorrow-night .token.doctype,
.code-section.theme-tomorrow-night .token.cdata {
  color: #999;
}
.code-section.theme-tomorrow-night .token.punctuation {
  color: #ccc;
}
.code-section.theme-tomorrow-night .token.tag,
.code-section.theme-tomorrow-night .token.attr-name,
.code-section.theme-tomorrow-night .token.namespace,
.code-section.theme-tomorrow-night .token.deleted {
  color: #e2777a;
}
.code-section.theme-tomorrow-night .token.function-name {
  color: #6196cc;
}
.code-section.theme-tomorrow-night .token.boolean,
.code-section.theme-tomorrow-night .token.number,
.code-section.theme-tomorrow-night .token.function {
  color: #f08d49;
}
.code-section.theme-tomorrow-night .token.property,
.code-section.theme-tomorrow-night .token.class-name,
.code-section.theme-tomorrow-night .token.constant,
.code-section.theme-tomorrow-night .token.symbol {
  color: #f8c555;
}
.code-section.theme-tomorrow-night .token.selector,
.code-section.theme-tomorrow-night .token.important,
.code-section.theme-tomorrow-night .token.important1,
.code-section.theme-tomorrow-night .token.atrule,
.code-section.theme-tomorrow-night .token.keyword,
.code-section.theme-tomorrow-night .token.builtin {
  color: #cc99cd;
}
.code-section.theme-tomorrow-night .token.string,
.code-section.theme-tomorrow-night .token.char,
.code-section.theme-tomorrow-night .token.attr-value,
.code-section.theme-tomorrow-night .token.regex,
.code-section.theme-tomorrow-night .token.variable {
  color: #7ec699;
}
.code-section.theme-tomorrow-night .token.operator,
.code-section.theme-tomorrow-night .token.entity,
.code-section.theme-tomorrow-night .token.url {
  color: #67cdcc;
}
.code-section.theme-tomorrow-night .token.important,
.code-section.theme-tomorrow-night .token.bold,
.code-section.theme-tomorrow-night .token.bold1 {
  font-weight: bold;
}
.code-section.theme-tomorrow-night .token.italic,
.code-section.theme-tomorrow-night .token.italic1 {
  font-style: italic;
}
.code-section.theme-tomorrow-night .token.entity {
  cursor: help;
}
.code-section.theme-tomorrow-night .token.inserted {
  color: green;
}

editor-container > math-type.dark-mode {
  background: #1e1e1e;
}
math-type.dark-mode {
  background: #1e1e1e;
}
math-type.dark-mode.math-type-for-print {
  -webkit-print-color-adjust: exact;
}
math-type.dark-mode editarea.root-editor {
  color: #e0e0e0;
  fill: #e0e0e0;
  stroke: #e0e0e0;
  border-color: #e0e0e0;
}
math-type.dark-mode editarea.root-editor {
  background: #1e1e1e;
}
math-type.dark-mode .math-container-symbol.selected,
math-type.dark-mode .math-container-symbol.display.selected {
  background-color: #2a352a;
}
math-type.dark-mode .matrix-symbol.gather-symbol.selected {
  background-color: #2a352a;
}
math-type.dark-mode .matrix-symbol.gather-symbol > matrix > table > tbody > tr > td.selected {
  border: 1px solid #525252;
}
math-type.dark-mode .matrix-symbol.align-symbol.selected {
  background-color: #2a352a;
}
math-type.dark-mode .matrix-symbol.align-symbol > matrix > table > tbody > tr > td.selected {
  border: 1px solid #525252;
}
math-type.dark-mode .matrix-symbol.matrix-like.selected {
  background-color: #2a352a;
}
math-type.dark-mode .matrix-symbol.matrix-like > matrix > table > tbody > tr.selected:not(.hline) {
  border-top: 1px solid #525252;
}
math-type.dark-mode .matrix-symbol.matrix-like > matrix > table > tbody > tr:last-child.selected {
  border-bottom: 1px solid #525252;
}
math-type.dark-mode .matrix-symbol > matrix > table > tbody > tr > td.selected:not(.vline) {
  border-left: 1px solid #525252;
}
math-type.dark-mode .matrix-symbol > matrix > table > tbody > tr > td:last-child.selected {
  border-right: 1px solid #525252;
}
math-type.dark-mode .matrix-symbol.case-symbol > matrix > table > tbody > tr > td.selected {
  border: 1px solid #525252;
}
math-type.dark-mode selection-wrapper > selection {
  background-color: rgba(33, 150, 243, 0.25);
}
math-type.dark-mode selection-wrapper.inactive > selection {
  background-color: rgba(255, 255, 255, 0.27);
}
math-type.dark-mode editarea.selected {
  outline: 1px solid rgba(177, 174, 174, 0.3);
}
math-type.dark-mode compositeblock.math-diagram > math-diagram {
  background: #1e1e1e;
}
container-layer.dark-mode editor-container {
  background: #1e1e1e;
}

/**we use alpha as we have problem with background (without alpha) in Electron version (older Chrome) **/
/* z-index region*/
/**different context*/
/**different context*/
editor-container > math-type {
  background: white;
  outline: 1px solid lightgray;
}
math-type {
  display: block;
  position: relative;
  padding: 20px;
  color: black;
  padding-top: 15px;
  -webkit-touch-callout: none;
  -webkit-user-select: none;
  -khtml-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
  outline: none;
  cursor: text;
  text-align: initial;
}
math-type .rcnt {
  color: white;
  font-size: 12px;
  position: -webkit-sticky;
  position: sticky;
  top: 0;
  bottom: 0;
  display: flex;
  flex-direction: row;
}
math-type > .mt-sa {
  position: absolute;
  top: 0;
  left: -100px;
  right: -100px;
  bottom: -400px;
  -webkit-user-select: none;
  -khtml-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
  pointer-events: none;
}
math-type.math-only compositeblock.math-container-symbol {
  width: 100%;
}
math-type.math-only compositeblock.math-container-symbol.selected {
  outline: none;
  background: none;
}
math-type.math-only compositeblock.math-container-symbol > editarea {
  width: 100%;
}
math-type.math-only compositeblock.math-container-symbol > editarea > line {
  justify-content: flex-start;
}
math-type > input:not([type]),
math-type input[type="text"] {
  width: 50px;
}
math-type composition-indicator {
  display: block;
  position: absolute;
  height: 2px;
  min-width: 2px;
  border-bottom: 2px solid gray;
  left: 0;
  top: 0;
}
math-type .focus-element {
  outline: none;
  overflow: hidden;
  width: 0px;
  height: 0px;
  top: 0px;
  left: 0px;
  display: block;
  position: absolute;
  font-size: 40px;
}
.scroll-without-scrollbar {
  scrollbar-width: none;
  /* Firefox */
  -ms-overflow-style: none;
  /* IE 10+ */
}
.scroll-without-scrollbar::-webkit-scrollbar {
  width: 0;
  height: 0;
  display: none;
}
#root,
.main-container {
  width: 100%;
  color: #212121;
}
.sub-text-cursor,
.text-cursor {
  position: absolute;
  color: green;
  /*font-size: 1.2em;*/
  pointer-events: none;
  border-left: 2px solid green;
  display: block;
  top: 0px;
  left: 0px;
  z-index: 10;
}
.sub-text-cursor {
  opacity: 0.4;
}
math-edit-container {
  display: block;
  outline: none;
  position: relative;
  font-family: 'Asana';
}
.root-editor {
  min-height: 500px;
  box-sizing: border-box;
}
.root-editor.restricted-view {
  min-height: unset;
}
.root-editor.test-view {
  min-height: 100px;
}
.menu {
  color: #ffffff;
  text-transform: uppercase;
  text-decoration: none;
  font-family: "HelveticaNeue-Medium", sans-serif;
  font-size: 14px;
  display: inline-block;
  transform: scale(1, 1.5);
  -webkit-transform: scale(1, 1.5);
  /* Safari and Chrome */
  -moz-transform: scale(1, 1.5);
  /* Firefox */
  -ms-transform: scale(1, 1.5);
  /* IE 9+ */
  -o-transform: scale(1, 1.5);
  /* Opera */
}
.setting-group-options {
  font-size: 13px;
  color: gray;
  fill: gray;
}
.setting-group-options > i,
.setting-group-options > svg.icon {
  padding: 3px;
  cursor: pointer;
  border: 1px solid transparent;
  /*box-sizing: border-box;*/
}
.setting-group-options > i.selected,
.setting-group-options > svg.icon.selected {
  background-color: white;
  border: 1px solid lightgray;
}
.setting-group-options > i:hover,
.setting-group-options > svg.icon:hover {
  border: 1px solid lightgray;
}
.setting-group-options > i.disabled,
.setting-group-options > svg.icon.disabled {
  opacity: 0.3;
}
.setting-group-options > i.disabled:hover,
.setting-group-options > svg.icon.disabled:hover {
  background-color: inherit;
  border: 1px solid transparent;
}
math-type .math-text,
math-type .normal-text,
math-type .raw-latex {
  font-family: arial, verdana, geneva, lucida, 'lucida grande', arial, helvetica, sans-serif;
}
math-type .math-text editarea.text-mode > line.text-mode > blocks > block,
math-type .normal-text editarea.text-mode > line.text-mode > blocks > block,
math-type .raw-latex editarea.text-mode > line.text-mode > blocks > block {
  white-space: nowrap;
}
.mt-common-dialog {
  box-shadow: 1px 1px 1px 0px #e0dddd;
  background-color: #f7f7f7;
  border: 1px lightgray solid;
  z-index: 14;
  padding: 6px;
  cursor: default;
  font-family: "Segoe UI", Arial, Verdana, sans-serif;
}
disabled-layer {
  display: block;
  position: absolute;
  left: 0;
  top: 1px;
  right: 0;
  bottom: 2px;
  background: rgba(247, 247, 247, 0.66);
  /** consider export button z-index when change this one*/
  z-index: 500;
}
math-type tag-container tag-select-wrapper {
  position: absolute;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
}
math-type tag-container tag-box-select {
  position: absolute;
  display: block;
  background-color: green;
  opacity: 0;
  cursor: pointer;
  z-index: 15;
}
math-type tag-container tag-box-select:hover {
  opacity: 0.2;
}
math-type tag-container tag-box-gap {
  position: absolute;
  display: block;
  background-color: white;
  opacity: 0.9;
  z-index: 15;
}
.setting-popup-zindex {
  z-index: 11;
}
svg.selectable {
  cursor: pointer;
  border: 1px solid transparent;
}
svg.selectable.selected {
  background: white;
  border: solid 1px lightgray;
}
svg.selectable:hover {
  border: solid 1px lightgray;
}


@media print {
  @page {
    margin: 0;
  }
  /**
    Convert Preview into main print area
    */
  .math-type-doc,
  .docs-container,
  .modal-dialog-root-container,
  instructions-container {
    display: none !important;
  }
  .print-preview-container {
    position: static !important;
    display: block !important;
    visibility: visible !important;
    width: auto !important;
    height: auto !important;
    z-index: 99999 !important;
  }
  .print-container {
    position: static !important;
    overflow: hidden;
  }
  .print-preview-controls-container {
    display: none !important;
  }
  .math-type-no-print {
    display: none !important;
  }
  area-container.print-page-level {
    margin-left: 0 !important;
    margin-top: 0 !important;
    margin-right: 0 !important;
    margin-bottom: 0 !important;
    border: none !important;
    border-left: none !important;
    border-top: none !important;
    border-right: none !important;
    border-bottom: none !important;
    break-inside: avoid !important;
  }
  .area-container-border {
    border: none !important;
    border-left: none !important;
    border-top: none !important;
    border-right: none !important;
    border-bottom: none !important;
    display: none !important;
  }
  #print-container {
    background-color: transparent !important;
  }
  #print-container > math-type {
    background-color: transparent !important;
  }
  #print-container > math-type > math-edit-container > editarea {
    background-color: transparent !important;
  }
  /*-----------------------------*/
  header,
  .export-bar-container {
    display: none !important;
  }
  math-type {
    padding: 0 !important;
  }
  .print-remove-background {
    background-color: transparent !important;
  }
  document-info-bar {
    display: none !important;
  }
  document-sidebar-container {
    display: none !important;
  }
  body {
    position: relative !important;
  }
  page,
  #root,
  body,
  html {
    height: 100% !important;
    width: 100% !important;
    position: relative !important;
    background: white !important;
    overflow: visible !important;
  }
}
.print-background.math-type-for-print {
  -webkit-print-color-adjust: exact;
}
@media print {
  outline: none !important;
  .npm__react-simple-code-editor__textarea {
    display: none !important;
  }
  math-diagram {
    border: none !important;
  }
  .no-border-on-print {
    border: none !important;
  }
  .setting-select {
    display: none !important;
  }
  .no-print,
  ref-tag.empty-line-tag,
  .text-cursor,
  .sub-text-cursor,
  selection-wrapper,
  message-box-container,
  connection-controls,
  .control-point-guide,
  tool-bar,
  items-bar,
  document-sidebar,
  resize-bar,
  diagram-expander,
  warning-error-region,
  loading-layer,
  resizing-info,
  toc-refresh {
    display: none !important;
  }
  .no-print-outline {
    outline: none !important;
  }
  .selected {
    background: unset !important;
  }
  .math-container-symbol.selected {
    background: unset !important;
  }
  .matrix-symbol.align-symbol {
    background: unset !important;
  }
  .matrix-symbol.gather-symbol {
    background: unset !important;
  }
  tr.selected,
  td.selected {
    border: unset !important;
  }
  tr.selected.hline {
    border-top: 1px solid black !important;
  }
  tr.selected.last-hline {
    border-bottom: 1px solid black !important;
  }
  td.selected.vline {
    border-left: 1px solid black !important;
  }
  td.selected.last-vline {
    border-right: 1px solid black !important;
  }
  .selected {
    outline: unset !important;
  }
  container-layer {
    margin: 0 !important;
    padding: 0 !important;
    background: transparent !important;
    height: initial !important;
    overflow: visible !important;
  }
  editor-container {
    border: none !important;
    margin: 0 !important;
    padding: 0 !important;
    background: transparent !important;
    width: 100% !important;
  }
  content-area {
    padding: 0px !important;
    margin: 0;
    background: transparent !important;
  }
  vcomposed-symbol.non-safari > start {
    margin-bottom: -0.05em !important;
  }
  vcomposed-symbol.non-safari > middle-center {
    margin-top: -0.05em;
    margin-bottom: -0.05em !important;
  }
  vcomposed-symbol.non-safari > middle {
    margin-top: -0.05em;
    margin-bottom: -0.05em !important;
  }
  vcomposed-symbol.non-safari > end {
    margin-top: -0.05em !important;
  }
}
.math-type-for-print {
  outline: none !important;
}
.math-type-for-print .npm__react-simple-code-editor__textarea {
  display: none !important;
}
.math-type-for-print math-diagram {
  border: none !important;
}
.math-type-for-print .no-border-on-print {
  border: none !important;
}
.math-type-for-print .setting-select {
  display: none !important;
}
.math-type-for-print .no-print,
.math-type-for-print ref-tag.empty-line-tag,
.math-type-for-print .text-cursor,
.math-type-for-print .sub-text-cursor,
.math-type-for-print selection-wrapper,
.math-type-for-print message-box-container,
.math-type-for-print connection-controls,
.math-type-for-print .control-point-guide,
.math-type-for-print tool-bar,
.math-type-for-print items-bar,
.math-type-for-print document-sidebar,
.math-type-for-print resize-bar,
.math-type-for-print diagram-expander,
.math-type-for-print warning-error-region,
.math-type-for-print loading-layer,
.math-type-for-print resizing-info,
.math-type-for-print toc-refresh {
  display: none !important;
}
.math-type-for-print .no-print-outline {
  outline: none !important;
}
.math-type-for-print .selected {
  background: unset !important;
}
.math-type-for-print .math-container-symbol.selected {
  background: unset !important;
}
.math-type-for-print .matrix-symbol.align-symbol {
  background: unset !important;
}
.math-type-for-print .matrix-symbol.gather-symbol {
  background: unset !important;
}
.math-type-for-print tr.selected,
.math-type-for-print td.selected {
  border: unset !important;
}
.math-type-for-print tr.selected.hline {
  border-top: 1px solid black !important;
}
.math-type-for-print tr.selected.last-hline {
  border-bottom: 1px solid black !important;
}
.math-type-for-print td.selected.vline {
  border-left: 1px solid black !important;
}
.math-type-for-print td.selected.last-vline {
  border-right: 1px solid black !important;
}
.math-type-for-print .selected {
  outline: unset !important;
}
.math-type-for-print container-layer {
  margin: 0 !important;
  padding: 0 !important;
  background: transparent !important;
  height: initial !important;
  overflow: visible !important;
}
.math-type-for-print editor-container {
  border: none !important;
  margin: 0 !important;
  padding: 0 !important;
  background: transparent !important;
  width: 100% !important;
}
.math-type-for-print content-area {
  padding: 0px !important;
  margin: 0;
  background: transparent !important;
}
.math-type-for-print vcomposed-symbol.non-safari > start {
  margin-bottom: -0.05em !important;
}
.math-type-for-print vcomposed-symbol.non-safari > middle-center {
  margin-top: -0.05em;
  margin-bottom: -0.05em !important;
}
.math-type-for-print vcomposed-symbol.non-safari > middle {
  margin-top: -0.05em;
  margin-bottom: -0.05em !important;
}
.math-type-for-print vcomposed-symbol.non-safari > end {
  margin-top: -0.05em !important;
}
.justify-single-line {
  display: inline-block;
  text-align-last: justify;
  width: 100%;
}
.rtl-on-line-level {
  direction: rtl;
}

math-type modal-dialog.import-latex math-type editarea.root-editor {
  min-height: 100px;
}

/**we use alpha as we have problem with background (without alpha) in Electron version (older Chrome) **/
/* z-index region*/
/**different context*/
/**different context*/
math-type .mobile-keys-support-region {
  position: fixed;
  top: 84px;
  left: 45px;
  color: gray;
  z-index: 11609;
  opacity: 0.9;
  display: flex;
  width: auto;
  z-index: 600;
  cursor: pointer;
}
math-type .mobile-keys-support-region.is-android {
  top: unset;
  bottom: 4px;
  left: 17px;
}
math-type .mobile-keys-support-region.select-only {
  top: 40px;
  left: 25px;
}
math-type .mobile-keys-support-region.select-only .btn-suggestion-box-mobile {
  display: none;
}



.special-symbol-dialog__special-char {
  display: inline-block;
  width: 24px;
  height: 24px;
  line-height: 24px;
  border-bottom: 1px solid #ddd;
  border-right: 1px solid #ddd;
  text-align: center;
  cursor: pointer;
  outline: none;
}
.special-symbol-dialog__special-char:hover {
  background: #bfe4bd;
}

/**we use alpha as we have problem with background (without alpha) in Electron version (older Chrome) **/
/* z-index region*/
/**different context*/
/**different context*/
context-menu-container {
  position: fixed;
  left: 100px;
  top: 300px;
  z-index: 13;
  box-shadow: 2px 2px 3px 0px #c3c3c3;
  border: 1px solid lightgray;
  width: 200px;
  background: white;
  cursor: default;
  outline: none;
  font-family: "Segoe UI", Arial, Verdana, sans-serif;
}
context-menu-container ct-item {
  display: block;
  padding: 6px 9px;
  font-size: 13px;
  color: gray;
}
context-menu-container ct-item.disabled {
  color: lightgray;
}
context-menu-container ct-item:hover {
  background: #eae9e9;
}
context-menu-container ct-item.hidden {
  display: none;
}
context-menu-container ct-icon {
  width: 20px;
  display: inline-block;
}
context-menu-container ct-separator {
  width: 100%;
  display: block;
  height: 1px;
  margin-top: 2px;
  margin-bottom: 2px;
  border-top: 1px solid lightgray;
}

/* Collection default theme */
/* Grid default theme */
/* Table default theme */









/* List default theme */



math-type .symbol-container,
.auto-complete-external-area .symbol-container {
  display: flex;
  flex-direction: row;
  min-height: 25px;
  padding-left: 4px;
  padding-right: 12px;
  align-items: center;
  cursor: pointer;
}
math-type .symbol-container.selected,
.auto-complete-external-area .symbol-container.selected {
  background-color: #bfe4bd;
}
math-type .symbol-friendly-name,
.auto-complete-external-area .symbol-friendly-name {
  flex-grow: 1;
  font-family: Asana;
  /*padding-top: 6px;*/
}
math-type .symbol-icon,
.auto-complete-external-area .symbol-icon {
  /*padding-top: 6px;*/
  margin-right: 15px;
  min-width: 20px;
  text-align: center;
}
math-type .short-cut,
.auto-complete-external-area .short-cut {
  text-align: center;
  color: gray;
  /*vertical-align: middle;*/
  /*line-height: 20px;*/
  margin: 0 2px 0 2px;
  font-size: 12px;
  display: flex;
  align-items: center;
}
math-type .short-cut span,
.auto-complete-external-area .short-cut span {
  font-size: 10px;
}
math-type .hidden,
.auto-complete-external-area .hidden {
  display: none;
}







/**different context*/
/**different context*/
selection-wrapper {
  display: block;
  position: absolute;
  left: 0;
  top: 0;
  user-select: none;
  pointer-events: none;
  z-index: 9;
}
selection-wrapper > selection {
  display: block;
  position: absolute;
  background-color: rgba(0, 126, 255, 0.15);
  user-select: none;
  width: 100px;
  height: 100px;
  transform-origin: 0 0;
}
selection-wrapper.inactive > selection {
  background-color: rgba(58, 57, 57, 0.13);
}

region-highlight-container {
  user-select: none;
  pointer-events: none;
  display: block;
  position: absolute;
  width: 0px;
  height: 0px;
  top: 0;
  left: 0;
  border: 1px solid lightgoldenrodyellow;
  opacity: 0.2;
}
region-highlight-container > rhc-all > rh-rect {
  display: block;
  position: absolute;
  background: orange;
}
region-highlight-container > rh-selected-rect {
  display: block;
  position: absolute;
  background: red;
}

.math-template-btb.btn-normal {
  background: transparent;
  margin-left: 0;
  font-size: 12px;
  border: none;
}
.math-template-btb.btn-normal:hover {
  background: white;
}
.math-template-name-item:hover {
  background: #f7f7f7;
}

.math-template-tree .tree-node-name {
  white-space: nowrap;
}
.math-template-tree .tree-node-name:hover {
  background: #f7f7f7;
}

math-type compositeblock.bib-bibliography {
  width: 100%;
  display: block;
}
math-type compositeblock.bib-cite {
  display: inline;
  white-space: break-spaces;
}
math-type compositeblock.bib-cite > editarea.text-mode {
  display: inline;
}
math-type compositeblock.bib-cite > editarea.text-mode > line.text-mode {
  display: inline;
}
math-type compositeblock.bib-cite > editarea.text-mode > line.text-mode > blocks {
  display: inline;
}
.csl-context {
  white-space: pre-wrap;
}
.csl-context.csl-cite div {
  display: inline;
}
.csl-context div.csl-left-margin {
  float: left;
}
.csl-context div.csl-block {
  font-weight: bold;
}
.csl-context div.csl-right-inline {
  margin-left: 2.5em;
}
.csl-context div.csl-indent {
  margin-top: 0.5em;
  margin-left: 2em;
  padding-bottom: 0.2em;
  padding-left: 0.5em;
  border-left: 5px solid #ccc;
}

.caption-ref-select .role-item:hover {
  background: #edf9ec;
}

.footnote-mt-container {
  position: relative;
}
.footnote-mt-container .more-option-box {
  position: absolute;
  left: -25px;
  top: 0;
  width: 30px;
  bottom: 0;
  display: none;
}
.footnote-mt-container .more-option-box > div {
  background: #f7f7f7;
  border: 1px solid #d6d3d3;
  padding: 0 0.2em;
  cursor: pointer;
  color: gray;
  display: inline-block;
}
.footnote-mt-container.hover-select:hover .more-option-box {
  display: block;
}
.mt-doc-fn > math-edit-container > editarea > area-container > line > first-line-prefix {
  padding-right: 0.3em;
}
.mt-doc-fn > math-edit-container > editarea > area-container > line.has-rtl {
  direction: rtl;
}
.mt-doc-fn > math-edit-container > editarea > area-container > line.has-rtl > first-line-prefix {
  padding-left: 0.3em;
}
.blocks-inline > math-edit-container > editarea > area-container > line > blocks {
  display: inline;
}

.lang-name:hover {
  background: #f7f7f7;
}
.lang-name.selected {
  background: #e1e8f5;
}
.custom-lange-area input::placeholder,
.custom-lange-area textarea::placeholder {
  color: lightgray;
}

.page-print-item {
  position: relative;
}
.page-print-item:hover .page-print-item-hover {
  display: block;
}
.page-print-item-hover {
  display: none;
  position: absolute;
  top: 100%;
  left: 50%;
  transform: translateX(-50%);
  margin-top: 10px;
  background: #f7f6f6;
  z-index: 10;
  padding: 5px;
  font-size: 0.8em;
  white-space: nowrap;
  color: gray;
  border: 1px solid lightgray;
}

.settings-show-hide {
  background: rgba(255, 255, 255, 0.61);
}
.settings-show-hide:hover {
  background: white;
}
.group-symbol-collapsed {
  display: block;
  border: 1px dotted lightgray;
  padding-top: 0.1em;
  padding-bottom: 0.1em;
}
.role-math-mode-group.math-mode-group-expanded .settings-show-hide,
.role-text-mode-group-inline.text-mode-group-inline-expanded .settings-show-hide {
  display: none;
}
.role-math-mode-group.math-mode-group-expanded:hover,
.role-text-mode-group-inline.text-mode-group-inline-expanded:hover {
  outline: 1px solid lightgray;
}
.role-math-mode-group.math-mode-group-expanded:hover .settings-show-hide,
.role-text-mode-group-inline.text-mode-group-inline-expanded:hover .settings-show-hide {
  display: flex;
}

math-type compositeblock.text-super-script-symbol,
math-type compositeblock.text-sub-script-symbol {
  display: inline;
}
math-type compositeblock.text-super-script-symbol > editarea.text-mode,
math-type compositeblock.text-sub-script-symbol > editarea.text-mode {
  display: inline;
}
math-type compositeblock.text-super-script-symbol > editarea.text-mode > line.text-mode,
math-type compositeblock.text-sub-script-symbol > editarea.text-mode > line.text-mode {
  display: inline;
}
math-type compositeblock.text-super-script-symbol > editarea.text-mode > line.text-mode > blocks,
math-type compositeblock.text-sub-script-symbol > editarea.text-mode > line.text-mode > blocks {
  display: inline;
}
math-type .text-super-script-symbol {
  vertical-align: super;
}
math-type .text-sub-script-symbol {
  vertical-align: sub;
}

compositeblock.section-ref {
  display: inline;
}
compositeblock.section-ref > .section-ref-border {
  display: inline;
  white-space: pre-wrap;
}
compositeblock.section-ref > div {
  display: inline;
}



icon-dropdown-items icon-dropdown-item:hover {
  background: #eae9e9;
}
icon-dropdown ii-icon {
  fill: gray;
}
icon-dropdown:hover {
  color: #4e4d4d;
}
icon-dropdown:hover ii-icon {
  fill: #4e4d4d;
}

resizable-container {
  display: block;
  position: relative;
  min-height: 0;
  flex-shrink: 0;
}





a.fce {
  cursor: pointer;
}
a.fce:hover svg {
  fill: #2d4373;
}
a.fce svg {
  fill: #3b5998;
}
a.fce i {
  text-align: center;
  color: white;
}
a.gg {
  cursor: pointer;
}
a.gg:hover svg {
  fill: #c23321;
}
a.gg svg {
  fill: #dd4b39;
}
a.gg i {
  text-align: center;
  color: white;
}
a.twr {
  cursor: pointer;
}
a.twr:hover svg {
  fill: #2795e9;
}
a.twr svg {
  fill: #55acee;
}
a.twr i {
  text-align: center;
  color: white;
}
a.gh {
  cursor: pointer;
}
a.gh:hover svg {
  fill: #2b2b2b;
}
a.gh svg {
  fill: #444;
}
a.gh i {
  text-align: center;
  color: white;
}





modal-dialog.swift.document-name modal-container.mt-common-dialog {
  width: 500px;
  max-width: 95vw;
}
modal-dialog.swift.document-name document-name {
  width: 100%;
  display: flex;
  flex-direction: column;
}
modal-dialog.swift.document-name document-name label {
  display: block;
  font-size: 13px;
}
modal-dialog.swift.document-name document-name textarea {
  width: auto;
  display: block;
  margin: 5px 0px;
  height: 39px;
  outline: none;
  border: 1px solid lightgray;
  resize: vertical;
}

.dock-tab-content {
  flex: 1;
  min-height: 0;
  min-width: 0;
  display: none;
}
.dock-tab-content.active {
  display: flex;
}

quick-start editarea.root-editor {
  min-height: 100px;
}
quick-start > qs-math-type-container > math-type:hover {
  border: 1px solid gray;
}
quick-start > qs-math-type-container > math-type tool-bar {
  display: none;
}
quick-start > qs-math-type-container > math-type items-bar {
  display: none;
  left: -60px;
  top: 0px;
  box-shadow: 0px 1px 2px 0px #4c4949;
}





/**we use alpha as we have problem with background (without alpha) in Electron version (older Chrome) **/
/* z-index region*/
/**Context Level 1*/
/**both Level 1 and 2 Context */
/**Context Level 2 inside docsContainerZIndex*/
document-info-container document-info-bar {
  display: block;
  position: absolute;
  right: 15px;
  bottom: 5px;
  background: #f7f7f7;
  box-shadow: 1px 1px 1px 0px #e0dddd;
  border: 1px lightgray solid;
  font-size: 12px;
  padding: 0px;
  color: gray;
  opacity: 0.8;
  z-index: 4;
}
document-info-container document-info-bar:hover {
  opacity: 1;
}
document-info-container modal-container button.ok.btn-primary {
  display: none;
}
.Popover-body {
  font-size: 12px;
  padding: 10px;
  background: #4CAF50;
  box-shadow: #888686 1px 1px 1px 1px;
  color: white;
  max-width: 250px;
}
.Popover-tip {
  fill: #4CAF50;
}

/**Context Level 1*/
/**both Level 1 and 2 Context */
/**Context Level 2 inside docsContainerZIndex*/
.doc-toolbar-container {
  position: relative;
  background: #f7f7f7;
  top: 0;
  left: 0;
  width: 100%;
  border: 1px lightgray solid;
  margin-left: -2px;
  z-index: 6;
}
.doc-toolbar-container > tool-bar {
  position: relative;
  top: 0;
  left: 0;
  display: block;
  padding-left: 0px;
  min-width: 770px;
  width: 770px;
  margin: auto;
  background: transparent;
  box-shadow: none;
  border: none;
  height: 35px;
}











/**Context Level 1*/
/**both Level 1 and 2 Context */
/**Context Level 2 inside docsContainerZIndex*/


</style><style>/* @font-face {
  font-family: 'FontAwesome';
  src: format('woff'), url('fonts/icomoon.svg?erlpdm#icomoon') format('svg');
  font-weight: normal;
  font-style: normal;
} */

[class^="fa-"], [class*=" fa-"] {
  /* use !important to prevent issues with browser extensions that change fonts */
  /* font-family: 'FontAwesome' !important;
  speak: none;
  font-style: normal;
  font-weight: normal;
  font-variant: normal;
  text-transform: none; */
  /* line-height: 1; */
  /* Better Font Rendering =========== */
  /* -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale; */
  display: inline-block;
  font: normal normal normal 14px/1 FontAwesome;
  font-size: inherit;
  text-rendering: auto;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

.fa-plus:before {
  content: "\f067";
}
.fa-user:before {
  content: "\f007";
}
.fa-check:before {
  content: "\f00c";
}
.fa-close:before {
  content: "\f00d";
}
.fa-remove:before {
  content: "\f00d";
}
.fa-times:before {
  content: "\f00d";
}
.fa-search-plus:before {
  content: "\f00e";
}
.fa-search-minus:before {
  content: "\f010";
}
.fa-cog:before {
  content: "\f013";
}
.fa-gear:before {
  content: "\f013";
}
.fa-trash-o:before {
  content: "\f014";
}
.fa-file-o:before {
  content: "\f016";
}
.fa-refresh:before {
  content: "\f021";
}
.fa-font:before {
  content: "\f031";
}
.fa-bold:before {
  content: "\f032";
}
.fa-italic:before {
  content: "\f033";
}
.fa-align-left:before {
  content: "\f036";
}
.fa-align-center:before {
  content: "\f037";
}
.fa-align-right:before {
  content: "\f038";
}
.fa-dedent:before {
  content: "\f03b";
}
.fa-outdent:before {
  content: "\f03b";
}
.fa-indent:before {
  content: "\f03c";
}
.fa-image:before {
  content: "\f03e";
}
.fa-photo:before {
  content: "\f03e";
}
.fa-picture-o:before {
  content: "\f03e";
}
.fa-pencil:before {
  content: "\f040";
}
.fa-edit:before {
  content: "\f044";
}
.fa-pencil-square-o:before {
  content: "\f044";
}
.fa-share-square-o:before {
  content: "\f045";
}
.fa-arrows:before {
  content: "\f047";
}
.fa-chevron-left:before {
  content: "\f053";
}
.fa-chevron-right:before {
  content: "\f054";
}
.fa-times-circle:before {
  content: "\f057";
}
.fa-info-circle:before {
  content: "\f05a";
}
.fa-arrow-left:before {
  content: "\f060";
}
.fa-arrow-right:before {
  content: "\f061";
}
.fa-arrow-up:before {
  content: "\f062";
}
.fa-arrow-down:before {
  content: "\f063";
}
.fa-mail-forward:before {
  content: "\f064";
}
.fa-share:before {
  content: "\f064";
}
.fa-exclamation-circle:before {
  content: "\f06a";
}
.fa-exclamation-triangle:before {
  content: "\f071";
}
.fa-warning:before {
  content: "\f071";
}
.fa-chevron-up:before {
  content: "\f077";
}
.fa-chevron-down:before {
  content: "\f078";
}
.fa-folder:before {
  content: "\f07b";
}
.fa-folder-open:before {
  content: "\f07c";
}
.fa-twitter:before {
  content: "\f099";
}
.fa-twr:before {
  content: "\f099";
}
.fa-facebook:before {
  content: "\f09a";
}
.fa-fce:before {
  content: "\f09a";
}
.fa-facebook-f:before {
  content: "\f09a";
}
.fa-github:before {
  content: "\f09b";
}
.fa-gh:before {
  content: "\f09b";
}
.fa-cut:before {
  content: "\f0c4";
}
.fa-scissors:before {
  content: "\f0c4";
}
.fa-copy:before {
  content: "\f0c5";
}
.fa-files-o:before {
  content: "\f0c5";
}
.fa-bars:before {
  content: "\f0c9";
}
.fa-navicon:before {
  content: "\f0c9";
}
.fa-reorder:before {
  content: "\f0c9";
}
.fa-list-ul:before {
  content: "\f0ca";
}
.fa-list-ol:before {
  content: "\f0cb";
}
.fa-strikethrough:before {
  content: "\f0cc";
}
.fa-underline:before {
  content: "\f0cd";
}
.fa-table:before {
  content: "\f0ce";
}
.fa-magic:before {
  content: "\f0d0";
}
.fa-caret-down:before {
  content: "\f0d7";
}
.fa-caret-right:before {
  content: "\f0da";
}
.fa-sort-desc:before {
  content: "\f0dd";
}
.fa-sort-down:before {
  content: "\f0dd";
}
.fa-clipboard:before {
  content: "\f0ea";
}
.fa-paste:before {
  content: "\f0ea";
}
.fa-angle-double-left:before {
  content: "\f100";
}
.fa-angle-double-right:before {
  content: "\f101";
}
.fa-angle-double-up:before {
  content: "\f102";
}
.fa-angle-double-down:before {
  content: "\f103";
}
.fa-circle:before {
  content: "\f111";
}
.fa-mail-reply:before {
  content: "\f112";
}
.fa-reply:before {
  content: "\f112";
}
.fa-exclamation:before {
  content: "\f12a";
}
.fa-eraser:before {
  content: "\f12d";
}
.fa-ellipsis-h:before {
  content: "\f141";
}
.fa-ellipsis-v:before {
  content: "\f142";
}
.fa-file:before {
  content: "\f15b";
}
.fa-file-text:before {
  content: "\f15c";
}
.fa-google:before {
  content: "\f1a0";
}
.fa-gg:before {
  content: "\f1a0";
}
.fa-trash:before {
  content: "\f1f8";
}
.fa-i-cursor:before {
  content: "\f246";
}
.fa-hand-paper-o:before {
  content: "\f256";
}
.fa-hand-stop-o:before {
  content: "\f256";
}
</style><style>.MathJax_Hover_Frame {border-radius: .25em; -webkit-border-radius: .25em; -moz-border-radius: .25em; -khtml-border-radius: .25em; box-shadow: 0px 0px 15px #83A; -webkit-box-shadow: 0px 0px 15px #83A; -moz-box-shadow: 0px 0px 15px #83A; -khtml-box-shadow: 0px 0px 15px #83A; border: 1px solid #A6D ! important; display: inline-block; position: absolute}
.MathJax_Menu_Button .MathJax_Hover_Arrow {position: absolute; cursor: pointer; display: inline-block; border: 2px solid #AAA; border-radius: 4px; -webkit-border-radius: 4px; -moz-border-radius: 4px; -khtml-border-radius: 4px; font-family: 'Courier New',Courier; font-size: 9px; color: #F0F0F0}
.MathJax_Menu_Button .MathJax_Hover_Arrow span {display: block; background-color: #AAA; border: 1px solid; border-radius: 3px; line-height: 0; padding: 4px}
.MathJax_Hover_Arrow:hover {color: white!important; border: 2px solid #CCC!important}
.MathJax_Hover_Arrow:hover span {background-color: #CCC!important}
</style><style>#MathJax_About {position: fixed; left: 50%; width: auto; text-align: center; border: 3px outset; padding: 1em 2em; background-color: #DDDDDD; color: black; cursor: default; font-family: message-box; font-size: 120%; font-style: normal; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; border-radius: 15px; -webkit-border-radius: 15px; -moz-border-radius: 15px; -khtml-border-radius: 15px; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
#MathJax_About.MathJax_MousePost {outline: none}
.MathJax_Menu {position: absolute; background-color: white; color: black; width: auto; padding: 5px 0px; border: 1px solid #CCCCCC; margin: 0; cursor: default; font: menu; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; border-radius: 5px; -webkit-border-radius: 5px; -moz-border-radius: 5px; -khtml-border-radius: 5px; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
.MathJax_MenuItem {padding: 1px 2em; background: transparent}
.MathJax_MenuArrow {position: absolute; right: .5em; padding-top: .25em; color: #666666; font-size: .75em}
.MathJax_MenuActive .MathJax_MenuArrow {color: white}
.MathJax_MenuArrow.RTL {left: .5em; right: auto}
.MathJax_MenuCheck {position: absolute; left: .7em}
.MathJax_MenuCheck.RTL {right: .7em; left: auto}
.MathJax_MenuRadioCheck {position: absolute; left: .7em}
.MathJax_MenuRadioCheck.RTL {right: .7em; left: auto}
.MathJax_MenuLabel {padding: 1px 2em 3px 1.33em; font-style: italic}
.MathJax_MenuRule {border-top: 1px solid #DDDDDD; margin: 4px 3px}
.MathJax_MenuDisabled {color: GrayText}
.MathJax_MenuActive {background-color: #606872; color: white}
.MathJax_MenuDisabled:focus, .MathJax_MenuLabel:focus {background-color: #E8E8E8}
.MathJax_ContextMenu:focus {outline: none}
.MathJax_ContextMenu .MathJax_MenuItem:focus {outline: none}
#MathJax_AboutClose {top: .2em; right: .2em}
.MathJax_Menu .MathJax_MenuClose {top: -10px; left: -10px}
.MathJax_MenuClose {position: absolute; cursor: pointer; display: inline-block; border: 2px solid #AAA; border-radius: 18px; -webkit-border-radius: 18px; -moz-border-radius: 18px; -khtml-border-radius: 18px; font-family: 'Courier New',Courier; font-size: 24px; color: #F0F0F0}
.MathJax_MenuClose span {display: block; background-color: #AAA; border: 1.5px solid; border-radius: 18px; -webkit-border-radius: 18px; -moz-border-radius: 18px; -khtml-border-radius: 18px; line-height: 0; padding: 8px 0 6px}
.MathJax_MenuClose:hover {color: white!important; border: 2px solid #CCC!important}
.MathJax_MenuClose:hover span {background-color: #CCC!important}
.MathJax_MenuClose:hover:focus {outline: none}
</style><style>.MathJax_Preview .MJXf-math {color: inherit!important}
</style><style>.MJX_Assistive_MathML {position: absolute!important; top: 0; left: 0; clip: rect(1px, 1px, 1px, 1px); padding: 1px 0 0 0!important; border: 0!important; height: 1px!important; width: 1px!important; overflow: hidden!important; display: block!important; -webkit-touch-callout: none; -webkit-user-select: none; -khtml-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none}
.MJX_Assistive_MathML.MJX_Assistive_MathML_Block {width: 100%!important}
</style><style>#MathJax_Zoom {position: absolute; background-color: #F0F0F0; overflow: auto; display: block; z-index: 301; padding: .5em; border: 1px solid black; margin: 0; font-weight: normal; font-style: normal; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; -webkit-box-sizing: content-box; -moz-box-sizing: content-box; box-sizing: content-box; box-shadow: 5px 5px 15px #AAAAAA; -webkit-box-shadow: 5px 5px 15px #AAAAAA; -moz-box-shadow: 5px 5px 15px #AAAAAA; -khtml-box-shadow: 5px 5px 15px #AAAAAA; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
#MathJax_ZoomOverlay {position: absolute; left: 0; top: 0; z-index: 300; display: inline-block; width: 100%; height: 100%; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
#MathJax_ZoomFrame {position: relative; display: inline-block; height: 0; width: 0}
#MathJax_ZoomEventTrap {position: absolute; left: 0; top: 0; z-index: 302; display: inline-block; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
</style><style>.MathJax_Preview {color: #888}
#MathJax_Message {position: fixed; left: 1em; bottom: 1.5em; background-color: #E6E6E6; border: 1px solid #959595; margin: 0px; padding: 2px 8px; z-index: 102; color: black; font-size: 80%; width: auto; white-space: nowrap}
#MathJax_MSIE_Frame {position: absolute; top: 0; left: 0; width: 0px; z-index: 101; border: 0px; margin: 0px; padding: 0px}
.MathJax_Error {color: #CC0000; font-style: italic}
</style><style>.MJXp-script {font-size: .8em}
.MJXp-right {-webkit-transform-origin: right; -moz-transform-origin: right; -ms-transform-origin: right; -o-transform-origin: right; transform-origin: right}
.MJXp-bold {font-weight: bold}
.MJXp-italic {font-style: italic}
.MJXp-scr {font-family: MathJax_Script,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-frak {font-family: MathJax_Fraktur,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-sf {font-family: MathJax_SansSerif,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-cal {font-family: MathJax_Caligraphic,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-mono {font-family: MathJax_Typewriter,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-largeop {font-size: 150%}
.MJXp-largeop.MJXp-int {vertical-align: -.2em}
.MJXp-math {display: inline-block; line-height: 1.2; text-indent: 0; font-family: 'Times New Roman',Times,STIXGeneral,serif; white-space: nowrap; border-collapse: collapse}
.MJXp-display {display: block; text-align: center; margin: 1em 0}
.MJXp-math span {display: inline-block}
.MJXp-box {display: block!important; text-align: center}
.MJXp-box:after {content: " "}
.MJXp-rule {display: block!important; margin-top: .1em}
.MJXp-char {display: block!important}
.MJXp-mo {margin: 0 .15em}
.MJXp-mfrac {margin: 0 .125em; vertical-align: .25em}
.MJXp-denom {display: inline-table!important; width: 100%}
.MJXp-denom > * {display: table-row!important}
.MJXp-surd {vertical-align: top}
.MJXp-surd > * {display: block!important}
.MJXp-script-box > *  {display: table!important; height: 50%}
.MJXp-script-box > * > * {display: table-cell!important; vertical-align: top}
.MJXp-script-box > *:last-child > * {vertical-align: bottom}
.MJXp-script-box > * > * > * {display: block!important}
.MJXp-mphantom {visibility: hidden}
.MJXp-munderover {display: inline-table!important}
.MJXp-over {display: inline-block!important; text-align: center}
.MJXp-over > * {display: block!important}
.MJXp-munderover > * {display: table-row!important}
.MJXp-mtable {vertical-align: .25em; margin: 0 .125em}
.MJXp-mtable > * {display: inline-table!important; vertical-align: middle}
.MJXp-mtr {display: table-row!important}
.MJXp-mtd {display: table-cell!important; text-align: center; padding: .5em 0 0 .5em}
.MJXp-mtr > .MJXp-mtd:first-child {padding-left: 0}
.MJXp-mtr:first-child > .MJXp-mtd {padding-top: 0}
.MJXp-mlabeledtr {display: table-row!important}
.MJXp-mlabeledtr > .MJXp-mtd:first-child {padding-left: 0}
.MJXp-mlabeledtr:first-child > .MJXp-mtd {padding-top: 0}
.MJXp-merror {background-color: #FFFF88; color: #CC0000; border: 1px solid #CC0000; padding: 1px 3px; font-style: normal; font-size: 90%}
.MJXp-scale0 {-webkit-transform: scaleX(.0); -moz-transform: scaleX(.0); -ms-transform: scaleX(.0); -o-transform: scaleX(.0); transform: scaleX(.0)}
.MJXp-scale1 {-webkit-transform: scaleX(.1); -moz-transform: scaleX(.1); -ms-transform: scaleX(.1); -o-transform: scaleX(.1); transform: scaleX(.1)}
.MJXp-scale2 {-webkit-transform: scaleX(.2); -moz-transform: scaleX(.2); -ms-transform: scaleX(.2); -o-transform: scaleX(.2); transform: scaleX(.2)}
.MJXp-scale3 {-webkit-transform: scaleX(.3); -moz-transform: scaleX(.3); -ms-transform: scaleX(.3); -o-transform: scaleX(.3); transform: scaleX(.3)}
.MJXp-scale4 {-webkit-transform: scaleX(.4); -moz-transform: scaleX(.4); -ms-transform: scaleX(.4); -o-transform: scaleX(.4); transform: scaleX(.4)}
.MJXp-scale5 {-webkit-transform: scaleX(.5); -moz-transform: scaleX(.5); -ms-transform: scaleX(.5); -o-transform: scaleX(.5); transform: scaleX(.5)}
.MJXp-scale6 {-webkit-transform: scaleX(.6); -moz-transform: scaleX(.6); -ms-transform: scaleX(.6); -o-transform: scaleX(.6); transform: scaleX(.6)}
.MJXp-scale7 {-webkit-transform: scaleX(.7); -moz-transform: scaleX(.7); -ms-transform: scaleX(.7); -o-transform: scaleX(.7); transform: scaleX(.7)}
.MJXp-scale8 {-webkit-transform: scaleX(.8); -moz-transform: scaleX(.8); -ms-transform: scaleX(.8); -o-transform: scaleX(.8); transform: scaleX(.8)}
.MJXp-scale9 {-webkit-transform: scaleX(.9); -moz-transform: scaleX(.9); -ms-transform: scaleX(.9); -o-transform: scaleX(.9); transform: scaleX(.9)}
.MathJax_PHTML .noError {vertical-align: ; font-size: 90%; text-align: left; color: black; padding: 1px 3px; border: 1px solid}
</style></head><body style="overflow:auto;background:rgb(255, 255, 255);width:auto;height:auto;"><editor-container style="display:block;margin:auto;width:816px;"><math-type style="user-select:text;" class=" math-type-for-print "><math-edit-container><editarea class="root-editor" style="font-family: &quot;Computer Modern Sans&quot;, serif; font-size: 17px;"><area-baseline aria-hidden="true">a</area-baseline><area-container><line class="root text-mode align-center" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; font-size: 1.73em; font-weight: bold;">Deep Learning with Databricks</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="anchor-tag inline" style="font-family: &quot;Computer Modern Serif&quot;, serif; font-weight: bold;"><div data-id="n0.3715415633810799" class="anchor-tag-border no-border-on-print" id="n0.3715415633810799"><span>Table of Content</span></div></compositeblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="table-of-content inline"><toc-wrapper style="opacity: 1;"><editarea class="edit-area toc-ea no-area-container text-mode"><line class="text-mode toc-s1" style="line-height: 1.4; cursor: pointer;"><a href="#n0.8216159908346063" style="color: inherit; text-decoration: inherit;"><prefix style="cursor: pointer;"></prefix><blocks style="cursor: pointer;"><baselineblock class="inline"></baselineblock><compositeblock class="prefix-block inline"><span data-line-id="n0.8216159908346063" style="display: inline-block; white-space: pre;">1. </span></compositeblock><block>Keras Fundamentals</block><compositeblock dir="ltr" class="toc-underline-placeholder-symbol inline" style="width: 20px; overflow: visible;"><svg data-reactroot="" style="width: 562.68px; height: 5px; overflow: visible; display: inline-block;"><path d="M 5,5 L562.6796875,5" stroke-dasharray="1 2" fill="none"></path></svg></compositeblock><compositeblock dir="ltr" class="toc-page-number-symbol inline"><span> </span></compositeblock></blocks></a></line><line class="text-mode toc-s2" style="line-height: 1.4; padding-left: 3em; cursor: pointer;"><a href="#n0.12412752945172945" style="color: inherit; text-decoration: inherit;"><prefix style="cursor: pointer;"></prefix><blocks style="cursor: pointer;"><baselineblock class="inline"></baselineblock><compositeblock class="prefix-block inline"><span data-line-id="n0.12412752945172945" style="display: inline-block; white-space: pre;">1.1. </span></compositeblock><block>Keras</block><compositeblock dir="ltr" class="toc-underline-placeholder-symbol inline" style="width: 20px; overflow: visible;"><svg data-reactroot="" style="width: 619.547px; height: 5px; overflow: visible; display: inline-block;"><path d="M 5,5 L619.546875,5" stroke-dasharray="1 2" fill="none"></path></svg></compositeblock><compositeblock dir="ltr" class="toc-page-number-symbol inline"><span> </span></compositeblock></blocks></a></line><line class="text-mode toc-s2" style="line-height: 1.4; padding-left: 3em; cursor: pointer;"><a href="#n0.08122664088479059" style="color: inherit; text-decoration: inherit;"><prefix style="cursor: pointer;"></prefix><blocks style="cursor: pointer;"><baselineblock class="inline"></baselineblock><compositeblock class="prefix-block inline"><span data-line-id="n0.08122664088479059" style="display: inline-block; white-space: pre;">1.2. </span></compositeblock><block>Hardware Considerations</block><compositeblock dir="ltr" class="toc-underline-placeholder-symbol inline" style="width: 20px; overflow: visible;"><svg data-reactroot="" style="width: 484.18px; height: 5px; overflow: visible; display: inline-block;"><path d="M 5,5 L484.1796875,5" stroke-dasharray="1 2" fill="none"></path></svg></compositeblock><compositeblock dir="ltr" class="toc-page-number-symbol inline"><span> </span></compositeblock></blocks></a></line><line class="text-mode toc-s2" style="line-height: 1.4; padding-left: 3em; cursor: pointer;"><a href="#n0.6708026075031961" style="color: inherit; text-decoration: inherit;"><prefix style="cursor: pointer;"></prefix><blocks style="cursor: pointer;"><baselineblock class="inline"></baselineblock><compositeblock class="prefix-block inline"><span data-line-id="n0.6708026075031961" style="display: inline-block; white-space: pre;">1.3. </span></compositeblock><block>Neural Network Fundamentals</block><compositeblock dir="ltr" class="toc-underline-placeholder-symbol inline" style="width: 20px; overflow: visible;"><svg data-reactroot="" style="width: 444.688px; height: 5px; overflow: visible; display: inline-block;"><path d="M 5,5 L444.6875,5" stroke-dasharray="1 2" fill="none"></path></svg></compositeblock><compositeblock dir="ltr" class="toc-page-number-symbol inline"><span> </span></compositeblock></blocks></a></line><line class="text-mode toc-s3" style="line-height: 1.4; padding-left: 6em; cursor: pointer;"><a href="#n0.02653560578766556" style="color: inherit; text-decoration: inherit;"><prefix style="cursor: pointer;"></prefix><blocks style="cursor: pointer;"><baselineblock class="inline"></baselineblock><compositeblock class="prefix-block inline"><span data-line-id="n0.02653560578766556" style="display: inline-block; white-space: pre;">1.3.1. </span></compositeblock><block>Activation Functions</block><compositeblock dir="ltr" class="toc-underline-placeholder-symbol inline" style="width: 20px; overflow: visible;"><svg data-reactroot="" style="width: 449.07px; height: 5px; overflow: visible; display: inline-block;"><path d="M 5,5 L449.0703125,5" stroke-dasharray="1 2" fill="none"></path></svg></compositeblock><compositeblock dir="ltr" class="toc-page-number-symbol inline"><span> </span></compositeblock></blocks></a></line><line class="text-mode toc-s3" style="line-height: 1.4; padding-left: 6em; cursor: pointer;"><a href="#n0.7209444374430432" style="color: inherit; text-decoration: inherit;"><prefix style="cursor: pointer;"></prefix><blocks style="cursor: pointer;"><baselineblock class="inline"></baselineblock><compositeblock class="prefix-block inline"><span data-line-id="n0.7209444374430432" style="display: inline-block; white-space: pre;">1.3.2. </span></compositeblock><block>Optimizers</block><compositeblock dir="ltr" class="toc-underline-placeholder-symbol inline" style="width: 20px; overflow: visible;"><svg data-reactroot="" style="width: 518.82px; height: 5px; overflow: visible; display: inline-block;"><path d="M 5,5 L518.8203125,5" stroke-dasharray="1 2" fill="none"></path></svg></compositeblock><compositeblock dir="ltr" class="toc-page-number-symbol inline"><span> </span></compositeblock></blocks></a></line><line class="text-mode toc-s3" style="line-height: 1.4; padding-left: 6em; cursor: pointer;"><a href="#n0.1253253155017302" style="color: inherit; text-decoration: inherit;"><prefix style="cursor: pointer;"></prefix><blocks style="cursor: pointer;"><baselineblock class="inline"></baselineblock><compositeblock class="prefix-block inline"><span data-line-id="n0.1253253155017302" style="display: inline-block; white-space: pre;">1.3.3. </span></compositeblock><block>Linear Regression with Keras</block><compositeblock dir="ltr" class="toc-underline-placeholder-symbol inline" style="width: 20px; overflow: visible;"><svg data-reactroot="" style="width: 389.859px; height: 5px; overflow: visible; display: inline-block;"><path d="M 5,5 L389.859375,5" stroke-dasharray="1 2" fill="none"></path></svg></compositeblock><compositeblock dir="ltr" class="toc-page-number-symbol inline"><span> </span></compositeblock></blocks></a></line><line class="text-mode toc-s2" style="line-height: 1.4; padding-left: 3em; cursor: pointer;"><a href="#n0.19553066077568682" style="color: inherit; text-decoration: inherit;"><prefix style="cursor: pointer;"></prefix><blocks style="cursor: pointer;"><baselineblock class="inline"></baselineblock><compositeblock class="prefix-block inline"><span data-line-id="n0.19553066077568682" style="display: inline-block; white-space: pre;">1.4. </span></compositeblock><block>Build a Simple Neural Network with Keras</block><compositeblock dir="ltr" class="toc-underline-placeholder-symbol inline" style="width: 20px; overflow: visible;"><svg data-reactroot="" style="width: 357.445px; height: 5px; overflow: visible; display: inline-block;"><path d="M 5,5 L357.4453125,5" stroke-dasharray="1 2" fill="none"></path></svg></compositeblock><compositeblock dir="ltr" class="toc-page-number-symbol inline"><span> </span></compositeblock></blocks></a></line><line class="text-mode toc-s2" style="line-height: 1.4; padding-left: 3em; cursor: pointer;"><a href="#n0.6587288027127318" style="color: inherit; text-decoration: inherit;"><prefix style="cursor: pointer;"></prefix><blocks style="cursor: pointer;"><baselineblock class="inline"></baselineblock><compositeblock class="prefix-block inline"><span data-line-id="n0.6587288027127318" style="display: inline-block; white-space: pre;">1.5. </span></compositeblock><block>Preprocessing with tf.keras.layers</block><compositeblock dir="ltr" class="toc-underline-placeholder-symbol inline" style="width: 20px; overflow: visible;"><svg data-reactroot="" style="width: 425.031px; height: 5px; overflow: visible; display: inline-block;"><path d="M 5,5 L425.03125,5" stroke-dasharray="1 2" fill="none"></path></svg></compositeblock><compositeblock dir="ltr" class="toc-page-number-symbol inline"><span> </span></compositeblock></blocks></a></line><line class="text-mode toc-s3" style="line-height: 1.4; padding-left: 6em; cursor: pointer;"><a href="#n0.2836853497313969" style="color: inherit; text-decoration: inherit;"><prefix style="cursor: pointer;"></prefix><blocks style="cursor: pointer;"><baselineblock class="inline"></baselineblock><compositeblock class="prefix-block inline"><span data-line-id="n0.2836853497313969" style="display: inline-block; white-space: pre;">1.5.1. </span></compositeblock><block>Normalization</block><compositeblock dir="ltr" class="toc-underline-placeholder-symbol inline" style="width: 20px; overflow: visible;"><svg data-reactroot="" style="width: 496.453px; height: 5px; overflow: visible; display: inline-block;"><path d="M 5,5 L496.453125,5" stroke-dasharray="1 2" fill="none"></path></svg></compositeblock><compositeblock dir="ltr" class="toc-page-number-symbol inline"><span> </span></compositeblock></blocks></a></line><line class="text-mode toc-s2" style="line-height: 1.4; padding-left: 3em; cursor: pointer;"><a href="#n0.4041849592632032" style="color: inherit; text-decoration: inherit;"><prefix style="cursor: pointer;"></prefix><blocks style="cursor: pointer;"><baselineblock class="inline"></baselineblock><compositeblock class="prefix-block inline"><span data-line-id="n0.4041849592632032" style="display: inline-block; white-space: pre;">1.6. </span></compositeblock><block>Callbacks</block><compositeblock dir="ltr" class="toc-underline-placeholder-symbol inline" style="width: 20px; overflow: visible;"><svg data-reactroot="" style="width: 592.906px; height: 5px; overflow: visible; display: inline-block;"><path d="M 5,5 L592.90625,5" stroke-dasharray="1 2" fill="none"></path></svg></compositeblock><compositeblock dir="ltr" class="toc-page-number-symbol inline"><span> </span></compositeblock></blocks></a></line><line class="text-mode toc-s3" style="line-height: 1.4; padding-left: 6em; cursor: pointer;"><a href="#n0.1217174443780098" style="color: inherit; text-decoration: inherit;"><prefix style="cursor: pointer;"></prefix><blocks style="cursor: pointer;"><baselineblock class="inline"></baselineblock><compositeblock class="prefix-block inline"><span data-line-id="n0.1217174443780098" style="display: inline-block; white-space: pre;">1.6.1. </span></compositeblock><block>Validation Data</block><compositeblock dir="ltr" class="toc-underline-placeholder-symbol inline" style="width: 20px; overflow: visible;"><svg data-reactroot="" style="width: 483.172px; height: 5px; overflow: visible; display: inline-block;"><path d="M 5,5 L483.171875,5" stroke-dasharray="1 2" fill="none"></path></svg></compositeblock><compositeblock dir="ltr" class="toc-page-number-symbol inline"><span> </span></compositeblock></blocks></a></line><line class="text-mode toc-s3" style="line-height: 1.4; padding-left: 6em; cursor: pointer;"><a href="#n0.999112295444228" style="color: inherit; text-decoration: inherit;"><prefix style="cursor: pointer;"></prefix><blocks style="cursor: pointer;"><baselineblock class="inline"></baselineblock><compositeblock class="prefix-block inline"><span data-line-id="n0.999112295444228" style="display: inline-block; white-space: pre;">1.6.2. </span></compositeblock><block>Checkpointing</block><compositeblock dir="ltr" class="toc-underline-placeholder-symbol inline" style="width: 20px; overflow: visible;"><svg data-reactroot="" style="width: 493.984px; height: 5px; overflow: visible; display: inline-block;"><path d="M 5,5 L493.984375,5" stroke-dasharray="1 2" fill="none"></path></svg></compositeblock><compositeblock dir="ltr" class="toc-page-number-symbol inline"><span> </span></compositeblock></blocks></a></line><line class="text-mode toc-s3" style="line-height: 1.4; padding-left: 6em; cursor: pointer;"><a href="#n0.6531623192089258" style="color: inherit; text-decoration: inherit;"><prefix style="cursor: pointer;"></prefix><blocks style="cursor: pointer;"><baselineblock class="inline"></baselineblock><compositeblock class="prefix-block inline"><span data-line-id="n0.6531623192089258" style="display: inline-block; white-space: pre;">1.6.3. </span></compositeblock><block>Tensorboard</block><compositeblock dir="ltr" class="toc-underline-placeholder-symbol inline" style="width: 20px; overflow: visible;"><svg data-reactroot="" style="width: 508.266px; height: 5px; overflow: visible; display: inline-block;"><path d="M 5,5 L508.265625,5" stroke-dasharray="1 2" fill="none"></path></svg></compositeblock><compositeblock dir="ltr" class="toc-page-number-symbol inline"><span> </span></compositeblock></blocks></a></line><line class="text-mode toc-s1" style="line-height: 1.4; cursor: pointer;"><a href="#n0.8289655899102821" style="color: inherit; text-decoration: inherit;"><prefix style="cursor: pointer;"></prefix><blocks style="cursor: pointer;"><baselineblock class="inline"></baselineblock><compositeblock class="prefix-block inline"><span data-line-id="n0.8289655899102821" style="display: inline-block; white-space: pre;">2. </span></compositeblock><block>MLflow</block><compositeblock dir="ltr" class="toc-underline-placeholder-symbol inline" style="width: 20px; overflow: visible;"><svg data-reactroot="" style="width: 653.766px; height: 5px; overflow: visible; display: inline-block;"><path d="M 5,5 L653.765625,5" stroke-dasharray="1 2" fill="none"></path></svg></compositeblock><compositeblock dir="ltr" class="toc-page-number-symbol inline"><span> </span></compositeblock></blocks></a></line><line class="text-mode toc-s2" style="line-height: 1.4; padding-left: 3em; cursor: pointer;"><a href="#n0.9218669531443409" style="color: inherit; text-decoration: inherit;"><prefix style="cursor: pointer;"></prefix><blocks style="cursor: pointer;"><baselineblock class="inline"></baselineblock><compositeblock class="prefix-block inline"><span data-line-id="n0.9218669531443409" style="display: inline-block; white-space: pre;">2.1. </span></compositeblock><block>Track Experiments</block><compositeblock dir="ltr" class="toc-underline-placeholder-symbol inline" style="width: 20px; overflow: visible;"><svg data-reactroot="" style="width: 526.578px; height: 5px; overflow: visible; display: inline-block;"><path d="M 5,5 L526.578125,5" stroke-dasharray="1 2" fill="none"></path></svg></compositeblock><compositeblock dir="ltr" class="toc-page-number-symbol inline"><span> </span></compositeblock></blocks></a></line><line class="text-mode toc-s2" style="line-height: 1.4; padding-left: 3em; cursor: pointer;"><a href="#n0.45963766848042265" style="color: inherit; text-decoration: inherit;"><prefix style="cursor: pointer;"></prefix><blocks style="cursor: pointer;"><baselineblock class="inline"></baselineblock><compositeblock class="prefix-block inline"><span data-line-id="n0.45963766848042265" style="display: inline-block; white-space: pre;">2.2. </span></compositeblock><block>Querying Past Runs</block><compositeblock dir="ltr" class="toc-underline-placeholder-symbol inline" style="width: 20px; overflow: visible;"><svg data-reactroot="" style="width: 517.938px; height: 5px; overflow: visible; display: inline-block;"><path d="M 5,5 L517.9375,5" stroke-dasharray="1 2" fill="none"></path></svg></compositeblock><compositeblock dir="ltr" class="toc-page-number-symbol inline"><span> </span></compositeblock></blocks></a></line><line class="text-mode toc-s2" style="line-height: 1.4; padding-left: 3em; cursor: pointer;"><a href="#n0.12718286624225938" style="color: inherit; text-decoration: inherit;"><prefix style="cursor: pointer;"></prefix><blocks style="cursor: pointer;"><baselineblock class="inline"></baselineblock><compositeblock class="prefix-block inline"><span data-line-id="n0.12718286624225938" style="display: inline-block; white-space: pre;">2.3. </span></compositeblock><block>User Defined Function</block><compositeblock dir="ltr" class="toc-underline-placeholder-symbol inline" style="width: 20px; overflow: visible;"><svg data-reactroot="" style="width: 500.633px; height: 5px; overflow: visible; display: inline-block;"><path d="M 5,5 L500.6328125,5" stroke-dasharray="1 2" fill="none"></path></svg></compositeblock><compositeblock dir="ltr" class="toc-page-number-symbol inline"><span> </span></compositeblock></blocks></a></line><line class="text-mode toc-s1" style="line-height: 1.4; cursor: pointer;"><a href="#n0.9453509797763815" style="color: inherit; text-decoration: inherit;"><prefix style="cursor: pointer;"></prefix><blocks style="cursor: pointer;"><baselineblock class="inline"></baselineblock><compositeblock class="prefix-block inline"><span data-line-id="n0.9453509797763815" style="display: inline-block; white-space: pre;">3. </span></compositeblock><block>Hyperparameter Tuning</block><compositeblock dir="ltr" class="toc-underline-placeholder-symbol inline" style="width: 20px; overflow: visible;"><svg data-reactroot="" style="width: 538.375px; height: 5px; overflow: visible; display: inline-block;"><path d="M 5,5 L538.375,5" stroke-dasharray="1 2" fill="none"></path></svg></compositeblock><compositeblock dir="ltr" class="toc-page-number-symbol inline"><span> </span></compositeblock></blocks></a></line><line class="text-mode toc-s2" style="line-height: 1.4; padding-left: 3em; cursor: pointer;"><a href="#n0.8806885533063584" style="color: inherit; text-decoration: inherit;"><prefix style="cursor: pointer;"></prefix><blocks style="cursor: pointer;"><baselineblock class="inline"></baselineblock><compositeblock class="prefix-block inline"><span data-line-id="n0.8806885533063584" style="display: inline-block; white-space: pre;">3.1. </span></compositeblock><block>Hyperopt</block><compositeblock dir="ltr" class="toc-underline-placeholder-symbol inline" style="width: 20px; overflow: visible;"><svg data-reactroot="" style="width: 593.453px; height: 5px; overflow: visible; display: inline-block;"><path d="M 5,5 L593.453125,5" stroke-dasharray="1 2" fill="none"></path></svg></compositeblock><compositeblock dir="ltr" class="toc-page-number-symbol inline"><span> </span></compositeblock></blocks></a></line><line class="text-mode toc-s3" style="line-height: 1.4; padding-left: 6em; cursor: pointer;"><a href="#n0.8500132802508897" style="color: inherit; text-decoration: inherit;"><prefix style="cursor: pointer;"></prefix><blocks style="cursor: pointer;"><baselineblock class="inline"></baselineblock><compositeblock class="prefix-block inline"><span data-line-id="n0.8500132802508897" style="display: inline-block; white-space: pre;">3.1.1. </span></compositeblock><block>Set up Hyperparameter Space and Training</block><compositeblock dir="ltr" class="toc-underline-placeholder-symbol inline" style="width: 20px; overflow: visible;"><svg data-reactroot="" style="width: 287.109px; height: 5px; overflow: visible; display: inline-block;"><path d="M 5,5 L287.109375,5" stroke-dasharray="1 2" fill="none"></path></svg></compositeblock><compositeblock dir="ltr" class="toc-page-number-symbol inline"><span> </span></compositeblock></blocks></a></line><line class="text-mode toc-s1" style="line-height: 1.4; cursor: pointer;"><a href="#n0.21926842074690178" style="color: inherit; text-decoration: inherit;"><prefix style="cursor: pointer;"></prefix><blocks style="cursor: pointer;"><baselineblock class="inline"></baselineblock><compositeblock class="prefix-block inline"><span data-line-id="n0.21926842074690178" style="display: inline-block; white-space: pre;">4. </span></compositeblock><block>Petastorm and Horovod</block><compositeblock dir="ltr" class="toc-underline-placeholder-symbol inline" style="width: 20px; overflow: visible;"><svg data-reactroot="" style="width: 537.352px; height: 5px; overflow: visible; display: inline-block;"><path d="M 5,5 L537.3515625,5" stroke-dasharray="1 2" fill="none"></path></svg></compositeblock><compositeblock dir="ltr" class="toc-page-number-symbol inline"><span> </span></compositeblock></blocks></a></line><line class="text-mode toc-s2" style="line-height: 1.4; padding-left: 3em; cursor: pointer;"><a href="#n0.5455534651856233" style="color: inherit; text-decoration: inherit;"><prefix style="cursor: pointer;"></prefix><blocks style="cursor: pointer;"><baselineblock class="inline"></baselineblock><compositeblock class="prefix-block inline"><span data-line-id="n0.5455534651856233" style="display: inline-block; white-space: pre;">4.1. </span></compositeblock><block>Petastorm</block><compositeblock dir="ltr" class="toc-underline-placeholder-symbol inline" style="width: 20px; overflow: visible;"><svg data-reactroot="" style="width: 587.164px; height: 5px; overflow: visible; display: inline-block;"><path d="M 5,5 L587.1640625,5" stroke-dasharray="1 2" fill="none"></path></svg></compositeblock><compositeblock dir="ltr" class="toc-page-number-symbol inline"><span> </span></compositeblock></blocks></a></line><line class="text-mode toc-s3" style="line-height: 1.4; padding-left: 6em; cursor: pointer;"><a href="#n0.7897191516441164" style="color: inherit; text-decoration: inherit;"><prefix style="cursor: pointer;"></prefix><blocks style="cursor: pointer;"><baselineblock class="inline"></baselineblock><compositeblock class="prefix-block inline"><span data-line-id="n0.7897191516441164" style="display: inline-block; white-space: pre;">4.1.1. </span></compositeblock><block>Preprocessing Data for Petastorm</block><compositeblock dir="ltr" class="toc-underline-placeholder-symbol inline" style="width: 20px; overflow: visible;"><svg data-reactroot="" style="width: 355.398px; height: 5px; overflow: visible; display: inline-block;"><path d="M 5,5 L355.3984375,5" stroke-dasharray="1 2" fill="none"></path></svg></compositeblock><compositeblock dir="ltr" class="toc-page-number-symbol inline"><span> </span></compositeblock></blocks></a></line><line class="text-mode toc-s2" style="line-height: 1.4; padding-left: 3em; cursor: pointer;"><a href="#n0.007155380855395466" style="color: inherit; text-decoration: inherit;"><prefix style="cursor: pointer;"></prefix><blocks style="cursor: pointer;"><baselineblock class="inline"></baselineblock><compositeblock class="prefix-block inline"><span data-line-id="n0.007155380855395466" style="display: inline-block; white-space: pre;">4.2. </span></compositeblock><block>Horovod</block><compositeblock dir="ltr" class="toc-underline-placeholder-symbol inline" style="width: 20px; overflow: visible;"><svg data-reactroot="" style="width: 599.406px; height: 5px; overflow: visible; display: inline-block;"><path d="M 5,5 L599.40625,5" stroke-dasharray="1 2" fill="none"></path></svg></compositeblock><compositeblock dir="ltr" class="toc-page-number-symbol inline"><span> </span></compositeblock></blocks></a></line><line class="text-mode toc-s3" style="line-height: 1.4; padding-left: 6em; cursor: pointer;"><a href="#n0.3817992936145109" style="color: inherit; text-decoration: inherit;"><prefix style="cursor: pointer;"></prefix><blocks style="cursor: pointer;"><baselineblock class="inline"></baselineblock><compositeblock class="prefix-block inline"><span data-line-id="n0.3817992936145109" style="display: inline-block; white-space: pre;">4.2.1. </span></compositeblock><block>Data Communication</block><compositeblock dir="ltr" class="toc-underline-placeholder-symbol inline" style="width: 20px; overflow: visible;"><svg data-reactroot="" style="width: 443.562px; height: 5px; overflow: visible; display: inline-block;"><path d="M 5,5 L443.5625,5" stroke-dasharray="1 2" fill="none"></path></svg></compositeblock><compositeblock dir="ltr" class="toc-page-number-symbol inline"><span> </span></compositeblock></blocks></a></line><line class="text-mode toc-s1" style="line-height: 1.4; cursor: pointer;"><a href="#n0.3420406311367108" style="color: inherit; text-decoration: inherit;"><prefix style="cursor: pointer;"></prefix><blocks style="cursor: pointer;"><baselineblock class="inline"></baselineblock><compositeblock class="prefix-block inline"><span data-line-id="n0.3420406311367108" style="display: inline-block; white-space: pre;">5. </span></compositeblock><block>Model Interpretability</block><compositeblock dir="ltr" class="toc-underline-placeholder-symbol inline" style="width: 20px; overflow: visible;"><svg data-reactroot="" style="width: 553.234px; height: 5px; overflow: visible; display: inline-block;"><path d="M 5,5 L553.234375,5" stroke-dasharray="1 2" fill="none"></path></svg></compositeblock><compositeblock dir="ltr" class="toc-page-number-symbol inline"><span> </span></compositeblock></blocks></a></line><line class="text-mode toc-s2" style="line-height: 1.4; padding-left: 3em; cursor: pointer;"><a href="#n0.9882978515245113" style="color: inherit; text-decoration: inherit;"><prefix style="cursor: pointer;"></prefix><blocks style="cursor: pointer;"><baselineblock class="inline"></baselineblock><compositeblock class="prefix-block inline"><span data-line-id="n0.9882978515245113" style="display: inline-block; white-space: pre;">5.1. </span></compositeblock><block>SHAP</block><compositeblock dir="ltr" class="toc-underline-placeholder-symbol inline" style="width: 20px; overflow: visible;"><svg data-reactroot="" style="width: 615.703px; height: 5px; overflow: visible; display: inline-block;"><path d="M 5,5 L615.703125,5" stroke-dasharray="1 2" fill="none"></path></svg></compositeblock><compositeblock dir="ltr" class="toc-page-number-symbol inline"><span> </span></compositeblock></blocks></a></line><line class="text-mode toc-s3" style="line-height: 1.4; padding-left: 6em; cursor: pointer;"><a href="#n0.5165138824355573" style="color: inherit; text-decoration: inherit;"><prefix style="cursor: pointer;"></prefix><blocks style="cursor: pointer;"><baselineblock class="inline"></baselineblock><compositeblock class="prefix-block inline"><span data-line-id="n0.5165138824355573" style="display: inline-block; white-space: pre;">5.1.1. </span></compositeblock><block>Visualize </block><compositeblock dir="ltr" class="toc-underline-placeholder-symbol inline" style="width: 20px; overflow: visible;"><svg data-reactroot="" style="width: 527.562px; height: 5px; overflow: visible; display: inline-block;"><path d="M 5,5 L527.5625,5" stroke-dasharray="1 2" fill="none"></path></svg></compositeblock><compositeblock dir="ltr" class="toc-page-number-symbol inline"><span> </span></compositeblock></blocks></a></line><line class="text-mode toc-s1" style="line-height: 1.4; cursor: pointer;"><a href="#n0.5222750491828694" style="color: inherit; text-decoration: inherit;"><prefix style="cursor: pointer;"></prefix><blocks style="cursor: pointer;"><baselineblock class="inline"></baselineblock><compositeblock class="prefix-block inline"><span data-line-id="n0.5222750491828694" style="display: inline-block; white-space: pre;">6. </span></compositeblock><block>Convolutional Neural Networks (CNN)</block><compositeblock dir="ltr" class="toc-underline-placeholder-symbol inline" style="width: 20px; overflow: visible;"><svg data-reactroot="" style="width: 432.953px; height: 5px; overflow: visible; display: inline-block;"><path d="M 5,5 L432.953125,5" stroke-dasharray="1 2" fill="none"></path></svg></compositeblock><compositeblock dir="ltr" class="toc-page-number-symbol inline"><span> </span></compositeblock></blocks></a></line><line class="text-mode toc-s2" style="line-height: 1.4; padding-left: 3em; cursor: pointer;"><a href="#n0.9266219639735855" style="color: inherit; text-decoration: inherit;"><prefix style="cursor: pointer;"></prefix><blocks style="cursor: pointer;"><baselineblock class="inline"></baselineblock><compositeblock class="prefix-block inline"><span data-line-id="n0.9266219639735855" style="display: inline-block; white-space: pre;">6.1. </span></compositeblock><block>InceptionV3 + Batch Normalization</block><compositeblock dir="ltr" class="toc-underline-placeholder-symbol inline" style="width: 20px; overflow: visible;"><svg data-reactroot="" style="width: 403.766px; height: 5px; overflow: visible; display: inline-block;"><path d="M 5,5 L403.765625,5" stroke-dasharray="1 2" fill="none"></path></svg></compositeblock><compositeblock dir="ltr" class="toc-page-number-symbol inline"><span> </span></compositeblock></blocks></a></line><line class="text-mode toc-s2" style="line-height: 1.4; padding-left: 3em; cursor: pointer;"><a href="#n0.06289071821290926" style="color: inherit; text-decoration: inherit;"><prefix style="cursor: pointer;"></prefix><blocks style="cursor: pointer;"><baselineblock class="inline"></baselineblock><compositeblock class="prefix-block inline"><span data-line-id="n0.06289071821290926" style="display: inline-block; white-space: pre;">6.2. </span></compositeblock><block>Apply pre-trained model</block><compositeblock dir="ltr" class="toc-underline-placeholder-symbol inline" style="width: 20px; overflow: visible;"><svg data-reactroot="" style="width: 487.727px; height: 5px; overflow: visible; display: inline-block;"><path d="M 5,5 L487.7265625,5" stroke-dasharray="1 2" fill="none"></path></svg></compositeblock><compositeblock dir="ltr" class="toc-page-number-symbol inline"><span> </span></compositeblock></blocks></a></line><line class="text-mode toc-s2" style="line-height: 1.4; padding-left: 3em; cursor: pointer;"><a href="#n0.8820875133557278" style="color: inherit; text-decoration: inherit;"><prefix style="cursor: pointer;"></prefix><blocks style="cursor: pointer;"><baselineblock class="inline"></baselineblock><compositeblock class="prefix-block inline"><span data-line-id="n0.8820875133557278" style="display: inline-block; white-space: pre;">6.3. </span></compositeblock><block>Distributed Inference</block><compositeblock dir="ltr" class="toc-underline-placeholder-symbol inline" style="width: 20px; overflow: visible;"><svg data-reactroot="" style="width: 511.312px; height: 5px; overflow: visible; display: inline-block;"><path d="M 5,5 L511.3125,5" stroke-dasharray="1 2" fill="none"></path></svg></compositeblock><compositeblock dir="ltr" class="toc-page-number-symbol inline"><span> </span></compositeblock></blocks></a></line><line class="text-mode toc-s3" style="line-height: 1.4; padding-left: 6em; cursor: pointer;"><a href="#n0.5279198879771259" style="color: inherit; text-decoration: inherit;"><prefix style="cursor: pointer;"></prefix><blocks style="cursor: pointer;"><baselineblock class="inline"></baselineblock><compositeblock class="prefix-block inline"><span data-line-id="n0.5279198879771259" style="display: inline-block; white-space: pre;">6.3.1. </span></compositeblock><block>Pandas/Vectorized UDF</block><compositeblock dir="ltr" class="toc-underline-placeholder-symbol inline" style="width: 20px; overflow: visible;"><svg data-reactroot="" style="width: 422.844px; height: 5px; overflow: visible; display: inline-block;"><path d="M 5,5 L422.84375,5" stroke-dasharray="1 2" fill="none"></path></svg></compositeblock><compositeblock dir="ltr" class="toc-page-number-symbol inline"><span> </span></compositeblock></blocks></a></line><line class="text-mode toc-s3" style="line-height: 1.4; padding-left: 6em; cursor: pointer;"><a href="#n0.6439888477855658" style="color: inherit; text-decoration: inherit;"><prefix style="cursor: pointer;"></prefix><blocks style="cursor: pointer;"><baselineblock class="inline"></baselineblock><compositeblock class="prefix-block inline"><span data-line-id="n0.6439888477855658" style="display: inline-block; white-space: pre;">6.3.2. </span></compositeblock><block>Pandas Scalar Iterator UDF</block><compositeblock dir="ltr" class="toc-underline-placeholder-symbol inline" style="width: 20px; overflow: visible;"><svg data-reactroot="" style="width: 398.68px; height: 5px; overflow: visible; display: inline-block;"><path d="M 5,5 L398.6796875,5" stroke-dasharray="1 2" fill="none"></path></svg></compositeblock><compositeblock dir="ltr" class="toc-page-number-symbol inline"><span> </span></compositeblock></blocks></a></line><line class="text-mode toc-s3" style="line-height: 1.4; padding-left: 6em; cursor: pointer;"><a href="#n0.7909110108170461" style="color: inherit; text-decoration: inherit;"><prefix style="cursor: pointer;"></prefix><blocks style="cursor: pointer;"><baselineblock class="inline"></baselineblock><compositeblock class="prefix-block inline"><span data-line-id="n0.7909110108170461" style="display: inline-block; white-space: pre;">6.3.3. </span></compositeblock><block>Pandas Function API</block><compositeblock dir="ltr" class="toc-underline-placeholder-symbol inline" style="width: 20px; overflow: visible;"><svg data-reactroot="" style="width: 444.297px; height: 5px; overflow: visible; display: inline-block;"><path d="M 5,5 L444.296875,5" stroke-dasharray="1 2" fill="none"></path></svg></compositeblock><compositeblock dir="ltr" class="toc-page-number-symbol inline"><span> </span></compositeblock></blocks></a></line><line class="text-mode toc-s2" style="line-height: 1.4; padding-left: 3em; cursor: pointer;"><a href="#n0.09342749891982827" style="color: inherit; text-decoration: inherit;"><prefix style="cursor: pointer;"></prefix><blocks style="cursor: pointer;"><baselineblock class="inline"></baselineblock><compositeblock class="prefix-block inline"><span data-line-id="n0.09342749891982827" style="display: inline-block; white-space: pre;">6.4. </span></compositeblock><block>SHAP for CNNs</block><compositeblock dir="ltr" class="toc-underline-placeholder-symbol inline" style="width: 20px; overflow: visible;"><svg data-reactroot="" style="width: 543.914px; height: 5px; overflow: visible; display: inline-block;"><path d="M 5,5 L543.9140625,5" stroke-dasharray="1 2" fill="none"></path></svg></compositeblock><compositeblock dir="ltr" class="toc-page-number-symbol inline"><span> </span></compositeblock></blocks></a></line><line class="text-mode toc-s1" style="line-height: 1.4; cursor: pointer;"><a href="#n0.10051025533642255" style="color: inherit; text-decoration: inherit;"><prefix style="cursor: pointer;"></prefix><blocks style="cursor: pointer;"><baselineblock class="inline"></baselineblock><compositeblock class="prefix-block inline"><span data-line-id="n0.10051025533642255" style="display: inline-block; white-space: pre;">7. </span></compositeblock><block>Transfer Learning</block><compositeblock dir="ltr" class="toc-underline-placeholder-symbol inline" style="width: 20px; overflow: visible;"><svg data-reactroot="" style="width: 582.57px; height: 5px; overflow: visible; display: inline-block;"><path d="M 5,5 L582.5703125,5" stroke-dasharray="1 2" fill="none"></path></svg></compositeblock><compositeblock dir="ltr" class="toc-page-number-symbol inline"><span> </span></compositeblock></blocks></a></line><line class="text-mode toc-s2" style="line-height: 1.4; padding-left: 3em; cursor: pointer;"><a href="#n0.6988243629481734" style="color: inherit; text-decoration: inherit;"><prefix style="cursor: pointer;"></prefix><blocks style="cursor: pointer;"><baselineblock class="inline"></baselineblock><compositeblock class="prefix-block inline"><span data-line-id="n0.6988243629481734" style="display: inline-block; white-space: pre;">7.1. </span></compositeblock><block>Transfer Learning with Data Generators</block><compositeblock dir="ltr" class="toc-underline-placeholder-symbol inline" style="width: 20px; overflow: visible;"><svg data-reactroot="" style="width: 377.352px; height: 5px; overflow: visible; display: inline-block;"><path d="M 5,5 L377.3515625,5" stroke-dasharray="1 2" fill="none"></path></svg></compositeblock><compositeblock dir="ltr" class="toc-page-number-symbol inline"><span> </span></compositeblock></blocks></a></line><line class="text-mode toc-s2" style="line-height: 1.4; padding-left: 3em; cursor: pointer;"><a href="#n0.9899541174798581" style="color: inherit; text-decoration: inherit;"><prefix style="cursor: pointer;"></prefix><blocks style="cursor: pointer;"><baselineblock class="inline"></baselineblock><compositeblock class="prefix-block inline"><span data-line-id="n0.9899541174798581" style="display: inline-block; white-space: pre;">7.2. </span></compositeblock><block>Transfer Learning with TFRecord</block><compositeblock dir="ltr" class="toc-underline-placeholder-symbol inline" style="width: 20px; overflow: visible;"><svg data-reactroot="" style="width: 423.484px; height: 5px; overflow: visible; display: inline-block;"><path d="M 5,5 L423.484375,5" stroke-dasharray="1 2" fill="none"></path></svg></compositeblock><compositeblock dir="ltr" class="toc-page-number-symbol inline"><span> </span></compositeblock></blocks></a></line><line class="text-mode toc-s1" style="line-height: 1.4; cursor: pointer;"><a href="#n0.8578052793516238" style="color: inherit; text-decoration: inherit;"><prefix style="cursor: pointer;"></prefix><blocks style="cursor: pointer;"><baselineblock class="inline"></baselineblock><compositeblock class="prefix-block inline"><span data-line-id="n0.8578052793516238" style="display: inline-block; white-space: pre;">8. </span></compositeblock><block>Distributed Training with TFRecord</block><compositeblock dir="ltr" class="toc-underline-placeholder-symbol inline" style="width: 20px; overflow: visible;"><svg data-reactroot="" style="width: 451.844px; height: 5px; overflow: visible; display: inline-block;"><path d="M 5,5 L451.84375,5" stroke-dasharray="1 2" fill="none"></path></svg></compositeblock><compositeblock dir="ltr" class="toc-page-number-symbol inline"><span> </span></compositeblock></blocks></a></line><line class="text-mode toc-s2" style="line-height: 1.4; padding-left: 3em; cursor: pointer;"><a href="#n0.17358431836964883" style="color: inherit; text-decoration: inherit;"><prefix style="cursor: pointer;"></prefix><blocks style="cursor: pointer;"><baselineblock class="inline"></baselineblock><compositeblock class="prefix-block inline"><span data-line-id="n0.17358431836964883" style="display: inline-block; white-space: pre;">8.1. </span></compositeblock><block>Train on Driver Node</block><compositeblock dir="ltr" class="toc-underline-placeholder-symbol inline" style="width: 20px; overflow: visible;"><svg data-reactroot="" style="width: 507.43px; height: 5px; overflow: visible; display: inline-block;"><path d="M 5,5 L507.4296875,5" stroke-dasharray="1 2" fill="none"></path></svg></compositeblock><compositeblock dir="ltr" class="toc-page-number-symbol inline"><span> </span></compositeblock></blocks></a></line><line class="text-mode toc-s2" style="line-height: 1.4; padding-left: 3em; cursor: pointer;"><a href="#n0.5045894702301612" style="color: inherit; text-decoration: inherit;"><prefix style="cursor: pointer;"></prefix><blocks style="cursor: pointer;"><baselineblock class="inline"></baselineblock><compositeblock class="prefix-block inline"><span data-line-id="n0.5045894702301612" style="display: inline-block; white-space: pre;">8.2. </span></compositeblock><block>Train on Workers</block><compositeblock dir="ltr" class="toc-underline-placeholder-symbol inline" style="width: 20px; overflow: visible;"><svg data-reactroot="" style="width: 536.672px; height: 5px; overflow: visible; display: inline-block;"><path d="M 5,5 L536.671875,5" stroke-dasharray="1 2" fill="none"></path></svg></compositeblock><compositeblock dir="ltr" class="toc-page-number-symbol inline"><span> </span></compositeblock></blocks></a></line><line class="text-mode toc-s1" style="line-height: 1.4; cursor: pointer;"><a href="#n0.11953009128235137" style="color: inherit; text-decoration: inherit;"><prefix style="cursor: pointer;"></prefix><blocks style="cursor: pointer;"><baselineblock class="inline"></baselineblock><compositeblock class="prefix-block inline"><span data-line-id="n0.11953009128235137" style="display: inline-block; white-space: pre;">9. </span></compositeblock><block>Model Serving</block><compositeblock dir="ltr" class="toc-underline-placeholder-symbol inline" style="width: 20px; overflow: visible;"><svg data-reactroot="" style="width: 604.711px; height: 5px; overflow: visible; display: inline-block;"><path d="M 5,5 L604.7109375,5" stroke-dasharray="1 2" fill="none"></path></svg></compositeblock><compositeblock dir="ltr" class="toc-page-number-symbol inline"><span> </span></compositeblock></blocks></a></line><line class="text-mode toc-s2" style="line-height: 1.4; padding-left: 3em; cursor: pointer;"><a href="#n0.8646135148335732" style="color: inherit; text-decoration: inherit;"><prefix style="cursor: pointer;"></prefix><blocks style="cursor: pointer;"><baselineblock class="inline"></baselineblock><compositeblock class="prefix-block inline"><span data-line-id="n0.8646135148335732" style="display: inline-block; white-space: pre;">9.1. </span></compositeblock><block>Model Serving in Databricks</block><compositeblock dir="ltr" class="toc-underline-placeholder-symbol inline" style="width: 20px; overflow: visible;"><svg data-reactroot="" style="width: 458.016px; height: 5px; overflow: visible; display: inline-block;"><path d="M 5,5 L458.015625,5" stroke-dasharray="1 2" fill="none"></path></svg></compositeblock><compositeblock dir="ltr" class="toc-page-number-symbol inline"><span> </span></compositeblock></blocks></a></line><line class="text-mode toc-s3" style="line-height: 1.4; padding-left: 6em; cursor: pointer;"><a href="#n0.3212049640387755" style="color: inherit; text-decoration: inherit;"><prefix style="cursor: pointer;"></prefix><blocks style="cursor: pointer;"><baselineblock class="inline"></baselineblock><compositeblock class="prefix-block inline"><span data-line-id="n0.3212049640387755" style="display: inline-block; white-space: pre;">9.1.1. </span></compositeblock><block>Creating a Wrapper Class using </block><block>pyfunc</block><compositeblock dir="ltr" class="toc-underline-placeholder-symbol inline" style="width: 20px; overflow: visible;"><svg data-reactroot="" style="width: 318.625px; height: 5px; overflow: visible; display: inline-block;"><path d="M 5,5 L318.625,5" stroke-dasharray="1 2" fill="none"></path></svg></compositeblock><compositeblock dir="ltr" class="toc-page-number-symbol inline"><span> </span></compositeblock></blocks></a></line><line class="text-mode toc-s2" style="line-height: 1.4; padding-left: 3em; cursor: pointer;"><a href="#n0.844237259461228" style="color: inherit; text-decoration: inherit;"><prefix style="cursor: pointer;"></prefix><blocks style="cursor: pointer;"><baselineblock class="inline"></baselineblock><compositeblock class="prefix-block inline"><span data-line-id="n0.844237259461228" style="display: inline-block; white-space: pre;">9.2. </span></compositeblock><block>Load from the Model Registry and Serve using REST</block><compositeblock dir="ltr" class="toc-underline-placeholder-symbol inline" style="width: 20px; overflow: visible;"><svg data-reactroot="" style="width: 279.617px; height: 5px; overflow: visible; display: inline-block;"><path d="M 5,5 L279.6171875,5" stroke-dasharray="1 2" fill="none"></path></svg></compositeblock><compositeblock dir="ltr" class="toc-page-number-symbol inline"><span> </span></compositeblock></blocks></a></line><line class="text-mode toc-s2" style="line-height: 1.4; padding-left: 3em; cursor: pointer;"><a href="#n0.2758956457668085" style="color: inherit; text-decoration: inherit;"><prefix style="cursor: pointer;"></prefix><blocks style="cursor: pointer;"><baselineblock class="inline"></baselineblock><compositeblock class="prefix-block inline"><span data-line-id="n0.2758956457668085" style="display: inline-block; white-space: pre;">9.3. </span></compositeblock><block>Enable MLflow Model Serving for the Registered Model</block><compositeblock dir="ltr" class="toc-underline-placeholder-symbol inline" style="width: 20px; overflow: visible;"><svg data-reactroot="" style="width: 263.992px; height: 5px; overflow: visible; display: inline-block;"><path d="M 5,5 L263.9921875,5" stroke-dasharray="1 2" fill="none"></path></svg></compositeblock><compositeblock dir="ltr" class="toc-page-number-symbol inline"><span> </span></compositeblock></blocks></a></line><line class="text-mode toc-s2" style="line-height: 1.4; padding-left: 3em; cursor: pointer;"><a href="#n0.7485476233169668" style="color: inherit; text-decoration: inherit;"><prefix style="cursor: pointer;"></prefix><blocks style="cursor: pointer;"><baselineblock class="inline"></baselineblock><compositeblock class="prefix-block inline"><span data-line-id="n0.7485476233169668" style="display: inline-block; white-space: pre;">9.4. </span></compositeblock><block>Compute Real-time Predictions</block><compositeblock dir="ltr" class="toc-underline-placeholder-symbol inline" style="width: 20px; overflow: visible;"><svg data-reactroot="" style="width: 437.648px; height: 5px; overflow: visible; display: inline-block;"><path d="M 5,5 L437.6484375,5" stroke-dasharray="1 2" fill="none"></path></svg></compositeblock><compositeblock dir="ltr" class="toc-page-number-symbol inline"><span> </span></compositeblock></blocks></a></line><line class="text-mode toc-s1" style="line-height: 1.4; cursor: pointer;"><a href="#n0.8335717214627942" style="color: inherit; text-decoration: inherit;"><prefix style="cursor: pointer;"></prefix><blocks style="cursor: pointer;"><baselineblock class="inline"></baselineblock><compositeblock class="prefix-block inline"><span data-line-id="n0.8335717214627942" style="display: inline-block; white-space: pre;">10. </span></compositeblock><block>Natural Language Processing</block><compositeblock dir="ltr" class="toc-underline-placeholder-symbol inline" style="width: 20px; overflow: visible;"><svg data-reactroot="" style="width: 490.844px; height: 5px; overflow: visible; display: inline-block;"><path d="M 5,5 L490.84375,5" stroke-dasharray="1 2" fill="none"></path></svg></compositeblock><compositeblock dir="ltr" class="toc-page-number-symbol inline"><span> </span></compositeblock></blocks></a></line><line class="text-mode toc-s2" style="line-height: 1.4; padding-left: 3em; cursor: pointer;"><a href="#n0.5781723805236052" style="color: inherit; text-decoration: inherit;"><prefix style="cursor: pointer;"></prefix><blocks style="cursor: pointer;"><baselineblock class="inline"></baselineblock><compositeblock class="prefix-block inline"><span data-line-id="n0.5781723805236052" style="display: inline-block; white-space: pre;">10.1. </span></compositeblock><block>Embeddings</block><compositeblock dir="ltr" class="toc-underline-placeholder-symbol inline" style="width: 20px; overflow: visible;"><svg data-reactroot="" style="width: 564.977px; height: 5px; overflow: visible; display: inline-block;"><path d="M 5,5 L564.9765625,5" stroke-dasharray="1 2" fill="none"></path></svg></compositeblock><compositeblock dir="ltr" class="toc-page-number-symbol inline"><span> </span></compositeblock></blocks></a></line><line class="text-mode toc-s3" style="line-height: 1.4; padding-left: 6em; cursor: pointer;"><a href="#n0.24419946683574278" style="color: inherit; text-decoration: inherit;"><prefix style="cursor: pointer;"></prefix><blocks style="cursor: pointer;"><baselineblock class="inline"></baselineblock><compositeblock class="prefix-block inline"><span data-line-id="n0.24419946683574278" style="display: inline-block; white-space: pre;">10.1.1. </span></compositeblock><block>What is a Word Embedding?</block><compositeblock dir="ltr" class="toc-underline-placeholder-symbol inline" style="width: 20px; overflow: visible;"><svg data-reactroot="" style="width: 380.531px; height: 5px; overflow: visible; display: inline-block;"><path d="M 5,5 L380.53125,5" stroke-dasharray="1 2" fill="none"></path></svg></compositeblock><compositeblock dir="ltr" class="toc-page-number-symbol inline"><span> </span></compositeblock></blocks></a></line><line class="text-mode toc-s3" style="line-height: 1.4; padding-left: 6em; cursor: pointer;"><a href="#n0.49649187041894005" style="color: inherit; text-decoration: inherit;"><prefix style="cursor: pointer;"></prefix><blocks style="cursor: pointer;"><baselineblock class="inline"></baselineblock><compositeblock class="prefix-block inline"><span data-line-id="n0.49649187041894005" style="display: inline-block; white-space: pre;">10.1.2. </span></compositeblock><block>Latent Semantic Analysis: The Old Way to Get Word Vectors</block><compositeblock dir="ltr" class="toc-underline-placeholder-symbol inline" style="width: 20px; overflow: visible;"><svg data-reactroot="" style="width: 147.883px; height: 5px; overflow: visible; display: inline-block;"><path d="M 5,5 L147.8828125,5" stroke-dasharray="1 2" fill="none"></path></svg></compositeblock><compositeblock dir="ltr" class="toc-page-number-symbol inline"><span> </span></compositeblock></blocks></a></line><line class="text-mode toc-s3" style="line-height: 1.4; padding-left: 6em; cursor: pointer;"><a href="#n0.5904261812819214" style="color: inherit; text-decoration: inherit;"><prefix style="cursor: pointer;"></prefix><blocks style="cursor: pointer;"><baselineblock class="inline"></baselineblock><compositeblock class="prefix-block inline"><span data-line-id="n0.5904261812819214" style="display: inline-block; white-space: pre;">10.1.3. </span></compositeblock><block>Train a Word2Vec Model using SparkML</block><compositeblock dir="ltr" class="toc-underline-placeholder-symbol inline" style="width: 20px; overflow: visible;"><svg data-reactroot="" style="width: 295.531px; height: 5px; overflow: visible; display: inline-block;"><path d="M 5,5 L295.53125,5" stroke-dasharray="1 2" fill="none"></path></svg></compositeblock><compositeblock dir="ltr" class="toc-page-number-symbol inline"><span> </span></compositeblock></blocks></a></line><line class="text-mode toc-s3" style="line-height: 1.4; padding-left: 6em; cursor: pointer;"><a href="#n0.7877235622224192" style="color: inherit; text-decoration: inherit;"><prefix style="cursor: pointer;"></prefix><blocks style="cursor: pointer;"><baselineblock class="inline"></baselineblock><compositeblock class="prefix-block inline"><span data-line-id="n0.7877235622224192" style="display: inline-block; white-space: pre;">10.1.4. </span></compositeblock><block>Implicit bias in word vectors</block><compositeblock dir="ltr" class="toc-underline-placeholder-symbol inline" style="width: 20px; overflow: visible;"><svg data-reactroot="" style="width: 387.562px; height: 5px; overflow: visible; display: inline-block;"><path d="M 5,5 L387.5625,5" stroke-dasharray="1 2" fill="none"></path></svg></compositeblock><compositeblock dir="ltr" class="toc-page-number-symbol inline"><span> </span></compositeblock></blocks></a></line><line class="text-mode toc-s3" style="line-height: 1.4; padding-left: 6em; cursor: pointer;"><a href="#n0.7705273686316372" style="color: inherit; text-decoration: inherit;"><prefix style="cursor: pointer;"></prefix><blocks style="cursor: pointer;"><baselineblock class="inline"></baselineblock><compositeblock class="prefix-block inline"><span data-line-id="n0.7705273686316372" style="display: inline-block; white-space: pre;">10.1.5. </span></compositeblock><block>Semantic Search</block><compositeblock dir="ltr" class="toc-underline-placeholder-symbol inline" style="width: 20px; overflow: visible;"><svg data-reactroot="" style="width: 468.992px; height: 5px; overflow: visible; display: inline-block;"><path d="M 5,5 L468.9921875,5" stroke-dasharray="1 2" fill="none"></path></svg></compositeblock><compositeblock dir="ltr" class="toc-page-number-symbol inline"><span> </span></compositeblock></blocks></a></line><line class="text-mode toc-s2" style="line-height: 1.4; padding-left: 3em; cursor: pointer;"><a href="#n0.15528075070547387" style="color: inherit; text-decoration: inherit;"><prefix style="cursor: pointer;"></prefix><blocks style="cursor: pointer;"><baselineblock class="inline"></baselineblock><compositeblock class="prefix-block inline"><span data-line-id="n0.15528075070547387" style="display: inline-block; white-space: pre;">10.2. </span></compositeblock><block>NER with SparkML</block><compositeblock dir="ltr" class="toc-underline-placeholder-symbol inline" style="width: 20px; overflow: visible;"><svg data-reactroot="" style="width: 511.664px; height: 5px; overflow: visible; display: inline-block;"><path d="M 5,5 L511.6640625,5" stroke-dasharray="1 2" fill="none"></path></svg></compositeblock><compositeblock dir="ltr" class="toc-page-number-symbol inline"><span> </span></compositeblock></blocks></a></line><line class="text-mode toc-s3" style="line-height: 1.4; padding-left: 6em; cursor: pointer;"><a href="#n0.10241697722256826" style="color: inherit; text-decoration: inherit;"><prefix style="cursor: pointer;"></prefix><blocks style="cursor: pointer;"><baselineblock class="inline"></baselineblock><compositeblock class="prefix-block inline"><span data-line-id="n0.10241697722256826" style="display: inline-block; white-space: pre;">10.2.1. </span></compositeblock><block>Transfer Learning</block><compositeblock dir="ltr" class="toc-underline-placeholder-symbol inline" style="width: 20px; overflow: visible;"><svg data-reactroot="" style="width: 462.617px; height: 5px; overflow: visible; display: inline-block;"><path d="M 5,5 L462.6171875,5" stroke-dasharray="1 2" fill="none"></path></svg></compositeblock><compositeblock dir="ltr" class="toc-page-number-symbol inline"><span> </span></compositeblock></blocks></a></line><line class="text-mode toc-s2" style="line-height: 1.4; padding-left: 3em; cursor: pointer;"><a href="#n0.3816963599102581" style="color: inherit; text-decoration: inherit;"><prefix style="cursor: pointer;"></prefix><blocks style="cursor: pointer;"><baselineblock class="inline"></baselineblock><compositeblock class="prefix-block inline"><span data-line-id="n0.3816963599102581" style="display: inline-block; white-space: pre;">10.3. </span></compositeblock><block>Document Classification</block><compositeblock dir="ltr" class="toc-underline-placeholder-symbol inline" style="width: 20px; overflow: visible;"><svg data-reactroot="" style="width: 479.18px; height: 5px; overflow: visible; display: inline-block;"><path d="M 5,5 L479.1796875,5" stroke-dasharray="1 2" fill="none"></path></svg></compositeblock><compositeblock dir="ltr" class="toc-page-number-symbol inline"><span> </span></compositeblock></blocks></a></line><line class="text-mode toc-s3" style="line-height: 1.4; padding-left: 6em; cursor: pointer;"><a href="#n0.8858277047277492" style="color: inherit; text-decoration: inherit;"><prefix style="cursor: pointer;"></prefix><blocks style="cursor: pointer;"><baselineblock class="inline"></baselineblock><compositeblock class="prefix-block inline"><span data-line-id="n0.8858277047277492" style="display: inline-block; white-space: pre;">10.3.1. </span></compositeblock><block>Build the Text Classifier Pipeline</block><compositeblock dir="ltr" class="toc-underline-placeholder-symbol inline" style="width: 20px; overflow: visible;"><svg data-reactroot="" style="width: 353.977px; height: 5px; overflow: visible; display: inline-block;"><path d="M 5,5 L353.9765625,5" stroke-dasharray="1 2" fill="none"></path></svg></compositeblock><compositeblock dir="ltr" class="toc-page-number-symbol inline"><span> </span></compositeblock></blocks></a></line></editarea></toc-wrapper></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="inline" style="display: block;"><div style="vertical-align: baseline;"><div style="display: inline-block; height: 0px; border-bottom: 1px solid; width: 100%;"></div></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-style: italic;">Disclaimer: These are my notes from the "Deep Learning with Databricks" training by Databricks. </block></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="inline" style="display: block;"><div style="vertical-align: baseline;"><div style="display: inline-block; height: 0px; border-bottom: 1px solid; width: 100%;"></div></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode section sindent-0" data-line-id="n0.8216159908346063" style="font-size: 1.2em; padding-top: 0.5em; padding-bottom: 0.5em; font-weight: bold; line-height: 1.4;" id="n0.8216159908346063" role="heading" aria-level="1"><prefix style="text-align: left; padding-right: 0.5em;">1. </prefix><blocks><baselineblock class="inline"></baselineblock><block>Keras Fundamentals</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold; background-color: rgb(255, 254, 0);">Important Note:</block><block> To get the library versions of Databricks runtime, refer to this </block><block class="role-hyper-link" data-hyper-link-url="https://docs.databricks.com/en/release-notes/runtime/index.html" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://docs.databricks.com/en/release-notes/runtime/index.html" target="_blank" style="color: inherit; text-decoration: inherit;">page</a></block><block>.</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold;">Why deep learning?</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Performs well on complex datasets like images, sequences, and natural language.</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Performs better as data amount increases</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Theoreticallt can learn any relationship  </block><block style="font-weight: bold; color: rgb(255, 64, 0);">universal approximation theory</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="boxed-container inline" style="display: block;"><div style="border-style: solid; border-width: 1px; padding: 1.25em; margin-top: 0.1em; margin-bottom: 0.1em; border-color: rgb(0, 0, 0); background: rgba(155, 155, 155, 0.2); border-radius: 10px;"><editarea class="text-mode"><line class="text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; font-size: 0.9em; font-weight: bold;">Universal Approximation Theory</block></blocks></line><line class="text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; font-size: 0.9em;">The "Universal Approximation Theory" is a fundamental theorem in the field of neural networks, an area within artificial intelligence and machine learning. Let's break it down in detail, including its concept, examples, and its relationship with deep learning.</block></blocks></line><line class="text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; font-size: 0.9em; font-weight: bold;">Concept of Universal Approximation Theory</block></blocks></line><line class="text-mode indent-0 has-indent list-item" style="line-height: 1.4;"><prefix style="font-size: 0.9em; flex-shrink: 0; min-width: 1em; text-align: left;">1. </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; font-size: 0.9em; font-weight: bold;">Basic Idea:</block><block style="font-family: &quot;Computer Modern Serif&quot;, serif; font-size: 0.9em;"> The Universal Approximation Theory states that a feed-forward network with a single hidden layer containing a finite number of neurons can approximate continuous functions on compact subsets of </block><compositeblock dir="ltr" class="math-container-symbol role-mathmode-area inline" style="font-size: 15.3px;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mstyle displaystyle=&quot;true&quot;><msup><mi mathvariant=&quot;double-struck&quot;>R</mi><mi>n</mi></msup></mstyle></math>"><editarea class="math-mode-font lazy lazyable no-area-container" style="font-family: LatinModern-Math, LatinModern, Asana-Math, Asana;" aria-hidden="true"><line class="" style="line-height: 1.2;"><baselineblock></baselineblock><block class="Normal" style="font-family: LatinModern-Mathbb, LatinModern-Math, LatinModern, Asana;">R</block><compositeblock dir="ltr" class="power-index-symbol-container has-power"><editarea-block class="power-value" style="line-height: 1.2; margin-bottom: -1.06571em;">n</editarea-block><middle-base><inline></inline></middle-base></compositeblock></line></editarea><span role="presentation" style="width:100%;position:absolute;top:0;left:0;clip:rect(1px, 1px, 1px, 1px);height:1px;padding:1px 0 0 0!important;overflow:hidden;user-select:none;"><math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><msup><mi mathvariant="double-struck">R</mi><mi>n</mi></msup></mstyle></math></span></compositeblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; font-size: 0.9em;">, under mild assumptions on the activation function. In simpler terms, it means that such a neural network can represent a wide variety of interesting functions when given appropriate parameters (weights and biases).</block></blocks></line><line class="text-mode indent-0 has-indent list-item" style="line-height: 1.4;"><prefix style="font-size: 0.9em; flex-shrink: 0; min-width: 1em; text-align: left;">2. </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; font-size: 0.9em; font-weight: bold;">Activation Functions:</block><block style="font-family: &quot;Computer Modern Serif&quot;, serif; font-size: 0.9em;"> The activation function is a key component here. It's a non-linear function like sigmoid, ReLU (Rectified Linear Unit), or tanh. The non-linearity of the activation function allows the neural network to compute non-trivial problems using a limited number of neurons.</block></blocks></line><line class="text-mode indent-0 has-indent list-item" style="line-height: 1.4;"><prefix style="font-size: 0.9em; flex-shrink: 0; min-width: 1em; text-align: left;">3. </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; font-size: 0.9em; font-weight: bold;">Importance of Depth and Width:</block><block style="font-family: &quot;Computer Modern Serif&quot;, serif; font-size: 0.9em;"> While the theory guarantees approximation with just one hidden layer, in practice, deeper networks (with more layers) can achieve the same level of approximation with fewer neurons overall, leading to more efficient computations in some cases.</block></blocks></line><line class="text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; font-size: 0.9em; font-weight: bold;">Examples and Use Cases</block></blocks></line><line class="text-mode indent-0 has-indent list-item" style="line-height: 1.4;"><prefix style="font-size: 0.9em; flex-shrink: 0; min-width: 1em; text-align: left;">1. </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; font-size: 0.9em; font-weight: bold;">Function Approximation:</block><block style="font-family: &quot;Computer Modern Serif&quot;, serif; font-size: 0.9em;"> For example, a neural network can approximate functions like sine, cosine, or even more complex functions. This is fundamental in tasks where you need to model the behavior of variables that have a non-linear relationship.</block></blocks></line><line class="text-mode indent-0 has-indent list-item" style="line-height: 1.4;"><prefix style="font-size: 0.9em; flex-shrink: 0; min-width: 1em; text-align: left;">2. </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; font-size: 0.9em; font-weight: bold;">Control Systems:</block><block style="font-family: &quot;Computer Modern Serif&quot;, serif; font-size: 0.9em;"> In robotics and control systems, neural networks can approximate the functions governing the system dynamics, aiding in designing controllers.</block></blocks></line><line class="text-mode indent-0 has-indent list-item" style="line-height: 1.4;"><prefix style="font-size: 0.9em; flex-shrink: 0; min-width: 1em; text-align: left;">3. </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; font-size: 0.9em; font-weight: bold;">Financial Modelling:</block><block style="font-family: &quot;Computer Modern Serif&quot;, serif; font-size: 0.9em;"> In finance, they can model and predict stock prices, which are influenced by a complex set of factors and exhibit non-linear dynamics.</block></blocks></line><line class="text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; font-size: 0.9em; font-weight: bold;">Relationship with Deep Learning</block></blocks></line><line class="text-mode indent-0 has-indent list-item" style="line-height: 1.4;"><prefix style="font-size: 0.9em; flex-shrink: 0; min-width: 1em; text-align: left;">1. </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; font-size: 0.9em; font-weight: bold;">Foundation for Deep Learning:</block><block style="font-family: &quot;Computer Modern Serif&quot;, serif; font-size: 0.9em;"> The Universal Approximation Theorem is at the heart of why deep learning works. It provides the theoretical foundation that ensures deep neural networks can fit a wide range of functions, from simple to highly complex ones.</block></blocks></line><line class="text-mode indent-0 has-indent list-item" style="line-height: 1.4;"><prefix style="font-size: 0.9em; flex-shrink: 0; min-width: 1em; text-align: left;">2. </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; font-size: 0.9em; font-weight: bold;">Beyond Approximation:</block><block style="font-family: &quot;Computer Modern Serif&quot;, serif; font-size: 0.9em;"> In deep learning, we not only want to approximate a function but also to generalize well to new, unseen data. This involves additional concepts like regularization, optimization algorithms, and network architectures.</block></blocks></line><line class="text-mode indent-0 has-indent list-item" style="line-height: 1.4;"><prefix style="font-size: 0.9em; flex-shrink: 0; min-width: 1em; text-align: left;">3. </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; font-size: 0.9em; font-weight: bold;">Deep Networks:</block><block style="font-family: &quot;Computer Modern Serif&quot;, serif; font-size: 0.9em;"> While the theorem talks about single-layer networks, in practice, deep networks (with many layers) are used. They have been found to be more efficient and effective in learning representations of data, especially for high-dimensional tasks like image and speech recognition.</block></blocks></line><line class="text-mode indent-0 has-indent list-item" style="line-height: 1.4;"><prefix style="font-size: 0.9em; flex-shrink: 0; min-width: 1em; text-align: left;">4. </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; font-size: 0.9em; font-weight: bold;">Limitations and Extensions:</block><block style="font-family: &quot;Computer Modern Serif&quot;, serif; font-size: 0.9em;"> The theorem does not address how to find the right parameters or the complexity required to achieve a certain level of approximation. Deep learning research often focuses on these aspects - how to efficiently train networks and how to structure them for specific tasks (like convolutional networks for image processing).</block></blocks></line><line class="text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; font-size: 0.9em;">In summary, the Universal Approximation Theory provides the theoretical underpinning for why neural networks can be so powerful and versatile. However, the practical success of deep learning also relies on many other factors, including innovations in computing hardware, algorithmic advancements in training networks, and the availability of large datasets.</block></blocks></line></editarea></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">[</block><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><compositeblock dir="ltr" class="anchor-tag-ref inline" style="font-family: &quot;Computer Modern Serif&quot;, serif; background-color: rgba(155, 155, 155, 0.2);"><a href="#n0.3715415633810799" style="color: inherit; text-decoration: inherit;">Back To Top</a></compositeblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">]</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode section sindent-1" data-line-id="n0.12412752945172945" style="font-size: 1.1em; padding-top: 0.5em; padding-bottom: 0.5em; font-weight: bold; line-height: 1.4;" id="n0.12412752945172945" role="heading" aria-level="2"><prefix style="text-align: left; padding-right: 0.25em;">1.1. </prefix><blocks><baselineblock class="inline"></baselineblock><block>Keras</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://www.tensorflow.org/guide/keras" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://www.tensorflow.org/guide/keras" target="_blank" style="color: inherit; text-decoration: inherit;">Keras</a></block><block> is a high-level Python API to build neural networks.</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Official high-level API of TensorFlow.</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Has over 250,000 users</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Released by Francois Chollet in 2015.</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>It is now the official high-level API of TensorFlow.</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://keras.io/" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://keras.io/" target="_blank" style="color: inherit; text-decoration: inherit;">Keras documentation</a></block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 213px; height: 445.58px; position: relative;"><img src="image-resources/63ffb1f4-58e3-40fb-bc83-f0bbf55fce4a.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div data-caption-block-id="n0.4901391112572415" class="role-image-caption-container role-caption-container" style="display: flex; align-items: center; justify-content: center; margin-top: 10px;" id="n0.4901391112572415"><span class="no-print-outline" style="outline: none; position: relative; text-align: center;"><span class="role-image-caption-prefix" style="padding-right: 0.3em; font-weight: bold;"><span class="role-image-caption-name">Figure</span><span class="role-image-caption-number"><!-- react-text: 1730 --> <!-- /react-text --><!-- react-text: 1731 -->1<!-- /react-text --></span><span>:</span></span><editarea class="image-caption text-mode" style="min-width: 50px; display: inline;"><line class="text-mode align-center" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold;">Steps to build a Keras model</block></blocks></line></editarea></span></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode section sindent-1" data-line-id="n0.08122664088479059" style="font-size: 1.1em; padding-top: 0.5em; padding-bottom: 0.5em; font-weight: bold; line-height: 1.4;" id="n0.08122664088479059" role="heading" aria-level="2"><prefix style="text-align: left; padding-right: 0.25em;">1.2. </prefix><blocks><baselineblock class="inline"></baselineblock><block>Hardware Considerations</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>GPUs are often the tool of choice for DL training due to their superior parallel execution abilities over CPUs.</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>CPUs are easier to program, faster for smaller datasets, and allow more flexibility of use.</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 451.5px; height: 442.11px; position: relative;"><img src="image-resources/dc8f2577-de08-436c-967d-1090b4835034.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode section sindent-1" data-line-id="n0.6708026075031961" style="font-size: 1.1em; padding-top: 0.5em; padding-bottom: 0.5em; font-weight: bold; line-height: 1.4;" id="n0.6708026075031961" role="heading" aria-level="2"><prefix style="text-align: left; padding-right: 0.25em;">1.3. </prefix><blocks><baselineblock class="inline"></baselineblock><block>Neural Network Fundamentals</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>A nice NN </block><block class="role-hyper-link" data-hyper-link-url="https://playground.tensorflow.org/#activation=tanh&amp;batchSize=10&amp;dataset=circle&amp;regDataset=reg-plane&amp;learningRate=0.03&amp;regularizationRate=0&amp;noise=0&amp;networkShape=4,2&amp;seed=0.49547&amp;showTestData=false&amp;discretize=false&amp;percTrainData=50&amp;x=true&amp;y=true&amp;xTimesY=false&amp;xSquared=false&amp;ySquared=false&amp;cosX=false&amp;sinX=false&amp;cosY=false&amp;sinY=false&amp;collectStats=false&amp;problem=classification&amp;initZero=false&amp;hideText=false" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://playground.tensorflow.org/#activation=tanh&amp;batchSize=10&amp;dataset=circle&amp;regDataset=reg-plane&amp;learningRate=0.03&amp;regularizationRate=0&amp;noise=0&amp;networkShape=4,2&amp;seed=0.49547&amp;showTestData=false&amp;discretize=false&amp;percTrainData=50&amp;x=true&amp;y=true&amp;xTimesY=false&amp;xSquared=false&amp;ySquared=false&amp;cosX=false&amp;sinX=false&amp;cosY=false&amp;sinY=false&amp;collectStats=false&amp;problem=classification&amp;initZero=false&amp;hideText=false" target="_blank" style="color: inherit; text-decoration: inherit;">visualizer tool</a></block><block>.</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode section sindent-2" data-line-id="n0.02653560578766556" style="font-size: 1em; padding-top: 0.5em; padding-bottom: 0.5em; font-weight: bold; line-height: 1.4;" id="n0.02653560578766556" role="heading" aria-level="3"><prefix style="text-align: left; padding-right: 0em;">1.3.1. </prefix><blocks><baselineblock class="inline"></baselineblock><block>Activation Functions</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="color: rgb(255, 64, 0); font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold; color: rgb(255, 64, 0);">Sigmoid</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Saturates and kills gradients</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Not zero-centered along the </block><compositeblock dir="ltr" class="math-container-symbol role-mathmode-area inline" style="font-size: 17px;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mstyle displaystyle=&quot;true&quot;><mi>y</mi></mstyle></math>"><editarea class="math-mode-font lazyable no-area-container" style="font-family: LatinModern-Math, LatinModern, Asana-Math, Asana;" aria-hidden="true"><line class="" style="line-height: 1.2;"><baselineblock></baselineblock><block class="Normal">y</block></line></editarea><span role="presentation" style="width:100%;position:absolute;top:0;left:0;clip:rect(1px, 1px, 1px, 1px);height:1px;padding:1px 0 0 0!important;overflow:hidden;user-select:none;"><math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mi>y</mi></mstyle></math></span></compositeblock><block>-axis</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Last layer activation function for binary classification models</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 320px; height: 202.65px; position: relative;"><img src="image-resources/748e8a76-078f-4568-af1e-4d80ea70e27f.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="color: rgb(255, 64, 0); font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold; color: rgb(255, 64, 0);">Softmax</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Convert logits to probabilities</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Last layer activation function for multi-class classification</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 300px; height: 158.21px; position: relative;"><img src="image-resources/b9acb4b5-e75d-4521-88d2-fbb8c86a3a29.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="color: rgb(255, 64, 0); font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold; color: rgb(255, 64, 0);">Hyperbolic Tangent (Tanh)</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Zero centered</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>BUT, like the sigmoid, its activations saturates</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 339px; height: 214.21px; position: relative;"><img src="image-resources/0159131d-d0a0-494f-b6a9-649c502e35dc.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="color: rgb(255, 64, 0); font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold; color: rgb(255, 64, 0);">ReLU (Rectified Linear Unit)</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>BUT, gradients can still go to zero</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 582px; height: 198.86px; position: relative;"><img src="image-resources/a17d7a49-2812-4ab4-88b5-036d76a68ae8.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="color: rgb(255, 64, 0); font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold; color: rgb(255, 64, 0);">Leaky ReLU</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>For </block><compositeblock dir="ltr" class="math-container-symbol role-mathmode-area inline" style="font-size: 17px;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mstyle displaystyle=&quot;true&quot;><mrow><mi>x</mi><mspace is=&quot;true&quot; width=&quot;0.22em&quot;></mspace><mo form=&quot;infix&quot;>&amp;lt;</mo><mspace is=&quot;true&quot; width=&quot;0.22em&quot;></mspace><mn>0</mn><mspace is=&quot;true&quot; width=&quot;0.22em&quot;></mspace><mo></mo><mspace is=&quot;true&quot; width=&quot;0.22em&quot;></mspace><mi>f</mi><mo fence=&quot;true&quot; stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo fence=&quot;true&quot; stretchy=&quot;false&quot;>)</mo><mspace is=&quot;true&quot; width=&quot;0.22em&quot;></mspace><mo form=&quot;infix&quot;>=</mo><mspace is=&quot;true&quot; width=&quot;0.22em&quot;></mspace><mi></mi><mo separator=&quot;true&quot;>.</mo><mi>x</mi></mrow></mstyle></math>"><editarea class="math-mode-font lazy lazyable no-area-container" style="font-family: LatinModern-Math, LatinModern, Asana-Math, Asana;" aria-hidden="true"><line class="" style="line-height: 1.2;"><baselineblock></baselineblock><block class="Normal">x </block><block class="Relation">&lt;</block><block class="Normal"> 0 </block><compositeblock dir="ltr" class="arrow-like-symbol"><arrow-like-simple><span></span></arrow-like-simple></compositeblock><block class="Normal"> f</block><opensymbolblock class="normal" type="parenthesis"><bracket-span>(</bracket-span></opensymbolblock><block class="Normal">x</block><closesymbolblock class="normal" type="parenthesis"><bracket-span>)</bracket-span></closesymbolblock><block class="Normal"> </block><block class="Relation">=</block><block class="Normal"> </block><block class="Punctuation">.</block><block class="Normal">x</block></line></editarea><span role="presentation" style="width:100%;position:absolute;top:0;left:0;clip:rect(1px, 1px, 1px, 1px);height:1px;padding:1px 0 0 0!important;overflow:hidden;user-select:none;"><math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mrow><mi>x</mi><mspace is="true" width="0.22em"></mspace><mo form="infix">&lt;</mo><mspace is="true" width="0.22em"></mspace><mn>0</mn><mspace is="true" width="0.22em"></mspace><mo></mo><mspace is="true" width="0.22em"></mspace><mi>f</mi><mo fence="true" stretchy="false">(</mo><mi>x</mi><mo fence="true" stretchy="false">)</mo><mspace is="true" width="0.22em"></mspace><mo form="infix">=</mo><mspace is="true" width="0.22em"></mspace><mi></mi><mo separator="true">.</mo><mi>x</mi></mrow></mstyle></math></span></compositeblock></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>For </block><compositeblock dir="ltr" class="math-container-symbol role-mathmode-area inline" style="font-size: 17px;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mstyle displaystyle=&quot;true&quot;><mrow><mi>x</mi><mspace is=&quot;true&quot; width=&quot;0.22em&quot;></mspace><mo form=&quot;infix&quot;></mo><mspace is=&quot;true&quot; width=&quot;0.22em&quot;></mspace><mn>0</mn><mspace is=&quot;true&quot; width=&quot;0.22em&quot;></mspace><mo></mo><mspace is=&quot;true&quot; width=&quot;0.22em&quot;></mspace><mi>f</mi><mo fence=&quot;true&quot; stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo fence=&quot;true&quot; stretchy=&quot;false&quot;>)</mo><mspace is=&quot;true&quot; width=&quot;0.22em&quot;></mspace><mo form=&quot;infix&quot;>=</mo><mspace is=&quot;true&quot; width=&quot;0.22em&quot;></mspace><mi>x</mi></mrow></mstyle></math>"><editarea class="math-mode-font lazy lazyable no-area-container" style="font-family: LatinModern-Math, LatinModern, Asana-Math, Asana;" aria-hidden="true"><line class="" style="line-height: 1.2;"><baselineblock></baselineblock><block class="Normal">x </block><block class="Relation"></block><block class="Normal"> 0 </block><compositeblock dir="ltr" class="arrow-like-symbol"><arrow-like-simple><span></span></arrow-like-simple></compositeblock><block class="Normal"> f</block><opensymbolblock class="normal" type="parenthesis"><bracket-span>(</bracket-span></opensymbolblock><block class="Normal">x</block><closesymbolblock class="normal" type="parenthesis"><bracket-span>)</bracket-span></closesymbolblock><block class="Normal"> </block><block class="Relation">=</block><block class="Normal"> x</block></line></editarea><span role="presentation" style="width:100%;position:absolute;top:0;left:0;clip:rect(1px, 1px, 1px, 1px);height:1px;padding:1px 0 0 0!important;overflow:hidden;user-select:none;"><math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mrow><mi>x</mi><mspace is="true" width="0.22em"></mspace><mo form="infix"></mo><mspace is="true" width="0.22em"></mspace><mn>0</mn><mspace is="true" width="0.22em"></mspace><mo></mo><mspace is="true" width="0.22em"></mspace><mi>f</mi><mo fence="true" stretchy="false">(</mo><mi>x</mi><mo fence="true" stretchy="false">)</mo><mspace is="true" width="0.22em"></mspace><mo form="infix">=</mo><mspace is="true" width="0.22em"></mspace><mi>x</mi></mrow></mstyle></math></span></compositeblock></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>These functions are not differentiable at 0, so we set the derivative to 0 or average of left and right derivatives.</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 348.5px; height: 224.35px; position: relative;"><img src="image-resources/772d2eb1-4547-480a-8c27-53217d761ba2.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="color: rgb(255, 64, 0); font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold; color: rgb(255, 64, 0);">Swish</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>More recent and advanced</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Swish activation function which returns </block><compositeblock dir="ltr" class="math-container-symbol role-mathmode-area inline" style="font-size: 17px;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mstyle displaystyle=&quot;true&quot;><mrow><mi>x</mi><mo separator=&quot;true&quot;>.</mo><mi mathvariant=&quot;normal&quot;>s</mi><mi mathvariant=&quot;normal&quot;>i</mi><mi mathvariant=&quot;normal&quot;>g</mi><mi mathvariant=&quot;normal&quot;>m</mi><mi mathvariant=&quot;normal&quot;>o</mi><mi mathvariant=&quot;normal&quot;>i</mi><mi mathvariant=&quot;normal&quot;>d</mi><mo fence=&quot;true&quot; stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo fence=&quot;true&quot; stretchy=&quot;false&quot;>)</mo></mrow></mstyle></math>"><editarea class="math-mode-font lazy lazyable no-area-container" style="font-family: LatinModern-Math, LatinModern, Asana-Math, Asana;" aria-hidden="true"><line class="" style="line-height: 1.2;"><baselineblock></baselineblock><block class="Normal" style="color: rgb(231, 55, 61);">x</block><block class="Punctuation" style="color: rgb(231, 55, 61);">.</block><block class="Normal" style="font-family: LatinModern-Mathrm, LatinModern-Math, LatinModern, Asana; color: rgb(231, 55, 61);">sigmoid</block><opensymbolblock class="normal" type="parenthesis" style="color: rgb(231, 55, 61); stroke: rgb(231, 55, 61); border-color: rgb(231, 55, 61); fill: rgb(231, 55, 61);"><bracket-span>(</bracket-span></opensymbolblock><block class="Normal" style="color: rgb(231, 55, 61);">x</block><closesymbolblock class="normal" type="parenthesis" style="color: rgb(231, 55, 61); stroke: rgb(231, 55, 61); border-color: rgb(231, 55, 61); fill: rgb(231, 55, 61);"><bracket-span>)</bracket-span></closesymbolblock></line></editarea><span role="presentation" style="width:100%;position:absolute;top:0;left:0;clip:rect(1px, 1px, 1px, 1px);height:1px;padding:1px 0 0 0!important;overflow:hidden;user-select:none;"><math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mrow><mi>x</mi><mo separator="true">.</mo><mi mathvariant="normal">s</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">g</mi><mi mathvariant="normal">m</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">d</mi><mo fence="true" stretchy="false">(</mo><mi>x</mi><mo fence="true" stretchy="false">)</mo></mrow></mstyle></math></span></compositeblock><block>. It is a smooth, non-monotonic function that consistently matches or outperforms ReLU on deep networks, it is unbounded above and bounded below.</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://www.tensorflow.org/api_docs/python/tf/keras/activations/swish#:~:text=Swish%20activation%20function%2C%20swish(x,x%20*%20sigmoid(x)%20.&amp;text=Swish%20activation%20function%20which%20returns,unbounded%20above%20and%20bounded%20below." style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://www.tensorflow.org/api_docs/python/tf/keras/activations/swish#:~:text=Swish%20activation%20function%2C%20swish(x,x%20*%20sigmoid(x)%20.&amp;text=Swish%20activation%20function%20which%20returns,unbounded%20above%20and%20bounded%20below." target="_blank" style="color: inherit; text-decoration: inherit;">TF Link</a></block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="color: rgb(255, 64, 0); font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold; color: rgb(255, 64, 0);">Mish</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>A step up from Swish</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>More suitable for computer vision cases</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://www.tensorflow.org/api_docs/python/tf/keras/activations/mish" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://www.tensorflow.org/api_docs/python/tf/keras/activations/mish" target="_blank" style="color: inherit; text-decoration: inherit;">TF Link</a></block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://arxiv.org/abs/1908.08681" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://arxiv.org/abs/1908.08681" target="_blank" style="color: inherit; text-decoration: inherit;">Link to Mish paper</a></block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 741px; height: 372.84px; position: relative;"><img src="image-resources/66c72442-33eb-43b4-844c-b93d702cbe7c.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">[</block><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><compositeblock dir="ltr" class="anchor-tag-ref inline" style="font-family: &quot;Computer Modern Serif&quot;, serif; background-color: rgba(155, 155, 155, 0.2);"><a href="#n0.3715415633810799" style="color: inherit; text-decoration: inherit;">Back To Top</a></compositeblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">]</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode section sindent-2" data-line-id="n0.7209444374430432" style="font-size: 1em; padding-top: 0.5em; padding-bottom: 0.5em; font-weight: bold; line-height: 1.4;" id="n0.7209444374430432" role="heading" aria-level="3"><prefix style="text-align: left; padding-right: 0em;">1.3.2. </prefix><blocks><baselineblock class="inline"></baselineblock><block>Optimizers</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="color: rgb(255, 64, 0); font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold; color: rgb(255, 64, 0);">Stochastic Gradient Descent (SGD)</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Choosing a proper learning rate can be difficult</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 545px; height: 273.42px; position: relative;"><img src="image-resources/a463c977-de5b-4f13-bd19-955b9d1a4bed.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Easy to get stuck in local minima</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 604.5px; height: 253.34px; position: relative;"><img src="image-resources/a709ca24-3ef5-4e72-b726-2fdbcf7939a7.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="color: rgb(255, 64, 0); font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold; color: rgb(255, 64, 0);">Momentum</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Accelerates SGD  like pushing a ball down a hill</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Takes average of direction we've been heading (current velocity and acceleration)</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Limits oscillating back and forth, gets out of local minima</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 465px; height: 127.02px; position: relative;"><img src="image-resources/479051ff-75d8-4d51-9f63-12c1c4ab6132.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="color: rgb(255, 64, 0); font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold; color: rgb(255, 64, 0);">Adam (Adaptive Moment Estimation)</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Recommended default choice</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold; background-color: rgb(255, 254, 0);">Momentum + RMSProp</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold;">Momentum</block></blocks></line><line class="root text-mode indent-2 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="3"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;">* </prefix><blocks><baselineblock class="inline"></baselineblock><block>Uses a moving average of the gradient</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold;">RMSProp</block></blocks></line><line class="root text-mode indent-2 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="3"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;">* </prefix><blocks><baselineblock class="inline"></baselineblock><block>Divides the learning rate element-wise by the root of the moving average of the squared gradient</block></blocks></line><line class="root text-mode indent-2 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="3"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;">* </prefix><blocks><baselineblock class="inline"></baselineblock><block>More uniform learning steps, small gradients are impactful, faster convergence</block></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 459.5px; height: 38.99px; position: relative;"><img src="image-resources/0fc3d5f3-02b3-4c65-9c6d-df3d292b2b91.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 545.5px; height: 527.32px; position: relative;"><img src="image-resources/87a3f7ca-be13-43fd-ace1-4d4d844f0831.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="color: rgb(255, 64, 0); font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold; color: rgb(255, 64, 0);">AdamW</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Most common these days (early 2024)</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold; background-color: rgb(255, 254, 0);">A nice GitHub repo on optimizers</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://github.com/lessw2020/Ranger21" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://github.com/lessw2020/Ranger21" target="_blank" style="color: inherit; text-decoration: inherit;">Ranger21 - integrating the latest deep learning components into a single optimizer</a></block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold; background-color: rgb(255, 254, 0);">A </block><block class="role-hyper-link" data-hyper-link-url="http://ruder.io/optimizing-gradient-descent/" style="text-decoration: underline; font-weight: bold; color: rgb(17, 85, 204); background-color: rgb(255, 254, 0);"><a href="http://ruder.io/optimizing-gradient-descent/" target="_blank" style="color: inherit; text-decoration: inherit;">great blog post</a></block><block style="font-weight: bold; background-color: rgb(255, 254, 0);"> illustrating the various optimizers.</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">[</block><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><compositeblock dir="ltr" class="anchor-tag-ref inline" style="font-family: &quot;Computer Modern Serif&quot;, serif; background-color: rgba(155, 155, 155, 0.2);"><a href="#n0.3715415633810799" style="color: inherit; text-decoration: inherit;">Back To Top</a></compositeblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">]</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode section sindent-2" data-line-id="n0.1253253155017302" style="font-size: 1em; padding-top: 0.5em; padding-bottom: 0.5em; font-weight: bold; line-height: 1.4;" id="n0.1253253155017302" role="heading" aria-level="3"><prefix style="text-align: left; padding-right: 0em;">1.3.3. </prefix><blocks><baselineblock class="inline"></baselineblock><block>Linear Regression with Keras</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>A </block><block style="font-weight: bold; background-color: rgb(255, 254, 0);">fully-connected neural network</block><block> is simply a set of matrix multiplications followed by some non-linear function.</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Let's build a N-layer NN (</block><block style="font-weight: bold; background-color: rgb(255, 254, 0);">Note:</block><block> When we say something is an n-layer neural network, we count all of the layers except the input layer.).</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>For this example, we'll use the </block><block class="role-hyper-link" data-hyper-link-url="https://www.tensorflow.org/api_docs/python/tf/keras" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://www.tensorflow.org/api_docs/python/tf/keras" target="_blank" style="color: inherit; text-decoration: inherit;">Sequential model</a></block><block> from Keras.</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>To </block><block class="role-hyper-link" data-hyper-link-url="https://www.tensorflow.org/api_docs/python/tf/keras/Sequential#compile" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://www.tensorflow.org/api_docs/python/tf/keras/Sequential#compile" target="_blank" style="color: inherit; text-decoration: inherit;">compile</a></block><block> the network, we need to specify the loss function and which optimizer to use.</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item full-line-block-inside" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="code-section-symbol inline" style="display: block;"><div class="code-section theme-tomorrow-night" style="display: block; border: 1px solid lightgray; background: rgb(45, 45, 45); padding: 10px; font-size: 12px;"><editarea class="text-mode code-section-edit-area" style="font-family: &quot;Fira code&quot;, &quot;Fira Mono&quot;, monospace;"><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">from</block><block class=" token"> sklearn</block><block class="punctuation token">.</block><block class=" token">metrics </block><block class="keyword token">import</block><block class=" token"> mean_squared_error</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">import</block><block class=" token"> tensorflow </block><block class="keyword token">as</block><block class=" token"> tf</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">from</block><block class=" token"> tensorflow</block><block class="punctuation token">.</block><block class=" token">keras</block><block class="punctuation token">.</block><block class=" token">layers </block><block class="keyword token">import</block><block class=" token"> Dense</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">from</block><block class=" token"> tensorflow</block><block class="punctuation token">.</block><block class=" token">keras</block><block class="punctuation token">.</block><block class=" token">models </block><block class="keyword token">import</block><block class=" token"> Sequential</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">tf</block><block class="punctuation token">.</block><block class=" token">random</block><block class="punctuation token">.</block><block class=" token">set_seed</block><block class="punctuation token">(</block><block class="number token">42</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># The Sequential model is a linear stack of layers.</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">model </block><block class="operator token">=</block><block class=" token"> Sequential</block><block class="punctuation token">(</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">model</block><block class="punctuation token">.</block><block class=" token">add</block><block class="punctuation token">(</block><block class=" token">Dense</block><block class="punctuation token">(</block><block class=" token">units</block><block class="operator token">=</block><block class="number token">1</block><block class="punctuation token">,</block><block class=" token"> input_dim</block><block class="operator token">=</block><block class="number token">1</block><block class="punctuation token">,</block><block class=" token"> activation</block><block class="operator token">=</block><block class="string token">"linear"</block><block class="punctuation token">)</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">model</block><block class="punctuation token">.</block><block class=" token">summary</block><block class="punctuation token">(</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Model: "sequential"</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># _________________________________________________________________</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  Layer (type)                Output Shape              Param #   </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># =================================================================</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  dense (Dense)               (None, 1)                 2         </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                                                                 </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># =================================================================</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Total params: 2</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Trainable params: 2</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Non-trainable params: 0</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># _________________________________________________________________</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Compile the NN</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">model</block><block class="punctuation token">.</block><block class="builtin token">compile</block><block class="punctuation token">(</block><block class=" token">loss</block><block class="operator token">=</block><block class="string token">"mse"</block><block class="punctuation token">,</block><block class=" token"> optimizer</block><block class="operator token">=</block><block class="string token">"adam"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Fit the model</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">model</block><block class="punctuation token">.</block><block class=" token">fit</block><block class="punctuation token">(</block><block class=" token">X</block><block class="punctuation token">,</block><block class=" token"> y</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># 1/1 [==============================] - 1s 581ms/step - loss: 414.3940</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># 1/1 [==============================] - 0s 128ms/step</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># WARNING:absl:Found untraced functions such as _update_step_xla while saving (showing 1 of 1). These functions will not be directly callable after loading.</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># INFO:tensorflow:Assets written to: /tmp/tmpadrqbocn/model/data/model/assets</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># INFO:tensorflow:Assets written to: /tmp/tmpadrqbocn/model/data/model/assets</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Out[13]: &lt;keras.callbacks.History at 0x7f4d0fb53430&gt;</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">keras_pred </block><block class="operator token">=</block><block class=" token"> model</block><block class="punctuation token">.</block><block class=" token">predict</block><block class="punctuation token">(</block><block class=" token">X</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">mse </block><block class="operator token">=</block><block class=" token"> mean_squared_error</block><block class="punctuation token">(</block><block class=" token">y</block><block class="punctuation token">,</block><block class=" token"> keras_pred</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Plot predictions against the actual</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">def</block><block class=" token"> </block><block class="function token">keras_pred_plot</block><block class="punctuation token">(</block><block class=" token">keras_pred</block><block class="punctuation token">)</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    plt</block><block class="punctuation token">.</block><block class=" token">clf</block><block class="punctuation token">(</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    plt</block><block class="punctuation token">.</block><block class=" token">plot</block><block class="punctuation token">(</block><block class=" token">X</block><block class="punctuation token">,</block><block class=" token"> y</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"ro"</block><block class="punctuation token">,</block><block class=" token"> label</block><block class="operator token">=</block><block class="string token">"True y"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    plt</block><block class="punctuation token">.</block><block class=" token">plot</block><block class="punctuation token">(</block><block class=" token">X</block><block class="punctuation token">,</block><block class=" token"> keras_pred</block><block class="punctuation token">,</block><block class=" token"> label</block><block class="operator token">=</block><block class="string token">"Pred y"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    plt</block><block class="punctuation token">.</block><block class=" token">title</block><block class="punctuation token">(</block><block class="string token">"X vs. True y and Pred. y (Keras)"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    plt</block><block class="punctuation token">.</block><block class=" token">xlabel</block><block class="punctuation token">(</block><block class="string token">"X"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    plt</block><block class="punctuation token">.</block><block class=" token">ylabel</block><block class="punctuation token">(</block><block class="string token">"y"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    plt</block><block class="punctuation token">.</block><block class=" token">legend</block><block class="punctuation token">(</block><block class=" token">numpoints</block><block class="operator token">=</block><block class="number token">1</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    plt</block><block class="punctuation token">.</block><block class=" token">show</block><block class="punctuation token">(</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">keras_pred_plot</block><block class="punctuation token">(</block><block class=" token">keras_pred</block><block class="punctuation token">)</block></blocks></line></editarea></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>In our toy example, this is the plot of predictions against the actuals:</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 513px; height: 333.26px; position: relative;"><img src="image-resources/637abc69-b56e-4824-a10c-76bd0ca12a77.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold;">What went wrong??</block><block> Turns out there a few more hyperparameters we need to set.</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>The parameter </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">epochs</block><block> specifies how many passes you want over your entire dataset. Let's increase the number of epochs, and look at how the </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">mse</block><block> decreases.</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item full-line-block-inside" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="code-section-symbol inline" style="display: block;"><div class="code-section theme-tomorrow-night" style="display: block; border: 1px solid lightgray; background: rgb(45, 45, 45); padding: 10px; font-size: 12px;"><editarea class="text-mode code-section-edit-area" style="font-family: &quot;Fira code&quot;, &quot;Fira Mono&quot;, monospace;"><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">history </block><block class="operator token">=</block><block class=" token"> model</block><block class="punctuation token">.</block><block class=" token">fit</block><block class="punctuation token">(</block><block class=" token">X</block><block class="punctuation token">,</block><block class=" token"> y</block><block class="punctuation token">,</block><block class=" token"> epochs</block><block class="operator token">=</block><block class="number token">20</block><block class="punctuation token">)</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Epoch 1/20</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># 1/1 [==============================] - 0s 95ms/step - loss: 414.1458</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Epoch 2/20</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># 1/1 [==============================] - 0s 7ms/step - loss: 413.8977</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Epoch 3/20</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># 1/1 [==============================] - 0s 6ms/step - loss: 413.6497</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Epoch 4/20</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># 1/1 [==============================] - 0s 8ms/step - loss: 413.4017</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Epoch 5/20</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># 1/1 [==============================] - 0s 6ms/step - loss: 413.1539</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Epoch 6/20</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># 1/1 [==============================] - 0s 5ms/step - loss: 412.9061</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Epoch 7/20</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># 1/1 [==============================] - 0s 6ms/step - loss: 412.6584</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Epoch 8/20</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># 1/1 [==============================] - 0s 12ms/step - loss: 412.4107</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Epoch 9/20</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># 1/1 [==============================] - 0s 6ms/step - loss: 412.1632</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Epoch 10/20</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># 1/1 [==============================] - 0s 8ms/step - loss: 411.9157</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Epoch 11/20</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># 1/1 [==============================] - 0s 7ms/step - loss: 411.6683</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Epoch 12/20</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># 1/1 [==============================] - 0s 6ms/step - loss: 411.4211</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Epoch 13/20</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># 1/1 [==============================] - 0s 6ms/step - loss: 411.1739</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Epoch 14/20</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># 1/1 [==============================] - 0s 6ms/step - loss: 410.9268</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Epoch 15/20</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># 1/1 [==============================] - 0s 6ms/step - loss: 410.6798</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Epoch 16/20</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># 1/1 [==============================] - 0s 8ms/step - loss: 410.4330</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Epoch 17/20</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># 1/1 [==============================] - 0s 5ms/step - loss: 410.1861</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Epoch 18/20</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># 1/1 [==============================] - 0s 9ms/step - loss: 409.9394</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Epoch 19/20</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># 1/1 [==============================] - 0s 7ms/step - loss: 409.6928</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Epoch 20/20</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># 1/1 [==============================] - 0s 8ms/step - loss: 409.4462</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># 1/1 [==============================] - 0s 21ms/step</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">def</block><block class=" token"> </block><block class="function token">view_model_loss</block><block class="punctuation token">(</block><block class="punctuation token">)</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    plt</block><block class="punctuation token">.</block><block class=" token">clf</block><block class="punctuation token">(</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    plt</block><block class="punctuation token">.</block><block class=" token">plot</block><block class="punctuation token">(</block><block class=" token">history</block><block class="punctuation token">.</block><block class=" token">history</block><block class="punctuation token">[</block><block class="string token">"loss"</block><block class="punctuation token">]</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    plt</block><block class="punctuation token">.</block><block class=" token">title</block><block class="punctuation token">(</block><block class="string token">"Model Loss"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    plt</block><block class="punctuation token">.</block><block class=" token">ylabel</block><block class="punctuation token">(</block><block class="string token">"Loss"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    plt</block><block class="punctuation token">.</block><block class=" token">xlabel</block><block class="punctuation token">(</block><block class="string token">"Epoch"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    plt</block><block class="punctuation token">.</block><block class=" token">show</block><block class="punctuation token">(</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">view_model_loss</block><block class="punctuation token">(</block><block class="punctuation token">)</block></blocks></line></editarea></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 424.5px; height: 292.3px; position: relative;"><img src="image-resources/f48a1058-aa0c-44b6-8667-60fd54b653c0.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>With 20 epochs, the </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">mse</block><block> is still far higher than the baseline model (based on </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; font-weight: bold;">LinearRegression</block><block>). Let's try </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">epochs=4000</block><block>.</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 404px; height: 272.56px; position: relative;"><img src="image-resources/15543a6d-f162-48f9-83e9-cd4740f3c543.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold;">To get the model weights</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Our dummy data is created using </block><compositeblock dir="ltr" class="math-container-symbol role-mathmode-area inline" style="font-size: 17px;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mstyle displaystyle=&quot;true&quot;><mrow><mi>y</mi><mo form=&quot;infix&quot;>=</mo><mn>2</mn><mi>x</mi><mo form=&quot;infix&quot;>+</mo><mn>1</mn></mrow></mstyle></math>"><editarea class="math-mode-font lazy lazyable no-area-container" style="font-family: LatinModern-Math, LatinModern, Asana-Math, Asana;" aria-hidden="true"><line class="" style="line-height: 1.2;"><baselineblock></baselineblock><block class="Normal">y</block><block class="Relation">=</block><block class="Normal">2x</block><block class="Binary">+</block><block class="Normal">1</block></line></editarea><span role="presentation" style="width:100%;position:absolute;top:0;left:0;clip:rect(1px, 1px, 1px, 1px);height:1px;padding:1px 0 0 0!important;overflow:hidden;user-select:none;"><math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mrow><mi>y</mi><mo form="infix">=</mo><mn>2</mn><mi>x</mi><mo form="infix">+</mo><mn>1</mn></mrow></mstyle></math></span></compositeblock><block>. The coefficients are getting closer to truth.</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item full-line-block-inside" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="code-section-symbol inline" style="display: block;"><div class="code-section theme-tomorrow-night" style="display: block; border: 1px solid lightgray; background: rgb(45, 45, 45); padding: 10px; font-size: 12px;"><editarea class="text-mode code-section-edit-area" style="font-family: &quot;Fira code&quot;, &quot;Fira Mono&quot;, monospace;"><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">print</block><block class="punctuation token">(</block><block class=" token">model</block><block class="punctuation token">.</block><block class=" token">get_weights</block><block class="punctuation token">(</block><block class="punctuation token">)</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">predicted_w </block><block class="operator token">=</block><block class=" token"> model</block><block class="punctuation token">.</block><block class=" token">get_weights</block><block class="punctuation token">(</block><block class="punctuation token">)</block><block class="punctuation token">[</block><block class="number token">0</block><block class="punctuation token">]</block><block class="punctuation token">[</block><block class="number token">0</block><block class="punctuation token">]</block><block class="punctuation token">[</block><block class="number token">0</block><block class="punctuation token">]</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">predicted_b </block><block class="operator token">=</block><block class=" token"> model</block><block class="punctuation token">.</block><block class=" token">get_weights</block><block class="punctuation token">(</block><block class="punctuation token">)</block><block class="punctuation token">[</block><block class="number token">1</block><block class="punctuation token">]</block><block class="punctuation token">[</block><block class="number token">0</block><block class="punctuation token">]</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">print</block><block class="punctuation token">(</block><block class="string-interpolation string token">f"predicted_w: </block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">predicted_w</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">print</block><block class="punctuation token">(</block><block class="string-interpolation string token">f"predicted_b: </block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">predicted_b</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># [array([[1.55]], dtype=float32), array([1.], dtype=float32)]</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># predicted_w: 1.552058219909668</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># predicted_b: 0.9999967217445374</block></blocks></line></editarea></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 438px; height: 296.54px; position: relative;"><img src="image-resources/94bb39f4-d0e0-4144-a1fa-731f9103801e.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold;">Evaluate a network</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(0, 0, 0);">model.</block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(63, 131, 219);">evaluate</block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(0, 0, 0);">(X, y)</block><block>  prints loss value &amp; metrics values for the model in test mode.</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">[</block><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><compositeblock dir="ltr" class="anchor-tag-ref inline" style="font-family: &quot;Computer Modern Serif&quot;, serif; background-color: rgba(155, 155, 155, 0.2);"><a href="#n0.3715415633810799" style="color: inherit; text-decoration: inherit;">Back To Top</a></compositeblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">]</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode section sindent-1" data-line-id="n0.19553066077568682" style="font-size: 1.1em; padding-top: 0.5em; padding-bottom: 0.5em; font-weight: bold; line-height: 1.4;" id="n0.19553066077568682" role="heading" aria-level="2"><prefix style="text-align: left; padding-right: 0.25em;">1.4. </prefix><blocks><baselineblock class="inline"></baselineblock><block>Build a Simple Neural Network with Keras</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>We are using the </block><block class="role-hyper-link" data-hyper-link-url="https://scikit-learn.org/stable/datasets/real_world.html#california-housing-dataset" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://scikit-learn.org/stable/datasets/real_world.html#california-housing-dataset" target="_blank" style="color: inherit; text-decoration: inherit;">California Housing Dataset</a></block><block> for this section.</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>In Keras, the </block><block class="role-hyper-link" data-hyper-link-url="https://www.tensorflow.org/api_docs/python/tf/keras/losses" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://www.tensorflow.org/api_docs/python/tf/keras/losses" target="_blank" style="color: inherit; text-decoration: inherit;">loss function</a></block><block> is the function for our optimizer to minimize. </block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://www.tensorflow.org/api_docs/python/tf/keras/metrics" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://www.tensorflow.org/api_docs/python/tf/keras/metrics" target="_blank" style="color: inherit; text-decoration: inherit;">Metrics</a></block><block> are similar to a loss function, except that the results from evaluating a metric are not used when training the model.</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="background-color: rgb(255, 254, 0);">When in doubt, the Adam optimizer does a very good job</block><block>. </block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="text-decoration: underline;">If you want to adjust any of the hyperparameters</block><block>, you will need to import the optimizer from </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">optimizers</block><block> instead of passing in the name as a string.</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item full-line-block-inside" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="code-section-symbol inline" style="display: block;"><div class="code-section theme-tomorrow-night" style="display: block; border: 1px solid lightgray; background: rgb(45, 45, 45); padding: 10px; font-size: 12px;"><editarea class="text-mode code-section-edit-area" style="font-family: &quot;Fira code&quot;, &quot;Fira Mono&quot;, monospace;"><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Loading the data</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">train_df </block><block class="operator token">=</block><block class=" token"> spark</block><block class="punctuation token">.</block><block class=" token">read</block><block class="punctuation token">.</block><block class="builtin token">format</block><block class="punctuation token">(</block><block class="string token">"delta"</block><block class="punctuation token">)</block><block class="punctuation token">.</block><block class=" token">load</block><block class="punctuation token">(</block><block class="string-interpolation string token">f"</block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">DA</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">paths</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">datasets</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">/california-housing/train"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">X_train </block><block class="operator token">=</block><block class=" token"> train_df</block><block class="punctuation token">.</block><block class=" token">toPandas</block><block class="punctuation token">(</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">y_train </block><block class="operator token">=</block><block class=" token"> X_train</block><block class="punctuation token">.</block><block class=" token">pop</block><block class="punctuation token">(</block><block class="string token">"label"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">test_df </block><block class="operator token">=</block><block class=" token"> spark</block><block class="punctuation token">.</block><block class=" token">read</block><block class="punctuation token">.</block><block class="builtin token">format</block><block class="punctuation token">(</block><block class="string token">"delta"</block><block class="punctuation token">)</block><block class="punctuation token">.</block><block class=" token">load</block><block class="punctuation token">(</block><block class="string-interpolation string token">f"</block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">DA</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">paths</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">datasets</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">/california-housing/test"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">X_test </block><block class="operator token">=</block><block class=" token"> test_df</block><block class="punctuation token">.</block><block class=" token">toPandas</block><block class="punctuation token">(</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">y_test </block><block class="operator token">=</block><block class=" token"> X_test</block><block class="punctuation token">.</block><block class=" token">pop</block><block class="punctuation token">(</block><block class="string token">"label"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Building the network</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">from</block><block class=" token"> tensorflow</block><block class="punctuation token">.</block><block class=" token">keras</block><block class="punctuation token">.</block><block class=" token">layers </block><block class="keyword token">import</block><block class=" token"> Dense</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">from</block><block class=" token"> tensorflow</block><block class="punctuation token">.</block><block class=" token">keras</block><block class="punctuation token">.</block><block class=" token">models </block><block class="keyword token">import</block><block class=" token"> Sequential</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">import</block><block class=" token"> tensorflow </block><block class="keyword token">as</block><block class=" token"> tf</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">tf</block><block class="punctuation token">.</block><block class=" token">random</block><block class="punctuation token">.</block><block class=" token">set_seed</block><block class="punctuation token">(</block><block class="number token">42</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">model </block><block class="operator token">=</block><block class=" token"> Sequential</block><block class="punctuation token">(</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Input layer</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">model</block><block class="punctuation token">.</block><block class=" token">add</block><block class="punctuation token">(</block><block class=" token">Dense</block><block class="punctuation token">(</block><block class="number token">20</block><block class="punctuation token">,</block><block class=" token"> input_dim</block><block class="operator token">=</block><block class="number token">8</block><block class="punctuation token">,</block><block class=" token"> activation</block><block class="operator token">=</block><block class="string token">"relu"</block><block class="punctuation token">)</block><block class="punctuation token">)</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Automatically infers the input_dim based on the layer before it</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">model</block><block class="punctuation token">.</block><block class=" token">add</block><block class="punctuation token">(</block><block class=" token">Dense</block><block class="punctuation token">(</block><block class="number token">20</block><block class="punctuation token">,</block><block class=" token"> activation</block><block class="operator token">=</block><block class="string token">"relu"</block><block class="punctuation token">)</block><block class="punctuation token">)</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Output layer</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">model</block><block class="punctuation token">.</block><block class=" token">add</block><block class="punctuation token">(</block><block class=" token">Dense</block><block class="punctuation token">(</block><block class="number token">1</block><block class="punctuation token">,</block><block class=" token"> activation</block><block class="operator token">=</block><block class="string token">"linear"</block><block class="punctuation token">)</block><block class="punctuation token">)</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># ====================================</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># NOTE: Alternative Keras model syntax </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">def</block><block class=" token"> </block><block class="function token">build_model</block><block class="punctuation token">(</block><block class="punctuation token">)</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="keyword token">return</block><block class=" token"> Sequential</block><block class="punctuation token">(</block><block class="punctuation token">[</block><block class=" token">Dense</block><block class="punctuation token">(</block><block class="number token">20</block><block class="punctuation token">,</block><block class=" token"> input_dim</block><block class="operator token">=</block><block class="number token">8</block><block class="punctuation token">,</block><block class=" token"> activation</block><block class="operator token">=</block><block class="string token">"relu"</block><block class="punctuation token">)</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                       Dense</block><block class="punctuation token">(</block><block class="number token">20</block><block class="punctuation token">,</block><block class=" token"> activation</block><block class="operator token">=</block><block class="string token">"relu"</block><block class="punctuation token">)</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                       Dense</block><block class="punctuation token">(</block><block class="number token">1</block><block class="punctuation token">,</block><block class=" token"> activation</block><block class="operator token">=</block><block class="string token">"linear"</block><block class="punctuation token">)</block><block class="punctuation token">]</block><block class="punctuation token">)</block><block class=" token"> </block><block class="comment token"># Keep the last layer as linear because this is a regression problem</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># ====================================</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">model </block><block class="operator token">=</block><block class=" token"> build_model</block><block class="punctuation token">(</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">model</block><block class="punctuation token">.</block><block class=" token">summary</block><block class="punctuation token">(</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Defining the loss function and training it</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">from</block><block class=" token"> tensorflow</block><block class="punctuation token">.</block><block class=" token">keras </block><block class="keyword token">import</block><block class=" token"> metrics</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">from</block><block class=" token"> tensorflow</block><block class="punctuation token">.</block><block class=" token">keras </block><block class="keyword token">import</block><block class=" token"> losses</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">loss </block><block class="operator token">=</block><block class=" token"> </block><block class="string token">"mse"</block><block class=" token"> </block><block class="comment token"># Or loss = losses.mse</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">metrics </block><block class="operator token">=</block><block class=" token"> </block><block class="punctuation token">[</block><block class="string token">"mae"</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"mse"</block><block class="punctuation token">]</block><block class=" token"> </block><block class="comment token"># Or metrics = [metrics.mae, metrics.mse]</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">model</block><block class="punctuation token">.</block><block class="builtin token">compile</block><block class="punctuation token">(</block><block class=" token">optimizer</block><block class="operator token">=</block><block class="string token">"sgd"</block><block class="punctuation token">,</block><block class=" token"> loss</block><block class="operator token">=</block><block class=" token">loss</block><block class="punctuation token">,</block><block class=" token"> metrics</block><block class="operator token">=</block><block class=" token">metrics</block><block class="punctuation token">)</block><block class=" token"> </block><block class="comment token">#sgd stands for stochastic gradient decent </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">model</block><block class="punctuation token">.</block><block class=" token">fit</block><block class="punctuation token">(</block><block class=" token">X_train</block><block class="punctuation token">,</block><block class=" token"> y_train</block><block class="punctuation token">,</block><block class=" token"> epochs</block><block class="operator token">=</block><block class="number token">10</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># ======= Train again with a different learning rate</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">from</block><block class=" token"> tensorflow</block><block class="punctuation token">.</block><block class=" token">keras </block><block class="keyword token">import</block><block class=" token"> optimizers</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">model </block><block class="operator token">=</block><block class=" token"> build_model</block><block class="punctuation token">(</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">optimizer </block><block class="operator token">=</block><block class=" token"> optimizers</block><block class="punctuation token">.</block><block class=" token">SGD</block><block class="punctuation token">(</block><block class=" token">learning_rate</block><block class="operator token">=</block><block class="number token">0.000001</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">model</block><block class="punctuation token">.</block><block class="builtin token">compile</block><block class="punctuation token">(</block><block class=" token">optimizer</block><block class="operator token">=</block><block class=" token">optimizer</block><block class="punctuation token">,</block><block class=" token"> loss</block><block class="operator token">=</block><block class=" token">loss</block><block class="punctuation token">,</block><block class=" token"> metrics</block><block class="operator token">=</block><block class=" token">metrics</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">model</block><block class="punctuation token">.</block><block class=" token">fit</block><block class="punctuation token">(</block><block class=" token">X_train</block><block class="punctuation token">,</block><block class=" token"> y_train</block><block class="punctuation token">,</block><block class=" token"> epochs</block><block class="operator token">=</block><block class="number token">10</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># ======= Train again with a different optimizer</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">from</block><block class=" token"> tensorflow</block><block class="punctuation token">.</block><block class=" token">keras </block><block class="keyword token">import</block><block class=" token"> optimizers</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">model </block><block class="operator token">=</block><block class=" token"> build_model</block><block class="punctuation token">(</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">optimizer </block><block class="operator token">=</block><block class=" token"> optimizers</block><block class="punctuation token">.</block><block class=" token">Adam</block><block class="punctuation token">(</block><block class=" token">learning_rate</block><block class="operator token">=</block><block class="number token">0.001</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">model</block><block class="punctuation token">.</block><block class="builtin token">compile</block><block class="punctuation token">(</block><block class=" token">optimizer</block><block class="operator token">=</block><block class=" token">optimizer</block><block class="punctuation token">,</block><block class=" token"> loss</block><block class="operator token">=</block><block class=" token">loss</block><block class="punctuation token">,</block><block class=" token"> metrics</block><block class="operator token">=</block><block class=" token">metrics</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">history </block><block class="operator token">=</block><block class=" token"> model</block><block class="punctuation token">.</block><block class=" token">fit</block><block class="punctuation token">(</block><block class=" token">X_train</block><block class="punctuation token">,</block><block class=" token"> y_train</block><block class="punctuation token">,</block><block class=" token"> epochs</block><block class="operator token">=</block><block class="number token">20</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Plotting the loss across different epochs</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">import</block><block class=" token"> matplotlib</block><block class="punctuation token">.</block><block class=" token">pyplot </block><block class="keyword token">as</block><block class=" token"> plt</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">def</block><block class=" token"> </block><block class="function token">view_model_loss</block><block class="punctuation token">(</block><block class="punctuation token">)</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    plt</block><block class="punctuation token">.</block><block class=" token">clf</block><block class="punctuation token">(</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    plt</block><block class="punctuation token">.</block><block class=" token">semilogy</block><block class="punctuation token">(</block><block class=" token">history</block><block class="punctuation token">.</block><block class=" token">history</block><block class="punctuation token">[</block><block class="string token">"loss"</block><block class="punctuation token">]</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    plt</block><block class="punctuation token">.</block><block class=" token">title</block><block class="punctuation token">(</block><block class="string token">"Model Loss"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    plt</block><block class="punctuation token">.</block><block class=" token">ylabel</block><block class="punctuation token">(</block><block class="string token">"Loss"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    plt</block><block class="punctuation token">.</block><block class=" token">xlabel</block><block class="punctuation token">(</block><block class="string token">"Epoch"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    plt</block><block class="punctuation token">.</block><block class=" token">show</block><block class="punctuation token">(</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">view_model_loss</block><block class="punctuation token">(</block><block class="punctuation token">)</block></blocks></line></editarea></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 477px; height: 309.23px; position: relative;"><img src="image-resources/dfc6f888-0927-4835-a39d-c59fb44b8cb7.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>As you can see, the loss is not decreasing (or converging).</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="color: rgb(255, 64, 0); font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold; color: rgb(255, 64, 0);">Batch Size</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Let's set the </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">batch_size</block><block> (how much data to be processed simultaneously by the model) to 64.</block></blocks></line><line class="root text-mode indent-2 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="3"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;">* </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold; background-color: rgb(255, 254, 0);">Mini-batches are often a power of 2, to facilitate memory allocation on GPU (typically between 16 and 512)</block><block>.</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Let's also increase the number of </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">epochs</block><block> to 20.</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold; background-color: rgb(255, 254, 0);">Note:</block><block> Also, if you don't want to see all of the intermediate values print out, you can set the </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">verbose</block><block> parameter: </block><block style="font-weight: bold;">0 = silent</block><block>, </block><block style="font-weight: bold;">1 = progress bar</block><block>, </block><block style="font-weight: bold;">2 = one line per epoch</block><block> (</block><block style="text-decoration: underline;">defaults to 1</block><block>).</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item full-line-block-inside" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="code-section-symbol inline" style="display: block;"><div class="code-section theme-tomorrow-night" style="display: block; border: 1px solid lightgray; background: rgb(45, 45, 45); padding: 10px; font-size: 12px;"><editarea class="text-mode code-section-edit-area" style="font-family: &quot;Fira code&quot;, &quot;Fira Mono&quot;, monospace;"><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">model </block><block class="operator token">=</block><block class=" token"> build_model</block><block class="punctuation token">(</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">optimizer </block><block class="operator token">=</block><block class=" token"> optimizers</block><block class="punctuation token">.</block><block class=" token">Adam</block><block class="punctuation token">(</block><block class=" token">learning_rate</block><block class="operator token">=</block><block class="number token">0.001</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">model</block><block class="punctuation token">.</block><block class="builtin token">compile</block><block class="punctuation token">(</block><block class=" token">optimizer</block><block class="operator token">=</block><block class=" token">optimizer</block><block class="punctuation token">,</block><block class=" token"> loss</block><block class="operator token">=</block><block class=" token">loss</block><block class="punctuation token">,</block><block class=" token"> metrics</block><block class="operator token">=</block><block class=" token">metrics</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">history </block><block class="operator token">=</block><block class=" token"> model</block><block class="punctuation token">.</block><block class=" token">fit</block><block class="punctuation token">(</block><block class=" token">X_train</block><block class="punctuation token">,</block><block class=" token"> y_train</block><block class="punctuation token">,</block><block class=" token"> epochs</block><block class="operator token">=</block><block class="number token">20</block><block class="punctuation token">,</block><block class=" token"> batch_size</block><block class="operator token">=</block><block class="number token">64</block><block class="punctuation token">,</block><block class=" token"> verbose</block><block class="operator token">=</block><block class="number token">2</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Evaluate the model</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">model</block><block class="punctuation token">.</block><block class=" token">evaluate</block><block class="punctuation token">(</block><block class=" token">X_test</block><block class="punctuation token">,</block><block class=" token"> y_test</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Save/load/train more the model</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">filepath </block><block class="operator token">=</block><block class=" token"> </block><block class="string-interpolation string token">f"</block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">DA</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">paths</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">working_path</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">/keras_checkpoint_weights.ckpt"</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">print</block><block class="punctuation token">(</block><block class=" token">filepath</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">model</block><block class="punctuation token">.</block><block class=" token">save</block><block class="punctuation token">(</block><block class=" token">filepath</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">from</block><block class=" token"> tensorflow</block><block class="punctuation token">.</block><block class=" token">keras</block><block class="punctuation token">.</block><block class=" token">models </block><block class="keyword token">import</block><block class=" token"> load_model</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">new_model </block><block class="operator token">=</block><block class=" token"> load_model</block><block class="punctuation token">(</block><block class=" token">filepath</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">new_model</block><block class="punctuation token">.</block><block class=" token">fit</block><block class="punctuation token">(</block><block class=" token">X_train</block><block class="punctuation token">,</block><block class=" token"> y_train</block><block class="punctuation token">,</block><block class=" token"> epochs</block><block class="operator token">=</block><block class="number token">1</block><block class="punctuation token">,</block><block class=" token"> batch_size</block><block class="operator token">=</block><block class="number token">64</block><block class="punctuation token">,</block><block class=" token"> verbose</block><block class="operator token">=</block><block class="number token">2</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">new_model</block><block class="punctuation token">.</block><block class=" token">save_weights</block><block class="punctuation token">(</block><block class=" token">filepath</block><block class="punctuation token">)</block><block class=" token"> </block><block class="comment token"># Using save_weights because the architecture is already saved</block></blocks></line></editarea></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">[</block><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><compositeblock dir="ltr" class="anchor-tag-ref inline" style="font-family: &quot;Computer Modern Serif&quot;, serif; background-color: rgba(155, 155, 155, 0.2);"><a href="#n0.3715415633810799" style="color: inherit; text-decoration: inherit;">Back To Top</a></compositeblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">]</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode section sindent-1" data-line-id="n0.6587288027127318" style="font-size: 1.1em; padding-top: 0.5em; padding-bottom: 0.5em; font-weight: bold; line-height: 1.4;" id="n0.6587288027127318" role="heading" aria-level="2"><prefix style="text-align: left; padding-right: 0.25em;">1.5. </prefix><blocks><baselineblock class="inline"></baselineblock><block>Preprocessing with tf.keras.layers</block></blocks></line><line class="root text-mode section sindent-2" data-line-id="n0.2836853497313969" style="font-size: 1em; padding-top: 0.5em; padding-bottom: 0.5em; font-weight: bold; line-height: 1.4;" id="n0.2836853497313969" role="heading" aria-level="3"><prefix style="text-align: left; padding-right: 0em;">1.5.1. </prefix><blocks><baselineblock class="inline"></baselineblock><block>Normalization</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Because our features are all on different scales, it's going to be more difficult for our neural network during training. Let's do </block><block style="font-weight: bold;">feature-wise standardization</block><block>.</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>We are going to use the </block><block class="role-hyper-link" data-hyper-link-url="https://www.tensorflow.org/api_docs/python/tf/keras/layers/Normalization" style="text-decoration: underline; color: rgb(17, 85, 204); background-color: rgb(255, 254, 0);"><a href="https://www.tensorflow.org/api_docs/python/tf/keras/layers/Normalization" target="_blank" style="color: inherit; text-decoration: inherit;">Normalization</a></block><block style="background-color: rgb(255, 254, 0);"> from TensorFlow</block><block>, which will remove the mean (zero-mean) and scale to unit variance. </block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold; background-color: rgb(255, 254, 0);">Note:</block><block> Even though </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">tf.keras</block><block> calls its Normalization layer "normalization", it implements the standardization formula under the hood (and not normalization - confusing, we know!).</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="math-container-symbol role-mathmode-area display" style="font-size: 17px;" data-mathml="<math display=&quot;block&quot; xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>x</mi><mi></mi><mo form=&quot;infix&quot;>=</mo><mfrac><mrow><mi>x</mi><mo form=&quot;infix&quot;>-</mo><mover accent=&quot;true&quot;><mi>x</mi><mo></mo></mover></mrow><mi></mi></mfrac></math>"><editarea class="math-mode-font lazy lazyable no-area-container" style="font-family: LatinModern-Math, LatinModern, Asana-Math, Asana;" aria-hidden="true"><line class="taggable" style="line-height: 1.2;"><baselineblock></baselineblock><block class="Normal">x</block><block class="Relation">=</block><compositeblock dir="ltr" class="fraction-symbol smaller"><editarea-line class=" frac-edit-area enumerator" style="line-height: 1.2; margin-bottom: -0.470588em;"><baselineblock></baselineblock><block class="Normal">x</block><block class="Binary">-</block><compositeblock dir="ltr" class="over-line-symbol ig-ex-br inline"><line-border style="height: 0.352941em; margin-top: 0.117647em; margin-bottom: -0.470588em;"><hcomposed-symbol style="font-family: LatinModern-Math, LatinModern, Asana-Math, Asana; font-style: normal; font-weight: normal;"><middle><fixed><inside></inside></fixed></middle></hcomposed-symbol></line-border><editarea-line class=" " style="margin-top: -0.235294em; line-height: 1.2;"><baselineblock></baselineblock><block class="Normal">x</block></editarea-line></compositeblock></editarea-line><div class="frac-line"><inline style="border-bottom: 1px solid;"></inline></div><editarea-line class=" frac-edit-area denominator" style="margin-bottom: -0.176471em; line-height: 1.2; margin-top: -0.411765em;"><baselineblock></baselineblock><block class="Normal"></block></editarea-line></compositeblock></line></editarea><span role="presentation" style="width:100%;position:absolute;top:0;left:0;clip:rect(1px, 1px, 1px, 1px);height:1px;padding:1px 0 0 0!important;overflow:hidden;user-select:none;"><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><mi>x</mi><mi></mi><mo form="infix">=</mo><mfrac><mrow><mi>x</mi><mo form="infix">-</mo><mover accent="true"><mi>x</mi><mo></mo></mover></mrow><mi></mi></mfrac></math></span></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item full-line-block-inside" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="code-section-symbol inline" style="display: block;"><div class="code-section theme-tomorrow-night" style="display: block; border: 1px solid lightgray; background: rgb(45, 45, 45); padding: 10px; font-size: 12px;"><editarea class="text-mode code-section-edit-area" style="font-family: &quot;Fira code&quot;, &quot;Fira Mono&quot;, monospace;"><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">import</block><block class=" token"> tensorflow </block><block class="keyword token">as</block><block class=" token"> tf</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">from</block><block class=" token"> tensorflow</block><block class="punctuation token">.</block><block class=" token">keras</block><block class="punctuation token">.</block><block class=" token">models </block><block class="keyword token">import</block><block class=" token"> Sequential</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">from</block><block class=" token"> tensorflow</block><block class="punctuation token">.</block><block class=" token">keras</block><block class="punctuation token">.</block><block class=" token">layers </block><block class="keyword token">import</block><block class=" token"> Dense</block><block class="punctuation token">,</block><block class=" token"> Normalization</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">tf</block><block class="punctuation token">.</block><block class=" token">random</block><block class="punctuation token">.</block><block class=" token">set_seed</block><block class="punctuation token">(</block><block class="number token">42</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">train_df </block><block class="operator token">=</block><block class=" token"> spark</block><block class="punctuation token">.</block><block class=" token">read</block><block class="punctuation token">.</block><block class="builtin token">format</block><block class="punctuation token">(</block><block class="string token">"delta"</block><block class="punctuation token">)</block><block class="punctuation token">.</block><block class=" token">load</block><block class="punctuation token">(</block><block class="string-interpolation string token">f"</block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">DA</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">paths</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">datasets</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">/california-housing/train"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">X_train </block><block class="operator token">=</block><block class=" token"> train_df</block><block class="punctuation token">.</block><block class=" token">toPandas</block><block class="punctuation token">(</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">y_train </block><block class="operator token">=</block><block class=" token"> X_train</block><block class="punctuation token">.</block><block class=" token">pop</block><block class="punctuation token">(</block><block class="string token">"label"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">test_df </block><block class="operator token">=</block><block class=" token"> spark</block><block class="punctuation token">.</block><block class=" token">read</block><block class="punctuation token">.</block><block class="builtin token">format</block><block class="punctuation token">(</block><block class="string token">"delta"</block><block class="punctuation token">)</block><block class="punctuation token">.</block><block class=" token">load</block><block class="punctuation token">(</block><block class="string-interpolation string token">f"</block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">DA</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">paths</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">datasets</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">/california-housing/test"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">X_test </block><block class="operator token">=</block><block class=" token"> test_df</block><block class="punctuation token">.</block><block class=" token">toPandas</block><block class="punctuation token">(</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">y_test </block><block class="operator token">=</block><block class=" token"> X_test</block><block class="punctuation token">.</block><block class=" token">pop</block><block class="punctuation token">(</block><block class="string token">"label"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Normalizing the data using Keras</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">normalize_layer </block><block class="operator token">=</block><block class=" token"> Normalization</block><block class="punctuation token">(</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">normalize_layer</block><block class="punctuation token">.</block><block class=" token">adapt</block><block class="punctuation token">(</block><block class=" token">X_train</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># ======== Normalizing inside the model</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">def</block><block class=" token"> </block><block class="function token">build_model</block><block class="punctuation token">(</block><block class="punctuation token">)</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="keyword token">return</block><block class=" token"> Sequential</block><block class="punctuation token">(</block><block class="punctuation token">[</block><block class=" token">normalize_layer</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                       Dense</block><block class="punctuation token">(</block><block class="number token">20</block><block class="punctuation token">,</block><block class=" token"> input_dim</block><block class="operator token">=</block><block class="number token">8</block><block class="punctuation token">,</block><block class=" token"> activation</block><block class="operator token">=</block><block class="string token">"relu"</block><block class="punctuation token">)</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                       Dense</block><block class="punctuation token">(</block><block class="number token">20</block><block class="punctuation token">,</block><block class=" token"> activation</block><block class="operator token">=</block><block class="string token">"relu"</block><block class="punctuation token">)</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                       Dense</block><block class="punctuation token">(</block><block class="number token">1</block><block class="punctuation token">,</block><block class=" token"> activation</block><block class="operator token">=</block><block class="string token">"linear"</block><block class="punctuation token">)</block><block class="punctuation token">]</block><block class="punctuation token">)</block><block class=" token"> </block><block class="comment token"># Keep the output layer as linear because this is a regression problem</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># ========</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">model </block><block class="operator token">=</block><block class=" token"> build_model</block><block class="punctuation token">(</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">optimizer </block><block class="operator token">=</block><block class=" token"> tf</block><block class="punctuation token">.</block><block class=" token">keras</block><block class="punctuation token">.</block><block class=" token">optimizers</block><block class="punctuation token">.</block><block class=" token">Adam</block><block class="punctuation token">(</block><block class=" token">learning_rate</block><block class="operator token">=</block><block class="number token">0.001</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">model</block><block class="punctuation token">.</block><block class="builtin token">compile</block><block class="punctuation token">(</block><block class=" token">optimizer</block><block class="operator token">=</block><block class=" token">optimizer</block><block class="punctuation token">,</block><block class=" token"> loss</block><block class="operator token">=</block><block class="string token">"mse"</block><block class="punctuation token">,</block><block class=" token"> metrics</block><block class="operator token">=</block><block class="punctuation token">[</block><block class="string token">"mae"</block><block class="punctuation token">]</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">model</block><block class="punctuation token">.</block><block class=" token">summary</block><block class="punctuation token">(</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">history </block><block class="operator token">=</block><block class=" token"> model</block><block class="punctuation token">.</block><block class=" token">fit</block><block class="punctuation token">(</block><block class=" token">X_train</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                    y_train</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                    epochs</block><block class="operator token">=</block><block class="number token">3</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                    batch_size</block><block class="operator token">=</block><block class="number token">32</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                   </block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">model</block><block class="punctuation token">.</block><block class=" token">evaluate</block><block class="punctuation token">(</block><block class=" token">X_test</block><block class="punctuation token">,</block><block class=" token"> y_test</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line></editarea></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold;">Normalization outside the model</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Including the preprocessing layer inside the model is pretty straightforward for inference. </block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="text-decoration: underline;">Some argue that this will slow down training since preprocessing happens once per epoch</block><block>. </block></blocks></line><line class="root text-mode indent-2 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="3"><prefix style="font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left;">* </prefix><blocks><baselineblock class="inline"></baselineblock><block>However, the slow down due to </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">tf.keras.Normalization</block><block> is </block><block style="text-decoration: underline;">quite negligible</block><block> since it is a simple operation, according to the author of </block><block class="role-hyper-link" data-hyper-link-url="https://learning.oreilly.com/library/view/hands-on-machine-learning/9781098125967/" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://learning.oreilly.com/library/view/hands-on-machine-learning/9781098125967/" target="_blank" style="color: inherit; text-decoration: inherit;">Hands-On Machine Learning with Scikit-Learn, Keras, and TensorFlow</a></block><block>.</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>However, if you wish to do </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">tf.keras.Normalization</block><block> outside the model, you can do it as well, similar to </block><block class="role-hyper-link" data-hyper-link-url="https://scikit-learn.org/stable/modules/generated/sklearn.preprocessing.StandardScaler.html" style="text-decoration: underline; font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);"><a href="https://scikit-learn.org/stable/modules/generated/sklearn.preprocessing.StandardScaler.html" target="_blank" style="color: inherit; text-decoration: inherit;">sklearn.preprocessing.StandardScaler</a></block><block>.</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item full-line-block-inside" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="code-section-symbol inline" style="display: block;"><div class="code-section theme-tomorrow-night" style="display: block; border: 1px solid lightgray; background: rgb(45, 45, 45); padding: 10px; font-size: 12px;"><editarea class="text-mode code-section-edit-area" style="font-family: &quot;Fira code&quot;, &quot;Fira Mono&quot;, monospace;"><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">normalize_layer </block><block class="operator token">=</block><block class=" token"> tf</block><block class="punctuation token">.</block><block class=" token">keras</block><block class="punctuation token">.</block><block class=" token">layers</block><block class="punctuation token">.</block><block class=" token">Normalization</block><block class="punctuation token">(</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">normalize_layer</block><block class="punctuation token">.</block><block class=" token">adapt</block><block class="punctuation token">(</block><block class=" token">X_train</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">X_train_scaled </block><block class="operator token">=</block><block class=" token"> normalize_layer</block><block class="punctuation token">(</block><block class=" token">X_train</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">outside_model </block><block class="operator token">=</block><block class=" token"> Sequential</block><block class="punctuation token">(</block><block class="punctuation token">[</block><block class=" token">Dense</block><block class="punctuation token">(</block><block class="number token">20</block><block class="punctuation token">,</block><block class=" token"> input_dim</block><block class="operator token">=</block><block class="number token">8</block><block class="punctuation token">,</block><block class=" token"> activation</block><block class="operator token">=</block><block class="string token">"relu"</block><block class="punctuation token">)</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                            Dense</block><block class="punctuation token">(</block><block class="number token">20</block><block class="punctuation token">,</block><block class=" token"> activation</block><block class="operator token">=</block><block class="string token">"relu"</block><block class="punctuation token">)</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                            Dense</block><block class="punctuation token">(</block><block class="number token">1</block><block class="punctuation token">,</block><block class=" token"> activation</block><block class="operator token">=</block><block class="string token">"linear"</block><block class="punctuation token">)</block><block class="punctuation token">]</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">optimizer </block><block class="operator token">=</block><block class=" token"> tf</block><block class="punctuation token">.</block><block class=" token">keras</block><block class="punctuation token">.</block><block class=" token">optimizers</block><block class="punctuation token">.</block><block class=" token">Adam</block><block class="punctuation token">(</block><block class=" token">learning_rate</block><block class="operator token">=</block><block class="number token">0.001</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">outside_model</block><block class="punctuation token">.</block><block class="builtin token">compile</block><block class="punctuation token">(</block><block class=" token">optimizer</block><block class="operator token">=</block><block class=" token">optimizer</block><block class="punctuation token">,</block><block class=" token"> loss</block><block class="operator token">=</block><block class="string token">"mse"</block><block class="punctuation token">,</block><block class=" token"> metrics</block><block class="operator token">=</block><block class="punctuation token">[</block><block class="string token">"mae"</block><block class="punctuation token">]</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">outside_model</block><block class="punctuation token">.</block><block class=" token">summary</block><block class="punctuation token">(</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">outside_model</block><block class="punctuation token">.</block><block class=" token">fit</block><block class="punctuation token">(</block><block class=" token">X_train_scaled</block><block class="punctuation token">,</block><block class=" token"> y_train</block><block class="punctuation token">,</block><block class=" token"> epochs</block><block class="operator token">=</block><block class="number token">3</block><block class="punctuation token">,</block><block class=" token"> batch_size</block><block class="operator token">=</block><block class="number token">32</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">inference_model </block><block class="operator token">=</block><block class=" token"> tf</block><block class="punctuation token">.</block><block class=" token">keras</block><block class="punctuation token">.</block><block class=" token">Sequential</block><block class="punctuation token">(</block><block class="punctuation token">[</block><block class=" token">normalize_layer</block><block class="punctuation token">,</block><block class=" token"> outside_model</block><block class="punctuation token">]</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">y_pred </block><block class="operator token">=</block><block class=" token"> inference_model</block><block class="punctuation token">(</block><block class=" token">X_test</block><block class="punctuation token">)</block></blocks></line></editarea></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">[</block><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><compositeblock dir="ltr" class="anchor-tag-ref inline" style="font-family: &quot;Computer Modern Serif&quot;, serif; background-color: rgba(155, 155, 155, 0.2);"><a href="#n0.3715415633810799" style="color: inherit; text-decoration: inherit;">Back To Top</a></compositeblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">]</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode section sindent-1" data-line-id="n0.4041849592632032" style="font-size: 1.1em; padding-top: 0.5em; padding-bottom: 0.5em; font-weight: bold; line-height: 1.4;" id="n0.4041849592632032" role="heading" aria-level="2"><prefix style="text-align: left; padding-right: 0.25em;">1.6. </prefix><blocks><baselineblock class="inline"></baselineblock><block>Callbacks</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item full-line-block-inside" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="code-section-symbol inline" style="display: block;"><div class="code-section theme-tomorrow-night" style="display: block; border: 1px solid lightgray; background: rgb(45, 45, 45); padding: 10px; font-size: 12px;"><editarea class="text-mode code-section-edit-area" style="font-family: &quot;Fira code&quot;, &quot;Fira Mono&quot;, monospace;"><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">train_df </block><block class="operator token">=</block><block class=" token"> spark</block><block class="punctuation token">.</block><block class=" token">read</block><block class="punctuation token">.</block><block class="builtin token">format</block><block class="punctuation token">(</block><block class="string token">"delta"</block><block class="punctuation token">)</block><block class="punctuation token">.</block><block class=" token">load</block><block class="punctuation token">(</block><block class="string-interpolation string token">f"</block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">DA</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">paths</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">datasets</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">/california-housing/train"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">X_train </block><block class="operator token">=</block><block class=" token"> train_df</block><block class="punctuation token">.</block><block class=" token">toPandas</block><block class="punctuation token">(</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">y_train </block><block class="operator token">=</block><block class=" token"> X_train</block><block class="punctuation token">.</block><block class=" token">pop</block><block class="punctuation token">(</block><block class="string token">"label"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">test_df </block><block class="operator token">=</block><block class=" token"> spark</block><block class="punctuation token">.</block><block class=" token">read</block><block class="punctuation token">.</block><block class="builtin token">format</block><block class="punctuation token">(</block><block class="string token">"delta"</block><block class="punctuation token">)</block><block class="punctuation token">.</block><block class=" token">load</block><block class="punctuation token">(</block><block class="string-interpolation string token">f"</block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">DA</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">paths</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">datasets</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">/california-housing/test"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">X_test </block><block class="operator token">=</block><block class=" token"> test_df</block><block class="punctuation token">.</block><block class=" token">toPandas</block><block class="punctuation token">(</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">y_test </block><block class="operator token">=</block><block class=" token"> X_test</block><block class="punctuation token">.</block><block class=" token">pop</block><block class="punctuation token">(</block><block class="string token">"label"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Define the model</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">import</block><block class=" token"> tensorflow </block><block class="keyword token">as</block><block class=" token"> tf</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">from</block><block class=" token"> tensorflow</block><block class="punctuation token">.</block><block class=" token">keras</block><block class="punctuation token">.</block><block class=" token">models </block><block class="keyword token">import</block><block class=" token"> Sequential</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">from</block><block class=" token"> tensorflow</block><block class="punctuation token">.</block><block class=" token">keras</block><block class="punctuation token">.</block><block class=" token">layers </block><block class="keyword token">import</block><block class=" token"> Dense</block><block class="punctuation token">,</block><block class=" token"> Normalization  </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">from</block><block class=" token"> tensorflow</block><block class="punctuation token">.</block><block class=" token">keras</block><block class="punctuation token">.</block><block class=" token">optimizers </block><block class="keyword token">import</block><block class=" token"> Adam</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">tf</block><block class="punctuation token">.</block><block class=" token">random</block><block class="punctuation token">.</block><block class=" token">set_seed</block><block class="punctuation token">(</block><block class="number token">42</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">normalize_layer </block><block class="operator token">=</block><block class=" token"> Normalization</block><block class="punctuation token">(</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">normalize_layer</block><block class="punctuation token">.</block><block class=" token">adapt</block><block class="punctuation token">(</block><block class=" token">X_train</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">model </block><block class="operator token">=</block><block class=" token"> Sequential</block><block class="punctuation token">(</block><block class="punctuation token">[</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    normalize_layer</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    Dense</block><block class="punctuation token">(</block><block class="number token">20</block><block class="punctuation token">,</block><block class=" token"> input_dim</block><block class="operator token">=</block><block class="number token">8</block><block class="punctuation token">,</block><block class=" token"> activation</block><block class="operator token">=</block><block class="string token">"relu"</block><block class="punctuation token">)</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    Dense</block><block class="punctuation token">(</block><block class="number token">20</block><block class="punctuation token">,</block><block class=" token"> activation</block><block class="operator token">=</block><block class="string token">"relu"</block><block class="punctuation token">)</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    Dense</block><block class="punctuation token">(</block><block class="number token">1</block><block class="punctuation token">,</block><block class=" token"> activation</block><block class="operator token">=</block><block class="string token">"linear"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="punctuation token">]</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">model</block><block class="punctuation token">.</block><block class="builtin token">compile</block><block class="punctuation token">(</block><block class=" token">optimizer</block><block class="operator token">=</block><block class=" token">Adam</block><block class="punctuation token">(</block><block class=" token">learning_rate</block><block class="operator token">=</block><block class="number token">0.001</block><block class="punctuation token">)</block><block class="punctuation token">,</block><block class=" token"> loss</block><block class="operator token">=</block><block class="string token">"mse"</block><block class="punctuation token">,</block><block class=" token"> metrics</block><block class="operator token">=</block><block class="punctuation token">[</block><block class="string token">"mae"</block><block class="punctuation token">]</block><block class="punctuation token">)</block></blocks></line></editarea></div></compositeblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode section sindent-2" data-line-id="n0.1217174443780098" style="font-size: 1em; padding-top: 0.5em; padding-bottom: 0.5em; font-weight: bold; line-height: 1.4;" id="n0.1217174443780098" role="heading" aria-level="3"><prefix style="text-align: left; padding-right: 0em;">1.6.1. </prefix><blocks><baselineblock class="inline"></baselineblock><block>Validation Data</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Let's take a look at the </block><block class="role-hyper-link" data-hyper-link-url="https://www.tensorflow.org/api_docs/python/tf/keras/Sequential#fit" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://www.tensorflow.org/api_docs/python/tf/keras/Sequential#fit" target="_blank" style="color: inherit; text-decoration: inherit;">.fit()</a></block><block> method in the docs to see all of the options we have available!</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="background-color: rgb(255, 254, 0);">We can either explicitly specify a validation dataset, or we can specify a fraction of our training data to be used as our validation dataset</block><block>.</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="text-decoration: underline;">Typically</block><block>, a validation set will be a curated part of the training dataset that covers a decent spread of the statistics that the larger training dataset will contain. </block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>A </block><block style="font-weight: bold;">validation dataset</block><block> can be pulled out of the training dataset, or a curated validation dataset can be created and kept seperately. </block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>The </block><block style="text-decoration: underline;">reason why we need a validation dataset</block><block> is to evaluate how well we are performing on unseen data (neural networks will overfit if you train them for too long!).</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>We can specify </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">validation_split</block><block> to be any value between 0.0 and 1.0 (</block><block style="text-decoration: underline;">defaults to 0.0</block><block>).</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item full-line-block-inside" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="code-section-symbol inline" style="display: block;"><div class="code-section theme-tomorrow-night" style="display: block; border: 1px solid lightgray; background: rgb(45, 45, 45); padding: 10px; font-size: 10px;"><editarea class="text-mode code-section-edit-area" style="font-family: &quot;Fira code&quot;, &quot;Fira Mono&quot;, monospace;"><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">history </block><block class="operator token">=</block><block class=" token"> model</block><block class="punctuation token">.</block><block class=" token">fit</block><block class="punctuation token">(</block><block class=" token">X_train</block><block class="punctuation token">,</block><block class=" token"> y_train</block><block class="punctuation token">,</block><block class=" token"> validation_split</block><block class="operator token">=</block><block class="number token">.2</block><block class="punctuation token">,</block><block class=" token"> epochs</block><block class="operator token">=</block><block class="number token">10</block><block class="punctuation token">,</block><block class=" token"> batch_size</block><block class="operator token">=</block><block class="number token">64</block><block class="punctuation token">,</block><block class=" token"> verbose</block><block class="operator token">=</block><block class="number token">2</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Epoch 1/10</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># 183/183 - 1s - loss: 1.4918 - mae: 0.8059 - val_loss: 1.0942 - val_mae: 0.7448 - 1s/epoch - 8ms/step</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Epoch 2/10</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># 183/183 - 0s - loss: 0.7521 - mae: 0.5594 - val_loss: 0.7653 - val_mae: 0.6248 - 339ms/epoch - 2ms/step</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Epoch 3/10</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># 183/183 - 0s - loss: 0.5203 - mae: 0.4751 - val_loss: 0.5779 - val_mae: 0.5544 - 343ms/epoch - 2ms/step</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Epoch 4/10</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># 183/183 - 0s - loss: 0.4249 - mae: 0.4415 - val_loss: 0.5254 - val_mae: 0.5322 - 457ms/epoch - 2ms/step</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Epoch 5/10</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># 183/183 - 0s - loss: 0.3848 - mae: 0.4278 - val_loss: 0.5316 - val_mae: 0.5352 - 332ms/epoch - 2ms/step</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Epoch 6/10</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># 183/183 - 0s - loss: 0.3647 - mae: 0.4206 - val_loss: 0.4997 - val_mae: 0.5192 - 423ms/epoch - 2ms/step</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Epoch 7/10</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># 183/183 - 0s - loss: 0.3537 - mae: 0.4147 - val_loss: 0.5047 - val_mae: 0.5222 - 334ms/epoch - 2ms/step</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Epoch 8/10</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># 183/183 - 0s - loss: 0.3489 - mae: 0.4127 - val_loss: 0.4755 - val_mae: 0.5082 - 344ms/epoch - 2ms/step</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Epoch 9/10</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># 183/183 - 0s - loss: 0.3450 - mae: 0.4097 - val_loss: 0.4687 - val_mae: 0.5062 - 419ms/epoch - 2ms/step</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Epoch 10/10</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># 183/183 - 0s - loss: 0.3411 - mae: 0.4076 - val_loss: 0.4533 - val_mae: 0.4977 - 332ms/epoch - 2ms/step</block></blocks></line></editarea></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode section sindent-2" data-line-id="n0.999112295444228" style="font-size: 1em; padding-top: 0.5em; padding-bottom: 0.5em; font-weight: bold; line-height: 1.4;" id="n0.999112295444228" role="heading" aria-level="3"><prefix style="text-align: left; padding-right: 0em;">1.6.2. </prefix><blocks><baselineblock class="inline"></baselineblock><block>Checkpointing</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>After each epoch, we want to save the model. </block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>However, we will pass in the flag </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">save_best_only=True</block><block>, which will </block><block style="text-decoration: underline;">only save the model if the validation loss decreased</block><block>. </block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="background-color: rgb(255, 254, 0);">This way, if our machine crashes or we start to overfit, we can always go back to the "good" state of the model</block><block>.</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>To accomplish this, we will use the </block><block class="role-hyper-link" data-hyper-link-url="https://www.tensorflow.org/api_docs/python/tf/keras/callbacks/ModelCheckpoint" style="text-decoration: underline; font-family: &quot;Computer Modern Typewriter&quot;, serif; font-weight: bold; color: rgb(17, 85, 204);"><a href="https://www.tensorflow.org/api_docs/python/tf/keras/callbacks/ModelCheckpoint" target="_blank" style="color: inherit; text-decoration: inherit;">ModelCheckpoint</a></block><block class="role-hyper-link" data-hyper-link-url="https://www.tensorflow.org/api_docs/python/tf/keras/callbacks/ModelCheckpoint" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://www.tensorflow.org/api_docs/python/tf/keras/callbacks/ModelCheckpoint" target="_blank" style="color: inherit; text-decoration: inherit;"> callback</a></block><block>. </block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold;">History</block><block> is an example of a callback that is </block><block style="text-decoration: underline;">automatically</block><block> applied to every Keras model.</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item full-line-block-inside" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="code-section-symbol inline" style="display: block;"><div class="code-section theme-tomorrow-night" style="display: block; border: 1px solid lightgray; background: rgb(45, 45, 45); padding: 10px; font-size: 12px;"><editarea class="text-mode code-section-edit-area" style="font-family: &quot;Fira code&quot;, &quot;Fira Mono&quot;, monospace;"><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">from</block><block class=" token"> tensorflow</block><block class="punctuation token">.</block><block class=" token">keras</block><block class="punctuation token">.</block><block class=" token">callbacks </block><block class="keyword token">import</block><block class=" token"> ModelCheckpoint</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">filepath </block><block class="operator token">=</block><block class=" token"> </block><block class="string-interpolation string token">f"</block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">DA</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">paths</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">working_path</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">/keras_checkpoint_weights.ckpt"</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">model_checkpoint </block><block class="operator token">=</block><block class=" token"> ModelCheckpoint</block><block class="punctuation token">(</block><block class=" token">filepath</block><block class="operator token">=</block><block class=" token">filepath</block><block class="punctuation token">,</block><block class=" token"> verbose</block><block class="operator token">=</block><block class="number token">1</block><block class="punctuation token">,</block><block class=" token"> save_best_only</block><block class="operator token">=</block><block class="boolean token">True</block><block class="punctuation token">)</block></blocks></line></editarea></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode section sindent-2" data-line-id="n0.6531623192089258" style="font-size: 1em; padding-top: 0.5em; padding-bottom: 0.5em; font-weight: bold; line-height: 1.4;" id="n0.6531623192089258" role="heading" aria-level="3"><prefix style="text-align: left; padding-right: 0em;">1.6.3. </prefix><blocks><baselineblock class="inline"></baselineblock><block>Tensorboard</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="background-color: rgb(255, 254, 0);">Tensorboard provides a nice UI to visualize the training process</block><block> of your neural network and can help with debugging! We can define it as a callback.</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Here are links to Tensorboard resources:</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://www.tensorflow.org/tensorboard/get_started" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://www.tensorflow.org/tensorboard/get_started" target="_blank" style="color: inherit; text-decoration: inherit;">Getting Started with Tensorboard</a></block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://www.tensorflow.org/tensorboard/tensorboard_profiling_keras" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://www.tensorflow.org/tensorboard/tensorboard_profiling_keras" target="_blank" style="color: inherit; text-decoration: inherit;">Profiling with Tensorboard</a></block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://www.datacamp.com/community/tutorials/tensorboard-tutorial" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://www.datacamp.com/community/tutorials/tensorboard-tutorial" target="_blank" style="color: inherit; text-decoration: inherit;">Effects of Weight Initialization</a></block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Here is a </block><block class="role-hyper-link" data-hyper-link-url="https://databricks.com/blog/2020/08/25/tensorboard-a-new-way-to-use-tensorboard-on-databricks.html" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://databricks.com/blog/2020/08/25/tensorboard-a-new-way-to-use-tensorboard-on-databricks.html" target="_blank" style="color: inherit; text-decoration: inherit;">Databricks blog post</a></block><block> that contains an end-to-end example of using Tensorboard on Databricks.</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 725.5px; height: 268.93px; position: relative;"><img src="image-resources/22dfed1f-3d4f-463e-985a-c2d99cce66a5.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 709px; height: 372px; position: relative;"><img src="image-resources/7825bfc2-355c-4925-b0d8-f4b54f0d33d0.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Go back and click to refresh the Tensorboard! Note that under the </block><block style="font-weight: bold;">histograms</block><block> tab, you will see histograms of </block><block style="font-weight: bold;">kernel</block><block> in each layer; </block><block style="font-weight: bold; background-color: rgb(255, 254, 0);">kernel</block><block style="background-color: rgb(255, 254, 0);"> represents the weights of the neural network</block><block>.</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>If </block><block style="text-decoration: underline;">you are curious about how different initial weight initialization methods</block><block> affect the training of neural networks, you can change the default weight initialization within the first Dense layer of your neural network. </block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>This </block><block class="role-hyper-link" data-hyper-link-url="https://www.tensorflow.org/api_docs/python/tf/keras/initializers" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://www.tensorflow.org/api_docs/python/tf/keras/initializers" target="_blank" style="color: inherit; text-decoration: inherit;">documentation</a></block><block> lists all the types of weight initialization methods that are supported by Tensorflow.</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item full-line-block-inside" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="code-section-symbol inline" style="display: block;"><div class="code-section theme-tomorrow-night" style="display: block; border: 1px solid lightgray; background: rgb(45, 45, 45); padding: 10px; font-size: 12px;"><editarea class="text-mode code-section-edit-area" style="font-family: &quot;Fira code&quot;, &quot;Fira Mono&quot;, monospace;"><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">model </block><block class="operator token">=</block><block class=" token"> Sequential</block><block class="punctuation token">(</block><block class="punctuation token">[</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    Dense</block><block class="punctuation token">(</block><block class="number token">20</block><block class="punctuation token">,</block><block class=" token"> input_dim</block><block class="operator token">=</block><block class="number token">8</block><block class="punctuation token">,</block><block class=" token"> activation</block><block class="operator token">=</block><block class="string token">"relu"</block><block class="punctuation token">,</block><block class=" token"> kernel_initializer</block><block class="operator token">=</block><block class="string token">""</block><block class="punctuation token">)</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    Dense</block><block class="punctuation token">(</block><block class="number token">20</block><block class="punctuation token">,</block><block class=" token"> activation</block><block class="operator token">=</block><block class="string token">"relu"</block><block class="punctuation token">)</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    Dense</block><block class="punctuation token">(</block><block class="number token">1</block><block class="punctuation token">,</block><block class=" token"> activation</block><block class="operator token">=</block><block class="string token">"linear"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="punctuation token">]</block><block class="punctuation token">)</block></blocks></line></editarea></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>If you would like to </block><block style="font-weight: bold;">share your Tensorboard result with your peer</block><block>, you can check out </block><block class="role-hyper-link" data-hyper-link-url="https://tensorboard.dev/" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://tensorboard.dev/" target="_blank" style="color: inherit; text-decoration: inherit;">TensorBoard.dev</a></block><block> (currently in preview) that allows you to share the dashboard. All you need to do is to upload your Tensorboard logs.</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold;">Checkpoints</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Now let's add in our model checkpoint and Tensorboard callbacks to our </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">.fit()</block><block> command.</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Click the </block><block style="font-weight: bold;">refresh</block><block> button on Tensorboard to view the Tensorboard output when the training has completed.</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item full-line-block-inside" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="code-section-symbol inline" style="display: block;"><div class="code-section theme-tomorrow-night" style="display: block; border: 1px solid lightgray; background: rgb(45, 45, 45); padding: 10px; font-size: 12px;"><editarea class="text-mode code-section-edit-area" style="font-family: &quot;Fira code&quot;, &quot;Fira Mono&quot;, monospace;"><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">from</block><block class=" token"> tensorflow</block><block class="punctuation token">.</block><block class=" token">keras</block><block class="punctuation token">.</block><block class=" token">callbacks </block><block class="keyword token">import</block><block class=" token"> TensorBoard</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">### Here, we set histogram_freq=1 so that we can visualize the distribution of a Tensor over time. </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">### It can be helpful to visualize weights and biases and verify that they are changing in an expected way. </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">### Refer to the Tensorboard documentation linked above.</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">tensorboard </block><block class="operator token">=</block><block class=" token"> TensorBoard</block><block class="punctuation token">(</block><block class=" token">log_dir</block><block class="punctuation token">,</block><block class=" token"> histogram_freq</block><block class="operator token">=</block><block class="number token">1</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">history </block><block class="operator token">=</block><block class=" token"> model</block><block class="punctuation token">.</block><block class=" token">fit</block><block class="punctuation token">(</block><block class=" token">X_train</block><block class="punctuation token">,</block><block class=" token"> y_train</block><block class="punctuation token">,</block><block class=" token"> validation_split</block><block class="operator token">=</block><block class="number token">.2</block><block class="punctuation token">,</block><block class=" token"> epochs</block><block class="operator token">=</block><block class="number token">10</block><block class="punctuation token">,</block><block class=" token"> batch_size</block><block class="operator token">=</block><block class="number token">64</block><block class="punctuation token">,</block><block class=" token"> verbose</block><block class="operator token">=</block><block class="number token">2</block><block class="punctuation token">,</block><block class=" token"> callbacks</block><block class="operator token">=</block><block class="punctuation token">[</block><block class=" token">model_checkpoint</block><block class="punctuation token">,</block><block class=" token"> tensorboard</block><block class="punctuation token">]</block><block class="punctuation token">)</block></blocks></line></editarea></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">[</block><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><compositeblock dir="ltr" class="anchor-tag-ref inline" style="font-family: &quot;Computer Modern Serif&quot;, serif; background-color: rgba(155, 155, 155, 0.2);"><a href="#n0.3715415633810799" style="color: inherit; text-decoration: inherit;">Back To Top</a></compositeblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">]</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="inline" style="display: block;"><div style="vertical-align: baseline;"><div style="display: inline-block; height: 0px; border-bottom: 1px solid; width: 100%;"></div></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode section sindent-0" data-line-id="n0.8289655899102821" style="font-size: 1.2em; padding-top: 0.5em; padding-bottom: 0.5em; font-weight: bold; line-height: 1.4;" id="n0.8289655899102821" role="heading" aria-level="1"><prefix style="text-align: left; padding-right: 0.5em;">2. </prefix><blocks><baselineblock class="inline"></baselineblock><block>MLflow</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://mlflow.org/" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://mlflow.org/" target="_blank" style="color: inherit; text-decoration: inherit;">MLflow</a></block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold;">Core machine learning issues</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Keeping track of experiments or model development</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Reproducing code</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Comparing models</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Standardization of packaging and deploying models</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="color: rgb(255, 64, 0); font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold; color: rgb(255, 64, 0);">MLflow addresses these issues.</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 682.392px; height: 340.89px; position: relative;"><img src="image-resources/7f8b7e84-10c5-41c7-a9fd-838c85298390.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 690.592px; height: 353.64px; position: relative;"><img src="image-resources/996a87bf-734d-40fc-95a4-6a9575fba3e3.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold;">The code example below shows how to log metrics from the models using MLflow.</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Log experiments with MLflow</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>View MLflow UI</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Generate a UDF with MLflow and apply to a Spark DataFrame</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold;">Initial setup</block></blocks></line><line class="root text-mode indent-0 has-indent list-item full-line-block-inside" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="code-section-symbol inline" style="display: block;"><div class="code-section theme-tomorrow-night" style="display: block; border: 1px solid lightgray; background: rgb(45, 45, 45); padding: 10px; font-size: 12px;"><editarea class="text-mode code-section-edit-area" style="font-family: &quot;Fira code&quot;, &quot;Fira Mono&quot;, monospace;"><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">import</block><block class=" token"> tensorflow </block><block class="keyword token">as</block><block class=" token"> tf</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">tf</block><block class="punctuation token">.</block><block class=" token">random</block><block class="punctuation token">.</block><block class=" token">set_seed</block><block class="punctuation token">(</block><block class="number token">42</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">train_df </block><block class="operator token">=</block><block class=" token"> spark</block><block class="punctuation token">.</block><block class=" token">read</block><block class="punctuation token">.</block><block class="builtin token">format</block><block class="punctuation token">(</block><block class="string token">"delta"</block><block class="punctuation token">)</block><block class="punctuation token">.</block><block class=" token">load</block><block class="punctuation token">(</block><block class="string-interpolation string token">f"</block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">DA</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">paths</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">datasets</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">/california-housing/train"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">X_train </block><block class="operator token">=</block><block class=" token"> train_df</block><block class="punctuation token">.</block><block class=" token">toPandas</block><block class="punctuation token">(</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">y_train </block><block class="operator token">=</block><block class=" token"> X_train</block><block class="punctuation token">.</block><block class=" token">pop</block><block class="punctuation token">(</block><block class="string token">"label"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">val_df </block><block class="operator token">=</block><block class=" token"> spark</block><block class="punctuation token">.</block><block class=" token">read</block><block class="punctuation token">.</block><block class="builtin token">format</block><block class="punctuation token">(</block><block class="string token">"delta"</block><block class="punctuation token">)</block><block class="punctuation token">.</block><block class=" token">load</block><block class="punctuation token">(</block><block class="string-interpolation string token">f"</block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">DA</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">paths</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">datasets</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">/california-housing/val"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">X_val </block><block class="operator token">=</block><block class=" token"> val_df</block><block class="punctuation token">.</block><block class=" token">toPandas</block><block class="punctuation token">(</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">y_val </block><block class="operator token">=</block><block class=" token"> X_val</block><block class="punctuation token">.</block><block class=" token">pop</block><block class="punctuation token">(</block><block class="string token">"label"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">test_df </block><block class="operator token">=</block><block class=" token"> spark</block><block class="punctuation token">.</block><block class=" token">read</block><block class="punctuation token">.</block><block class="builtin token">format</block><block class="punctuation token">(</block><block class="string token">"delta"</block><block class="punctuation token">)</block><block class="punctuation token">.</block><block class=" token">load</block><block class="punctuation token">(</block><block class="string-interpolation string token">f"</block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">DA</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">paths</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">datasets</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">/california-housing/test"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">X_test </block><block class="operator token">=</block><block class=" token"> test_df</block><block class="punctuation token">.</block><block class=" token">toPandas</block><block class="punctuation token">(</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">y_test </block><block class="operator token">=</block><block class=" token"> X_test</block><block class="punctuation token">.</block><block class=" token">pop</block><block class="punctuation token">(</block><block class="string token">"label"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Build the model</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">from</block><block class=" token"> tensorflow</block><block class="punctuation token">.</block><block class=" token">keras</block><block class="punctuation token">.</block><block class=" token">models </block><block class="keyword token">import</block><block class=" token"> Sequential</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">from</block><block class=" token"> tensorflow</block><block class="punctuation token">.</block><block class=" token">keras</block><block class="punctuation token">.</block><block class=" token">layers </block><block class="keyword token">import</block><block class=" token"> Dense</block><block class="punctuation token">,</block><block class=" token"> Normalization</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">normalize_layer </block><block class="operator token">=</block><block class=" token"> Normalization</block><block class="punctuation token">(</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">normalize_layer</block><block class="punctuation token">.</block><block class=" token">adapt</block><block class="punctuation token">(</block><block class=" token">X_train</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">def</block><block class=" token"> </block><block class="function token">build_model</block><block class="punctuation token">(</block><block class="punctuation token">)</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="keyword token">return</block><block class=" token"> Sequential</block><block class="punctuation token">(</block><block class="punctuation token">[</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        normalize_layer</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        Dense</block><block class="punctuation token">(</block><block class="number token">20</block><block class="punctuation token">,</block><block class=" token"> input_dim</block><block class="operator token">=</block><block class="number token">8</block><block class="punctuation token">,</block><block class=" token"> activation</block><block class="operator token">=</block><block class="string token">"relu"</block><block class="punctuation token">)</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        Dense</block><block class="punctuation token">(</block><block class="number token">20</block><block class="punctuation token">,</block><block class=" token"> activation</block><block class="operator token">=</block><block class="string token">"relu"</block><block class="punctuation token">)</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        Dense</block><block class="punctuation token">(</block><block class="number token">1</block><block class="punctuation token">,</block><block class=" token"> activation</block><block class="operator token">=</block><block class="string token">"linear"</block><block class="punctuation token">)</block><block class="punctuation token">]</block><block class="punctuation token">)</block><block class=" token"> </block><block class="comment token"># Keep the last layer as linear because this is a regression problem</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Plot training loss</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">import</block><block class=" token"> matplotlib</block><block class="punctuation token">.</block><block class=" token">pyplot </block><block class="keyword token">as</block><block class=" token"> plt</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">def</block><block class=" token"> </block><block class="function token">view_model_loss</block><block class="punctuation token">(</block><block class=" token">history</block><block class="punctuation token">)</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    plt</block><block class="punctuation token">.</block><block class=" token">clf</block><block class="punctuation token">(</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    plt</block><block class="punctuation token">.</block><block class=" token">plot</block><block class="punctuation token">(</block><block class=" token">history</block><block class="punctuation token">.</block><block class=" token">history</block><block class="punctuation token">[</block><block class="string token">"loss"</block><block class="punctuation token">]</block><block class="punctuation token">,</block><block class=" token"> label</block><block class="operator token">=</block><block class="string token">"train_loss"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="keyword token">if</block><block class=" token"> </block><block class="string token">"val_loss"</block><block class=" token"> </block><block class="keyword token">in</block><block class=" token"> history</block><block class="punctuation token">.</block><block class=" token">history</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        plt</block><block class="punctuation token">.</block><block class=" token">plot</block><block class="punctuation token">(</block><block class=" token">history</block><block class="punctuation token">.</block><block class=" token">history</block><block class="punctuation token">[</block><block class="string token">"val_loss"</block><block class="punctuation token">]</block><block class="punctuation token">,</block><block class=" token"> label</block><block class="operator token">=</block><block class="string token">"val_loss"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    plt</block><block class="punctuation token">.</block><block class=" token">title</block><block class="punctuation token">(</block><block class="string token">"Model Loss"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    plt</block><block class="punctuation token">.</block><block class=" token">ylabel</block><block class="punctuation token">(</block><block class="string token">"Loss"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    plt</block><block class="punctuation token">.</block><block class=" token">xlabel</block><block class="punctuation token">(</block><block class="string token">"Epoch"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    plt</block><block class="punctuation token">.</block><block class=" token">legend</block><block class="punctuation token">(</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="keyword token">return</block><block class=" token"> plt</block></blocks></line></editarea></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">[</block><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><compositeblock dir="ltr" class="anchor-tag-ref inline" style="font-family: &quot;Computer Modern Serif&quot;, serif; background-color: rgba(155, 155, 155, 0.2);"><a href="#n0.3715415633810799" style="color: inherit; text-decoration: inherit;">Back To Top</a></compositeblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">]</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode section sindent-1" data-line-id="n0.9218669531443409" style="font-size: 1.1em; padding-top: 0.5em; padding-bottom: 0.5em; font-weight: bold; line-height: 1.4;" id="n0.9218669531443409" role="heading" aria-level="2"><prefix style="text-align: left; padding-right: 0.25em;">2.1. </prefix><blocks><baselineblock class="inline"></baselineblock><block>Track Experiments</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>When tracking an experiment, you can use </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">mlflow.set_experiment()</block><block> to set an experiment, </block><block style="text-decoration: underline;">but if you do not specify an experiment, it will automatically be scoped to this notebook</block><block>.</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Additionally, when training a model you can log to MLflow using </block><block class="role-hyper-link" data-hyper-link-url="https://docs.databricks.com/applications/mlflow/databricks-autologging.html" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://docs.databricks.com/applications/mlflow/databricks-autologging.html" target="_blank" style="color: inherit; text-decoration: inherit;">autologging</a></block><block>. </block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold; color: rgb(255, 64, 0);">Autologging</block><block> allows you to log metrics, parameters, and models without the need for explicit log statements.</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold;">There are a few ways to use autologging:</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;">1. </prefix><blocks><baselineblock class="inline"></baselineblock><block>Call </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">mlflow.autolog()</block><block> before your training code. This will enable autologging for each supported library you have installed as soon as you import it.</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;">2. </prefix><blocks><baselineblock class="inline"></baselineblock><block>Enable autologging at the workspace level from the admin console.</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;">3. </prefix><blocks><baselineblock class="inline"></baselineblock><block>Use library-specific autolog calls for each library you use in your code. (e.g. </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">mlflow.tensorflow.autolog()</block><block>)</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold;">Here we are only using numeric features for simplicity of building the random forest.</block></blocks></line><line class="root text-mode indent-0 has-indent list-item full-line-block-inside" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="code-section-symbol inline" style="display: block;"><div class="code-section theme-tomorrow-night" style="display: block; border: 1px solid lightgray; background: rgb(45, 45, 45); padding: 10px; font-size: 12px;"><editarea class="text-mode code-section-edit-area" style="font-family: &quot;Fira code&quot;, &quot;Fira Mono&quot;, monospace;"><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">import</block><block class=" token"> mlflow</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Note issue with **kwargs https://github.com/keras-team/keras/issues/9805</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">def</block><block class=" token"> </block><block class="function token">track_experiments</block><block class="punctuation token">(</block><block class=" token">run_name</block><block class="punctuation token">,</block><block class=" token"> model</block><block class="punctuation token">,</block><block class=" token"> compile_kwargs</block><block class="punctuation token">,</block><block class=" token"> fit_kwargs</block><block class="punctuation token">,</block><block class=" token"> optional_params</block><block class="operator token">=</block><block class="punctuation token">{</block><block class="punctuation token">}</block><block class="punctuation token">)</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="keyword token">with</block><block class=" token"> mlflow</block><block class="punctuation token">.</block><block class=" token">start_run</block><block class="punctuation token">(</block><block class=" token">run_name</block><block class="operator token">=</block><block class=" token">run_name</block><block class="punctuation token">)</block><block class=" token"> </block><block class="keyword token">as</block><block class=" token"> run</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block><block class="comment token"># Enable autologging - need to put in the with statement to keep the run id</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        mlflow</block><block class="punctuation token">.</block><block class=" token">tensorflow</block><block class="punctuation token">.</block><block class=" token">autolog</block><block class="punctuation token">(</block><block class=" token">log_models</block><block class="operator token">=</block><block class="boolean token">True</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        model </block><block class="operator token">=</block><block class=" token"> model</block><block class="punctuation token">(</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        model</block><block class="punctuation token">.</block><block class="builtin token">compile</block><block class="punctuation token">(</block><block class="operator token">**</block><block class=" token">compile_kwargs</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        history </block><block class="operator token">=</block><block class=" token"> model</block><block class="punctuation token">.</block><block class=" token">fit</block><block class="punctuation token">(</block><block class="operator token">**</block><block class=" token">fit_kwargs</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">            </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block><block class="comment token"># Log optional params </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        mlflow</block><block class="punctuation token">.</block><block class=" token">log_params</block><block class="punctuation token">(</block><block class=" token">optional_params</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        plt </block><block class="operator token">=</block><block class=" token"> view_model_loss</block><block class="punctuation token">(</block><block class=" token">history</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        fig </block><block class="operator token">=</block><block class=" token"> plt</block><block class="punctuation token">.</block><block class=" token">gcf</block><block class="punctuation token">(</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        mlflow</block><block class="punctuation token">.</block><block class=" token">log_figure</block><block class="punctuation token">(</block><block class=" token">fig</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"train-validation-loss.png"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block><block class="keyword token">return</block><block class=" token"> run</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">compile_kwargs </block><block class="operator token">=</block><block class=" token"> </block><block class="punctuation token">{</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="string token">"optimizer"</block><block class="punctuation token">:</block><block class=" token"> </block><block class="string token">"adam"</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="string token">"loss"</block><block class="punctuation token">:</block><block class=" token"> </block><block class="string token">"mse"</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="string token">"metrics"</block><block class="punctuation token">:</block><block class=" token"> </block><block class="punctuation token">[</block><block class="string token">"mse"</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"mae"</block><block class="punctuation token">]</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="punctuation token">}</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">fit_kwargs </block><block class="operator token">=</block><block class=" token"> </block><block class="punctuation token">{</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="string token">"x"</block><block class="punctuation token">:</block><block class=" token"> X_train</block><block class="punctuation token">,</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="string token">"y"</block><block class="punctuation token">:</block><block class=" token"> y_train</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="string token">"epochs"</block><block class="punctuation token">:</block><block class=" token"> </block><block class="number token">10</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="string token">"verbose"</block><block class="punctuation token">:</block><block class=" token"> </block><block class="number token">2</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="string token">"batch_size"</block><block class="punctuation token">:</block><block class=" token"> </block><block class="number token">64</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="punctuation token">}</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">optional_params </block><block class="operator token">=</block><block class=" token"> </block><block class="punctuation token">{</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="string token">"standardize_data"</block><block class="punctuation token">:</block><block class=" token"> </block><block class="string token">"true"</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="punctuation token">}</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">run_name </block><block class="operator token">=</block><block class=" token"> </block><block class="string token">"adam"</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">run </block><block class="operator token">=</block><block class=" token"> track_experiments</block><block class="punctuation token">(</block><block class=" token">run_name</block><block class="punctuation token">,</block><block class=" token"> build_model</block><block class="punctuation token">,</block><block class=" token"> compile_kwargs</block><block class="punctuation token">,</block><block class=" token"> fit_kwargs</block><block class="punctuation token">,</block><block class=" token"> optional_params</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Now, let's include a validation set</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">val_type </block><block class="operator token">=</block><block class=" token"> </block><block class="string token">"data"</block><block class=" token"> </block><block class="comment token"># data -&gt; use curated dataset with X_val, y_val | split -&gt; split the training dataset using validation_split</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">if</block><block class=" token"> val_type</block><block class="operator token">==</block><block class="string token">"split"</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    fit_kwargs</block><block class="punctuation token">[</block><block class="string token">"validation_split"</block><block class="punctuation token">]</block><block class=" token"> </block><block class="operator token">=</block><block class=" token"> </block><block class="number token">0.2</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">if</block><block class=" token"> val_type</block><block class="operator token">==</block><block class="string token">"data"</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    fit_kwargs</block><block class="punctuation token">[</block><block class="string token">"validation_data"</block><block class="punctuation token">]</block><block class="operator token">=</block><block class="punctuation token">(</block><block class=" token">X_val</block><block class="punctuation token">,</block><block class=" token"> y_val</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">optional_params </block><block class="operator token">=</block><block class=" token"> </block><block class="punctuation token">{</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="string token">"standardize_data"</block><block class="punctuation token">:</block><block class=" token"> </block><block class="string token">"true"</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="punctuation token">}</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">run_name </block><block class="operator token">=</block><block class=" token"> </block><block class="string token">"adam_with_validation"</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">run </block><block class="operator token">=</block><block class=" token"> track_experiments</block><block class="punctuation token">(</block><block class=" token">run_name</block><block class="punctuation token">,</block><block class=" token"> build_model</block><block class="punctuation token">,</block><block class=" token"> compile_kwargs</block><block class="punctuation token">,</block><block class=" token"> fit_kwargs</block><block class="punctuation token">,</block><block class=" token"> optional_params</block><block class="punctuation token">)</block></blocks></line></editarea></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode section sindent-1" data-line-id="n0.45963766848042265" style="font-size: 1.1em; padding-top: 0.5em; padding-bottom: 0.5em; font-weight: bold; line-height: 1.4;" id="n0.45963766848042265" role="heading" aria-level="2"><prefix style="text-align: left; padding-right: 0.25em;">2.2. </prefix><blocks><baselineblock class="inline"></baselineblock><block>Querying Past Runs</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>You can query past runs programmatically in order to use this data back in Python. </block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>The pathway to doing this is an </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">MlflowClient</block><block> object. You can use search_runs to find all runs for a given experiment.</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item full-line-block-inside" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="code-section-symbol inline" style="display: block;"><div class="code-section theme-tomorrow-night" style="display: block; border: 1px solid lightgray; background: rgb(45, 45, 45); padding: 10px; font-size: 12px;"><editarea class="text-mode code-section-edit-area" style="font-family: &quot;Fira code&quot;, &quot;Fira Mono&quot;, monospace;"><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">from</block><block class=" token"> mlflow</block><block class="punctuation token">.</block><block class=" token">tracking </block><block class="keyword token">import</block><block class=" token"> MlflowClient</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">client </block><block class="operator token">=</block><block class=" token"> MlflowClient</block><block class="punctuation token">(</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">runs_df </block><block class="operator token">=</block><block class=" token"> mlflow</block><block class="punctuation token">.</block><block class=" token">search_runs</block><block class="punctuation token">(</block><block class=" token">run</block><block class="punctuation token">.</block><block class=" token">info</block><block class="punctuation token">.</block><block class=" token">experiment_id</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">display</block><block class="punctuation token">(</block><block class=" token">runs_df</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Pull the last run and check out the metrics</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">runs </block><block class="operator token">=</block><block class=" token"> client</block><block class="punctuation token">.</block><block class=" token">search_runs</block><block class="punctuation token">(</block><block class=" token">run</block><block class="punctuation token">.</block><block class=" token">info</block><block class="punctuation token">.</block><block class=" token">experiment_id</block><block class="punctuation token">,</block><block class=" token"> order_by</block><block class="operator token">=</block><block class="punctuation token">[</block><block class="string token">"attributes.start_time desc"</block><block class="punctuation token">]</block><block class="punctuation token">,</block><block class=" token"> max_results</block><block class="operator token">=</block><block class="number token">1</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">runs</block><block class="punctuation token">[</block><block class="number token">0</block><block class="punctuation token">]</block><block class="punctuation token">.</block><block class=" token">data</block><block class="punctuation token">.</block><block class=" token">metrics</block></blocks></line></editarea></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode section sindent-1" data-line-id="n0.12718286624225938" style="font-size: 1.1em; padding-top: 0.5em; padding-bottom: 0.5em; font-weight: bold; line-height: 1.4;" id="n0.12718286624225938" role="heading" aria-level="2"><prefix style="text-align: left; padding-right: 0.25em;">2.3. </prefix><blocks><baselineblock class="inline"></baselineblock><block>User Defined Function</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Let's now register our Keras model as a </block><block class="role-hyper-link" data-hyper-link-url="https://www.mlflow.org/docs/latest/python_api/mlflow.pyfunc.html#module-mlflow.pyfunc" style="text-decoration: underline; font-weight: bold; color: rgb(17, 85, 204);"><a href="https://www.mlflow.org/docs/latest/python_api/mlflow.pyfunc.html#module-mlflow.pyfunc" target="_blank" style="color: inherit; text-decoration: inherit;">Spark UDF</a></block><block> to apply to rows in parallel.</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item full-line-block-inside" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="code-section-symbol inline" style="display: block;"><div class="code-section theme-tomorrow-night" style="display: block; border: 1px solid lightgray; background: rgb(45, 45, 45); padding: 10px; font-size: 12px;"><editarea class="text-mode code-section-edit-area" style="font-family: &quot;Fira code&quot;, &quot;Fira Mono&quot;, monospace;"><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">import</block><block class=" token"> pandas </block><block class="keyword token">as</block><block class=" token"> pd</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">predict </block><block class="operator token">=</block><block class=" token"> mlflow</block><block class="punctuation token">.</block><block class=" token">pyfunc</block><block class="punctuation token">.</block><block class=" token">spark_udf</block><block class="punctuation token">(</block><block class=" token">spark</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string-interpolation string token">f"runs:/</block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">runs</block><block class="string-interpolation interpolation punctuation token">[</block><block class="string-interpolation interpolation number token">0</block><block class="string-interpolation interpolation punctuation token">]</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">info</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">run_id</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">/model"</block><block class="punctuation token">)</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">X_test_df </block><block class="operator token">=</block><block class=" token"> spark</block><block class="punctuation token">.</block><block class=" token">createDataFrame</block><block class="punctuation token">(</block><block class=" token">pd</block><block class="punctuation token">.</block><block class=" token">concat</block><block class="punctuation token">(</block><block class="punctuation token">[</block><block class=" token">pd</block><block class="punctuation token">.</block><block class=" token">DataFrame</block><block class="punctuation token">(</block><block class=" token">X_test</block><block class="punctuation token">,</block><block class=" token"> columns</block><block class="operator token">=</block><block class=" token">X_test</block><block class="punctuation token">.</block><block class=" token">columns</block><block class="punctuation token">)</block><block class="punctuation token">,</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                                             pd</block><block class="punctuation token">.</block><block class=" token">DataFrame</block><block class="punctuation token">(</block><block class=" token">y_test</block><block class="punctuation token">,</block><block class=" token"> columns</block><block class="operator token">=</block><block class="punctuation token">[</block><block class="string token">"label"</block><block class="punctuation token">]</block><block class="punctuation token">)</block><block class="punctuation token">]</block><block class="punctuation token">,</block><block class=" token"> axis</block><block class="operator token">=</block><block class="number token">1</block><block class="punctuation token">)</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">display</block><block class="punctuation token">(</block><block class=" token">X_test_df</block><block class="punctuation token">.</block><block class=" token">withColumn</block><block class="punctuation token">(</block><block class="string token">"prediction"</block><block class="punctuation token">,</block><block class=" token"> predict</block><block class="punctuation token">(</block><block class="operator token">*</block><block class=" token">X_test</block><block class="punctuation token">.</block><block class=" token">columns</block><block class="punctuation token">)</block><block class="punctuation token">)</block><block class="punctuation token">)</block></blocks></line></editarea></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Register the </block><block style="font-weight: bold; color: rgb(255, 64, 0);">Vectorized UDF</block><block> </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif;">predict</block><block> into the SQL namespace.</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item full-line-block-inside" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="code-section-symbol inline" style="display: block;"><div class="code-section theme-tomorrow-night" style="display: block; border: 1px solid lightgray; background: rgb(45, 45, 45); padding: 10px; font-size: 12px;"><editarea class="text-mode code-section-edit-area" style="font-family: &quot;Fira code&quot;, &quot;Fira Mono&quot;, monospace;"><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">spark</block><block class="punctuation token">.</block><block class=" token">udf</block><block class="punctuation token">.</block><block class=" token">register</block><block class="punctuation token">(</block><block class="string token">"predictUDF"</block><block class="punctuation token">,</block><block class=" token"> predict</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">X_test_df</block><block class="punctuation token">.</block><block class=" token">createOrReplaceGlobalTempView</block><block class="punctuation token">(</block><block class="string token">"X_test_df"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="operator token">%</block><block class=" token">sql </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">SELECT </block><block class="operator token">*</block><block class="punctuation token">,</block><block class=" token"> predictUDF</block><block class="punctuation token">(</block><block class=" token">MedInc</block><block class="punctuation token">,</block><block class=" token"> HouseAge</block><block class="punctuation token">,</block><block class=" token"> AveRooms</block><block class="punctuation token">,</block><block class=" token"> AveBedrms</block><block class="punctuation token">,</block><block class=" token"> Population</block><block class="punctuation token">,</block><block class=" token"> AveOccup</block><block class="punctuation token">,</block><block class=" token"> Latitude</block><block class="punctuation token">,</block><block class=" token"> Longitude</block><block class="punctuation token">)</block><block class=" token"> AS prediction </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">FROM global_temp</block><block class="punctuation token">.</block><block class=" token">X_test_df</block></blocks></line></editarea></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">[</block><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><compositeblock dir="ltr" class="anchor-tag-ref inline" style="font-family: &quot;Computer Modern Serif&quot;, serif; background-color: rgba(155, 155, 155, 0.2);"><a href="#n0.3715415633810799" style="color: inherit; text-decoration: inherit;">Back To Top</a></compositeblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">]</block></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="inline" style="display: block;"><div style="vertical-align: baseline;"><div style="display: inline-block; height: 0px; border-bottom: 1px solid; width: 100%;"></div></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode section sindent-0" data-line-id="n0.9453509797763815" style="font-size: 1.2em; padding-top: 0.5em; padding-bottom: 0.5em; font-weight: bold; line-height: 1.4;" id="n0.9453509797763815" role="heading" aria-level="1"><prefix style="text-align: left; padding-right: 0.5em;">3. </prefix><blocks><baselineblock class="inline"></baselineblock><block>Hyperparameter Tuning</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold; background-color: rgb(255, 254, 0);">Problems with grid search</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Exhaustive enumeration is expensive</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Manually determined search space</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Past information on good hyperparameters isn't used</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold;">So what do you do if ...</block></blocks></line><line class="root text-mode indent-2 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="3"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;">* </prefix><blocks><baselineblock class="inline"></baselineblock><block>You have a training budget</block></blocks></line><line class="root text-mode indent-2 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="3"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;">* </prefix><blocks><baselineblock class="inline"></baselineblock><block>You have many hyperparameters to tune</block></blocks></line><line class="root text-mode indent-2 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="3"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;">* </prefix><blocks><baselineblock class="inline"></baselineblock><block>You want to pick your hyperparameters based on past results</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 614.392px; height: 290.55px; position: relative;"><img src="image-resources/64a60377-8e4c-4ebb-ba1e-15fe7884f904.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode section sindent-1" data-line-id="n0.8806885533063584" style="font-size: 1.1em; padding-top: 0.5em; padding-bottom: 0.5em; font-weight: bold; line-height: 1.4;" id="n0.8806885533063584" role="heading" aria-level="2"><prefix style="text-align: left; padding-right: 0.25em;">3.1. </prefix><blocks><baselineblock class="inline"></baselineblock><block>Hyperopt</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Open-source Python </block><block class="role-hyper-link" data-hyper-link-url="https://github.com/hyperopt/hyperopt" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://github.com/hyperopt/hyperopt" target="_blank" style="color: inherit; text-decoration: inherit;">library</a></block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://hyperopt.github.io/hyperopt/" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://hyperopt.github.io/hyperopt/" target="_blank" style="color: inherit; text-decoration: inherit;">Hyperopt documentation</a></block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Optimization over awkward search spaces</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Serial</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Parallel</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Spark integration</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Core algorithms for optimization:</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="color: rgb(255, 64, 0); font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold; color: rgb(255, 64, 0);">Random Search</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="color: rgb(255, 64, 0); font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://optunity.readthedocs.io/en/latest/user/solvers/TPE.html" style="text-decoration: underline; font-weight: bold; color: rgb(255, 64, 0);"><a href="https://optunity.readthedocs.io/en/latest/user/solvers/TPE.html" target="_blank" style="color: inherit; text-decoration: inherit;">Adaptive Tree of Parzen Estimators (TPE)</a></block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>With MLflow, we can record the hyperparameters and corresponding metrics for each hyperparameter combination. </block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Read more on </block><block class="role-hyper-link" data-hyper-link-url="https://github.com/hyperopt/hyperopt/blob/master/docs/templates/scaleout/spark.md" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://github.com/hyperopt/hyperopt/blob/master/docs/templates/scaleout/spark.md" target="_blank" style="color: inherit; text-decoration: inherit;">SparkTrials with Hyperopt</a></block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item full-line-block-inside" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="code-section-symbol inline" style="display: block;"><div class="code-section theme-tomorrow-night" style="display: block; border: 1px solid lightgray; background: rgb(45, 45, 45); padding: 10px; font-size: 12px;"><editarea class="text-mode code-section-edit-area" style="font-family: &quot;Fira code&quot;, &quot;Fira Mono&quot;, monospace;"><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">train_df </block><block class="operator token">=</block><block class=" token"> spark</block><block class="punctuation token">.</block><block class=" token">read</block><block class="punctuation token">.</block><block class="builtin token">format</block><block class="punctuation token">(</block><block class="string token">"delta"</block><block class="punctuation token">)</block><block class="punctuation token">.</block><block class=" token">load</block><block class="punctuation token">(</block><block class="string-interpolation string token">f"</block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">DA</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">paths</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">datasets</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">/california-housing/train"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">X_train </block><block class="operator token">=</block><block class=" token"> train_df</block><block class="punctuation token">.</block><block class=" token">toPandas</block><block class="punctuation token">(</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">y_train </block><block class="operator token">=</block><block class=" token"> X_train</block><block class="punctuation token">.</block><block class=" token">pop</block><block class="punctuation token">(</block><block class="string token">"label"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">val_df </block><block class="operator token">=</block><block class=" token"> spark</block><block class="punctuation token">.</block><block class=" token">read</block><block class="punctuation token">.</block><block class="builtin token">format</block><block class="punctuation token">(</block><block class="string token">"delta"</block><block class="punctuation token">)</block><block class="punctuation token">.</block><block class=" token">load</block><block class="punctuation token">(</block><block class="string-interpolation string token">f"</block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">DA</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">paths</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">datasets</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">/california-housing/val"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">X_val </block><block class="operator token">=</block><block class=" token"> val_df</block><block class="punctuation token">.</block><block class=" token">toPandas</block><block class="punctuation token">(</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">y_val </block><block class="operator token">=</block><block class=" token"> X_val</block><block class="punctuation token">.</block><block class=" token">pop</block><block class="punctuation token">(</block><block class="string token">"label"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">test_df </block><block class="operator token">=</block><block class=" token"> spark</block><block class="punctuation token">.</block><block class=" token">read</block><block class="punctuation token">.</block><block class="builtin token">format</block><block class="punctuation token">(</block><block class="string token">"delta"</block><block class="punctuation token">)</block><block class="punctuation token">.</block><block class=" token">load</block><block class="punctuation token">(</block><block class="string-interpolation string token">f"</block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">DA</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">paths</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">datasets</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">/california-housing/test"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">X_test </block><block class="operator token">=</block><block class=" token"> test_df</block><block class="punctuation token">.</block><block class=" token">toPandas</block><block class="punctuation token">(</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">y_test </block><block class="operator token">=</block><block class=" token"> X_test</block><block class="punctuation token">.</block><block class=" token">pop</block><block class="punctuation token">(</block><block class="string token">"label"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Build the Keras model</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">import</block><block class=" token"> tensorflow </block><block class="keyword token">as</block><block class=" token"> tf</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">from</block><block class=" token"> tensorflow</block><block class="punctuation token">.</block><block class=" token">keras</block><block class="punctuation token">.</block><block class=" token">layers </block><block class="keyword token">import</block><block class=" token"> Dense</block><block class="punctuation token">,</block><block class=" token"> Normalization</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">from</block><block class=" token"> tensorflow</block><block class="punctuation token">.</block><block class=" token">keras</block><block class="punctuation token">.</block><block class=" token">models </block><block class="keyword token">import</block><block class=" token"> Sequential</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">tf</block><block class="punctuation token">.</block><block class=" token">random</block><block class="punctuation token">.</block><block class=" token">set_seed</block><block class="punctuation token">(</block><block class="number token">42</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">def</block><block class=" token"> </block><block class="function token">create_model</block><block class="punctuation token">(</block><block class=" token">hpo</block><block class="punctuation token">)</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    normalize_layer </block><block class="operator token">=</block><block class=" token"> Normalization</block><block class="punctuation token">(</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    normalize_layer</block><block class="punctuation token">.</block><block class=" token">adapt</block><block class="punctuation token">(</block><block class=" token">X_train</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    model </block><block class="operator token">=</block><block class=" token"> Sequential</block><block class="punctuation token">(</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    model</block><block class="punctuation token">.</block><block class=" token">add</block><block class="punctuation token">(</block><block class=" token">normalize_layer</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    model</block><block class="punctuation token">.</block><block class=" token">add</block><block class="punctuation token">(</block><block class=" token">Dense</block><block class="punctuation token">(</block><block class="builtin token">int</block><block class="punctuation token">(</block><block class=" token">hpo</block><block class="punctuation token">[</block><block class="string token">"dense_l1"</block><block class="punctuation token">]</block><block class="punctuation token">)</block><block class="punctuation token">,</block><block class=" token"> input_dim</block><block class="operator token">=</block><block class="number token">8</block><block class="punctuation token">,</block><block class=" token"> activation</block><block class="operator token">=</block><block class="string token">"relu"</block><block class="punctuation token">)</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    model</block><block class="punctuation token">.</block><block class=" token">add</block><block class="punctuation token">(</block><block class=" token">Dense</block><block class="punctuation token">(</block><block class="builtin token">int</block><block class="punctuation token">(</block><block class=" token">hpo</block><block class="punctuation token">[</block><block class="string token">"dense_l2"</block><block class="punctuation token">]</block><block class="punctuation token">)</block><block class="punctuation token">,</block><block class=" token"> activation</block><block class="operator token">=</block><block class="string token">"relu"</block><block class="punctuation token">)</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    model</block><block class="punctuation token">.</block><block class=" token">add</block><block class="punctuation token">(</block><block class=" token">Dense</block><block class="punctuation token">(</block><block class="number token">1</block><block class="punctuation token">,</block><block class=" token"> activation</block><block class="operator token">=</block><block class="string token">"linear"</block><block class="punctuation token">)</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="keyword token">return</block><block class=" token"> model</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Hyperparameter tuning</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">from</block><block class=" token"> hyperopt </block><block class="keyword token">import</block><block class=" token"> fmin</block><block class="punctuation token">,</block><block class=" token"> hp</block><block class="punctuation token">,</block><block class=" token"> tpe</block><block class="punctuation token">,</block><block class=" token"> SparkTrials</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">def</block><block class=" token"> </block><block class="function token">run_nn</block><block class="punctuation token">(</block><block class=" token">hpo</block><block class="punctuation token">)</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    model </block><block class="operator token">=</block><block class=" token"> create_model</block><block class="punctuation token">(</block><block class=" token">hpo</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="comment token"># Select Optimizer</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    optimizer_call </block><block class="operator token">=</block><block class=" token"> </block><block class="builtin token">getattr</block><block class="punctuation token">(</block><block class=" token">tf</block><block class="punctuation token">.</block><block class=" token">keras</block><block class="punctuation token">.</block><block class=" token">optimizers</block><block class="punctuation token">,</block><block class=" token"> hpo</block><block class="punctuation token">[</block><block class="string token">"optimizer"</block><block class="punctuation token">]</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    optimizer </block><block class="operator token">=</block><block class=" token"> optimizer_call</block><block class="punctuation token">(</block><block class=" token">learning_rate</block><block class="operator token">=</block><block class=" token">hpo</block><block class="punctuation token">[</block><block class="string token">"learning_rate"</block><block class="punctuation token">]</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="comment token"># Compile model</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    model</block><block class="punctuation token">.</block><block class="builtin token">compile</block><block class="punctuation token">(</block><block class=" token">loss</block><block class="operator token">=</block><block class="string token">"mse"</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                  optimizer</block><block class="operator token">=</block><block class=" token">optimizer</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                  metrics</block><block class="operator token">=</block><block class="punctuation token">[</block><block class="string token">"mse"</block><block class="punctuation token">]</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    history </block><block class="operator token">=</block><block class=" token"> model</block><block class="punctuation token">.</block><block class=" token">fit</block><block class="punctuation token">(</block><block class=" token">X_train</block><block class="punctuation token">,</block><block class=" token"> y_train</block><block class="punctuation token">,</block><block class=" token"> validation_data</block><block class="operator token">=</block><block class="punctuation token">[</block><block class=" token">X_val</block><block class="punctuation token">,</block><block class=" token">y_val</block><block class="punctuation token">]</block><block class="punctuation token">,</block><block class=" token"> batch_size</block><block class="operator token">=</block><block class="number token">64</block><block class="punctuation token">,</block><block class=" token"> epochs</block><block class="operator token">=</block><block class="number token">10</block><block class="punctuation token">,</block><block class=" token"> verbose</block><block class="operator token">=</block><block class="number token">2</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="comment token"># Evaluate our model</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    obj_metric </block><block class="operator token">=</block><block class=" token"> history</block><block class="punctuation token">.</block><block class=" token">history</block><block class="punctuation token">[</block><block class="string token">"val_loss"</block><block class="punctuation token">]</block><block class="punctuation token">[</block><block class="operator token">-</block><block class="number token">1</block><block class="punctuation token">]</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="keyword token">return</block><block class=" token"> obj_metric</block></blocks></line></editarea></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode section sindent-2" data-line-id="n0.8500132802508897" style="font-size: 1em; padding-top: 0.5em; padding-bottom: 0.5em; font-weight: bold; line-height: 1.4;" id="n0.8500132802508897" role="heading" aria-level="3"><prefix style="text-align: left; padding-right: 0em;">3.1.1. </prefix><blocks><baselineblock class="inline"></baselineblock><block>Set up Hyperparameter Space and Training</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>We need to create a search space for </block><block style="font-style: italic;">Hyperopt</block><block> and set up </block><block style="font-style: italic;">SparkTrials</block><block> to allow Hyperopt to run in parallel using Spark worker nodes. </block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="text-decoration: underline;">MLflow will automatically track the results of Hyperopt's tuning trials</block><block>.</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item full-line-block-inside" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="code-section-symbol inline" style="display: block;"><div class="code-section theme-tomorrow-night" style="display: block; border: 1px solid lightgray; background: rgb(45, 45, 45); padding: 10px; font-size: 12px;"><editarea class="text-mode code-section-edit-area" style="font-family: &quot;Fira code&quot;, &quot;Fira Mono&quot;, monospace;"><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">space </block><block class="operator token">=</block><block class=" token"> </block><block class="punctuation token">{</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="string token">"dense_l1"</block><block class="punctuation token">:</block><block class=" token"> hp</block><block class="punctuation token">.</block><block class=" token">quniform</block><block class="punctuation token">(</block><block class="string token">"dense_l1"</block><block class="punctuation token">,</block><block class=" token"> </block><block class="number token">10</block><block class="punctuation token">,</block><block class=" token"> </block><block class="number token">30</block><block class="punctuation token">,</block><block class=" token"> </block><block class="number token">1</block><block class="punctuation token">)</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="string token">"dense_l2"</block><block class="punctuation token">:</block><block class=" token"> hp</block><block class="punctuation token">.</block><block class=" token">quniform</block><block class="punctuation token">(</block><block class="string token">"dense_l2"</block><block class="punctuation token">,</block><block class=" token"> </block><block class="number token">10</block><block class="punctuation token">,</block><block class=" token"> </block><block class="number token">30</block><block class="punctuation token">,</block><block class=" token"> </block><block class="number token">1</block><block class="punctuation token">)</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="string token">"learning_rate"</block><block class="punctuation token">:</block><block class=" token"> hp</block><block class="punctuation token">.</block><block class=" token">loguniform</block><block class="punctuation token">(</block><block class="string token">"learning_rate"</block><block class="punctuation token">,</block><block class=" token"> </block><block class="operator token">-</block><block class="number token">5</block><block class="punctuation token">,</block><block class=" token"> </block><block class="number token">0</block><block class="punctuation token">)</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="string token">"optimizer"</block><block class="punctuation token">:</block><block class=" token"> hp</block><block class="punctuation token">.</block><block class=" token">choice</block><block class="punctuation token">(</block><block class="string token">"optimizer"</block><block class="punctuation token">,</block><block class=" token"> </block><block class="punctuation token">[</block><block class="string token">"Adadelta"</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"Adam"</block><block class="punctuation token">]</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token"> </block><block class="punctuation token">}</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">spark_trials </block><block class="operator token">=</block><block class=" token"> SparkTrials</block><block class="punctuation token">(</block><block class=" token">parallelism</block><block class="operator token">=</block><block class="number token">4</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">best_hyperparam </block><block class="operator token">=</block><block class=" token"> fmin</block><block class="punctuation token">(</block><block class=" token">fn</block><block class="operator token">=</block><block class=" token">run_nn</block><block class="punctuation token">,</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                       space</block><block class="operator token">=</block><block class=" token">space</block><block class="punctuation token">,</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                       algo</block><block class="operator token">=</block><block class=" token">tpe</block><block class="punctuation token">.</block><block class=" token">suggest</block><block class="punctuation token">,</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                       max_evals</block><block class="operator token">=</block><block class="number token">16</block><block class="punctuation token">,</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                       trials</block><block class="operator token">=</block><block class=" token">spark_trials</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                       rstate</block><block class="operator token">=</block><block class=" token">np</block><block class="punctuation token">.</block><block class=" token">random</block><block class="punctuation token">.</block><block class=" token">default_rng</block><block class="punctuation token">(</block><block class="number token">42</block><block class="punctuation token">)</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">best_hyperparam</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Hyperopt with SparkTrials will automatically track trials in MLflow. To view the MLflow experiment associated with the notebook, click the 'Runs' icon in the notebook context bar on the upper right. There, you can view all runs.</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># To view logs from trials, please check the Spark executor logs. To view executor logs, expand 'Spark Jobs' above until you see the (i) icon next to the stage from the trial job. Click it and find the list of tasks. Click the 'stderr' link for a task to view trial logs.</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># 100%|| 16/16 [01:22&lt;00:00,  5.16s/trial, best loss: 0.2984829545021057]</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Total Trials: 16: 16 succeeded, 0 failed, 0 cancelled.</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Out[8]: {'dense_l1': 24.0,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  'dense_l2': 19.0,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  'learning_rate': 0.015072559245413342,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  'optimizer': 1}</block></blocks></line></editarea></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>To view the MLflow experiment associated with the notebook, click the </block><block style="font-weight: bold;">MLflow API</block><block> icon on the top context menu, next to the "Run all" button. A new menu will open on the right where you can click on each run, or open the experiment UI.</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>To understand the effect of tuning a hyperparameter:</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Select the resulting runs and click </block><block style="font-style: italic;">Compare</block><block>.</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>In the Scatter Plot, select a hyperparameter for the X-axis and loss for the Y-axis.</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>With these new/best parameters, you have the best parameters within this search space, and can build, track, and log a new MLflow model with these values!</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">[</block><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><compositeblock dir="ltr" class="anchor-tag-ref inline" style="font-family: &quot;Computer Modern Serif&quot;, serif; background-color: rgba(155, 155, 155, 0.2);"><a href="#n0.3715415633810799" style="color: inherit; text-decoration: inherit;">Back To Top</a></compositeblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">]</block></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="inline" style="display: block;"><div style="vertical-align: baseline;"><div style="display: inline-block; height: 0px; border-bottom: 1px solid; width: 100%;"></div></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode section sindent-0" data-line-id="n0.21926842074690178" style="font-size: 1.2em; padding-top: 0.5em; padding-bottom: 0.5em; font-weight: bold; line-height: 1.4;" id="n0.21926842074690178" role="heading" aria-level="1"><prefix style="text-align: left; padding-right: 0.5em;">4. </prefix><blocks><baselineblock class="inline"></baselineblock><block>Petastorm and Horovod</block></blocks></line><line class="root text-mode section sindent-1" data-line-id="n0.5455534651856233" style="font-size: 1.1em; padding-top: 0.5em; padding-bottom: 0.5em; font-weight: bold; line-height: 1.4;" id="n0.5455534651856233" role="heading" aria-level="2"><prefix style="text-align: left; padding-right: 0.25em;">4.1. </prefix><blocks><baselineblock class="inline"></baselineblock><block>Petastorm</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://github.com/uber/petastorm" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://github.com/uber/petastorm" target="_blank" style="color: inherit; text-decoration: inherit;">Petastorm</a></block><block> enables </block><block style="font-weight: bold; background-color: rgb(255, 254, 0);">single machine or distributed training and evaluation of deep learning models from datasets in Apache Parquet format and datasets that are already loaded as Spark DataFrames</block><block>. </block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>It supports ML frameworks such as TensorFlow, PyTorch, and PySpark and can be used from pure Python code.</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://learn.microsoft.com/en-us/azure/databricks/_extras/notebooks/source/deep-learning/petastorm-spark-converter-pytorch.html" style="text-decoration: underline; font-weight: bold; color: rgb(17, 85, 204);"><a href="https://learn.microsoft.com/en-us/azure/databricks/_extras/notebooks/source/deep-learning/petastorm-spark-converter-pytorch.html" target="_blank" style="color: inherit; text-decoration: inherit;">Simplify data conversion from Spark to PyTorch</a></block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Below, we define </block><block style="font-weight: bold; color: rgb(255, 64, 0);">training configurations</block><block>.</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold; background-color: rgb(255, 254, 0);">Note:</block><block> We define a path for </block><block style="font-style: italic;">Petastorm</block><block> to store cached data. </block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Petastorm takes data from a Spark DataFrame, checks if it's already cached and persisted in the file system, and caches it if not. </block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Here, we define where the cache path is to provide a directory for the intermediate files later.</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 609.992px; height: 353.69px; position: relative;"><img src="image-resources/2573a00d-7da4-4700-8b01-205823af1507.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold;">What is </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; font-weight: bold; color: rgb(231, 55, 61);">dataclass</block><block style="font-weight: bold;">? </block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>It is a new feature since Python 3.7 that allows class definition with less boilerplate code, reducing code verbosity. </block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>If you are curious to read more about this, go to this </block><block class="role-hyper-link" data-hyper-link-url="https://towardsdatascience.com/9-reasons-why-you-should-start-using-python-dataclasses-98271adadc66" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://towardsdatascience.com/9-reasons-why-you-should-start-using-python-dataclasses-98271adadc66" target="_blank" style="color: inherit; text-decoration: inherit;">blog post</a></block><block> or </block><block class="role-hyper-link" data-hyper-link-url="https://docs.python.org/3/library/dataclasses.html" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://docs.python.org/3/library/dataclasses.html" target="_blank" style="color: inherit; text-decoration: inherit;">Python's documentation</a></block><block>.</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item full-line-block-inside" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="code-section-symbol inline" style="display: block;"><div class="code-section theme-tomorrow-night" style="display: block; border: 1px solid lightgray; background: rgb(45, 45, 45); padding: 10px; font-size: 12px;"><editarea class="text-mode code-section-edit-area" style="font-family: &quot;Fira code&quot;, &quot;Fira Mono&quot;, monospace;"><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">from</block><block class=" token"> dataclasses </block><block class="keyword token">import</block><block class=" token"> dataclass</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">@dataclass</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">class</block><block class=" token"> </block><block class="class-name token">TrainConfig</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    batch_size</block><block class="punctuation token">:</block><block class=" token"> </block><block class="builtin token">int</block><block class=" token"> </block><block class="operator token">=</block><block class=" token"> </block><block class="number token">64</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    epochs</block><block class="punctuation token">:</block><block class=" token"> </block><block class="builtin token">int</block><block class=" token"> </block><block class="operator token">=</block><block class=" token"> </block><block class="number token">10</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    learning_rate</block><block class="punctuation token">:</block><block class=" token"> </block><block class="builtin token">float</block><block class=" token"> </block><block class="operator token">=</block><block class=" token"> </block><block class="number token">0.001</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    verbose</block><block class="punctuation token">:</block><block class=" token"> </block><block class="builtin token">int</block><block class=" token"> </block><block class="operator token">=</block><block class=" token"> </block><block class="number token">1</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    prefetch</block><block class="punctuation token">:</block><block class=" token"> </block><block class="builtin token">int</block><block class=" token"> </block><block class="operator token">=</block><block class=" token"> </block><block class="number token">1</block><block class=" token">  </block><block class="comment token"># We will look at this later</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    validation_data</block><block class="punctuation token">:</block><block class=" token"> </block><block class="builtin token">tuple</block><block class=" token"> </block><block class="operator token">=</block><block class=" token"> </block><block class="punctuation token">(</block><block class=" token">X_val</block><block class="punctuation token">,</block><block class=" token"> y_val</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="comment token"># Define directory the underlying files are copied to</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="comment token"># Leverages Network File System (NFS) location for better performance if using a single node cluster</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    petastorm_cache</block><block class="punctuation token">:</block><block class=" token"> </block><block class="builtin token">str</block><block class=" token"> </block><block class="operator token">=</block><block class=" token"> </block><block class="string-interpolation string token">f"file:/</block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">DA</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">paths</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">working_dir</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">/petastorm"</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="comment token"># uncomment the line below if working with a multi node cluster (can't use NFS location)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="comment token"># petastorm_cache: str = f"file:///{DA.paths.working_dir}/petastorm".replace("///dbfs:/", "/dbfs/")</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    dbutils</block><block class="punctuation token">.</block><block class=" token">fs</block><block class="punctuation token">.</block><block class=" token">rm</block><block class="punctuation token">(</block><block class=" token">petastorm_cache</block><block class="punctuation token">,</block><block class=" token"> recurse</block><block class="operator token">=</block><block class="boolean token">True</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    dbutils</block><block class="punctuation token">.</block><block class=" token">fs</block><block class="punctuation token">.</block><block class=" token">mkdirs</block><block class="punctuation token">(</block><block class=" token">petastorm_cache</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    petastorm_workers_count</block><block class="punctuation token">:</block><block class=" token"> </block><block class="builtin token">int</block><block class=" token"> </block><block class="operator token">=</block><block class=" token"> spark</block><block class="punctuation token">.</block><block class=" token">sparkContext</block><block class="punctuation token">.</block><block class=" token">defaultParallelism</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">target_col </block><block class="operator token">=</block><block class=" token"> </block><block class="string token">"label"</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">feature_cols </block><block class="operator token">=</block><block class=" token"> train_df</block><block class="punctuation token">.</block><block class=" token">columns</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">feature_cols</block><block class="punctuation token">.</block><block class=" token">remove</block><block class="punctuation token">(</block><block class=" token">target_col</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">feature_cols</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">import</block><block class=" token"> tensorflow </block><block class="keyword token">as</block><block class=" token"> tf</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">from</block><block class=" token"> tensorflow</block><block class="punctuation token">.</block><block class=" token">keras</block><block class="punctuation token">.</block><block class=" token">models </block><block class="keyword token">import</block><block class=" token"> Sequential</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">from</block><block class=" token"> tensorflow</block><block class="punctuation token">.</block><block class=" token">keras</block><block class="punctuation token">.</block><block class=" token">layers </block><block class="keyword token">import</block><block class=" token"> Dense</block><block class="punctuation token">,</block><block class=" token"> Normalization</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">tf</block><block class="punctuation token">.</block><block class=" token">random</block><block class="punctuation token">.</block><block class=" token">set_seed</block><block class="punctuation token">(</block><block class="number token">42</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">def</block><block class=" token"> </block><block class="function token">build_compile_model</block><block class="punctuation token">(</block><block class=" token">normalize_layer</block><block class="punctuation token">,</block><block class=" token"> cfg</block><block class="punctuation token">)</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    model </block><block class="operator token">=</block><block class=" token"> Sequential</block><block class="punctuation token">(</block><block class="punctuation token">[</block><block class=" token">normalize_layer</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                        Dense</block><block class="punctuation token">(</block><block class="number token">20</block><block class="punctuation token">,</block><block class=" token"> input_dim</block><block class="operator token">=</block><block class="builtin token">len</block><block class="punctuation token">(</block><block class=" token">feature_cols</block><block class="punctuation token">)</block><block class="punctuation token">,</block><block class=" token"> activation</block><block class="operator token">=</block><block class="string token">"relu"</block><block class="punctuation token">)</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                        Dense</block><block class="punctuation token">(</block><block class="number token">20</block><block class="punctuation token">,</block><block class=" token"> activation</block><block class="operator token">=</block><block class="string token">"relu"</block><block class="punctuation token">)</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                        Dense</block><block class="punctuation token">(</block><block class="number token">1</block><block class="punctuation token">,</block><block class=" token"> activation</block><block class="operator token">=</block><block class="string token">"linear"</block><block class="punctuation token">)</block><block class="punctuation token">]</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                        </block><block class="punctuation token">)</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    optimizer </block><block class="operator token">=</block><block class=" token"> tf</block><block class="punctuation token">.</block><block class=" token">keras</block><block class="punctuation token">.</block><block class=" token">optimizers</block><block class="punctuation token">.</block><block class=" token">Adam</block><block class="punctuation token">(</block><block class=" token">learning_rate</block><block class="operator token">=</block><block class=" token">cfg</block><block class="punctuation token">.</block><block class=" token">learning_rate</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    model</block><block class="punctuation token">.</block><block class="builtin token">compile</block><block class="punctuation token">(</block><block class=" token">optimizer</block><block class="operator token">=</block><block class=" token">optimizer</block><block class="punctuation token">,</block><block class=" token"> loss</block><block class="operator token">=</block><block class="string token">"mse"</block><block class="punctuation token">,</block><block class=" token"> metrics</block><block class="operator token">=</block><block class="punctuation token">[</block><block class="string token">"mae"</block><block class="punctuation token">]</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="keyword token">return</block><block class=" token"> model</block></blocks></line></editarea></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">[</block><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><compositeblock dir="ltr" class="anchor-tag-ref inline" style="font-family: &quot;Computer Modern Serif&quot;, serif; background-color: rgba(155, 155, 155, 0.2);"><a href="#n0.3715415633810799" style="color: inherit; text-decoration: inherit;">Back To Top</a></compositeblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">]</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode section sindent-2" data-line-id="n0.7897191516441164" style="font-size: 1em; padding-top: 0.5em; padding-bottom: 0.5em; font-weight: bold; line-height: 1.4;" id="n0.7897191516441164" role="heading" aria-level="3"><prefix style="text-align: left; padding-right: 0em;">4.1.1. </prefix><blocks><baselineblock class="inline"></baselineblock><block>Preprocessing Data for Petastorm</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="text-decoration: underline;">Delta tables inherently store data in Parquet columnar format</block><block>. </block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="background-color: rgb(255, 254, 0);">Petastorm requires row format for transformation or filtering</block><block>. </block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>You can read </block><block class="role-hyper-link" data-hyper-link-url="https://www.uber.com/blog/petastorm/" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://www.uber.com/blog/petastorm/" target="_blank" style="color: inherit; text-decoration: inherit;">Uber's blog post</a></block><block> on how Petastorm is implemented. </block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>There are two approaches to carrying out transformations:</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="color: rgb(0, 0, 0); font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold; color: rgb(0, 0, 0);">Upstream Vectorization</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="color: rgb(0, 0, 0); font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold; color: rgb(0, 0, 0);">Downstream Vectorization</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Both approaches require us to use Petastorm </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">TransformSpec</block><block> function, which we will show later.</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="color: rgb(255, 64, 0); font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold; color: rgb(255, 64, 0);">Approach 1: Upstream Vectorization</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>This approach </block><block style="background-color: rgb(255, 254, 0);">handles as much transformation as possible </block><block style="text-decoration: underline; background-color: rgb(255, 254, 0);">prior</block><block style="background-color: rgb(255, 254, 0);"> to passing data to Petastorm and TensorFlow</block><block>.</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold;">Benefits</block><block> of </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">SparkDatasetConverter</block><block> and </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">make_spark_converter</block><block>:</block></blocks></line><line class="root text-mode indent-2 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="3"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;">1. </prefix><blocks><baselineblock class="inline"></baselineblock><block>Caches the data if it has not been cached</block></blocks></line><line class="root text-mode indent-2 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="3"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;">2. </prefix><blocks><baselineblock class="inline"></baselineblock><block style="text-decoration: underline;">Automatically converts SparkML vector into 1D arrays</block><block>.</block></blocks></line><line class="root text-mode indent-3 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="background-color: rgb(255, 254, 0);">This removes the need to use SparkML for training ML models, allowing us to use a variety of deep learning frameworks to train models</block><block>.</block></blocks></line><line class="root text-mode indent-3 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold; background-color: rgb(255, 254, 0);">Note:</block><block> Notice that Petastorm caches the DataFrame in the path with this directory format: </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(63, 131, 219);">{datetime}-appid-{spark.sparkContext.applicationId}-{uuid4}</block><block>. </block></blocks></line><line class="root text-mode indent-2 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="3"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;">* </prefix><blocks><baselineblock class="inline"></baselineblock><block>Date time string format is </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(63, 131, 219);">%Y%m%d%H%M%S</block><block> that represents the time of dataframe materialization.</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item full-line-block-inside" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="code-section-symbol inline" style="display: block;"><div class="code-section theme-tomorrow-night" style="display: block; border: 1px solid lightgray; background: rgb(45, 45, 45); padding: 10px; font-size: 10px;"><editarea class="text-mode code-section-edit-area" style="font-family: &quot;Fira code&quot;, &quot;Fira Mono&quot;, monospace;"><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">from</block><block class=" token"> pyspark</block><block class="punctuation token">.</block><block class=" token">ml</block><block class="punctuation token">.</block><block class=" token">feature </block><block class="keyword token">import</block><block class=" token"> VectorAssembler</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">from</block><block class=" token"> petastorm</block><block class="punctuation token">.</block><block class=" token">spark </block><block class="keyword token">import</block><block class=" token"> SparkDatasetConverter</block><block class="punctuation token">,</block><block class=" token"> make_spark_converter</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">def</block><block class=" token"> </block><block class="function token">create_petastorm_converters_vec</block><block class="punctuation token">(</block><block class=" token">train_df</block><block class="punctuation token">,</block><block class=" token"> cfg</block><block class="punctuation token">,</block><block class=" token"> feature_cols</block><block class="punctuation token">,</block><block class=" token"> target_col</block><block class="operator token">=</block><block class="string token">"label"</block><block class="punctuation token">)</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="comment token"># Set a cache directory for intermediate data storage</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    spark</block><block class="punctuation token">.</block><block class=" token">conf</block><block class="punctuation token">.</block><block class="builtin token">set</block><block class="punctuation token">(</block><block class=" token">SparkDatasetConverter</block><block class="punctuation token">.</block><block class=" token">PARENT_CACHE_DIR_URL_CONF</block><block class="punctuation token">,</block><block class=" token"> cfg</block><block class="punctuation token">.</block><block class=" token">petastorm_cache</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    vector_assembler </block><block class="operator token">=</block><block class=" token"> VectorAssembler</block><block class="punctuation token">(</block><block class=" token">inputCols</block><block class="operator token">=</block><block class=" token">feature_cols</block><block class="punctuation token">,</block><block class=" token"> outputCol</block><block class="operator token">=</block><block class="string token">"features"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    transformed_df </block><block class="operator token">=</block><block class=" token"> vector_assembler</block><block class="punctuation token">.</block><block class=" token">transform</block><block class="punctuation token">(</block><block class=" token">train_df</block><block class="punctuation token">)</block><block class="punctuation token">.</block><block class=" token">select</block><block class="punctuation token">(</block><block class="string token">"features"</block><block class="punctuation token">,</block><block class=" token"> target_col</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="comment token"># Below, we repartition the dataframe for efficiency: we'd like the dataframe to be evenly distributed across workers</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    converter_train </block><block class="operator token">=</block><block class=" token"> make_spark_converter</block><block class="punctuation token">(</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        transformed_df</block><block class="punctuation token">.</block><block class=" token">repartition</block><block class="punctuation token">(</block><block class=" token">cfg</block><block class="punctuation token">.</block><block class=" token">petastorm_workers_count</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="keyword token">return</block><block class=" token"> converter_train</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">cfg </block><block class="operator token">=</block><block class=" token"> TrainConfig</block><block class="punctuation token">(</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">converter_train_vec </block><block class="operator token">=</block><block class=" token"> create_petastorm_converters_vec</block><block class="punctuation token">(</block><block class=" token">train_df</block><block class="punctuation token">,</block><block class=" token"> cfg</block><block class="punctuation token">,</block><block class=" token"> feature_cols</block><block class="punctuation token">,</block><block class=" token"> target_col</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Converting floating-point columns to float32</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># The median size 134967 B (&lt; 50 MB) of the parquet files is too small. Total size: 539716 B. Increase the median file size by calling df.repartition(n) or df.coalesce(n), which might help improve the performance. Parquet files: file:/dbfs:/mnt/dbacademy-users/class+015@databricks.com/deep-learning-with-databricks/petastorm/20240109155024-appid-local-1704812232391-b0ff35f9-8e35-4c58-bb15-58c57c4a297f/part-00002-tid-3415652848501999887-44a42c18-8b6b-490e-9d7e-5cc0874f4246-98-1-c000.parquet, ...</block></blocks></line></editarea></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold; background-color: rgb(255, 254, 0);">At this stage, the dataframe has not yet been materialized</block><block style="background-color: rgb(255, 254, 0);">. </block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>It is only materialized when we call </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">converter_train.make_tf_dataset</block><block> later in order to actively feed data to TensorFlow training framework. </block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>We can now further define additional preprocessing logic using </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">TransformSpec</block><block>. </block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="background-color: rgb(255, 254, 0);">All the transformations will apply to each row on the Spark thread</block><block>, which is why we needed to specify </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">petastorm_workers_count</block><block> in our training configurations.</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold;">About</block><block> </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">TransformSpec</block><block>:</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>The output shape of </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">TransformSpec</block><block> is not automatically known by Petastorm. Therefore, we need to supply the length of our feature vector in </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">edit_fields</block><block>.</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">selected_fields</block><block> indicates the fields to be selected, and the post-transform schema will respect the field order in </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">selected_fields</block><block>.</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Refer to </block><block class="role-hyper-link" data-hyper-link-url="https://petastorm.readthedocs.io/en/latest/api.html?highlight=transformspec#module-petastorm.transform" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://petastorm.readthedocs.io/en/latest/api.html?highlight=transformspec#module-petastorm.transform" target="_blank" style="color: inherit; text-decoration: inherit;">documentation</a></block><block>.</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item full-line-block-inside" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="code-section-symbol inline" style="display: block;"><div class="code-section theme-tomorrow-night" style="display: block; border: 1px solid lightgray; background: rgb(45, 45, 45); padding: 10px; font-size: 12px;"><editarea class="text-mode code-section-edit-area" style="font-family: &quot;Fira code&quot;, &quot;Fira Mono&quot;, monospace;"><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">from</block><block class=" token"> petastorm </block><block class="keyword token">import</block><block class=" token"> TransformSpec</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">tf_spec_vec </block><block class="operator token">=</block><block class=" token"> TransformSpec</block><block class="punctuation token">(</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    edit_fields</block><block class="operator token">=</block><block class="punctuation token">[</block><block class="punctuation token">(</block><block class="string token">"features"</block><block class="punctuation token">,</block><block class=" token"> np</block><block class="punctuation token">.</block><block class=" token">float32</block><block class="punctuation token">,</block><block class=" token"> </block><block class="punctuation token">(</block><block class="builtin token">len</block><block class="punctuation token">(</block><block class=" token">feature_cols</block><block class="punctuation token">)</block><block class="punctuation token">,</block><block class="punctuation token">)</block><block class="punctuation token">,</block><block class=" token"> </block><block class="boolean token">False</block><block class="punctuation token">)</block><block class="punctuation token">]</block><block class="punctuation token">,</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    selected_fields</block><block class="operator token">=</block><block class="punctuation token">[</block><block class="string token">"features"</block><block class="punctuation token">,</block><block class=" token"> target_col</block><block class="punctuation token">]</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="punctuation token">)</block></blocks></line></editarea></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold;">Gotchas about</block><block> </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">epoch</block><block>:</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>When using </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">tf.keras.layers.Normalization</block><block> (or other preprocessing layers), remember that </block><block style="text-decoration: none; font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61); background-color: rgb(255, 254, 0);">.adapt()</block><block style="text-decoration: none; background-color: rgb(255, 254, 0);"> is not epoch-aware</block><block>. </block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>This means that we need to have </block><block style="text-decoration: underline;">two separate calls</block><block> of </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">converter_train.make_tf_dataset</block><block> to</block></blocks></line><line class="root text-mode indent-2 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="3"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;">* </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold;">Normalize</block><block> </block><block style="font-weight: bold;">our data</block><block> in one go: </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">num_epochs=1</block></blocks></line><line class="root text-mode indent-2 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="3"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;">* </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold;">Train the DL model</block><block> with infinite batches of data: </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">num_epochs=None</block></blocks></line><line class="root text-mode indent-2 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="3"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;">* </prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold; background-color: rgb(255, 254, 0);">Note:</block><block> The </block><block style="font-style: italic;">epoch</block><block> we are referring to is separate from training epochs, which dictates how many times TF sees the entire dataset. </block></blocks></line><line class="root text-mode indent-2 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="3"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;">* </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold; color: rgb(144, 19, 254);">Petastorm epoch</block><block> is the number of times for Petastorm to pass over all rows.</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold;">Why</block><block> </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">prefetch</block><block style="font-weight: bold;">?</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>It is </block><block style="background-color: rgb(255, 254, 0);">important for model performance</block><block>. </block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>We are creating a dataset that is </block><block style="text-decoration: underline;">always n batches ahead</block><block>, while our model is training on another batch.</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Refer to </block><block class="role-hyper-link" data-hyper-link-url="https://www.tensorflow.org/guide/data_performance#prefetching" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://www.tensorflow.org/guide/data_performance#prefetching" target="_blank" style="color: inherit; text-decoration: inherit;">tf.keras's documentation here</a></block><block>.</block></blocks></line><line class="root text-mode indent-2 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="3"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;">* </prefix><blocks><baselineblock class="inline"></baselineblock><block style="text-decoration: underline; background-color: rgb(255, 254, 0);">When the data is large</block><block style="background-color: rgb(255, 254, 0);">, we usually prefer to leave to </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61); background-color: rgb(255, 254, 0);">tf.data.AUTOTUNE</block><block style="background-color: rgb(255, 254, 0);"> to decide how many batches to prefetch, rather than using trials and errors to set it manually</block><block>.</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item full-line-block-inside" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="code-section-symbol inline" style="display: block;"><div class="code-section theme-tomorrow-night" style="display: block; border: 1px solid lightgray; background: rgb(45, 45, 45); padding: 10px; font-size: 12px;"><editarea class="text-mode code-section-edit-area" style="font-family: &quot;Fira code&quot;, &quot;Fira Mono&quot;, monospace;"><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">### This `with` statement here creates train_ds in TF dataset format to feed into a TF algorithm. This means that what we supply to TransformSpec will be performed on each batch of data.</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">with</block><block class=" token"> converter_train_vec</block><block class="punctuation token">.</block><block class=" token">make_tf_dataset</block><block class="punctuation token">(</block><block class=" token">transform_spec</block><block class="operator token">=</block><block class=" token">tf_spec_vec</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                                        workers_count</block><block class="operator token">=</block><block class=" token">cfg</block><block class="punctuation token">.</block><block class=" token">petastorm_workers_count</block><block class="punctuation token">,</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                                        batch_size</block><block class="operator token">=</block><block class=" token">cfg</block><block class="punctuation token">.</block><block class=" token">batch_size</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                                        prefetch</block><block class="operator token">=</block><block class=" token">cfg</block><block class="punctuation token">.</block><block class=" token">prefetch</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                                        num_epochs</block><block class="operator token">=</block><block class="number token">1</block><block class=" token"> </block><block class="comment token"># adapt() is not epoch aware; setting num_epochs=None creates an infinite dataset. Hence an infinite loop.</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                                        </block><block class="punctuation token">)</block><block class=" token"> </block><block class="keyword token">as</block><block class=" token"> train_ds</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="comment token"># Number of steps required to go through one epoch</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    steps_per_epoch </block><block class="operator token">=</block><block class=" token"> </block><block class="builtin token">len</block><block class="punctuation token">(</block><block class=" token">converter_train_vec</block><block class="punctuation token">)</block><block class=" token"> </block><block class="operator token">//</block><block class=" token"> cfg</block><block class="punctuation token">.</block><block class=" token">batch_size</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    normalizer_vec </block><block class="operator token">=</block><block class=" token"> Normalization</block><block class="punctuation token">(</block><block class=" token">axis</block><block class="operator token">=</block><block class="operator token">-</block><block class="number token">1</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    normalizer_vec</block><block class="punctuation token">.</block><block class=" token">adapt</block><block class="punctuation token">(</block><block class=" token">train_ds</block><block class="punctuation token">.</block><block class="builtin token">map</block><block class="punctuation token">(</block><block class="keyword token">lambda</block><block class=" token"> x</block><block class="punctuation token">:</block><block class=" token"> x</block><block class="punctuation token">.</block><block class=" token">features</block><block class="punctuation token">)</block><block class="punctuation token">)</block></blocks></line></editarea></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold; background-color: rgb(255, 254, 0);">Note:</block><block> Note that we use </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">num_epochs=None</block><block> to generate infinite batches of data to avoid handling the last incomplete batch. </block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>This is </block><block style="text-decoration: underline; font-weight: bold;">particularly useful in the distributed training scenario</block><block>, where we need to guarantee that the numbers of data records seen on all workers are identical. </block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Given that the length of each data shard may not be identical, </block><block style="text-decoration: underline;">setting </block><block style="text-decoration: underline; font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">num_epochs</block><block style="text-decoration: underline;"> to any specific number would fail to meet the guarantee</block><block>.</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Essentially, since the normalization layer is not part of the training, we only need to do it once, and then we can prepend to every training epoch.</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item full-line-block-inside" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="code-section-symbol inline" style="display: block;"><div class="code-section theme-tomorrow-night" style="display: block; border: 1px solid lightgray; background: rgb(45, 45, 45); padding: 10px; font-size: 12px;"><editarea class="text-mode code-section-edit-area" style="font-family: &quot;Fira code&quot;, &quot;Fira Mono&quot;, monospace;"><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># reset the Petastorm converter to create an 'infinite' dataset</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">with</block><block class=" token"> converter_train_vec</block><block class="punctuation token">.</block><block class=" token">make_tf_dataset</block><block class="punctuation token">(</block><block class=" token">workers_count</block><block class="operator token">=</block><block class=" token">cfg</block><block class="punctuation token">.</block><block class=" token">petastorm_workers_count</block><block class="punctuation token">,</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                                     batch_size</block><block class="operator token">=</block><block class=" token">cfg</block><block class="punctuation token">.</block><block class=" token">batch_size</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                                     prefetch</block><block class="operator token">=</block><block class=" token">cfg</block><block class="punctuation token">.</block><block class=" token">prefetch</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                                     num_epochs</block><block class="operator token">=</block><block class="boolean token">None</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                                    </block><block class="punctuation token">)</block><block class=" token"> </block><block class="keyword token">as</block><block class=" token"> train_ds</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    dataset </block><block class="operator token">=</block><block class=" token"> train_ds</block><block class="punctuation token">.</block><block class="builtin token">map</block><block class="punctuation token">(</block><block class="keyword token">lambda</block><block class=" token"> x</block><block class="punctuation token">:</block><block class=" token"> </block><block class="punctuation token">(</block><block class=" token">x</block><block class="punctuation token">.</block><block class=" token">features</block><block class="punctuation token">,</block><block class=" token"> x</block><block class="punctuation token">.</block><block class=" token">label</block><block class="punctuation token">)</block><block class="punctuation token">)</block><block class=" token"> </block><block class="comment token"># Not strictly necessary as part of our TransformSpec</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    model_vec </block><block class="operator token">=</block><block class=" token"> build_compile_model</block><block class="punctuation token">(</block><block class=" token">normalizer_vec</block><block class="punctuation token">,</block><block class=" token"> cfg</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    history_vec </block><block class="operator token">=</block><block class=" token"> model_vec</block><block class="punctuation token">.</block><block class=" token">fit</block><block class="punctuation token">(</block><block class=" token">dataset</block><block class="punctuation token">,</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                        </block><block class="comment token"># Do not specify the batch_size if your data is in the form of a dataset (since they generate batches)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                        </block><block class="comment token"># Instead, use steps_per_epoch</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                        steps_per_epoch</block><block class="operator token">=</block><block class=" token">steps_per_epoch</block><block class="punctuation token">,</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                        epochs</block><block class="operator token">=</block><block class=" token">cfg</block><block class="punctuation token">.</block><block class=" token">epochs</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                        validation_data</block><block class="operator token">=</block><block class=" token">cfg</block><block class="punctuation token">.</block><block class=" token">validation_data</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                       </block><block class="punctuation token">)</block></blocks></line></editarea></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">[</block><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><compositeblock dir="ltr" class="anchor-tag-ref inline" style="font-family: &quot;Computer Modern Serif&quot;, serif; background-color: rgba(155, 155, 155, 0.2);"><a href="#n0.3715415633810799" style="color: inherit; text-decoration: inherit;">Back To Top</a></compositeblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">]</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="color: rgb(255, 64, 0); font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold; color: rgb(255, 64, 0);">Approach 2: Downstream Vectorization</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Here, we use the approach of passing the conversion of feature vector to 1D arrays to </block><block style="font-style: italic;">Petastorm</block><block>. </block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="background-color: rgb(255, 254, 0);">While this approach works, we recommend pushing as many data transformations upstream to allow higher efficiency when training</block><block>.</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item full-line-block-inside" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="code-section-symbol inline" style="display: block;"><div class="code-section theme-tomorrow-night" style="display: block; border: 1px solid lightgray; background: rgb(45, 45, 45); padding: 10px; font-size: 12px;"><editarea class="text-mode code-section-edit-area" style="font-family: &quot;Fira code&quot;, &quot;Fira Mono&quot;, monospace;"><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">def</block><block class=" token"> </block><block class="function token">create_petastorm_converters</block><block class="punctuation token">(</block><block class=" token">train_df</block><block class="punctuation token">,</block><block class=" token"> cfg</block><block class="punctuation token">)</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="triple-quoted-string string token">"""Create Petastorm converter objects from train and val Spark DataFrames"""</block><block class=" token">    </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    spark</block><block class="punctuation token">.</block><block class=" token">conf</block><block class="punctuation token">.</block><block class="builtin token">set</block><block class="punctuation token">(</block><block class=" token">SparkDatasetConverter</block><block class="punctuation token">.</block><block class=" token">PARENT_CACHE_DIR_URL_CONF</block><block class="punctuation token">,</block><block class=" token"> cfg</block><block class="punctuation token">.</block><block class=" token">petastorm_cache</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="comment token"># Same as before, we repartition the dataframe for efficiency: we'd like the dataframe to be evenly distributed across workers</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    converter_train </block><block class="operator token">=</block><block class=" token"> make_spark_converter</block><block class="punctuation token">(</block><block class=" token">train_df</block><block class="punctuation token">.</block><block class=" token">repartition</block><block class="punctuation token">(</block><block class=" token">cfg</block><block class="punctuation token">.</block><block class=" token">petastorm_workers_count</block><block class="punctuation token">)</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="keyword token">return</block><block class=" token"> converter_train</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">cfg </block><block class="operator token">=</block><block class=" token"> TrainConfig</block><block class="punctuation token">(</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">converter_train </block><block class="operator token">=</block><block class=" token"> create_petastorm_converters</block><block class="punctuation token">(</block><block class=" token">train_df</block><block class="punctuation token">,</block><block class=" token"> cfg</block><block class="punctuation token">)</block></blocks></line></editarea></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>In addition to specifying the output shape and schema, we instruct </block><block style="font-style: italic;">Petastorm</block><block> how to preprocess our data. </block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="text-decoration: underline;">Here we need to prepare the data to be a 1D array from a vector</block><block>. Hence, we define </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">make_transform_row</block><block> to perform the transformations.</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>About </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">make_transform_row</block><block>:</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;">1. </prefix><blocks><baselineblock class="inline"></baselineblock><block>It operates in </block><block style="font-weight: bold;">Spark threads</block><block>.</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;">2. </prefix><blocks><baselineblock class="inline"></baselineblock><block>The input and output of this dataframe </block><block style="font-weight: bold;">has to be a dictionary</block><block>, which </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif;">pandas.DataFrame</block><block> is.</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;">3. </prefix><blocks><baselineblock class="inline"></baselineblock><block style="text-decoration: underline;">We take each feature and transform it into a 1D numpy or a tensor</block><block>.</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item full-line-block-inside" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="code-section-symbol inline" style="display: block;"><div class="code-section theme-tomorrow-night" style="display: block; border: 1px solid lightgray; background: rgb(45, 45, 45); padding: 10px; font-size: 12px;"><editarea class="text-mode code-section-edit-area" style="font-family: &quot;Fira code&quot;, &quot;Fira Mono&quot;, monospace;"><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">import</block><block class=" token"> pandas </block><block class="keyword token">as</block><block class=" token"> pd</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">import</block><block class=" token"> numpy </block><block class="keyword token">as</block><block class=" token"> np</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">def</block><block class=" token"> </block><block class="function token">make_transform_row</block><block class="punctuation token">(</block><block class=" token">feature_cols</block><block class="punctuation token">,</block><block class=" token"> label_col</block><block class="punctuation token">)</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="keyword token">def</block><block class=" token"> </block><block class="function token">apply</block><block class="punctuation token">(</block><block class=" token">pdf</block><block class="punctuation token">)</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        res </block><block class="operator token">=</block><block class=" token"> pd</block><block class="punctuation token">.</block><block class=" token">DataFrame</block><block class="punctuation token">(</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        res</block><block class="punctuation token">[</block><block class="string token">"features"</block><block class="punctuation token">]</block><block class=" token"> </block><block class="operator token">=</block><block class=" token"> pdf</block><block class="punctuation token">[</block><block class=" token">feature_cols</block><block class="punctuation token">]</block><block class="punctuation token">.</block><block class="builtin token">apply</block><block class="punctuation token">(</block><block class="keyword token">lambda</block><block class=" token"> x</block><block class="punctuation token">:</block><block class=" token"> np</block><block class="punctuation token">.</block><block class=" token">array</block><block class="punctuation token">(</block><block class=" token">x</block><block class="punctuation token">.</block><block class=" token">tolist</block><block class="punctuation token">(</block><block class="punctuation token">)</block><block class="punctuation token">)</block><block class="punctuation token">,</block><block class=" token"> axis</block><block class="operator token">=</block><block class="number token">1</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        res</block><block class="punctuation token">[</block><block class=" token">label_col</block><block class="punctuation token">]</block><block class=" token"> </block><block class="operator token">=</block><block class=" token"> pdf</block><block class="punctuation token">[</block><block class=" token">label_col</block><block class="punctuation token">]</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block><block class="keyword token">return</block><block class=" token"> res</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="keyword token">return</block><block class=" token"> </block><block class="builtin token">apply</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">tf_spec </block><block class="operator token">=</block><block class=" token"> TransformSpec</block><block class="punctuation token">(</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    make_transform_row</block><block class="punctuation token">(</block><block class=" token">feature_cols</block><block class="punctuation token">,</block><block class=" token"> target_col</block><block class="punctuation token">)</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    edit_fields</block><block class="operator token">=</block><block class="punctuation token">[</block><block class="punctuation token">(</block><block class="string token">"features"</block><block class="punctuation token">,</block><block class=" token"> np</block><block class="punctuation token">.</block><block class=" token">float32</block><block class="punctuation token">,</block><block class=" token"> </block><block class="punctuation token">(</block><block class="builtin token">len</block><block class="punctuation token">(</block><block class=" token">feature_cols</block><block class="punctuation token">)</block><block class="punctuation token">,</block><block class="punctuation token">)</block><block class="punctuation token">,</block><block class=" token"> </block><block class="boolean token">False</block><block class="punctuation token">)</block><block class=" token"> </block><block class="comment token"># Tensorflow expects a list of tuples</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                </block><block class="punctuation token">]</block><block class="punctuation token">,</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    selected_fields</block><block class="operator token">=</block><block class="punctuation token">[</block><block class="string token">"features"</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"label"</block><block class="punctuation token">]</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Train the normalizer</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">with</block><block class=" token"> converter_train</block><block class="punctuation token">.</block><block class=" token">make_tf_dataset</block><block class="punctuation token">(</block><block class=" token">transform_spec</block><block class="operator token">=</block><block class=" token">tf_spec</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                                     workers_count</block><block class="operator token">=</block><block class=" token">cfg</block><block class="punctuation token">.</block><block class=" token">petastorm_workers_count</block><block class="punctuation token">,</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                                     batch_size</block><block class="operator token">=</block><block class=" token">cfg</block><block class="punctuation token">.</block><block class=" token">batch_size</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                                     prefetch</block><block class="operator token">=</block><block class="number token">2</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                                     num_epochs</block><block class="operator token">=</block><block class="number token">1</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                                    </block><block class="punctuation token">)</block><block class=" token"> </block><block class="keyword token">as</block><block class=" token"> train_ds</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    steps_per_epoch </block><block class="operator token">=</block><block class=" token"> </block><block class="builtin token">len</block><block class="punctuation token">(</block><block class=" token">converter_train</block><block class="punctuation token">)</block><block class=" token"> </block><block class="operator token">//</block><block class=" token"> cfg</block><block class="punctuation token">.</block><block class=" token">batch_size</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    normalizer </block><block class="operator token">=</block><block class=" token"> Normalization</block><block class="punctuation token">(</block><block class=" token">axis</block><block class="operator token">=</block><block class="operator token">-</block><block class="number token">1</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    normalizer</block><block class="punctuation token">.</block><block class=" token">adapt</block><block class="punctuation token">(</block><block class=" token">train_ds</block><block class="punctuation token">.</block><block class="builtin token">map</block><block class="punctuation token">(</block><block class="keyword token">lambda</block><block class=" token"> x</block><block class="punctuation token">:</block><block class=" token"> x</block><block class="punctuation token">.</block><block class=" token">features</block><block class="punctuation token">)</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># reset the Petastorm converter to create an 'infinite' dataset</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">with</block><block class=" token"> converter_train</block><block class="punctuation token">.</block><block class=" token">make_tf_dataset</block><block class="punctuation token">(</block><block class=" token">transform_spec</block><block class="operator token">=</block><block class=" token">tf_spec</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                                      workers_count</block><block class="operator token">=</block><block class=" token">cfg</block><block class="punctuation token">.</block><block class=" token">petastorm_workers_count</block><block class="punctuation token">,</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                                      batch_size</block><block class="operator token">=</block><block class=" token">cfg</block><block class="punctuation token">.</block><block class=" token">batch_size</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                                      prefetch</block><block class="operator token">=</block><block class="number token">2</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                                      num_epochs</block><block class="operator token">=</block><block class="boolean token">None</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                                     </block><block class="punctuation token">)</block><block class=" token"> </block><block class="keyword token">as</block><block class=" token"> train_ds</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    model </block><block class="operator token">=</block><block class=" token"> build_compile_model</block><block class="punctuation token">(</block><block class=" token">normalizer</block><block class="punctuation token">,</block><block class=" token"> cfg</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    history </block><block class="operator token">=</block><block class=" token"> model</block><block class="punctuation token">.</block><block class=" token">fit</block><block class="punctuation token">(</block><block class=" token">train_ds</block><block class="punctuation token">,</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                          steps_per_epoch</block><block class="operator token">=</block><block class=" token">steps_per_epoch</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                          epochs</block><block class="operator token">=</block><block class=" token">cfg</block><block class="punctuation token">.</block><block class=" token">epochs</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                          validation_data</block><block class="operator token">=</block><block class=" token">cfg</block><block class="punctuation token">.</block><block class=" token">validation_data</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                         </block><block class="punctuation token">)</block></blocks></line></editarea></div></compositeblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold;">Delete the cached files</block></blocks></line><line class="root text-mode indent-0 has-indent list-item full-line-block-inside" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="code-section-symbol inline" style="display: block;"><div class="code-section theme-tomorrow-night" style="display: block; border: 1px solid lightgray; background: rgb(45, 45, 45); padding: 10px; font-size: 12px;"><editarea class="text-mode code-section-edit-area" style="font-family: &quot;Fira code&quot;, &quot;Fira Mono&quot;, monospace;"><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">converter_train_vec</block><block class="punctuation token">.</block><block class=" token">delete</block><block class="punctuation token">(</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">converter_train</block><block class="punctuation token">.</block><block class=" token">delete</block><block class="punctuation token">(</block><block class="punctuation token">)</block></blocks></line></editarea></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">[</block><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><compositeblock dir="ltr" class="anchor-tag-ref inline" style="font-family: &quot;Computer Modern Serif&quot;, serif; background-color: rgba(155, 155, 155, 0.2);"><a href="#n0.3715415633810799" style="color: inherit; text-decoration: inherit;">Back To Top</a></compositeblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">]</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode section sindent-1" data-line-id="n0.007155380855395466" style="font-size: 1.1em; padding-top: 0.5em; padding-bottom: 0.5em; font-weight: bold; line-height: 1.4;" id="n0.007155380855395466" role="heading" aria-level="2"><prefix style="text-align: left; padding-right: 0.25em;">4.2. </prefix><blocks><baselineblock class="inline"></baselineblock><block>Horovod</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Similar to </block><block style="text-decoration: none; font-style: italic;">Petastorm</block><block>, </block><block style="font-weight: bold; color: rgb(255, 64, 0);">Horovod</block><block> is open-source developed by Uber to </block><block style="background-color: rgb(255, 254, 0);">train a distributed neural network</block><block>.</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://github.com/horovod/horovod" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://github.com/horovod/horovod" target="_blank" style="color: inherit; text-decoration: inherit;">Open-sourced</a></block><block> by Uber in 2017.</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Simplifies distributed neural network training</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Supports TensorFlow, Keras, PyTorch, and Apache MXNet</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://arxiv.org/pdf/1802.05799.pdf" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://arxiv.org/pdf/1802.05799.pdf" target="_blank" style="color: inherit; text-decoration: inherit;">Horovod paper</a></block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>From </block><block class="role-hyper-link" data-hyper-link-url="https://www.uber.com/blog/horovod/" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://www.uber.com/blog/horovod/" target="_blank" style="color: inherit; text-decoration: inherit;">Uber's blog post</a></block><block>:</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="font-style: italic; flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-style: italic;">[Horovod is] named after a traditional Russian folk dance in which performers dance with linked arms in a circle, much like how distributed TensorFlow processes use Horovod to communicate with each other.</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 445.6px; height: 331.08px; position: relative;"><img src="image-resources/7768d35e-dbd0-4fd4-bba7-1726b4365af4.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold;">Classical Parameter Server</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 675.195px; height: 187.47px; position: relative;"><img src="image-resources/f9c48f3b-6627-4204-a0b1-fda599f6f53c.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold;">Horovod</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="background-color: rgb(255, 254, 0);">The goal is to allow single node training to multiple nodes</block><block>. </block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="text-decoration: underline;">Horovod</block><block> uses a </block><block style="font-weight: bold;">data parallelization strategy</block><block> by </block><block style="text-decoration: underline;">distributing the training to multiple nodes in parallel</block><block>.</block></blocks></line><line class="root text-mode indent-2 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="3"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;">* </prefix><blocks><baselineblock class="inline"></baselineblock><block>Each node receives a copy of the model and a batch of the dataset.</block></blocks></line><line class="root text-mode indent-2 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="3"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;">* </prefix><blocks><baselineblock class="inline"></baselineblock><block>The node/worker computes the gradients on the assigned batch of data.</block></blocks></line><line class="root text-mode indent-2 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="3"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;">* </prefix><blocks><baselineblock class="inline"></baselineblock><block style="background-color: rgb(255, 254, 0);">Horovod uses </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61); background-color: rgb(255, 254, 0);">ring allreduce</block><block style="background-color: rgb(255, 254, 0);"> algorithm to synchronize and average the gradients across nodes</block><block>.</block></blocks></line><line class="root text-mode indent-2 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="3"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;">* </prefix><blocks><baselineblock class="inline"></baselineblock><block>All nodes/workers update their models' weights.</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 625.995px; height: 378.84px; position: relative;"><img src="image-resources/63230e37-ff91-4ba2-a69e-4e6b1b01555f.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>We will use </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">HorovodRunner</block><block> to </block><block style="text-decoration: underline;">wrap the single Python function that includes the training procedure</block><block>. </block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="background-color: rgb(255, 254, 0);">Spark implements </block><block style="text-decoration: underline; background-color: rgb(255, 254, 0);">barrier execution mode</block><block style="background-color: rgb(255, 254, 0);"> that allows multiple operations to be coordinated.</block><block> </block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>For example, in neural networks, the training process needs to coordinate backpropagation and forward pass. </block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">HorovodRunner</block><block> integrates with Spark's barrier execution/scheduling mode. </block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>If you are interested in more implementation details, refer to this </block><block class="role-hyper-link" data-hyper-link-url="https://docs.microsoft.com/en-us/azure/databricks/applications/deep-learning/distributed-training/horovod-runner" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://docs.microsoft.com/en-us/azure/databricks/applications/deep-learning/distributed-training/horovod-runner" target="_blank" style="color: inherit; text-decoration: inherit;">documentation</a></block><block>.</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>For additional info read the </block><block class="role-hyper-link" data-hyper-link-url="https://arxiv.org/abs/1802.05799" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://arxiv.org/abs/1802.05799" target="_blank" style="color: inherit; text-decoration: inherit;">paper released by Uber</a></block><block>.</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 677.992px; height: 280.5px; position: relative;"><img src="image-resources/734ba140-6c87-42dc-a4f4-35f49b5a3a40.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div data-caption-block-id="n0.9663819360063188" class="role-image-caption-container role-caption-container" style="display: flex; align-items: center; justify-content: center; margin-top: 10px;" id="n0.9663819360063188"><span class="no-print-outline" style="outline: none; position: relative; text-align: center;"><span class="role-image-caption-prefix" style="padding-right: 0.3em; font-weight: bold;"><span class="role-image-caption-name">Figure</span><span class="role-image-caption-number"><!-- react-text: 8473 --> <!-- /react-text --><!-- react-text: 8474 -->2<!-- /react-text --></span><span>:</span></span><editarea class="image-caption text-mode" style="min-width: 50px; display: inline;"><line class="text-mode align-center" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block>Ring All-Reduce</block></blocks></line><line class="text-mode align-center" style="line-height: 0.7;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; font-size: 0.8em; color: rgb(78, 166, 78);">#only one line of code</block></blocks></line><line class="text-mode align-center" style="line-height: 0.7;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; font-size: 0.8em;">optimizer = hvd.</block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; font-size: 0.8em; color: rgb(63, 131, 219);">DistributedOptimizer</block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; font-size: 0.8em;">(optimizer)</block></blocks></line></editarea></span></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item full-line-block-inside" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="code-section-symbol inline" style="display: block;"><div class="code-section theme-tomorrow-night" style="display: block; border: 1px solid lightgray; background: rgb(45, 45, 45); padding: 10px; font-size: 12px;"><editarea class="text-mode code-section-edit-area" style="font-family: &quot;Fira code&quot;, &quot;Fira Mono&quot;, monospace;"><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">from</block><block class=" token"> dataclasses </block><block class="keyword token">import</block><block class=" token"> dataclass</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">@dataclass</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">class</block><block class=" token"> </block><block class="class-name token">TrainConfig</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    batch_size</block><block class="punctuation token">:</block><block class=" token"> </block><block class="builtin token">int</block><block class=" token"> </block><block class="operator token">=</block><block class=" token"> </block><block class="number token">64</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    epochs</block><block class="punctuation token">:</block><block class=" token"> </block><block class="builtin token">int</block><block class=" token"> </block><block class="operator token">=</block><block class=" token"> </block><block class="number token">10</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    learning_rate</block><block class="punctuation token">:</block><block class=" token"> </block><block class="builtin token">float</block><block class=" token"> </block><block class="operator token">=</block><block class=" token"> </block><block class="number token">0.001</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    verbose</block><block class="punctuation token">:</block><block class=" token"> </block><block class="builtin token">int</block><block class=" token"> </block><block class="operator token">=</block><block class=" token"> </block><block class="number token">1</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    prefetch</block><block class="punctuation token">:</block><block class=" token"> </block><block class="builtin token">int</block><block class=" token"> </block><block class="operator token">=</block><block class=" token"> </block><block class="number token">2</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    validation_data </block><block class="operator token">=</block><block class=" token"> </block><block class="punctuation token">[</block><block class=" token">X_val</block><block class="punctuation token">,</block><block class=" token"> y_val</block><block class="punctuation token">]</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="comment token"># Define directory the underlying files are copied to</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="comment token"># Leverages Network File System (NFS) location for better performance if using a single node cluster</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    petastorm_cache</block><block class="punctuation token">:</block><block class=" token"> </block><block class="builtin token">str</block><block class=" token"> </block><block class="operator token">=</block><block class=" token"> </block><block class="string-interpolation string token">f"file:///</block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">DA</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">paths</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">working_dir</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">/petastorm"</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="comment token"># uncomment the line below if working with a multi node cluster (can't use NFS location)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="comment token"># petastorm_cache: str = f"file:///{DA.paths.working_dir}/petastorm".replace("///dbfs:/", "/dbfs/")</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    dbutils</block><block class="punctuation token">.</block><block class=" token">fs</block><block class="punctuation token">.</block><block class=" token">rm</block><block class="punctuation token">(</block><block class=" token">petastorm_cache</block><block class="punctuation token">,</block><block class=" token"> recurse</block><block class="operator token">=</block><block class="boolean token">True</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    dbutils</block><block class="punctuation token">.</block><block class=" token">fs</block><block class="punctuation token">.</block><block class=" token">mkdirs</block><block class="punctuation token">(</block><block class=" token">petastorm_cache</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    petastorm_workers_count</block><block class="punctuation token">:</block><block class=" token"> </block><block class="builtin token">int</block><block class=" token"> </block><block class="operator token">=</block><block class=" token"> spark</block><block class="punctuation token">.</block><block class=" token">sparkContext</block><block class="punctuation token">.</block><block class=" token">defaultParallelism</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">from</block><block class=" token"> petastorm</block><block class="punctuation token">.</block><block class=" token">spark </block><block class="keyword token">import</block><block class=" token"> SparkDatasetConverter</block><block class="punctuation token">,</block><block class=" token"> make_spark_converter</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">from</block><block class=" token"> pyspark</block><block class="punctuation token">.</block><block class=" token">ml</block><block class="punctuation token">.</block><block class=" token">feature </block><block class="keyword token">import</block><block class=" token"> VectorAssembler</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">def</block><block class=" token"> </block><block class="function token">create_petastorm_converters_vec</block><block class="punctuation token">(</block><block class=" token">train_df</block><block class="punctuation token">,</block><block class=" token"> cfg</block><block class="punctuation token">,</block><block class=" token"> feature_cols</block><block class="punctuation token">,</block><block class=" token"> target_col</block><block class="operator token">=</block><block class="string token">"label"</block><block class="punctuation token">)</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="comment token"># Set a cache directory for intermediate data storage </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    spark</block><block class="punctuation token">.</block><block class=" token">conf</block><block class="punctuation token">.</block><block class="builtin token">set</block><block class="punctuation token">(</block><block class=" token">SparkDatasetConverter</block><block class="punctuation token">.</block><block class=" token">PARENT_CACHE_DIR_URL_CONF</block><block class="punctuation token">,</block><block class=" token"> cfg</block><block class="punctuation token">.</block><block class=" token">petastorm_cache</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    vector_assembler </block><block class="operator token">=</block><block class=" token"> VectorAssembler</block><block class="punctuation token">(</block><block class=" token">inputCols</block><block class="operator token">=</block><block class=" token">feature_cols</block><block class="punctuation token">,</block><block class=" token"> outputCol</block><block class="operator token">=</block><block class="string token">"features"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    t_df </block><block class="operator token">=</block><block class=" token"> vector_assembler</block><block class="punctuation token">.</block><block class=" token">transform</block><block class="punctuation token">(</block><block class=" token">train_df</block><block class="punctuation token">)</block><block class="punctuation token">.</block><block class=" token">select</block><block class="punctuation token">(</block><block class="string token">"features"</block><block class="punctuation token">,</block><block class=" token"> target_col</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    converter_train </block><block class="operator token">=</block><block class=" token"> make_spark_converter</block><block class="punctuation token">(</block><block class=" token">t_df</block><block class="punctuation token">.</block><block class=" token">repartition</block><block class="punctuation token">(</block><block class=" token">cfg</block><block class="punctuation token">.</block><block class=" token">petastorm_workers_count</block><block class="punctuation token">)</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="keyword token">return</block><block class=" token"> converter_train</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">cfg </block><block class="operator token">=</block><block class=" token"> TrainConfig</block><block class="punctuation token">(</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">converter_train </block><block class="operator token">=</block><block class=" token"> create_petastorm_converters_vec</block><block class="punctuation token">(</block><block class=" token">train_df</block><block class="punctuation token">,</block><block class=" token"> cfg</block><block class="punctuation token">,</block><block class=" token"> feature_cols</block><block class="punctuation token">,</block><block class=" token"> target_col</block><block class="punctuation token">)</block></blocks></line></editarea></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">[</block><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><compositeblock dir="ltr" class="anchor-tag-ref inline" style="font-family: &quot;Computer Modern Serif&quot;, serif; background-color: rgba(155, 155, 155, 0.2);"><a href="#n0.3715415633810799" style="color: inherit; text-decoration: inherit;">Back To Top</a></compositeblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">]</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode section sindent-2" data-line-id="n0.3817992936145109" style="font-size: 1em; padding-top: 0.5em; padding-bottom: 0.5em; font-weight: bold; line-height: 1.4;" id="n0.3817992936145109" role="heading" aria-level="3"><prefix style="text-align: left; padding-right: 0em;">4.2.1. </prefix><blocks><baselineblock class="inline"></baselineblock><block>Data Communication</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Notice that in Petastorm's </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">converter_train.make_tf_dataset</block><block> call below, we have </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">cur_shard=hvd.rank()</block><block> and </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">shard_count=hvd.size()</block><block>. </block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>This is because Horovod uses </block><block style="font-weight: bold; color: rgb(255, 64, 0);">Message Passing Interface (MPI)</block><block> implementation to set up the distributed infrastructure for the nodes to communicate with each other.</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Say we launch our training step on 4 VMs, each having 4 GPUs. If we launched one copy of the script per GPU:</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Size would be the number of processes, in this case, 16.</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Rank would be the unique process ID from 0 to 15 (size - 1).</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Local rank would be the unique process ID within the VM from 0 to 3.</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold;">Reference:</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://github.com/horovod/horovod/blob/master/docs/concepts.rst" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://github.com/horovod/horovod/blob/master/docs/concepts.rst" target="_blank" style="color: inherit; text-decoration: inherit;">Horovod docs</a></block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold;">Define Horovod Training</block></blocks></line><line class="root text-mode indent-0 has-indent list-item full-line-block-inside" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="code-section-symbol inline" style="display: block;"><div class="code-section theme-tomorrow-night" style="display: block; border: 1px solid lightgray; background: rgb(45, 45, 45); padding: 10px; font-size: 10px;"><editarea class="text-mode code-section-edit-area" style="font-family: &quot;Fira code&quot;, &quot;Fira Mono&quot;, monospace;"><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Firstly we need to get our modules and set up some logistics</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">import</block><block class=" token"> horovod</block><block class="punctuation token">.</block><block class=" token">tensorflow</block><block class="punctuation token">.</block><block class=" token">keras </block><block class="keyword token">as</block><block class=" token"> hvd</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">import</block><block class=" token"> mlflow</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">import</block><block class=" token"> horovod</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">import</block><block class=" token"> tensorflow </block><block class="keyword token">as</block><block class=" token"> tf</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">from</block><block class=" token"> tensorflow</block><block class="punctuation token">.</block><block class=" token">keras</block><block class="punctuation token">.</block><block class=" token">models </block><block class="keyword token">import</block><block class=" token"> Sequential</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">from</block><block class=" token"> tensorflow</block><block class="punctuation token">.</block><block class=" token">keras</block><block class="punctuation token">.</block><block class=" token">layers </block><block class="keyword token">import</block><block class=" token"> Dense</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">from</block><block class=" token"> petastorm </block><block class="keyword token">import</block><block class=" token"> TransformSpec</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># As we will be sending the function to run on multiple machines, we need to be able to send data to our driver node for mlflow, this means we need to get our hostname and a token</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">tf</block><block class="punctuation token">.</block><block class=" token">random</block><block class="punctuation token">.</block><block class=" token">set_seed</block><block class="punctuation token">(</block><block class="number token">42</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">## get databricks credentials for mlflow tracking</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">databricks_host </block><block class="operator token">=</block><block class=" token"> mlflow</block><block class="punctuation token">.</block><block class=" token">utils</block><block class="punctuation token">.</block><block class=" token">databricks_utils</block><block class="punctuation token">.</block><block class=" token">get_webapp_url</block><block class="punctuation token">(</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">databricks_token </block><block class="operator token">=</block><block class=" token"> dbutils</block><block class="punctuation token">.</block><block class=" token">notebook</block><block class="punctuation token">.</block><block class=" token">entry_point</block><block class="punctuation token">.</block><block class=" token">getDbutils</block><block class="punctuation token">(</block><block class="punctuation token">)</block><block class="punctuation token">.</block><block class=" token">notebook</block><block class="punctuation token">(</block><block class="punctuation token">)</block><block class="punctuation token">.</block><block class=" token">getContext</block><block class="punctuation token">(</block><block class="punctuation token">)</block><block class="punctuation token">.</block><block class=" token">apiToken</block><block class="punctuation token">(</block><block class="punctuation token">)</block><block class="punctuation token">.</block><block class=" token">getOrElse</block><block class="punctuation token">(</block><block class="boolean token">None</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Finally, we need to checkpoint our data incase of a failure or stoppage.</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">checkpoint_dir </block><block class="operator token">=</block><block class=" token"> </block><block class="string-interpolation string token">f"</block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">DA</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">paths</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">working_dir</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">/petastorm_checkpoint_weights.ckpt"</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">dbutils</block><block class="punctuation token">.</block><block class=" token">fs</block><block class="punctuation token">.</block><block class=" token">rm</block><block class="punctuation token">(</block><block class=" token">checkpoint_dir</block><block class="punctuation token">,</block><block class=" token"> </block><block class="boolean token">True</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#checkpoint_dir = checkpoint_dir.replace("dbfs:/", "/dbfs/")</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">def</block><block class=" token"> </block><block class="function token">run_training_horovod</block><block class="punctuation token">(</block><block class="punctuation token">)</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="comment token"># Horovod: initialize Horovod.</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    hvd</block><block class="punctuation token">.</block><block class=" token">init</block><block class="punctuation token">(</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="comment token"># If using GPU, see example in docs pin GPU to be used to process local rank (one GPU per process)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="comment token"># These steps are skipped on a CPU cluster</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="comment token"># https://horovod.readthedocs.io/en/stable/tensorflow.html?#horovod-with-tensorflow</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="comment token"># While we already included mlflow in our notebook, this function will be sent to new nodes so we will need it included again</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="keyword token">import</block><block class=" token"> mlflow</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="keyword token">import</block><block class=" token"> os</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="comment token"># Configure Databricks MLflow environment</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    mlflow</block><block class="punctuation token">.</block><block class=" token">set_tracking_uri</block><block class="punctuation token">(</block><block class="string token">"databricks"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    os</block><block class="punctuation token">.</block><block class=" token">environ</block><block class="punctuation token">[</block><block class="string token">"DATABRICKS_HOST"</block><block class="punctuation token">]</block><block class=" token"> </block><block class="operator token">=</block><block class=" token"> databricks_host</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    os</block><block class="punctuation token">.</block><block class=" token">environ</block><block class="punctuation token">[</block><block class="string token">"DATABRICKS_TOKEN"</block><block class="punctuation token">]</block><block class=" token"> </block><block class="operator token">=</block><block class=" token"> databricks_token</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="comment token">#### Like the previous lesson, we need to create our dataset with the vectorization ####</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    tf_spec </block><block class="operator token">=</block><block class=" token"> TransformSpec</block><block class="punctuation token">(</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        edit_fields</block><block class="operator token">=</block><block class="punctuation token">[</block><block class="punctuation token">(</block><block class="string token">"features"</block><block class="punctuation token">,</block><block class=" token"> np</block><block class="punctuation token">.</block><block class=" token">float32</block><block class="punctuation token">,</block><block class=" token"> </block><block class="punctuation token">(</block><block class="builtin token">len</block><block class="punctuation token">(</block><block class=" token">feature_cols</block><block class="punctuation token">)</block><block class="punctuation token">,</block><block class="punctuation token">)</block><block class="punctuation token">,</block><block class=" token"> </block><block class="boolean token">False</block><block class="punctuation token">)</block><block class="punctuation token">]</block><block class="punctuation token">,</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        selected_fields</block><block class="operator token">=</block><block class="punctuation token">[</block><block class="string token">"features"</block><block class="punctuation token">,</block><block class=" token"> target_col</block><block class="punctuation token">]</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="keyword token">with</block><block class=" token"> converter_train</block><block class="punctuation token">.</block><block class=" token">make_tf_dataset</block><block class="punctuation token">(</block><block class=" token">transform_spec</block><block class="operator token">=</block><block class=" token">tf_spec</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                                     workers_count</block><block class="operator token">=</block><block class=" token">cfg</block><block class="punctuation token">.</block><block class=" token">petastorm_workers_count</block><block class="punctuation token">,</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                                     batch_size</block><block class="operator token">=</block><block class=" token">cfg</block><block class="punctuation token">.</block><block class=" token">batch_size</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                                     prefetch</block><block class="operator token">=</block><block class=" token">cfg</block><block class="punctuation token">.</block><block class=" token">prefetch</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                                     num_epochs</block><block class="operator token">=</block><block class="number token">1</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                                    </block><block class="punctuation token">)</block><block class=" token"> </block><block class="keyword token">as</block><block class=" token"> train_ds</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block><block class="comment token"># Number of steps required to go through one epoch</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        steps_per_epoch </block><block class="operator token">=</block><block class=" token"> </block><block class="builtin token">len</block><block class="punctuation token">(</block><block class=" token">converter_train</block><block class="punctuation token">)</block><block class=" token"> </block><block class="operator token">//</block><block class=" token"> cfg</block><block class="punctuation token">.</block><block class=" token">batch_size</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        normalizer </block><block class="operator token">=</block><block class=" token"> tf</block><block class="punctuation token">.</block><block class=" token">keras</block><block class="punctuation token">.</block><block class=" token">layers</block><block class="punctuation token">.</block><block class=" token">Normalization</block><block class="punctuation token">(</block><block class=" token">axis</block><block class="operator token">=</block><block class="operator token">-</block><block class="number token">1</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        normalizer</block><block class="punctuation token">.</block><block class=" token">adapt</block><block class="punctuation token">(</block><block class=" token">train_ds</block><block class="punctuation token">.</block><block class="builtin token">map</block><block class="punctuation token">(</block><block class="keyword token">lambda</block><block class=" token"> x</block><block class="punctuation token">:</block><block class=" token"> x</block><block class="punctuation token">.</block><block class=" token">features</block><block class="punctuation token">)</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="keyword token">with</block><block class=" token"> converter_train</block><block class="punctuation token">.</block><block class=" token">make_tf_dataset</block><block class="punctuation token">(</block><block class=" token">workers_count</block><block class="operator token">=</block><block class=" token">cfg</block><block class="punctuation token">.</block><block class=" token">petastorm_workers_count</block><block class="punctuation token">,</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                                         batch_size</block><block class="operator token">=</block><block class=" token">cfg</block><block class="punctuation token">.</block><block class=" token">batch_size</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                                         prefetch</block><block class="operator token">=</block><block class=" token">cfg</block><block class="punctuation token">.</block><block class=" token">prefetch</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                                         num_epochs</block><block class="operator token">=</block><block class="boolean token">None</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                                         cur_shard</block><block class="operator token">=</block><block class=" token">hvd</block><block class="punctuation token">.</block><block class=" token">rank</block><block class="punctuation token">(</block><block class="punctuation token">)</block><block class="punctuation token">,</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                                         shard_count</block><block class="operator token">=</block><block class=" token">hvd</block><block class="punctuation token">.</block><block class=" token">size</block><block class="punctuation token">(</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                                        </block><block class="punctuation token">)</block><block class=" token"> </block><block class="keyword token">as</block><block class=" token"> train_ds</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        dataset </block><block class="operator token">=</block><block class=" token"> train_ds</block><block class="punctuation token">.</block><block class="builtin token">map</block><block class="punctuation token">(</block><block class="keyword token">lambda</block><block class=" token"> x</block><block class="punctuation token">:</block><block class=" token"> </block><block class="punctuation token">(</block><block class=" token">x</block><block class="punctuation token">.</block><block class=" token">features</block><block class="punctuation token">,</block><block class=" token"> x</block><block class="punctuation token">.</block><block class=" token">label</block><block class="punctuation token">)</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        steps_per_epoch </block><block class="operator token">=</block><block class=" token"> </block><block class="builtin token">len</block><block class="punctuation token">(</block><block class=" token">converter_train</block><block class="punctuation token">)</block><block class=" token"> </block><block class="operator token">//</block><block class=" token"> </block><block class="punctuation token">(</block><block class=" token">cfg</block><block class="punctuation token">.</block><block class=" token">batch_size</block><block class="operator token">*</block><block class=" token">hvd</block><block class="punctuation token">.</block><block class=" token">size</block><block class="punctuation token">(</block><block class="punctuation token">)</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        model </block><block class="operator token">=</block><block class=" token"> Sequential</block><block class="punctuation token">(</block><block class="punctuation token">[</block><block class=" token">normalizer</block><block class="punctuation token">,</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                            Dense</block><block class="punctuation token">(</block><block class="number token">20</block><block class="punctuation token">,</block><block class=" token"> input_dim</block><block class="operator token">=</block><block class="builtin token">len</block><block class="punctuation token">(</block><block class=" token">feature_cols</block><block class="punctuation token">)</block><block class="punctuation token">,</block><block class=" token"> activation</block><block class="operator token">=</block><block class="string token">"relu"</block><block class="punctuation token">)</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                            Dense</block><block class="punctuation token">(</block><block class="number token">20</block><block class="punctuation token">,</block><block class=" token"> activation</block><block class="operator token">=</block><block class="string token">"relu"</block><block class="punctuation token">)</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                            Dense</block><block class="punctuation token">(</block><block class="number token">1</block><block class="punctuation token">,</block><block class=" token"> activation</block><block class="operator token">=</block><block class="string token">"linear"</block><block class="punctuation token">)</block><block class="punctuation token">]</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                            </block><block class="punctuation token">)</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="comment token">### We need to go further now, with the horovod optimizer, callbacks, and training with this converter_train call</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">      </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block><block class="comment token"># Horovod: adjust learning rate based on number of GPUs/CPUs</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block><block class="comment token">#optimizer = tf.keras.optimizers.Adam(learning_rate=cfg.learning_rate)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        optimizer </block><block class="operator token">=</block><block class=" token"> tf</block><block class="punctuation token">.</block><block class=" token">keras</block><block class="punctuation token">.</block><block class=" token">optimizers</block><block class="punctuation token">.</block><block class=" token">legacy</block><block class="punctuation token">.</block><block class=" token">Adam</block><block class="punctuation token">(</block><block class=" token">learning_rate</block><block class="operator token">=</block><block class=" token">cfg</block><block class="punctuation token">.</block><block class=" token">learning_rate</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block><block class="comment token"># Adding in Distributed Optimizer</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        optimizer </block><block class="operator token">=</block><block class=" token"> hvd</block><block class="punctuation token">.</block><block class=" token">DistributedOptimizer</block><block class="punctuation token">(</block><block class=" token">optimizer</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        model</block><block class="punctuation token">.</block><block class="builtin token">compile</block><block class="punctuation token">(</block><block class=" token">optimizer</block><block class="operator token">=</block><block class=" token">optimizer</block><block class="punctuation token">,</block><block class=" token"> loss</block><block class="operator token">=</block><block class="string token">"mse"</block><block class="punctuation token">,</block><block class=" token"> metrics</block><block class="operator token">=</block><block class="punctuation token">[</block><block class="string token">"mae"</block><block class="punctuation token">]</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block><block class="comment token"># Adding in callbacks</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        callbacks </block><block class="operator token">=</block><block class=" token"> </block><block class="punctuation token">[</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">            </block><block class="comment token"># Horovod: broadcast initial variable states from rank 0 to all other processes.</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">            </block><block class="comment token"># This is necessary to ensure consistent initialization of all workers when</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">            </block><block class="comment token"># training is started with random weights or restored from a checkpoint.</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">            hvd</block><block class="punctuation token">.</block><block class=" token">callbacks</block><block class="punctuation token">.</block><block class=" token">BroadcastGlobalVariablesCallback</block><block class="punctuation token">(</block><block class="number token">0</block><block class="punctuation token">)</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">            </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">            </block><block class="comment token"># Horovod: average metrics among workers at the end of every epoch.</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">            </block><block class="comment token"># Note: This callback must be in the list before the ReduceLROnPlateau,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">            </block><block class="comment token"># TensorBoard or other metrics-based callbacks.</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">            hvd</block><block class="punctuation token">.</block><block class=" token">callbacks</block><block class="punctuation token">.</block><block class=" token">MetricAverageCallback</block><block class="punctuation token">(</block><block class="punctuation token">)</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">            </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">            </block><block class="comment token"># Horovod: using `lr = 1.0 * hvd.size()` from the very beginning leads to worse final</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">            </block><block class="comment token"># accuracy. Scale the learning rate `lr = 1.0` ---&gt; `lr = 1.0 * hvd.size()` during</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">            </block><block class="comment token"># the first five epochs. See https://arxiv.org/abs/1706.02677 for details.</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">            hvd</block><block class="punctuation token">.</block><block class=" token">callbacks</block><block class="punctuation token">.</block><block class=" token">LearningRateWarmupCallback</block><block class="punctuation token">(</block><block class=" token">initial_lr</block><block class="operator token">=</block><block class=" token">cfg</block><block class="punctuation token">.</block><block class=" token">learning_rate</block><block class="operator token">*</block><block class=" token">hvd</block><block class="punctuation token">.</block><block class=" token">size</block><block class="punctuation token">(</block><block class="punctuation token">)</block><block class="punctuation token">,</block><block class=" token"> warmup_epochs</block><block class="operator token">=</block><block class="number token">5</block><block class="punctuation token">,</block><block class=" token"> verbose</block><block class="operator token">=</block><block class=" token">cfg</block><block class="punctuation token">.</block><block class=" token">verbose</block><block class="punctuation token">)</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">            </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">            </block><block class="comment token"># Reduce the learning rate if training plateaus.</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">            tf</block><block class="punctuation token">.</block><block class=" token">keras</block><block class="punctuation token">.</block><block class=" token">callbacks</block><block class="punctuation token">.</block><block class=" token">ReduceLROnPlateau</block><block class="punctuation token">(</block><block class=" token">monitor</block><block class="operator token">=</block><block class="string token">"loss"</block><block class="punctuation token">,</block><block class=" token"> patience</block><block class="operator token">=</block><block class="number token">10</block><block class="punctuation token">,</block><block class=" token"> verbose</block><block class="operator token">=</block><block class="number token">2</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block><block class="punctuation token">]</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block><block class="comment token"># Horovod: save checkpoints only on worker 0 to prevent other workers from corrupting them.</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block><block class="keyword token">if</block><block class=" token"> hvd</block><block class="punctuation token">.</block><block class=" token">rank</block><block class="punctuation token">(</block><block class="punctuation token">)</block><block class=" token"> </block><block class="operator token">==</block><block class=" token"> </block><block class="number token">0</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">            callbacks</block><block class="punctuation token">.</block><block class=" token">append</block><block class="punctuation token">(</block><block class=" token">tf</block><block class="punctuation token">.</block><block class=" token">keras</block><block class="punctuation token">.</block><block class=" token">callbacks</block><block class="punctuation token">.</block><block class=" token">ModelCheckpoint</block><block class="punctuation token">(</block><block class=" token">checkpoint_dir</block><block class="punctuation token">.</block><block class=" token">replace</block><block class="punctuation token">(</block><block class="string token">"dbfs:/"</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"/dbfs/"</block><block class="punctuation token">)</block><block class="punctuation token">,</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                                                                monitor</block><block class="operator token">=</block><block class="string token">"loss"</block><block class="punctuation token">,</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                                                                save_best_only</block><block class="operator token">=</block><block class="boolean token">True</block><block class="punctuation token">)</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">            </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block><block class="comment token"># Here we will do our actual training of the model on each node</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        history </block><block class="operator token">=</block><block class=" token"> model</block><block class="punctuation token">.</block><block class=" token">fit</block><block class="punctuation token">(</block><block class=" token">train_ds</block><block class="punctuation token">,</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                            steps_per_epoch</block><block class="operator token">=</block><block class=" token">steps_per_epoch</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                            epochs</block><block class="operator token">=</block><block class=" token">cfg</block><block class="punctuation token">.</block><block class=" token">epochs</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                            callbacks</block><block class="operator token">=</block><block class=" token">callbacks</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                            verbose</block><block class="operator token">=</block><block class=" token">cfg</block><block class="punctuation token">.</block><block class=" token">verbose</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                            validation_data</block><block class="operator token">=</block><block class=" token">cfg</block><block class="punctuation token">.</block><block class=" token">validation_data</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                           </block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block><block class="comment token"># MLflow Tracking (Log only from Worker 0)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block><block class="keyword token">if</block><block class=" token"> hvd</block><block class="punctuation token">.</block><block class=" token">rank</block><block class="punctuation token">(</block><block class="punctuation token">)</block><block class=" token"> </block><block class="operator token">==</block><block class=" token"> </block><block class="number token">0</block><block class="punctuation token">:</block><block class=" token">    </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">            </block><block class="comment token"># Log events to MLflow</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">            </block><block class="keyword token">with</block><block class=" token"> mlflow</block><block class="punctuation token">.</block><block class=" token">start_run</block><block class="punctuation token">(</block><block class=" token">run_id </block><block class="operator token">=</block><block class=" token"> active_run_id</block><block class="punctuation token">)</block><block class=" token"> </block><block class="keyword token">as</block><block class=" token"> run</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                </block><block class="comment token"># Log MLflow Parameters</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                mlflow</block><block class="punctuation token">.</block><block class=" token">log_param</block><block class="punctuation token">(</block><block class="string token">"num_layers"</block><block class="punctuation token">,</block><block class=" token"> </block><block class="builtin token">len</block><block class="punctuation token">(</block><block class=" token">model</block><block class="punctuation token">.</block><block class=" token">layers</block><block class="punctuation token">)</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                mlflow</block><block class="punctuation token">.</block><block class=" token">log_param</block><block class="punctuation token">(</block><block class="string token">"optimizer_name"</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"Adam"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                mlflow</block><block class="punctuation token">.</block><block class=" token">log_param</block><block class="punctuation token">(</block><block class="string token">"learning_rate"</block><block class="punctuation token">,</block><block class=" token"> cfg</block><block class="punctuation token">.</block><block class=" token">learning_rate</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                mlflow</block><block class="punctuation token">.</block><block class=" token">log_param</block><block class="punctuation token">(</block><block class="string token">"batch_size"</block><block class="punctuation token">,</block><block class=" token"> cfg</block><block class="punctuation token">.</block><block class=" token">batch_size</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                mlflow</block><block class="punctuation token">.</block><block class=" token">log_param</block><block class="punctuation token">(</block><block class="string token">"hvd_size"</block><block class="punctuation token">,</block><block class=" token"> hvd</block><block class="punctuation token">.</block><block class=" token">size</block><block class="punctuation token">(</block><block class="punctuation token">)</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                </block><block class="comment token"># Log MLflow Metrics</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                mlflow</block><block class="punctuation token">.</block><block class=" token">log_metric</block><block class="punctuation token">(</block><block class="string token">"train loss"</block><block class="punctuation token">,</block><block class=" token"> history</block><block class="punctuation token">.</block><block class=" token">history</block><block class="punctuation token">[</block><block class="string token">"loss"</block><block class="punctuation token">]</block><block class="punctuation token">[</block><block class="operator token">-</block><block class="number token">1</block><block class="punctuation token">]</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                </block><block class="comment token"># Log Model</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                mlflow</block><block class="punctuation token">.</block><block class=" token">tensorflow</block><block class="punctuation token">.</block><block class=" token">log_model</block><block class="punctuation token">(</block><block class=" token">model</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"model"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#### Test it out on just the driver (negative sign indicates running on the driver).</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">from</block><block class=" token"> sparkdl </block><block class="keyword token">import</block><block class=" token"> HorovodRunner</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">with</block><block class=" token"> mlflow</block><block class="punctuation token">.</block><block class=" token">start_run</block><block class="punctuation token">(</block><block class="punctuation token">)</block><block class=" token"> </block><block class="keyword token">as</block><block class=" token"> run</block><block class="punctuation token">:</block><block class=" token">  </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="comment token"># Get active run_uuid</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    active_run_id </block><block class="operator token">=</block><block class=" token"> mlflow</block><block class="punctuation token">.</block><block class=" token">active_run</block><block class="punctuation token">(</block><block class="punctuation token">)</block><block class="punctuation token">.</block><block class=" token">info</block><block class="punctuation token">.</block><block class=" token">run_id</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    hvd_np </block><block class="operator token">=</block><block class=" token"> </block><block class="operator token">-</block><block class="number token">1</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    hr </block><block class="operator token">=</block><block class=" token"> HorovodRunner</block><block class="punctuation token">(</block><block class=" token">np</block><block class="operator token">=</block><block class=" token">hvd_np</block><block class="punctuation token">,</block><block class=" token"> driver_log_verbosity</block><block class="operator token">=</block><block class="string token">"all"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    hr</block><block class="punctuation token">.</block><block class=" token">run</block><block class="punctuation token">(</block><block class=" token">run_training_horovod</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#### Run on all workers</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">## OPTIONAL: You can enable Horovod Timeline as follows, but can incur slow down from frequent writes, and have to export out of Databricks to upload to chrome://tracing</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># import os</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># os.environ["HOROVOD_TIMELINE"] = f"{DA.paths.working_dir}/_timeline.json"</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">with</block><block class=" token"> mlflow</block><block class="punctuation token">.</block><block class=" token">start_run</block><block class="punctuation token">(</block><block class="punctuation token">)</block><block class=" token"> </block><block class="keyword token">as</block><block class=" token"> run</block><block class="punctuation token">:</block><block class=" token">  </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="comment token"># Get active run_uuid</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    active_run_id </block><block class="operator token">=</block><block class=" token"> mlflow</block><block class="punctuation token">.</block><block class=" token">active_run</block><block class="punctuation token">(</block><block class="punctuation token">)</block><block class="punctuation token">.</block><block class=" token">info</block><block class="punctuation token">.</block><block class=" token">run_id</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    hvd_np </block><block class="operator token">=</block><block class=" token"> spark</block><block class="punctuation token">.</block><block class=" token">sparkContext</block><block class="punctuation token">.</block><block class=" token">defaultParallelism</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    hr </block><block class="operator token">=</block><block class=" token"> HorovodRunner</block><block class="punctuation token">(</block><block class=" token">np</block><block class="operator token">=</block><block class=" token">hvd_np</block><block class="punctuation token">,</block><block class=" token"> driver_log_verbosity</block><block class="operator token">=</block><block class="string token">"all"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    hr</block><block class="punctuation token">.</block><block class=" token">run</block><block class="punctuation token">(</block><block class=" token">run_training_horovod</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#### Loading Model and Evaluation</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Since we included the Normalization layer inside the model, we can now use this model in production without having to worry about normalization again.</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">from</block><block class=" token"> tensorflow</block><block class="punctuation token">.</block><block class=" token">keras</block><block class="punctuation token">.</block><block class=" token">models </block><block class="keyword token">import</block><block class=" token"> load_model</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">trained_model </block><block class="operator token">=</block><block class=" token"> load_model</block><block class="punctuation token">(</block><block class=" token">checkpoint_dir</block><block class="punctuation token">.</block><block class=" token">replace</block><block class="punctuation token">(</block><block class="string token">"dbfs:/"</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"/dbfs/"</block><block class="punctuation token">)</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">print</block><block class="punctuation token">(</block><block class=" token">trained_model</block><block class="punctuation token">.</block><block class=" token">summary</block><block class="punctuation token">(</block><block class="punctuation token">)</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">trained_model</block><block class="punctuation token">.</block><block class=" token">evaluate</block><block class="punctuation token">(</block><block class=" token">X_test</block><block class="punctuation token">,</block><block class=" token"> y_test</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#### Load model from MLflow run</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">from</block><block class=" token"> sklearn</block><block class="punctuation token">.</block><block class=" token">metrics </block><block class="keyword token">import</block><block class=" token"> mean_squared_error</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">model_uri </block><block class="operator token">=</block><block class=" token"> </block><block class="string-interpolation string token">f"runs:/</block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">run</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">info</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">run_id</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">/model"</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">mlflow_model </block><block class="operator token">=</block><block class=" token"> mlflow</block><block class="punctuation token">.</block><block class=" token">pyfunc</block><block class="punctuation token">.</block><block class=" token">load_model</block><block class="punctuation token">(</block><block class=" token">model_uri</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">y_pred </block><block class="operator token">=</block><block class=" token"> mlflow_model</block><block class="punctuation token">.</block><block class=" token">predict</block><block class="punctuation token">(</block><block class=" token">X_test</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">mean_squared_error</block><block class="punctuation token">(</block><block class=" token">y_test</block><block class="punctuation token">,</block><block class=" token"> y_pred</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#### Leveraging Spark for scalable inference using MLflow's Spark UDF</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">predict </block><block class="operator token">=</block><block class=" token"> mlflow</block><block class="punctuation token">.</block><block class=" token">pyfunc</block><block class="punctuation token">.</block><block class=" token">spark_udf</block><block class="punctuation token">(</block><block class=" token">spark</block><block class="punctuation token">,</block><block class=" token"> model_uri</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">display</block><block class="punctuation token">(</block><block class=" token">test_df</block><block class="punctuation token">.</block><block class=" token">withColumn</block><block class="punctuation token">(</block><block class="string token">"prediction"</block><block class="punctuation token">,</block><block class=" token"> predict</block><block class="punctuation token">(</block><block class="operator token">*</block><block class=" token">feature_cols</block><block class="punctuation token">)</block><block class="punctuation token">)</block><block class="punctuation token">)</block></blocks></line></editarea></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">[</block><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><compositeblock dir="ltr" class="anchor-tag-ref inline" style="font-family: &quot;Computer Modern Serif&quot;, serif; background-color: rgba(155, 155, 155, 0.2);"><a href="#n0.3715415633810799" style="color: inherit; text-decoration: inherit;">Back To Top</a></compositeblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">]</block></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="inline" style="display: block;"><div style="vertical-align: baseline;"><div style="display: inline-block; height: 0px; border-bottom: 1px solid; width: 100%;"></div></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode section sindent-0" data-line-id="n0.3420406311367108" style="font-size: 1.2em; padding-top: 0.5em; padding-bottom: 0.5em; font-weight: bold; line-height: 1.4;" id="n0.3420406311367108" role="heading" aria-level="1"><prefix style="text-align: left; padding-right: 0.5em;">5. </prefix><blocks><baselineblock class="inline"></baselineblock><block>Model Interpretability</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Use </block><block class="role-hyper-link" data-hyper-link-url="https://shap.readthedocs.io/en/latest" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://shap.readthedocs.io/en/latest" target="_blank" style="color: inherit; text-decoration: inherit;">SHAP</a></block><block> to understand which features are most important in the model's prediction for wine quality.</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode section sindent-1" data-line-id="n0.9882978515245113" style="font-size: 1.1em; padding-top: 0.5em; padding-bottom: 0.5em; font-weight: bold; line-height: 1.4;" id="n0.9882978515245113" role="heading" aria-level="2"><prefix style="text-align: left; padding-right: 0.25em;">5.1. </prefix><blocks><baselineblock class="inline"></baselineblock><block>SHAP</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold; color: rgb(255, 64, 0);">SHAP</block><block> (</block><block class="role-hyper-link" data-hyper-link-url="https://github.com/slundberg/shap" style="text-decoration: underline; font-weight: bold; color: rgb(17, 85, 204);"><a href="https://github.com/slundberg/shap" target="_blank" style="color: inherit; text-decoration: inherit;">SHapley Additive exPlanations</a></block><block>) is another approach to explain the output of a machine learning model. </block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>See the </block><block class="role-hyper-link" data-hyper-link-url="http://papers.nips.cc/paper/7062-a-unified-approach-to-interpreting-model-predictions" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="http://papers.nips.cc/paper/7062-a-unified-approach-to-interpreting-model-predictions" target="_blank" style="color: inherit; text-decoration: inherit;">SHAP NIPS</a></block><block> paper for details, and Christoph Molnar's book chapter on Shapley Values.</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Great </block><block class="role-hyper-link" data-hyper-link-url="https://blog.dominodatalab.com/shap-lime-python-libraries-part-1-great-explainers-pros-cons/" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://blog.dominodatalab.com/shap-lime-python-libraries-part-1-great-explainers-pros-cons/" target="_blank" style="color: inherit; text-decoration: inherit;">blog post</a></block><block> comparing </block><block class="role-hyper-link" data-hyper-link-url="https://towardsdatascience.com/lime-explain-machine-learning-predictions-af8f18189bfe" style="text-decoration: underline; font-weight: bold; color: rgb(255, 64, 0);"><a href="https://towardsdatascience.com/lime-explain-machine-learning-predictions-af8f18189bfe" target="_blank" style="color: inherit; text-decoration: inherit;">LIME</a></block><block> (another model explainability method) to SHAP. </block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="background-color: rgb(255, 254, 0);">SHAP provides greater theoretical guarantees than LIME, but at the cost of additional compute.</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 623.595px; height: 233.75px; position: relative;"><img src="image-resources/b4a42d67-d776-4157-9e0b-1f96ee3a9629.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://christophm.github.io/interpretable-ml-book/shapley.html" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://christophm.github.io/interpretable-ml-book/shapley.html" target="_blank" style="color: inherit; text-decoration: inherit;">Great read on Shapley values</a></block><block>.</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item full-line-block-inside" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="code-section-symbol inline" style="display: block;"><div class="code-section theme-tomorrow-night" style="display: block; border: 1px solid lightgray; background: rgb(45, 45, 45); padding: 10px; font-size: 10px;"><editarea class="text-mode code-section-edit-area" style="font-family: &quot;Fira code&quot;, &quot;Fira Mono&quot;, monospace;"><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">import</block><block class=" token"> shap</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="builtin token">help</block><block class="punctuation token">(</block><block class=" token">shap</block><block class="punctuation token">.</block><block class=" token">DeepExplainer</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Help on class Deep in module shap.explainers._deep:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># class Deep(shap.explainers._explainer.Explainer)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |  Deep(model, data, session=None, learning_phase_flags=None)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |  </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |  Meant to approximate SHAP values for deep learning models.</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |  </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |  This is an enhanced version of the DeepLIFT algorithm (Deep SHAP) where, similar to Kernel SHAP, we</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |  approximate the conditional expectations of SHAP values using a selection of background samples.</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |  Lundberg and Lee, NIPS 2017 showed that the per node attribution rules in DeepLIFT (Shrikumar,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |  Greenside, and Kundaje, arXiv 2017) can be chosen to approximate Shapley values. By integrating</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |  over many backgound samples Deep estimates approximate SHAP values such that they sum</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |  up to the difference between the expected model output on the passed background samples and the</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |  current model output (f(x) - E[f(x)]).</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |  </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |  Examples</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |  --------</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |  See :ref:`Deep Explainer Examples &lt;deep_explainer_examples&gt;`</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |  </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |  Method resolution order:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |      Deep</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |      shap.explainers._explainer.Explainer</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |      shap._serializable.Serializable</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |      builtins.object</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |  </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |  Methods defined here:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |  </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |  __init__(self, model, data, session=None, learning_phase_flags=None)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |      An explainer object for a differentiable model using a given background dataset.</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |      </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |      Note that the complexity of the method scales linearly with the number of background data</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |      samples. Passing the entire training dataset as `data` will give very accurate expected</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |      values, but be unreasonably expensive. The variance of the expectation estimates scale by</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |      roughly 1/sqrt(N) for N background data samples. So 100 samples will give a good estimate,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |      and 1000 samples a very good estimate of the expected values.</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |      </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |      Parameters</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |      ----------</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |      model : if framework == 'tensorflow', (input : [tf.Tensor], output : tf.Tensor)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |           A pair of TensorFlow tensors (or a list and a tensor) that specifies the input and</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |          output of the model to be explained. Note that SHAP values are specific to a single</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |          output value, so the output tf.Tensor should be a single dimensional output (,1).</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |      </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |          if framework == 'pytorch', an nn.Module object (model), or a tuple (model, layer),</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |              where both are nn.Module objects</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |          The model is an nn.Module object which takes as input a tensor (or list of tensors) of</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |          shape data, and returns a single dimensional output.</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |          If the input is a tuple, the returned shap values will be for the input of the</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |          layer argument. layer must be a layer in the model, i.e. model.conv2</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |      </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |      data :</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |          if framework == 'tensorflow': [numpy.array] or [pandas.DataFrame]</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |          if framework == 'pytorch': [torch.tensor]</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |          The background dataset to use for integrating out features. Deep integrates</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |          over these samples. The data passed here must match the input tensors given in the</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |          first argument. Note that since these samples are integrated over for each sample you</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |          should only something like 100 or 1000 random background samples, not the whole training</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |          dataset.</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |      </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |      if framework == 'tensorflow':</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |      </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |      session : None or tensorflow.Session</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |          The TensorFlow session that has the model we are explaining. If None is passed then</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |          we do our best to find the right session, first looking for a keras session, then</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |          falling back to the default TensorFlow session.</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |      </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |      learning_phase_flags : None or list of tensors</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |          If you have your own custom learning phase flags pass them here. When explaining a prediction</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |          we need to ensure we are not in training mode, since this changes the behavior of ops like</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |          batch norm or dropout. If None is passed then we look for tensors in the graph that look like</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |          learning phase flags (this works for Keras models). Note that we assume all the flags should</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |          have a value of False during predictions (and hence explanations).</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |  </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |  shap_values(self, X, ranked_outputs=None, output_rank_order='max', check_additivity=True)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |      Return approximate SHAP values for the model applied to the data given by X.</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |      </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |      Parameters</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |      ----------</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |      X : list,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |          if framework == 'tensorflow': numpy.array, or pandas.DataFrame</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |          if framework == 'pytorch': torch.tensor</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |          A tensor (or list of tensors) of samples (where X.shape[0] == # samples) on which to</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |          explain the model's output.</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |      </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |      ranked_outputs : None or int</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |          If ranked_outputs is None then we explain all the outputs in a multi-output model. If</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |          ranked_outputs is a positive integer then we only explain that many of the top model</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |          outputs (where "top" is determined by output_rank_order). Note that this causes a pair</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |          of values to be returned (shap_values, indexes), where shap_values is a list of numpy</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |          arrays for each of the output ranks, and indexes is a matrix that indicates for each sample</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |          which output indexes were choses as "top".</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |      </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |      output_rank_order : "max", "min", or "max_abs"</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |          How to order the model outputs when using ranked_outputs, either by maximum, minimum, or</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |          maximum absolute value.</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |      </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |      Returns</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |      -------</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |      array or list</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |          For a models with a single output this returns a tensor of SHAP values with the same shape</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |          as X. For a model with multiple outputs this returns a list of SHAP value tensors, each of</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |          which are the same shape as X. If ranked_outputs is None then this list of tensors matches</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |          the number of model outputs. If ranked_outputs is a positive integer a pair is returned</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |          (shap_values, indexes), where shap_values is a list of tensors with a length of</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |          ranked_outputs, and indexes is a matrix that indicates for each sample which output indexes</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |          were chosen as "top".</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |  </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |  ----------------------------------------------------------------------</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |  Methods inherited from shap.explainers._explainer.Explainer:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |  </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |  __call__(self, *args, max_evals='auto', main_effects=False, error_bounds=False, batch_size='auto', outputs=None, silent=False, **kwargs)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |      Explains the output of model(*args), where args is a list of parallel iteratable datasets.</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |      </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |      Note this default version could be an abstract method that is implemented by each algorithm-specific</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |      subclass of Explainer. Descriptions of each subclasses' __call__ arguments</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |      are available in their respective doc-strings.</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |  </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |  explain_row(self, *row_args, max_evals, main_effects, error_bounds, outputs, silent, **kwargs)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |      Explains a single row and returns the tuple (row_values, row_expected_values, row_mask_shapes, main_effects).</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |      </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |      This is an abstract method meant to be implemented by each subclass.</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |      </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |      Returns</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |      -------</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |      tuple</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |          A tuple of (row_values, row_expected_values, row_mask_shapes), where row_values is an array of the</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |          attribution values for each sample, row_expected_values is an array (or single value) representing</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |          the expected value of the model for each sample (which is the same for all samples unless there</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |          are fixed inputs present, like labels when explaining the loss), and row_mask_shapes is a list</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |          of all the input shapes (since the row_values is always flattened),</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |  </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |  save(self, out_file, model_saver='.save', masker_saver='.save')</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |      Write the explainer to the given file stream.</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |  </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |  ----------------------------------------------------------------------</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |  Class methods inherited from shap.explainers._explainer.Explainer:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |  </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |  load(in_file, model_loader=&lt;bound method Model.load of &lt;class 'shap.models._model.Model'&gt;&gt;, masker_loader=&lt;bound method Serializable.load of &lt;class 'shap.maskers._masker.Masker'&gt;&gt;, instantiate=True) from builtins.type</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |      Load an Explainer from the given file stream.</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |      </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |      Parameters</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |      ----------</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |      in_file : The file stream to load objects from.</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |  </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |  ----------------------------------------------------------------------</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |  Static methods inherited from shap.explainers._explainer.Explainer:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |  </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |  supports_model_with_masker(model, masker)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |      Determines if this explainer can handle the given model.</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |      </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |      This is an abstract static method meant to be implemented by each subclass.</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |  </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |  ----------------------------------------------------------------------</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |  Data descriptors inherited from shap._serializable.Serializable:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |  </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |  __dict__</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |      dictionary for instance variables (if defined)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |  </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |  __weakref__</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  |      list of weak references to the object (if defined)</block></blocks></line></editarea></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item full-line-block-inside" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="code-section-symbol inline" style="display: block;"><div class="code-section theme-tomorrow-night" style="display: block; border: 1px solid lightgray; background: rgb(45, 45, 45); padding: 10px; font-size: 12px;"><editarea class="text-mode code-section-edit-area" style="font-family: &quot;Fira code&quot;, &quot;Fira Mono&quot;, monospace;"><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">import</block><block class=" token"> numpy </block><block class="keyword token">as</block><block class=" token"> np</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">shap</block><block class="punctuation token">.</block><block class=" token">initjs</block><block class="punctuation token">(</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">shap_explainer </block><block class="operator token">=</block><block class=" token"> shap</block><block class="punctuation token">.</block><block class=" token">DeepExplainer</block><block class="punctuation token">(</block><block class=" token">model</block><block class="punctuation token">,</block><block class=" token"> X_train</block><block class="punctuation token">[</block><block class="punctuation token">:</block><block class="number token">200</block><block class="punctuation token">]</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">base_value </block><block class="operator token">=</block><block class=" token"> model</block><block class="punctuation token">.</block><block class=" token">predict</block><block class="punctuation token">(</block><block class=" token">X_train</block><block class="punctuation token">)</block><block class="punctuation token">.</block><block class=" token">mean</block><block class="punctuation token">(</block><block class="punctuation token">)</block><block class=" token"> </block><block class="comment token"># base value = average prediction</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">shap_values </block><block class="operator token">=</block><block class=" token"> shap_explainer</block><block class="punctuation token">.</block><block class=" token">shap_values</block><block class="punctuation token">(</block><block class=" token">X_test</block><block class="punctuation token">[</block><block class="number token">0</block><block class="punctuation token">:</block><block class="number token">1</block><block class="punctuation token">]</block><block class="punctuation token">.</block><block class=" token">to_numpy</block><block class="punctuation token">(</block><block class="punctuation token">)</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">y_pred </block><block class="operator token">=</block><block class=" token"> model</block><block class="punctuation token">.</block><block class=" token">predict</block><block class="punctuation token">(</block><block class=" token">X_test</block><block class="punctuation token">[</block><block class="number token">0</block><block class="punctuation token">:</block><block class="number token">1</block><block class="punctuation token">]</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">print</block><block class="punctuation token">(</block><block class="string-interpolation string token">f"Actual rating: </block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">y_test</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">values</block><block class="string-interpolation interpolation punctuation token">[</block><block class="string-interpolation interpolation number token">0</block><block class="string-interpolation interpolation punctuation token">]</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">, Predicted rating: </block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">y_pred</block><block class="string-interpolation interpolation punctuation token">[</block><block class="string-interpolation interpolation number token">0</block><block class="string-interpolation interpolation punctuation token">]</block><block class="string-interpolation interpolation punctuation token">[</block><block class="string-interpolation interpolation number token">0</block><block class="string-interpolation interpolation punctuation token">]</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                   </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Saving to File b/c can't display IFrame directly in Databricks: https://github.com/slundberg/shap/issues/101</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">file_path </block><block class="operator token">=</block><block class=" token"> </block><block class="string token">"/tmp/shap.html"</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">shap</block><block class="punctuation token">.</block><block class=" token">save_html</block><block class="punctuation token">(</block><block class=" token">file_path</block><block class="punctuation token">,</block><block class=" token"> shap</block><block class="punctuation token">.</block><block class=" token">force_plot</block><block class="punctuation token">(</block><block class=" token">base_value</block><block class="punctuation token">,</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                                          shap_values</block><block class="punctuation token">[</block><block class="number token">0</block><block class="punctuation token">]</block><block class="punctuation token">,</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                                          features</block><block class="operator token">=</block><block class=" token">X_test</block><block class="punctuation token">[</block><block class="number token">0</block><block class="punctuation token">:</block><block class="number token">1</block><block class="punctuation token">]</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                                          feature_names</block><block class="operator token">=</block><block class=" token">X_test</block><block class="punctuation token">.</block><block class=" token">columns</block><block class="punctuation token">,</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                                          show</block><block class="operator token">=</block><block class="boolean token">False</block><block class="punctuation token">)</block><block class="punctuation token">)</block></blocks></line></editarea></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">[</block><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><compositeblock dir="ltr" class="anchor-tag-ref inline" style="font-family: &quot;Computer Modern Serif&quot;, serif; background-color: rgba(155, 155, 155, 0.2);"><a href="#n0.3715415633810799" style="color: inherit; text-decoration: inherit;">Back To Top</a></compositeblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">]</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode section sindent-2" data-line-id="n0.5165138824355573" style="font-size: 1em; padding-top: 0.5em; padding-bottom: 0.5em; font-weight: bold; line-height: 1.4;" id="n0.5165138824355573" role="heading" aria-level="3"><prefix style="text-align: left; padding-right: 0em;">5.1.1. </prefix><blocks><baselineblock class="inline"></baselineblock><block>Visualize </block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="background-color: rgb(255, 254, 0);">Red pixels increase the model's output while blue pixels decrease the output</block><block>.</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Here's a </block><block class="role-hyper-link" data-hyper-link-url="https://christophm.github.io/interpretable-ml-book/shapley.html" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://christophm.github.io/interpretable-ml-book/shapley.html" target="_blank" style="color: inherit; text-decoration: inherit;">great article</a></block><block> discussing how SHAP works under the hood.</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold;">From the </block><block class="role-hyper-link" data-hyper-link-url="https://proceedings.neurips.cc/paper/2017/file/8a20a8621978632d76c43dfd28b67767-Paper.pdf" style="text-decoration: underline; font-weight: bold; color: rgb(17, 85, 204);"><a href="https://proceedings.neurips.cc/paper/2017/file/8a20a8621978632d76c43dfd28b67767-Paper.pdf" target="_blank" style="color: inherit; text-decoration: inherit;">original SHAP paper</a></block><block style="font-weight: bold;">:</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold;">Base value</block><block> is the value that would be predicted if we did not know any features for the current output.</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>In other words, </block><block style="text-decoration: underline;">it is the mean prediction</block><block>.</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold;">Red/Blue:</block><block> Features that push the prediction higher (to the right) are shown in red, and those pushing the prediction lower are shown in blue.</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item full-line-block-inside" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="code-section-symbol inline" style="display: block;"><div class="code-section theme-tomorrow-night" style="display: block; border: 1px solid lightgray; background: rgb(45, 45, 45); padding: 10px; font-size: 12px;"><editarea class="text-mode code-section-edit-area" style="font-family: &quot;Fira code&quot;, &quot;Fira Mono&quot;, monospace;"><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">import</block><block class=" token"> codecs</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">f </block><block class="operator token">=</block><block class=" token"> codecs</block><block class="punctuation token">.</block><block class="builtin token">open</block><block class="punctuation token">(</block><block class=" token">file_path</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"r"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">displayHTML</block><block class="punctuation token">(</block><block class=" token">f</block><block class="punctuation token">.</block><block class=" token">read</block><block class="punctuation token">(</block><block class="punctuation token">)</block><block class="punctuation token">)</block></blocks></line></editarea></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 733.992px; height: 90.75px; position: relative;"><img src="image-resources/d3797f49-c9e7-4490-b13e-7573563c237e.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div data-caption-block-id="n0.0705615694996995" class="role-image-caption-container role-caption-container" style="display: flex; align-items: center; justify-content: center; margin-top: 10px;" id="n0.0705615694996995"><span class="no-print-outline" style="outline: none; position: relative; text-align: center;"><span class="role-image-caption-prefix" style="padding-right: 0.3em; font-weight: bold;"><span class="role-image-caption-name">Figure</span><span class="role-image-caption-number"><!-- react-text: 10941 --> <!-- /react-text --><!-- react-text: 10942 -->3<!-- /react-text --></span><span>:</span></span><editarea class="image-caption text-mode" style="min-width: 50px; display: inline;"><line class="text-mode align-center" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-size: 0.8em;">The values on the bottom show the true values of </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; font-size: 0.8em; font-weight: bold;">X_test[0]</block></blocks></line></editarea></span></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item full-line-block-inside" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="code-section-symbol inline" style="display: block;"><div class="code-section theme-tomorrow-night" style="display: block; border: 1px solid lightgray; background: rgb(45, 45, 45); padding: 10px; font-size: 12px;"><editarea class="text-mode code-section-edit-area" style="font-family: &quot;Fira code&quot;, &quot;Fira Mono&quot;, monospace;"><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">import</block><block class=" token"> pandas </block><block class="keyword token">as</block><block class=" token"> pd</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">pd</block><block class="punctuation token">.</block><block class=" token">DataFrame</block><block class="punctuation token">(</block><block class=" token">X_test</block><block class="punctuation token">.</block><block class=" token">to_numpy</block><block class="punctuation token">(</block><block class="punctuation token">)</block><block class="punctuation token">[</block><block class="number token">0</block><block class="punctuation token">]</block><block class="punctuation token">,</block><block class=" token"> X_test</block><block class="punctuation token">.</block><block class=" token">columns</block><block class="punctuation token">,</block><block class=" token"> </block><block class="punctuation token">[</block><block class="string token">"features"</block><block class="punctuation token">]</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">shap_features </block><block class="operator token">=</block><block class=" token"> pd</block><block class="punctuation token">.</block><block class=" token">DataFrame</block><block class="punctuation token">(</block><block class=" token">shap_values</block><block class="punctuation token">[</block><block class="number token">0</block><block class="punctuation token">]</block><block class="punctuation token">[</block><block class="number token">0</block><block class="punctuation token">]</block><block class="punctuation token">,</block><block class=" token"> X_test</block><block class="punctuation token">.</block><block class=" token">columns</block><block class="punctuation token">,</block><block class=" token"> </block><block class="punctuation token">[</block><block class="string token">"features"</block><block class="punctuation token">]</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">shap_features</block><block class="punctuation token">.</block><block class=" token">sort_values</block><block class="punctuation token">(</block><block class="string token">"features"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">shap</block><block class="punctuation token">.</block><block class=" token">summary_plot</block><block class="punctuation token">(</block><block class=" token">shap_values</block><block class="punctuation token">[</block><block class="number token">0</block><block class="punctuation token">]</block><block class="punctuation token">,</block><block class=" token"> X_test</block><block class="punctuation token">,</block><block class=" token"> plot_type</block><block class="operator token">=</block><block class="string token">"bar"</block><block class="punctuation token">,</block><block class=" token"> feature_names</block><block class="operator token">=</block><block class=" token">X_test</block><block class="punctuation token">.</block><block class=" token">columns</block><block class="punctuation token">)</block></blocks></line></editarea></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 536.8px; height: 387.99px; position: relative;"><img src="image-resources/25daa54c-8c94-47f1-8797-e945d80ef11d.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">[</block><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><compositeblock dir="ltr" class="anchor-tag-ref inline" style="font-family: &quot;Computer Modern Serif&quot;, serif; background-color: rgba(155, 155, 155, 0.2);"><a href="#n0.3715415633810799" style="color: inherit; text-decoration: inherit;">Back To Top</a></compositeblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">]</block></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="inline" style="display: block;"><div style="vertical-align: baseline;"><div style="display: inline-block; height: 0px; border-bottom: 1px solid; width: 100%;"></div></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode section sindent-0" data-line-id="n0.5222750491828694" style="font-size: 1.2em; padding-top: 0.5em; padding-bottom: 0.5em; font-weight: bold; line-height: 1.4;" id="n0.5222750491828694" role="heading" aria-level="1"><prefix style="text-align: left; padding-right: 0.5em;">6. </prefix><blocks><baselineblock class="inline"></baselineblock><block>Convolutional Neural Networks (CNN)</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold;">Note:</block><block> We're not going to cover CNN theory here.</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://setosa.io/ev/image-kernels/" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://setosa.io/ev/image-kernels/" target="_blank" style="color: inherit; text-decoration: inherit;">Image kernels</a></block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://cs231n.github.io/convolutional-networks/" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://cs231n.github.io/convolutional-networks/" target="_blank" style="color: inherit; text-decoration: inherit;">CS231n Convolutional Neural Networks for Visual Recognition (Stanford)</a></block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://karpathy.github.io/2015/03/30/breaking-convnets/" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://karpathy.github.io/2015/03/30/breaking-convnets/" target="_blank" style="color: inherit; text-decoration: inherit;">Breaking Linear Classifiers on ImageNet, Andrej Karpathy</a></block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://static.googleusercontent.com/media/research.google.com/en//pubs/archive/43022.pdf" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://static.googleusercontent.com/media/research.google.com/en//pubs/archive/43022.pdf" target="_blank" style="color: inherit; text-decoration: inherit;">Going deeper with convolutions</a></block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold; background-color: rgb(255, 254, 0);">Larger, newer models != better</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://arxiv.org/abs/2103.14749" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://arxiv.org/abs/2103.14749" target="_blank" style="color: inherit; text-decoration: inherit;">MIT and Amazon researchers</a></block><block> found ~3.4% errors across 10 benchmarking datasets. Label errors documented here: </block><block class="role-hyper-link" data-hyper-link-url="https://labelerrors.com/" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://labelerrors.com/" target="_blank" style="color: inherit; text-decoration: inherit;">https://labelerrors.com</a></block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 543px; height: 369.89px; position: relative;"><img src="image-resources/3dcc8813-8855-4710-a335-a313f875bafa.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold; background-color: rgb(255, 254, 0);">Detrimental imapct of errors increases with model size</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="color: rgb(255, 64, 0); font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold; color: rgb(255, 64, 0);">Lower-capacity models</block></blocks></line><line class="root text-mode indent-2 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="3"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;">* </prefix><blocks><baselineblock class="inline"></baselineblock><block>Provide regularization benefits</block></blocks></line><line class="root text-mode indent-2 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="3"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;">* </prefix><blocks><baselineblock class="inline"></baselineblock><block>Are more resistant to learning asymmetric distribution of noisy labels</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="color: rgb(255, 64, 0); font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold; color: rgb(255, 64, 0);">Large models overfit to</block></blocks></line><line class="root text-mode indent-2 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="3"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;">* </prefix><blocks><baselineblock class="inline"></baselineblock><block>Specific benchmarks</block></blocks></line><line class="root text-mode indent-2 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="3"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;">* </prefix><blocks><baselineblock class="inline"></baselineblock><block>Quirks of the original label annotators</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="color: rgb(255, 64, 0); font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold; color: rgb(255, 64, 0);">Implications</block></blocks></line><line class="root text-mode indent-2 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="3"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;">* </prefix><blocks><baselineblock class="inline"></baselineblock><block>We only see the original test accuracy</block></blocks></line><line class="root text-mode indent-2 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="3"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;">* </prefix><blocks><baselineblock class="inline"></baselineblock><block>But we should pick our models based on the corrected test accuracy</block></blocks></line><line class="root text-mode indent-2 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="3"><prefix style="font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left;">* </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold; background-color: rgb(255, 254, 0);">SOTA on research data != SOTA on real production data</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>In this section, we will use pre-trained Convolutional Neural Networks (CNNs), trained with the image dataset from ImageNet, to make scalable predictions with </block><block style="font-weight: bold; color: rgb(255, 64, 0);">Pandas Scalar Iterator UDFs</block><block>.</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>We are going to start with the </block><block style="font-weight: bold; color: rgb(144, 19, 254);">VGG16</block><block> model, which was introduced by Simonyan and Zisserman in their 2014 paper </block><block class="role-hyper-link" data-hyper-link-url="https://arxiv.org/abs/1409.1556" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://arxiv.org/abs/1409.1556" target="_blank" style="color: inherit; text-decoration: inherit;">Very Deep Convolutional Networks for Large Scale Image Recognition</a></block><block>.</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item full-line-block-inside" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="code-section-symbol inline" style="display: block;"><div class="code-section theme-tomorrow-night" style="display: block; border: 1px solid lightgray; background: rgb(45, 45, 45); padding: 10px; font-size: 10px;"><editarea class="text-mode code-section-edit-area" style="font-family: &quot;Fira code&quot;, &quot;Fira Mono&quot;, monospace;"><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">from</block><block class=" token"> tensorflow</block><block class="punctuation token">.</block><block class=" token">keras</block><block class="punctuation token">.</block><block class=" token">preprocessing </block><block class="keyword token">import</block><block class=" token"> image</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">from</block><block class=" token"> tensorflow</block><block class="punctuation token">.</block><block class=" token">keras</block><block class="punctuation token">.</block><block class=" token">applications</block><block class="punctuation token">.</block><block class=" token">vgg16 </block><block class="keyword token">import</block><block class=" token"> preprocess_input</block><block class="punctuation token">,</block><block class=" token"> decode_predictions</block><block class="punctuation token">,</block><block class=" token"> VGG16</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">import</block><block class=" token"> numpy </block><block class="keyword token">as</block><block class=" token"> np</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">vgg16_model </block><block class="operator token">=</block><block class=" token"> VGG16</block><block class="punctuation token">(</block><block class=" token">weights</block><block class="operator token">=</block><block class="string token">"imagenet"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">vgg16_model</block><block class="punctuation token">.</block><block class=" token">summary</block><block class="punctuation token">(</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Model: "vgg16"</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># _________________________________________________________________</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  Layer (type)                Output Shape              Param #   </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># =================================================================</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  input_1 (InputLayer)        [(None, 224, 224, 3)]     0                                                                       </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  block1_conv1 (Conv2D)       (None, 224, 224, 64)      1792      </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                                                                 </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># ...      </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                                                                 </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  fc1 (Dense)                 (None, 4096)              102764544 </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                                                                 </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  fc2 (Dense)                 (None, 4096)              16781312  </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                                                                 </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  predictions (Dense)         (None, 1000)              4097000   </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                                                                 </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># =================================================================</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Total params: 138,357,544</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Trainable params: 138,357,544</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Non-trainable params: 0</block></blocks></line></editarea></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">[</block><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><compositeblock dir="ltr" class="anchor-tag-ref inline" style="font-family: &quot;Computer Modern Serif&quot;, serif; background-color: rgba(155, 155, 155, 0.2);"><a href="#n0.3715415633810799" style="color: inherit; text-decoration: inherit;">Back To Top</a></compositeblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">]</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode section sindent-1" data-line-id="n0.9266219639735855" style="font-size: 1.1em; padding-top: 0.5em; padding-bottom: 0.5em; font-weight: bold; line-height: 1.4;" id="n0.9266219639735855" role="heading" aria-level="2"><prefix style="text-align: left; padding-right: 0.25em;">6.1. </prefix><blocks><baselineblock class="inline"></baselineblock><block>InceptionV3 + Batch Normalization</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>In 2016, developers from </block><block class="role-hyper-link" data-hyper-link-url="https://www.cv-foundation.org/openaccess/content_cvpr_2016/papers/Szegedy_Rethinking_the_Inception_CVPR_2016_paper.pdf" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://www.cv-foundation.org/openaccess/content_cvpr_2016/papers/Szegedy_Rethinking_the_Inception_CVPR_2016_paper.pdf" target="_blank" style="color: inherit; text-decoration: inherit;">Google published a paper</a></block><block> updating their </block><block style="font-weight: bold; color: rgb(255, 64, 0);">Inception architecture</block><block> with a </block><block style="text-decoration: underline;">number of optimizations</block><block>. This included a technique known as </block><block style="font-weight: bold;">batch normalization</block><block>.</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://cloud.google.com/tpu/docs/inception-v3-advanced" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://cloud.google.com/tpu/docs/inception-v3-advanced" target="_blank" style="color: inherit; text-decoration: inherit;">Advanced guide to Inception V3</a></block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://github.com/tensorflow/models/tree/master/research" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://github.com/tensorflow/models/tree/master/research" target="_blank" style="color: inherit; text-decoration: inherit;">TensorFlow model garden</a></block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 678.5px; height: 265.97px; position: relative;"><img src="image-resources/8d916f74-ed82-46c0-ba14-fade8e4b3184.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold; color: rgb(255, 64, 0);">Batch normalization</block><block> is a technique that applies to very deep neural networks (</block><block style="background-color: rgb(255, 254, 0);">especially CNNs</block><block>) that </block><block style="text-decoration: underline;">standardizes the inputs to a layer for each mini-batch</block><block>. </block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Generally speaking, this </block><block style="background-color: rgb(255, 254, 0);">reduces the number of training epochs needed by stabilizing the learning process</block><block>.</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 481.191px; height: 338.29px; position: relative;"><img src="image-resources/607c78ea-10b9-4fb3-97ec-cb1ec730b038.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold;">There are two main hypotheses for why this works:</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Each layer in a deep neural network (with 10+ layers, for instance) </block><block style="text-decoration: underline;">expects the inputs from the previous layer to come from the same distribution</block><block>. </block></blocks></line><line class="root text-mode indent-2 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="3"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;">* </prefix><blocks><baselineblock class="inline"></baselineblock><block>However, </block><block style="text-decoration: underline;">in practice each layer is being updated, changing the distribution of its output to the next layer</block><block>. </block></blocks></line><line class="root text-mode indent-2 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="3"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;">* </prefix><blocks><baselineblock class="inline"></baselineblock><block>This is called </block><block style="font-weight: bold; color: rgb(78, 166, 78);">"internal covariate shift"</block><block> and can result in an </block><block style="text-decoration: underline;">unstable learning process</block><block> since each layer is effectively learning a moving target.</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>This technique </block><block style="background-color: rgb(255, 254, 0);">smoothes objective function</block><block> and thereby improves the learning process.</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold; font-style: italic; background-color: rgb(255, 254, 0);">Batch normalization</block><block style="font-weight: bold; background-color: rgb(255, 254, 0);"> should generally not be used with dropout, another regularization technique</block><block> (discussed in the GANs notebook). </block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>While there's some contention over which is a more effective method </block><block class="role-hyper-link" data-hyper-link-url="https://link.springer.com/article/10.1007/s11042-019-08453-9" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://link.springer.com/article/10.1007/s11042-019-08453-9" target="_blank" style="color: inherit; text-decoration: inherit;">see this paper</a></block><block> for details, </block><block style="background-color: rgb(255, 254, 0);">batch normalization is generally preferred over dropout for deep neural networks</block><block>.</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://towardsdatascience.com/an-intuitive-guide-to-deep-network-architectures-65fdc477db41#:~:text=Xception%20slightly%20outperforms%20Inception%20v3,implying%20a%20greater%20computational%20efficiency" style="text-decoration: underline; font-weight: bold; color: rgb(255, 64, 0);"><a href="https://towardsdatascience.com/an-intuitive-guide-to-deep-network-architectures-65fdc477db41#:~:text=Xception%20slightly%20outperforms%20Inception%20v3,implying%20a%20greater%20computational%20efficiency" target="_blank" style="color: inherit; text-decoration: inherit;">XCeption</a></block><block class="role-hyper-link" data-hyper-link-url="https://towardsdatascience.com/an-intuitive-guide-to-deep-network-architectures-65fdc477db41#:~:text=Xception%20slightly%20outperforms%20Inception%20v3,implying%20a%20greater%20computational%20efficiency" style="text-decoration: underline; font-weight: bold; color: rgb(17, 85, 204);"><a href="https://towardsdatascience.com/an-intuitive-guide-to-deep-network-architectures-65fdc477db41#:~:text=Xception%20slightly%20outperforms%20Inception%20v3,implying%20a%20greater%20computational%20efficiency" target="_blank" style="color: inherit; text-decoration: inherit;"> (Extreme Inception) - 2017</a></block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="font-style: italic; flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-style: italic;">Cross-channel correlations and spatial correlations are sufficiently decoupled that it is preferable not to map them jointly.</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 483.2px; height: 357.03px; position: relative;"><img src="image-resources/98233800-443f-4c9f-8c61-76e62bfe85ed.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 691.192px; height: 377.13px; position: relative;"><img src="image-resources/4e52f73d-a16e-4d9e-9b5f-e7131c2eaee3.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Let's load the Inception V3 model to compare architectures with </block><block style="font-weight: bold;">VGG16</block><block>.</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item full-line-block-inside" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="code-section-symbol inline" style="display: block;"><div class="code-section theme-tomorrow-night" style="display: block; border: 1px solid lightgray; background: rgb(45, 45, 45); padding: 10px; font-size: 8px;"><editarea class="text-mode code-section-edit-area" style="font-family: &quot;Fira code&quot;, &quot;Fira Mono&quot;, monospace;"><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">from</block><block class=" token"> tensorflow</block><block class="punctuation token">.</block><block class=" token">keras</block><block class="punctuation token">.</block><block class=" token">applications</block><block class="punctuation token">.</block><block class=" token">inception_v3 </block><block class="keyword token">import</block><block class=" token"> InceptionV3</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">inception_model </block><block class="operator token">=</block><block class=" token"> InceptionV3</block><block class="punctuation token">(</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">inception_model</block><block class="punctuation token">.</block><block class=" token">summary</block><block class="punctuation token">(</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Model: "inception_v3"</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># __________________________________________________________________________________________________</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  Layer (type)                   Output Shape         Param #     Connected to                     </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># ==================================================================================================</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  input_2 (InputLayer)           [(None, 299, 299, 3  0           []                               </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#                                 )]                                                                </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                                                                                                  </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># .....                                                                                                           </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                                                                                                  </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  predictions (Dense)            (None, 1000)         2049000     ['avg_pool[0][0]']               </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                                                                                                  </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># ==================================================================================================</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Total params: 23,851,784</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Trainable params: 23,817,352</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Non-trainable params: 34,432</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line></editarea></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold; background-color: rgb(255, 254, 0);">Note:</block><block> Looking for more reference architectures? Check out </block><block class="role-hyper-link" data-hyper-link-url="https://www.tensorflow.org/api_docs/python/tf/keras/applications" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://www.tensorflow.org/api_docs/python/tf/keras/applications" target="_blank" style="color: inherit; text-decoration: inherit;">tf.keras.applications for what's available out of the box</a></block><block>.</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">[</block><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><compositeblock dir="ltr" class="anchor-tag-ref inline" style="font-family: &quot;Computer Modern Serif&quot;, serif; background-color: rgba(155, 155, 155, 0.2);"><a href="#n0.3715415633810799" style="color: inherit; text-decoration: inherit;">Back To Top</a></compositeblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">]</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode section sindent-1" data-line-id="n0.06289071821290926" style="font-size: 1.1em; padding-top: 0.5em; padding-bottom: 0.5em; font-weight: bold; line-height: 1.4;" id="n0.06289071821290926" role="heading" aria-level="2"><prefix style="text-align: left; padding-right: 0.25em;">6.2. </prefix><blocks><baselineblock class="inline"></baselineblock><block>Apply pre-trained model</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>We are going to make a helper method to resize our images to be 224 x 224, and output the top 3 classes for a given image. This is the expected input shape for VGG16.</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>In TensorFlow, it represents the images in a channels-last manner: (samples, height, width, color_depth)</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item full-line-block-inside" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="code-section-symbol inline" style="display: block;"><div class="code-section theme-tomorrow-night" style="display: block; border: 1px solid lightgray; background: rgb(45, 45, 45); padding: 10px; font-size: 12px;"><editarea class="text-mode code-section-edit-area" style="font-family: &quot;Fira code&quot;, &quot;Fira Mono&quot;, monospace;"><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">def</block><block class=" token"> </block><block class="function token">predict_images</block><block class="punctuation token">(</block><block class=" token">images</block><block class="punctuation token">,</block><block class=" token"> model</block><block class="punctuation token">)</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="keyword token">for</block><block class=" token"> i </block><block class="keyword token">in</block><block class=" token"> images</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block><block class="keyword token">print</block><block class="punctuation token">(</block><block class="string-interpolation string token">f"Processing image: </block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">i</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        img </block><block class="operator token">=</block><block class=" token"> image</block><block class="punctuation token">.</block><block class=" token">load_img</block><block class="punctuation token">(</block><block class=" token">i</block><block class="punctuation token">,</block><block class=" token"> target_size</block><block class="operator token">=</block><block class="punctuation token">(</block><block class="number token">224</block><block class="punctuation token">,</block><block class=" token"> </block><block class="number token">224</block><block class="punctuation token">)</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block><block class="comment token"># Convert to numpy array for Keras image format processing</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        x </block><block class="operator token">=</block><block class=" token"> image</block><block class="punctuation token">.</block><block class=" token">img_to_array</block><block class="punctuation token">(</block><block class=" token">img</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        x </block><block class="operator token">=</block><block class=" token"> np</block><block class="punctuation token">.</block><block class=" token">expand_dims</block><block class="punctuation token">(</block><block class=" token">x</block><block class="punctuation token">,</block><block class=" token"> axis</block><block class="operator token">=</block><block class="number token">0</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        x </block><block class="operator token">=</block><block class=" token"> preprocess_input</block><block class="punctuation token">(</block><block class=" token">x</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        preds </block><block class="operator token">=</block><block class=" token"> model</block><block class="punctuation token">.</block><block class=" token">predict</block><block class="punctuation token">(</block><block class=" token">x</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block><block class="comment token"># Decode the results into a list of tuples (class, description, probability)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block><block class="keyword token">print</block><block class="punctuation token">(</block><block class="string-interpolation string token">f"Predicted: </block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">decode_predictions</block><block class="string-interpolation interpolation punctuation token">(</block><block class="string-interpolation interpolation token">preds</block><block class="string-interpolation interpolation punctuation token">,</block><block class="string-interpolation interpolation token"> top</block><block class="string-interpolation interpolation operator token">=</block><block class="string-interpolation interpolation number token">3</block><block class="string-interpolation interpolation punctuation token">)</block><block class="string-interpolation interpolation punctuation token">[</block><block class="string-interpolation interpolation number token">0</block><block class="string-interpolation interpolation punctuation token">]</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">\n"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">img_paths </block><block class="operator token">=</block><block class=" token"> </block><block class="punctuation token">[</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="string-interpolation string token">f"</block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">DA</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">paths</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">datasets</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">/img/pug.jpg"</block><block class="punctuation token">.</block><block class=" token">replace</block><block class="punctuation token">(</block><block class="string token">"dbfs:/"</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"/dbfs/"</block><block class="punctuation token">)</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="string-interpolation string token">f"</block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">DA</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">paths</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">datasets</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">/img/strawberries.jpg"</block><block class="punctuation token">.</block><block class=" token">replace</block><block class="punctuation token">(</block><block class="string token">"dbfs:/"</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"/dbfs/"</block><block class="punctuation token">)</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="string-interpolation string token">f"</block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">DA</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">paths</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">datasets</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">/img/rose.jpg"</block><block class="punctuation token">.</block><block class=" token">replace</block><block class="punctuation token">(</block><block class="string token">"dbfs:/"</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"/dbfs/"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="punctuation token">]</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">predict_images</block><block class="punctuation token">(</block><block class=" token">img_paths</block><block class="punctuation token">,</block><block class=" token"> vgg16_model</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Processing image: /dbfs/mnt/dbacademy-datasets/deep-learning-with-databricks/v03/img/pug.jpg</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># 1/1 [==============================] - 1s 651ms/step</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Downloading data from https://storage.googleapis.com/download.tensorflow.org/data/imagenet_class_index.json</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># 35363/35363 [==============================] - 0s 0us/step</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Predicted: [('n02110958', 'pug', 0.98625606), ('n02096585', 'Boston_bull', 0.004724465), ('n02108915', 'French_bulldog', 0.0033564696)]</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Processing image: /dbfs/mnt/dbacademy-datasets/deep-learning-with-databricks/v03/img/strawberries.jpg</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># 1/1 [==============================] - 0s 373ms/step</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Predicted: [('n07745940', 'strawberry', 0.98333734), ('n07768694', 'pomegranate', 0.006117687), ('n07753275', 'pineapple', 0.004819302)]</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Processing image: /dbfs/mnt/dbacademy-datasets/deep-learning-with-databricks/v03/img/rose.jpg</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># 1/1 [==============================] - 0s 384ms/step</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Predicted: [('n01914609', 'sea_anemone', 0.20209216), ('n04522168', 'vase', 0.14700975), ('n02776631', 'bakery', 0.10013556)]</block></blocks></line></editarea></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode section sindent-1" data-line-id="n0.8820875133557278" style="font-size: 1.1em; padding-top: 0.5em; padding-bottom: 0.5em; font-weight: bold; line-height: 1.4;" id="n0.8820875133557278" role="heading" aria-level="2"><prefix style="text-align: left; padding-right: 0.25em;">6.3. </prefix><blocks><baselineblock class="inline"></baselineblock><block>Distributed Inference</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold;">Note:</block><block> This is not limited to CNN and can be applied to other types of models, e.g. NLP.</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="background-color: rgb(255, 254, 0);">Let's wrap the prediction code inside a UDF so we can apply this model in parallel on each row of the DataFrame</block><block>.</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item full-line-block-inside" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="code-section-symbol inline" style="display: block;"><div class="code-section theme-tomorrow-night" style="display: block; border: 1px solid lightgray; background: rgb(45, 45, 45); padding: 10px; font-size: 12px;"><editarea class="text-mode code-section-edit-area" style="font-family: &quot;Fira code&quot;, &quot;Fira Mono&quot;, monospace;"><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">from</block><block class=" token"> pyspark</block><block class="punctuation token">.</block><block class=" token">sql</block><block class="punctuation token">.</block><block class=" token">types </block><block class="keyword token">import</block><block class=" token"> StringType</block><block class="punctuation token">,</block><block class=" token"> ArrayType</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">@udf</block><block class="punctuation token">(</block><block class=" token">ArrayType</block><block class="punctuation token">(</block><block class=" token">StringType</block><block class="punctuation token">(</block><block class="punctuation token">)</block><block class="punctuation token">)</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">def</block><block class=" token"> </block><block class="function token">vgg16_predict_udf</block><block class="punctuation token">(</block><block class=" token">path</block><block class="punctuation token">)</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    img </block><block class="operator token">=</block><block class=" token"> image</block><block class="punctuation token">.</block><block class=" token">load_img</block><block class="punctuation token">(</block><block class=" token">path</block><block class="punctuation token">.</block><block class=" token">replace</block><block class="punctuation token">(</block><block class="string token">"dbfs:/"</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"/dbfs/"</block><block class="punctuation token">)</block><block class="punctuation token">,</block><block class=" token"> target_size</block><block class="operator token">=</block><block class="punctuation token">(</block><block class="number token">224</block><block class="punctuation token">,</block><block class=" token"> </block><block class="number token">224</block><block class="punctuation token">)</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    x </block><block class="operator token">=</block><block class=" token"> image</block><block class="punctuation token">.</block><block class=" token">img_to_array</block><block class="punctuation token">(</block><block class=" token">img</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    x </block><block class="operator token">=</block><block class=" token"> np</block><block class="punctuation token">.</block><block class=" token">expand_dims</block><block class="punctuation token">(</block><block class=" token">x</block><block class="punctuation token">,</block><block class=" token"> axis</block><block class="operator token">=</block><block class="number token">0</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    x </block><block class="operator token">=</block><block class=" token"> preprocess_input</block><block class="punctuation token">(</block><block class=" token">x</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    model </block><block class="operator token">=</block><block class=" token"> VGG16</block><block class="punctuation token">(</block><block class=" token">weights</block><block class="operator token">=</block><block class="string token">"imagenet"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    preds </block><block class="operator token">=</block><block class=" token"> model</block><block class="punctuation token">.</block><block class=" token">predict</block><block class="punctuation token">(</block><block class=" token">x</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="comment token"># Decode the results into a list of strings (class, description, probability)  </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="keyword token">return</block><block class=" token"> </block><block class="punctuation token">[</block><block class="string-interpolation string token">f"</block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">label</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">: </block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">prob</block><block class="string-interpolation interpolation punctuation token">:</block><block class="string-interpolation interpolation format-spec token">.3f</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">"</block><block class=" token"> </block><block class="keyword token">for</block><block class=" token"> _</block><block class="punctuation token">,</block><block class=" token"> label</block><block class="punctuation token">,</block><block class=" token"> prob </block><block class="keyword token">in</block><block class=" token"> decode_predictions</block><block class="punctuation token">(</block><block class=" token">preds</block><block class="punctuation token">,</block><block class=" token"> top</block><block class="operator token">=</block><block class="number token">3</block><block class="punctuation token">)</block><block class="punctuation token">[</block><block class="number token">0</block><block class="punctuation token">]</block><block class="punctuation token">]</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">results_df </block><block class="operator token">=</block><block class=" token"> df</block><block class="punctuation token">.</block><block class=" token">withColumn</block><block class="punctuation token">(</block><block class="string token">"predictions"</block><block class="punctuation token">,</block><block class=" token"> vgg16_predict_udf</block><block class="punctuation token">(</block><block class="string token">"path"</block><block class="punctuation token">)</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">display</block><block class="punctuation token">(</block><block class=" token">results_df</block><block class="punctuation token">)</block></blocks></line></editarea></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode section sindent-2" data-line-id="n0.5279198879771259" style="font-size: 1em; padding-top: 0.5em; padding-bottom: 0.5em; font-weight: bold; line-height: 1.4;" id="n0.5279198879771259" role="heading" aria-level="3"><prefix style="text-align: left; padding-right: 0em;">6.3.1. </prefix><blocks><baselineblock class="inline"></baselineblock><block>Pandas/Vectorized UDF</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold; color: rgb(255, 64, 0);">Pandas/Vectorized UDFs</block><block> are available in Python to help </block><block style="background-color: rgb(255, 254, 0);">speed up the computation by leveraging Apache Arrow</block><block>. </block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://arrow.apache.org/" style="text-decoration: underline; font-weight: bold; color: rgb(255, 64, 0);"><a href="https://arrow.apache.org/" target="_blank" style="color: inherit; text-decoration: inherit;">Apache Arrow</a></block><block> is an </block><block style="background-color: rgb(255, 254, 0);">in-memory columnar data format</block><block> that is </block><block style="background-color: rgb(255, 254, 0);">used in Spark to efficiently transfer data between JVM and Python processes with near-zero (de)serialization cost</block><block>. See more </block><block class="role-hyper-link" data-hyper-link-url="https://spark.apache.org/docs/latest/api/python/user_guide/sql/arrow_pandas.html" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://spark.apache.org/docs/latest/api/python/user_guide/sql/arrow_pandas.html" target="_blank" style="color: inherit; text-decoration: inherit;">here</a></block><block>.</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://databricks.com/blog/2017/10/30/introducing-vectorized-udfs-for-pyspark.html" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://databricks.com/blog/2017/10/30/introducing-vectorized-udfs-for-pyspark.html" target="_blank" style="color: inherit; text-decoration: inherit;">Blog post</a></block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://spark.apache.org/docs/latest/sql-programming-guide.html#pyspark-usage-guide-for-pandas-with-apache-arrow" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://spark.apache.org/docs/latest/sql-programming-guide.html#pyspark-usage-guide-for-pandas-with-apache-arrow" target="_blank" style="color: inherit; text-decoration: inherit;">Documentation</a></block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 511px; height: 339.35px; position: relative;"><img src="image-resources/28b3a15c-5235-4a1b-981c-a2c4f0754bbd.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">[</block><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><compositeblock dir="ltr" class="anchor-tag-ref inline" style="font-family: &quot;Computer Modern Serif&quot;, serif; background-color: rgba(155, 155, 155, 0.2);"><a href="#n0.3715415633810799" style="color: inherit; text-decoration: inherit;">Back To Top</a></compositeblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">]</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode section sindent-2" data-line-id="n0.6439888477855658" style="font-size: 1em; padding-top: 0.5em; padding-bottom: 0.5em; font-weight: bold; line-height: 1.4;" id="n0.6439888477855658" role="heading" aria-level="3"><prefix style="text-align: left; padding-right: 0em;">6.3.2. </prefix><blocks><baselineblock class="inline"></baselineblock><block>Pandas Scalar Iterator UDF</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>If you define your own UDF to apply a model to each record of your DataFrame in Python, opt for pandas/vectorized UDFs for </block><block style="text-decoration: underline;">optimized serialization and deserialization</block><block>. </block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="background-color: rgb(255, 254, 0);">However, if your model is very large, then there is high overhead for the pandas UDF to repeatedly load the same model for every batch in the same Python worker process</block><block>. </block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="background-color: rgb(255, 254, 0);">In Spark 3.0, pandas UDFs can accept an </block><block style="font-style: italic; background-color: rgb(255, 254, 0);">iterator</block><block style="background-color: rgb(255, 254, 0);"> of </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; font-weight: bold; color: rgb(231, 55, 61); background-color: rgb(255, 254, 0);">pandas.Series</block><block style="background-color: rgb(255, 254, 0);"> or </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; font-weight: bold; color: rgb(231, 55, 61); background-color: rgb(255, 254, 0);">pandas.DataFrame</block><block style="background-color: rgb(255, 254, 0);"> so that you can load the model only once instead of loading it for every series in the iterator.</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>This way the cost of any set-up needed (like loading the VGG16 model in our case) will be incurred fewer times. </block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>When the number of images youre working with is greater than </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">spark.conf.get("spark.sql.execution.arrow.maxRecordsPerBatch")</block><block>, which is 10,000 by default, you'll see </block><block style="background-color: rgb(255, 254, 0);">significant speed ups over a pandas scalar UDF because it iterates through batches of </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; background-color: rgb(255, 254, 0);">pd.Series</block><block>.</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>It has the general syntax of: </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">@pandas_udf(...) def predict(iterator): model = ... # load model for features in iterator: yield model.predict(features)</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="background-color: rgb(255, 254, 0);">If the workers cached the model weights after loading it for the first time, subsequent calls of the same UDF with the same model loading will become significantly faster</block><block>.</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item full-line-block-inside" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="code-section-symbol inline" style="display: block;"><div class="code-section theme-tomorrow-night" style="display: block; border: 1px solid lightgray; background: rgb(45, 45, 45); padding: 10px; font-size: 12px;"><editarea class="text-mode code-section-edit-area" style="font-family: &quot;Fira code&quot;, &quot;Fira Mono&quot;, monospace;"><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">from</block><block class=" token"> pyspark</block><block class="punctuation token">.</block><block class=" token">sql</block><block class="punctuation token">.</block><block class=" token">functions </block><block class="keyword token">import</block><block class=" token"> pandas_udf</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">import</block><block class=" token"> pandas </block><block class="keyword token">as</block><block class=" token"> pd</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">from</block><block class=" token"> typing </block><block class="keyword token">import</block><block class=" token"> Iterator</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">def</block><block class=" token"> </block><block class="function token">preprocess</block><block class="punctuation token">(</block><block class=" token">image_path</block><block class="punctuation token">)</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    path </block><block class="operator token">=</block><block class=" token"> image_path</block><block class="punctuation token">.</block><block class=" token">replace</block><block class="punctuation token">(</block><block class="string token">"dbfs:/"</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"/dbfs/"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    img </block><block class="operator token">=</block><block class=" token"> image</block><block class="punctuation token">.</block><block class=" token">load_img</block><block class="punctuation token">(</block><block class=" token">path</block><block class="punctuation token">,</block><block class=" token"> target_size</block><block class="operator token">=</block><block class="punctuation token">(</block><block class="number token">224</block><block class="punctuation token">,</block><block class=" token"> </block><block class="number token">224</block><block class="punctuation token">)</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    x </block><block class="operator token">=</block><block class=" token"> image</block><block class="punctuation token">.</block><block class=" token">img_to_array</block><block class="punctuation token">(</block><block class=" token">img</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    x </block><block class="operator token">=</block><block class=" token"> preprocess_input</block><block class="punctuation token">(</block><block class=" token">x</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="keyword token">return</block><block class=" token"> x</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">@pandas_udf</block><block class="punctuation token">(</block><block class=" token">ArrayType</block><block class="punctuation token">(</block><block class=" token">StringType</block><block class="punctuation token">(</block><block class="punctuation token">)</block><block class="punctuation token">)</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">def</block><block class=" token"> </block><block class="function token">vgg16_predict_pandas_udf</block><block class="punctuation token">(</block><block class=" token">image_data_iter</block><block class="punctuation token">:</block><block class=" token"> Iterator</block><block class="punctuation token">[</block><block class=" token">pd</block><block class="punctuation token">.</block><block class=" token">DataFrame</block><block class="punctuation token">]</block><block class="punctuation token">)</block><block class=" token"> </block><block class="operator token">-</block><block class="operator token">&gt;</block><block class=" token"> Iterator</block><block class="punctuation token">[</block><block class=" token">pd</block><block class="punctuation token">.</block><block class=" token">DataFrame</block><block class="punctuation token">]</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="comment token"># Load model outside of for loop</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    model </block><block class="operator token">=</block><block class=" token"> VGG16</block><block class="punctuation token">(</block><block class=" token">weights</block><block class="operator token">=</block><block class="string token">"imagenet"</block><block class="punctuation token">)</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="keyword token">for</block><block class=" token"> image_data_series </block><block class="keyword token">in</block><block class=" token"> image_data_iter</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block><block class="comment token"># Apply functions to entire series at once</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        x </block><block class="operator token">=</block><block class=" token"> image_data_series</block><block class="punctuation token">.</block><block class="builtin token">map</block><block class="punctuation token">(</block><block class=" token">preprocess</block><block class="punctuation token">)</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        x </block><block class="operator token">=</block><block class=" token"> np</block><block class="punctuation token">.</block><block class=" token">stack</block><block class="punctuation token">(</block><block class="builtin token">list</block><block class="punctuation token">(</block><block class=" token">x</block><block class="punctuation token">.</block><block class=" token">values</block><block class="punctuation token">)</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        preds </block><block class="operator token">=</block><block class=" token"> model</block><block class="punctuation token">.</block><block class=" token">predict</block><block class="punctuation token">(</block><block class=" token">x</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        top_3s </block><block class="operator token">=</block><block class=" token"> decode_predictions</block><block class="punctuation token">(</block><block class=" token">preds</block><block class="punctuation token">,</block><block class=" token"> top</block><block class="operator token">=</block><block class="number token">3</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block><block class="keyword token">yield</block><block class=" token"> pd</block><block class="punctuation token">.</block><block class=" token">Series</block><block class="punctuation token">(</block><block class="punctuation token">[</block><block class="punctuation token">[</block><block class="string-interpolation string token">f"</block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">label</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">: </block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">prob</block><block class="string-interpolation interpolation punctuation token">:</block><block class="string-interpolation interpolation format-spec token">.3f</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">"</block><block class=" token"> </block><block class="keyword token">for</block><block class=" token"> _</block><block class="punctuation token">,</block><block class=" token"> label</block><block class="punctuation token">,</block><block class=" token"> prob </block><block class="keyword token">in</block><block class=" token"> top_3</block><block class="punctuation token">]</block><block class=" token"> </block><block class="keyword token">for</block><block class=" token"> top_3 </block><block class="keyword token">in</block><block class=" token"> top_3s</block><block class="punctuation token">]</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">display</block><block class="punctuation token">(</block><block class=" token">df</block><block class="punctuation token">.</block><block class=" token">withColumn</block><block class="punctuation token">(</block><block class="string token">"predictions"</block><block class="punctuation token">,</block><block class=" token"> vgg16_predict_pandas_udf</block><block class="punctuation token">(</block><block class="string token">"path"</block><block class="punctuation token">)</block><block class="punctuation token">)</block><block class="punctuation token">)</block></blocks></line></editarea></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode section sindent-2" data-line-id="n0.7909110108170461" style="font-size: 1em; padding-top: 0.5em; padding-bottom: 0.5em; font-weight: bold; line-height: 1.4;" id="n0.7909110108170461" role="heading" aria-level="3"><prefix style="text-align: left; padding-right: 0em;">6.3.3. </prefix><blocks><baselineblock class="inline"></baselineblock><block>Pandas Function API</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Instead of using a </block><block style="font-weight: bold;">Pandas UDF</block><block>, we can use a </block><block style="font-weight: bold; color: rgb(255, 64, 0);">Pandas Function API</block><block>. </block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>This new category in </block><block style="text-decoration: underline;">Apache Spark 3.0</block><block> enables you to </block><block style="text-decoration: underline;">directly apply a Python native function</block><block>, which takes and outputs Pandas instances against a </block><block style="font-style: italic;">PySpark DataFrame</block><block>. </block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold; background-color: rgb(255, 254, 0);">Pandas Functions APIs</block><block style="background-color: rgb(255, 254, 0);"> supported in Apache Spark 3.0 are:</block><block> </block><block style="font-weight: bold;">grouped map, map, and co-grouped map</block><block>.</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">mapInPandas()</block><block> takes an iterator of </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">pandas.DataFrame</block><block> as input, and outputs another iterator of </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">pandas.DataFrame</block><block>. </block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="background-color: rgb(255, 254, 0);">It's flexible and easy to use if your model requires all of your columns as input, but it requires serialization/deserialization of the whole DataFrame (as it is passed to its input)</block><block>. </block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>You can </block><block style="text-decoration: underline;">control the size</block><block> of each </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">pandas.DataFrame</block><block> with the </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">spark.sql.execution.arrow.maxRecordsPerBatch</block><block> config.</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Because </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">mapInPandas</block><block> </block><block style="text-decoration: underline;">requires deserializing all of your columns</block><block>, we will only be selecting the path column prior to applying the model.</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item full-line-block-inside" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="code-section-symbol inline" style="display: block;"><div class="code-section theme-tomorrow-night" style="display: block; border: 1px solid lightgray; background: rgb(45, 45, 45); padding: 10px; font-size: 12px;"><editarea class="text-mode code-section-edit-area" style="font-family: &quot;Fira code&quot;, &quot;Fira Mono&quot;, monospace;"><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">def</block><block class=" token"> </block><block class="function token">map_pandas_predict</block><block class="punctuation token">(</block><block class=" token">image_data_iter</block><block class="punctuation token">:</block><block class=" token"> Iterator</block><block class="punctuation token">[</block><block class=" token">pd</block><block class="punctuation token">.</block><block class=" token">DataFrame</block><block class="punctuation token">]</block><block class="punctuation token">)</block><block class=" token"> </block><block class="operator token">-</block><block class="operator token">&gt;</block><block class=" token"> Iterator</block><block class="punctuation token">[</block><block class=" token">pd</block><block class="punctuation token">.</block><block class=" token">DataFrame</block><block class="punctuation token">]</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    model </block><block class="operator token">=</block><block class=" token"> VGG16</block><block class="punctuation token">(</block><block class=" token">weights</block><block class="operator token">=</block><block class="string token">"imagenet"</block><block class="punctuation token">)</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="keyword token">for</block><block class=" token"> image_data_series </block><block class="keyword token">in</block><block class=" token"> image_data_iter</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        image_path_series </block><block class="operator token">=</block><block class=" token"> image_data_series</block><block class="punctuation token">[</block><block class="string token">"path"</block><block class="punctuation token">]</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        x </block><block class="operator token">=</block><block class=" token"> image_path_series</block><block class="punctuation token">.</block><block class="builtin token">map</block><block class="punctuation token">(</block><block class=" token">preprocess</block><block class="punctuation token">)</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        x </block><block class="operator token">=</block><block class=" token"> np</block><block class="punctuation token">.</block><block class=" token">stack</block><block class="punctuation token">(</block><block class="builtin token">list</block><block class="punctuation token">(</block><block class=" token">x</block><block class="punctuation token">.</block><block class=" token">values</block><block class="punctuation token">)</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        preds </block><block class="operator token">=</block><block class=" token"> model</block><block class="punctuation token">.</block><block class=" token">predict</block><block class="punctuation token">(</block><block class=" token">x</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        top_3s </block><block class="operator token">=</block><block class=" token"> decode_predictions</block><block class="punctuation token">(</block><block class=" token">preds</block><block class="punctuation token">,</block><block class=" token"> top</block><block class="operator token">=</block><block class="number token">3</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        results </block><block class="operator token">=</block><block class=" token"> </block><block class="punctuation token">[</block><block class="punctuation token">[</block><block class="string-interpolation string token">f"</block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">label</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">: </block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">prob</block><block class="string-interpolation interpolation punctuation token">:</block><block class="string-interpolation interpolation format-spec token">.3f</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">"</block><block class=" token"> </block><block class="keyword token">for</block><block class=" token"> _</block><block class="punctuation token">,</block><block class=" token"> label</block><block class="punctuation token">,</block><block class=" token"> prob </block><block class="keyword token">in</block><block class=" token"> top_3</block><block class="punctuation token">]</block><block class=" token"> </block><block class="keyword token">for</block><block class=" token"> top_3 </block><block class="keyword token">in</block><block class=" token"> top_3s</block><block class="punctuation token">]</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block><block class="keyword token">yield</block><block class=" token"> pd</block><block class="punctuation token">.</block><block class=" token">concat</block><block class="punctuation token">(</block><block class="punctuation token">[</block><block class=" token">image_path_series</block><block class="punctuation token">,</block><block class=" token"> pd</block><block class="punctuation token">.</block><block class=" token">Series</block><block class="punctuation token">(</block><block class=" token">results</block><block class="punctuation token">,</block><block class=" token"> name</block><block class="operator token">=</block><block class="string token">"prediction"</block><block class="punctuation token">)</block><block class="punctuation token">]</block><block class="punctuation token">,</block><block class=" token"> axis</block><block class="operator token">=</block><block class="number token">1</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">display</block><block class="punctuation token">(</block><block class=" token">df</block><block class="punctuation token">.</block><block class=" token">select</block><block class="punctuation token">(</block><block class="string token">"path"</block><block class="punctuation token">)</block><block class="punctuation token">.</block><block class=" token">mapInPandas</block><block class="punctuation token">(</block><block class=" token">map_pandas_predict</block><block class="punctuation token">,</block><block class=" token"> schema</block><block class="operator token">=</block><block class="string token">"path:STRING, prediction:ARRAY&lt;STRING&gt;"</block><block class="punctuation token">)</block><block class="punctuation token">)</block></blocks></line></editarea></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">[</block><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><compositeblock dir="ltr" class="anchor-tag-ref inline" style="font-family: &quot;Computer Modern Serif&quot;, serif; background-color: rgba(155, 155, 155, 0.2);"><a href="#n0.3715415633810799" style="color: inherit; text-decoration: inherit;">Back To Top</a></compositeblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">]</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode section sindent-1" data-line-id="n0.09342749891982827" style="font-size: 1.1em; padding-top: 0.5em; padding-bottom: 0.5em; font-weight: bold; line-height: 1.4;" id="n0.09342749891982827" role="heading" aria-level="2"><prefix style="text-align: left; padding-right: 0.25em;">6.4. </prefix><blocks><baselineblock class="inline"></baselineblock><block>SHAP for CNNs</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>The idea is to use SHAP to generate explanation behind a model's predictions.</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Here, we use the </block><block class="role-hyper-link" data-hyper-link-url="https://github.com/zalandoresearch/fashion-mnist" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://github.com/zalandoresearch/fashion-mnist" target="_blank" style="color: inherit; text-decoration: inherit;">Fashion MNIST</a></block><block> dataset images (70,000 grayscale images with 10 categories).</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>We are going to use </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">shap.GradientExplainer</block><block> to explain pixel attributions to the predictions. </block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>From the </block><block class="role-hyper-link" data-hyper-link-url="https://shap-lrjball.readthedocs.io/en/latest/generated/shap.GradientExplainer.html#shap.GradientExplainer" style="text-decoration: underline; font-weight: bold; color: rgb(17, 85, 204);"><a href="https://shap-lrjball.readthedocs.io/en/latest/generated/shap.GradientExplainer.html#shap.GradientExplainer" target="_blank" style="color: inherit; text-decoration: inherit;">SHAP documentation</a></block><block>:</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="font-style: italic; flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-style: italic;">"GradientExplainer Explains a model using </block><block style="font-weight: bold; font-style: italic; color: rgb(255, 64, 0);">expected gradients</block><block style="font-style: italic;">. Expected gradients an extension of the integrated gradients method (Sundararajan et al. 2017), a feature attribution method designed for differentiable models based on an extension of Shapley values to infinite player games (Aumann-Shapley values)."</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="font-style: italic; flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>To read more about </block><block class="role-hyper-link" data-hyper-link-url="https://christophm.github.io/interpretable-ml-book/pixel-attribution.html" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://christophm.github.io/interpretable-ml-book/pixel-attribution.html" target="_blank" style="color: inherit; text-decoration: inherit;">pixel attribution here</a></block><block>. According to the documentation:</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="font-style: italic; flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-style: italic;">"</block><block style="font-style: italic; background-color: rgb(255, 254, 0);">Red pixels increase the model's output while blue pixels decrease the output</block><block style="font-style: italic;">. The input images are shown on the left, and as nearly transparent grayscale backings behind each of the explanations. </block><block style="text-decoration: underline; font-style: italic;">The sum of the SHAP values equals the difference between the expected model output (averaged over the background dataset) and the current model output</block><block style="font-style: italic;">."</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item full-line-block-inside" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="code-section-symbol inline" style="display: block;"><div class="code-section theme-tomorrow-night" style="display: block; border: 1px solid lightgray; background: rgb(45, 45, 45); padding: 10px; font-size: 12px;"><editarea class="text-mode code-section-edit-area" style="font-family: &quot;Fira code&quot;, &quot;Fira Mono&quot;, monospace;"><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">import</block><block class=" token"> tensorflow </block><block class="keyword token">as</block><block class=" token"> tf</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">### split data into training and testing sets</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="punctuation token">(</block><block class=" token">X_train</block><block class="punctuation token">,</block><block class=" token"> y_train</block><block class="punctuation token">)</block><block class="punctuation token">,</block><block class=" token"> </block><block class="punctuation token">(</block><block class=" token">X_test</block><block class="punctuation token">,</block><block class=" token"> y_test</block><block class="punctuation token">)</block><block class=" token"> </block><block class="operator token">=</block><block class=" token"> tf</block><block class="punctuation token">.</block><block class=" token">keras</block><block class="punctuation token">.</block><block class=" token">datasets</block><block class="punctuation token">.</block><block class=" token">fashion_mnist</block><block class="punctuation token">.</block><block class=" token">load_data</block><block class="punctuation token">(</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">### Preprocessing images</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">from</block><block class=" token"> tensorflow</block><block class="punctuation token">.</block><block class=" token">keras </block><block class="keyword token">import</block><block class=" token"> layers</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">num_classes </block><block class="operator token">=</block><block class=" token"> </block><block class="number token">10</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">### Input image dimensions</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">### Each image has 28 x 28 pixels</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">img_rows</block><block class="punctuation token">,</block><block class=" token"> img_cols </block><block class="operator token">=</block><block class=" token"> </block><block class="number token">28</block><block class="punctuation token">,</block><block class=" token"> </block><block class="number token">28</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">X_train </block><block class="operator token">=</block><block class=" token"> X_train</block><block class="punctuation token">.</block><block class=" token">reshape</block><block class="punctuation token">(</block><block class=" token">X_train</block><block class="punctuation token">.</block><block class=" token">shape</block><block class="punctuation token">[</block><block class="number token">0</block><block class="punctuation token">]</block><block class="punctuation token">,</block><block class=" token"> img_rows</block><block class="punctuation token">,</block><block class=" token"> img_cols</block><block class="punctuation token">,</block><block class=" token"> </block><block class="number token">1</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">X_test </block><block class="operator token">=</block><block class=" token"> X_test</block><block class="punctuation token">.</block><block class=" token">reshape</block><block class="punctuation token">(</block><block class=" token">X_test</block><block class="punctuation token">.</block><block class=" token">shape</block><block class="punctuation token">[</block><block class="number token">0</block><block class="punctuation token">]</block><block class="punctuation token">,</block><block class=" token"> img_rows</block><block class="punctuation token">,</block><block class=" token"> img_cols</block><block class="punctuation token">,</block><block class=" token"> </block><block class="number token">1</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">input_shape </block><block class="operator token">=</block><block class=" token"> </block><block class="punctuation token">(</block><block class=" token">img_rows</block><block class="punctuation token">,</block><block class=" token"> img_cols</block><block class="punctuation token">,</block><block class=" token"> </block><block class="number token">1</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">### Scale the images in both the training and testing sets to a range of 0 to 1. </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">X_train </block><block class="operator token">=</block><block class=" token"> X_train</block><block class="punctuation token">.</block><block class=" token">astype</block><block class="punctuation token">(</block><block class="string token">"float32"</block><block class="punctuation token">)</block><block class=" token"> </block><block class="operator token">/</block><block class=" token"> </block><block class="number token">255</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">X_test </block><block class="operator token">=</block><block class=" token"> X_test</block><block class="punctuation token">.</block><block class=" token">astype</block><block class="punctuation token">(</block><block class="string token">"float32"</block><block class="punctuation token">)</block><block class=" token"> </block><block class="operator token">/</block><block class=" token"> </block><block class="number token">255</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">print</block><block class="punctuation token">(</block><block class="string token">"X_train shape: "</block><block class="punctuation token">,</block><block class=" token"> X_train</block><block class="punctuation token">.</block><block class=" token">shape</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">print</block><block class="punctuation token">(</block><block class=" token">X_train</block><block class="punctuation token">.</block><block class=" token">shape</block><block class="punctuation token">[</block><block class="number token">0</block><block class="punctuation token">]</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"train images"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">print</block><block class="punctuation token">(</block><block class=" token">X_test</block><block class="punctuation token">.</block><block class=" token">shape</block><block class="punctuation token">[</block><block class="number token">0</block><block class="punctuation token">]</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"test images"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">### Convert class vectors to binary class matrices</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">y_train </block><block class="operator token">=</block><block class=" token"> tf</block><block class="punctuation token">.</block><block class=" token">keras</block><block class="punctuation token">.</block><block class=" token">utils</block><block class="punctuation token">.</block><block class=" token">to_categorical</block><block class="punctuation token">(</block><block class=" token">y_train</block><block class="punctuation token">,</block><block class=" token"> num_classes</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">y_test </block><block class="operator token">=</block><block class=" token"> tf</block><block class="punctuation token">.</block><block class=" token">keras</block><block class="punctuation token">.</block><block class=" token">utils</block><block class="punctuation token">.</block><block class=" token">to_categorical</block><block class="punctuation token">(</block><block class=" token">y_test</block><block class="punctuation token">,</block><block class=" token"> num_classes</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">### Constructing and training a simple CNN</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">model </block><block class="operator token">=</block><block class=" token"> tf</block><block class="punctuation token">.</block><block class=" token">keras</block><block class="punctuation token">.</block><block class=" token">models</block><block class="punctuation token">.</block><block class=" token">Sequential</block><block class="punctuation token">(</block><block class="punctuation token">[</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    layers</block><block class="punctuation token">.</block><block class=" token">Conv2D</block><block class="punctuation token">(</block><block class="number token">32</block><block class="punctuation token">,</block><block class=" token"> kernel_size</block><block class="operator token">=</block><block class="punctuation token">(</block><block class="number token">3</block><block class="punctuation token">,</block><block class=" token"> </block><block class="number token">3</block><block class="punctuation token">)</block><block class="punctuation token">,</block><block class=" token"> activation</block><block class="operator token">=</block><block class="string token">"relu"</block><block class="punctuation token">,</block><block class=" token"> input_shape</block><block class="operator token">=</block><block class=" token">input_shape</block><block class="punctuation token">)</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    layers</block><block class="punctuation token">.</block><block class=" token">MaxPooling2D</block><block class="punctuation token">(</block><block class=" token">pool_size</block><block class="operator token">=</block><block class="punctuation token">(</block><block class="number token">2</block><block class="punctuation token">,</block><block class=" token"> </block><block class="number token">2</block><block class="punctuation token">)</block><block class="punctuation token">)</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    layers</block><block class="punctuation token">.</block><block class=" token">Flatten</block><block class="punctuation token">(</block><block class="punctuation token">)</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    layers</block><block class="punctuation token">.</block><block class=" token">Dense</block><block class="punctuation token">(</block><block class="number token">128</block><block class="punctuation token">,</block><block class=" token"> activation</block><block class="operator token">=</block><block class="string token">"relu"</block><block class="punctuation token">)</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    layers</block><block class="punctuation token">.</block><block class=" token">Dense</block><block class="punctuation token">(</block><block class=" token">num_classes</block><block class="punctuation token">,</block><block class=" token"> activation</block><block class="operator token">=</block><block class="string token">"softmax"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="punctuation token">]</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">model</block><block class="punctuation token">.</block><block class="builtin token">compile</block><block class="punctuation token">(</block><block class=" token">loss</block><block class="operator token">=</block><block class=" token">tf</block><block class="punctuation token">.</block><block class=" token">keras</block><block class="punctuation token">.</block><block class=" token">losses</block><block class="punctuation token">.</block><block class=" token">categorical_crossentropy</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">              optimizer</block><block class="operator token">=</block><block class=" token">tf</block><block class="punctuation token">.</block><block class=" token">keras</block><block class="punctuation token">.</block><block class=" token">optimizers</block><block class="punctuation token">.</block><block class=" token">Adam</block><block class="punctuation token">(</block><block class="punctuation token">)</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">              metrics</block><block class="operator token">=</block><block class="punctuation token">[</block><block class="string token">"accuracy"</block><block class="punctuation token">]</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">EPOCHS </block><block class="operator token">=</block><block class=" token"> </block><block class="number token">3</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">BATCH_SIZE </block><block class="operator token">=</block><block class=" token"> </block><block class="number token">128</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">### Restrict the training set to only 5000 images to reduce training time</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">model</block><block class="punctuation token">.</block><block class=" token">fit</block><block class="punctuation token">(</block><block class=" token">X_train</block><block class="punctuation token">[</block><block class="punctuation token">:</block><block class="number token">5000</block><block class="punctuation token">]</block><block class="punctuation token">,</block><block class=" token"> y_train</block><block class="punctuation token">[</block><block class="punctuation token">:</block><block class="number token">5000</block><block class="punctuation token">]</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">          batch_size</block><block class="operator token">=</block><block class=" token">BATCH_SIZE</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">          epochs</block><block class="operator token">=</block><block class=" token">EPOCHS</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">          verbose</block><block class="operator token">=</block><block class="number token">1</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">          validation_data</block><block class="operator token">=</block><block class="punctuation token">(</block><block class=" token">X_test</block><block class="punctuation token">[</block><block class="punctuation token">:</block><block class="number token">1000</block><block class="punctuation token">]</block><block class="punctuation token">,</block><block class=" token"> y_test</block><block class="punctuation token">[</block><block class="punctuation token">:</block><block class="number token">1000</block><block class="punctuation token">]</block><block class="punctuation token">)</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">score </block><block class="operator token">=</block><block class=" token"> model</block><block class="punctuation token">.</block><block class=" token">evaluate</block><block class="punctuation token">(</block><block class=" token">X_test</block><block class="punctuation token">,</block><block class=" token"> y_test</block><block class="punctuation token">,</block><block class=" token"> verbose</block><block class="operator token">=</block><block class="number token">0</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">print</block><block class="punctuation token">(</block><block class="string-interpolation string token">f"Test loss: </block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">score</block><block class="string-interpolation interpolation punctuation token">[</block><block class="string-interpolation interpolation number token">0</block><block class="string-interpolation interpolation punctuation token">]</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">print</block><block class="punctuation token">(</block><block class="string-interpolation string token">f"Test accuracy: </block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">score</block><block class="string-interpolation interpolation punctuation token">[</block><block class="string-interpolation interpolation number token">1</block><block class="string-interpolation interpolation punctuation token">]</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">### Get model predictions</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">import</block><block class=" token"> numpy </block><block class="keyword token">as</block><block class=" token"> np</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">np</block><block class="punctuation token">.</block><block class=" token">random</block><block class="punctuation token">.</block><block class=" token">seed</block><block class="punctuation token">(</block><block class="number token">1234</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">N_test </block><block class="operator token">=</block><block class=" token"> </block><block class="number token">9</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># sample_index = np.random.choice(X_test.shape[0], N_test, replace=False) #optional if you want to shuffle test example</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">sample_index </block><block class="operator token">=</block><block class=" token"> np</block><block class="punctuation token">.</block><block class=" token">arange</block><block class="punctuation token">(</block><block class=" token">N_test</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">X_test_sample </block><block class="operator token">=</block><block class=" token"> X_test</block><block class="punctuation token">[</block><block class=" token">sample_index</block><block class="punctuation token">]</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">y_test_sample </block><block class="operator token">=</block><block class=" token"> y_test</block><block class="punctuation token">[</block><block class=" token">sample_index</block><block class="punctuation token">]</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">predictions </block><block class="operator token">=</block><block class=" token"> model</block><block class="punctuation token">.</block><block class=" token">predict</block><block class="punctuation token">(</block><block class=" token">X_test_sample</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">prob_array </block><block class="operator token">=</block><block class=" token"> </block><block class="punctuation token">[</block><block class="builtin token">max</block><block class="punctuation token">(</block><block class=" token">predictions</block><block class="punctuation token">[</block><block class=" token">i</block><block class="punctuation token">]</block><block class="punctuation token">)</block><block class=" token"> </block><block class="keyword token">for</block><block class=" token"> i </block><block class="keyword token">in</block><block class=" token"> </block><block class="builtin token">range</block><block class="punctuation token">(</block><block class=" token">N_test</block><block class="punctuation token">)</block><block class="punctuation token">]</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">class_array </block><block class="operator token">=</block><block class=" token"> </block><block class="punctuation token">[</block><block class=" token">class_names</block><block class="punctuation token">[</block><block class=" token">np</block><block class="punctuation token">.</block><block class=" token">argmax</block><block class="punctuation token">(</block><block class=" token">predictions</block><block class="punctuation token">[</block><block class=" token">i</block><block class="punctuation token">]</block><block class="punctuation token">)</block><block class="punctuation token">]</block><block class=" token"> </block><block class="keyword token">for</block><block class=" token"> i </block><block class="keyword token">in</block><block class=" token"> </block><block class="builtin token">range</block><block class="punctuation token">(</block><block class=" token">N_test</block><block class="punctuation token">)</block><block class="punctuation token">]</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">print</block><block class="punctuation token">(</block><block class="builtin token">list</block><block class="punctuation token">(</block><block class="builtin token">zip</block><block class="punctuation token">(</block><block class=" token">class_array</block><block class="punctuation token">,</block><block class=" token"> prob_array</block><block class="punctuation token">)</block><block class="punctuation token">)</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">### Applying SHAP</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">import</block><block class=" token"> shap</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">## Select a set of background examples to take an expectation over</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">background </block><block class="operator token">=</block><block class=" token"> X_train</block><block class="punctuation token">[</block><block class=" token">np</block><block class="punctuation token">.</block><block class=" token">random</block><block class="punctuation token">.</block><block class=" token">choice</block><block class="punctuation token">(</block><block class=" token">X_train</block><block class="punctuation token">.</block><block class=" token">shape</block><block class="punctuation token">[</block><block class="number token">0</block><block class="punctuation token">]</block><block class="punctuation token">,</block><block class=" token"> </block><block class="number token">200</block><block class="punctuation token">,</block><block class=" token"> replace</block><block class="operator token">=</block><block class="boolean token">False</block><block class="punctuation token">)</block><block class="punctuation token">]</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">e </block><block class="operator token">=</block><block class=" token"> shap</block><block class="punctuation token">.</block><block class=" token">GradientExplainer</block><block class="punctuation token">(</block><block class=" token">model</block><block class="punctuation token">,</block><block class=" token"> background</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">shap_values </block><block class="operator token">=</block><block class=" token"> e</block><block class="punctuation token">.</block><block class=" token">shap_values</block><block class="punctuation token">(</block><block class=" token">X_test_sample</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">## Plot the pixel attributions</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">## get class name in the plot, index_names need to have dimension [N_sample, N_output]</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">index_names </block><block class="operator token">=</block><block class=" token"> np</block><block class="punctuation token">.</block><block class=" token">array</block><block class="punctuation token">(</block><block class="punctuation token">[</block><block class=" token">class_names</block><block class="punctuation token">]</block><block class="operator token">*</block><block class=" token">N_test</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">### Note that the negative sign in front of X_test is to remove the image background</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">shap</block><block class="punctuation token">.</block><block class=" token">image_plot</block><block class="punctuation token">(</block><block class=" token">shap_values</block><block class="punctuation token">,</block><block class=" token"> </block><block class="operator token">-</block><block class=" token">X_test_sample</block><block class="punctuation token">,</block><block class=" token"> index_names</block><block class="punctuation token">)</block></blocks></line></editarea></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 685.597px; height: 482.46px; position: relative;"><img src="image-resources/41ff4c07-778a-4b67-b33c-d12114428969.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold; background-color: rgb(255, 254, 0);">Note:</block><block> Note that for the first (row 1) and the last picture (row 9), mostly "blank" outer background is important for the model to generate a "ankle boot" and "sandal" prediction respectively.</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>What else do you see? How can you explain the misclassification of the 7th picture (row 7) using this SHAP-generated image?</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">[</block><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><compositeblock dir="ltr" class="anchor-tag-ref inline" style="font-family: &quot;Computer Modern Serif&quot;, serif; background-color: rgba(155, 155, 155, 0.2);"><a href="#n0.3715415633810799" style="color: inherit; text-decoration: inherit;">Back To Top</a></compositeblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">]</block></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="inline" style="display: block;"><div style="vertical-align: baseline;"><div style="display: inline-block; height: 0px; border-bottom: 1px solid; width: 100%;"></div></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode section sindent-0" data-line-id="n0.10051025533642255" style="font-size: 1.2em; padding-top: 0.5em; padding-bottom: 0.5em; font-weight: bold; line-height: 1.4;" id="n0.10051025533642255" role="heading" aria-level="1"><prefix style="text-align: left; padding-right: 0.5em;">7. </prefix><blocks><baselineblock class="inline"></baselineblock><block>Transfer Learning</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>The </block><block style="text-decoration: underline;">idea</block><block> of transfer learning is that </block><block style="background-color: rgb(255, 254, 0);">intermediate representations learned for one task may be useful for other related tasks</block><block>.</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 575.591px; height: 343.07px; position: relative;"><img src="image-resources/ed293166-3715-4ca5-8209-7a976a8918be.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div data-caption-block-id="n0.2155449341898601" class="role-image-caption-container role-caption-container" style="display: flex; align-items: center; justify-content: center; margin-top: 10px;" id="n0.2155449341898601"><span class="no-print-outline" style="outline: none; position: relative; text-align: center;"><span class="role-image-caption-prefix" style="padding-right: 0.3em; font-weight: bold;"><span class="role-image-caption-name">Figure</span><span class="role-image-caption-number"><!-- react-text: 13167 --> <!-- /react-text --><!-- react-text: 13168 -->4<!-- /react-text --></span><span>:</span></span><editarea class="image-caption text-mode" style="min-width: 50px; display: inline;"><line class="text-mode align-center" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://www.ruder.io/transfer-learning/" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://www.ruder.io/transfer-learning/" target="_blank" style="color: inherit; text-decoration: inherit;">Source</a></block></blocks></line></editarea></span></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="color: rgb(255, 64, 0); font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold; color: rgb(255, 64, 0);">Why Transfer Learning?</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold;">In 2016, Andrew Ng claimed that transfer learning will be the next driver of commercial machine learning success after supervised learning. Why?</block></blocks></line><line class="root text-mode indent-2 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="3"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;">* </prefix><blocks><baselineblock class="inline"></baselineblock><block>A fundamental assumption of most machine learning approaches is that you train a model from scratch on a new dataset</block></blocks></line><line class="root text-mode indent-2 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="3"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;">* </prefix><blocks><baselineblock class="inline"></baselineblock><block>Transfer learning stores knowledge gained from solving one problem on a different, related problem</block></blocks></line><line class="root text-mode indent-2 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="3"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;">* </prefix><blocks><baselineblock class="inline"></baselineblock><block>More closely resembles human learning</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold;">What types of features could be transferred from one task to the next in the following cases?</block></blocks></line><line class="root text-mode indent-2 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="3"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;">* </prefix><blocks><baselineblock class="inline"></baselineblock><block>Image recognition</block></blocks></line><line class="root text-mode indent-2 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="3"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;">* </prefix><blocks><baselineblock class="inline"></baselineblock><block>Natural language processing</block></blocks></line><line class="root text-mode indent-2 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="3"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;">* </prefix><blocks><baselineblock class="inline"></baselineblock><block>Speech recognition</block></blocks></line><line class="root text-mode indent-2 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="3"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;">* </prefix><blocks><baselineblock class="inline"></baselineblock><block>Time series</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="color: rgb(255, 64, 0); font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold; color: rgb(255, 64, 0);">When to use transfer learning?</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 496.8px; height: 290.18px; position: relative;"><img src="image-resources/0899c16a-e2d5-4f67-9c23-5d6f652ab8b6.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div data-caption-block-id="n0.8285092709796988" class="role-image-caption-container role-caption-container" style="display: flex; align-items: center; justify-content: center; margin-top: 10px;" id="n0.8285092709796988"><span class="no-print-outline" style="outline: none; position: relative; text-align: center;"><span class="role-image-caption-prefix" style="padding-right: 0.3em; font-weight: bold;"><span class="role-image-caption-name">Figure</span><span class="role-image-caption-number"><!-- react-text: 13272 --> <!-- /react-text --><!-- react-text: 13273 -->5<!-- /react-text --></span><span>:</span></span><editarea class="image-caption text-mode" style="min-width: 50px; display: inline;"><line class="text-mode align-center" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://cs231n.github.io/transfer-learning/" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://cs231n.github.io/transfer-learning/" target="_blank" style="color: inherit; text-decoration: inherit;">Andrej Karpathy's Transfer Learning</a></block></blocks></line></editarea></span></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="color: rgb(255, 64, 0); font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold; color: rgb(255, 64, 0);">Common Pre-trained Models</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold;">Keras</block><block> exposes a number of deep learning models (architectures) along with pre-trained weights. </block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>They are available in the </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">tensorflow.keras.applications</block><block> package and the full list is available </block><block class="role-hyper-link" data-hyper-link-url="https://www.tensorflow.org/api_docs/python/tf/keras/applications" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://www.tensorflow.org/api_docs/python/tf/keras/applications" target="_blank" style="color: inherit; text-decoration: inherit;">here</a></block><block>.</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold;">Transfer learning:</block></blocks></line><line class="root text-mode indent-2 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="3"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;">* </prefix><blocks><baselineblock class="inline"></baselineblock><block>Saves a lot of time and resources over retraining models from scratch</block></blocks></line><line class="root text-mode indent-2 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="3"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;">* </prefix><blocks><baselineblock class="inline"></baselineblock><block>Are often pre-trained using the ImageNet dataset</block></blocks></line><line class="root text-mode indent-2 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="3"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;">* </prefix><blocks><baselineblock class="inline"></baselineblock><block>Repurposes earlier layers that encode higher level features (e.g. edges in images)</block></blocks></line><line class="root text-mode indent-2 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="3"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;">* </prefix><blocks><baselineblock class="inline"></baselineblock><block>Uses custom final layers specific to the new task</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Below is a comparison of common reference architectures and pre-trained weights used in transfer learning:</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item full-line-block-inside" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="matrix-symbol table-symbol role-tabular"><matrix class="table"><table data-table-id="n0.26283417612551085"><colgroup><col><col style="width: 128.784px;"><col style="width: 222.606px;"><col style="width: 185.1px;"></colgroup><tbody><tr><td data-rindex="0" data-cindex="0" style="padding: 0.5em; vertical-align: middle; border-color: rgb(0, 0, 0); border-style: solid; border-width: 1px;"><editarea class="text-mode"><line class="text-mode align-center" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; font-size: 0.9em; font-weight: bold;">Network</block></blocks></line></editarea></td><td data-rindex="0" data-cindex="1" style="padding: 0.5em; vertical-align: middle; border-color: rgb(0, 0, 0); border-style: solid; border-width: 1px;"><editarea class="text-mode"><line class="text-mode align-center" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; font-size: 0.9em; font-weight: bold;">Year</block></blocks></line></editarea></td><td data-rindex="0" data-cindex="2" style="padding: 0.5em; vertical-align: middle; border-color: rgb(0, 0, 0); border-style: solid; border-width: 1px;"><editarea class="text-mode"><line class="text-mode align-center" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; font-size: 0.9em; font-weight: bold;">Top-5 ImageNet Accuracy</block></blocks></line></editarea></td><td data-rindex="0" data-cindex="3" style="padding: 0.5em; vertical-align: middle; border-color: rgb(0, 0, 0); border-style: solid; border-width: 1px;"><editarea class="text-mode"><line class="text-mode align-center" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; font-size: 0.9em; font-weight: bold;"># of Params</block></blocks></line></editarea></td></tr><tr><td data-rindex="1" data-cindex="0" style="padding: 0.5em; vertical-align: middle; border-color: rgb(0, 0, 0); border-style: solid; border-width: 1px;"><editarea class="text-mode"><line class="text-mode align-center" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://proceedings.neurips.cc/paper/2012/file/c399862d3b9d6b76c8436e924a68c45b-Paper.pdf" style="text-decoration: underline; font-family: &quot;Computer Modern Serif&quot;, serif; font-size: 0.9em; color: rgb(17, 85, 204);"><a href="https://proceedings.neurips.cc/paper/2012/file/c399862d3b9d6b76c8436e924a68c45b-Paper.pdf" target="_blank" style="color: inherit; text-decoration: inherit;">AlexNet</a></block></blocks></line></editarea></td><td data-rindex="1" data-cindex="1" style="padding: 0.5em; vertical-align: middle; border-color: rgb(0, 0, 0); border-style: solid; border-width: 1px;"><editarea class="text-mode"><line class="text-mode align-center" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; font-size: 0.9em;">2012</block></blocks></line></editarea></td><td data-rindex="1" data-cindex="2" style="padding: 0.5em; vertical-align: middle; border-color: rgb(0, 0, 0); border-style: solid; border-width: 1px;"><editarea class="text-mode"><line class="text-mode align-center" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; font-size: 0.9em;">84.7%</block></blocks></line></editarea></td><td data-rindex="1" data-cindex="3" style="padding: 0.5em; vertical-align: middle; border-color: rgb(0, 0, 0); border-style: solid; border-width: 1px;"><editarea class="text-mode"><line class="text-mode align-center" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; font-size: 0.9em;">62M</block></blocks></line></editarea></td></tr><tr><td data-rindex="2" data-cindex="0" style="padding: 0.5em; vertical-align: middle; border-color: rgb(0, 0, 0); border-style: solid; border-width: 1px;"><editarea class="text-mode"><line class="text-mode align-center" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://arxiv.org/abs/1409.1556" style="text-decoration: underline; font-family: &quot;Computer Modern Serif&quot;, serif; font-size: 0.9em; color: rgb(17, 85, 204);"><a href="https://arxiv.org/abs/1409.1556" target="_blank" style="color: inherit; text-decoration: inherit;">VGGNet</a></block></blocks></line></editarea></td><td data-rindex="2" data-cindex="1" style="padding: 0.5em; vertical-align: middle; border-color: rgb(0, 0, 0); border-style: solid; border-width: 1px;"><editarea class="text-mode"><line class="text-mode align-center" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; font-size: 0.9em;">2014</block></blocks></line></editarea></td><td data-rindex="2" data-cindex="2" style="padding: 0.5em; vertical-align: middle; border-color: rgb(0, 0, 0); border-style: solid; border-width: 1px;"><editarea class="text-mode"><line class="text-mode align-center" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; font-size: 0.9em;">92.3%</block></blocks></line></editarea></td><td data-rindex="2" data-cindex="3" style="padding: 0.5em; vertical-align: middle; border-color: rgb(0, 0, 0); border-style: solid; border-width: 1px;"><editarea class="text-mode"><line class="text-mode align-center" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; font-size: 0.9em;">138M</block></blocks></line></editarea></td></tr><tr><td data-rindex="3" data-cindex="0" style="padding: 0.5em; vertical-align: middle; border-color: rgb(0, 0, 0); border-style: solid; border-width: 1px;"><editarea class="text-mode"><line class="text-mode align-center" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://arxiv.org/pdf/1409.4842.pdf" style="text-decoration: underline; font-family: &quot;Computer Modern Serif&quot;, serif; font-size: 0.9em; color: rgb(17, 85, 204);"><a href="https://arxiv.org/pdf/1409.4842.pdf" target="_blank" style="color: inherit; text-decoration: inherit;">Inception v1</a></block></blocks></line></editarea></td><td data-rindex="3" data-cindex="1" style="padding: 0.5em; vertical-align: middle; border-color: rgb(0, 0, 0); border-style: solid; border-width: 1px;"><editarea class="text-mode"><line class="text-mode align-center" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; font-size: 0.9em;">2014</block></blocks></line></editarea></td><td data-rindex="3" data-cindex="2" style="padding: 0.5em; vertical-align: middle; border-color: rgb(0, 0, 0); border-style: solid; border-width: 1px;"><editarea class="text-mode"><line class="text-mode align-center" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; font-size: 0.9em;">93.3%</block></blocks></line></editarea></td><td data-rindex="3" data-cindex="3" style="padding: 0.5em; vertical-align: middle; border-color: rgb(0, 0, 0); border-style: solid; border-width: 1px;"><editarea class="text-mode"><line class="text-mode align-center" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; font-size: 0.9em;">6.4M</block></blocks></line></editarea></td></tr><tr><td data-rindex="4" data-cindex="0" style="padding: 0.5em; vertical-align: middle; border-color: rgb(0, 0, 0); border-style: solid; border-width: 1px;"><editarea class="text-mode"><line class="text-mode align-center" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://arxiv.org/abs/1512.03385" style="text-decoration: underline; font-family: &quot;Computer Modern Serif&quot;, serif; font-size: 0.9em; color: rgb(17, 85, 204);"><a href="https://arxiv.org/abs/1512.03385" target="_blank" style="color: inherit; text-decoration: inherit;">ResNet-152</a></block></blocks></line></editarea></td><td data-rindex="4" data-cindex="1" style="padding: 0.5em; vertical-align: middle; border-color: rgb(0, 0, 0); border-style: solid; border-width: 1px;"><editarea class="text-mode"><line class="text-mode align-center" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; font-size: 0.9em;">2015</block></blocks></line></editarea></td><td data-rindex="4" data-cindex="2" style="padding: 0.5em; vertical-align: middle; border-color: rgb(0, 0, 0); border-style: solid; border-width: 1px;"><editarea class="text-mode"><line class="text-mode align-center" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; font-size: 0.9em;">95.5%</block></blocks></line></editarea></td><td data-rindex="4" data-cindex="3" style="padding: 0.5em; vertical-align: middle; border-color: rgb(0, 0, 0); border-style: solid; border-width: 1px;"><editarea class="text-mode"><line class="text-mode align-center" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; font-size: 0.9em;">60.3M</block></blocks></line></editarea></td></tr><tr><td data-rindex="5" data-cindex="0" style="padding: 0.5em; vertical-align: middle; border-color: rgb(0, 0, 0); border-style: solid; border-width: 1px;"><editarea class="text-mode"><line class="text-mode align-center" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://arxiv.org/abs/1512.00567" style="text-decoration: underline; font-family: &quot;Computer Modern Serif&quot;, serif; font-size: 0.9em; color: rgb(17, 85, 204);"><a href="https://arxiv.org/abs/1512.00567" target="_blank" style="color: inherit; text-decoration: inherit;">Inception v3</a></block></blocks></line></editarea></td><td data-rindex="5" data-cindex="1" style="padding: 0.5em; vertical-align: middle; border-color: rgb(0, 0, 0); border-style: solid; border-width: 1px;"><editarea class="text-mode"><line class="text-mode align-center" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; font-size: 0.9em;">2015</block></blocks></line></editarea></td><td data-rindex="5" data-cindex="2" style="padding: 0.5em; vertical-align: middle; border-color: rgb(0, 0, 0); border-style: solid; border-width: 1px;"><editarea class="text-mode"><line class="text-mode align-center" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; font-size: 0.9em;">94.4%</block></blocks></line></editarea></td><td data-rindex="5" data-cindex="3" style="padding: 0.5em; vertical-align: middle; border-color: rgb(0, 0, 0); border-style: solid; border-width: 1px;"><editarea class="text-mode"><line class="text-mode align-center" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; font-size: 0.9em;">23.8M</block></blocks></line></editarea></td></tr><tr><td data-rindex="6" data-cindex="0" style="padding: 0.5em; vertical-align: middle; border-color: rgb(0, 0, 0); border-style: solid; border-width: 1px;"><editarea class="text-mode"><line class="text-mode align-center" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://arxiv.org/abs/1610.02357" style="text-decoration: underline; font-family: &quot;Computer Modern Serif&quot;, serif; font-size: 0.9em; color: rgb(17, 85, 204);"><a href="https://arxiv.org/abs/1610.02357" target="_blank" style="color: inherit; text-decoration: inherit;">XCeption</a></block></blocks></line></editarea></td><td data-rindex="6" data-cindex="1" style="padding: 0.5em; vertical-align: middle; border-color: rgb(0, 0, 0); border-style: solid; border-width: 1px;"><editarea class="text-mode"><line class="text-mode align-center" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; font-size: 0.9em;">2016</block></blocks></line></editarea></td><td data-rindex="6" data-cindex="2" style="padding: 0.5em; vertical-align: middle; border-color: rgb(0, 0, 0); border-style: solid; border-width: 1px;"><editarea class="text-mode"><line class="text-mode align-center" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; font-size: 0.9em;">94.5%</block></blocks></line></editarea></td><td data-rindex="6" data-cindex="3" style="padding: 0.5em; vertical-align: middle; border-color: rgb(0, 0, 0); border-style: solid; border-width: 1px;"><editarea class="text-mode"><line class="text-mode align-center" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; font-size: 0.9em;">22.8M</block></blocks></line></editarea></td></tr><tr><td data-rindex="7" data-cindex="0" style="padding: 0.5em; vertical-align: middle; border-color: rgb(0, 0, 0); border-style: solid; border-width: 1px;"><editarea class="text-mode"><line class="text-mode align-center" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://arxiv.org/pdf/1707.07012.pdf" style="text-decoration: underline; font-family: &quot;Computer Modern Serif&quot;, serif; font-size: 0.9em; color: rgb(17, 85, 204);"><a href="https://arxiv.org/pdf/1707.07012.pdf" target="_blank" style="color: inherit; text-decoration: inherit;">NasNet</a></block></blocks></line></editarea></td><td data-rindex="7" data-cindex="1" style="padding: 0.5em; vertical-align: middle; border-color: rgb(0, 0, 0); border-style: solid; border-width: 1px;"><editarea class="text-mode"><line class="text-mode align-center" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; font-size: 0.9em;">2017</block></blocks></line></editarea></td><td data-rindex="7" data-cindex="2" style="padding: 0.5em; vertical-align: middle; border-color: rgb(0, 0, 0); border-style: solid; border-width: 1px;"><editarea class="text-mode"><line class="text-mode align-center" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; font-size: 0.9em;">95.3%</block></blocks></line></editarea></td><td data-rindex="7" data-cindex="3" style="padding: 0.5em; vertical-align: middle; border-color: rgb(0, 0, 0); border-style: solid; border-width: 1px;"><editarea class="text-mode"><line class="text-mode align-center" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; font-size: 0.9em;">22.6M</block></blocks></line></editarea></td></tr><tr><td data-rindex="8" data-cindex="0" style="padding: 0.5em; vertical-align: middle; border-color: rgb(0, 0, 0); border-style: solid; border-width: 1px;"><editarea class="text-mode"><line class="text-mode align-center" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://arxiv.org/pdf/1704.04861.pdf" style="text-decoration: underline; font-family: &quot;Computer Modern Serif&quot;, serif; font-size: 0.9em; color: rgb(17, 85, 204);"><a href="https://arxiv.org/pdf/1704.04861.pdf" target="_blank" style="color: inherit; text-decoration: inherit;">MobileNet</a></block></blocks></line></editarea></td><td data-rindex="8" data-cindex="1" style="padding: 0.5em; vertical-align: middle; border-color: rgb(0, 0, 0); border-style: solid; border-width: 1px;"><editarea class="text-mode"><line class="text-mode align-center" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; font-size: 0.9em;">2017</block></blocks></line></editarea></td><td data-rindex="8" data-cindex="2" style="padding: 0.5em; vertical-align: middle; border-color: rgb(0, 0, 0); border-style: solid; border-width: 1px;"><editarea class="text-mode"><line class="text-mode align-center" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; font-size: 0.9em;">89.5%</block></blocks></line></editarea></td><td data-rindex="8" data-cindex="3" style="padding: 0.5em; vertical-align: middle; border-color: rgb(0, 0, 0); border-style: solid; border-width: 1px;"><editarea class="text-mode"><line class="text-mode align-center" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; font-size: 0.9em;">4.24M</block></blocks></line></editarea></td></tr><tr><td data-rindex="9" data-cindex="0" style="padding: 0.5em; vertical-align: middle; border-color: rgb(0, 0, 0); border-style: solid; border-width: 1px;"><editarea class="text-mode"><line class="text-mode align-center" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://arxiv.org/pdf/1905.11946.pdf" style="text-decoration: underline; font-family: &quot;Computer Modern Serif&quot;, serif; font-size: 0.9em; color: rgb(17, 85, 204);"><a href="https://arxiv.org/pdf/1905.11946.pdf" target="_blank" style="color: inherit; text-decoration: inherit;">EfficientNet B5</a></block></blocks></line></editarea></td><td data-rindex="9" data-cindex="1" style="padding: 0.5em; vertical-align: middle; border-color: rgb(0, 0, 0); border-style: solid; border-width: 1px;"><editarea class="text-mode"><line class="text-mode align-center" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; font-size: 0.9em;">2019</block></blocks></line></editarea></td><td data-rindex="9" data-cindex="2" style="padding: 0.5em; vertical-align: middle; border-color: rgb(0, 0, 0); border-style: solid; border-width: 1px;"><editarea class="text-mode"><line class="text-mode align-center" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; font-size: 0.9em;">96.7%</block></blocks></line></editarea></td><td data-rindex="9" data-cindex="3" style="padding: 0.5em; vertical-align: middle; border-color: rgb(0, 0, 0); border-style: solid; border-width: 1px;"><editarea class="text-mode"><line class="text-mode align-center" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; font-size: 0.9em;">30M</block></blocks></line></editarea></td></tr></tbody></table><table-resize style="position: absolute; left: 0px; top: 0px; width: 0px; height: 0px;"></table-resize></matrix></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold; background-color: rgb(255, 254, 0);">Note:</block><block> See </block><block class="role-hyper-link" data-hyper-link-url="https://paperswithcode.com/sota/image-classification-on-imagenet" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://paperswithcode.com/sota/image-classification-on-imagenet" target="_blank" style="color: inherit; text-decoration: inherit;">this website</a></block><block> that compiles metrics on a variety of deep learning architectures.</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">[</block><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><compositeblock dir="ltr" class="anchor-tag-ref inline" style="font-family: &quot;Computer Modern Serif&quot;, serif; background-color: rgba(155, 155, 155, 0.2);"><a href="#n0.3715415633810799" style="color: inherit; text-decoration: inherit;">Back To Top</a></compositeblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">]</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode section sindent-1" data-line-id="n0.6988243629481734" style="font-size: 1.1em; padding-top: 0.5em; padding-bottom: 0.5em; font-weight: bold; line-height: 1.4;" id="n0.6988243629481734" role="heading" aria-level="2"><prefix style="text-align: left; padding-right: 0.25em;">7.1. </prefix><blocks><baselineblock class="inline"></baselineblock><block>Transfer Learning with Data Generators</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>We want to make a classifier that distinguishes between cats and dogs. </block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>To do this, we'll use VGG16, but instead of predicting 1000 classes, we will predict 2 classes (cat or dog). </block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>We have </block><block style="text-decoration: underline;">3 options</block><block>:</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;">1. </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold;">Use only the architecture from VGG16</block><block>, initialize the weights at random. This is a computationally expensive approach and requires a lot of data as you are training hundreds of millions of weights from scratch.</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;">2. </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold;">Use both the architecture from VGG16 and weights</block><block> pre-trained on ImageNet. Leave earlier layers frozen and retrain the later layers. This is less computationally expensive and still requires a good amount of data.</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;">3. </prefix><blocks><baselineblock class="inline"></baselineblock><block>Use both the architecture from VGG16 and the weights, but </block><block style="font-weight: bold;">freeze the entire network, and add an additional layer</block><block>. In this case, we would only train the final classification layer specific to our problem. This is fast and works with small amounts of data.</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;">3. </prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="text-decoration: underline;">Since our dataset is small and similar to the task VGG16 was trained on, we'll choose option 3</block><block>.</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold; background-color: rgb(255, 254, 0);">Would you want to use a high or low learning rate for transfer learning? Or different learning rates for different layers?</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold; background-color: rgb(255, 254, 0);">Note:</block><block> Here we use </block><block style="font-weight: bold; color: rgb(144, 19, 254);">Keras functional API</block><block>. </block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>The Keras functional API is a way to create models that is more flexible than the </block><block style="font-weight: bold; color: rgb(144, 19, 254);">tf.keras.Sequential API</block><block>. </block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>The functional API can </block><block style="text-decoration: underline;">handle models with non-linear topology, models with shared layers, and models with multiple inputs or outputs</block><block>. </block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>The </block><block style="text-decoration: underline;">main idea</block><block> that a deep learning model is usually a </block><block style="font-weight: bold; color: rgb(255, 64, 0);">directed acyclic graph (DAG) of layers</block><block>. </block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="background-color: rgb(255, 254, 0);">So the functional API is a way to build graphs of layers</block><block>.</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>To train the model, we use </block><block class="role-hyper-link" data-hyper-link-url="https://www.tensorflow.org/api_docs/python/tf/keras/preprocessing/image/ImageDataGenerator" style="text-decoration: underline; font-family: &quot;Computer Modern Typewriter&quot;, serif; font-weight: bold; color: rgb(17, 85, 204); background-color: rgb(255, 254, 0);"><a href="https://www.tensorflow.org/api_docs/python/tf/keras/preprocessing/image/ImageDataGenerator" target="_blank" style="color: inherit; text-decoration: inherit;">ImageDataGenerator</a></block><block style="background-color: rgb(255, 254, 0);"> class</block><block>. </block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="text-decoration: underline;">Generators are useful when your data is very large, as you only need to load one batch of data into memory at a time</block><block>. </block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>In general, </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">ImageDataGenerator</block><block> is used to </block><block style="text-decoration: underline;">configure random transformations and normalization operations</block><block> to be done on your image data </block><block style="text-decoration: underline;">during trainin</block><block>g, as well as instantiate generators of augmented image batches (and their labels).</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>These generators can be used with Keras model methods that accept data generators as inputs. </block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://www.tensorflow.org/api_docs/python/tf/keras/preprocessing/image/ImageDataGenerator#flow_from_dataframe" style="text-decoration: underline; font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(17, 85, 204);"><a href="https://www.tensorflow.org/api_docs/python/tf/keras/preprocessing/image/ImageDataGenerator#flow_from_dataframe" target="_blank" style="color: inherit; text-decoration: inherit;">flow_from_dataframe()</a></block><block> takes the dataframe and the path to a directory to generates batches.</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item full-line-block-inside" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="code-section-symbol inline" style="display: block;"><div class="code-section theme-tomorrow-night" style="display: block; border: 1px solid lightgray; background: rgb(45, 45, 45); padding: 10px; font-size: 12px;"><editarea class="text-mode code-section-edit-area" style="font-family: &quot;Fira code&quot;, &quot;Fira Mono&quot;, monospace;"><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  Reading data</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">from</block><block class=" token"> pyspark</block><block class="punctuation token">.</block><block class=" token">sql</block><block class="punctuation token">.</block><block class=" token">functions </block><block class="keyword token">import</block><block class=" token"> lit</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">df_cats </block><block class="operator token">=</block><block class=" token"> spark</block><block class="punctuation token">.</block><block class=" token">read</block><block class="punctuation token">.</block><block class="builtin token">format</block><block class="punctuation token">(</block><block class="string token">"binaryFile"</block><block class="punctuation token">)</block><block class="punctuation token">.</block><block class=" token">load</block><block class="punctuation token">(</block><block class="string-interpolation string token">f"</block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">DA</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">paths</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">datasets</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">/img/cats/*.jpg"</block><block class="punctuation token">)</block><block class="punctuation token">.</block><block class=" token">withColumn</block><block class="punctuation token">(</block><block class="string token">"label"</block><block class="punctuation token">,</block><block class=" token"> lit</block><block class="punctuation token">(</block><block class="string token">"cat"</block><block class="punctuation token">)</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">df_dogs </block><block class="operator token">=</block><block class=" token"> spark</block><block class="punctuation token">.</block><block class=" token">read</block><block class="punctuation token">.</block><block class="builtin token">format</block><block class="punctuation token">(</block><block class="string token">"binaryFile"</block><block class="punctuation token">)</block><block class="punctuation token">.</block><block class=" token">load</block><block class="punctuation token">(</block><block class="string-interpolation string token">f"</block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">DA</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">paths</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">datasets</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">/img/dogs/*.jpg"</block><block class="punctuation token">)</block><block class="punctuation token">.</block><block class=" token">withColumn</block><block class="punctuation token">(</block><block class="string token">"label"</block><block class="punctuation token">,</block><block class=" token"> lit</block><block class="punctuation token">(</block><block class="string token">"dog"</block><block class="punctuation token">)</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">cat_data </block><block class="operator token">=</block><block class=" token"> df_cats</block><block class="punctuation token">.</block><block class=" token">toPandas</block><block class="punctuation token">(</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">dog_data </block><block class="operator token">=</block><block class=" token"> df_dogs</block><block class="punctuation token">.</block><block class=" token">toPandas</block><block class="punctuation token">(</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">train_data </block><block class="operator token">=</block><block class=" token"> cat_data</block><block class="punctuation token">.</block><block class=" token">iloc</block><block class="punctuation token">[</block><block class="punctuation token">:</block><block class="number token">32</block><block class="punctuation token">]</block><block class="punctuation token">.</block><block class=" token">append</block><block class="punctuation token">(</block><block class=" token">dog_data</block><block class="punctuation token">.</block><block class=" token">iloc</block><block class="punctuation token">[</block><block class="punctuation token">:</block><block class="number token">32</block><block class="punctuation token">]</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">train_data</block><block class="punctuation token">[</block><block class="string token">"path"</block><block class="punctuation token">]</block><block class=" token"> </block><block class="operator token">=</block><block class=" token"> train_data</block><block class="punctuation token">[</block><block class="string token">"path"</block><block class="punctuation token">]</block><block class="punctuation token">.</block><block class="builtin token">apply</block><block class="punctuation token">(</block><block class="keyword token">lambda</block><block class=" token"> x</block><block class="punctuation token">:</block><block class=" token"> x</block><block class="punctuation token">.</block><block class=" token">replace</block><block class="punctuation token">(</block><block class="string token">"dbfs:/"</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"/dbfs/"</block><block class="punctuation token">)</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">test_data </block><block class="operator token">=</block><block class=" token"> cat_data</block><block class="punctuation token">.</block><block class=" token">iloc</block><block class="punctuation token">[</block><block class="number token">32</block><block class="punctuation token">:</block><block class="punctuation token">]</block><block class="punctuation token">.</block><block class=" token">append</block><block class="punctuation token">(</block><block class=" token">dog_data</block><block class="punctuation token">.</block><block class=" token">iloc</block><block class="punctuation token">[</block><block class="number token">32</block><block class="punctuation token">:</block><block class="punctuation token">]</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">test_data</block><block class="punctuation token">[</block><block class="string token">"path"</block><block class="punctuation token">]</block><block class=" token"> </block><block class="operator token">=</block><block class=" token"> test_data</block><block class="punctuation token">[</block><block class="string token">"path"</block><block class="punctuation token">]</block><block class="punctuation token">.</block><block class="builtin token">apply</block><block class="punctuation token">(</block><block class="keyword token">lambda</block><block class=" token"> x</block><block class="punctuation token">:</block><block class=" token"> x</block><block class="punctuation token">.</block><block class=" token">replace</block><block class="punctuation token">(</block><block class="string token">"dbfs:/"</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"/dbfs/"</block><block class="punctuation token">)</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Use Functional API to build the model</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">import</block><block class=" token"> tensorflow </block><block class="keyword token">as</block><block class=" token"> tf</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">from</block><block class=" token"> tensorflow</block><block class="punctuation token">.</block><block class=" token">keras </block><block class="keyword token">import</block><block class=" token"> applications</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">from</block><block class=" token"> tensorflow</block><block class="punctuation token">.</block><block class=" token">keras</block><block class="punctuation token">.</block><block class=" token">preprocessing</block><block class="punctuation token">.</block><block class=" token">image </block><block class="keyword token">import</block><block class=" token"> ImageDataGenerator</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">from</block><block class=" token"> tensorflow</block><block class="punctuation token">.</block><block class=" token">keras</block><block class="punctuation token">.</block><block class=" token">models </block><block class="keyword token">import</block><block class=" token"> Model </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">from</block><block class=" token"> tensorflow</block><block class="punctuation token">.</block><block class=" token">keras</block><block class="punctuation token">.</block><block class=" token">layers </block><block class="keyword token">import</block><block class=" token"> Dense</block><block class="punctuation token">,</block><block class=" token"> Input</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">import</block><block class=" token"> pandas </block><block class="keyword token">as</block><block class=" token"> pd</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">tf</block><block class="punctuation token">.</block><block class=" token">random</block><block class="punctuation token">.</block><block class=" token">set_seed</block><block class="punctuation token">(</block><block class="number token">42</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Load original model with pretrained weights from imagenet</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># We do not want to use the ImageNet classifier at the top since it has many irrelevant categories</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">base_model </block><block class="operator token">=</block><block class=" token"> applications</block><block class="punctuation token">.</block><block class=" token">VGG16</block><block class="punctuation token">(</block><block class=" token">weights</block><block class="operator token">=</block><block class="string token">"imagenet"</block><block class="punctuation token">,</block><block class=" token"> include_top</block><block class="operator token">=</block><block class="boolean token">False</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Freeze base model</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">base_model</block><block class="punctuation token">.</block><block class=" token">trainable </block><block class="operator token">=</block><block class=" token"> </block><block class="boolean token">False</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Create new model on top</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">img_height </block><block class="operator token">=</block><block class=" token"> </block><block class="number token">224</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">img_width </block><block class="operator token">=</block><block class=" token"> </block><block class="number token">224</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">inputs </block><block class="operator token">=</block><block class=" token"> Input</block><block class="punctuation token">(</block><block class=" token">shape</block><block class="operator token">=</block><block class="punctuation token">(</block><block class=" token">img_height</block><block class="punctuation token">,</block><block class=" token"> img_width</block><block class="punctuation token">,</block><block class=" token"> </block><block class="number token">3</block><block class="punctuation token">)</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">x </block><block class="operator token">=</block><block class=" token"> base_model</block><block class="punctuation token">(</block><block class=" token">inputs</block><block class="punctuation token">,</block><block class=" token"> training</block><block class="operator token">=</block><block class="boolean token">False</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">x </block><block class="operator token">=</block><block class=" token"> tf</block><block class="punctuation token">.</block><block class=" token">keras</block><block class="punctuation token">.</block><block class=" token">layers</block><block class="punctuation token">.</block><block class=" token">GlobalAveragePooling2D</block><block class="punctuation token">(</block><block class="punctuation token">)</block><block class="punctuation token">(</block><block class=" token">x</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">outputs </block><block class="operator token">=</block><block class=" token"> Dense</block><block class="punctuation token">(</block><block class="number token">1</block><block class="punctuation token">,</block><block class=" token"> activation</block><block class="operator token">=</block><block class="string token">"sigmoid"</block><block class="punctuation token">)</block><block class="punctuation token">(</block><block class=" token">x</block><block class="punctuation token">)</block><block class=" token"> </block><block class="comment token"># we want to output probabilities for both classes</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">model </block><block class="operator token">=</block><block class=" token"> Model</block><block class="punctuation token">(</block><block class=" token">inputs</block><block class="punctuation token">,</block><block class=" token"> outputs</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">model</block><block class="punctuation token">.</block><block class=" token">summary</block><block class="punctuation token">(</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Using ImageDataGenerator</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">import</block><block class=" token"> mlflow</block><block class="punctuation token">.</block><block class=" token">tensorflow</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">from</block><block class=" token"> tensorflow</block><block class="punctuation token">.</block><block class=" token">keras</block><block class="punctuation token">.</block><block class=" token">optimizers </block><block class="keyword token">import</block><block class=" token"> Adam</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Check out the MLflow UI as this runs</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">mlflow</block><block class="punctuation token">.</block><block class=" token">tensorflow</block><block class="punctuation token">.</block><block class=" token">autolog</block><block class="punctuation token">(</block><block class=" token">every_n_iter</block><block class="operator token">=</block><block class="number token">2</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">model</block><block class="punctuation token">.</block><block class="builtin token">compile</block><block class="punctuation token">(</block><block class=" token">loss</block><block class="operator token">=</block><block class="string token">"binary_crossentropy"</block><block class="punctuation token">,</block><block class=" token"> optimizer</block><block class="operator token">=</block><block class=" token">Adam</block><block class="punctuation token">(</block><block class=" token">learning_rate</block><block class="operator token">=</block><block class="number token">0.005</block><block class="punctuation token">)</block><block class="punctuation token">,</block><block class=" token"> metrics</block><block class="operator token">=</block><block class="punctuation token">[</block><block class="string token">"accuracy"</block><block class="punctuation token">]</block><block class="punctuation token">)</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Loading training data</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">batch_size </block><block class="operator token">=</block><block class=" token"> </block><block class="number token">8</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">train_datagen </block><block class="operator token">=</block><block class=" token"> ImageDataGenerator</block><block class="punctuation token">(</block><block class=" token">preprocessing_function</block><block class="operator token">=</block><block class=" token">applications</block><block class="punctuation token">.</block><block class=" token">vgg16</block><block class="punctuation token">.</block><block class=" token">preprocess_input</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">train_generator </block><block class="operator token">=</block><block class=" token"> train_datagen</block><block class="punctuation token">.</block><block class=" token">flow_from_dataframe</block><block class="punctuation token">(</block><block class=" token">dataframe</block><block class="operator token">=</block><block class=" token">train_data</block><block class="punctuation token">,</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                                                    directory</block><block class="operator token">=</block><block class="boolean token">None</block><block class="punctuation token">,</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                                                    x_col</block><block class="operator token">=</block><block class="string token">"path"</block><block class="punctuation token">,</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                                                    y_col</block><block class="operator token">=</block><block class="string token">"label"</block><block class="punctuation token">,</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                                                    class_mode</block><block class="operator token">=</block><block class="string token">"binary"</block><block class="punctuation token">,</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                                                    target_size</block><block class="operator token">=</block><block class="punctuation token">(</block><block class=" token">img_height</block><block class="punctuation token">,</block><block class=" token"> img_width</block><block class="punctuation token">)</block><block class="punctuation token">,</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                                                    batch_size</block><block class="operator token">=</block><block class=" token">batch_size</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">print</block><block class="punctuation token">(</block><block class="string-interpolation string token">f"Class labels: </block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">train_generator</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">class_indices</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">step_size </block><block class="operator token">=</block><block class=" token"> train_generator</block><block class="punctuation token">.</block><block class=" token">n</block><block class="operator token">//</block><block class=" token">train_generator</block><block class="punctuation token">.</block><block class=" token">batch_size</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Train the model</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># You might want to increase the # of epochs, but it will take longer to train</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">model</block><block class="punctuation token">.</block><block class=" token">fit</block><block class="punctuation token">(</block><block class=" token">train_generator</block><block class="punctuation token">,</block><block class=" token"> epochs</block><block class="operator token">=</block><block class="number token">3</block><block class="punctuation token">,</block><block class=" token"> steps_per_epoch</block><block class="operator token">=</block><block class=" token">step_size</block><block class="punctuation token">,</block><block class=" token"> verbose</block><block class="operator token">=</block><block class="number token">2</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Model evaluation</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Evaluate model on test set</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">test_datagen </block><block class="operator token">=</block><block class=" token"> ImageDataGenerator</block><block class="punctuation token">(</block><block class=" token">preprocessing_function</block><block class="operator token">=</block><block class=" token">applications</block><block class="punctuation token">.</block><block class=" token">vgg16</block><block class="punctuation token">.</block><block class=" token">preprocess_input</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Small dataset so we can evaluate it in one batch</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">batch_size </block><block class="operator token">=</block><block class=" token"> test_data</block><block class="punctuation token">.</block><block class=" token">count</block><block class="punctuation token">(</block><block class="punctuation token">)</block><block class="punctuation token">[</block><block class="number token">0</block><block class="punctuation token">]</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">test_generator </block><block class="operator token">=</block><block class=" token"> test_datagen</block><block class="punctuation token">.</block><block class=" token">flow_from_dataframe</block><block class="punctuation token">(</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    dataframe</block><block class="operator token">=</block><block class=" token">test_data</block><block class="punctuation token">,</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    directory</block><block class="operator token">=</block><block class="boolean token">None</block><block class="punctuation token">,</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    x_col</block><block class="operator token">=</block><block class="string token">"path"</block><block class="punctuation token">,</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    y_col</block><block class="operator token">=</block><block class="string token">"label"</block><block class="punctuation token">,</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    class_mode</block><block class="operator token">=</block><block class="string token">"binary"</block><block class="punctuation token">,</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    target_size</block><block class="operator token">=</block><block class="punctuation token">(</block><block class=" token">img_height</block><block class="punctuation token">,</block><block class=" token"> img_width</block><block class="punctuation token">)</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    shuffle</block><block class="operator token">=</block><block class="boolean token">False</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    batch_size</block><block class="operator token">=</block><block class=" token">batch_size</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">step_size </block><block class="operator token">=</block><block class=" token"> test_generator</block><block class="punctuation token">.</block><block class=" token">n</block><block class="operator token">//</block><block class=" token">test_generator</block><block class="punctuation token">.</block><block class=" token">batch_size</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">eval_results </block><block class="operator token">=</block><block class=" token"> model</block><block class="punctuation token">.</block><block class=" token">evaluate</block><block class="punctuation token">(</block><block class=" token">test_generator</block><block class="punctuation token">,</block><block class=" token"> steps</block><block class="operator token">=</block><block class=" token">step_size</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">print</block><block class="punctuation token">(</block><block class="string-interpolation string token">f"Loss: </block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">eval_results</block><block class="string-interpolation interpolation punctuation token">[</block><block class="string-interpolation interpolation number token">0</block><block class="string-interpolation interpolation punctuation token">]</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">. Accuracy: </block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">eval_results</block><block class="string-interpolation interpolation punctuation token">[</block><block class="string-interpolation interpolation number token">1</block><block class="string-interpolation interpolation punctuation token">]</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Visualize the results</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">predictions </block><block class="operator token">=</block><block class=" token"> pd</block><block class="punctuation token">.</block><block class=" token">DataFrame</block><block class="punctuation token">(</block><block class="punctuation token">{</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="string token">"Prediction"</block><block class="punctuation token">:</block><block class=" token"> </block><block class="punctuation token">(</block><block class="punctuation token">(</block><block class=" token">model</block><block class="punctuation token">.</block><block class=" token">predict</block><block class="punctuation token">(</block><block class=" token">test_generator</block><block class="punctuation token">)</block><block class=" token"> </block><block class="operator token">&gt;=</block><block class=" token"> </block><block class="number token">0.5</block><block class="punctuation token">)</block><block class="operator token">+</block><block class="number token">0</block><block class="punctuation token">)</block><block class="punctuation token">.</block><block class=" token">ravel</block><block class="punctuation token">(</block><block class="punctuation token">)</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="string token">"True"</block><block class="punctuation token">:</block><block class=" token"> test_generator</block><block class="punctuation token">.</block><block class=" token">classes</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="string token">"Path"</block><block class="punctuation token">:</block><block class=" token"> test_data</block><block class="punctuation token">[</block><block class="string token">"path"</block><block class="punctuation token">]</block><block class="punctuation token">.</block><block class="builtin token">apply</block><block class="punctuation token">(</block><block class="keyword token">lambda</block><block class=" token"> x</block><block class="punctuation token">:</block><block class=" token"> x</block><block class="punctuation token">.</block><block class=" token">replace</block><block class="punctuation token">(</block><block class="string token">"/dbfs"</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"dbfs:"</block><block class="punctuation token">)</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="punctuation token">}</block><block class="punctuation token">)</block><block class="punctuation token">.</block><block class=" token">replace</block><block class="punctuation token">(</block><block class="punctuation token">{</block><block class=" token">v</block><block class="punctuation token">:</block><block class=" token"> k </block><block class="keyword token">for</block><block class=" token"> k</block><block class="punctuation token">,</block><block class=" token"> v </block><block class="keyword token">in</block><block class=" token"> train_generator</block><block class="punctuation token">.</block><block class=" token">class_indices</block><block class="punctuation token">.</block><block class=" token">items</block><block class="punctuation token">(</block><block class="punctuation token">)</block><block class="punctuation token">}</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">all_images_df </block><block class="operator token">=</block><block class=" token"> df_cats</block><block class="punctuation token">.</block><block class=" token">union</block><block class="punctuation token">(</block><block class=" token">df_dogs</block><block class="punctuation token">)</block><block class="punctuation token">.</block><block class=" token">drop</block><block class="punctuation token">(</block><block class="string token">"label"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">predictions_df </block><block class="operator token">=</block><block class=" token"> spark</block><block class="punctuation token">.</block><block class=" token">createDataFrame</block><block class="punctuation token">(</block><block class=" token">predictions</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">display</block><block class="punctuation token">(</block><block class=" token">all_images_df</block><block class="punctuation token">.</block><block class=" token">join</block><block class="punctuation token">(</block><block class=" token">predictions_df</block><block class="punctuation token">,</block><block class=" token"> predictions_df</block><block class="punctuation token">.</block><block class=" token">Path</block><block class="operator token">==</block><block class=" token">all_images_df</block><block class="punctuation token">.</block><block class=" token">path</block><block class="punctuation token">)</block><block class="punctuation token">.</block><block class=" token">select</block><block class="punctuation token">(</block><block class="string token">"content"</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"Prediction"</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"True"</block><block class="punctuation token">)</block><block class="punctuation token">)</block></blocks></line></editarea></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">[</block><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><compositeblock dir="ltr" class="anchor-tag-ref inline" style="font-family: &quot;Computer Modern Serif&quot;, serif; background-color: rgba(155, 155, 155, 0.2);"><a href="#n0.3715415633810799" style="color: inherit; text-decoration: inherit;">Back To Top</a></compositeblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">]</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode section sindent-1" data-line-id="n0.9899541174798581" style="font-size: 1.1em; padding-top: 0.5em; padding-bottom: 0.5em; font-weight: bold; line-height: 1.4;" id="n0.9899541174798581" role="heading" aria-level="2"><prefix style="text-align: left; padding-right: 0.25em;">7.2. </prefix><blocks><baselineblock class="inline"></baselineblock><block>Transfer Learning with TFRecord</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold;">What is </block><block style="font-weight: bold; color: rgb(255, 64, 0);">TFRecord</block><block style="font-weight: bold;">?</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="background-color: rgb(255, 254, 0);">The </block><block style="text-decoration: underline; background-color: rgb(255, 254, 0);">default data format for TF</block><block style="background-color: rgb(255, 254, 0);"> and is optimized using Googles Protocol Buffers (aka </block><block style="font-weight: bold; background-color: rgb(255, 254, 0);">protobuf</block><block style="background-color: rgb(255, 254, 0);">)</block><block>.</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>A </block><block style="font-weight: bold;">simple binary format</block><block> that contains a </block><block style="font-weight: bold;">sequence of binary records</block><block>, enabling </block><block style="font-weight: bold;">very efficient reading and writing</block><block>.</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>By </block><block style="text-decoration: underline;">default</block><block>, </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">TFRecordDataset</block><block> reads files </block><block style="text-decoration: underline;">sequentially</block><block>, so you will see later we need to use </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">num_parallel_calls</block><block> to allow reading multiple files in parallel.</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>It is a series of </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">tf.Examples</block><block>, where each </block><block style="font-style: italic;">Example</block><block> is a </block><block style="text-decoration: underline;">key-value pair</block><block>.</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>To load </block><block style="font-weight: bold;">TFRecord</block><block>, we need to parse each </block><block style="font-style: italic;">Example</block><block> using </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">tf.io.parse_single_example</block><block> and provide the instructions (feature descriptions) on how to serialize the features. </block></blocks></line><line class="root text-mode indent-2 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="3"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;">* </prefix><blocks><baselineblock class="inline"></baselineblock><block>We can then apply the parsing function to all the data by using </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">map</block><block> function later.</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://www.tensorflow.org/tutorials/load_data/tfrecord" style="text-decoration: underline; font-weight: bold; color: rgb(17, 85, 204);"><a href="https://www.tensorflow.org/tutorials/load_data/tfrecord" target="_blank" style="color: inherit; text-decoration: inherit;">Reference documentation</a></block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>One of the methods to store training data is to use directory structures like this: </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">path_to_directory/img/cats/cat1.jpg</block><block>, </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">path_to_directory/img/cats/cat1.jpg</block><block>, ....</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="background-color: rgb(255, 254, 0);">It has a major drawback that it slows down the process.</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Opening a file is a time-consuming operation, so having to open a larger number of files adds significant overhead to the training time.</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold; background-color: rgb(255, 254, 0);">Note:</block><block> If you need to debug, you can take one image from the file path, for example:</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-1 has-indent list-item full-line-block-inside" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="code-section-symbol inline" style="display: block;"><div class="code-section theme-tomorrow-night" style="display: block; border: 1px solid lightgray; background: rgb(45, 45, 45); padding: 10px; font-size: 12px;"><editarea class="text-mode code-section-edit-area" style="font-family: &quot;Fira code&quot;, &quot;Fira Mono&quot;, monospace;"><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">raw_image_dataset </block><block class="operator token">=</block><block class=" token"> tf</block><block class="punctuation token">.</block><block class=" token">data</block><block class="punctuation token">.</block><block class=" token">TFRecordDataset</block><block class="punctuation token">(</block><block class=" token">tfr_train_file_path</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">raw </block><block class="operator token">=</block><block class=" token"> </block><block class="builtin token">next</block><block class="punctuation token">(</block><block class="builtin token">iter</block><block class="punctuation token">(</block><block class=" token">raw_image_dataset</block><block class="punctuation token">)</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">parsed </block><block class="operator token">=</block><block class=" token"> tf</block><block class="punctuation token">.</block><block class=" token">io</block><block class="punctuation token">.</block><block class=" token">parse_single_example</block><block class="punctuation token">(</block><block class=" token">raw</block><block class="punctuation token">,</block><block class=" token"> image_feature_description</block><block class="punctuation token">)</block></blocks></line></editarea></div></compositeblock></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="color: rgb(0, 0, 0); flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="color: rgb(0, 0, 0); font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold;">There are a couple of </block><block style="text-decoration: underline; font-weight: bold;">important things to notice</block><block style="font-weight: bold;"> below:</block></blocks></line><line class="root text-mode indent-2 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="3"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;">* </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">num_parallel_calls</block><block>, </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">prefetch</block><block>, and </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">map()</block><block> are important for us to exploit multiple cores.</block></blocks></line><line class="root text-mode indent-2 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="3"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;">* </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">shuffle</block><block>: This allows the training process to benefit from a non-deterministic order of reading data, improving model quality.</block></blocks></line><line class="root text-mode indent-2 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="3"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;">* </prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="color: rgb(0, 0, 0); flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>You might also read that some pipelines have </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">cache()</block><block> after </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">map()</block><block>  </block><block style="text-decoration: underline;">but before shuffling, prefetching, and batching</block><block>  to cache the content to RAM. However, </block><block style="background-color: rgb(255, 254, 0);">this is not recommended if your data is large</block><block>.</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Here's the training data. Above, we mentioned the drawback with this way of structuring the data.</block></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 714.794px; height: 221.85px; position: relative;"><img src="image-resources/6b759c7d-4eea-4a65-bc6f-61e5c4a36876.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item full-line-block-inside" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="code-section-symbol inline" style="display: block;"><div class="code-section theme-tomorrow-night" style="display: block; border: 1px solid lightgray; background: rgb(45, 45, 45); padding: 10px; font-size: 10px;"><editarea class="text-mode code-section-edit-area" style="font-family: &quot;Fira code&quot;, &quot;Fira Mono&quot;, monospace;"><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">import</block><block class=" token"> glob</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">cats_dir </block><block class="operator token">=</block><block class=" token"> </block><block class="string-interpolation string token">f"</block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">DA</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">paths</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">datasets</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">replace</block><block class="string-interpolation interpolation punctuation token">(</block><block class="string-interpolation interpolation string token">'dbfs:/'</block><block class="string-interpolation interpolation punctuation token">,</block><block class="string-interpolation interpolation token"> </block><block class="string-interpolation interpolation string token">'/dbfs/'</block><block class="string-interpolation interpolation punctuation token">)</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">/img/cats/cats*.jpg"</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">dogs_dir </block><block class="operator token">=</block><block class=" token"> </block><block class="string-interpolation string token">f"</block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">DA</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">paths</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">datasets</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">replace</block><block class="string-interpolation interpolation punctuation token">(</block><block class="string-interpolation interpolation string token">'dbfs:/'</block><block class="string-interpolation interpolation punctuation token">,</block><block class="string-interpolation interpolation token"> </block><block class="string-interpolation interpolation string token">'/dbfs/'</block><block class="string-interpolation interpolation punctuation token">)</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">/img/dogs/dog*.jpg"</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">train_cat_list </block><block class="operator token">=</block><block class=" token"> </block><block class="builtin token">list</block><block class="punctuation token">(</block><block class=" token">glob</block><block class="punctuation token">.</block><block class=" token">glob</block><block class="punctuation token">(</block><block class=" token">cats_dir</block><block class="punctuation token">)</block><block class="punctuation token">[</block><block class="punctuation token">:</block><block class="number token">32</block><block class="punctuation token">]</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">train_dog_list </block><block class="operator token">=</block><block class=" token"> </block><block class="builtin token">list</block><block class="punctuation token">(</block><block class=" token">glob</block><block class="punctuation token">.</block><block class=" token">glob</block><block class="punctuation token">(</block><block class=" token">dogs_dir</block><block class="punctuation token">)</block><block class="punctuation token">[</block><block class="punctuation token">:</block><block class="number token">32</block><block class="punctuation token">]</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">test_cat_list </block><block class="operator token">=</block><block class=" token"> </block><block class="builtin token">list</block><block class="punctuation token">(</block><block class=" token">glob</block><block class="punctuation token">.</block><block class=" token">glob</block><block class="punctuation token">(</block><block class=" token">cats_dir</block><block class="punctuation token">)</block><block class="punctuation token">[</block><block class="number token">32</block><block class="punctuation token">:</block><block class="punctuation token">]</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">test_dog_list </block><block class="operator token">=</block><block class=" token"> </block><block class="builtin token">list</block><block class="punctuation token">(</block><block class=" token">glob</block><block class="punctuation token">.</block><block class=" token">glob</block><block class="punctuation token">(</block><block class=" token">dogs_dir</block><block class="punctuation token">)</block><block class="punctuation token">[</block><block class="number token">32</block><block class="punctuation token">:</block><block class="punctuation token">]</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">train_data_paths </block><block class="operator token">=</block><block class=" token"> train_cat_list </block><block class="operator token">+</block><block class=" token"> train_dog_list </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">test_data_paths </block><block class="operator token">=</block><block class=" token"> test_cat_list </block><block class="operator token">+</block><block class=" token"> test_dog_list</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">print</block><block class="punctuation token">(</block><block class="builtin token">len</block><block class="punctuation token">(</block><block class=" token">train_data_paths</block><block class="punctuation token">)</block><block class="punctuation token">,</block><block class=" token"> </block><block class="builtin token">len</block><block class="punctuation token">(</block><block class=" token">test_data_paths</block><block class="punctuation token">)</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">from</block><block class=" token"> dataclasses </block><block class="keyword token">import</block><block class=" token"> dataclass</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">@dataclass</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">class</block><block class=" token"> </block><block class="class-name token">TrainConfig</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    img_height</block><block class="punctuation token">:</block><block class=" token"> </block><block class="builtin token">int</block><block class=" token"> </block><block class="operator token">=</block><block class=" token"> </block><block class="number token">224</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    img_width</block><block class="punctuation token">:</block><block class=" token"> </block><block class="builtin token">int</block><block class=" token"> </block><block class="operator token">=</block><block class=" token"> </block><block class="number token">224</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    img_channels</block><block class="punctuation token">:</block><block class=" token"> </block><block class="builtin token">int</block><block class=" token"> </block><block class="operator token">=</block><block class=" token"> </block><block class="number token">3</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    batch_size</block><block class="punctuation token">:</block><block class=" token"> </block><block class="builtin token">int</block><block class=" token"> </block><block class="operator token">=</block><block class=" token"> </block><block class="number token">64</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    epochs</block><block class="punctuation token">:</block><block class=" token"> </block><block class="builtin token">int</block><block class=" token"> </block><block class="operator token">=</block><block class=" token"> </block><block class="number token">10</block><block class=" token">    </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    learning_rate</block><block class="punctuation token">:</block><block class=" token"> </block><block class="builtin token">float</block><block class=" token"> </block><block class="operator token">=</block><block class=" token"> </block><block class="number token">0.0125</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    verbose</block><block class="punctuation token">:</block><block class=" token"> </block><block class="builtin token">int</block><block class=" token"> </block><block class="operator token">=</block><block class=" token"> </block><block class="number token">1</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Writing as TFRecord</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">from</block><block class=" token"> pathlib </block><block class="keyword token">import</block><block class=" token"> Path</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">import</block><block class=" token"> os</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">import</block><block class=" token"> tensorflow </block><block class="keyword token">as</block><block class=" token"> tf</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">def</block><block class=" token"> </block><block class="function token">write_to_tfrecords</block><block class="punctuation token">(</block><block class=" token">target_dir</block><block class="punctuation token">,</block><block class=" token"> data_paths</block><block class="punctuation token">,</block><block class=" token"> prefix</block><block class="punctuation token">)</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    tfr_path </block><block class="operator token">=</block><block class=" token"> </block><block class="string-interpolation string token">f"</block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">target_dir</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">/tf_records/"</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    dbutils</block><block class="punctuation token">.</block><block class=" token">fs</block><block class="punctuation token">.</block><block class=" token">mkdirs</block><block class="punctuation token">(</block><block class=" token">tfr_path</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    tfr_file_path </block><block class="operator token">=</block><block class=" token"> os</block><block class="punctuation token">.</block><block class=" token">path</block><block class="punctuation token">.</block><block class=" token">join</block><block class="punctuation token">(</block><block class=" token">target_dir</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string-interpolation string token">f"cats_dogs_</block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">prefix</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">.tfrecords"</block><block class="punctuation token">)</block><block class="punctuation token">.</block><block class=" token">replace</block><block class="punctuation token">(</block><block class="string token">"dbfs:/"</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"/dbfs/"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    writer </block><block class="operator token">=</block><block class=" token"> tf</block><block class="punctuation token">.</block><block class=" token">io</block><block class="punctuation token">.</block><block class=" token">TFRecordWriter</block><block class="punctuation token">(</block><block class=" token">tfr_file_path</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="comment token"># the number of classes of images</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    classes </block><block class="operator token">=</block><block class=" token"> </block><block class="punctuation token">{</block><block class="string token">"0"</block><block class=" token"> </block><block class="punctuation token">:</block><block class=" token"> </block><block class="string token">"cats"</block><block class="punctuation token">,</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">               </block><block class="string token">"1"</block><block class=" token"> </block><block class="punctuation token">:</block><block class=" token"> </block><block class="string token">"dogs"</block><block class="punctuation token">}</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="comment token"># Loop to convert each image array to raw bytes one at a time</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="keyword token">for</block><block class=" token"> img_path </block><block class="keyword token">in</block><block class=" token"> data_paths</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">      </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block><block class="comment token"># Get the integer value for the associated label </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        label </block><block class="operator token">=</block><block class=" token"> Path</block><block class="punctuation token">(</block><block class=" token">img_path</block><block class="punctuation token">)</block><block class="punctuation token">.</block><block class=" token">parent</block><block class="punctuation token">.</block><block class=" token">name</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        label_int </block><block class="operator token">=</block><block class=" token"> </block><block class="builtin token">list</block><block class="punctuation token">(</block><block class=" token">classes</block><block class="punctuation token">.</block><block class=" token">values</block><block class="punctuation token">(</block><block class="punctuation token">)</block><block class="punctuation token">)</block><block class="punctuation token">.</block><block class=" token">index</block><block class="punctuation token">(</block><block class=" token">label</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        img_raw </block><block class="operator token">=</block><block class=" token"> </block><block class="builtin token">open</block><block class="punctuation token">(</block><block class=" token">img_path</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"rb"</block><block class="punctuation token">)</block><block class="punctuation token">.</block><block class=" token">read</block><block class="punctuation token">(</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        img_shape </block><block class="operator token">=</block><block class=" token"> tf</block><block class="punctuation token">.</block><block class=" token">io</block><block class="punctuation token">.</block><block class=" token">decode_jpeg</block><block class="punctuation token">(</block><block class=" token">img_raw</block><block class="punctuation token">)</block><block class="punctuation token">.</block><block class=" token">shape</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block><block class="comment token"># To store data, we need to add feature to it</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block><block class="comment token"># Each feature has a key value pair, where the key holds the string name and the value holds the data</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        my_features </block><block class="operator token">=</block><block class=" token"> </block><block class="punctuation token">{</block><block class="string token">"height"</block><block class="punctuation token">:</block><block class=" token"> tf</block><block class="punctuation token">.</block><block class=" token">train</block><block class="punctuation token">.</block><block class=" token">Feature</block><block class="punctuation token">(</block><block class=" token">int64_list</block><block class="operator token">=</block><block class=" token">tf</block><block class="punctuation token">.</block><block class=" token">train</block><block class="punctuation token">.</block><block class=" token">Int64List</block><block class="punctuation token">(</block><block class=" token">value</block><block class="operator token">=</block><block class="punctuation token">[</block><block class=" token">img_shape</block><block class="punctuation token">[</block><block class="number token">0</block><block class="punctuation token">]</block><block class="punctuation token">]</block><block class="punctuation token">)</block><block class="punctuation token">)</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                       </block><block class="string token">"width"</block><block class="punctuation token">:</block><block class=" token"> tf</block><block class="punctuation token">.</block><block class=" token">train</block><block class="punctuation token">.</block><block class=" token">Feature</block><block class="punctuation token">(</block><block class=" token">int64_list</block><block class="operator token">=</block><block class=" token">tf</block><block class="punctuation token">.</block><block class=" token">train</block><block class="punctuation token">.</block><block class=" token">Int64List</block><block class="punctuation token">(</block><block class=" token">value</block><block class="operator token">=</block><block class="punctuation token">[</block><block class=" token">img_shape</block><block class="punctuation token">[</block><block class="number token">1</block><block class="punctuation token">]</block><block class="punctuation token">]</block><block class="punctuation token">)</block><block class="punctuation token">)</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                       </block><block class="string token">"depth"</block><block class="punctuation token">:</block><block class=" token"> tf</block><block class="punctuation token">.</block><block class=" token">train</block><block class="punctuation token">.</block><block class=" token">Feature</block><block class="punctuation token">(</block><block class=" token">int64_list</block><block class="operator token">=</block><block class=" token">tf</block><block class="punctuation token">.</block><block class=" token">train</block><block class="punctuation token">.</block><block class=" token">Int64List</block><block class="punctuation token">(</block><block class=" token">value</block><block class="operator token">=</block><block class="punctuation token">[</block><block class=" token">img_shape</block><block class="punctuation token">[</block><block class="number token">2</block><block class="punctuation token">]</block><block class="punctuation token">]</block><block class="punctuation token">)</block><block class="punctuation token">)</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                       </block><block class="string token">"img_raw"</block><block class="punctuation token">:</block><block class=" token"> tf</block><block class="punctuation token">.</block><block class=" token">train</block><block class="punctuation token">.</block><block class=" token">Feature</block><block class="punctuation token">(</block><block class=" token">bytes_list</block><block class="operator token">=</block><block class=" token">tf</block><block class="punctuation token">.</block><block class=" token">train</block><block class="punctuation token">.</block><block class=" token">BytesList</block><block class="punctuation token">(</block><block class=" token">value</block><block class="operator token">=</block><block class="punctuation token">[</block><block class=" token">img_raw</block><block class="punctuation token">]</block><block class="punctuation token">)</block><block class="punctuation token">)</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                       </block><block class="comment token"># tf.train.Feature must be in either bytes, float, or integer </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                       </block><block class="string token">"label"</block><block class="punctuation token">:</block><block class=" token"> tf</block><block class="punctuation token">.</block><block class=" token">train</block><block class="punctuation token">.</block><block class=" token">Feature</block><block class="punctuation token">(</block><block class=" token">int64_list</block><block class="operator token">=</block><block class=" token">tf</block><block class="punctuation token">.</block><block class=" token">train</block><block class="punctuation token">.</block><block class=" token">Int64List</block><block class="punctuation token">(</block><block class=" token">value</block><block class="operator token">=</block><block class="punctuation token">[</block><block class="builtin token">int</block><block class="punctuation token">(</block><block class=" token">label_int</block><block class="punctuation token">)</block><block class="punctuation token">]</block><block class="punctuation token">)</block><block class="punctuation token">)</block><block class="punctuation token">}</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">            </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        example </block><block class="operator token">=</block><block class=" token"> tf</block><block class="punctuation token">.</block><block class=" token">train</block><block class="punctuation token">.</block><block class=" token">Example</block><block class="punctuation token">(</block><block class=" token">features</block><block class="operator token">=</block><block class=" token">tf</block><block class="punctuation token">.</block><block class=" token">train</block><block class="punctuation token">.</block><block class=" token">Features</block><block class="punctuation token">(</block><block class=" token">feature</block><block class="operator token">=</block><block class=" token">my_features</block><block class="punctuation token">)</block><block class="punctuation token">)</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        writer</block><block class="punctuation token">.</block><block class=" token">write</block><block class="punctuation token">(</block><block class=" token">example</block><block class="punctuation token">.</block><block class=" token">SerializeToString</block><block class="punctuation token">(</block><block class="punctuation token">)</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    writer</block><block class="punctuation token">.</block><block class=" token">close</block><block class="punctuation token">(</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="keyword token">print</block><block class="punctuation token">(</block><block class="string-interpolation string token">f"Written to </block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">tfr_file_path</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="keyword token">return</block><block class=" token"> tfr_file_path</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">tfr_train_file_path </block><block class="operator token">=</block><block class=" token">  write_to_tfrecords</block><block class="punctuation token">(</block><block class=" token">DA</block><block class="punctuation token">.</block><block class=" token">paths</block><block class="punctuation token">.</block><block class=" token">working_dir</block><block class="punctuation token">,</block><block class=" token"> train_data_paths</block><block class="punctuation token">,</block><block class=" token"> prefix</block><block class="operator token">=</block><block class="string token">"train"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">tfr_test_file_path </block><block class="operator token">=</block><block class=" token"> write_to_tfrecords</block><block class="punctuation token">(</block><block class=" token">DA</block><block class="punctuation token">.</block><block class=" token">paths</block><block class="punctuation token">.</block><block class=" token">working_dir</block><block class="punctuation token">,</block><block class=" token"> test_data_paths</block><block class="punctuation token">,</block><block class=" token"> prefix</block><block class="operator token">=</block><block class="string token">"test"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Loading TFRecord</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">from</block><block class=" token"> dataclasses </block><block class="keyword token">import</block><block class=" token"> dataclass</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">@dataclass</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">class</block><block class=" token"> </block><block class="class-name token">DataIngest</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    img_height</block><block class="punctuation token">:</block><block class=" token"> </block><block class="builtin token">int</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    img_width</block><block class="punctuation token">:</block><block class=" token"> </block><block class="builtin token">int</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    img_channels</block><block class="punctuation token">:</block><block class=" token"> </block><block class="builtin token">int</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="keyword token">def</block><block class=" token"> </block><block class="function token">read_from_tfrecords</block><block class="punctuation token">(</block><block class=" token">self</block><block class="punctuation token">,</block><block class=" token"> serialized_example</block><block class="punctuation token">)</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block><block class="triple-quoted-string string token">"""Read TFRecords"""</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        image_feature_description </block><block class="operator token">=</block><block class=" token"> </block><block class="punctuation token">{</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">            </block><block class="string token">"img_raw"</block><block class="punctuation token">:</block><block class=" token"> tf</block><block class="punctuation token">.</block><block class=" token">io</block><block class="punctuation token">.</block><block class=" token">FixedLenFeature</block><block class="punctuation token">(</block><block class="punctuation token">[</block><block class="punctuation token">]</block><block class="punctuation token">,</block><block class=" token"> tf</block><block class="punctuation token">.</block><block class=" token">string</block><block class="punctuation token">)</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">            </block><block class="string token">"label"</block><block class="punctuation token">:</block><block class=" token"> tf</block><block class="punctuation token">.</block><block class=" token">io</block><block class="punctuation token">.</block><block class=" token">FixedLenFeature</block><block class="punctuation token">(</block><block class="punctuation token">[</block><block class="punctuation token">]</block><block class="punctuation token">,</block><block class=" token"> tf</block><block class="punctuation token">.</block><block class=" token">int64</block><block class="punctuation token">)</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">            </block><block class="string token">"height"</block><block class="punctuation token">:</block><block class=" token"> tf</block><block class="punctuation token">.</block><block class=" token">io</block><block class="punctuation token">.</block><block class=" token">FixedLenFeature</block><block class="punctuation token">(</block><block class="punctuation token">[</block><block class="punctuation token">]</block><block class="punctuation token">,</block><block class=" token"> tf</block><block class="punctuation token">.</block><block class=" token">int64</block><block class="punctuation token">)</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">            </block><block class="string token">"width"</block><block class="punctuation token">:</block><block class=" token"> tf</block><block class="punctuation token">.</block><block class=" token">io</block><block class="punctuation token">.</block><block class=" token">FixedLenFeature</block><block class="punctuation token">(</block><block class="punctuation token">[</block><block class="punctuation token">]</block><block class="punctuation token">,</block><block class=" token"> tf</block><block class="punctuation token">.</block><block class=" token">int64</block><block class="punctuation token">)</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">            </block><block class="string token">"depth"</block><block class="punctuation token">:</block><block class=" token"> tf</block><block class="punctuation token">.</block><block class=" token">io</block><block class="punctuation token">.</block><block class=" token">FixedLenFeature</block><block class="punctuation token">(</block><block class="punctuation token">[</block><block class="punctuation token">]</block><block class="punctuation token">,</block><block class=" token"> tf</block><block class="punctuation token">.</block><block class=" token">int64</block><block class="punctuation token">)</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block><block class="punctuation token">}</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block><block class="comment token"># Parse the input tf.train.Example proto using the dictionary above.</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        parsed </block><block class="operator token">=</block><block class=" token"> tf</block><block class="punctuation token">.</block><block class=" token">io</block><block class="punctuation token">.</block><block class=" token">parse_single_example</block><block class="punctuation token">(</block><block class=" token">serialized_example</block><block class="punctuation token">,</block><block class=" token"> image_feature_description</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block><block class="comment token"># parse the data to get the original image</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        img </block><block class="operator token">=</block><block class=" token"> tf</block><block class="punctuation token">.</block><block class=" token">image</block><block class="punctuation token">.</block><block class=" token">decode_jpeg</block><block class="punctuation token">(</block><block class=" token">parsed</block><block class="punctuation token">[</block><block class="string token">"img_raw"</block><block class="punctuation token">]</block><block class="punctuation token">,</block><block class=" token"> channels</block><block class="operator token">=</block><block class=" token">self</block><block class="punctuation token">.</block><block class=" token">img_channels</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        label </block><block class="operator token">=</block><block class=" token"> parsed</block><block class="punctuation token">[</block><block class="string token">"label"</block><block class="punctuation token">]</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block><block class="keyword token">return</block><block class=" token"> img</block><block class="punctuation token">,</block><block class=" token"> label   </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="keyword token">def</block><block class=" token"> </block><block class="function token">preprocess_image</block><block class="punctuation token">(</block><block class=" token">self</block><block class="punctuation token">,</block><block class=" token"> img</block><block class="punctuation token">)</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block><block class="triple-quoted-string string token">"""Resizes and pads image to target width and height"""</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block><block class="keyword token">return</block><block class=" token"> tf</block><block class="punctuation token">.</block><block class=" token">image</block><block class="punctuation token">.</block><block class=" token">resize_with_pad</block><block class="punctuation token">(</block><block class=" token">img</block><block class="punctuation token">,</block><block class=" token"> self</block><block class="punctuation token">.</block><block class=" token">img_height</block><block class="punctuation token">,</block><block class=" token"> self</block><block class="punctuation token">.</block><block class=" token">img_width</block><block class="punctuation token">)</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">AUTOTUNE </block><block class="operator token">=</block><block class=" token"> tf</block><block class="punctuation token">.</block><block class=" token">data</block><block class="punctuation token">.</block><block class=" token">AUTOTUNE </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">def</block><block class=" token"> </block><block class="function token">parse_tfrecords</block><block class="punctuation token">(</block><block class=" token">tfrecords_path</block><block class="punctuation token">:</block><block class=" token"> </block><block class="builtin token">str</block><block class="punctuation token">,</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                    img_height</block><block class="punctuation token">:</block><block class=" token"> </block><block class="builtin token">int</block><block class="punctuation token">,</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                    img_width</block><block class="punctuation token">:</block><block class=" token"> </block><block class="builtin token">int</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                    img_channels</block><block class="punctuation token">:</block><block class=" token"> </block><block class="builtin token">int</block><block class="punctuation token">,</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                    batch_size</block><block class="punctuation token">:</block><block class=" token"> </block><block class="builtin token">int</block><block class="punctuation token">)</block><block class=" token"> </block><block class="operator token">-</block><block class="operator token">&gt;</block><block class=" token"> tf</block><block class="punctuation token">.</block><block class=" token">data</block><block class="punctuation token">.</block><block class=" token">Dataset</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    data_ingest </block><block class="operator token">=</block><block class=" token"> DataIngest</block><block class="punctuation token">(</block><block class=" token">img_height</block><block class="punctuation token">,</block><block class=" token"> img_width</block><block class="punctuation token">,</block><block class=" token"> img_channels</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    ds </block><block class="operator token">=</block><block class=" token"> tf</block><block class="punctuation token">.</block><block class=" token">data</block><block class="punctuation token">.</block><block class=" token">TFRecordDataset</block><block class="punctuation token">(</block><block class=" token">tfrecords_path</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="keyword token">def</block><block class=" token"> </block><block class="function token">_preprocess_img_label</block><block class="punctuation token">(</block><block class=" token">img</block><block class="punctuation token">,</block><block class=" token"> label</block><block class="punctuation token">)</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block><block class="keyword token">return</block><block class=" token"> data_ingest</block><block class="punctuation token">.</block><block class=" token">preprocess_image</block><block class="punctuation token">(</block><block class=" token">img</block><block class="punctuation token">)</block><block class="punctuation token">,</block><block class=" token"> label</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    parsed_image_dataset </block><block class="operator token">=</block><block class=" token"> </block><block class="punctuation token">(</block><block class=" token">ds</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                            </block><block class="punctuation token">.</block><block class="builtin token">map</block><block class="punctuation token">(</block><block class=" token">data_ingest</block><block class="punctuation token">.</block><block class=" token">read_from_tfrecords</block><block class="punctuation token">,</block><block class=" token"> num_parallel_calls</block><block class="operator token">=</block><block class=" token">AUTOTUNE</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                            </block><block class="punctuation token">.</block><block class="builtin token">map</block><block class="punctuation token">(</block><block class=" token">_preprocess_img_label</block><block class="punctuation token">,</block><block class=" token"> num_parallel_calls</block><block class="operator token">=</block><block class=" token">AUTOTUNE</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                            </block><block class="punctuation token">.</block><block class=" token">cache</block><block class="punctuation token">(</block><block class="punctuation token">)</block><block class=" token"> </block><block class="comment token">## NOT RECOMMENDED for large datasets</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                            </block><block class="punctuation token">.</block><block class=" token">shuffle</block><block class="punctuation token">(</block><block class="number token">32</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                            </block><block class="punctuation token">.</block><block class=" token">prefetch</block><block class="punctuation token">(</block><block class=" token">AUTOTUNE</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                            </block><block class="punctuation token">.</block><block class=" token">batch</block><block class="punctuation token">(</block><block class=" token">batch_size</block><block class="punctuation token">)</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="keyword token">return</block><block class=" token"> parsed_image_dataset</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Traing the model</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">from</block><block class=" token"> tensorflow</block><block class="punctuation token">.</block><block class=" token">keras </block><block class="keyword token">import</block><block class=" token"> layers</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">from</block><block class=" token"> tensorflow</block><block class="punctuation token">.</block><block class=" token">keras</block><block class="punctuation token">.</block><block class=" token">optimizers </block><block class="keyword token">import</block><block class=" token"> Adam</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">tf</block><block class="punctuation token">.</block><block class=" token">random</block><block class="punctuation token">.</block><block class=" token">set_seed</block><block class="punctuation token">(</block><block class="number token">42</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">def</block><block class=" token"> </block><block class="function token">build_compile_model</block><block class="punctuation token">(</block><block class=" token">cfg</block><block class="punctuation token">:</block><block class=" token"> TrainConfig</block><block class="punctuation token">)</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    model </block><block class="operator token">=</block><block class=" token"> tf</block><block class="punctuation token">.</block><block class=" token">keras</block><block class="punctuation token">.</block><block class=" token">models</block><block class="punctuation token">.</block><block class=" token">Sequential</block><block class="punctuation token">(</block><block class="punctuation token">[</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        layers</block><block class="punctuation token">.</block><block class=" token">Conv2D</block><block class="punctuation token">(</block><block class="number token">32</block><block class="punctuation token">,</block><block class=" token"> kernel_size</block><block class="operator token">=</block><block class="punctuation token">(</block><block class="number token">3</block><block class="punctuation token">,</block><block class=" token"> </block><block class="number token">3</block><block class="punctuation token">)</block><block class="punctuation token">,</block><block class=" token"> activation</block><block class="operator token">=</block><block class="string token">"relu"</block><block class="punctuation token">,</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                      input_shape</block><block class="operator token">=</block><block class="punctuation token">[</block><block class=" token">cfg</block><block class="punctuation token">.</block><block class=" token">img_height</block><block class="punctuation token">,</block><block class=" token"> cfg</block><block class="punctuation token">.</block><block class=" token">img_width</block><block class="punctuation token">,</block><block class=" token"> cfg</block><block class="punctuation token">.</block><block class=" token">img_channels</block><block class="punctuation token">]</block><block class="punctuation token">)</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        layers</block><block class="punctuation token">.</block><block class=" token">MaxPooling2D</block><block class="punctuation token">(</block><block class=" token">pool_size</block><block class="operator token">=</block><block class="punctuation token">(</block><block class="number token">2</block><block class="punctuation token">,</block><block class=" token"> </block><block class="number token">2</block><block class="punctuation token">)</block><block class="punctuation token">)</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        layers</block><block class="punctuation token">.</block><block class=" token">Flatten</block><block class="punctuation token">(</block><block class="punctuation token">)</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        layers</block><block class="punctuation token">.</block><block class=" token">Dense</block><block class="punctuation token">(</block><block class="number token">128</block><block class="punctuation token">,</block><block class=" token"> activation</block><block class="operator token">=</block><block class="string token">"relu"</block><block class="punctuation token">)</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        layers</block><block class="punctuation token">.</block><block class=" token">Dense</block><block class="punctuation token">(</block><block class="number token">1</block><block class="punctuation token">,</block><block class=" token"> activation</block><block class="operator token">=</block><block class="string token">"sigmoid"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="punctuation token">]</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    model</block><block class="punctuation token">.</block><block class="builtin token">compile</block><block class="punctuation token">(</block><block class=" token">loss</block><block class="operator token">=</block><block class="string token">"binary_crossentropy"</block><block class="punctuation token">,</block><block class=" token"> optimizer</block><block class="operator token">=</block><block class=" token">Adam</block><block class="punctuation token">(</block><block class=" token">learning_rate</block><block class="operator token">=</block><block class=" token">cfg</block><block class="punctuation token">.</block><block class=" token">learning_rate</block><block class="punctuation token">)</block><block class="punctuation token">,</block><block class=" token"> metrics</block><block class="operator token">=</block><block class="punctuation token">[</block><block class="string token">"accuracy"</block><block class="punctuation token">]</block><block class="punctuation token">)</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="keyword token">return</block><block class=" token"> model </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">train_cfg </block><block class="operator token">=</block><block class=" token"> TrainConfig</block><block class="punctuation token">(</block><block class=" token">img_height</block><block class="operator token">=</block><block class="number token">224</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                        img_width</block><block class="operator token">=</block><block class="number token">224</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                        img_channels</block><block class="operator token">=</block><block class="number token">3</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                        batch_size</block><block class="operator token">=</block><block class="number token">8</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                        epochs</block><block class="operator token">=</block><block class="number token">4</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                        learning_rate</block><block class="operator token">=</block><block class="number token">0.0125</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                       </block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">import</block><block class=" token"> mlflow</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">train_ds </block><block class="operator token">=</block><block class=" token"> parse_tfrecords</block><block class="punctuation token">(</block><block class=" token">tfr_train_file_path</block><block class="punctuation token">,</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                           train_cfg</block><block class="punctuation token">.</block><block class=" token">img_height</block><block class="punctuation token">,</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                           train_cfg</block><block class="punctuation token">.</block><block class=" token">img_width</block><block class="punctuation token">,</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                           train_cfg</block><block class="punctuation token">.</block><block class=" token">img_channels</block><block class="punctuation token">,</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                           train_cfg</block><block class="punctuation token">.</block><block class=" token">batch_size</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">model </block><block class="operator token">=</block><block class=" token"> build_compile_model</block><block class="punctuation token">(</block><block class=" token">train_cfg</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">history </block><block class="operator token">=</block><block class=" token"> model</block><block class="punctuation token">.</block><block class=" token">fit</block><block class="punctuation token">(</block><block class=" token">train_ds</block><block class="punctuation token">,</block><block class=" token"> epochs</block><block class="operator token">=</block><block class=" token">train_cfg</block><block class="punctuation token">.</block><block class=" token">epochs</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Transfer learning with VGG-16</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">from</block><block class=" token"> tensorflow</block><block class="punctuation token">.</block><block class=" token">keras </block><block class="keyword token">import</block><block class=" token"> applications</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">from</block><block class=" token"> tensorflow</block><block class="punctuation token">.</block><block class=" token">keras</block><block class="punctuation token">.</block><block class=" token">models </block><block class="keyword token">import</block><block class=" token"> Model </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">def</block><block class=" token"> </block><block class="function token">build_compile_vgg16_model</block><block class="punctuation token">(</block><block class=" token">cfg</block><block class="punctuation token">:</block><block class=" token"> TrainConfig</block><block class="punctuation token">)</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="comment token"># Load original model with pretrained weights from imagenet</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="comment token"># We do not want to use the ImageNet classifier at the top since it has many irrelevant categories</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    base_model </block><block class="operator token">=</block><block class=" token"> applications</block><block class="punctuation token">.</block><block class=" token">VGG16</block><block class="punctuation token">(</block><block class=" token">weights</block><block class="operator token">=</block><block class="string token">"imagenet"</block><block class="punctuation token">,</block><block class=" token"> include_top</block><block class="operator token">=</block><block class="boolean token">False</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="comment token"># Freeze base model</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    base_model</block><block class="punctuation token">.</block><block class=" token">trainable </block><block class="operator token">=</block><block class=" token"> </block><block class="boolean token">False</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="comment token"># Create new model on top</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    inputs </block><block class="operator token">=</block><block class=" token"> layers</block><block class="punctuation token">.</block><block class=" token">Input</block><block class="punctuation token">(</block><block class=" token">shape</block><block class="operator token">=</block><block class="punctuation token">(</block><block class=" token">cfg</block><block class="punctuation token">.</block><block class=" token">img_height</block><block class="punctuation token">,</block><block class=" token"> cfg</block><block class="punctuation token">.</block><block class=" token">img_width</block><block class="punctuation token">,</block><block class=" token"> </block><block class="number token">3</block><block class="punctuation token">)</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    x </block><block class="operator token">=</block><block class=" token"> base_model</block><block class="punctuation token">(</block><block class=" token">inputs</block><block class="punctuation token">,</block><block class=" token"> training</block><block class="operator token">=</block><block class="boolean token">False</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    x </block><block class="operator token">=</block><block class=" token"> layers</block><block class="punctuation token">.</block><block class=" token">GlobalAveragePooling2D</block><block class="punctuation token">(</block><block class="punctuation token">)</block><block class="punctuation token">(</block><block class=" token">x</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    outputs </block><block class="operator token">=</block><block class=" token"> layers</block><block class="punctuation token">.</block><block class=" token">Dense</block><block class="punctuation token">(</block><block class="number token">1</block><block class="punctuation token">,</block><block class=" token"> activation</block><block class="operator token">=</block><block class="string token">"sigmoid"</block><block class="punctuation token">)</block><block class="punctuation token">(</block><block class=" token">x</block><block class="punctuation token">)</block><block class=" token"> </block><block class="comment token"># we want to output probabilities for both classes</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    model </block><block class="operator token">=</block><block class=" token"> Model</block><block class="punctuation token">(</block><block class=" token">inputs</block><block class="punctuation token">,</block><block class=" token"> outputs</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    model</block><block class="punctuation token">.</block><block class="builtin token">compile</block><block class="punctuation token">(</block><block class=" token">loss</block><block class="operator token">=</block><block class="string token">"binary_crossentropy"</block><block class="punctuation token">,</block><block class=" token"> optimizer</block><block class="operator token">=</block><block class=" token">Adam</block><block class="punctuation token">(</block><block class=" token">learning_rate</block><block class="operator token">=</block><block class=" token">cfg</block><block class="punctuation token">.</block><block class=" token">learning_rate</block><block class="punctuation token">)</block><block class="punctuation token">,</block><block class=" token"> metrics</block><block class="operator token">=</block><block class="punctuation token">[</block><block class="string token">"accuracy"</block><block class="punctuation token">]</block><block class="punctuation token">)</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="keyword token">return</block><block class=" token"> model </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">vgg16_model </block><block class="operator token">=</block><block class=" token"> build_compile_vgg16_model</block><block class="punctuation token">(</block><block class=" token">train_cfg</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">vgg16_history </block><block class="operator token">=</block><block class=" token"> vgg16_model</block><block class="punctuation token">.</block><block class=" token">fit</block><block class="punctuation token">(</block><block class=" token">train_ds</block><block class="punctuation token">,</block><block class=" token"> epochs</block><block class="operator token">=</block><block class=" token">train_cfg</block><block class="punctuation token">.</block><block class=" token">epochs</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Evaluation</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">test_ds </block><block class="operator token">=</block><block class=" token"> parse_tfrecords</block><block class="punctuation token">(</block><block class=" token">tfr_test_file_path</block><block class="punctuation token">,</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                          train_cfg</block><block class="punctuation token">.</block><block class=" token">img_height</block><block class="punctuation token">,</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                          train_cfg</block><block class="punctuation token">.</block><block class=" token">img_width</block><block class="punctuation token">,</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                          train_cfg</block><block class="punctuation token">.</block><block class=" token">img_channels</block><block class="punctuation token">,</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                          train_cfg</block><block class="punctuation token">.</block><block class=" token">batch_size</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">eval_results </block><block class="operator token">=</block><block class=" token"> model</block><block class="punctuation token">.</block><block class=" token">evaluate</block><block class="punctuation token">(</block><block class=" token">test_ds</block><block class="punctuation token">,</block><block class=" token"> steps</block><block class="operator token">=</block><block class="number token">2</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># 2/2 [==============================] - 1s 62ms/step - loss: 0.6463 - accuracy: 0.5833</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">eval_results_vgg16 </block><block class="operator token">=</block><block class=" token"> vgg16_model</block><block class="punctuation token">.</block><block class=" token">evaluate</block><block class="punctuation token">(</block><block class=" token">test_ds</block><block class="punctuation token">,</block><block class=" token"> steps</block><block class="operator token">=</block><block class="number token">2</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># 2/2 [==============================] - 4s 1s/step - loss: 0.3801 - accuracy: 0.9167</block></blocks></line></editarea></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">[</block><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><compositeblock dir="ltr" class="anchor-tag-ref inline" style="font-family: &quot;Computer Modern Serif&quot;, serif; background-color: rgba(155, 155, 155, 0.2);"><a href="#n0.3715415633810799" style="color: inherit; text-decoration: inherit;">Back To Top</a></compositeblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">]</block></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="inline" style="display: block;"><div style="vertical-align: baseline;"><div style="display: inline-block; height: 0px; border-bottom: 1px solid; width: 100%;"></div></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode section sindent-0" data-line-id="n0.8578052793516238" style="font-size: 1.2em; padding-top: 0.5em; padding-bottom: 0.5em; font-weight: bold; line-height: 1.4;" id="n0.8578052793516238" role="heading" aria-level="1"><prefix style="text-align: left; padding-right: 0.5em;">8. </prefix><blocks><baselineblock class="inline"></baselineblock><block>Distributed Training with TFRecord</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>In this section, we explore how to conduct distributed training with </block><block style="font-weight: bold;">TFRecord</block><block> using </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">spark-tensorflow-distributor</block><block>.</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>As we saw earlier, </block><block style="font-weight: bold;">Horovod</block><block> is a candidate for distributed training and works well with </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">tf.keras</block><block>, PyTorch. </block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Here, we introduce </block><block style="text-decoration: underline;">another framework</block><block> specific to </block><block style="text-decoration: none; font-style: italic;">TFRecord</block><block>. </block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>This library provides a </block><block style="text-decoration: underline;">Spark wrapper</block><block> around </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">tf.keras</block><block>'s existing distributed training strategy. </block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://github.com/tensorflow/ecosystem/tree/master/spark/spark-tensorflow-distributor" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://github.com/tensorflow/ecosystem/tree/master/spark/spark-tensorflow-distributor" target="_blank" style="color: inherit; text-decoration: inherit;">Spark TensorFlow Distributor</a></block><block> makes use of the </block><block style="font-weight: bold; background-color: rgb(255, 254, 0);">barrier execution mode</block><block>, allowing workers to share data between each other during execution.</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://docs.databricks.com/_static/notebooks/deep-learning/spark-tensorflow-distributor.html" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://docs.databricks.com/_static/notebooks/deep-learning/spark-tensorflow-distributor.html" target="_blank" style="color: inherit; text-decoration: inherit;">A notebook example</a></block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://www.tensorflow.org/guide/distributed_training?hl=en" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://www.tensorflow.org/guide/distributed_training?hl=en" target="_blank" style="color: inherit; text-decoration: inherit;">TensorFlow's distributed training documentation</a></block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61); background-color: rgb(255, 254, 0);">spark-tensorflow-distributor</block><block style="background-color: rgb(255, 254, 0);"> requires all training code to be wrapped within a single function</block><block>. </block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold; background-color: rgb(255, 254, 0);">Note:</block><block> Notice the </block><block style="text-decoration: underline;">code is highly similar to the single-node implementation</block><block>, with the exception of the </block><block style="font-weight: bold; color: rgb(78, 166, 78);">data sharding option</block><block>.</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">tf.data.experimental.AutoShardPolicy</block><block> dictates how the inputs will be sharded. </block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>When it's set to </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">DATA</block><block>, the data will be sharded (or shared) by each worker or process. Based on the </block><block class="role-hyper-link" data-hyper-link-url="https://www.tensorflow.org/api_docs/python/tf/data/experimental/AutoShardPolicy" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://www.tensorflow.org/api_docs/python/tf/data/experimental/AutoShardPolicy" target="_blank" style="color: inherit; text-decoration: inherit;">documentation</a></block><block>  </block><block style="font-style: italic;">"each worker will process the whole dataset and discard the portion that is not for itself."</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="background-color: rgb(255, 254, 0);">It is recommended</block><block> to </block><block style="text-decoration: underline;">make the imports inside the function</block><block> so that the training function can be </block><block style="text-decoration: underline;">serialized</block><block>.</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">[</block><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><compositeblock dir="ltr" class="anchor-tag-ref inline" style="font-family: &quot;Computer Modern Serif&quot;, serif; background-color: rgba(155, 155, 155, 0.2);"><a href="#n0.3715415633810799" style="color: inherit; text-decoration: inherit;">Back To Top</a></compositeblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">]</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode section sindent-1" data-line-id="n0.17358431836964883" style="font-size: 1.1em; padding-top: 0.5em; padding-bottom: 0.5em; font-weight: bold; line-height: 1.4;" id="n0.17358431836964883" role="heading" aria-level="2"><prefix style="text-align: left; padding-right: 0.25em;">8.1. </prefix><blocks><baselineblock class="inline"></baselineblock><block>Train on Driver Node</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="background-color: rgb(255, 254, 0);">Under the hood, </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61); background-color: rgb(255, 254, 0);">tf.keras</block><block style="background-color: rgb(255, 254, 0);"> is distribution-aware</block><block>, so you can easily use </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">tf.distribute.Stategy</block><block> to enable distributed training. </block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61); background-color: rgb(255, 254, 0);">MirroredStrategyRunner</block><block style="background-color: rgb(255, 254, 0);"> provides a Spark wrapper around </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61); background-color: rgb(255, 254, 0);">tf.distribute.MirroredStrategy</block><block>.</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="color: rgb(255, 64, 0); font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold; color: rgb(255, 64, 0);">Why is it called "mirrored"?</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>This strategy supports synchronous distributed training on multiple CPUs/GPUs on one machine.</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>A model replica is created per GPU device; hence, the model variables are also mirrored across all replica.</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>The model variables are in sync since model updates apply to all of them.</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="color: rgb(255, 64, 0); font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold; color: rgb(255, 64, 0);">Best practices</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Since </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">.fit()</block><block> automatically splits each training batch across all replicas, </block><block style="font-weight: bold;">it's best that the batch size is divisible by the number of replicas (# of CPUs/GPUs)</block><block>. </block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="text-decoration: underline;">This is to ensure that each replica gets batches of the same size</block><block>.</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Refer to </block><block class="role-hyper-link" data-hyper-link-url="https://www.tensorflow.org/guide/distributed_training?hl=en#mirroredstrategy" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://www.tensorflow.org/guide/distributed_training?hl=en#mirroredstrategy" target="_blank" style="color: inherit; text-decoration: inherit;">documentation here</a></block><block>.</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">[</block><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><compositeblock dir="ltr" class="anchor-tag-ref inline" style="font-family: &quot;Computer Modern Serif&quot;, serif; background-color: rgba(155, 155, 155, 0.2);"><a href="#n0.3715415633810799" style="color: inherit; text-decoration: inherit;">Back To Top</a></compositeblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">]</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode section sindent-1" data-line-id="n0.5045894702301612" style="font-size: 1.1em; padding-top: 0.5em; padding-bottom: 0.5em; font-weight: bold; line-height: 1.4;" id="n0.5045894702301612" role="heading" aria-level="2"><prefix style="text-align: left; padding-right: 0.25em;">8.2. </prefix><blocks><baselineblock class="inline"></baselineblock><block>Train on Workers</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="text-decoration: underline;">Now that we are certain that the code works, we can leverage all the slots available</block><block>. </block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="background-color: rgb(255, 254, 0);">On GPU clusters, the number of slots is equal to the number of available GPUs</block><block>. </block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="background-color: rgb(255, 254, 0);">On CPU clusters, pick a number that's reasonable</block><block>. </block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>You also need to </block><block style="background-color: rgb(255, 254, 0);">toggle </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61); background-color: rgb(255, 254, 0);">local_mode</block><block style="background-color: rgb(255, 254, 0);"> to </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61); background-color: rgb(255, 254, 0);">False</block><block> to set the training to happen on workers.</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>If you want to use a custom strategy for distributed training, you can create your own </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">tf.distribute.Strategy</block><block> and turn </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">use_custom_strategy</block><block> to </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">True</block><block>. Refer to:</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>spark-tensorflow-distributor </block><block class="role-hyper-link" data-hyper-link-url="https://docs.databricks.com/_static/notebooks/deep-learning/spark-tensorflow-distributor.html" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://docs.databricks.com/_static/notebooks/deep-learning/spark-tensorflow-distributor.html" target="_blank" style="color: inherit; text-decoration: inherit;">notebook by Databricks</a></block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Tensorflow documentation </block><block class="role-hyper-link" data-hyper-link-url="https://www.tensorflow.org/tutorials/distribute/custom_training" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://www.tensorflow.org/tutorials/distribute/custom_training" target="_blank" style="color: inherit; text-decoration: inherit;">here</a></block><block> and </block><block class="role-hyper-link" data-hyper-link-url="https://www.tensorflow.org/api_docs/python/tf/distribute/Strategy#in_short_2" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://www.tensorflow.org/api_docs/python/tf/distribute/Strategy#in_short_2" target="_blank" style="color: inherit; text-decoration: inherit;">here</a></block><block>.</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Since we are not using a cluster with workers, if we use </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">use_custom_strategy=False</block><block>, </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">MirroredStrategyRunner</block><block> will construct a </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">MultiWorkerMirroredStrategy</block><block> for the user automatically, which will result in failure. </block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Hence, we override the custom strategy below to use the non-worker strategy. </block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Refer to the </block><block class="role-hyper-link" data-hyper-link-url="https://github.com/tensorflow/ecosystem/blob/fd74f96d3e3cdf40d8b2714b2ce36749920fe093/spark/spark-tensorflow-distributor/spark_tensorflow_distributor/mirrored_strategy_runner.py#L273" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://github.com/tensorflow/ecosystem/blob/fd74f96d3e3cdf40d8b2714b2ce36749920fe093/spark/spark-tensorflow-distributor/spark_tensorflow_distributor/mirrored_strategy_runner.py#L273" target="_blank" style="color: inherit; text-decoration: inherit;">source code</a></block><block> here if you are interested in the implementation detail.</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item full-line-block-inside" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="code-section-symbol inline" style="display: block;"><div class="code-section theme-tomorrow-night" style="display: block; border: 1px solid lightgray; background: rgb(45, 45, 45); padding: 10px; font-size: 10px;"><editarea class="text-mode code-section-edit-area" style="font-family: &quot;Fira code&quot;, &quot;Fira Mono&quot;, monospace;"><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">from</block><block class=" token"> dataclasses </block><block class="keyword token">import</block><block class=" token"> dataclass</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">@dataclass</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">class</block><block class=" token"> </block><block class="class-name token">DataIngest</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    img_height</block><block class="punctuation token">:</block><block class=" token"> </block><block class="builtin token">int</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    img_width</block><block class="punctuation token">:</block><block class=" token"> </block><block class="builtin token">int</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    img_channels</block><block class="punctuation token">:</block><block class=" token"> </block><block class="builtin token">int</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="keyword token">def</block><block class=" token"> </block><block class="function token">read_from_tfrecords</block><block class="punctuation token">(</block><block class=" token">self</block><block class="punctuation token">,</block><block class=" token"> serialized_example</block><block class="punctuation token">)</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block><block class="triple-quoted-string string token">"""Read TFRecords"""</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        image_feature_description </block><block class="operator token">=</block><block class=" token"> </block><block class="punctuation token">{</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">            </block><block class="string token">"img_raw"</block><block class="punctuation token">:</block><block class=" token"> tf</block><block class="punctuation token">.</block><block class=" token">io</block><block class="punctuation token">.</block><block class=" token">FixedLenFeature</block><block class="punctuation token">(</block><block class="punctuation token">[</block><block class="punctuation token">]</block><block class="punctuation token">,</block><block class=" token"> tf</block><block class="punctuation token">.</block><block class=" token">string</block><block class="punctuation token">)</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">            </block><block class="string token">"label"</block><block class="punctuation token">:</block><block class=" token"> tf</block><block class="punctuation token">.</block><block class=" token">io</block><block class="punctuation token">.</block><block class=" token">FixedLenFeature</block><block class="punctuation token">(</block><block class="punctuation token">[</block><block class="punctuation token">]</block><block class="punctuation token">,</block><block class=" token"> tf</block><block class="punctuation token">.</block><block class=" token">int64</block><block class="punctuation token">)</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">            </block><block class="string token">"height"</block><block class="punctuation token">:</block><block class=" token"> tf</block><block class="punctuation token">.</block><block class=" token">io</block><block class="punctuation token">.</block><block class=" token">FixedLenFeature</block><block class="punctuation token">(</block><block class="punctuation token">[</block><block class="punctuation token">]</block><block class="punctuation token">,</block><block class=" token"> tf</block><block class="punctuation token">.</block><block class=" token">int64</block><block class="punctuation token">)</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">            </block><block class="string token">"width"</block><block class="punctuation token">:</block><block class=" token"> tf</block><block class="punctuation token">.</block><block class=" token">io</block><block class="punctuation token">.</block><block class=" token">FixedLenFeature</block><block class="punctuation token">(</block><block class="punctuation token">[</block><block class="punctuation token">]</block><block class="punctuation token">,</block><block class=" token"> tf</block><block class="punctuation token">.</block><block class=" token">int64</block><block class="punctuation token">)</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">            </block><block class="string token">"depth"</block><block class="punctuation token">:</block><block class=" token"> tf</block><block class="punctuation token">.</block><block class=" token">io</block><block class="punctuation token">.</block><block class=" token">FixedLenFeature</block><block class="punctuation token">(</block><block class="punctuation token">[</block><block class="punctuation token">]</block><block class="punctuation token">,</block><block class=" token"> tf</block><block class="punctuation token">.</block><block class=" token">int64</block><block class="punctuation token">)</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block><block class="punctuation token">}</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block><block class="comment token"># Parse the input tf.train.Example proto using the dictionary above.</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        parsed </block><block class="operator token">=</block><block class=" token"> tf</block><block class="punctuation token">.</block><block class=" token">io</block><block class="punctuation token">.</block><block class=" token">parse_single_example</block><block class="punctuation token">(</block><block class=" token">serialized_example</block><block class="punctuation token">,</block><block class=" token"> image_feature_description</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        img </block><block class="operator token">=</block><block class=" token"> tf</block><block class="punctuation token">.</block><block class=" token">image</block><block class="punctuation token">.</block><block class=" token">decode_jpeg</block><block class="punctuation token">(</block><block class=" token">parsed</block><block class="punctuation token">[</block><block class="string token">"img_raw"</block><block class="punctuation token">]</block><block class="punctuation token">,</block><block class=" token"> channels</block><block class="operator token">=</block><block class=" token">self</block><block class="punctuation token">.</block><block class=" token">img_channels</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        label </block><block class="operator token">=</block><block class=" token"> parsed</block><block class="punctuation token">[</block><block class="string token">"label"</block><block class="punctuation token">]</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block><block class="keyword token">return</block><block class=" token"> img</block><block class="punctuation token">,</block><block class=" token"> label   </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="keyword token">def</block><block class=" token"> </block><block class="function token">preprocess_image</block><block class="punctuation token">(</block><block class=" token">self</block><block class="punctuation token">,</block><block class=" token"> img</block><block class="punctuation token">)</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block><block class="triple-quoted-string string token">"""Resizes and pads image to target width and height"""</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block><block class="keyword token">return</block><block class=" token"> tf</block><block class="punctuation token">.</block><block class=" token">image</block><block class="punctuation token">.</block><block class=" token">resize_with_pad</block><block class="punctuation token">(</block><block class=" token">img</block><block class="punctuation token">,</block><block class=" token"> self</block><block class="punctuation token">.</block><block class=" token">img_height</block><block class="punctuation token">,</block><block class=" token"> self</block><block class="punctuation token">.</block><block class=" token">img_width</block><block class="punctuation token">)</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">import</block><block class=" token"> tensorflow </block><block class="keyword token">as</block><block class=" token"> tf</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">AUTOTUNE </block><block class="operator token">=</block><block class=" token"> tf</block><block class="punctuation token">.</block><block class=" token">data</block><block class="punctuation token">.</block><block class=" token">AUTOTUNE </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">def</block><block class=" token"> </block><block class="function token">parse_tfrecords</block><block class="punctuation token">(</block><block class=" token">tfrecords_path</block><block class="punctuation token">:</block><block class=" token"> </block><block class="builtin token">str</block><block class="punctuation token">,</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                    img_height</block><block class="punctuation token">:</block><block class=" token"> </block><block class="builtin token">int</block><block class="punctuation token">,</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                    img_width</block><block class="punctuation token">:</block><block class=" token"> </block><block class="builtin token">int</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                    img_channels</block><block class="punctuation token">:</block><block class=" token"> </block><block class="builtin token">int</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                    batch_size</block><block class="punctuation token">:</block><block class=" token"> </block><block class="builtin token">int</block><block class="punctuation token">)</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">  </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    data_ingest </block><block class="operator token">=</block><block class=" token"> DataIngest</block><block class="punctuation token">(</block><block class=" token">img_height</block><block class="punctuation token">,</block><block class=" token"> img_width</block><block class="punctuation token">,</block><block class=" token"> img_channels</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    ds </block><block class="operator token">=</block><block class=" token"> tf</block><block class="punctuation token">.</block><block class=" token">data</block><block class="punctuation token">.</block><block class=" token">TFRecordDataset</block><block class="punctuation token">(</block><block class=" token">tfrecords_path</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="keyword token">def</block><block class=" token"> </block><block class="function token">_preprocess_img_label</block><block class="punctuation token">(</block><block class=" token">img</block><block class="punctuation token">,</block><block class=" token"> label</block><block class="punctuation token">)</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block><block class="keyword token">return</block><block class=" token"> data_ingest</block><block class="punctuation token">.</block><block class=" token">preprocess_image</block><block class="punctuation token">(</block><block class=" token">img</block><block class="punctuation token">)</block><block class="punctuation token">,</block><block class=" token"> label</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    parsed_image_dataset </block><block class="operator token">=</block><block class=" token"> </block><block class="punctuation token">(</block><block class=" token">ds</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                            </block><block class="punctuation token">.</block><block class="builtin token">map</block><block class="punctuation token">(</block><block class=" token">data_ingest</block><block class="punctuation token">.</block><block class=" token">read_from_tfrecords</block><block class="punctuation token">,</block><block class=" token"> num_parallel_calls</block><block class="operator token">=</block><block class=" token">AUTOTUNE</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                            </block><block class="punctuation token">.</block><block class="builtin token">map</block><block class="punctuation token">(</block><block class=" token">_preprocess_img_label</block><block class="punctuation token">,</block><block class=" token"> num_parallel_calls</block><block class="operator token">=</block><block class=" token">AUTOTUNE</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                            </block><block class="punctuation token">.</block><block class=" token">cache</block><block class="punctuation token">(</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                            </block><block class="punctuation token">.</block><block class=" token">shuffle</block><block class="punctuation token">(</block><block class="number token">32</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                            </block><block class="punctuation token">.</block><block class=" token">prefetch</block><block class="punctuation token">(</block><block class=" token">AUTOTUNE</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                            </block><block class="punctuation token">.</block><block class=" token">batch</block><block class="punctuation token">(</block><block class=" token">batch_size</block><block class="punctuation token">)</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="keyword token">return</block><block class=" token"> parsed_image_dataset</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">@dataclass</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">class</block><block class=" token"> </block><block class="class-name token">TrainConfig</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    img_height</block><block class="punctuation token">:</block><block class=" token"> </block><block class="builtin token">int</block><block class=" token"> </block><block class="operator token">=</block><block class=" token"> </block><block class="number token">224</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    img_width</block><block class="punctuation token">:</block><block class=" token"> </block><block class="builtin token">int</block><block class=" token"> </block><block class="operator token">=</block><block class=" token"> </block><block class="number token">224</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    img_channels</block><block class="punctuation token">:</block><block class=" token"> </block><block class="builtin token">int</block><block class=" token"> </block><block class="operator token">=</block><block class=" token"> </block><block class="number token">3</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    batch_size</block><block class="punctuation token">:</block><block class=" token"> </block><block class="builtin token">int</block><block class=" token"> </block><block class="operator token">=</block><block class=" token"> </block><block class="number token">64</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    epochs</block><block class="punctuation token">:</block><block class=" token"> </block><block class="builtin token">int</block><block class=" token"> </block><block class="operator token">=</block><block class=" token"> </block><block class="number token">10</block><block class=" token">    </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    learning_rate</block><block class="punctuation token">:</block><block class=" token"> </block><block class="builtin token">float</block><block class=" token"> </block><block class="operator token">=</block><block class=" token"> </block><block class="number token">0.0125</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    verbose</block><block class="punctuation token">:</block><block class=" token"> </block><block class="builtin token">int</block><block class=" token"> </block><block class="operator token">=</block><block class=" token"> </block><block class="number token">1</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Set up training configurations</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">train_cfg </block><block class="operator token">=</block><block class=" token"> TrainConfig</block><block class="punctuation token">(</block><block class=" token">img_height</block><block class="operator token">=</block><block class="number token">224</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                        img_width</block><block class="operator token">=</block><block class="number token">224</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                        img_channels</block><block class="operator token">=</block><block class="number token">3</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                        batch_size</block><block class="operator token">=</block><block class="number token">8</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                        epochs</block><block class="operator token">=</block><block class="number token">4</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                        learning_rate</block><block class="operator token">=</block><block class="number token">0.0125</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                       </block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Create TFRecord dataset</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">from</block><block class=" token"> pathlib </block><block class="keyword token">import</block><block class=" token"> Path</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">import</block><block class=" token"> os</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">import</block><block class=" token"> tensorflow </block><block class="keyword token">as</block><block class=" token"> tf</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">import</block><block class=" token"> glob</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">cats_dir </block><block class="operator token">=</block><block class=" token"> </block><block class="string-interpolation string token">f"</block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">DA</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">paths</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">datasets</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">replace</block><block class="string-interpolation interpolation punctuation token">(</block><block class="string-interpolation interpolation string token">'dbfs:/'</block><block class="string-interpolation interpolation punctuation token">,</block><block class="string-interpolation interpolation token"> </block><block class="string-interpolation interpolation string token">'/dbfs/'</block><block class="string-interpolation interpolation punctuation token">)</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">/img/cats/cats*.jpg"</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">dogs_dir </block><block class="operator token">=</block><block class=" token"> </block><block class="string-interpolation string token">f"</block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">DA</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">paths</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">datasets</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">replace</block><block class="string-interpolation interpolation punctuation token">(</block><block class="string-interpolation interpolation string token">'dbfs:/'</block><block class="string-interpolation interpolation punctuation token">,</block><block class="string-interpolation interpolation token"> </block><block class="string-interpolation interpolation string token">'/dbfs/'</block><block class="string-interpolation interpolation punctuation token">)</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">/img/dogs/dog*.jpg"</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">train_cat_list </block><block class="operator token">=</block><block class=" token"> </block><block class="builtin token">list</block><block class="punctuation token">(</block><block class=" token">glob</block><block class="punctuation token">.</block><block class=" token">glob</block><block class="punctuation token">(</block><block class=" token">cats_dir</block><block class="punctuation token">)</block><block class="punctuation token">[</block><block class="punctuation token">:</block><block class="number token">32</block><block class="punctuation token">]</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">train_dog_list </block><block class="operator token">=</block><block class=" token"> </block><block class="builtin token">list</block><block class="punctuation token">(</block><block class=" token">glob</block><block class="punctuation token">.</block><block class=" token">glob</block><block class="punctuation token">(</block><block class=" token">dogs_dir</block><block class="punctuation token">)</block><block class="punctuation token">[</block><block class="punctuation token">:</block><block class="number token">32</block><block class="punctuation token">]</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">test_cat_list </block><block class="operator token">=</block><block class=" token"> </block><block class="builtin token">list</block><block class="punctuation token">(</block><block class=" token">glob</block><block class="punctuation token">.</block><block class=" token">glob</block><block class="punctuation token">(</block><block class=" token">cats_dir</block><block class="punctuation token">)</block><block class="punctuation token">[</block><block class="number token">32</block><block class="punctuation token">:</block><block class="punctuation token">]</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">test_dog_list </block><block class="operator token">=</block><block class=" token"> </block><block class="builtin token">list</block><block class="punctuation token">(</block><block class=" token">glob</block><block class="punctuation token">.</block><block class=" token">glob</block><block class="punctuation token">(</block><block class=" token">dogs_dir</block><block class="punctuation token">)</block><block class="punctuation token">[</block><block class="number token">32</block><block class="punctuation token">:</block><block class="punctuation token">]</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">train_data_paths </block><block class="operator token">=</block><block class=" token"> train_cat_list </block><block class="operator token">+</block><block class=" token"> train_dog_list </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">test_data_paths </block><block class="operator token">=</block><block class=" token"> test_cat_list </block><block class="operator token">+</block><block class=" token"> test_dog_list</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">def</block><block class=" token"> </block><block class="function token">write_to_tfrecords</block><block class="punctuation token">(</block><block class=" token">target_dir</block><block class="punctuation token">,</block><block class=" token"> data_paths</block><block class="punctuation token">,</block><block class=" token"> prefix</block><block class="punctuation token">)</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    tfr_path </block><block class="operator token">=</block><block class=" token"> </block><block class="string-interpolation string token">f"</block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">target_dir</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">/tf_records/"</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    dbutils</block><block class="punctuation token">.</block><block class=" token">fs</block><block class="punctuation token">.</block><block class=" token">mkdirs</block><block class="punctuation token">(</block><block class=" token">tfr_path</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    tfr_file_path </block><block class="operator token">=</block><block class=" token"> os</block><block class="punctuation token">.</block><block class=" token">path</block><block class="punctuation token">.</block><block class=" token">join</block><block class="punctuation token">(</block><block class=" token">target_dir</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string-interpolation string token">f"cats_dogs_</block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">prefix</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">.tfrecords"</block><block class="punctuation token">)</block><block class="punctuation token">.</block><block class=" token">replace</block><block class="punctuation token">(</block><block class="string token">"dbfs:/"</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"/dbfs/"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    writer </block><block class="operator token">=</block><block class=" token"> tf</block><block class="punctuation token">.</block><block class=" token">io</block><block class="punctuation token">.</block><block class=" token">TFRecordWriter</block><block class="punctuation token">(</block><block class=" token">tfr_file_path</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="comment token"># the number of classes of images</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    classes </block><block class="operator token">=</block><block class=" token"> </block><block class="punctuation token">{</block><block class="string token">"0"</block><block class=" token"> </block><block class="punctuation token">:</block><block class=" token"> </block><block class="string token">"cats"</block><block class="punctuation token">,</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">               </block><block class="string token">"1"</block><block class=" token"> </block><block class="punctuation token">:</block><block class=" token"> </block><block class="string token">"dogs"</block><block class="punctuation token">}</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="comment token"># Loop to convert each image array to raw bytes one at a time</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="keyword token">for</block><block class=" token"> img_path </block><block class="keyword token">in</block><block class=" token"> data_paths</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">      </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block><block class="comment token"># Get the integer value for the associated label </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        label </block><block class="operator token">=</block><block class=" token"> Path</block><block class="punctuation token">(</block><block class=" token">img_path</block><block class="punctuation token">)</block><block class="punctuation token">.</block><block class=" token">parent</block><block class="punctuation token">.</block><block class=" token">name</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        label_int </block><block class="operator token">=</block><block class=" token"> </block><block class="builtin token">list</block><block class="punctuation token">(</block><block class=" token">classes</block><block class="punctuation token">.</block><block class=" token">values</block><block class="punctuation token">(</block><block class="punctuation token">)</block><block class="punctuation token">)</block><block class="punctuation token">.</block><block class=" token">index</block><block class="punctuation token">(</block><block class=" token">label</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        img_raw </block><block class="operator token">=</block><block class=" token"> </block><block class="builtin token">open</block><block class="punctuation token">(</block><block class=" token">img_path</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"rb"</block><block class="punctuation token">)</block><block class="punctuation token">.</block><block class=" token">read</block><block class="punctuation token">(</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        img_shape </block><block class="operator token">=</block><block class=" token"> tf</block><block class="punctuation token">.</block><block class=" token">io</block><block class="punctuation token">.</block><block class=" token">decode_jpeg</block><block class="punctuation token">(</block><block class=" token">img_raw</block><block class="punctuation token">)</block><block class="punctuation token">.</block><block class=" token">shape</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block><block class="comment token"># To store data, we need to add feature to it</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block><block class="comment token"># Each feature has a key value pair, where the key holds the string name and the value holds the data</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        my_features </block><block class="operator token">=</block><block class=" token"> </block><block class="punctuation token">{</block><block class="string token">"height"</block><block class="punctuation token">:</block><block class=" token"> tf</block><block class="punctuation token">.</block><block class=" token">train</block><block class="punctuation token">.</block><block class=" token">Feature</block><block class="punctuation token">(</block><block class=" token">int64_list</block><block class="operator token">=</block><block class=" token">tf</block><block class="punctuation token">.</block><block class=" token">train</block><block class="punctuation token">.</block><block class=" token">Int64List</block><block class="punctuation token">(</block><block class=" token">value</block><block class="operator token">=</block><block class="punctuation token">[</block><block class=" token">img_shape</block><block class="punctuation token">[</block><block class="number token">0</block><block class="punctuation token">]</block><block class="punctuation token">]</block><block class="punctuation token">)</block><block class="punctuation token">)</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                       </block><block class="string token">"width"</block><block class="punctuation token">:</block><block class=" token"> tf</block><block class="punctuation token">.</block><block class=" token">train</block><block class="punctuation token">.</block><block class=" token">Feature</block><block class="punctuation token">(</block><block class=" token">int64_list</block><block class="operator token">=</block><block class=" token">tf</block><block class="punctuation token">.</block><block class=" token">train</block><block class="punctuation token">.</block><block class=" token">Int64List</block><block class="punctuation token">(</block><block class=" token">value</block><block class="operator token">=</block><block class="punctuation token">[</block><block class=" token">img_shape</block><block class="punctuation token">[</block><block class="number token">1</block><block class="punctuation token">]</block><block class="punctuation token">]</block><block class="punctuation token">)</block><block class="punctuation token">)</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                       </block><block class="string token">"depth"</block><block class="punctuation token">:</block><block class=" token"> tf</block><block class="punctuation token">.</block><block class=" token">train</block><block class="punctuation token">.</block><block class=" token">Feature</block><block class="punctuation token">(</block><block class=" token">int64_list</block><block class="operator token">=</block><block class=" token">tf</block><block class="punctuation token">.</block><block class=" token">train</block><block class="punctuation token">.</block><block class=" token">Int64List</block><block class="punctuation token">(</block><block class=" token">value</block><block class="operator token">=</block><block class="punctuation token">[</block><block class=" token">img_shape</block><block class="punctuation token">[</block><block class="number token">2</block><block class="punctuation token">]</block><block class="punctuation token">]</block><block class="punctuation token">)</block><block class="punctuation token">)</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                       </block><block class="string token">"img_raw"</block><block class="punctuation token">:</block><block class=" token"> tf</block><block class="punctuation token">.</block><block class=" token">train</block><block class="punctuation token">.</block><block class=" token">Feature</block><block class="punctuation token">(</block><block class=" token">bytes_list</block><block class="operator token">=</block><block class=" token">tf</block><block class="punctuation token">.</block><block class=" token">train</block><block class="punctuation token">.</block><block class=" token">BytesList</block><block class="punctuation token">(</block><block class=" token">value</block><block class="operator token">=</block><block class="punctuation token">[</block><block class=" token">img_raw</block><block class="punctuation token">]</block><block class="punctuation token">)</block><block class="punctuation token">)</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                       </block><block class="comment token"># tf.train.Feature must be in either bytes, float, or integer </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                       </block><block class="string token">"label"</block><block class="punctuation token">:</block><block class=" token"> tf</block><block class="punctuation token">.</block><block class=" token">train</block><block class="punctuation token">.</block><block class=" token">Feature</block><block class="punctuation token">(</block><block class=" token">int64_list</block><block class="operator token">=</block><block class=" token">tf</block><block class="punctuation token">.</block><block class=" token">train</block><block class="punctuation token">.</block><block class=" token">Int64List</block><block class="punctuation token">(</block><block class=" token">value</block><block class="operator token">=</block><block class="punctuation token">[</block><block class="builtin token">int</block><block class="punctuation token">(</block><block class=" token">label_int</block><block class="punctuation token">)</block><block class="punctuation token">]</block><block class="punctuation token">)</block><block class="punctuation token">)</block><block class="punctuation token">}</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">            </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        example </block><block class="operator token">=</block><block class=" token"> tf</block><block class="punctuation token">.</block><block class=" token">train</block><block class="punctuation token">.</block><block class=" token">Example</block><block class="punctuation token">(</block><block class=" token">features</block><block class="operator token">=</block><block class=" token">tf</block><block class="punctuation token">.</block><block class=" token">train</block><block class="punctuation token">.</block><block class=" token">Features</block><block class="punctuation token">(</block><block class=" token">feature</block><block class="operator token">=</block><block class=" token">my_features</block><block class="punctuation token">)</block><block class="punctuation token">)</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        writer</block><block class="punctuation token">.</block><block class=" token">write</block><block class="punctuation token">(</block><block class=" token">example</block><block class="punctuation token">.</block><block class=" token">SerializeToString</block><block class="punctuation token">(</block><block class="punctuation token">)</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    writer</block><block class="punctuation token">.</block><block class=" token">close</block><block class="punctuation token">(</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="keyword token">print</block><block class="punctuation token">(</block><block class="string-interpolation string token">f"Written to </block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">tfr_file_path</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="keyword token">return</block><block class=" token"> tfr_file_path</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">tfr_train_file_path </block><block class="operator token">=</block><block class=" token">  write_to_tfrecords</block><block class="punctuation token">(</block><block class=" token">DA</block><block class="punctuation token">.</block><block class=" token">paths</block><block class="punctuation token">.</block><block class=" token">working_dir</block><block class="punctuation token">,</block><block class=" token"> train_data_paths</block><block class="punctuation token">,</block><block class=" token"> prefix</block><block class="operator token">=</block><block class="string token">"train"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">tfr_test_file_path </block><block class="operator token">=</block><block class=" token"> write_to_tfrecords</block><block class="punctuation token">(</block><block class=" token">DA</block><block class="punctuation token">.</block><block class=" token">paths</block><block class="punctuation token">.</block><block class=" token">working_dir</block><block class="punctuation token">,</block><block class=" token"> test_data_paths</block><block class="punctuation token">,</block><block class=" token"> prefix</block><block class="operator token">=</block><block class="string token">"test"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">def</block><block class=" token"> </block><block class="function token">train</block><block class="punctuation token">(</block><block class="punctuation token">)</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="keyword token">from</block><block class=" token"> dataclasses </block><block class="keyword token">import</block><block class=" token"> dataclass</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="keyword token">import</block><block class=" token"> tensorflow </block><block class="keyword token">as</block><block class=" token"> tf</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="keyword token">from</block><block class=" token"> tensorflow</block><block class="punctuation token">.</block><block class=" token">keras </block><block class="keyword token">import</block><block class=" token"> layers</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="keyword token">from</block><block class=" token"> tensorflow</block><block class="punctuation token">.</block><block class=" token">keras</block><block class="punctuation token">.</block><block class=" token">optimizers </block><block class="keyword token">import</block><block class=" token"> Adam</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    tf</block><block class="punctuation token">.</block><block class=" token">random</block><block class="punctuation token">.</block><block class=" token">set_seed</block><block class="punctuation token">(</block><block class="number token">42</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="keyword token">def</block><block class=" token"> </block><block class="function token">build_compile_model</block><block class="punctuation token">(</block><block class=" token">cfg</block><block class="punctuation token">)</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        model </block><block class="operator token">=</block><block class=" token"> tf</block><block class="punctuation token">.</block><block class=" token">keras</block><block class="punctuation token">.</block><block class=" token">models</block><block class="punctuation token">.</block><block class=" token">Sequential</block><block class="punctuation token">(</block><block class="punctuation token">[</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">            layers</block><block class="punctuation token">.</block><block class=" token">Conv2D</block><block class="punctuation token">(</block><block class="number token">32</block><block class="punctuation token">,</block><block class=" token"> kernel_size</block><block class="operator token">=</block><block class="punctuation token">(</block><block class="number token">3</block><block class="punctuation token">,</block><block class=" token"> </block><block class="number token">3</block><block class="punctuation token">)</block><block class="punctuation token">,</block><block class=" token"> activation</block><block class="operator token">=</block><block class="string token">"relu"</block><block class="punctuation token">,</block><block class=" token"> input_shape</block><block class="operator token">=</block><block class="punctuation token">[</block><block class=" token">cfg</block><block class="punctuation token">.</block><block class=" token">img_height</block><block class="punctuation token">,</block><block class=" token"> cfg</block><block class="punctuation token">.</block><block class=" token">img_width</block><block class="punctuation token">,</block><block class=" token"> cfg</block><block class="punctuation token">.</block><block class=" token">img_channels</block><block class="punctuation token">]</block><block class="punctuation token">)</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">            layers</block><block class="punctuation token">.</block><block class=" token">MaxPooling2D</block><block class="punctuation token">(</block><block class=" token">pool_size</block><block class="operator token">=</block><block class="punctuation token">(</block><block class="number token">2</block><block class="punctuation token">,</block><block class=" token"> </block><block class="number token">2</block><block class="punctuation token">)</block><block class="punctuation token">)</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">            layers</block><block class="punctuation token">.</block><block class=" token">Flatten</block><block class="punctuation token">(</block><block class="punctuation token">)</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">            layers</block><block class="punctuation token">.</block><block class=" token">Dense</block><block class="punctuation token">(</block><block class="number token">128</block><block class="punctuation token">,</block><block class=" token"> activation</block><block class="operator token">=</block><block class="string token">"relu"</block><block class="punctuation token">)</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">            layers</block><block class="punctuation token">.</block><block class=" token">Dense</block><block class="punctuation token">(</block><block class="number token">1</block><block class="punctuation token">,</block><block class=" token"> activation</block><block class="operator token">=</block><block class="string token">"sigmoid"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block><block class="punctuation token">]</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        model</block><block class="punctuation token">.</block><block class="builtin token">compile</block><block class="punctuation token">(</block><block class=" token">loss</block><block class="operator token">=</block><block class="string token">"binary_crossentropy"</block><block class="punctuation token">,</block><block class=" token"> optimizer</block><block class="operator token">=</block><block class=" token">Adam</block><block class="punctuation token">(</block><block class=" token">learning_rate</block><block class="operator token">=</block><block class=" token">cfg</block><block class="punctuation token">.</block><block class=" token">learning_rate</block><block class="punctuation token">)</block><block class="punctuation token">,</block><block class=" token"> metrics</block><block class="operator token">=</block><block class="punctuation token">[</block><block class="string token">"accuracy"</block><block class="punctuation token">]</block><block class="punctuation token">)</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block><block class="keyword token">return</block><block class=" token"> model </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    model </block><block class="operator token">=</block><block class=" token"> build_compile_model</block><block class="punctuation token">(</block><block class=" token">train_cfg</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    train_ds </block><block class="operator token">=</block><block class=" token"> parse_tfrecords</block><block class="punctuation token">(</block><block class=" token">tfr_train_file_path</block><block class="punctuation token">,</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                                   train_cfg</block><block class="punctuation token">.</block><block class=" token">img_height</block><block class="punctuation token">,</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                                   train_cfg</block><block class="punctuation token">.</block><block class=" token">img_width</block><block class="punctuation token">,</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                                   train_cfg</block><block class="punctuation token">.</block><block class=" token">img_channels</block><block class="punctuation token">,</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                                   train_cfg</block><block class="punctuation token">.</block><block class=" token">batch_size</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    options </block><block class="operator token">=</block><block class=" token"> tf</block><block class="punctuation token">.</block><block class=" token">data</block><block class="punctuation token">.</block><block class=" token">Options</block><block class="punctuation token">(</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    options</block><block class="punctuation token">.</block><block class=" token">experimental_distribute</block><block class="punctuation token">.</block><block class=" token">auto_shard_policy </block><block class="operator token">=</block><block class=" token"> tf</block><block class="punctuation token">.</block><block class=" token">data</block><block class="punctuation token">.</block><block class=" token">experimental</block><block class="punctuation token">.</block><block class=" token">AutoShardPolicy</block><block class="punctuation token">.</block><block class=" token">DATA</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    train_ds </block><block class="operator token">=</block><block class=" token"> train_ds</block><block class="punctuation token">.</block><block class=" token">with_options</block><block class="punctuation token">(</block><block class=" token">options</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    history </block><block class="operator token">=</block><block class=" token"> model</block><block class="punctuation token">.</block><block class=" token">fit</block><block class="punctuation token">(</block><block class=" token">train_ds</block><block class="punctuation token">,</block><block class=" token"> epochs</block><block class="operator token">=</block><block class="number token">1</block><block class="punctuation token">,</block><block class=" token"> steps_per_epoch</block><block class="operator token">=</block><block class="number token">8</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    test_ds </block><block class="operator token">=</block><block class=" token"> parse_tfrecords</block><block class="punctuation token">(</block><block class=" token">tfr_test_file_path</block><block class="punctuation token">,</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                              train_cfg</block><block class="punctuation token">.</block><block class=" token">img_height</block><block class="punctuation token">,</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                              train_cfg</block><block class="punctuation token">.</block><block class=" token">img_width</block><block class="punctuation token">,</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                              train_cfg</block><block class="punctuation token">.</block><block class=" token">img_channels</block><block class="punctuation token">,</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                              train_cfg</block><block class="punctuation token">.</block><block class=" token">batch_size</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    eval_results </block><block class="operator token">=</block><block class=" token"> model</block><block class="punctuation token">.</block><block class=" token">evaluate</block><block class="punctuation token">(</block><block class=" token">test_ds</block><block class="punctuation token">,</block><block class=" token"> steps</block><block class="operator token">=</block><block class="number token">2</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="keyword token">return</block><block class=" token"> model </block><block class="punctuation token">,</block><block class=" token"> eval_results</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Train on the driver node</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">from</block><block class=" token"> spark_tensorflow_distributor </block><block class="keyword token">import</block><block class=" token"> MirroredStrategyRunner</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">import</block><block class=" token"> mlflow</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">import</block><block class=" token"> mlflow</block><block class="punctuation token">.</block><block class=" token">tensorflow</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">with</block><block class=" token"> mlflow</block><block class="punctuation token">.</block><block class=" token">start_run</block><block class="punctuation token">(</block><block class="punctuation token">)</block><block class=" token"> </block><block class="keyword token">as</block><block class=" token"> local_run</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    runner </block><block class="operator token">=</block><block class=" token"> MirroredStrategyRunner</block><block class="punctuation token">(</block><block class=" token">num_slots</block><block class="operator token">=</block><block class="number token">1</block><block class="punctuation token">,</block><block class=" token"> local_mode</block><block class="operator token">=</block><block class="boolean token">True</block><block class="punctuation token">,</block><block class=" token"> use_gpu</block><block class="operator token">=</block><block class="boolean token">False</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    local_model</block><block class="punctuation token">,</block><block class=" token"> local_eval_results </block><block class="operator token">=</block><block class=" token"> runner</block><block class="punctuation token">.</block><block class=" token">run</block><block class="punctuation token">(</block><block class=" token">train</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    mlflow</block><block class="punctuation token">.</block><block class=" token">tensorflow</block><block class="punctuation token">.</block><block class=" token">log_model</block><block class="punctuation token">(</block><block class=" token">local_model</block><block class="punctuation token">,</block><block class=" token"> artifact_path</block><block class="operator token">=</block><block class="string token">"local_model"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Load model using MLflow and evaluate on test set</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">loaded_model </block><block class="operator token">=</block><block class=" token"> mlflow</block><block class="punctuation token">.</block><block class=" token">tensorflow</block><block class="punctuation token">.</block><block class=" token">load_model</block><block class="punctuation token">(</block><block class=" token">model_uri</block><block class="operator token">=</block><block class="string-interpolation string token">f"runs:/</block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">local_run</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">info</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">run_id</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">/local_model"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">test_ds </block><block class="operator token">=</block><block class=" token"> parse_tfrecords</block><block class="punctuation token">(</block><block class=" token">tfr_test_file_path</block><block class="punctuation token">,</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                           train_cfg</block><block class="punctuation token">.</block><block class=" token">img_height</block><block class="punctuation token">,</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                           train_cfg</block><block class="punctuation token">.</block><block class=" token">img_width</block><block class="punctuation token">,</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                           train_cfg</block><block class="punctuation token">.</block><block class=" token">img_channels</block><block class="punctuation token">,</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                           train_cfg</block><block class="punctuation token">.</block><block class=" token">batch_size</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">loaded_model</block><block class="punctuation token">.</block><block class=" token">evaluate</block><block class="punctuation token">(</block><block class=" token">test_ds</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Train on workers</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">with</block><block class=" token"> mlflow</block><block class="punctuation token">.</block><block class=" token">start_run</block><block class="punctuation token">(</block><block class="punctuation token">)</block><block class=" token"> </block><block class="keyword token">as</block><block class=" token"> dist_run</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    dist_runner </block><block class="operator token">=</block><block class=" token"> MirroredStrategyRunner</block><block class="punctuation token">(</block><block class=" token">num_slots</block><block class="operator token">=</block><block class="number token">4</block><block class="punctuation token">,</block><block class=" token"> local_mode</block><block class="operator token">=</block><block class="boolean token">False</block><block class="punctuation token">,</block><block class=" token"> use_custom_strategy</block><block class="operator token">=</block><block class="boolean token">True</block><block class="punctuation token">,</block><block class=" token"> use_gpu</block><block class="operator token">=</block><block class="boolean token">False</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    dist_model</block><block class="punctuation token">,</block><block class=" token"> dist_eval_results </block><block class="operator token">=</block><block class=" token"> dist_runner</block><block class="punctuation token">.</block><block class=" token">run</block><block class="punctuation token">(</block><block class=" token">train</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    mlflow</block><block class="punctuation token">.</block><block class=" token">tensorflow</block><block class="punctuation token">.</block><block class=" token">log_model</block><block class="punctuation token">(</block><block class=" token">dist_model</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"dist_model"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">loaded_dist_model </block><block class="operator token">=</block><block class=" token"> mlflow</block><block class="punctuation token">.</block><block class=" token">tensorflow</block><block class="punctuation token">.</block><block class=" token">load_model</block><block class="punctuation token">(</block><block class=" token">model_uri</block><block class="operator token">=</block><block class="string-interpolation string token">f"runs:/</block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">dist_run</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">info</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">run_id</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">/dist_model"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">loaded_dist_model</block><block class="punctuation token">.</block><block class=" token">evaluate</block><block class="punctuation token">(</block><block class=" token">test_ds</block><block class="punctuation token">)</block></blocks></line></editarea></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">[</block><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><compositeblock dir="ltr" class="anchor-tag-ref inline" style="font-family: &quot;Computer Modern Serif&quot;, serif; background-color: rgba(155, 155, 155, 0.2);"><a href="#n0.3715415633810799" style="color: inherit; text-decoration: inherit;">Back To Top</a></compositeblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">]</block></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="inline" style="display: block;"><div style="vertical-align: baseline;"><div style="display: inline-block; height: 0px; border-bottom: 1px solid; width: 100%;"></div></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode section sindent-0" data-line-id="n0.11953009128235137" style="font-size: 1.2em; padding-top: 0.5em; padding-bottom: 0.5em; font-weight: bold; line-height: 1.4;" id="n0.11953009128235137" role="heading" aria-level="1"><prefix style="text-align: left; padding-right: 0.5em;">9. </prefix><blocks><baselineblock class="inline"></baselineblock><block>Model Serving</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>In this section, we explore a more complex deployment scenario involving the real time deployment of a convolutional neural network using REST and Databricks </block><block style="font-weight: bold; color: rgb(255, 64, 0);">MLflow Model Serving</block><block>.</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode section sindent-1" data-line-id="n0.8646135148335732" style="font-size: 1.1em; padding-top: 0.5em; padding-bottom: 0.5em; font-weight: bold; line-height: 1.4;" id="n0.8646135148335732" role="heading" aria-level="2"><prefix style="text-align: left; padding-right: 0.25em;">9.1. </prefix><blocks><baselineblock class="inline"></baselineblock><block>Model Serving in Databricks</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>The </block><block style="font-weight: bold;">MLflow model registry</block><block> in Databricks is now integrated with </block><block style="font-weight: bold;">MLflow Model Serving</block><block>. </block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>This is </block><block style="text-decoration: underline;">currently</block><block> intended for development use cases and is therefore </block><block style="text-decoration: underline;">not intended for production</block><block>. </block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>In this module, you will create a </block><block style="text-decoration: underline;">wrapper class around a keras model</block><block> that provides custom pre and post processing logic necessary for this more complex deployment scenario.</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>For additional background, see the following resources:</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://databricks.com/blog/2020/06/25/announcing-mlflow-model-serving-on-databricks.html" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://databricks.com/blog/2020/06/25/announcing-mlflow-model-serving-on-databricks.html" target="_blank" style="color: inherit; text-decoration: inherit;">Databricks blog on model serving</a></block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://github.com/mlflow/mlflow/tree/master/examples/flower_classifier" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://github.com/mlflow/mlflow/tree/master/examples/flower_classifier" target="_blank" style="color: inherit; text-decoration: inherit;">Example of an image classifier</a></block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://www.mlflow.org/docs/latest/models.html#example-saving-an-xgboost-model-in-mlflow-format" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://www.mlflow.org/docs/latest/models.html#example-saving-an-xgboost-model-in-mlflow-format" target="_blank" style="color: inherit; text-decoration: inherit;">Example of a custom loader used with XGBoost</a></block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode section sindent-2" data-line-id="n0.3212049640387755" style="font-size: 1em; padding-top: 0.5em; padding-bottom: 0.5em; font-weight: bold; line-height: 1.4;" id="n0.3212049640387755" role="heading" aria-level="3"><prefix style="text-align: left; padding-right: 0em;">9.1.1. </prefix><blocks><baselineblock class="inline"></baselineblock><block>Creating a Wrapper Class using </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; font-weight: bold;">pyfunc</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Create a wrapper class that includes the following as a </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">pyfunc</block><block>:</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>A </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">load_context</block><block> method to load in the model.</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Custom featurization logic that parses base64 encoded images (necessary for HTTP requests)</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Custom prediction logic that reports the top class and its probability</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item full-line-block-inside" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="code-section-symbol inline" style="display: block;"><div class="code-section theme-tomorrow-night" style="display: block; border: 1px solid lightgray; background: rgb(45, 45, 45); padding: 10px; font-size: 10px;"><editarea class="text-mode code-section-edit-area" style="font-family: &quot;Fira code&quot;, &quot;Fira Mono&quot;, monospace;"><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Create a keras model using a reference architecture and pretrained weights.</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">import</block><block class=" token"> tensorflow </block><block class="keyword token">as</block><block class=" token"> tf</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">tf</block><block class="punctuation token">.</block><block class=" token">random</block><block class="punctuation token">.</block><block class=" token">set_seed</block><block class="punctuation token">(</block><block class="number token">42</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">model </block><block class="operator token">=</block><block class=" token"> tf</block><block class="punctuation token">.</block><block class=" token">keras</block><block class="punctuation token">.</block><block class=" token">applications</block><block class="punctuation token">.</block><block class=" token">VGG16</block><block class="punctuation token">(</block><block class=" token">weights</block><block class="operator token">=</block><block class="string token">"imagenet"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">model</block><block class="punctuation token">.</block><block class=" token">summary</block><block class="punctuation token">(</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Create a small dataset to test the model. This is two images of cats.</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">import</block><block class=" token"> pandas </block><block class="keyword token">as</block><block class=" token"> pd</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">import</block><block class=" token"> base64</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">filenames </block><block class="operator token">=</block><block class=" token"> </block><block class="punctuation token">[</block><block class="string-interpolation string token">f"</block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">DA</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">paths</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">datasets</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">/img/cats/cats2.jpg"</block><block class="punctuation token">.</block><block class=" token">replace</block><block class="punctuation token">(</block><block class="string token">"dbfs:/"</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"/dbfs/"</block><block class="punctuation token">)</block><block class="punctuation token">,</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">             </block><block class="string-interpolation string token">f"</block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">DA</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">paths</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">datasets</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">/img/cats/cats4.jpg"</block><block class="punctuation token">.</block><block class=" token">replace</block><block class="punctuation token">(</block><block class="string token">"dbfs:/"</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"/dbfs/"</block><block class="punctuation token">)</block><block class="punctuation token">]</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">def</block><block class=" token"> </block><block class="function token">read_image</block><block class="punctuation token">(</block><block class=" token">path</block><block class="punctuation token">:</block><block class=" token"> </block><block class="builtin token">str</block><block class="punctuation token">)</block><block class=" token"> </block><block class="operator token">-</block><block class="operator token">&gt;</block><block class=" token"> </block><block class="builtin token">bytes</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="triple-quoted-string string token">"""Reads an image from a path and returns the contents in bytes"""</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="keyword token">with</block><block class=" token"> </block><block class="builtin token">open</block><block class="punctuation token">(</block><block class=" token">path</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"rb"</block><block class="punctuation token">)</block><block class=" token"> </block><block class="keyword token">as</block><block class=" token"> f</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        image_bytes </block><block class="operator token">=</block><block class=" token"> f</block><block class="punctuation token">.</block><block class=" token">read</block><block class="punctuation token">(</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="keyword token">return</block><block class=" token"> image_bytes</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">data </block><block class="operator token">=</block><block class=" token"> pd</block><block class="punctuation token">.</block><block class=" token">DataFrame</block><block class="punctuation token">(</block><block class=" token">data</block><block class="operator token">=</block><block class="punctuation token">[</block><block class=" token">base64</block><block class="punctuation token">.</block><block class=" token">b64encode</block><block class="punctuation token">(</block><block class=" token">read_image</block><block class="punctuation token">(</block><block class=" token">x</block><block class="punctuation token">)</block><block class="punctuation token">)</block><block class=" token"> </block><block class="keyword token">for</block><block class=" token"> x </block><block class="keyword token">in</block><block class=" token"> filenames</block><block class="punctuation token">]</block><block class="punctuation token">,</block><block class=" token"> columns</block><block class="operator token">=</block><block class="punctuation token">[</block><block class="string token">"image"</block><block class="punctuation token">]</block><block class="punctuation token">)</block><block class=" token"> </block><block class="comment token">#refer to doc https://docs.python.org/3/library/base64.html</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">data</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Save the model using mlflow.</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">import</block><block class=" token"> mlflow</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">import</block><block class=" token"> mlflow</block><block class="punctuation token">.</block><block class=" token">keras</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">suffix </block><block class="operator token">=</block><block class=" token"> DA</block><block class="punctuation token">.</block><block class=" token">unique_name</block><block class="punctuation token">(</block><block class="string token">"-"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">model_name </block><block class="operator token">=</block><block class=" token"> </block><block class="string-interpolation string token">f"keras-model_</block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">suffix</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">"</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">with</block><block class=" token"> mlflow</block><block class="punctuation token">.</block><block class=" token">start_run</block><block class="punctuation token">(</block><block class="punctuation token">)</block><block class=" token"> </block><block class="keyword token">as</block><block class=" token"> run</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    mlflow</block><block class="punctuation token">.</block><block class=" token">tensorflow</block><block class="punctuation token">.</block><block class=" token">log_model</block><block class="punctuation token">(</block><block class=" token">model</block><block class="operator token">=</block><block class=" token">model</block><block class="punctuation token">,</block><block class=" token"> artifact_path</block><block class="operator token">=</block><block class=" token">model_name</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    model_uri </block><block class="operator token">=</block><block class=" token"> </block><block class="string-interpolation string token">f"runs:/</block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">run</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">info</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">run_id</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">/</block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">model_name</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">"</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">print</block><block class="punctuation token">(</block><block class="string-interpolation string token">f"Model saved to </block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">model_uri</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Create a wrapper class using pyfunc</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">import</block><block class=" token"> mlflow</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">class</block><block class=" token"> </block><block class="class-name token">KerasImageClassifierPyfunc</block><block class="punctuation token">(</block><block class=" token">mlflow</block><block class="punctuation token">.</block><block class=" token">pyfunc</block><block class="punctuation token">.</block><block class=" token">PythonModel</block><block class="punctuation token">)</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">  </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="keyword token">def</block><block class=" token"> </block><block class="function token">__init__</block><block class="punctuation token">(</block><block class=" token">self</block><block class="punctuation token">)</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        self</block><block class="punctuation token">.</block><block class=" token">model </block><block class="operator token">=</block><block class=" token"> </block><block class="boolean token">None</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        self</block><block class="punctuation token">.</block><block class=" token">img_height </block><block class="operator token">=</block><block class=" token"> </block><block class="number token">224</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        self</block><block class="punctuation token">.</block><block class=" token">img_width </block><block class="operator token">=</block><block class=" token"> </block><block class="number token">224</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="keyword token">def</block><block class=" token"> </block><block class="function token">load_context</block><block class="punctuation token">(</block><block class=" token">self</block><block class="punctuation token">,</block><block class=" token"> context</block><block class="operator token">=</block><block class="boolean token">None</block><block class="punctuation token">,</block><block class=" token"> path</block><block class="operator token">=</block><block class="boolean token">None</block><block class="punctuation token">)</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block><block class="triple-quoted-string string token">"""</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="triple-quoted-string string token">        When loading a pyfunc, this method runs automatically with the related</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="triple-quoted-string string token">        context.  This method is designed to load the keras model from a path </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="triple-quoted-string string token">        if it is running in a notebook or use the artifact from the context</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="triple-quoted-string string token">        if it is loaded with mlflow.pyfunc.load_model()</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="triple-quoted-string string token">        """</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block><block class="keyword token">import</block><block class=" token"> numpy </block><block class="keyword token">as</block><block class=" token"> np</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block><block class="keyword token">import</block><block class=" token"> tensorflow </block><block class="keyword token">as</block><block class=" token"> tf</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block><block class="keyword token">if</block><block class=" token"> context</block><block class="punctuation token">:</block><block class=" token"> </block><block class="comment token"># This block executes for server run</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">            model_path </block><block class="operator token">=</block><block class=" token"> context</block><block class="punctuation token">.</block><block class=" token">artifacts</block><block class="punctuation token">[</block><block class="string token">"keras_model"</block><block class="punctuation token">]</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block><block class="keyword token">else</block><block class="punctuation token">:</block><block class=" token"> </block><block class="comment token"># This block executes for notebook run</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">            model_path </block><block class="operator token">=</block><block class=" token"> path</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        self</block><block class="punctuation token">.</block><block class=" token">model </block><block class="operator token">=</block><block class=" token"> mlflow</block><block class="punctuation token">.</block><block class=" token">tensorflow</block><block class="punctuation token">.</block><block class=" token">load_model</block><block class="punctuation token">(</block><block class=" token">model_path</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="keyword token">def</block><block class=" token"> </block><block class="function token">predict_from_bytes</block><block class="punctuation token">(</block><block class=" token">self</block><block class="punctuation token">,</block><block class=" token"> image_bytes</block><block class="punctuation token">)</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block><block class="triple-quoted-string string token">"""</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="triple-quoted-string string token">        Applied across numpy representations of the model input, this method</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="triple-quoted-string string token">        uses the appropriate decoding based upon whether it is run in the </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="triple-quoted-string string token">        notebook or on a server</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="triple-quoted-string string token">        """</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block><block class="keyword token">import</block><block class=" token"> base64</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block><block class="keyword token">try</block><block class="punctuation token">:</block><block class=" token"> </block><block class="comment token"># This block executes for notebook run</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">            image_bytes_decoded </block><block class="operator token">=</block><block class=" token"> base64</block><block class="punctuation token">.</block><block class=" token">b64decode</block><block class="punctuation token">(</block><block class=" token">image_bytes</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">            img_array </block><block class="operator token">=</block><block class=" token"> tf</block><block class="punctuation token">.</block><block class=" token">image</block><block class="punctuation token">.</block><block class=" token">decode_image</block><block class="punctuation token">(</block><block class=" token">image_bytes_decoded</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block><block class="keyword token">except</block><block class="punctuation token">:</block><block class=" token"> </block><block class="comment token"># This block executes for server run</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">            img_array </block><block class="operator token">=</block><block class=" token"> tf</block><block class="punctuation token">.</block><block class=" token">image</block><block class="punctuation token">.</block><block class=" token">decode_image</block><block class="punctuation token">(</block><block class=" token">image_bytes</block><block class="punctuation token">)</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        img_array </block><block class="operator token">=</block><block class=" token"> tf</block><block class="punctuation token">.</block><block class=" token">image</block><block class="punctuation token">.</block><block class=" token">resize</block><block class="punctuation token">(</block><block class=" token">img_array</block><block class="punctuation token">,</block><block class=" token"> </block><block class="punctuation token">(</block><block class=" token">self</block><block class="punctuation token">.</block><block class=" token">img_height</block><block class="punctuation token">,</block><block class=" token"> self</block><block class="punctuation token">.</block><block class=" token">img_width</block><block class="punctuation token">)</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        img_array </block><block class="operator token">=</block><block class=" token"> tf</block><block class="punctuation token">.</block><block class=" token">expand_dims</block><block class="punctuation token">(</block><block class=" token">img_array</block><block class="punctuation token">,</block><block class=" token"> </block><block class="number token">0</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        prediction </block><block class="operator token">=</block><block class=" token"> self</block><block class="punctuation token">.</block><block class=" token">model</block><block class="punctuation token">.</block><block class=" token">predict</block><block class="punctuation token">(</block><block class=" token">img_array</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block><block class="keyword token">return</block><block class=" token"> prediction</block><block class="punctuation token">[</block><block class="number token">0</block><block class="punctuation token">]</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">  </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="keyword token">def</block><block class=" token"> </block><block class="function token">postprocess_raw_predictions</block><block class="punctuation token">(</block><block class=" token">self</block><block class="punctuation token">,</block><block class=" token"> raw_prediction</block><block class="punctuation token">)</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block><block class="triple-quoted-string string token">"""</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="triple-quoted-string string token">        Post processing logic to render predictions in a human readable form</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="triple-quoted-string string token">        """</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block><block class="keyword token">from</block><block class=" token"> tensorflow</block><block class="punctuation token">.</block><block class=" token">keras</block><block class="punctuation token">.</block><block class=" token">applications</block><block class="punctuation token">.</block><block class=" token">vgg16 </block><block class="keyword token">import</block><block class=" token"> decode_predictions</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        res </block><block class="operator token">=</block><block class=" token"> decode_predictions</block><block class="punctuation token">(</block><block class=" token">raw_prediction</block><block class="punctuation token">,</block><block class=" token"> top</block><block class="operator token">=</block><block class="number token">3</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        str_template </block><block class="operator token">=</block><block class=" token"> </block><block class="string token">"Best response of {best} with probability of {p}"</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block><block class="keyword token">return</block><block class=" token"> </block><block class="punctuation token">[</block><block class=" token">str_template</block><block class="punctuation token">.</block><block class="builtin token">format</block><block class="punctuation token">(</block><block class=" token">best</block><block class="operator token">=</block><block class=" token">i</block><block class="punctuation token">[</block><block class="number token">0</block><block class="punctuation token">]</block><block class="punctuation token">[</block><block class="number token">1</block><block class="punctuation token">]</block><block class="punctuation token">,</block><block class=" token"> p</block><block class="operator token">=</block><block class=" token">i</block><block class="punctuation token">[</block><block class="number token">0</block><block class="punctuation token">]</block><block class="punctuation token">[</block><block class="number token">2</block><block class="punctuation token">]</block><block class="punctuation token">)</block><block class=" token"> </block><block class="keyword token">for</block><block class=" token"> i </block><block class="keyword token">in</block><block class=" token"> res</block><block class="punctuation token">]</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="keyword token">def</block><block class=" token"> </block><block class="function token">predict</block><block class="punctuation token">(</block><block class=" token">self</block><block class="punctuation token">,</block><block class=" token"> context</block><block class="operator token">=</block><block class="boolean token">None</block><block class="punctuation token">,</block><block class=" token"> model_input</block><block class="operator token">=</block><block class="boolean token">None</block><block class="punctuation token">)</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block><block class="triple-quoted-string string token">"""</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="triple-quoted-string string token">        Wrapper predict method</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="triple-quoted-string string token">        """</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        n_records </block><block class="operator token">=</block><block class=" token"> model_input</block><block class="punctuation token">.</block><block class=" token">shape</block><block class="punctuation token">[</block><block class="number token">0</block><block class="punctuation token">]</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        input_numpy </block><block class="operator token">=</block><block class=" token"> model_input</block><block class="punctuation token">.</block><block class=" token">values</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        raw_predictions </block><block class="operator token">=</block><block class=" token"> np</block><block class="punctuation token">.</block><block class=" token">vectorize</block><block class="punctuation token">(</block><block class=" token">self</block><block class="punctuation token">.</block><block class=" token">predict_from_bytes</block><block class="punctuation token">,</block><block class=" token"> otypes</block><block class="operator token">=</block><block class="punctuation token">[</block><block class=" token">np</block><block class="punctuation token">.</block><block class=" token">ndarray</block><block class="punctuation token">]</block><block class="punctuation token">)</block><block class="punctuation token">(</block><block class=" token">input_numpy</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        raw_predictions </block><block class="operator token">=</block><block class=" token"> np</block><block class="punctuation token">.</block><block class=" token">array</block><block class="punctuation token">(</block><block class=" token">raw_predictions</block><block class="punctuation token">.</block><block class=" token">tolist</block><block class="punctuation token">(</block><block class="punctuation token">)</block><block class="punctuation token">)</block><block class="punctuation token">.</block><block class=" token">reshape</block><block class="punctuation token">(</block><block class="punctuation token">[</block><block class=" token">n_records</block><block class="punctuation token">,</block><block class=" token"> </block><block class="number token">1000</block><block class="punctuation token">]</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        decoded_predictions </block><block class="operator token">=</block><block class=" token"> self</block><block class="punctuation token">.</block><block class=" token">postprocess_raw_predictions</block><block class="punctuation token">(</block><block class=" token">raw_predictions</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        decoded_predictions </block><block class="operator token">=</block><block class=" token"> pd</block><block class="punctuation token">.</block><block class=" token">DataFrame</block><block class="punctuation token">(</block><block class=" token">decoded_predictions</block><block class="punctuation token">,</block><block class=" token"> columns</block><block class="operator token">=</block><block class="punctuation token">[</block><block class="string token">"prediction"</block><block class="punctuation token">]</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        decoded_predictions</block><block class="punctuation token">.</block><block class=" token">index </block><block class="operator token">=</block><block class=" token"> model_input</block><block class="punctuation token">.</block><block class=" token">index</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block><block class="keyword token">return</block><block class=" token"> decoded_predictions</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">classifier_pyfunc </block><block class="operator token">=</block><block class=" token"> KerasImageClassifierPyfunc</block><block class="punctuation token">(</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">classifier_pyfunc</block><block class="punctuation token">.</block><block class=" token">load_context</block><block class="punctuation token">(</block><block class=" token">path</block><block class="operator token">=</block><block class=" token">model_uri</block><block class="punctuation token">)</block><block class=" token"> </block><block class="comment token"># This will run automatically when using mlflow.pyfunc.load_model()</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">output </block><block class="operator token">=</block><block class=" token"> classifier_pyfunc</block><block class="punctuation token">.</block><block class=" token">predict</block><block class="punctuation token">(</block><block class=" token">model_input</block><block class="operator token">=</block><block class=" token">data</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">output</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Save the pyfunc with Dependencies</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Create a model signature to document model inputs and outputs.</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">from</block><block class=" token"> mlflow</block><block class="punctuation token">.</block><block class=" token">models</block><block class="punctuation token">.</block><block class=" token">signature </block><block class="keyword token">import</block><block class=" token"> infer_signature</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">signature </block><block class="operator token">=</block><block class=" token"> infer_signature</block><block class="punctuation token">(</block><block class=" token">data</block><block class="punctuation token">,</block><block class=" token"> output</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">print</block><block class="punctuation token">(</block><block class=" token">signature</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Create the Conda environment for all the **`pyfunc`**'s dependencies.</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">import</block><block class=" token"> cloudpickle</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">import</block><block class=" token"> tensorflow</block><block class="punctuation token">.</block><block class=" token">keras</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">from</block><block class=" token"> sys </block><block class="keyword token">import</block><block class=" token"> version_info</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">conda_env </block><block class="operator token">=</block><block class=" token"> </block><block class="punctuation token">{</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="string token">"channels"</block><block class="punctuation token">:</block><block class=" token"> </block><block class="punctuation token">[</block><block class="string token">"defaults"</block><block class="punctuation token">]</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="string token">"dependencies"</block><block class="punctuation token">:</block><block class=" token"> </block><block class="punctuation token">[</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">      </block><block class="string-interpolation string token">f"python=</block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">version_info</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">major</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">.</block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">version_info</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">minor</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">.</block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">version_info</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">micro</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">"</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">      </block><block class="string token">"pip"</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">      </block><block class="punctuation token">{</block><block class="string token">"pip"</block><block class="punctuation token">:</block><block class=" token"> </block><block class="punctuation token">[</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">          </block><block class="string-interpolation string token">f"mlflow==</block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">mlflow</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">__version__</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">"</block><block class="punctuation token">,</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">          </block><block class="string-interpolation string token">f"tensorflow==</block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">tf</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">__version__</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">"</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">          </block><block class="string-interpolation string token">f"cloudpickle==1.2.2"</block><block class="punctuation token">,</block><block class=" token"> </block><block class="comment token"># Forcing cloudpickle version due to serialization issue</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">          </block><block class="string-interpolation string token">f"keras==</block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">tensorflow</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">keras</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">__version__</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">"</block><block class=" token"> </block><block class="comment token"># Need both tensorflow and keras due to mlflow dependency</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block><block class="punctuation token">]</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">      </block><block class="punctuation token">}</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="punctuation token">]</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="string token">"name"</block><block class="punctuation token">:</block><block class=" token"> </block><block class="string token">"keras_env"</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="punctuation token">}</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">import</block><block class=" token"> json</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">print</block><block class="punctuation token">(</block><block class=" token">json</block><block class="punctuation token">.</block><block class=" token">dumps</block><block class="punctuation token">(</block><block class=" token">conda_env</block><block class="punctuation token">,</block><block class=" token"> indent</block><block class="operator token">=</block><block class="number token">4</block><block class="punctuation token">)</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Create associated artifacts. Note that since the default serialization of a keras models uses tensorflow serialization we'll instead read in the model using keras when the Python function is loaded.</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">artifacts </block><block class="operator token">=</block><block class=" token"> </block><block class="punctuation token">{</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="string token">"keras_model"</block><block class="punctuation token">:</block><block class=" token"> model_uri</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="punctuation token">}</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Log the pyfunc including the artifacts, environment, signature, and input example.</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">with</block><block class=" token"> mlflow</block><block class="punctuation token">.</block><block class=" token">start_run</block><block class="punctuation token">(</block><block class="punctuation token">)</block><block class=" token"> </block><block class="keyword token">as</block><block class=" token"> run</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    mlflow</block><block class="punctuation token">.</block><block class=" token">pyfunc</block><block class="punctuation token">.</block><block class=" token">log_model</block><block class="punctuation token">(</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">      </block><block class="string token">"vgg-model"</block><block class="punctuation token">,</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">      python_model</block><block class="operator token">=</block><block class=" token">KerasImageClassifierPyfunc</block><block class="punctuation token">(</block><block class="punctuation token">)</block><block class="punctuation token">,</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">      artifacts</block><block class="operator token">=</block><block class=" token">artifacts</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">      conda_env</block><block class="operator token">=</block><block class=" token">conda_env</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">      signature</block><block class="operator token">=</block><block class=" token">signature</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">      input_example</block><block class="operator token">=</block><block class=" token">data</block><block class="punctuation token">[</block><block class="punctuation token">:</block><block class="number token">1</block><block class="punctuation token">]</block><block class="punctuation token">,</block><block class=" token"> </block><block class="comment token"># Can only log one row because of MLflow serving size limits</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">      registered_model_name</block><block class="operator token">=</block><block class=" token">model_name </block><block class="comment token"># Registers model</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">  </block><block class="punctuation token">)</block></blocks></line></editarea></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">[</block><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><compositeblock dir="ltr" class="anchor-tag-ref inline" style="font-family: &quot;Computer Modern Serif&quot;, serif; background-color: rgba(155, 155, 155, 0.2);"><a href="#n0.3715415633810799" style="color: inherit; text-decoration: inherit;">Back To Top</a></compositeblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">]</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode section sindent-1" data-line-id="n0.844237259461228" style="font-size: 1.1em; padding-top: 0.5em; padding-bottom: 0.5em; font-weight: bold; line-height: 1.4;" id="n0.844237259461228" role="heading" aria-level="2"><prefix style="text-align: left; padding-right: 0.25em;">9.2. </prefix><blocks><baselineblock class="inline"></baselineblock><block>Load from the Model Registry and Serve using REST</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Load from the model registry to confirm the registration is complete.</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item full-line-block-inside" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="code-section-symbol inline" style="display: block;"><div class="code-section theme-tomorrow-night" style="display: block; border: 1px solid lightgray; background: rgb(45, 45, 45); padding: 10px; font-size: 10px;"><editarea class="text-mode code-section-edit-area" style="font-family: &quot;Fira code&quot;, &quot;Fira Mono&quot;, monospace;"><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">import</block><block class=" token"> time</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">model_version_uri </block><block class="operator token">=</block><block class=" token"> </block><block class="string-interpolation string token">f"models:/</block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">model_name</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">/1"</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">while</block><block class=" token"> </block><block class="boolean token">True</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="keyword token">try</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        model_version_1 </block><block class="operator token">=</block><block class=" token"> mlflow</block><block class="punctuation token">.</block><block class=" token">pyfunc</block><block class="punctuation token">.</block><block class=" token">load_model</block><block class="punctuation token">(</block><block class=" token">model_version_uri</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block><block class="keyword token">break</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="keyword token">except</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block><block class="keyword token">print</block><block class="punctuation token">(</block><block class="string-interpolation string token">f"Model not ready yet.  Sleeping..."</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        time</block><block class="punctuation token">.</block><block class=" token">sleep</block><block class="punctuation token">(</block><block class="number token">10</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">model_version_1</block><block class="punctuation token">.</block><block class=" token">predict</block><block class="punctuation token">(</block><block class=" token">data</block><block class="punctuation token">)</block><block class=" token"> </block><block class="comment token"># Test on sample data</block></blocks></line></editarea></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode section sindent-1" data-line-id="n0.2758956457668085" style="font-size: 1.1em; padding-top: 0.5em; padding-bottom: 0.5em; font-weight: bold; line-height: 1.4;" id="n0.2758956457668085" role="heading" aria-level="2"><prefix style="text-align: left; padding-right: 0.25em;">9.3. </prefix><blocks><baselineblock class="inline"></baselineblock><block>Enable MLflow Model Serving for the Registered Model</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Your first task is to enable </block><block style="font-weight: bold;">Model Serving</block><block> for the model that was just registered.</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold; color: rgb(144, 19, 254);">Hint:</block><block> Enable serving for your model. See the Databricks documentation for details (</block><block class="role-hyper-link" data-hyper-link-url="https://docs.databricks.com/machine-learning/model-inference/serverless/create-manage-serverless-endpoints.html" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://docs.databricks.com/machine-learning/model-inference/serverless/create-manage-serverless-endpoints.html" target="_blank" style="color: inherit; text-decoration: inherit;">AWS</a></block><block>|</block><block class="role-hyper-link" data-hyper-link-url="https://learn.microsoft.com/en-us/azure/databricks/machine-learning/model-inference/serverless/create-manage-serverless-endpoints" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://learn.microsoft.com/en-us/azure/databricks/machine-learning/model-inference/serverless/create-manage-serverless-endpoints" target="_blank" style="color: inherit; text-decoration: inherit;">Azure</a></block><block>).</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>To visualize the UI for model serving or to manually create a model serving endpoint, click the Serving tab on the navbar.</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 735.197px; height: 209.28px; position: relative;"><img src="image-resources/4c78fdf9-fa32-40bd-bbe0-83b0185296e0.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">[</block><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><compositeblock dir="ltr" class="anchor-tag-ref inline" style="font-family: &quot;Computer Modern Serif&quot;, serif; background-color: rgba(155, 155, 155, 0.2);"><a href="#n0.3715415633810799" style="color: inherit; text-decoration: inherit;">Back To Top</a></compositeblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">]</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode section sindent-1" data-line-id="n0.7485476233169668" style="font-size: 1.1em; padding-top: 0.5em; padding-bottom: 0.5em; font-weight: bold; line-height: 1.4;" id="n0.7485476233169668" role="heading" aria-level="2"><prefix style="text-align: left; padding-right: 0.25em;">9.4. </prefix><blocks><baselineblock class="inline"></baselineblock><block>Compute Real-time Predictions</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>To do this, </block><block style="text-decoration: underline;">you'll first need the appropriate token and url</block><block>. </block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>The code below automatically creates the serving endpoint. </block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>You need to set up configs as well.</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item full-line-block-inside" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="code-section-symbol inline" style="display: block;"><div class="code-section theme-tomorrow-night" style="display: block; border: 1px solid lightgray; background: rgb(45, 45, 45); padding: 10px; font-size: 10px;"><editarea class="text-mode code-section-edit-area" style="font-family: &quot;Fira code&quot;, &quot;Fira Mono&quot;, monospace;"><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">model_serving_endpoint_name </block><block class="operator token">=</block><block class=" token"> </block><block class="string token">"endpoint-lab-"</block><block class=" token"> </block><block class="operator token">+</block><block class=" token"> model_name </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># As a best practice, use secret scope for tokens. But for demonstration </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># purposes we can use the token that this notebook is using.</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">token </block><block class="operator token">=</block><block class=" token"> dbutils</block><block class="punctuation token">.</block><block class=" token">notebook</block><block class="punctuation token">.</block><block class=" token">entry_point</block><block class="punctuation token">.</block><block class=" token">getDbutils</block><block class="punctuation token">(</block><block class="punctuation token">)</block><block class="punctuation token">.</block><block class=" token">notebook</block><block class="punctuation token">(</block><block class="punctuation token">)</block><block class="punctuation token">.</block><block class=" token">getContext</block><block class="punctuation token">(</block><block class="punctuation token">)</block><block class="punctuation token">.</block><block class=" token">apiToken</block><block class="punctuation token">(</block><block class="punctuation token">)</block><block class="punctuation token">.</block><block class=" token">getOrElse</block><block class="punctuation token">(</block><block class="boolean token">None</block><block class="punctuation token">)</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># With the token, we can create our authorization header for our subsequent REST calls</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">headers </block><block class="operator token">=</block><block class=" token"> </block><block class="punctuation token">{</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="string token">"Authorization"</block><block class="punctuation token">:</block><block class=" token"> </block><block class="string-interpolation string token">f"Bearer </block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">token</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">"</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="string token">"Content-Type"</block><block class="punctuation token">:</block><block class=" token"> </block><block class="string token">"application/json"</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">  </block><block class="punctuation token">}</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Similarly, we can get the domain name for this workspace from the notebook.</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">workspace_domain </block><block class="operator token">=</block><block class=" token"> sc</block><block class="punctuation token">.</block><block class=" token">getConf</block><block class="punctuation token">(</block><block class="punctuation token">)</block><block class="punctuation token">.</block><block class=" token">get</block><block class="punctuation token">(</block><block class="string token">"spark.databricks.workspaceUrl"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">api_url </block><block class="operator token">=</block><block class=" token"> </block><block class="string-interpolation string token">f"https://</block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">workspace_domain</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">/api/2.0/serving-endpoints"</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">print</block><block class="punctuation token">(</block><block class="string-interpolation string token">f"API URL: </block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">api_url</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">my_json </block><block class="operator token">=</block><block class=" token"> </block><block class="punctuation token">{</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">  </block><block class="string token">"name"</block><block class="punctuation token">:</block><block class=" token"> model_serving_endpoint_name</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">  </block><block class="string token">"config"</block><block class="punctuation token">:</block><block class=" token"> </block><block class="punctuation token">{</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">   </block><block class="string token">"served_models"</block><block class="punctuation token">:</block><block class=" token"> </block><block class="punctuation token">[</block><block class="punctuation token">{</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">     </block><block class="string token">"model_name"</block><block class="punctuation token">:</block><block class=" token"> model_name</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">     </block><block class="string token">"model_version"</block><block class="punctuation token">:</block><block class=" token"> </block><block class="string token">"1"</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">     </block><block class="string token">"workload_size"</block><block class="punctuation token">:</block><block class=" token"> </block><block class="string token">"Small"</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">     </block><block class="string token">"scale_to_zero_enabled"</block><block class="punctuation token">:</block><block class=" token"> </block><block class="boolean token">True</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">   </block><block class="punctuation token">}</block><block class="punctuation token">]</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token"> </block><block class="punctuation token">}</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="punctuation token">}</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">print</block><block class="punctuation token">(</block><block class=" token">json</block><block class="punctuation token">.</block><block class=" token">dumps</block><block class="punctuation token">(</block><block class=" token">my_json</block><block class="punctuation token">,</block><block class=" token"> indent</block><block class="operator token">=</block><block class="number token">4</block><block class="punctuation token">)</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Enable the endpoint</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">import</block><block class=" token"> requests</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">print</block><block class="punctuation token">(</block><block class="string-interpolation string token">f"Creating this new endpoint: </block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">api_url</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">/</block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">model_serving_endpoint_name</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">/invocations"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">re </block><block class="operator token">=</block><block class=" token"> requests</block><block class="punctuation token">.</block><block class=" token">post</block><block class="punctuation token">(</block><block class=" token">api_url</block><block class="punctuation token">,</block><block class=" token"> headers</block><block class="operator token">=</block><block class=" token">headers</block><block class="punctuation token">,</block><block class=" token"> json</block><block class="operator token">=</block><block class=" token">my_json</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">assert</block><block class=" token"> re</block><block class="punctuation token">.</block><block class=" token">status_code </block><block class="operator token">==</block><block class=" token"> </block><block class="number token">200</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string-interpolation string token">f"Expected an HTTP 200 response, received </block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">re</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">status_code</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">\n</block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">re</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">content</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">"</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># We can define our wait method to ensure that the resources are ready before moving forward.</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">def</block><block class=" token"> </block><block class="function token">wait_for_endpoint</block><block class="punctuation token">(</block><block class="punctuation token">)</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="keyword token">import</block><block class=" token"> time</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="keyword token">while</block><block class=" token"> </block><block class="boolean token">True</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        invocation_url </block><block class="operator token">=</block><block class=" token">  </block><block class="string-interpolation string token">f"</block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">api_url</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">/</block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">model_serving_endpoint_name</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">"</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        response </block><block class="operator token">=</block><block class=" token"> requests</block><block class="punctuation token">.</block><block class=" token">get</block><block class="punctuation token">(</block><block class=" token">invocation_url</block><block class="punctuation token">,</block><block class=" token"> headers</block><block class="operator token">=</block><block class=" token">headers</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block><block class="keyword token">assert</block><block class=" token"> response</block><block class="punctuation token">.</block><block class=" token">status_code </block><block class="operator token">==</block><block class=" token"> </block><block class="number token">200</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string-interpolation string token">f"Expected an HTTP 200 response, received </block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">response</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">status_code</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">\n</block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">response</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">text</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">"</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        status </block><block class="operator token">=</block><block class=" token"> response</block><block class="punctuation token">.</block><block class=" token">json</block><block class="punctuation token">(</block><block class="punctuation token">)</block><block class="punctuation token">.</block><block class=" token">get</block><block class="punctuation token">(</block><block class="string token">"state"</block><block class="punctuation token">,</block><block class=" token"> </block><block class="punctuation token">{</block><block class="punctuation token">}</block><block class="punctuation token">)</block><block class="punctuation token">.</block><block class=" token">get</block><block class="punctuation token">(</block><block class="string token">"ready"</block><block class="punctuation token">,</block><block class=" token"> </block><block class="punctuation token">{</block><block class="punctuation token">}</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">       </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block><block class="keyword token">if</block><block class=" token"> status </block><block class="operator token">==</block><block class=" token"> </block><block class="string token">"READY"</block><block class="punctuation token">:</block><block class=" token"> </block><block class="keyword token">print</block><block class="punctuation token">(</block><block class=" token">status</block><block class="punctuation token">)</block><block class="punctuation token">;</block><block class=" token"> </block><block class="keyword token">print</block><block class="punctuation token">(</block><block class="string token">"-"</block><block class="operator token">*</block><block class="number token">80</block><block class="punctuation token">)</block><block class="punctuation token">;</block><block class=" token"> </block><block class="keyword token">return</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block><block class="keyword token">else</block><block class="punctuation token">:</block><block class=" token"> </block><block class="keyword token">print</block><block class="punctuation token">(</block><block class="string-interpolation string token">f"Endpoint not ready (</block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">status</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">), waiting 10 seconds"</block><block class="punctuation token">)</block><block class="punctuation token">;</block><block class=" token"> time</block><block class="punctuation token">.</block><block class=" token">sleep</block><block class="punctuation token">(</block><block class="number token">10</block><block class="punctuation token">)</block><block class=" token"> </block><block class="comment token"># Wait 10 seconds</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Next, create a function that takes a single record as input and returns the predicted value from the endpoint.</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">import</block><block class=" token"> requests</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">import</block><block class=" token"> matplotlib</block><block class="punctuation token">.</block><block class=" token">pyplot </block><block class="keyword token">as</block><block class=" token"> plt</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">import</block><block class=" token"> matplotlib</block><block class="punctuation token">.</block><block class=" token">image </block><block class="keyword token">as</block><block class=" token"> mpimg</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">def</block><block class=" token"> </block><block class="function token">score_model</block><block class="punctuation token">(</block><block class=" token">dataset</block><block class="punctuation token">:</block><block class=" token"> pd</block><block class="punctuation token">.</block><block class=" token">DataFrame</block><block class="punctuation token">,</block><block class=" token"> model_serving_endpoint_name</block><block class="punctuation token">:</block><block class=" token"> </block><block class="builtin token">str</block><block class="punctuation token">,</block><block class=" token"> timeout_sec</block><block class="operator token">=</block><block class="number token">300</block><block class="punctuation token">)</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    start </block><block class="operator token">=</block><block class=" token"> </block><block class="builtin token">int</block><block class="punctuation token">(</block><block class=" token">time</block><block class="punctuation token">.</block><block class=" token">time</block><block class="punctuation token">(</block><block class="punctuation token">)</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    serving_url </block><block class="operator token">=</block><block class=" token"> </block><block class="string-interpolation string token">f"https://</block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">workspace_domain</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">/serving-endpoints/</block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">model_serving_endpoint_name</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">/invocations"</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="keyword token">print</block><block class="punctuation token">(</block><block class="string-interpolation string token">f"Scoring </block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">model_name</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token"> at </block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">serving_url</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    data_json </block><block class="operator token">=</block><block class=" token"> </block><block class="punctuation token">{</block><block class="string token">"dataframe_split"</block><block class="punctuation token">:</block><block class=" token"> dataset</block><block class="punctuation token">.</block><block class=" token">to_dict</block><block class="punctuation token">(</block><block class=" token">orient</block><block class="operator token">=</block><block class="string token">"split"</block><block class="punctuation token">)</block><block class="punctuation token">}</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="keyword token">while</block><block class=" token"> </block><block class="boolean token">True</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        response </block><block class="operator token">=</block><block class=" token"> requests</block><block class="punctuation token">.</block><block class=" token">request</block><block class="punctuation token">(</block><block class=" token">method</block><block class="operator token">=</block><block class="string token">"POST"</block><block class="punctuation token">,</block><block class=" token"> headers</block><block class="operator token">=</block><block class=" token">headers</block><block class="punctuation token">,</block><block class=" token"> url</block><block class="operator token">=</block><block class=" token">serving_url</block><block class="punctuation token">,</block><block class=" token"> json</block><block class="operator token">=</block><block class=" token">data_json</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        elapsed </block><block class="operator token">=</block><block class=" token"> </block><block class="builtin token">int</block><block class="punctuation token">(</block><block class=" token">time</block><block class="punctuation token">.</block><block class=" token">time</block><block class="punctuation token">(</block><block class="punctuation token">)</block><block class="punctuation token">)</block><block class=" token"> </block><block class="operator token">-</block><block class=" token"> start</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block><block class="keyword token">if</block><block class=" token"> response</block><block class="punctuation token">.</block><block class=" token">status_code </block><block class="operator token">==</block><block class=" token"> </block><block class="number token">200</block><block class="punctuation token">:</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">            </block><block class="keyword token">return</block><block class=" token"> response</block><block class="punctuation token">.</block><block class=" token">json</block><block class="punctuation token">(</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block><block class="keyword token">elif</block><block class=" token"> elapsed </block><block class="operator token">&gt;</block><block class=" token"> timeout_sec</block><block class="punctuation token">:</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">            </block><block class="keyword token">raise</block><block class=" token"> Exception</block><block class="punctuation token">(</block><block class="string-interpolation string token">f"Endpoint was not ready after </block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">timeout_sec</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token"> seconds"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block><block class="keyword token">elif</block><block class=" token"> response</block><block class="punctuation token">.</block><block class=" token">status_code </block><block class="keyword token">in</block><block class=" token"> </block><block class="punctuation token">[</block><block class="number token">404</block><block class="punctuation token">,</block><block class=" token"> </block><block class="number token">503</block><block class="punctuation token">]</block><block class="punctuation token">:</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">            </block><block class="keyword token">print</block><block class="punctuation token">(</block><block class="string token">"Temporarily unavailable, retry in 5"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">            time</block><block class="punctuation token">.</block><block class=" token">sleep</block><block class="punctuation token">(</block><block class="number token">5</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block><block class="keyword token">else</block><block class="punctuation token">:</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">            </block><block class="keyword token">raise</block><block class=" token"> Exception</block><block class="punctuation token">(</block><block class="string-interpolation string token">f"Request failed with status </block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">response</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">status_code</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">, </block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">response</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">text</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">wait_for_endpoint</block><block class="punctuation token">(</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Generate prediction</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">results </block><block class="operator token">=</block><block class=" token"> score_model</block><block class="punctuation token">(</block><block class=" token">data</block><block class="punctuation token">,</block><block class=" token"> model_serving_endpoint_name</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">print</block><block class="punctuation token">(</block><block class=" token">json</block><block class="punctuation token">.</block><block class=" token">dumps</block><block class="punctuation token">(</block><block class=" token">results</block><block class="punctuation token">,</block><block class=" token"> indent</block><block class="operator token">=</block><block class="number token">4</block><block class="punctuation token">)</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Delete the serving endpoint after use</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">def</block><block class=" token"> </block><block class="function token">delete_model_serving_endpoint</block><block class="punctuation token">(</block><block class=" token">model_serving_endpoint_name</block><block class="punctuation token">)</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    url </block><block class="operator token">=</block><block class=" token">  </block><block class="string-interpolation string token">f"</block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">api_url</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">/</block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">model_serving_endpoint_name</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">"</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    response </block><block class="operator token">=</block><block class=" token"> requests</block><block class="punctuation token">.</block><block class=" token">delete</block><block class="punctuation token">(</block><block class=" token">url</block><block class="punctuation token">,</block><block class=" token"> headers</block><block class="operator token">=</block><block class=" token">headers</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="keyword token">if</block><block class=" token"> response</block><block class="punctuation token">.</block><block class=" token">status_code </block><block class="operator token">!=</block><block class=" token"> </block><block class="number token">200</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block><block class="keyword token">raise</block><block class=" token"> Exception</block><block class="punctuation token">(</block><block class="string-interpolation string token">f"Request failed with status </block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">response</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">status_code</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">, </block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">response</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">text</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="keyword token">else</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block><block class="keyword token">print</block><block class="punctuation token">(</block><block class=" token">model_serving_endpoint_name</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"endpoint is deleted!"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">delete_model_serving_endpoint</block><block class="punctuation token">(</block><block class=" token">model_serving_endpoint_name</block><block class="punctuation token">)</block></blocks></line></editarea></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">[</block><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><compositeblock dir="ltr" class="anchor-tag-ref inline" style="font-family: &quot;Computer Modern Serif&quot;, serif; background-color: rgba(155, 155, 155, 0.2);"><a href="#n0.3715415633810799" style="color: inherit; text-decoration: inherit;">Back To Top</a></compositeblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">]</block></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="inline" style="display: block;"><div style="vertical-align: baseline;"><div style="display: inline-block; height: 0px; border-bottom: 1px solid; width: 100%;"></div></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode section sindent-0" data-line-id="n0.8335717214627942" style="font-size: 1.2em; padding-top: 0.5em; padding-bottom: 0.5em; font-weight: bold; line-height: 1.4;" id="n0.8335717214627942" role="heading" aria-level="1"><prefix style="text-align: left; padding-right: 0.5em;">10. </prefix><blocks><baselineblock class="inline"></baselineblock><block>Natural Language Processing</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 659.995px; height: 282.75px; position: relative;"><img src="image-resources/ea4e344b-2d48-40da-8c66-b50a1a258808.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 663.284px; height: 289.57px; position: relative;"><img src="image-resources/6d5b47d8-dbcd-438d-9cd4-ad4cd8374f93.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 665.694px; height: 353.05px; position: relative;"><img src="image-resources/caaec6f2-abe6-4a66-a8f9-ae5895d9b3a8.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div data-caption-block-id="n0.07964580511941066" class="role-image-caption-container role-caption-container" style="display: flex; align-items: center; justify-content: center; margin-top: 10px;" id="n0.07964580511941066"><span class="no-print-outline" style="outline: none; position: relative; text-align: center;"><span class="role-image-caption-prefix" style="padding-right: 0.3em; font-weight: bold;"><span class="role-image-caption-name">Figure</span><span class="role-image-caption-number"><!-- react-text: 18907 --> <!-- /react-text --><!-- react-text: 18908 -->6<!-- /react-text --></span><span>:</span></span><editarea class="image-caption text-mode" style="min-width: 50px; display: inline;"><line class="text-mode align-center" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://victorzhou.com/blog/bag-of-words/" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://victorzhou.com/blog/bag-of-words/" target="_blank" style="color: inherit; text-decoration: inherit;">A Simple Explanation of the Bag-of-Words Model</a></block></blocks></line></editarea></span></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 666.797px; height: 429.5px; position: relative;"><img src="image-resources/f30938f0-cc43-498e-bf6c-293c17c48702.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div data-caption-block-id="n0.9021598599752143" class="role-image-caption-container role-caption-container" style="display: flex; align-items: center; justify-content: center; margin-top: 10px;" id="n0.9021598599752143"><span class="no-print-outline" style="outline: none; position: relative; text-align: center;"><span class="role-image-caption-prefix" style="padding-right: 0.3em; font-weight: bold;"><span class="role-image-caption-name">Figure</span><span class="role-image-caption-number"><!-- react-text: 18942 --> <!-- /react-text --><!-- react-text: 18943 -->7<!-- /react-text --></span><span>:</span></span><editarea class="image-caption text-mode" style="min-width: 50px; display: inline;"><line class="text-mode align-center" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://medium.com/@hari4om/word-embedding-d816f643140" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://medium.com/@hari4om/word-embedding-d816f643140" target="_blank" style="color: inherit; text-decoration: inherit;">Word Embeddings: Basics. Create a vector from a word</a></block></blocks></line></editarea></span></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">[</block><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><compositeblock dir="ltr" class="anchor-tag-ref inline" style="font-family: &quot;Computer Modern Serif&quot;, serif; background-color: rgba(155, 155, 155, 0.2);"><a href="#n0.3715415633810799" style="color: inherit; text-decoration: inherit;">Back To Top</a></compositeblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">]</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 667.387px; height: 354.29px; position: relative;"><img src="image-resources/9b438c7a-51dd-4858-8f05-449ca6cae5f7.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 665.995px; height: 308.3px; position: relative;"><img src="image-resources/f387a4d8-fec2-49a2-890c-472cc144e3fb.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 667.992px; height: 175.23px; position: relative;"><img src="image-resources/c3113713-5a60-4414-8249-4180f081773d.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 670.397px; height: 177.09px; position: relative;"><img src="image-resources/85ba3824-dabb-46c4-94c2-28c01c5ec9a5.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 669.191px; height: 350px; position: relative;"><img src="image-resources/803e7397-d883-43cb-bc39-ee60728be0ea.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div data-caption-block-id="n0.19811111674894022" class="role-image-caption-container role-caption-container" style="display: flex; align-items: center; justify-content: center; margin-top: 10px;" id="n0.19811111674894022"><span class="no-print-outline" style="outline: none; position: relative; text-align: center;"><span class="role-image-caption-prefix" style="padding-right: 0.3em; font-weight: bold;"><span class="role-image-caption-name">Figure</span><span class="role-image-caption-number"><!-- react-text: 19045 --> <!-- /react-text --><!-- react-text: 19046 -->8<!-- /react-text --></span><span>:</span></span><editarea class="image-caption text-mode" style="min-width: 50px; display: inline;"><line class="text-mode align-center" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://towardsdatascience.com/light-on-math-ml-intuitive-guide-to-understanding-glove-embeddings-b13b4f19c010" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://towardsdatascience.com/light-on-math-ml-intuitive-guide-to-understanding-glove-embeddings-b13b4f19c010" target="_blank" style="color: inherit; text-decoration: inherit;">Intuitive Guide to Understanding GloVe Embeddings</a></block></blocks></line></editarea></span></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 661.791px; height: 329.99px; position: relative;"><img src="image-resources/d9f81bc1-5cd5-4b08-84ea-9ad120265077.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 666px; height: 185.7px; position: relative;"><img src="image-resources/468d800b-e20a-4aea-94b2-9db32c3cea36.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 662.791px; height: 348.38px; position: relative;"><img src="image-resources/72627818-68f0-4c8d-a86b-54f284dfb45e.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div data-caption-block-id="n0.3436601915551407" class="role-image-caption-container role-caption-container" style="display: flex; align-items: center; justify-content: center; margin-top: 10px;" id="n0.3436601915551407"><span class="no-print-outline" style="outline: none; position: relative; text-align: center;"><span class="role-image-caption-prefix" style="padding-right: 0.3em; font-weight: bold;"><span class="role-image-caption-name">Figure</span><span class="role-image-caption-number"><!-- react-text: 19114 --> <!-- /react-text --><!-- react-text: 19115 -->9<!-- /react-text --></span><span>:</span></span><editarea class="image-caption text-mode" style="min-width: 50px; display: inline;"><line class="text-mode align-center" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://towardsdatascience.com/the-three-main-branches-of-word-embeddings-7b90fa36dfb9" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://towardsdatascience.com/the-three-main-branches-of-word-embeddings-7b90fa36dfb9" target="_blank" style="color: inherit; text-decoration: inherit;">Source</a></block></blocks></line></editarea></span></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">[</block><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><compositeblock dir="ltr" class="anchor-tag-ref inline" style="font-family: &quot;Computer Modern Serif&quot;, serif; background-color: rgba(155, 155, 155, 0.2);"><a href="#n0.3715415633810799" style="color: inherit; text-decoration: inherit;">Back To Top</a></compositeblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">]</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 664.791px; height: 231.18px; position: relative;"><img src="image-resources/7eef6c11-7920-4779-96a9-99df60414160.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 666.192px; height: 200.32px; position: relative;"><img src="image-resources/5e0f8f1f-742a-4daf-90cc-64979ab3b068.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 668.491px; height: 335.14px; position: relative;"><img src="image-resources/8c536b2b-4c1d-4af0-9c8e-9b366d1c3b57.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 666.884px; height: 345.12px; position: relative;"><img src="image-resources/d1f41cc8-77b1-44ae-a10b-a654dec8164a.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 669.989px; height: 304.86px; position: relative;"><img src="image-resources/d4d971a7-a0d5-4895-87c0-4355c8b34bfc.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div data-caption-block-id="n0.1732913669794911" class="role-image-caption-container role-caption-container" style="display: flex; align-items: center; justify-content: center; margin-top: 10px;" id="n0.1732913669794911"><span class="no-print-outline" style="outline: none; position: relative; text-align: center;"><span class="role-image-caption-prefix" style="padding-right: 0.3em; font-weight: bold;"><span class="role-image-caption-name">Figure</span><span class="role-image-caption-number"><!-- react-text: 19217 --> <!-- /react-text --><!-- react-text: 19218 -->10<!-- /react-text --></span><span>:</span></span><editarea class="image-caption text-mode" style="min-width: 50px; display: inline;"><line class="text-mode align-center" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://app.inferkit.com/demo" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://app.inferkit.com/demo" target="_blank" style="color: inherit; text-decoration: inherit;">Example1</a></block><block>, </block><block class="role-hyper-link" data-hyper-link-url="https://twitter.com/sharifshameem/status/1284095222939451393" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://twitter.com/sharifshameem/status/1284095222939451393" target="_blank" style="color: inherit; text-decoration: inherit;">Example2</a></block><block>, </block><block class="role-hyper-link" data-hyper-link-url="https://arxiv.org/pdf/1411.4555.pdf" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://arxiv.org/pdf/1411.4555.pdf" target="_blank" style="color: inherit; text-decoration: inherit;">A Neural Image Caption Generator</a></block></blocks></line></editarea></span></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 670.395px; height: 361.86px; position: relative;"><img src="image-resources/309c04a2-4e1f-45ec-b3cb-b210076208b6.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 665.991px; height: 322.07px; position: relative;"><img src="image-resources/6ed3e11f-90b4-4e03-a7b4-3e75af894769.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div data-caption-block-id="n0.6167842977118807" class="role-image-caption-container role-caption-container" style="display: flex; align-items: center; justify-content: center; margin-top: 10px;" id="n0.6167842977118807"><span class="no-print-outline" style="outline: none; position: relative; text-align: center;"><span class="role-image-caption-prefix" style="padding-right: 0.3em; font-weight: bold;"><span class="role-image-caption-name">Figure</span><span class="role-image-caption-number"><!-- react-text: 19273 --> <!-- /react-text --><!-- react-text: 19274 -->11<!-- /react-text --></span><span>:</span></span><editarea class="image-caption text-mode" style="min-width: 50px; display: inline;"><line class="text-mode align-center" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://purnasaigudikandula.medium.com/recurrent-neural-networks-and-lstm-explained-7f51c7f6bbb9" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://purnasaigudikandula.medium.com/recurrent-neural-networks-and-lstm-explained-7f51c7f6bbb9" target="_blank" style="color: inherit; text-decoration: inherit;">Recurrent Neural Networks and LSTM explained</a></block></blocks></line></editarea></span></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 654.391px; height: 369.87px; position: relative;"><img src="image-resources/b99a8d88-1ecb-460e-ba71-bd50812a3736.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div data-caption-block-id="n0.4223154094240651" class="role-image-caption-container role-caption-container" style="display: flex; align-items: center; justify-content: center; margin-top: 10px;" id="n0.4223154094240651"><span class="no-print-outline" style="outline: none; position: relative; text-align: center;"><span class="role-image-caption-prefix" style="padding-right: 0.3em; font-weight: bold;"><span class="role-image-caption-name">Figure</span><span class="role-image-caption-number"><!-- react-text: 19308 --> <!-- /react-text --><!-- react-text: 19309 -->12<!-- /react-text --></span><span>:</span></span><editarea class="image-caption text-mode" style="min-width: 50px; display: inline;"><line class="text-mode align-center" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://web.stanford.edu/class/cs224n/slides/cs224n-2021-lecture05-rnnlm.pdf" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://web.stanford.edu/class/cs224n/slides/cs224n-2021-lecture05-rnnlm.pdf" target="_blank" style="color: inherit; text-decoration: inherit;">CS224n - 2021 Lectures - Stanford</a></block></blocks></line></editarea></span></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">[</block><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><compositeblock dir="ltr" class="anchor-tag-ref inline" style="font-family: &quot;Computer Modern Serif&quot;, serif; background-color: rgba(155, 155, 155, 0.2);"><a href="#n0.3715415633810799" style="color: inherit; text-decoration: inherit;">Back To Top</a></compositeblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">]</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 655.194px; height: 315.98px; position: relative;"><img src="image-resources/c29e0cc9-0be5-4f10-b360-6e989367a2f6.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 655.309px; height: 348.51px; position: relative;"><img src="image-resources/09c895c4-28a4-4371-a9c5-0b3f393da46e.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 656.689px; height: 146.63px; position: relative;"><img src="image-resources/fb274a6d-dbc1-4e87-bde6-238650dbbb09.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 657.787px; height: 230.19px; position: relative;"><img src="image-resources/dc38ff8c-6206-447d-a7d9-cee9f61b20a9.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 659.195px; height: 338.98px; position: relative;"><img src="image-resources/95d45d89-531c-4dc9-9801-4d8719beab38.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 660.392px; height: 145.1px; position: relative;"><img src="image-resources/c6b6f6f3-6a13-4e62-b775-eabbb62475f8.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 656.984px; height: 310.74px; position: relative;"><img src="image-resources/d2512f43-d583-4c6b-95fc-a7e6b8143c2a.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 659.886px; height: 234.52px; position: relative;"><img src="image-resources/f926d049-407d-4148-92c7-eac7ed911a0a.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div data-caption-block-id="n0.08201658782863586" class="role-image-caption-container role-caption-container" style="display: flex; align-items: center; justify-content: center; margin-top: 10px;" id="n0.08201658782863586"><span class="no-print-outline" style="outline: none; position: relative; text-align: center;"><span class="role-image-caption-prefix" style="padding-right: 0.3em; font-weight: bold;"><span class="role-image-caption-name">Figure</span><span class="role-image-caption-number"><!-- react-text: 19467 --> <!-- /react-text --><!-- react-text: 19468 -->13<!-- /react-text --></span><span>:</span></span><editarea class="image-caption text-mode" style="min-width: 50px; display: inline;"><line class="text-mode align-center" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="http://colah.github.io/posts/2015-08-Understanding-LSTMs/" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="http://colah.github.io/posts/2015-08-Understanding-LSTMs/" target="_blank" style="color: inherit; text-decoration: inherit;">Understanding LSTMs</a></block></blocks></line></editarea></span></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 648.597px; height: 317.84px; position: relative;"><img src="image-resources/9c08e3be-f63e-4dab-9d37-4a3e21d2b098.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div data-caption-block-id="n0.7966916701978783" class="role-image-caption-container role-caption-container" style="display: flex; align-items: center; justify-content: center; margin-top: 10px;" id="n0.7966916701978783"><span class="no-print-outline" style="outline: none; position: relative; text-align: center;"><span class="role-image-caption-prefix" style="padding-right: 0.3em; font-weight: bold;"><span class="role-image-caption-name">Figure</span><span class="role-image-caption-number"><!-- react-text: 19502 --> <!-- /react-text --><!-- react-text: 19503 -->14<!-- /react-text --></span><span>:</span></span><editarea class="image-caption text-mode" style="min-width: 50px; display: inline;"><line class="text-mode align-center" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://web.stanford.edu/class/cs224n/slides/cs224n-2021-lecture06-fancy-rnn.pdf" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://web.stanford.edu/class/cs224n/slides/cs224n-2021-lecture06-fancy-rnn.pdf" target="_blank" style="color: inherit; text-decoration: inherit;">CS224n - 2021 Lectures - Stanford</a></block></blocks></line></editarea></span></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">[</block><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><compositeblock dir="ltr" class="anchor-tag-ref inline" style="font-family: &quot;Computer Modern Serif&quot;, serif; background-color: rgba(155, 155, 155, 0.2);"><a href="#n0.3715415633810799" style="color: inherit; text-decoration: inherit;">Back To Top</a></compositeblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">]</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 653.2px; height: 341.79px; position: relative;"><img src="image-resources/24c507e2-19c5-4e25-9151-5d4ca0bbe155.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 649.594px; height: 360.21px; position: relative;"><img src="image-resources/906bb928-3718-48e9-acb4-102ed4c72fda.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div data-caption-block-id="n0.8910707860209031" class="role-image-caption-container role-caption-container" style="display: flex; align-items: center; justify-content: center; margin-top: 10px;" id="n0.8910707860209031"><span class="no-print-outline" style="outline: none; position: relative; text-align: center;"><span class="role-image-caption-prefix" style="padding-right: 0.3em; font-weight: bold;"><span class="role-image-caption-name">Figure</span><span class="role-image-caption-number"><!-- react-text: 19554 --> <!-- /react-text --><!-- react-text: 19555 -->15<!-- /react-text --></span><span>:</span></span><editarea class="image-caption text-mode" style="min-width: 50px; display: inline;"><line class="text-mode align-center" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://arxiv.org/pdf/1706.03762.pdf" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://arxiv.org/pdf/1706.03762.pdf" target="_blank" style="color: inherit; text-decoration: inherit;">Attention is All You Need</a></block></blocks></line></editarea></span></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 649.192px; height: 329.83px; position: relative;"><img src="image-resources/fffaf286-6dd3-4e46-9aee-a9d29cdeed9a.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div data-caption-block-id="n0.08046980803138637" class="role-image-caption-container role-caption-container" style="display: flex; align-items: center; justify-content: center; margin-top: 10px;" id="n0.08046980803138637"><span class="no-print-outline" style="outline: none; position: relative; text-align: center;"><span class="role-image-caption-prefix" style="padding-right: 0.3em; font-weight: bold;"><span class="role-image-caption-name">Figure</span><span class="role-image-caption-number"><!-- react-text: 19589 --> <!-- /react-text --><!-- react-text: 19590 -->16<!-- /react-text --></span><span>:</span></span><editarea class="image-caption text-mode" style="min-width: 50px; display: inline;"><line class="text-mode align-center" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://web.stanford.edu/class/archive/cs/cs224n/cs224n.1204/slides/cs224n-2020-lecture08-nmt.pdf" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://web.stanford.edu/class/archive/cs/cs224n/cs224n.1204/slides/cs224n-2020-lecture08-nmt.pdf" target="_blank" style="color: inherit; text-decoration: inherit;">CS224n - 2021 Lectures - Stanford</a></block></blocks></line></editarea></span></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 640px; height: 366.98px; position: relative;"><img src="image-resources/ca41d9b6-4662-459d-a2c4-1aef44bb7a10.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 643.192px; height: 403.69px; position: relative;"><img src="image-resources/f4c866b2-c2fe-452b-b03f-f1c56211a87b.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 640.992px; height: 415.95px; position: relative;"><img src="image-resources/3e9ca834-ceae-429e-aa2d-f1635cfdf908.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 647.192px; height: 416.65px; position: relative;"><img src="image-resources/e88f0da1-d231-44c2-bf5d-8d60c0e2921b.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 642.584px; height: 276.75px; position: relative;"><img src="image-resources/92f171af-436c-4757-aec7-4926ab877a9c.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 642.692px; height: 138.9px; position: relative;"><img src="image-resources/a71e0e09-1481-458f-8978-00d911e0950e.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 647.392px; height: 154.99px; position: relative;"><img src="image-resources/225fbb4a-61db-48c9-bbb6-7748e2257ed6.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 644px; height: 358.97px; position: relative;"><img src="image-resources/8096866d-2234-493d-8c08-4a73b8fd458b.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div data-caption-block-id="n0.9834521874673126" class="role-image-caption-container role-caption-container" style="display: flex; align-items: center; justify-content: center; margin-top: 10px;" id="n0.9834521874673126"><span class="no-print-outline" style="outline: none; position: relative; text-align: center;"><span class="role-image-caption-prefix" style="padding-right: 0.3em; font-weight: bold;"><span class="role-image-caption-name">Figure</span><span class="role-image-caption-number"><!-- react-text: 19743 --> <!-- /react-text --><!-- react-text: 19744 -->17<!-- /react-text --></span><span>:</span></span><editarea class="image-caption text-mode" style="min-width: 50px; display: inline;"><line class="text-mode align-center" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://web.stanford.edu/class/archive/cs/cs224n/cs224n.1204/slides/Jacob_Devlin_BERT.pdf" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://web.stanford.edu/class/archive/cs/cs224n/cs224n.1204/slides/Jacob_Devlin_BERT.pdf" target="_blank" style="color: inherit; text-decoration: inherit;">Source</a></block></blocks></line></editarea></span></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 647.197px; height: 209.19px; position: relative;"><img src="image-resources/2974999c-d962-4637-8562-ead24aeadeb1.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 644.394px; height: 305.61px; position: relative;"><img src="image-resources/d21f2bc0-e7fe-48b9-a02d-7c3675e916fb.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div data-caption-block-id="n0.11097165958089805" class="role-image-caption-container role-caption-container" style="display: flex; align-items: center; justify-content: center; margin-top: 10px;" id="n0.11097165958089805"><span class="no-print-outline" style="outline: none; position: relative; text-align: center;"><span class="role-image-caption-prefix" style="padding-right: 0.3em; font-weight: bold;"><span class="role-image-caption-name">Figure</span><span class="role-image-caption-number"><!-- react-text: 19795 --> <!-- /react-text --><!-- react-text: 19796 -->18<!-- /react-text --></span><span>:</span></span><editarea class="image-caption text-mode" style="min-width: 50px; display: inline;"><line class="text-mode align-center" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://aclanthology.org/N19-1423.pdf" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://aclanthology.org/N19-1423.pdf" target="_blank" style="color: inherit; text-decoration: inherit;">BERT</a></block></blocks></line></editarea></span></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 637.992px; height: 327.88px; position: relative;"><img src="image-resources/9d872ba3-ab37-4553-b68f-88b154acedbd.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div data-caption-block-id="n0.7738720237631473" class="role-image-caption-container role-caption-container" style="display: flex; align-items: center; justify-content: center; margin-top: 10px;" id="n0.7738720237631473"><span class="no-print-outline" style="outline: none; position: relative; text-align: center;"><span class="role-image-caption-prefix" style="padding-right: 0.3em; font-weight: bold;"><span class="role-image-caption-name">Figure</span><span class="role-image-caption-number"><!-- react-text: 19830 --> <!-- /react-text --><!-- react-text: 19831 -->19<!-- /react-text --></span><span>:</span></span><editarea class="image-caption text-mode" style="min-width: 50px; display: inline;"><line class="text-mode align-center" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://github.com/thunlp/PLMpapers" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://github.com/thunlp/PLMpapers" target="_blank" style="color: inherit; text-decoration: inherit;">Source</a></block></blocks></line></editarea></span></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">[</block><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><compositeblock dir="ltr" class="anchor-tag-ref inline" style="font-family: &quot;Computer Modern Serif&quot;, serif; background-color: rgba(155, 155, 155, 0.2);"><a href="#n0.3715415633810799" style="color: inherit; text-decoration: inherit;">Back To Top</a></compositeblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">]</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode align-center indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="font-size: 1.73em; font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-size: 1.73em; font-weight: bold;">Transfer Learning for NLP</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 640.886px; height: 318.14px; position: relative;"><img src="image-resources/ce84d479-17a5-48ca-bed2-7abee9323634.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 642.091px; height: 349.9px; position: relative;"><img src="image-resources/af60f888-6841-490e-859b-7f7cc5c50330.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div data-caption-block-id="n0.9451903867968534" class="role-image-caption-container role-caption-container" style="display: flex; align-items: center; justify-content: center; margin-top: 10px;" id="n0.9451903867968534"><span class="no-print-outline" style="outline: none; position: relative; text-align: center;"><span class="role-image-caption-prefix" style="padding-right: 0.3em; font-weight: bold;"><span class="role-image-caption-name">Figure</span><span class="role-image-caption-number"><!-- react-text: 19902 --> <!-- /react-text --><!-- react-text: 19903 -->20<!-- /react-text --></span><span>:</span></span><editarea class="image-caption text-mode" style="min-width: 50px; display: inline;"><line class="text-mode align-center" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://web.stanford.edu/class/archive/cs/cs224n/cs224n.1204/slides/cs224n-2020-lecture11-convnets.pdf" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://web.stanford.edu/class/archive/cs/cs224n/cs224n.1204/slides/cs224n-2020-lecture11-convnets.pdf" target="_blank" style="color: inherit; text-decoration: inherit;">Source</a></block></blocks></line></editarea></span></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 639.395px; height: 190.61px; position: relative;"><img src="image-resources/ed719617-b6a3-4024-acf2-a17330a293fd.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 636.389px; height: 172.19px; position: relative;"><img src="image-resources/cbf6705b-e913-44ab-9982-fb4ec6d4bacc.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode align-center indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="font-size: 1.73em; font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode align-center indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="font-size: 1.73em; font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-size: 1.73em; font-weight: bold;">Imapct of Deep Learning</block></blocks></line><line class="root text-mode align-center" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 619.595px; height: 321.49px; position: relative;"><img src="image-resources/217fd273-ba02-473d-aacd-2b90a3975a5b.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 621.594px; height: 202.85px; position: relative;"><img src="image-resources/8be83f6f-0c83-4a40-9e38-3f06bee5e438.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div data-caption-block-id="n0.7482591506512322" class="role-image-caption-container role-caption-container" style="display: flex; align-items: center; justify-content: center; margin-top: 10px;" id="n0.7482591506512322"><span class="no-print-outline" style="outline: none; position: relative; text-align: center;"><span class="role-image-caption-prefix" style="padding-right: 0.3em; font-weight: bold;"><span class="role-image-caption-name">Figure</span><span class="role-image-caption-number"><!-- react-text: 20008 --> <!-- /react-text --><!-- react-text: 20009 -->21<!-- /react-text --></span><span>:</span></span><editarea class="image-caption text-mode" style="min-width: 50px; display: inline;"><line class="text-mode align-center" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://dl.acm.org/doi/10.1145/3442188.3445922" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://dl.acm.org/doi/10.1145/3442188.3445922" target="_blank" style="color: inherit; text-decoration: inherit;">Source</a></block></blocks></line></editarea></span></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">[</block><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><compositeblock dir="ltr" class="anchor-tag-ref inline" style="font-family: &quot;Computer Modern Serif&quot;, serif; background-color: rgba(155, 155, 155, 0.2);"><a href="#n0.3715415633810799" style="color: inherit; text-decoration: inherit;">Back To Top</a></compositeblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">]</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode align-center" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-size: 1.73em; font-weight: bold;">CNN for NLP</block></blocks></line><line class="root text-mode align-center" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 615.595px; height: 294.44px; position: relative;"><img src="image-resources/0faf0323-8ba0-4279-9080-1c77f3ab7191.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div data-caption-block-id="n0.5437509541019745" class="role-image-caption-container role-caption-container" style="display: flex; align-items: center; justify-content: center; margin-top: 10px;" id="n0.5437509541019745"><span class="no-print-outline" style="outline: none; position: relative; text-align: center;"><span class="role-image-caption-prefix" style="padding-right: 0.3em; font-weight: bold;"><span class="role-image-caption-name">Figure</span><span class="role-image-caption-number"><!-- react-text: 20058 --> <!-- /react-text --><!-- react-text: 20059 -->22<!-- /react-text --></span><span>:</span></span><editarea class="image-caption text-mode" style="min-width: 50px; display: inline;"><line class="text-mode align-center" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://cs224d.stanford.edu/lectures/CS224d-Lecture13.pdf" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://cs224d.stanford.edu/lectures/CS224d-Lecture13.pdf" target="_blank" style="color: inherit; text-decoration: inherit;">Source</a></block></blocks></line></editarea></span></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 609.389px; height: 220.88px; position: relative;"><img src="image-resources/37e55419-0a70-4d1a-b612-66fb5a9be647.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div data-caption-block-id="n0.4795160587244083" class="role-image-caption-container role-caption-container" style="display: flex; align-items: center; justify-content: center; margin-top: 10px;" id="n0.4795160587244083"><span class="no-print-outline" style="outline: none; position: relative; text-align: center;"><span class="role-image-caption-prefix" style="padding-right: 0.3em; font-weight: bold;"><span class="role-image-caption-name">Figure</span><span class="role-image-caption-number"><!-- react-text: 20093 --> <!-- /react-text --><!-- react-text: 20094 -->23<!-- /react-text --></span><span>:</span></span><editarea class="image-caption text-mode" style="min-width: 50px; display: inline;"><line class="text-mode align-center" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://lena-voita.github.io/nlp_course/models/convolutional.html" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://lena-voita.github.io/nlp_course/models/convolutional.html" target="_blank" style="color: inherit; text-decoration: inherit;">Interactive CNN for NLP Visualization</a></block></blocks></line></editarea></span></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 607.387px; height: 297.13px; position: relative;"><img src="image-resources/95457e4d-4c7d-4cf8-9c98-b0b47ffce364.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 609.591px; height: 164.56px; position: relative;"><img src="image-resources/cefc812d-78e3-4c29-b925-c32bc2bd469e.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div data-caption-block-id="n0.9610032247483788" class="role-image-caption-container role-caption-container" style="display: flex; align-items: center; justify-content: center; margin-top: 10px;" id="n0.9610032247483788"><span class="no-print-outline" style="outline: none; position: relative; text-align: center;"><span class="role-image-caption-prefix" style="padding-right: 0.3em; font-weight: bold;"><span class="role-image-caption-name">Figure</span><span class="role-image-caption-number"><!-- react-text: 20150 --> <!-- /react-text --><!-- react-text: 20151 -->24<!-- /react-text --></span><span>:</span></span><editarea class="image-caption text-mode" style="min-width: 50px; display: inline;"><line class="text-mode align-center" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block>Source: NLP in Action by Lane, et al</block></blocks></line></editarea></span></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="color: rgb(255, 64, 0); font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold; color: rgb(255, 64, 0);">CNN Applications in NLP</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Translation: CNN for encoding and RNN for decoding</block></blocks></line><line class="root text-mode indent-2 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="3"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;">* </prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://aclanthology.org/D13-1176.pdf" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://aclanthology.org/D13-1176.pdf" target="_blank" style="color: inherit; text-decoration: inherit;">Kalchbrenner and Blunsom 2013</a></block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Classification</block></blocks></line><line class="root text-mode indent-2 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="3"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;">* </prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://aclanthology.org/D14-1181.pdf" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://aclanthology.org/D14-1181.pdf" target="_blank" style="color: inherit; text-decoration: inherit;">Kim 2014</a></block></blocks></line><line class="root text-mode indent-2 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="3"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;">* </prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://arxiv.org/pdf/1404.2188.pdf" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://arxiv.org/pdf/1404.2188.pdf" target="_blank" style="color: inherit; text-decoration: inherit;">Kalchbrenner et al. 2014</a></block></blocks></line><line class="root text-mode indent-2 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="3"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;">* </prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://aclanthology.org/E17-1104.pdf" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://aclanthology.org/E17-1104.pdf" target="_blank" style="color: inherit; text-decoration: inherit;">Conneau et al. 2017</a></block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">[</block><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><compositeblock dir="ltr" class="anchor-tag-ref inline" style="font-family: &quot;Computer Modern Serif&quot;, serif; background-color: rgba(155, 155, 155, 0.2);"><a href="#n0.3715415633810799" style="color: inherit; text-decoration: inherit;">Back To Top</a></compositeblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">]</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode align-center" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-size: 1.73em; font-weight: bold;">Attention</block></blocks></line><line class="root text-mode align-center" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 625px; height: 258.97px; position: relative;"><img src="image-resources/dff913a3-a610-442f-be00-fa22f5391ff7.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div data-caption-block-id="n0.5105314213227754" class="role-image-caption-container role-caption-container" style="display: flex; align-items: center; justify-content: center; margin-top: 10px;" id="n0.5105314213227754"><span class="no-print-outline" style="outline: none; position: relative; text-align: center;"><span class="role-image-caption-prefix" style="padding-right: 0.3em; font-weight: bold;"><span class="role-image-caption-name">Figure</span><span class="role-image-caption-number"><!-- react-text: 20235 --> <!-- /react-text --><!-- react-text: 20236 -->25<!-- /react-text --></span><span>:</span></span><editarea class="image-caption text-mode" style="min-width: 50px; display: inline;"><line class="text-mode align-center" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://web.stanford.edu/class/archive/cs/cs224n/cs224n.1204/slides/cs224n-2020-lecture08-nmt.pdf" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://web.stanford.edu/class/archive/cs/cs224n/cs224n.1204/slides/cs224n-2020-lecture08-nmt.pdf" target="_blank" style="color: inherit; text-decoration: inherit;">Source</a></block></blocks></line></editarea></span></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 618.75px; height: 196.38px; position: relative;"><img src="image-resources/b5ac46ad-b471-486f-b7e7-9e0bb4f7eb47.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 619px; height: 313.28px; position: relative;"><img src="image-resources/afb0e2e1-b562-457a-ab8d-c4a1cb416b37.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">[</block><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><compositeblock dir="ltr" class="anchor-tag-ref inline" style="font-family: &quot;Computer Modern Serif&quot;, serif; background-color: rgba(155, 155, 155, 0.2);"><a href="#n0.3715415633810799" style="color: inherit; text-decoration: inherit;">Back To Top</a></compositeblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">]</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode align-center" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-size: 1.73em; font-weight: bold;">Evolution Post-BERT</block></blocks></line><line class="root text-mode align-center" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 613px; height: 267.26px; position: relative;"><img src="image-resources/fe1f040b-0883-49ee-8d41-3eaaab8abce0.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 616.75px; height: 161.88px; position: relative;"><img src="image-resources/eb4def5e-412d-43d9-a843-93995468fef3.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 616px; height: 205.15px; position: relative;"><img src="image-resources/84f6bf50-bd31-4b05-ab96-c10a38bb395f.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 616.5px; height: 230.38px; position: relative;"><img src="image-resources/debc3f41-b07a-4cc7-b2c0-8c0bf3873f80.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 612.25px; height: 326.86px; position: relative;"><img src="image-resources/4b8add08-9185-43a7-81c5-543786a80ffd.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div data-caption-block-id="n0.852275179315034" class="role-image-caption-container role-caption-container" style="display: flex; align-items: center; justify-content: center; margin-top: 10px;" id="n0.852275179315034"><span class="no-print-outline" style="outline: none; position: relative; text-align: center;"><span class="role-image-caption-prefix" style="padding-right: 0.3em; font-weight: bold;"><span class="role-image-caption-name">Figure</span><span class="role-image-caption-number"><!-- react-text: 20392 --> <!-- /react-text --><!-- react-text: 20393 -->26<!-- /react-text --></span><span>:</span></span><editarea class="image-caption text-mode" style="min-width: 50px; display: inline;"><line class="text-mode align-center" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://blog.research.google/2020/02/exploring-transfer-learning-with-t5.html" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://blog.research.google/2020/02/exploring-transfer-learning-with-t5.html" target="_blank" style="color: inherit; text-decoration: inherit;">Source</a></block></blocks></line></editarea></span></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 605.592px; height: 241.14px; position: relative;"><img src="image-resources/946b093b-00aa-42a7-acdc-0b27baf20eba.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div data-caption-block-id="n0.8529178530919319" class="role-image-caption-container role-caption-container" style="display: flex; align-items: center; justify-content: center; margin-top: 10px;" id="n0.8529178530919319"><span class="no-print-outline" style="outline: none; position: relative; text-align: center;"><span class="role-image-caption-prefix" style="padding-right: 0.3em; font-weight: bold;"><span class="role-image-caption-name">Figure</span><span class="role-image-caption-number"><!-- react-text: 20427 --> <!-- /react-text --><!-- react-text: 20428 -->27<!-- /react-text --></span><span>:</span></span><editarea class="image-caption text-mode" style="min-width: 50px; display: inline;"><line class="text-mode align-center" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://arxiv.org/pdf/1910.10683.pdf" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://arxiv.org/pdf/1910.10683.pdf" target="_blank" style="color: inherit; text-decoration: inherit;">T5 paper</a></block></blocks></line></editarea></span></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">[</block><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><compositeblock dir="ltr" class="anchor-tag-ref inline" style="font-family: &quot;Computer Modern Serif&quot;, serif; background-color: rgba(155, 155, 155, 0.2);"><a href="#n0.3715415633810799" style="color: inherit; text-decoration: inherit;">Back To Top</a></compositeblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">]</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode align-center" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-size: 1.73em; font-weight: bold;">Smaller, Cheaper Models</block></blocks></line><line class="root text-mode align-center" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="color: rgb(255, 64, 0); font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold; color: rgb(255, 64, 0);">How to make models cheaper and smaller?</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold;">Distillation = model comparison</block></blocks></line><line class="root text-mode indent-2 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="3"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;">* </prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://www.cs.cornell.edu/~caruana/compression.kdd06.pdf" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://www.cs.cornell.edu/~caruana/compression.kdd06.pdf" target="_blank" style="color: inherit; text-decoration: inherit;">Bucila et al. 2006 </a></block></blocks></line><line class="root text-mode indent-2 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="3"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;">* </prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://arxiv.org/abs/1503.02531" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://arxiv.org/abs/1503.02531" target="_blank" style="color: inherit; text-decoration: inherit;">Hinton et al.,2015 </a></block></blocks></line><line class="root text-mode indent-2 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="3"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;">* </prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://arxiv.org/abs/1910.01108v3" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://arxiv.org/abs/1910.01108v3" target="_blank" style="color: inherit; text-decoration: inherit;">Sanh et al., 2019</a></block><block>  </block><block style="font-weight: bold; background-color: rgb(255, 254, 0);">DistilBERT</block><block> </block></blocks></line><line class="root text-mode indent-2 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="3"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;">* </prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://arxiv.org/abs/1909.10351v5" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://arxiv.org/abs/1909.10351v5" target="_blank" style="color: inherit; text-decoration: inherit;">Jiao et al., 2019</a></block><block>  </block><block style="font-weight: bold; background-color: rgb(255, 254, 0);">TinyBERT</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold;">Parameter sharing</block></blocks></line><line class="root text-mode indent-2 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="3"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;">* </prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://openreview.net/pdf?id=H1eA7AEtvS" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://openreview.net/pdf?id=H1eA7AEtvS" target="_blank" style="color: inherit; text-decoration: inherit;">Lan et al., 2019</a></block><block>  </block><block style="font-weight: bold; background-color: rgb(255, 254, 0);">ALBERT</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold;">Conditional computation</block></blocks></line><line class="root text-mode indent-2 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="3"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;">* </prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://arxiv.org/pdf/1701.06538v1.pdf" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://arxiv.org/pdf/1701.06538v1.pdf" target="_blank" style="color: inherit; text-decoration: inherit;">Shazeer et al., 2017</a></block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 632.784px; height: 273.03px; position: relative;"><img src="image-resources/c53112e6-598f-4d0e-b3de-6e67f05d5129.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div data-caption-block-id="n0.6671271642897154" class="role-image-caption-container role-caption-container" style="display: flex; align-items: center; justify-content: center; margin-top: 10px;" id="n0.6671271642897154"><span class="no-print-outline" style="outline: none; position: relative; text-align: center;"><span class="role-image-caption-prefix" style="padding-right: 0.3em; font-weight: bold;"><span class="role-image-caption-name">Figure</span><span class="role-image-caption-number"><!-- react-text: 20544 --> <!-- /react-text --><!-- react-text: 20545 -->28<!-- /react-text --></span><span>:</span></span><editarea class="image-caption text-mode" style="min-width: 50px; display: inline;"><line class="text-mode align-center" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://medium.com/huggingface/distilbert-8cf3380435b5#id_token=eyJhbGciOiJSUzI1NiIsImtpZCI6ImQ5OGY0OWJjNmNhNDU4MWVhZThkZmFkZDQ5NGZjZTEwZWEyM2FhYjAiLCJ0eXAiOiJKV1QifQ.eyJpc3MiOiJodHRwczovL2FjY291bnRzLmdvb2dsZS5jb20iLCJuYmYiOjE2NDAxMTc0NzUsImF1ZCI6IjIxNjI5NjAzNTgzNC1rMWs2cWUwNjBzMnRwMmEyamFtNGxqZGNtczAwc3R0Zy5hcHBzLmdvb2dsZXVzZXJjb250ZW50LmNvbSIsInN1YiI6IjExNjM2Nzg3OTEyNTgyOTgzNDQ1NiIsImhkIjoiZGF0YWJyaWNrcy5jb20iLCJlbWFpbCI6ImNoZW5neWluLmVuZ0BkYXRhYnJpY2tzLmNvbSIsImVtYWlsX3ZlcmlmaWVkIjp0cnVlLCJhenAiOiIyMTYyOTYwMzU4MzQtazFrNnFlMDYwczJ0cDJhMmphbTRsamRjbXMwMHN0dGcuYXBwcy5nb29nbGV1c2VyY29udGVudC5jb20iLCJuYW1lIjoiQ2hlbmd5aW4gRW5nIiwicGljdHVyZSI6Imh0dHBzOi8vbGgzLmdvb2dsZXVzZXJjb250ZW50LmNvbS9hLS9BT2gxNEdoYWdpbWd3dDlka2dUeFJ4R0wyVVJseEZoR3hCTXFYOEI5VkI5Mz1zOTYtYyIsImdpdmVuX25hbWUiOiJDaGVuZ3lpbiIsImZhbWlseV9uYW1lIjoiRW5nIiwiaWF0IjoxNjQwMTE3Nzc1LCJleHAiOjE2NDAxMjEzNzUsImp0aSI6ImU2NWU0YWQ1YjdjNWZlZTg2Y2VlYTZmYjZkY2FjZTZjMmZiOGQzNjkifQ.cv_N3JzwybhTEbDiTVWZQcgbglL9YRM1xl2LEsqK1zvhkNQF0_ig8y6bNKLqF40Bb6ccEwZnEH-7mmDiIAii8D0B9j2K2hwW3guN7f5khZktBPHwtKR3xNS_8furTTubCExDA0kMIhVLV1SGvJSl1-6bFAaw7csYYjMikssZPSYUhaHfWaKVi7nkejznW1T8xwHCiyiAdtmi0_hd6zsOxjbrIdrmdoH-BcPWACek_Nk-cKclUKJZf5nNzURrauCA1NFtqj2ZRNSl1bJMVbmH1ySGYReBjeJbK3uk1cDsOM9iOb_Unw44D1o_8_cDAkGc5BnDOArPe87Ri9TyjR2WHg" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://medium.com/huggingface/distilbert-8cf3380435b5#id_token=eyJhbGciOiJSUzI1NiIsImtpZCI6ImQ5OGY0OWJjNmNhNDU4MWVhZThkZmFkZDQ5NGZjZTEwZWEyM2FhYjAiLCJ0eXAiOiJKV1QifQ.eyJpc3MiOiJodHRwczovL2FjY291bnRzLmdvb2dsZS5jb20iLCJuYmYiOjE2NDAxMTc0NzUsImF1ZCI6IjIxNjI5NjAzNTgzNC1rMWs2cWUwNjBzMnRwMmEyamFtNGxqZGNtczAwc3R0Zy5hcHBzLmdvb2dsZXVzZXJjb250ZW50LmNvbSIsInN1YiI6IjExNjM2Nzg3OTEyNTgyOTgzNDQ1NiIsImhkIjoiZGF0YWJyaWNrcy5jb20iLCJlbWFpbCI6ImNoZW5neWluLmVuZ0BkYXRhYnJpY2tzLmNvbSIsImVtYWlsX3ZlcmlmaWVkIjp0cnVlLCJhenAiOiIyMTYyOTYwMzU4MzQtazFrNnFlMDYwczJ0cDJhMmphbTRsamRjbXMwMHN0dGcuYXBwcy5nb29nbGV1c2VyY29udGVudC5jb20iLCJuYW1lIjoiQ2hlbmd5aW4gRW5nIiwicGljdHVyZSI6Imh0dHBzOi8vbGgzLmdvb2dsZXVzZXJjb250ZW50LmNvbS9hLS9BT2gxNEdoYWdpbWd3dDlka2dUeFJ4R0wyVVJseEZoR3hCTXFYOEI5VkI5Mz1zOTYtYyIsImdpdmVuX25hbWUiOiJDaGVuZ3lpbiIsImZhbWlseV9uYW1lIjoiRW5nIiwiaWF0IjoxNjQwMTE3Nzc1LCJleHAiOjE2NDAxMjEzNzUsImp0aSI6ImU2NWU0YWQ1YjdjNWZlZTg2Y2VlYTZmYjZkY2FjZTZjMmZiOGQzNjkifQ.cv_N3JzwybhTEbDiTVWZQcgbglL9YRM1xl2LEsqK1zvhkNQF0_ig8y6bNKLqF40Bb6ccEwZnEH-7mmDiIAii8D0B9j2K2hwW3guN7f5khZktBPHwtKR3xNS_8furTTubCExDA0kMIhVLV1SGvJSl1-6bFAaw7csYYjMikssZPSYUhaHfWaKVi7nkejznW1T8xwHCiyiAdtmi0_hd6zsOxjbrIdrmdoH-BcPWACek_Nk-cKclUKJZf5nNzURrauCA1NFtqj2ZRNSl1bJMVbmH1ySGYReBjeJbK3uk1cDsOM9iOb_Unw44D1o_8_cDAkGc5BnDOArPe87Ri9TyjR2WHg" target="_blank" style="color: inherit; text-decoration: inherit;">Source</a></block></blocks></line></editarea></span></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode align-center" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-size: 1.73em; font-weight: bold;">Size and Impact of NLP Models</block></blocks></line><line class="root text-mode align-center" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 622.589px; height: 332.62px; position: relative;"><img src="image-resources/7e21f431-535d-4f34-97a8-f38cd056a30b.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div data-caption-block-id="n0.3900695331553474" class="role-image-caption-container role-caption-container" style="display: flex; align-items: center; justify-content: center; margin-top: 10px;" id="n0.3900695331553474"><span class="no-print-outline" style="outline: none; position: relative; text-align: center;"><span class="role-image-caption-prefix" style="padding-right: 0.3em; font-weight: bold;"><span class="role-image-caption-name">Figure</span><span class="role-image-caption-number"><!-- react-text: 20599 --> <!-- /react-text --><!-- react-text: 20600 -->29<!-- /react-text --></span><span>:</span></span><editarea class="image-caption text-mode" style="min-width: 50px; display: inline;"><line class="text-mode align-center" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://dl.acm.org/doi/10.1145/3442188.3445922" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://dl.acm.org/doi/10.1145/3442188.3445922" target="_blank" style="color: inherit; text-decoration: inherit;">Source</a></block></blocks></line></editarea></span></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 624.188px; height: 135.53px; position: relative;"><img src="image-resources/11f8b3b9-8d9c-4c26-8809-b0375cfbd075.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 622.594px; height: 212.93px; position: relative;"><img src="image-resources/bdfb42e5-6e83-43e6-8ee9-8182afc5e133.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 621.994px; height: 194.01px; position: relative;"><img src="image-resources/87da0e4b-a7cf-4b89-96e5-84991ffb0a2b.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="color: rgb(255, 64, 0); font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold; color: rgb(255, 64, 0);">NLP Resources</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="http://nlp.seas.harvard.edu/2018/04/03/attention.html" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="http://nlp.seas.harvard.edu/2018/04/03/attention.html" target="_blank" style="color: inherit; text-decoration: inherit;">The Annotated Transformer (harvard.edu)</a></block><block> </block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://neptune.ai/blog/bert-and-the-transformer-architecture-reshaping-the-ai-landscape" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://neptune.ai/blog/bert-and-the-transformer-architecture-reshaping-the-ai-landscape" target="_blank" style="color: inherit; text-decoration: inherit;">Googles BERT - NLP and Transformer Architecture That Are Reshaping AI Landcape (neptune.ai)</a></block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://app.inferkit.com/demo" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://app.inferkit.com/demo" target="_blank" style="color: inherit; text-decoration: inherit;">Demo  InferKit</a></block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://arxiv.org/pdf/1910.07370.pdf" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://arxiv.org/pdf/1910.07370.pdf" target="_blank" style="color: inherit; text-decoration: inherit;">Evolution of Transfer Learning in NLP</a></block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://www.geeksforgeeks.org/self-attention-in-nlp/" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://www.geeksforgeeks.org/self-attention-in-nlp/" target="_blank" style="color: inherit; text-decoration: inherit;">Self -attention in NLP - GeeksforGeeks</a></block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://jalammar.github.io/illustrated-bert/" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://jalammar.github.io/illustrated-bert/" target="_blank" style="color: inherit; text-decoration: inherit;">The Illustrated BERT, ELMo, and co. (How NLP Cracked Transfer Learning)  Jay Alammar Visualizing machine learning one concept at a time. (jalammar.github.io)</a></block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://towardsdatascience.com/illustrated-self-attention-2d627e33b20a" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://towardsdatascience.com/illustrated-self-attention-2d627e33b20a" target="_blank" style="color: inherit; text-decoration: inherit;">Illustrated: Self-Attention. Step-by-step guide to self-attention | by Raimi Karim | Towards Data Science</a></block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://jalammar.github.io/illustrated-transformer/" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://jalammar.github.io/illustrated-transformer/" target="_blank" style="color: inherit; text-decoration: inherit;">The Illustrated Transformer  Jay Alammar  Visualizing machine learning one concept at a time. (jalammar.github.io)</a></block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold;">Library Comparisons:</block></blocks></line><line class="root text-mode indent-2 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="3"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;">* </prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://www.qblocks.cloud/blog/best-nlp-libraries-python" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://www.qblocks.cloud/blog/best-nlp-libraries-python" target="_blank" style="color: inherit; text-decoration: inherit;">10 Best Python Libraries for NLP in 2021 and their Use Cases (qblocks.cloud)</a></block></blocks></line><line class="root text-mode indent-2 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="3"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;">* </prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://medium.com/activewizards-machine-learning-company/comparison-of-top-6-python-nlp-libraries-c4ce160237eb" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://medium.com/activewizards-machine-learning-company/comparison-of-top-6-python-nlp-libraries-c4ce160237eb" target="_blank" style="color: inherit; text-decoration: inherit;">Comparison of Top 6 Python NLP Libraries | by Igor Bobriakov | ActiveWizards  AI &amp; ML for startups | Medium</a></block></blocks></line><line class="root text-mode indent-2 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="3"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;">* </prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://towardsdatascience.com/top-nlp-libraries-to-use-2020-4f700cdb841f" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://towardsdatascience.com/top-nlp-libraries-to-use-2020-4f700cdb841f" target="_blank" style="color: inherit; text-decoration: inherit;">Top NLP Libraries to Use 2020 | Towards Data Science</a></block></blocks></line><line class="root text-mode indent-2 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="3"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;">* </prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://domino.ai/blog/comparing-nlp-libraries-in-python" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://domino.ai/blog/comparing-nlp-libraries-in-python" target="_blank" style="color: inherit; text-decoration: inherit;">Introduction to NLP Libraries in Python: spaCy vs. NTLK vs. Spark NLP (dominodatalab.com)</a></block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">[</block><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><compositeblock dir="ltr" class="anchor-tag-ref inline" style="font-family: &quot;Computer Modern Serif&quot;, serif; background-color: rgba(155, 155, 155, 0.2);"><a href="#n0.3715415633810799" style="color: inherit; text-decoration: inherit;">Back To Top</a></compositeblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">]</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode section sindent-1" data-line-id="n0.5781723805236052" style="font-size: 1.1em; padding-top: 0.5em; padding-bottom: 0.5em; font-weight: bold; line-height: 1.4;" id="n0.5781723805236052" role="heading" aria-level="2"><prefix style="text-align: left; padding-right: 0.25em;">10.1. </prefix><blocks><baselineblock class="inline"></baselineblock><block>Embeddings</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>In this section, we're going to train our own </block><block style="font-weight: bold; color: rgb(255, 64, 0);">Word2Vec</block><block> model using </block><block style="font-weight: bold;">SparkML</block><block>.</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Requirement  the gensim package  </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(65, 117, 5);">%pip install gensim==4.2.0</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>So far we have been working with individual words and their counts which limits the way we can analyze text. </block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>When each word is represented as a string, it is really hard for us to compare different words and find a relationship between them which is why we were introduced to numerical representations such as </block><block style="font-weight: bold;">TFIDF</block><block> vectors. </block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>However, these vectors are often </block><block style="text-decoration: underline;">high dimensional</block><block> (equal to the number of unique terms we are tracking) and </block><block style="background-color: rgb(255, 254, 0);">pretty sparse which makes them hard to use</block><block>. </block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>We are now going to learn about a different technique of representing individual strings as denser vectors in a lower dimensional space, which tries to encode the </block><block style="background-color: rgb(255, 254, 0);">semantic relationships between words</block><block>. </block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>In this space, mathematical operations like addition, subtraction, and multiplication (dot product) </block><block style="text-decoration: underline;">still remain meaningful</block><block> to us.</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode section sindent-2" data-line-id="n0.24419946683574278" style="font-size: 1em; padding-top: 0.5em; padding-bottom: 0.5em; font-weight: bold; line-height: 1.4;" id="n0.24419946683574278" role="heading" aria-level="3"><prefix style="text-align: left; padding-right: 0em;">10.1.1. </prefix><blocks><baselineblock class="inline"></baselineblock><block>What is a Word Embedding?</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>A </block><block style="font-weight: bold; color: rgb(255, 64, 0);">word embedding</block><block> is a mapping of words to vectors in a higher dimensional space. </block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>This mapping has </block><block style="text-decoration: underline;">words with similar meanings mapped close to each other in the vector space</block><block> while different words lie far apart from each other. </block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>In this way, the topography of this vector space </block><block style="background-color: rgb(255, 254, 0);">approximates the semantic "space" of word</block><block> meanings in natural language. </block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Once we have mapped words into this semantic vector space, we can manipulate the vector representation of a word to get to a different vector which represents a different word.</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 699.6px; height: 243.06px; position: relative;"><img src="image-resources/b6e43db2-5d04-4129-a04a-46ecd5d23356.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode section sindent-2" data-line-id="n0.49649187041894005" style="font-size: 1em; padding-top: 0.5em; padding-bottom: 0.5em; font-weight: bold; line-height: 1.4;" id="n0.49649187041894005" role="heading" aria-level="3"><prefix style="text-align: left; padding-right: 0em;">10.1.2. </prefix><blocks><baselineblock class="inline"></baselineblock><block>Latent Semantic Analysis: The Old Way to Get Word Vectors</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>An older technique for obtaining semantic word vectors was to perform </block><block style="font-weight: bold; color: rgb(255, 64, 0);">Latent Semantic Analysis (LSA)</block><block> on a corpus of text. </block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>This involved building up a </block><block style="text-decoration: underline;">document-term matrix</block><block> where the </block><block style="text-decoration: underline;">rows represent documents, and the columns represent terms</block><block>. </block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>The values of a given cell might be </block><block style="font-weight: bold;">TF-IDF scores</block><block> for that term in that document. </block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Then, you perform a </block><block style="font-weight: bold;">principal components analysis (PCA)</block><block> on this matrix to obtain a </block><block style="text-decoration: underline;">mapping from the terms into a more compact semantic space</block><block>. </block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>This is relatively easy to do, but has a number of </block><block style="text-decoration: underline;">drawbacks:</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>It can be very </block><block style="text-decoration: underline;">computationally expensive</block><block> to represent and factorize very large matrices (even with a distributed engine like Spark) especially on the large text corpora needed for good NLP performance</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="text-decoration: underline;">PCA is limited to linear transformations</block><block>, which does not seem to do a good job of mapping words to their various meanings (especially with words that have different meanings in different contexts)</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="text-decoration: underline;">For the above reasons, people have mostly turned away from LSA to various neural network models in order to get efficient embeddings</block><block>. </block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>It can still be useful to do, occasionally, especially for relatively small text corpora and as a first approximation for bootstrapping other NLP processes.</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode section sindent-2" data-line-id="n0.5904261812819214" style="font-size: 1em; padding-top: 0.5em; padding-bottom: 0.5em; font-weight: bold; line-height: 1.4;" id="n0.5904261812819214" role="heading" aria-level="3"><prefix style="text-align: left; padding-right: 0em;">10.1.3. </prefix><blocks><baselineblock class="inline"></baselineblock><block>Train a Word2Vec Model using SparkML</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>There are various different ways of obtaining these vector representations of words. Below are a few commonly used embedding models:</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://code.google.com/archive/p/word2vec/Word2Vec" style="text-decoration: underline; color: rgb(17, 85, 204); font-weight: bold;"><a href="https://code.google.com/archive/p/word2vec/Word2Vec" target="_blank" style="color: inherit; text-decoration: inherit;">Word2Vec</a></block><block> by Google</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://nlp.stanford.edu/projects/glove/" style="text-decoration: underline; color: rgb(17, 85, 204); font-weight: bold;"><a href="https://nlp.stanford.edu/projects/glove/" target="_blank" style="color: inherit; text-decoration: inherit;">GloVe</a></block><block> by Stanford NLP</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://fasttext.cc/" style="text-decoration: underline; color: rgb(17, 85, 204); font-weight: bold;"><a href="https://fasttext.cc/" target="_blank" style="color: inherit; text-decoration: inherit;">fastText</a></block><block> by Facebook</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://allennlp.org/elmo" style="text-decoration: underline; color: rgb(17, 85, 204); font-weight: bold;"><a href="https://allennlp.org/elmo" target="_blank" style="color: inherit; text-decoration: inherit;">ELMO</a></block><block> by Allen NLP</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://bert-embedding.readthedocs.io/en/latest/" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://bert-embedding.readthedocs.io/en/latest/" target="_blank" style="color: inherit; text-decoration: inherit;">BERT</a></block><block> by Google</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>There are also different libraries which we can easily train/load word embeddings with:</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://spacy.io/api/vectors" style="text-decoration: underline; color: rgb(17, 85, 204); font-weight: bold;"><a href="https://spacy.io/api/vectors" target="_blank" style="color: inherit; text-decoration: inherit;">spaCy</a></block><block> has built in vectors</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://radimrehurek.com/gensim/index.html" style="text-decoration: underline; color: rgb(17, 85, 204); font-weight: bold;"><a href="https://radimrehurek.com/gensim/index.html" target="_blank" style="color: inherit; text-decoration: inherit;">Gensim</a></block><block> lets you train your own models and load in pre-trained models</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://spark.apache.org/docs/latest/ml-features.html#word2vec" style="text-decoration: underline; color: rgb(17, 85, 204); font-weight: bold;"><a href="https://spark.apache.org/docs/latest/ml-features.html#word2vec" target="_blank" style="color: inherit; text-decoration: inherit;">SparkML</a></block><block> lets you train models in parallel</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>In this section we will focus on using SparkML to train a custom embedding model specific to our reviews dataset.</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Within </block><block style="font-weight: bold;">SparkML</block><block>, there is built-in functionality to learn a distributed vector representation of words using the </block><block style="font-weight: bold;">Word2Vec</block><block> approach. </block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Given a column of text, the </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; font-weight: bold;">Word2Vec</block><block> function will assign to each row its respective word embedding. </block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>For our reviews DataFrame, this means each review will be given one vector representation, the average embedding of all words in the review. </block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>More details about this training process can be found at this </block><block class="role-hyper-link" data-hyper-link-url="https://spark.apache.org/docs/latest/ml-features.html#word2vec" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://spark.apache.org/docs/latest/ml-features.html#word2vec" target="_blank" style="color: inherit; text-decoration: inherit;">SparkML Word2Vec documentation page</a></block><block>.</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix style=""></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; font-weight: bold; color: rgb(255, 64, 0);"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold; color: rgb(255, 64, 0);">Word2Vec: SparkML</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>When training our embeddings, in SparkML's Word2Vec function we can specify two hyperparameters: </block></blocks></line><line class="root text-mode indent-2 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="3"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; color: rgb(0, 0, 0);">* </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">vectorSize</block></blocks></line><line class="root text-mode indent-2 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="3"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; color: rgb(0, 0, 0);">* </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">minCount</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">vectorSize</block><block> is the dimension of the embeddings that we want to learn and </block><block style="background-color: rgb(255, 254, 0);">typically we want this dimension to be lot smaller than the number of unique words in our dataset</block><block> (benefit over TFIDF and one-hot encoded vectors).</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">minCount</block><block> is the minimum number of times a unique word must appear to be included in the Word2Vec model's vocabulary. </block></blocks></line><line class="root text-mode indent-2 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="3"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;">* </prefix><blocks><baselineblock class="inline"></baselineblock><block>This hyperparameter can be </block><block style="background-color: rgb(255, 254, 0);">used to reduce the amount of computation done by not training our model on every single word that appears</block><block>.</block></blocks></line><line class="root text-mode indent-2 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="3"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;">* </prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold; background-color: rgb(255, 254, 0);">Note:</block><block> We are only training with 10,000 rows of text to save time.</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item full-line-block-inside" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="code-section-symbol inline" style="display: block;"><div class="code-section theme-tomorrow-night" style="display: block; border: 1px solid lightgray; background: rgb(45, 45, 45); padding: 10px; font-size: 10px;"><editarea class="text-mode code-section-edit-area" style="font-family: &quot;Fira code&quot;, &quot;Fira Mono&quot;, monospace;"><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Obtain Word2Vec embeddings of `Text` in the reviews dataframe</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">processed_df </block><block class="operator token">=</block><block class=" token"> spark</block><block class="punctuation token">.</block><block class=" token">read</block><block class="punctuation token">.</block><block class=" token">parquet</block><block class="punctuation token">(</block><block class="string-interpolation string token">f"</block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">DA</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">paths</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">datasets</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">/reviews/tfidf.parquet"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">display</block><block class="punctuation token">(</block><block class=" token">processed_df</block><block class="punctuation token">.</block><block class=" token">limit</block><block class="punctuation token">(</block><block class="number token">2</block><block class="punctuation token">)</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Training</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">from</block><block class=" token"> pyspark</block><block class="punctuation token">.</block><block class=" token">ml</block><block class="punctuation token">.</block><block class=" token">feature </block><block class="keyword token">import</block><block class=" token"> Word2Vec</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Learn a vector representation for each row of text</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">word_2_vec </block><block class="operator token">=</block><block class=" token"> Word2Vec</block><block class="punctuation token">(</block><block class=" token">vectorSize</block><block class="operator token">=</block><block class="number token">20</block><block class="punctuation token">,</block><block class=" token"> minCount</block><block class="operator token">=</block><block class="number token">2</block><block class="punctuation token">,</block><block class=" token"> inputCol</block><block class="operator token">=</block><block class="string token">"CleanTokens"</block><block class="punctuation token">,</block><block class=" token"> outputCol</block><block class="operator token">=</block><block class="string token">"word2vecEmbedding"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">model </block><block class="operator token">=</block><block class=" token"> word_2_vec</block><block class="punctuation token">.</block><block class=" token">fit</block><block class="punctuation token">(</block><block class=" token">processed_df</block><block class="punctuation token">.</block><block class=" token">limit</block><block class="punctuation token">(</block><block class="number token">10000</block><block class="punctuation token">)</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">wv_df </block><block class="operator token">=</block><block class=" token"> model</block><block class="punctuation token">.</block><block class=" token">transform</block><block class="punctuation token">(</block><block class=" token">processed_df</block><block class="punctuation token">.</block><block class=" token">limit</block><block class="punctuation token">(</block><block class="number token">10000</block><block class="punctuation token">)</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">display</block><block class="punctuation token">(</block><block class=" token">wv_df</block><block class="punctuation token">.</block><block class=" token">select</block><block class="punctuation token">(</block><block class="string token">"Text"</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"word2vecEmbedding"</block><block class="punctuation token">)</block><block class="punctuation token">.</block><block class=" token">limit</block><block class="punctuation token">(</block><block class="number token">2</block><block class="punctuation token">)</block><block class="punctuation token">)</block></blocks></line></editarea></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix style=""></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; font-weight: bold;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold;">Load Pre-Trained Model using Gensim</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>When we train our own embedding representation, we are building a </block><block style="text-decoration: underline;">domain-specific model</block><block> versus using a pretrained off-the-shelf model. </block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Since a good embedding model requires large amounts of training data, </block><block style="background-color: rgb(255, 254, 0);">it is often better to load and use a pretrained model</block><block>. </block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>This is </block><block style="text-decoration: underline;">especially relevant if your text does not contain a lot of domain specific words</block><block>, and if the </block><block style="text-decoration: underline;">amount of text</block><block> that you have available to train on </block><block style="text-decoration: underline;">is limited</block><block>.</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Another technique we can use with a pre-trained model is </block><block style="font-weight: bold; color: rgb(144, 19, 254);">transfer learning</block><block>. </block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>By using a previously trained model as the starting point of your model instead of training everything from scratch, </block><block style="background-color: rgb(255, 254, 0); font-weight: bold;">transfer learning</block><block style="background-color: rgb(255, 254, 0);"> can save you a lot of computational and time resources</block><block>.</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Our reviews dataset probably does not have much, if any, domain specific words and is likely not large enough for a trained model to perform well. </block></blocks></line><line class="root text-mode indent-2 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="3"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;">* </prefix><blocks><baselineblock class="inline"></baselineblock><block>So for a more comprehensive and generalizable model, in the following cell, we will load and use the pretrained </block><block style="font-weight: bold; color: rgb(255, 64, 0);">GloVe model</block><block> through the </block><block style="font-weight: bold;">Gensim API</block><block>. </block></blocks></line><line class="root text-mode indent-2 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="3"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;">* </prefix><blocks><baselineblock class="inline"></baselineblock><block>The </block><block style="font-style: italic;">GloVe</block><block> model we are using was trained using Wikipedia 2014 and Gigaword 5 data, with 400,000 tokens as unique 100D vectors.</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix style=""></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>A distance metric called </block><block style="font-weight: bold; color: rgb(255, 64, 0);">cosine similarity</block><block> is used to determine how "close" 2 vectors are to each other.</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Given 2 vectors </block><compositeblock dir="ltr" class="math-container-symbol role-mathmode-area inline" style="font-size: 17px;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mstyle displaystyle=&quot;true&quot;><mi>u</mi></mstyle></math>"><editarea class="math-mode-font lazyable no-area-container" style="font-family: LatinModern-Math, LatinModern, Asana-Math, Asana;" aria-hidden="true"><line class="" style="line-height: 1.2;"><baselineblock></baselineblock><block class="Normal">u</block></line></editarea><span role="presentation" style="width:100%;position:absolute;top:0;left:0;clip:rect(1px, 1px, 1px, 1px);height:1px;padding:1px 0 0 0!important;overflow:hidden;user-select:none;"><math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mi>u</mi></mstyle></math></span></compositeblock><block> and </block><compositeblock dir="ltr" class="math-container-symbol role-mathmode-area inline" style="font-size: 17px;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mstyle displaystyle=&quot;true&quot;><mi>v</mi></mstyle></math>"><editarea class="math-mode-font lazyable no-area-container" style="font-family: LatinModern-Math, LatinModern, Asana-Math, Asana;" aria-hidden="true"><line class="" style="line-height: 1.2;"><baselineblock></baselineblock><block class="Normal">v</block></line></editarea><span role="presentation" style="width:100%;position:absolute;top:0;left:0;clip:rect(1px, 1px, 1px, 1px);height:1px;padding:1px 0 0 0!important;overflow:hidden;user-select:none;"><math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mi>v</mi></mstyle></math></span></compositeblock><block>:</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="math-container-symbol role-mathmode-area display" style="font-size: 17px;" data-mathml="<math display=&quot;block&quot; xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mtext>CosineSimilarity</mtext><mo fence=&quot;true&quot; stretchy=&quot;false&quot;>(</mo><mi>u</mi><mo separator=&quot;true&quot;>,</mo><mi>v</mi><mo fence=&quot;true&quot; stretchy=&quot;false&quot;>)</mo><mo form=&quot;infix&quot;>=</mo><mfrac><mrow><mi>u</mi><mo separator=&quot;true&quot;>.</mo><mi>v</mi></mrow><mrow><mo stretchy=&quot;false&quot;>|</mo><mi>u</mi><mo stretchy=&quot;false&quot;>|</mo><mo stretchy=&quot;false&quot;>|</mo><mi>v</mi><mo stretchy=&quot;false&quot;>|</mo></mrow></mfrac></math>"><editarea class="math-mode-font lazy lazyable no-area-container" style="font-family: LatinModern-Math, LatinModern, Asana-Math, Asana;" aria-hidden="true"><line class="taggable" style="line-height: 1.2;"><baselineblock></baselineblock><compositeblock dir="ltr" class="normal-text" style="font-family: LatinModern-Math, LatinModern, Asana-Math, Asana;"><editarea class="" style="font-family: &quot;Computer Modern Sans&quot;, serif; font-size: 17px; font-style: normal;"><area-container><line class="" style="line-height: 1.4;"><baselineblock></baselineblock><block>CosineSimilarity</block></line></area-container></editarea></compositeblock><opensymbolblock class="normal" type="parenthesis"><bracket-span>(</bracket-span></opensymbolblock><block class="Normal">u</block><block class="Punctuation">,</block><block class="Normal">v</block><closesymbolblock class="normal" type="parenthesis"><bracket-span>)</bracket-span></closesymbolblock><block class="Relation">=</block><compositeblock dir="ltr" class="fraction-symbol smaller"><editarea-line class=" frac-edit-area enumerator" style="line-height: 1.2; margin-bottom: -0.470588em;"><baselineblock></baselineblock><block class="Normal">u</block><block class="Punctuation">.</block><block class="Normal">v</block></editarea-line><div class="frac-line"><inline style="border-bottom: 1px solid;"></inline></div><editarea-line class=" frac-edit-area denominator" style="margin-bottom: -0.176471em; line-height: 1.2; margin-top: -0.411765em;"><baselineblock></baselineblock><block class="Closing">|</block><block class="Normal">u</block><block class="Closing">||</block><block class="Normal">v</block><block class="Closing">|</block></editarea-line></compositeblock></line></editarea><span role="presentation" style="width:100%;position:absolute;top:0;left:0;clip:rect(1px, 1px, 1px, 1px);height:1px;padding:1px 0 0 0!important;overflow:hidden;user-select:none;"><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><mtext>CosineSimilarity</mtext><mo fence="true" stretchy="false">(</mo><mi>u</mi><mo separator="true">,</mo><mi>v</mi><mo fence="true" stretchy="false">)</mo><mo form="infix">=</mo><mfrac><mrow><mi>u</mi><mo separator="true">.</mo><mi>v</mi></mrow><mrow><mo stretchy="false">|</mo><mi>u</mi><mo stretchy="false">|</mo><mo stretchy="false">|</mo><mi>v</mi><mo stretchy="false">|</mo></mrow></mfrac></math></span></compositeblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>This metric ranges from -1 to 1, with a value of 1 indicating that the words are exactly the same, a value of -1 indicating the words are exactly opposite, and a cosine similarity of 0 representing orthogonality between the words (they are unrelated). </block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>We can use intermediate values as an indicator of how "close" 2 words are to each other given their word embedding representations.</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item full-line-block-inside" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="code-section-symbol inline" style="display: block;"><div class="code-section theme-tomorrow-night" style="display: block; border: 1px solid lightgray; background: rgb(45, 45, 45); padding: 10px; font-size: 10px;"><editarea class="text-mode code-section-edit-area" style="font-family: &quot;Fira code&quot;, &quot;Fira Mono&quot;, monospace;"><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">import</block><block class=" token"> gensim</block><block class="punctuation token">.</block><block class=" token">downloader </block><block class="keyword token">as</block><block class=" token"> api</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Load GloVe</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">word_vectors </block><block class="operator token">=</block><block class=" token"> api</block><block class="punctuation token">.</block><block class=" token">load</block><block class="punctuation token">(</block><block class="string token">"glove-wiki-gigaword-100"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">california_vec </block><block class="operator token">=</block><block class=" token"> word_vectors</block><block class="punctuation token">.</block><block class=" token">get_vector</block><block class="punctuation token">(</block><block class="string token">"california"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">print</block><block class="punctuation token">(</block><block class="string token">"Embedding dimension:"</block><block class="punctuation token">,</block><block class=" token"> california_vec</block><block class="punctuation token">.</block><block class=" token">shape</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">print</block><block class="punctuation token">(</block><block class="string token">"Vector embedding for the token 'california':\n"</block><block class="punctuation token">,</block><block class=" token"> california_vec</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">print</block><block class="punctuation token">(</block><block class="string token">"Words with vectors most similar to 'california':"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">word_vectors</block><block class="punctuation token">.</block><block class=" token">most_similar</block><block class="punctuation token">(</block><block class="string token">"california"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">result </block><block class="operator token">=</block><block class=" token"> word_vectors</block><block class="punctuation token">.</block><block class=" token">most_similar</block><block class="punctuation token">(</block><block class=" token">positive</block><block class="operator token">=</block><block class="punctuation token">[</block><block class="string token">"woman"</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"king"</block><block class="punctuation token">]</block><block class="punctuation token">,</block><block class=" token"> negative</block><block class="operator token">=</block><block class="punctuation token">[</block><block class="string token">"man"</block><block class="punctuation token">]</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">result</block></blocks></line></editarea></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix style=""></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Let's try to get a better understanding of how the embeddings work by visualizing the embeddings of woman, king, man, and queen.</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix style=""></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item full-line-block-inside" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="code-section-symbol inline" style="display: block;"><div class="code-section theme-tomorrow-night" style="display: block; border: 1px solid lightgray; background: rgb(45, 45, 45); padding: 10px; font-size: 10px;"><editarea class="text-mode code-section-edit-area" style="font-family: &quot;Fira code&quot;, &quot;Fira Mono&quot;, monospace;"><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">import</block><block class=" token"> matplotlib</block><block class="punctuation token">.</block><block class=" token">pyplot </block><block class="keyword token">as</block><block class=" token"> plt</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">from</block><block class=" token"> pyspark</block><block class="punctuation token">.</block><block class=" token">ml</block><block class="punctuation token">.</block><block class=" token">feature </block><block class="keyword token">import</block><block class=" token"> PCA</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">from</block><block class=" token"> pyspark</block><block class="punctuation token">.</block><block class=" token">ml</block><block class="punctuation token">.</block><block class=" token">linalg </block><block class="keyword token">import</block><block class=" token"> Vectors</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">def</block><block class=" token"> </block><block class="function token">get_embed_df</block><block class="punctuation token">(</block><block class=" token">words</block><block class="punctuation token">)</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="comment token"># Create df</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    vecs </block><block class="operator token">=</block><block class=" token"> </block><block class="punctuation token">[</block><block class=" token">Vectors</block><block class="punctuation token">.</block><block class=" token">dense</block><block class="punctuation token">(</block><block class="punctuation token">[</block><block class=" token">val</block><block class="punctuation token">.</block><block class=" token">item</block><block class="punctuation token">(</block><block class="punctuation token">)</block><block class=" token"> </block><block class="keyword token">for</block><block class=" token"> val </block><block class="keyword token">in</block><block class=" token"> word_vectors</block><block class="punctuation token">[</block><block class=" token">word</block><block class="punctuation token">]</block><block class="punctuation token">]</block><block class="punctuation token">)</block><block class=" token"> </block><block class="keyword token">for</block><block class=" token"> word </block><block class="keyword token">in</block><block class=" token"> words</block><block class="punctuation token">]</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    df_list </block><block class="operator token">=</block><block class=" token"> </block><block class="punctuation token">[</block><block class="punctuation token">(</block><block class=" token">i</block><block class="punctuation token">,</block><block class=" token"> word</block><block class="punctuation token">,</block><block class=" token"> vec</block><block class="punctuation token">)</block><block class=" token"> </block><block class="keyword token">for</block><block class=" token"> i</block><block class="punctuation token">,</block><block class=" token"> </block><block class="punctuation token">(</block><block class=" token">word</block><block class="punctuation token">,</block><block class=" token"> vec</block><block class="punctuation token">)</block><block class=" token"> </block><block class="keyword token">in</block><block class=" token"> </block><block class="builtin token">enumerate</block><block class="punctuation token">(</block><block class="builtin token">zip</block><block class="punctuation token">(</block><block class=" token">words</block><block class="punctuation token">,</block><block class=" token"> vecs</block><block class="punctuation token">)</block><block class="punctuation token">)</block><block class="punctuation token">]</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    df </block><block class="operator token">=</block><block class=" token"> spark</block><block class="punctuation token">.</block><block class=" token">createDataFrame</block><block class="punctuation token">(</block><block class=" token">df_list</block><block class="punctuation token">,</block><block class=" token"> </block><block class="punctuation token">[</block><block class="string token">"id"</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"word"</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"vectors"</block><block class="punctuation token">]</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="comment token"># Reduce to 2 dim for plotting</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    pca </block><block class="operator token">=</block><block class=" token"> PCA</block><block class="punctuation token">(</block><block class=" token">k</block><block class="operator token">=</block><block class="number token">2</block><block class="punctuation token">,</block><block class=" token"> inputCol</block><block class="operator token">=</block><block class="string token">"vectors"</block><block class="punctuation token">,</block><block class=" token"> outputCol</block><block class="operator token">=</block><block class="string token">"2d_vectors"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    model </block><block class="operator token">=</block><block class=" token"> pca</block><block class="punctuation token">.</block><block class=" token">fit</block><block class="punctuation token">(</block><block class=" token">df</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="keyword token">return</block><block class=" token"> model</block><block class="punctuation token">.</block><block class=" token">transform</block><block class="punctuation token">(</block><block class=" token">df</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">words </block><block class="operator token">=</block><block class=" token"> </block><block class="punctuation token">[</block><block class="string token">"man"</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"woman"</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"king"</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"queen"</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"object"</block><block class="punctuation token">]</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">embed_df </block><block class="operator token">=</block><block class=" token"> get_embed_df</block><block class="punctuation token">(</block><block class=" token">words</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Get the 4 vectors we are interested in</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">vectors </block><block class="operator token">=</block><block class=" token"> </block><block class="punctuation token">[</block><block class=" token">row</block><block class="punctuation token">[</block><block class="number token">0</block><block class="punctuation token">]</block><block class=" token"> </block><block class="keyword token">for</block><block class=" token"> row </block><block class="keyword token">in</block><block class=" token"> embed_df</block><block class="punctuation token">.</block><block class=" token">select</block><block class="punctuation token">(</block><block class="string token">"2d_vectors"</block><block class="punctuation token">)</block><block class="punctuation token">.</block><block class=" token">collect</block><block class="punctuation token">(</block><block class="punctuation token">)</block><block class="punctuation token">[</block><block class="punctuation token">:</block><block class="number token">4</block><block class="punctuation token">]</block><block class="punctuation token">]</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">def</block><block class=" token"> </block><block class="function token">plot_vectors</block><block class="punctuation token">(</block><block class=" token">vectors</block><block class="punctuation token">,</block><block class=" token"> words</block><block class="punctuation token">)</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="keyword token">for</block><block class=" token"> coord</block><block class="punctuation token">,</block><block class=" token"> word </block><block class="keyword token">in</block><block class=" token"> </block><block class="builtin token">zip</block><block class="punctuation token">(</block><block class=" token">vectors</block><block class="punctuation token">,</block><block class=" token"> words</block><block class="punctuation token">)</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        plt</block><block class="punctuation token">.</block><block class=" token">quiver</block><block class="punctuation token">(</block><block class="number token">0</block><block class="punctuation token">,</block><block class=" token"> </block><block class="number token">0</block><block class="punctuation token">,</block><block class=" token"> coord</block><block class="punctuation token">[</block><block class="number token">0</block><block class="punctuation token">]</block><block class="punctuation token">,</block><block class=" token"> coord</block><block class="punctuation token">[</block><block class="number token">1</block><block class="punctuation token">]</block><block class="punctuation token">,</block><block class=" token"> angles</block><block class="operator token">=</block><block class="string token">"xy"</block><block class="punctuation token">,</block><block class=" token"> scale_units</block><block class="operator token">=</block><block class="string token">"xy"</block><block class="punctuation token">,</block><block class=" token"> scale</block><block class="operator token">=</block><block class="number token">1</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        plt</block><block class="punctuation token">.</block><block class=" token">text</block><block class="punctuation token">(</block><block class=" token">coord</block><block class="punctuation token">[</block><block class="number token">0</block><block class="punctuation token">]</block><block class=" token"> </block><block class="operator token">+</block><block class=" token"> </block><block class="number token">0.05</block><block class="punctuation token">,</block><block class=" token"> coord</block><block class="punctuation token">[</block><block class="number token">1</block><block class="punctuation token">]</block><block class="punctuation token">,</block><block class=" token"> word</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        plt</block><block class="punctuation token">.</block><block class=" token">title</block><block class="punctuation token">(</block><block class="string token">"Visualizing Word Embeddings"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        plt</block><block class="punctuation token">.</block><block class=" token">xlim</block><block class="punctuation token">(</block><block class="operator token">-</block><block class="number token">2</block><block class="punctuation token">,</block><block class=" token"> </block><block class="number token">5</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        plt</block><block class="punctuation token">.</block><block class=" token">ylim</block><block class="punctuation token">(</block><block class="operator token">-</block><block class="number token">0.5</block><block class="punctuation token">,</block><block class=" token"> </block><block class="number token">4.5</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">plot_vectors</block><block class="punctuation token">(</block><block class=" token">vectors</block><block class="punctuation token">,</block><block class=" token"> words</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">plt</block><block class="punctuation token">.</block><block class=" token">show</block><block class="punctuation token">(</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Some more examples</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">examples </block><block class="operator token">=</block><block class=" token"> </block><block class="punctuation token">[</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="punctuation token">[</block><block class="string token">"ice"</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"cold"</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"heat"</block><block class="punctuation token">]</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="punctuation token">[</block><block class="string token">"ocean"</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"water"</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"sand"</block><block class="punctuation token">]</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="punctuation token">[</block><block class="string token">"walking"</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"walked"</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"swam"</block><block class="punctuation token">]</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="punctuation token">[</block><block class="string token">"rode"</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"ride"</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"drive"</block><block class="punctuation token">]</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="punctuation token">[</block><block class="string token">"london"</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"england"</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"france"</block><block class="punctuation token">]</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="punctuation token">[</block><block class="string token">"rome"</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"italy"</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"japan"</block><block class="punctuation token">]</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="punctuation token">[</block><block class="string token">"aunt"</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"woman"</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"man"</block><block class="punctuation token">]</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="punctuation token">[</block><block class="string token">"dog"</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"man"</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"woman"</block><block class="punctuation token">]</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="punctuation token">[</block><block class="string token">"doctor"</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"man"</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"woman"</block><block class="punctuation token">]</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="punctuation token">]</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">for</block><block class=" token"> start</block><block class="punctuation token">,</block><block class=" token"> neg</block><block class="punctuation token">,</block><block class=" token"> pos </block><block class="keyword token">in</block><block class=" token"> examples</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="keyword token">print</block><block class="punctuation token">(</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block><block class="string-interpolation string token">f"</block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">start</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token"> - </block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">neg</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token"> + </block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">pos</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token"> = </block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">word_vectors</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">most_similar</block><block class="string-interpolation interpolation punctuation token">(</block><block class="string-interpolation interpolation token">positive</block><block class="string-interpolation interpolation operator token">=</block><block class="string-interpolation interpolation punctuation token">[</block><block class="string-interpolation interpolation token">start</block><block class="string-interpolation interpolation punctuation token">,</block><block class="string-interpolation interpolation token"> pos</block><block class="string-interpolation interpolation punctuation token">]</block><block class="string-interpolation interpolation punctuation token">,</block><block class="string-interpolation interpolation token"> negative</block><block class="string-interpolation interpolation operator token">=</block><block class="string-interpolation interpolation punctuation token">[</block><block class="string-interpolation interpolation token">neg</block><block class="string-interpolation interpolation punctuation token">]</block><block class="string-interpolation interpolation punctuation token">)</block><block class="string-interpolation interpolation punctuation token">[</block><block class="string-interpolation interpolation number token">0</block><block class="string-interpolation interpolation punctuation token">]</block><block class="string-interpolation interpolation punctuation token">[</block><block class="string-interpolation interpolation number token">0</block><block class="string-interpolation interpolation punctuation token">]</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">"</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="punctuation token">)</block></blocks></line></editarea></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix style=""></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 484px; height: 356.84px; position: relative;"><img src="image-resources/9894ca1b-1d7c-4885-aadf-39468260b46a.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix style=""></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">[</block><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><compositeblock dir="ltr" class="anchor-tag-ref inline" style="font-family: &quot;Computer Modern Serif&quot;, serif; background-color: rgba(155, 155, 155, 0.2);"><a href="#n0.3715415633810799" style="color: inherit; text-decoration: inherit;">Back To Top</a></compositeblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">]</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode section sindent-2" style="line-height: 1.4; font-size: 1em; padding-top: 0.5em; padding-bottom: 0.5em; font-weight: bold;" data-line-id="n0.7877235622224192" id="n0.7877235622224192" role="heading" aria-level="3"><prefix style="text-align: left; padding-right: 0em;">10.1.4. </prefix><blocks><baselineblock class="inline"></baselineblock><block>Implicit bias in word vectors</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold;">Do all the above examples make sense to you?</block><block> </block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>As you can see, these vectors span many semantic dimensions, not only gender. </block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>We can other meaningful attributes here, such as: heat-cold, dry-wet, past-present, as well as the capital cities of several countries.</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>There are some strange examples at the end, however. </block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Returning to gender, we can see a few odd effects here. </block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>While gender is part of the definition of "aunt" and "uncle" (just as it is for "king" and "queen"), it is peculiar that gender is involved at all in the distinction between "dog" and "cat", and it is just wrong that it should be in the representation for "doctor" and "nurse".</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; font-weight: bold;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold;">What is going on here?</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Word embeddings are trained on very large corpora of text, usually taken from the public internet (the GloVE model was trained on Wikipedia articles). </block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="text-decoration: underline;">Unfortunately, there is still a fair bit of bias in the world around issues such as gender and race, and these biases will be present in the language for some of these articles</block><block>. </block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>The neural networks that learn the </block><block style="text-decoration: underline;">word embeddings will pick up this bias</block><block> in just the same way they pick up on all of other ways in which humans make distinctions between words and meanings. </block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Thus, in addition to pure semantic meaning, the model also learns and applies the biases and stereotypes present within the training data. </block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Some of these biases may be idiosyncratic and culture-specific (such as identifying dogs as masculine and cats as feminine), but others can be quite harmful.</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Researchers are continuing to develop ways of identifying and "de-biasing" or correcting for such biases in language models, and this remains an area of active research see </block><block class="role-hyper-link" data-hyper-link-url="https://papers.nips.cc/paper/6228-man-is-to-computer-programmer-as-woman-is-to-homemaker-debiasing-word-embeddings.pdf" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://papers.nips.cc/paper/6228-man-is-to-computer-programmer-as-woman-is-to-homemaker-debiasing-word-embeddings.pdf" target="_blank" style="color: inherit; text-decoration: inherit;">here</a></block><block>. </block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>It is important to be aware of these implicit biases in our data, and try to correct them, because otherwise A.I. systems we build on it will simply continue perpetuate these biases in future decisions that they make. This can be both embarrassing and costly to companies that deploy such models for real-world use.</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix style=""></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode section sindent-2" style="line-height: 1.4; font-size: 1em; padding-top: 0.5em; padding-bottom: 0.5em; font-weight: bold;" data-line-id="n0.7705273686316372" id="n0.7705273686316372" role="heading" aria-level="3"><prefix style="text-align: left; padding-right: 0em;">10.1.5. </prefix><blocks><baselineblock class="inline"></baselineblock><block>Semantic Search</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>One simple application for semantic similarity is </block><block style="background-color: rgb(255, 254, 0);">as a filter for finding related items in a text corpus</block><block>. </block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>To start, build a target vector by adding together a number of related terms that relate to the search topic of interest, the more the better. </block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Any single word vector may contain elements representing alternative meanings (polysemy), so adding (or averaging) together a number of word vectors will build a target vector that is more focused only on the shared / common attributes.</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold; background-color: rgb(255, 254, 0);">Note:</block><block> that since vector cosines are a measure of the angle between two vectors, the absolute length of the vectors (the norm) does not matter in semantic similarity - only the directions in which they point.</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix style=""></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Let's search for product reviews that describe delicious foods.</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix style=""></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item full-line-block-inside" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="code-section-symbol inline" style="display: block;"><div class="code-section theme-tomorrow-night" style="display: block; border: 1px solid lightgray; background: rgb(45, 45, 45); padding: 10px; font-size: 10px;"><editarea class="text-mode code-section-edit-area" style="font-family: &quot;Fira code&quot;, &quot;Fira Mono&quot;, monospace;"><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># First, we set up a target vector based on related terms that together describe what we're looking for...</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">import</block><block class=" token"> numpy </block><block class="keyword token">as</block><block class=" token"> np</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">keywords </block><block class="operator token">=</block><block class=" token"> </block><block class="punctuation token">[</block><block class="string token">"food"</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"eat"</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"flavor"</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"yummy"</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"delicious"</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"taste"</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"tasty"</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"sweet"</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"salty"</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"spicy"</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"savory"</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"drink"</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"snack"</block><block class="punctuation token">]</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">target_vector </block><block class="operator token">=</block><block class=" token"> np</block><block class="punctuation token">.</block><block class="builtin token">sum</block><block class="punctuation token">(</block><block class=" token">np</block><block class="punctuation token">.</block><block class=" token">array</block><block class="punctuation token">(</block><block class="punctuation token">[</block><block class=" token">word_vectors</block><block class="punctuation token">.</block><block class=" token">get_vector</block><block class="punctuation token">(</block><block class=" token">w</block><block class="punctuation token">)</block><block class=" token"> </block><block class="keyword token">for</block><block class=" token"> w </block><block class="keyword token">in</block><block class=" token"> keywords</block><block class="punctuation token">]</block><block class="punctuation token">)</block><block class="punctuation token">,</block><block class=" token"> axis</block><block class="operator token">=</block><block class="number token">0</block><block class="punctuation token">)</block><block class="punctuation token">.</block><block class=" token">tolist</block><block class="punctuation token">(</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">target_vector</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">display</block><block class="punctuation token">(</block><block class=" token">processed_df</block><block class="punctuation token">.</block><block class=" token">limit</block><block class="punctuation token">(</block><block class="number token">2</block><block class="punctuation token">)</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Now build a vector of the words in the description. Since `pandas_udf` does not currently support `VectorUDT` type, we will be using regular `udf`.</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">from</block><block class=" token"> pyspark</block><block class="punctuation token">.</block><block class=" token">ml</block><block class="punctuation token">.</block><block class=" token">linalg </block><block class="keyword token">import</block><block class=" token"> VectorUDT</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">from</block><block class=" token"> pyspark</block><block class="punctuation token">.</block><block class=" token">sql</block><block class="punctuation token">.</block><block class=" token">functions </block><block class="keyword token">import</block><block class=" token"> col</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">@udf</block><block class="punctuation token">(</block><block class=" token">returnType</block><block class="operator token">=</block><block class=" token">VectorUDT</block><block class="punctuation token">(</block><block class="punctuation token">)</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">def</block><block class=" token"> </block><block class="function token">tokens_2_vector</block><block class="punctuation token">(</block><block class=" token">tokens</block><block class="punctuation token">)</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">  desc_vec </block><block class="operator token">=</block><block class=" token"> np</block><block class="punctuation token">.</block><block class=" token">zeros</block><block class="punctuation token">(</block><block class="number token">100</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">  </block><block class="keyword token">for</block><block class=" token"> token </block><block class="keyword token">in</block><block class=" token"> tokens</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="keyword token">try</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">      desc_vec </block><block class="operator token">+=</block><block class=" token"> word_vectors</block><block class="punctuation token">.</block><block class=" token">get_vector</block><block class="punctuation token">(</block><block class=" token">token</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="keyword token">except</block><block class=" token"> KeyError</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">      </block><block class="keyword token">continue</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">  </block><block class="keyword token">return</block><block class=" token"> Vectors</block><block class="punctuation token">.</block><block class=" token">dense</block><block class="punctuation token">(</block><block class=" token">desc_vec</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">vectorized_df </block><block class="operator token">=</block><block class=" token"> processed_df</block><block class="punctuation token">.</block><block class=" token">select</block><block class="punctuation token">(</block><block class="string token">"Id"</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                                    </block><block class="string token">"ProductId"</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                                    </block><block class="string token">"Score"</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                                    </block><block class="string token">"Summary"</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                                    </block><block class="string token">"Text"</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                                    </block><block class="string token">"CleanTokens"</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                                    tokens_2_vector</block><block class="punctuation token">(</block><block class=" token">col</block><block class="punctuation token">(</block><block class="string token">"CleanTokens"</block><block class="punctuation token">)</block><block class="punctuation token">)</block><block class="punctuation token">.</block><block class=" token">alias</block><block class="punctuation token">(</block><block class="string token">"Vector"</block><block class="punctuation token">)</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">display</block><block class="punctuation token">(</block><block class=" token">vectorized_df</block><block class="punctuation token">.</block><block class=" token">limit</block><block class="punctuation token">(</block><block class="number token">2</block><block class="punctuation token">)</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Finally, we compute semantic similarity (ie. cosine) of the review vector to our target vector. Sorting by decreasing similarity scores should display the most relevant results at the top of the list.</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">from</block><block class=" token"> pyspark</block><block class="punctuation token">.</block><block class=" token">sql</block><block class="punctuation token">.</block><block class=" token">types </block><block class="keyword token">import</block><block class=" token"> DoubleType</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">from</block><block class=" token"> pyspark</block><block class="punctuation token">.</block><block class=" token">sql</block><block class="punctuation token">.</block><block class=" token">functions </block><block class="keyword token">import</block><block class=" token"> array</block><block class="punctuation token">,</block><block class=" token"> lit</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">from</block><block class=" token"> numpy</block><block class="punctuation token">.</block><block class=" token">linalg </block><block class="keyword token">import</block><block class=" token"> norm</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">@udf</block><block class="punctuation token">(</block><block class=" token">returnType</block><block class="operator token">=</block><block class=" token">DoubleType</block><block class="punctuation token">(</block><block class="punctuation token">)</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">def</block><block class=" token"> </block><block class="function token">similarity</block><block class="punctuation token">(</block><block class=" token">a</block><block class="punctuation token">,</block><block class=" token"> b</block><block class="punctuation token">)</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">  </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    a_norm </block><block class="operator token">=</block><block class=" token"> norm</block><block class="punctuation token">(</block><block class=" token">a</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    b_norm </block><block class="operator token">=</block><block class=" token"> norm</block><block class="punctuation token">(</block><block class=" token">b</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    similarity </block><block class="operator token">=</block><block class=" token"> </block><block class="builtin token">float</block><block class="punctuation token">(</block><block class=" token">np</block><block class="punctuation token">.</block><block class=" token">dot</block><block class="punctuation token">(</block><block class=" token">a</block><block class="punctuation token">,</block><block class=" token"> b</block><block class="punctuation token">)</block><block class=" token"> </block><block class="operator token">/</block><block class=" token"> </block><block class="punctuation token">(</block><block class=" token">a_norm </block><block class="operator token">*</block><block class=" token"> b_norm</block><block class="punctuation token">)</block><block class="punctuation token">)</block><block class=" token"> </block><block class="keyword token">if</block><block class=" token"> </block><block class="punctuation token">(</block><block class=" token">a_norm </block><block class="operator token">!=</block><block class=" token"> </block><block class="number token">0.0</block><block class=" token"> </block><block class="keyword token">and</block><block class=" token"> b_norm </block><block class="operator token">!=</block><block class=" token"> </block><block class="number token">0.0</block><block class="punctuation token">)</block><block class=" token"> </block><block class="keyword token">else</block><block class=" token"> </block><block class="number token">0.0</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="keyword token">return</block><block class=" token"> similarity</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">sim_df </block><block class="operator token">=</block><block class=" token"> vectorized_df</block><block class="punctuation token">.</block><block class=" token">withColumn</block><block class="punctuation token">(</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    </block><block class="string token">"SimilarityToTarget"</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    similarity</block><block class="punctuation token">(</block><block class=" token">col</block><block class="punctuation token">(</block><block class="string token">"Vector"</block><block class="punctuation token">)</block><block class="punctuation token">,</block><block class=" token"> array</block><block class="punctuation token">(</block><block class="punctuation token">[</block><block class=" token">lit</block><block class="punctuation token">(</block><block class=" token">x</block><block class="punctuation token">)</block><block class=" token"> </block><block class="keyword token">for</block><block class=" token"> x </block><block class="keyword token">in</block><block class=" token"> target_vector</block><block class="punctuation token">]</block><block class="punctuation token">)</block><block class="punctuation token">)</block><block class="punctuation token">,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">display</block><block class="punctuation token">(</block><block class=" token">sim_df</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block><block class="punctuation token">.</block><block class=" token">select</block><block class="punctuation token">(</block><block class="string token">"Id"</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"Summary"</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"ProductId"</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"Text"</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"SimilarityToTarget"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block><block class="punctuation token">.</block><block class=" token">orderBy</block><block class="punctuation token">(</block><block class=" token">col</block><block class="punctuation token">(</block><block class="string token">"SimilarityToTarget"</block><block class="punctuation token">)</block><block class="punctuation token">.</block><block class=" token">desc</block><block class="punctuation token">(</block><block class="punctuation token">)</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="punctuation token">)</block></blocks></line></editarea></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix style=""></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">[</block><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><compositeblock dir="ltr" class="anchor-tag-ref inline" style="font-family: &quot;Computer Modern Serif&quot;, serif; background-color: rgba(155, 155, 155, 0.2);"><a href="#n0.3715415633810799" style="color: inherit; text-decoration: inherit;">Back To Top</a></compositeblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">]</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode section sindent-1" style="line-height: 1.4; font-size: 1.1em; padding-top: 0.5em; padding-bottom: 0.5em; font-weight: bold;" data-line-id="n0.15528075070547387" id="n0.15528075070547387" role="heading" aria-level="2"><prefix style="text-align: left; padding-right: 0.25em;">10.2. </prefix><blocks><baselineblock class="inline"></baselineblock><block>NER with SparkML</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>In this section we will:</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Extract facts and relevant information from an otherwise unstructured data (raw, unprocessed text)</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Explore example applications:</block></blocks></line><line class="root text-mode indent-2 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="3"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; font-weight: bold;">* </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold;">Information management</block></blocks></line><line class="root text-mode indent-2 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="3"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; font-weight: bold;">* </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold;">Question answering</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Use groups of words as a single entity rather than single words</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Detect named entities and their types</block></blocks></line><line class="root text-mode indent-2 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="3"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;">* </prefix><blocks><baselineblock class="inline"></baselineblock><block>people, locations, organizations</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Use </block><block style="font-weight: bold; color: rgb(255, 64, 0);">SparkNLP</block><block> - an open source library created by </block><block class="role-hyper-link" data-hyper-link-url="https://nlp.johnsnowlabs.com/api/python/reference/index.html" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://nlp.johnsnowlabs.com/api/python/reference/index.html" target="_blank" style="color: inherit; text-decoration: inherit;">John Snow Labs</a></block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix style=""></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Library requirements:</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; color: rgb(0, 0, 0);"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">spark-nlp-display==4.1</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; color: rgb(0, 0, 0);"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">spark-nlp==4.2.1</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix style=""></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>You need to additionally install a Maven package on the cluster as well.</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>When on Apache Spark versions 3.x:</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; color: rgb(0, 0, 0);"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">com.johnsnowlabs.nlp:spark-nlp_2.12:4.2.5</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold; background-color: rgb(255, 254, 0);">Note:</block><block> John Snow Labs updates the SparkNLP package periodically. When Apache Spark/Databricks runtime versions are updated, please refer to </block><block class="role-hyper-link" data-hyper-link-url="https://github.com/JohnSnowLabs/spark-nlp#packages-cheatsheet" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://github.com/JohnSnowLabs/spark-nlp#packages-cheatsheet" target="_blank" style="color: inherit; text-decoration: inherit;">JSL's package cheatsheet</a></block><block> to get the latest Maven version to install.</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix style=""></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item full-line-block-inside" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="code-section-symbol inline" style="display: block;"><div class="code-section theme-tomorrow-night" style="display: block; border: 1px solid lightgray; background: rgb(45, 45, 45); padding: 10px; font-size: 10px;"><editarea class="text-mode code-section-edit-area" style="font-family: &quot;Fira code&quot;, &quot;Fira Mono&quot;, monospace;"><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="operator token">%</block><block class=" token">scala</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">// Verify that com.johnsnowlabs.nlp:spark-nlp </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">// is properly installed by importing it.</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">import</block><block class=" token"> </block><block class="namespace token">com</block><block class="namespace punctuation token">.</block><block class="namespace token">johnsnowlabs</block><block class="namespace punctuation token">.</block><block class="namespace token">nlp</block><block class="punctuation token">.</block><block class="class-name token">SparkNLP</block></blocks></line></editarea></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix style=""></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; font-weight: bold;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold;">Using pre-trained model without fine-tuning</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>What is the data? A set of financial documents.</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-style: italic;">Data source</block><block>  publicly disclosed SEC fillings - </block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-style: italic;">Goal</block><block>  assess loan agreement, loan amount, value of collateral - perform risk assessment - </block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Research paper published </block><block class="role-hyper-link" data-hyper-link-url="https://aclanthology.org/U15-1010.pdf" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://aclanthology.org/U15-1010.pdf" target="_blank" style="color: inherit; text-decoration: inherit;">here</a></block><block> by a group of researchers at the University of Melbourne, Australia.</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="font-weight: bold; flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Data can be downloaded </block><block class="role-hyper-link" data-hyper-link-url="https://people.eng.unimelb.edu.au/tbaldwin/#resources" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://people.eng.unimelb.edu.au/tbaldwin/#resources" target="_blank" style="color: inherit; text-decoration: inherit;">here</a></block><block>.</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 456px; height: 264.95px; position: relative;"><img src="image-resources/281fbf03-f347-41db-9f0c-c910fe929997.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold; color: rgb(255, 64, 0);">CoNLL</block><block> is the conventional name for TSV (tab-separated values) data in NLP. </block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>It originally refers to the shared NLP tasks organized by the Conferences of Natural Language Learning (CoNLL). </block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>You can go to </block><block class="role-hyper-link" data-hyper-link-url="https://raw.githubusercontent.com/patverga/torch-ner-nlp-from-scratch/master/data/conll2003/eng.train" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://raw.githubusercontent.com/patverga/torch-ner-nlp-from-scratch/master/data/conll2003/eng.train" target="_blank" style="color: inherit; text-decoration: inherit;">this page</a></block><block> to look at how the data looks like: this particular dataset - that contains Reuter stories - is one of the most widely used NER datasets in the CoNLL format. But we will be using financial data for this notebook!</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://www.researchgate.net/figure/1-The-Penn-Treebank-POS-tagset_tbl1_2873803" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://www.researchgate.net/figure/1-The-Penn-Treebank-POS-tagset_tbl1_2873803" target="_blank" style="color: inherit; text-decoration: inherit;">Source for the Image on the right</a></block></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 694.4px; height: 328.14px; position: relative;"><img src="image-resources/3574df8f-70e7-4ccd-aedc-247b57f43ff7.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item full-line-block-inside" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="code-section-symbol inline" style="display: block;"><div class="code-section theme-tomorrow-night" style="display: block; border: 1px solid lightgray; background: rgb(45, 45, 45); padding: 10px; font-size: 10px;"><editarea class="text-mode code-section-edit-area" style="font-family: &quot;Fira code&quot;, &quot;Fira Mono&quot;, monospace;"><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">from</block><block class=" token"> sparknlp</block><block class="punctuation token">.</block><block class=" token">training </block><block class="keyword token">import</block><block class=" token"> CoNLL</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">training_data </block><block class="operator token">=</block><block class=" token"> CoNLL</block><block class="punctuation token">(</block><block class="punctuation token">)</block><block class="punctuation token">.</block><block class=" token">readDataset</block><block class="punctuation token">(</block><block class=" token">spark</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string-interpolation string token">f"</block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">DA</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">paths</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">datasets</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">/sec-fillings/train-fin5.txt"</block><block class="punctuation token">,</block><block class=" token"> read_as</block><block class="operator token">=</block><block class="string token">"text"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">display</block><block class="punctuation token">(</block><block class=" token">training_data</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">test_data </block><block class="operator token">=</block><block class=" token"> CoNLL</block><block class="punctuation token">(</block><block class="punctuation token">)</block><block class="punctuation token">.</block><block class=" token">readDataset</block><block class="punctuation token">(</block><block class=" token">spark</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string-interpolation string token">f"</block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">DA</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">paths</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">datasets</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">/sec-fillings/test-fin3.txt"</block><block class="punctuation token">,</block><block class=" token"> read_as</block><block class="operator token">=</block><block class="string token">"text"</block><block class="punctuation token">)</block></blocks></line></editarea></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix style=""></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Here are all the available pretrained </block><block class="role-hyper-link" data-hyper-link-url="https://nlp.johnsnowlabs.com/docs/en/pipelines" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://nlp.johnsnowlabs.com/docs/en/pipelines" target="_blank" style="color: inherit; text-decoration: inherit;">pipelines</a></block><block> in SparkNLP. </block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>This </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">recognize_entities_dl</block><block> pipeline was trained on </block><block class="role-hyper-link" data-hyper-link-url="https://nlp.johnsnowlabs.com/2020/01/22/glove_100d.html" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://nlp.johnsnowlabs.com/2020/01/22/glove_100d.html" target="_blank" style="color: inherit; text-decoration: inherit;">Glove</a></block><block> embeddings and this </block><block class="role-hyper-link" data-hyper-link-url="https://nlp.johnsnowlabs.com/2020/03/19/ner_dl_en.html" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://nlp.johnsnowlabs.com/2020/03/19/ner_dl_en.html" target="_blank" style="color: inherit; text-decoration: inherit;">NER</a></block><block> model that was trained on the CoNLL 2003 Reuters text corpus.</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix style=""></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item full-line-block-inside" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="code-section-symbol inline" style="display: block;"><div class="code-section theme-tomorrow-night" style="display: block; border: 1px solid lightgray; background: rgb(45, 45, 45); padding: 10px; font-size: 10px;"><editarea class="text-mode code-section-edit-area" style="font-family: &quot;Fira code&quot;, &quot;Fira Mono&quot;, monospace;"><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">from</block><block class=" token"> sparknlp</block><block class="punctuation token">.</block><block class=" token">pretrained </block><block class="keyword token">import</block><block class=" token"> PretrainedPipeline</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">rec_entities_pipeline </block><block class="operator token">=</block><block class=" token"> PretrainedPipeline</block><block class="punctuation token">(</block><block class="string token">"recognize_entities_dl"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">sample_text </block><block class="operator token">=</block><block class=" token"> training_data</block><block class="punctuation token">.</block><block class=" token">first</block><block class="punctuation token">(</block><block class="punctuation token">)</block><block class="punctuation token">[</block><block class="number token">0</block><block class="punctuation token">]</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">single_example </block><block class="operator token">=</block><block class=" token"> rec_entities_pipeline</block><block class="punctuation token">.</block><block class=" token">fullAnnotate</block><block class="punctuation token">(</block><block class=" token">sample_text</block><block class="punctuation token">)</block><block class="punctuation token">[</block><block class="number token">0</block><block class="punctuation token">]</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">single_example</block><block class="punctuation token">.</block><block class=" token">keys</block><block class="punctuation token">(</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># recognize_entities_dl download started this may take some time.</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Approx size to download 160.1 MB</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># [OK!]</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Out[9]: dict_keys(['entities', 'document', 'token', 'ner', 'embeddings', 'sentence'])</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">rec_entities_pipeline</block><block class="punctuation token">.</block><block class=" token">model</block><block class="punctuation token">.</block><block class=" token">stages</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Out[10]: [document_1c58bc1aca5d,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  SENTENCE_328d8a47c1a8,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  REGEX_TOKENIZER_b6c4cbc5a4ea,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  WORD_EMBEDDINGS_MODEL_48cffc8b9a76,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  NerDLModel_d4424c9af5f4,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  NER_CONVERTER_389b80afbf7d]</block></blocks></line></editarea></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix style=""></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Visualizations are possible with the use of the library </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">spark-nlp-display</block><block>. Documentation is </block><block class="role-hyper-link" data-hyper-link-url="https://github.com/JohnSnowLabs/spark-nlp-display/blob/main/tutorials/Spark_NLP_Display.ipynb" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://github.com/JohnSnowLabs/spark-nlp-display/blob/main/tutorials/Spark_NLP_Display.ipynb" target="_blank" style="color: inherit; text-decoration: inherit;">here</a></block><block>.</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix style=""></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item full-line-block-inside" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="code-section-symbol inline" style="display: block;"><div class="code-section theme-tomorrow-night" style="display: block; border: 1px solid lightgray; background: rgb(45, 45, 45); padding: 10px; font-size: 10px;"><editarea class="text-mode code-section-edit-area" style="font-family: &quot;Fira code&quot;, &quot;Fira Mono&quot;, monospace;"><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">from</block><block class=" token"> sparknlp_display </block><block class="keyword token">import</block><block class=" token"> NerVisualizer</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">visualizer </block><block class="operator token">=</block><block class=" token"> NerVisualizer</block><block class="punctuation token">(</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">ner_vis </block><block class="operator token">=</block><block class=" token"> visualizer</block><block class="punctuation token">.</block><block class=" token">display</block><block class="punctuation token">(</block><block class=" token">single_example</block><block class="punctuation token">,</block><block class=" token"> label_col</block><block class="operator token">=</block><block class="string token">"entities"</block><block class="punctuation token">,</block><block class=" token"> document_col</block><block class="operator token">=</block><block class="string token">"document"</block><block class="punctuation token">,</block><block class=" token"> return_html</block><block class="operator token">=</block><block class="boolean token">True</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">displayHTML</block><block class="punctuation token">(</block><block class=" token">ner_vis</block><block class="punctuation token">)</block></blocks></line></editarea></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix style=""></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 668.992px; height: 117.7px; position: relative;"><img src="image-resources/914c6222-ac82-4408-92fc-35ceb1b7e7ff.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">[</block><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><compositeblock dir="ltr" class="anchor-tag-ref inline" style="font-family: &quot;Computer Modern Serif&quot;, serif; background-color: rgba(155, 155, 155, 0.2);"><a href="#n0.3715415633810799" style="color: inherit; text-decoration: inherit;">Back To Top</a></compositeblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">]</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode section sindent-2" style="line-height: 1.4; font-size: 1em; padding-top: 0.5em; padding-bottom: 0.5em; font-weight: bold;" data-line-id="n0.10241697722256826" id="n0.10241697722256826" role="heading" aria-level="3"><prefix style="text-align: left; padding-right: 0em;">10.2.1. </prefix><blocks><baselineblock class="inline"></baselineblock><block>Transfer Learning</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>What if we'd like to pick a set of embeddings which we fine tune later on?</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix style=""></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item full-line-block-inside" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="code-section-symbol inline" style="display: block;"><div class="code-section theme-tomorrow-night" style="display: block; border: 1px solid lightgray; background: rgb(45, 45, 45); padding: 10px; font-size: 10px;"><editarea class="text-mode code-section-edit-area" style="font-family: &quot;Fira code&quot;, &quot;Fira Mono&quot;, monospace;"><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">from</block><block class=" token"> sparknlp</block><block class="punctuation token">.</block><block class=" token">annotator </block><block class="keyword token">import</block><block class=" token"> BertEmbeddings</block><block class="punctuation token">,</block><block class=" token"> NerDLApproach</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">from</block><block class=" token"> pyspark</block><block class="punctuation token">.</block><block class=" token">ml </block><block class="keyword token">import</block><block class=" token"> Pipeline</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Define the pretrained BERT model </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">bert </block><block class="operator token">=</block><block class=" token"> </block><block class="punctuation token">(</block><block class=" token">BertEmbeddings</block><block class="punctuation token">.</block><block class=" token">pretrained</block><block class="punctuation token">(</block><block class="string token">"small_bert_L2_128"</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"en"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block><block class="punctuation token">.</block><block class=" token">setInputCols</block><block class="punctuation token">(</block><block class="string token">"document"</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"token"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">        </block><block class="punctuation token">.</block><block class=" token">setOutputCol</block><block class="punctuation token">(</block><block class="string token">"bert"</block><block class="punctuation token">)</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Define the NER approach</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">ner_dl </block><block class="operator token">=</block><block class=" token"> </block><block class="punctuation token">(</block><block class=" token">NerDLApproach</block><block class="punctuation token">(</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">          </block><block class="punctuation token">.</block><block class=" token">setInputCols</block><block class="punctuation token">(</block><block class="punctuation token">[</block><block class="string token">"document"</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"token"</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"bert"</block><block class="punctuation token">]</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">          </block><block class="punctuation token">.</block><block class=" token">setLabelColumn</block><block class="punctuation token">(</block><block class="string token">"label"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">          </block><block class="punctuation token">.</block><block class=" token">setOutputCol</block><block class="punctuation token">(</block><block class="string token">"ner"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">          </block><block class="punctuation token">.</block><block class=" token">setMaxEpochs</block><block class="punctuation token">(</block><block class="number token">10</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">          </block><block class="punctuation token">.</block><block class=" token">setLr</block><block class="punctuation token">(</block><block class="number token">0.001</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">          </block><block class="punctuation token">.</block><block class=" token">setValidationSplit</block><block class="punctuation token">(</block><block class="number token">0.2</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">          </block><block class="punctuation token">.</block><block class=" token">setBatchSize</block><block class="punctuation token">(</block><block class="number token">16</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">          </block><block class="punctuation token">.</block><block class=" token">setRandomSeed</block><block class="punctuation token">(</block><block class="number token">0</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">         </block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># put everything into the pipeline</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">ner_pipeline </block><block class="operator token">=</block><block class=" token"> </block><block class="punctuation token">(</block><block class=" token">Pipeline</block><block class="punctuation token">(</block><block class=" token">stages</block><block class="operator token">=</block><block class="punctuation token">[</block><block class=" token">bert</block><block class="punctuation token">,</block><block class=" token"> ner_dl</block><block class="punctuation token">]</block><block class="punctuation token">)</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">ner_model </block><block class="operator token">=</block><block class=" token"> ner_pipeline</block><block class="punctuation token">.</block><block class=" token">fit</block><block class="punctuation token">(</block><block class=" token">training_data</block><block class="punctuation token">.</block><block class=" token">limit</block><block class="punctuation token">(</block><block class="number token">100</block><block class="punctuation token">)</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Inference using the fine-tuned model</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">display</block><block class="punctuation token">(</block><block class=" token">ner_model</block><block class="punctuation token">.</block><block class=" token">transform</block><block class="punctuation token">(</block><block class=" token">test_data</block><block class="punctuation token">.</block><block class=" token">limit</block><block class="punctuation token">(</block><block class="number token">1</block><block class="punctuation token">)</block><block class="punctuation token">)</block><block class="punctuation token">.</block><block class=" token">select</block><block class="punctuation token">(</block><block class="string token">"text"</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"ner"</block><block class="punctuation token">)</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Use MLflow to log hyperparameters and the model object</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">key_list </block><block class="operator token">=</block><block class=" token"> </block><block class="punctuation token">[</block><block class="punctuation token">]</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">value_list </block><block class="operator token">=</block><block class=" token"> </block><block class="punctuation token">[</block><block class="punctuation token">]</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">for</block><block class=" token"> key</block><block class="punctuation token">,</block><block class=" token"> value </block><block class="keyword token">in</block><block class=" token"> ner_dl</block><block class="punctuation token">.</block><block class=" token">extractParamMap</block><block class="punctuation token">(</block><block class="punctuation token">)</block><block class="punctuation token">.</block><block class=" token">items</block><block class="punctuation token">(</block><block class="punctuation token">)</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    key_list</block><block class="punctuation token">.</block><block class=" token">append</block><block class="punctuation token">(</block><block class="builtin token">str</block><block class="punctuation token">(</block><block class=" token">key</block><block class="punctuation token">)</block><block class="punctuation token">.</block><block class=" token">partition</block><block class="punctuation token">(</block><block class="string token">"__"</block><block class="punctuation token">)</block><block class="punctuation token">[</block><block class="operator token">-</block><block class="number token">1</block><block class="punctuation token">]</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    value_list</block><block class="punctuation token">.</block><block class=" token">append</block><block class="punctuation token">(</block><block class=" token">value</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">hyperparam_dict </block><block class="operator token">=</block><block class=" token"> </block><block class="builtin token">dict</block><block class="punctuation token">(</block><block class="builtin token">zip</block><block class="punctuation token">(</block><block class=" token">key_list</block><block class="punctuation token">,</block><block class=" token"> value_list</block><block class="punctuation token">)</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">hyperparam_dict</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Out[15]: {'lazyAnnotator': False,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  'minEpochs': 0,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  'maxEpochs': 10,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  'lr': 0.001,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  'po': 0.005,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  'batchSize': 16,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  'dropout': 0.5,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  'verbose': 2,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  'useContrib': True,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  'validationSplit': 0.2,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  'evaluationLogExtended': False,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  'includeConfidence': False,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  'includeAllConfidenceScores': False,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  'enableOutputLogs': False,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  'enableMemoryOptimizer': False,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  'useBestModel': False,</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  'bestModelMetric': 'f1_micro',</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  'inputCols': ['document', 'token', 'bert'],</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  'labelColumn': 'label',</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  'outputCol': 'ner',</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  'randomSeed': 0}</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">import</block><block class=" token"> mlflow</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">with</block><block class=" token"> mlflow</block><block class="punctuation token">.</block><block class=" token">start_run</block><block class="punctuation token">(</block><block class="punctuation token">)</block><block class=" token"> </block><block class="keyword token">as</block><block class=" token"> run</block><block class="punctuation token">:</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    mlflow</block><block class="punctuation token">.</block><block class=" token">log_params</block><block class="punctuation token">(</block><block class=" token">hyperparam_dict</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">    mlflow</block><block class="punctuation token">.</block><block class=" token">spark</block><block class="punctuation token">.</block><block class=" token">log_model</block><block class="punctuation token">(</block><block class=" token">ner_model</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"ner_model"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Load the model using MLflow</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">loaded_model </block><block class="operator token">=</block><block class=" token"> mlflow</block><block class="punctuation token">.</block><block class=" token">spark</block><block class="punctuation token">.</block><block class=" token">load_model</block><block class="punctuation token">(</block><block class="string-interpolation string token">f"runs:/</block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">run</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">info</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">run_id</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">/ner_model"</block><block class="punctuation token">)</block></blocks></line></editarea></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix style=""></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; font-weight: bold;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold;">Model Inference</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Note that computing evaluation metrics is not available on the open-sourced version of SparkNLP. It's only available for the enterprise edition of SparkNLP. Refer to this </block><block class="role-hyper-link" data-hyper-link-url="https://nlp.johnsnowlabs.com/docs/en/evaluation#evaluating-ner-dl" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://nlp.johnsnowlabs.com/docs/en/evaluation#evaluating-ner-dl" target="_blank" style="color: inherit; text-decoration: inherit;">documentation</a></block><block>.</block></blocks></line><line class="root text-mode indent-2 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="3"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; color: rgb(0, 0, 0);">* </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">display(loaded_model.transform(test_data.limit(1)))</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix style=""></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; font-weight: bold;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold;">What if we would like to view the visualizations as well?</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix style=""></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item full-line-block-inside" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="code-section-symbol inline" style="display: block;"><div class="code-section theme-tomorrow-night" style="display: block; border: 1px solid lightgray; background: rgb(45, 45, 45); padding: 10px; font-size: 10px;"><editarea class="text-mode code-section-edit-area" style="font-family: &quot;Fira code&quot;, &quot;Fira Mono&quot;, monospace;"><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">from</block><block class=" token"> sparknlp</block><block class="punctuation token">.</block><block class=" token">base </block><block class="keyword token">import</block><block class=" token"> LightPipeline</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">light_model </block><block class="operator token">=</block><block class=" token"> LightPipeline</block><block class="punctuation token">(</block><block class=" token">ner_model</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">ann_text </block><block class="operator token">=</block><block class=" token"> light_model</block><block class="punctuation token">.</block><block class=" token">fullAnnotate</block><block class="punctuation token">(</block><block class=" token">sample_text</block><block class="punctuation token">)</block><block class="punctuation token">[</block><block class="number token">0</block><block class="punctuation token">]</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">ann_text</block><block class="punctuation token">.</block><block class=" token">keys</block><block class="punctuation token">(</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># dict_keys(['bert', 'ner'])</block></blocks></line></editarea></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix style=""></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; color: rgb(0, 0, 0);"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>If we run this we'll get an error:</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; font-weight: bold; color: rgb(0, 0, 0);"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; font-weight: bold; color: rgb(255, 64, 0);">displayHTML(visualizer.display(ann_text, label_col="entities", document_col="document", return_html=True))</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; color: rgb(0, 0, 0);"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>The error occurred because the visualization is expecting the column </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; font-weight: bold; color: rgb(255, 64, 0);">document</block><block> in the data. </block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="color: rgb(0, 0, 0); flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>However, the column is not present because our custom </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; font-weight: bold; color: rgb(255, 64, 0);">ner_pipeline</block><block> only produced </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; font-weight: bold; color: rgb(255, 64, 0);">bert</block><block> and </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; font-weight: bold; color: rgb(255, 64, 0);">ner</block><block> as our output columns! </block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="color: rgb(0, 0, 0); flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="text-decoration: underline;">To allow visualizations to work, we will need to construct the complete NLP pipeline, starting from assembling the text data, to tokenizing data, and then finally continue with the rest of the NER pipeline we have made above</block><block>!</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix style=""></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item full-line-block-inside" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="code-section-symbol inline" style="display: block;"><div class="code-section theme-tomorrow-night" style="display: block; border: 1px solid lightgray; background: rgb(45, 45, 45); padding: 10px; font-size: 10px;"><editarea class="text-mode code-section-edit-area" style="font-family: &quot;Fira code&quot;, &quot;Fira Mono&quot;, monospace;"><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">from</block><block class=" token"> sparknlp</block><block class="punctuation token">.</block><block class=" token">base </block><block class="keyword token">import</block><block class=" token"> DocumentAssembler</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">from</block><block class=" token"> sparknlp</block><block class="punctuation token">.</block><block class=" token">annotator </block><block class="keyword token">import</block><block class=" token"> SentenceDetector</block><block class="punctuation token">,</block><block class=" token"> Tokenizer</block><block class="punctuation token">,</block><block class=" token"> NerConverter</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">## Step 1: DocumentAssembler</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">## Prepares data into a format that is processable by Spark NLP. This is the entry point for every Spark NLP pipeline.</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">step1_document </block><block class="operator token">=</block><block class=" token"> </block><block class="punctuation token">(</block><block class=" token">DocumentAssembler</block><block class="punctuation token">(</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                  </block><block class="punctuation token">.</block><block class=" token">setInputCol</block><block class="punctuation token">(</block><block class="string token">"text"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                  </block><block class="punctuation token">.</block><block class=" token">setOutputCol</block><block class="punctuation token">(</block><block class="string token">"document"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                 </block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">### Step 2: SentenceDetector</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">### Annotator that detects sentence boundaries using any provided approach. </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">step2_sentence </block><block class="operator token">=</block><block class=" token"> </block><block class="punctuation token">(</block><block class=" token">SentenceDetector</block><block class="punctuation token">(</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                  </block><block class="punctuation token">.</block><block class=" token">setInputCols</block><block class="punctuation token">(</block><block class="string token">"document"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                  </block><block class="punctuation token">.</block><block class=" token">setOutputCol</block><block class="punctuation token">(</block><block class="string token">"sentence"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                 </block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># ### Step 3: Tokenizer</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">step3_tokenizer </block><block class="operator token">=</block><block class=" token"> </block><block class="punctuation token">(</block><block class=" token">Tokenizer</block><block class="punctuation token">(</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                   </block><block class="punctuation token">.</block><block class=" token">setInputCols</block><block class="punctuation token">(</block><block class="string token">"sentence"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                   </block><block class="punctuation token">.</block><block class=" token">setOutputCol</block><block class="punctuation token">(</block><block class="string token">"token"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                  </block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># ### Step 4: Apply embeddings</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">step4_embeddings </block><block class="operator token">=</block><block class=" token"> </block><block class="punctuation token">(</block><block class=" token">BertEmbeddings</block><block class="punctuation token">.</block><block class=" token">pretrained</block><block class="punctuation token">(</block><block class="string token">'small_bert_L2_128'</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">'en'</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                    </block><block class="punctuation token">.</block><block class=" token">setInputCols</block><block class="punctuation token">(</block><block class="punctuation token">[</block><block class="string token">"sentence"</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"token"</block><block class="punctuation token">]</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                    </block><block class="punctuation token">.</block><block class=" token">setOutputCol</block><block class="punctuation token">(</block><block class="string token">"bert"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                   </block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">### Step 5: NER </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">step5_ner_dl </block><block class="operator token">=</block><block class=" token"> loaded_model</block><block class="punctuation token">.</block><block class=" token">stages</block><block class="punctuation token">[</block><block class="operator token">-</block><block class="number token">1</block><block class="punctuation token">]</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">### NER Converter</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">### This converts the NER column to the right structure for visualizations.</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">step6_converter </block><block class="operator token">=</block><block class=" token"> </block><block class="punctuation token">(</block><block class=" token">NerConverter</block><block class="punctuation token">(</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                   </block><block class="punctuation token">.</block><block class=" token">setInputCols</block><block class="punctuation token">(</block><block class="punctuation token">[</block><block class="string token">"document"</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"token"</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"ner"</block><block class="punctuation token">]</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                   </block><block class="punctuation token">.</block><block class=" token">setOutputCol</block><block class="punctuation token">(</block><block class="string token">"ner_span"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                  </block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">full_ner_pipeline </block><block class="operator token">=</block><block class=" token"> Pipeline</block><block class="punctuation token">(</block><block class=" token">stages</block><block class="operator token">=</block><block class="punctuation token">[</block><block class=" token">step1_document</block><block class="punctuation token">,</block><block class=" token"> step2_sentence</block><block class="punctuation token">,</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                                     step3_tokenizer</block><block class="punctuation token">,</block><block class=" token"> step4_embeddings</block><block class="punctuation token">,</block><block class=" token"> </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                                     step5_ner_dl</block><block class="punctuation token">,</block><block class=" token"> step6_converter</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                                    </block><block class="punctuation token">]</block><block class="punctuation token">)</block></blocks></line></editarea></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix style=""></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>According to the documentation, </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">LightPipeline</block><block> is equivalent to SparkML Pipeline but much faster with small amounts of data.</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Refer to documentation </block><block class="role-hyper-link" data-hyper-link-url="https://nlp.johnsnowlabs.com/api/python/reference/autosummary/sparknlp.base.LightPipeline.html" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://nlp.johnsnowlabs.com/api/python/reference/autosummary/sparknlp.base.LightPipeline.html" target="_blank" style="color: inherit; text-decoration: inherit;">here</a></block><block>.</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix style=""></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item full-line-block-inside" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="code-section-symbol inline" style="display: block;"><div class="code-section theme-tomorrow-night" style="display: block; border: 1px solid lightgray; background: rgb(45, 45, 45); padding: 10px; font-size: 10px;"><editarea class="text-mode code-section-edit-area" style="font-family: &quot;Fira code&quot;, &quot;Fira Mono&quot;, monospace;"><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">prediction_model </block><block class="operator token">=</block><block class=" token"> full_ner_pipeline</block><block class="punctuation token">.</block><block class=" token">fit</block><block class="punctuation token">(</block><block class=" token">training_data</block><block class="punctuation token">.</block><block class=" token">limit</block><block class="punctuation token">(</block><block class="number token">100</block><block class="punctuation token">)</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">light_model </block><block class="operator token">=</block><block class=" token"> LightPipeline</block><block class="punctuation token">(</block><block class=" token">prediction_model</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">ann_text </block><block class="operator token">=</block><block class=" token"> light_model</block><block class="punctuation token">.</block><block class=" token">fullAnnotate</block><block class="punctuation token">(</block><block class=" token">sample_text</block><block class="punctuation token">)</block><block class="punctuation token">[</block><block class="number token">0</block><block class="punctuation token">]</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">ann_text</block><block class="punctuation token">.</block><block class=" token">keys</block><block class="punctuation token">(</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># dict_keys(['document', 'ner_span', 'token', 'ner', 'bert', 'sentence'])</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">ner_vis_complete </block><block class="operator token">=</block><block class=" token"> visualizer</block><block class="punctuation token">.</block><block class=" token">display</block><block class="punctuation token">(</block><block class=" token">ann_text</block><block class="punctuation token">,</block><block class=" token"> label_col</block><block class="operator token">=</block><block class="string token">"ner_span"</block><block class="punctuation token">,</block><block class=" token"> document_col</block><block class="operator token">=</block><block class="string token">"document"</block><block class="punctuation token">,</block><block class=" token"> return_html</block><block class="operator token">=</block><block class="boolean token">True</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">displayHTML</block><block class="punctuation token">(</block><block class=" token">ner_vis_complete</block><block class="punctuation token">)</block></blocks></line></editarea></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 673.589px; height: 98.69px; position: relative;"><img src="image-resources/634b9325-f66c-4b3c-a106-0c961f144046.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; font-weight: bold;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold;">What differences did you notice between using the out-of-the-box pretrained model vs. fine-tuning BERT embeddings for an additional 10 epochs in the results of NER?</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; font-weight: bold;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold;">How do the results differ from the ground truth labels?</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix style=""></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item full-line-block-inside" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="code-section-symbol inline" style="display: block;"><div class="code-section theme-tomorrow-night" style="display: block; border: 1px solid lightgray; background: rgb(45, 45, 45); padding: 10px; font-size: 10px;"><editarea class="text-mode code-section-edit-area" style="font-family: &quot;Fira code&quot;, &quot;Fira Mono&quot;, monospace;"><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">import</block><block class=" token"> pyspark</block><block class="punctuation token">.</block><block class=" token">sql</block><block class="punctuation token">.</block><block class=" token">functions </block><block class="keyword token">as</block><block class=" token"> F</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">ground_truth </block><block class="operator token">=</block><block class=" token"> </block><block class="punctuation token">(</block><block class=" token">training_data</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                </block><block class="punctuation token">.</block><block class=" token">limit</block><block class="punctuation token">(</block><block class="number token">1</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                </block><block class="punctuation token">.</block><block class=" token">select</block><block class="punctuation token">(</block><block class="string token">"label"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                </block><block class="punctuation token">.</block><block class=" token">select</block><block class="punctuation token">(</block><block class=" token">F</block><block class="punctuation token">.</block><block class=" token">explode</block><block class="punctuation token">(</block><block class="string token">"label"</block><block class="punctuation token">)</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                </block><block class="punctuation token">.</block><block class=" token">select</block><block class="punctuation token">(</block><block class=" token">F</block><block class="punctuation token">.</block><block class=" token">expr</block><block class="punctuation token">(</block><block class="string token">"col.metadata['word']"</block><block class="punctuation token">)</block><block class="punctuation token">.</block><block class=" token">alias</block><block class="punctuation token">(</block><block class="string token">"word"</block><block class="punctuation token">)</block><block class="punctuation token">,</block><block class=" token"> F</block><block class="punctuation token">.</block><block class=" token">expr</block><block class="punctuation token">(</block><block class="string token">"col.result"</block><block class="punctuation token">)</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                </block><block class="punctuation token">.</block><block class="builtin token">filter</block><block class="punctuation token">(</block><block class=" token">F</block><block class="punctuation token">.</block><block class=" token">col</block><block class="punctuation token">(</block><block class="string token">"result"</block><block class="punctuation token">)</block><block class=" token"> </block><block class="operator token">!=</block><block class=" token"> </block><block class="string token">"O"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">               </block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">display</block><block class="punctuation token">(</block><block class=" token">ground_truth</block><block class="punctuation token">)</block></blocks></line></editarea></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix style=""></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://huggingface.co/" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://huggingface.co/" target="_blank" style="color: inherit; text-decoration: inherit;">HuggingFace</a></block><block> is another popular NLP library and hub for transformers and generative AI. </block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Hugging Face has recently been integrated into MLflow and is able to be used in conjunction with Databricks and Spark. </block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>You'll interact with the </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">mlflow.transformers</block><block> to access the functionallity of transformers within MLflow.</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://docs.databricks.com/machine-learning/train-model/huggingface/index.html" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://docs.databricks.com/machine-learning/train-model/huggingface/index.html" target="_blank" style="color: inherit; text-decoration: inherit;">Hugging Face Transformers</a></block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://www.databricks.com/blog/2023/02/06/getting-started-nlp-using-hugging-face-transformers-pipelines.html" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://www.databricks.com/blog/2023/02/06/getting-started-nlp-using-hugging-face-transformers-pipelines.html" target="_blank" style="color: inherit; text-decoration: inherit;">Getting started with NLP using Hugging Face transformers pipelines</a></block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://www.databricks.com/blog/2022/09/09/rapid-nlp-development-databricks-delta-and-transformers.html" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://www.databricks.com/blog/2022/09/09/rapid-nlp-development-databricks-delta-and-transformers.html" target="_blank" style="color: inherit; text-decoration: inherit;">Rapid NLP Development with Databricks, Delta, and Transformers</a></block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block class="role-hyper-link" data-hyper-link-url="https://medium.com/@tim.lortz/making-transformer-based-models-first-class-citizens-in-the-lakehouse-cf900cf604d4" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://medium.com/@tim.lortz/making-transformer-based-models-first-class-citizens-in-the-lakehouse-cf900cf604d4" target="_blank" style="color: inherit; text-decoration: inherit;">Making Transformer-Based Models First-Class Citizens in the Lakehouse</a></block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix style=""></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">[</block><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><compositeblock dir="ltr" class="anchor-tag-ref inline" style="font-family: &quot;Computer Modern Serif&quot;, serif; background-color: rgba(155, 155, 155, 0.2);"><a href="#n0.3715415633810799" style="color: inherit; text-decoration: inherit;">Back To Top</a></compositeblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">]</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode section sindent-1" style="line-height: 1.4; font-size: 1.1em; padding-top: 0.5em; padding-bottom: 0.5em; font-weight: bold;" data-line-id="n0.3816963599102581" id="n0.3816963599102581" role="heading" aria-level="2"><prefix style="text-align: left; padding-right: 0.25em;">10.3. </prefix><blocks><baselineblock class="inline"></baselineblock><block>Document Classification</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>In this section, we will use transfer learning to classify </block><block class="role-hyper-link" data-hyper-link-url="https://newscatcherapi.com/" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://newscatcherapi.com/" target="_blank" style="color: inherit; text-decoration: inherit;">news topics collected by the NewsCatcher team</a></block><block>, who collect and index news articles and release them to the open-source community. </block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>The dataset can be downloaded from </block><block class="role-hyper-link" data-hyper-link-url="https://www.kaggle.com/kotartemiy/topic-labeled-news-dataset" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://www.kaggle.com/kotartemiy/topic-labeled-news-dataset" target="_blank" style="color: inherit; text-decoration: inherit;">Kaggle</a></block><block>.</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>We will fine-tune a pretrained model to classify the topics of the news.</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix style=""></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; color: rgb(0, 0, 0);"> </prefix><blocks><baselineblock class="inline"></baselineblock><block>Library requirement:</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; color: rgb(0, 0, 0);"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">%pip install spark-nlp==4.2.5</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix style=""></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item full-line-block-inside" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="code-section-symbol inline" style="display: block;"><div class="code-section theme-tomorrow-night" style="display: block; border: 1px solid lightgray; background: rgb(45, 45, 45); padding: 10px; font-size: 10px;"><editarea class="text-mode code-section-edit-area" style="font-family: &quot;Fira code&quot;, &quot;Fira Mono&quot;, monospace;"><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  Read training data</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">df </block><block class="operator token">=</block><block class=" token"> </block><block class="punctuation token">(</block><block class=" token">spark</block><block class="punctuation token">.</block><block class=" token">read</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">      </block><block class="punctuation token">.</block><block class=" token">option</block><block class="punctuation token">(</block><block class="string token">"header"</block><block class="punctuation token">,</block><block class=" token"> </block><block class="boolean token">True</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">      </block><block class="punctuation token">.</block><block class=" token">option</block><block class="punctuation token">(</block><block class="string token">"sep"</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">";"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">      </block><block class="punctuation token">.</block><block class="builtin token">format</block><block class="punctuation token">(</block><block class="string token">"csv"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">      </block><block class="punctuation token">.</block><block class=" token">load</block><block class="punctuation token">(</block><block class="string-interpolation string token">f"</block><block class="string-interpolation interpolation punctuation token">{</block><block class="string-interpolation interpolation token">DA</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">paths</block><block class="string-interpolation interpolation punctuation token">.</block><block class="string-interpolation interpolation token">datasets</block><block class="string-interpolation interpolation punctuation token">}</block><block class="string-interpolation string token">/news/labelled_newscatcher_dataset.csv"</block><block class="punctuation token">)</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">train_df</block><block class="punctuation token">,</block><block class=" token"> test_df </block><block class="operator token">=</block><block class=" token"> df</block><block class="punctuation token">.</block><block class=" token">randomSplit</block><block class="punctuation token">(</block><block class="punctuation token">[</block><block class="number token">0.8</block><block class="punctuation token">,</block><block class=" token"> </block><block class="number token">0.2</block><block class="punctuation token">]</block><block class="punctuation token">,</block><block class=" token"> seed</block><block class="operator token">=</block><block class="number token">42</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">display</block><block class="punctuation token">(</block><block class=" token">train_df</block><block class="punctuation token">)</block></blocks></line></editarea></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix style=""></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode section sindent-2" style="line-height: 1.4; font-size: 1em; padding-top: 0.5em; padding-bottom: 0.5em; font-weight: bold;" data-line-id="n0.8858277047277492" id="n0.8858277047277492" role="heading" aria-level="3"><prefix style="text-align: left; padding-right: 0em;">10.3.1. </prefix><blocks><baselineblock class="inline"></baselineblock><block>Build the Text Classifier Pipeline</block></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; font-weight: bold;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold;">Instructions:</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;">1. </prefix><blocks><baselineblock class="inline"></baselineblock><block>Use </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">DocumentAssembler</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;">2. </prefix><blocks><baselineblock class="inline"></baselineblock><block>You will use </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">UniversalSentenceEncoder</block><block> for the first time. </block></blocks></line><line class="root text-mode indent-2 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="3"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;">* </prefix><blocks><baselineblock class="inline"></baselineblock><block>Refer to the </block><block class="role-hyper-link" data-hyper-link-url="https://nlp.johnsnowlabs.com/docs/en/transformers#universalsentenceencoder" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://nlp.johnsnowlabs.com/docs/en/transformers#universalsentenceencoder" target="_blank" style="color: inherit; text-decoration: inherit;">documentation</a></block><block> on </block><block style="font-weight: bold; color: rgb(255, 64, 0);">Universal Sentence Encoder</block><block> to see an example of how you can build such an encoder. </block></blocks></line><line class="root text-mode indent-2 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="3"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;">* </prefix><blocks><baselineblock class="inline"></baselineblock><block>This is a </block><block class="role-hyper-link" data-hyper-link-url="https://arxiv.org/pdf/1803.11175.pdf" style="color: rgb(17, 85, 204);"><a href="https://arxiv.org/pdf/1803.11175.pdf" target="_blank" style="color: inherit; text-decoration: inherit;">pretrained model published by Google on TFhub</a></block><block style="text-decoration: none;"> and SparkNLP</block><block> provides a wrapper to use this model efficiently with Spark.</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;">3. </prefix><blocks><baselineblock class="inline"></baselineblock><block>You will need to build a </block><block class="role-hyper-link" data-hyper-link-url="https://nlp.johnsnowlabs.com/docs/en/annotators#classifierdl" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://nlp.johnsnowlabs.com/docs/en/annotators#classifierdl" target="_blank" style="color: inherit; text-decoration: inherit;">text classifier</a></block><block>. </block></blocks></line><line class="root text-mode indent-2 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="3"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;">* </prefix><blocks><baselineblock class="inline"></baselineblock><block>This model uses embeddings from the </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">UniversalSentenceEncoder</block><block> and was originally trained on the </block><block style="font-weight: bold;">TREC6 dataset</block><block>, which is another common </block><block style="text-decoration: underline;">benchmarking dataset that classifies fact-based questions into different semantic categories</block><block>. </block></blocks></line><line class="root text-mode indent-2 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="3"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;">* </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold;">TREC</block><block> stands for </block><block style="font-weight: bold;">Text REtrieval Conference</block><block>. </block></blocks></line><line class="root text-mode indent-2 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="3"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;">* </prefix><blocks><baselineblock class="inline"></baselineblock><block>More about the TREC dataset </block><block class="role-hyper-link" data-hyper-link-url="https://trec.nist.gov/data/qa.html" style="text-decoration: underline; color: rgb(17, 85, 204);"><a href="https://trec.nist.gov/data/qa.html" target="_blank" style="color: inherit; text-decoration: inherit;">here</a></block><block>.</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;">4. </prefix><blocks><baselineblock class="inline"></baselineblock><block>Set the </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">maxEpochs</block><block> to be </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">3</block><block>. </block></blocks></line><line class="root text-mode indent-2 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="3"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;">* </prefix><blocks><baselineblock class="inline"></baselineblock><block>This number determines how many epochs you want to fine-tune the pretrained model.</block></blocks></line><line class="root text-mode indent-1 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="2"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;">5. </prefix><blocks><baselineblock class="inline"></baselineblock><block>Compile the stages above into a pipeline.</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix style=""></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item full-line-block-inside" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="code-section-symbol inline" style="display: block;"><div class="code-section theme-tomorrow-night" style="display: block; border: 1px solid lightgray; background: rgb(45, 45, 45); padding: 10px; font-size: 10px;"><editarea class="text-mode code-section-edit-area" style="font-family: &quot;Fira code&quot;, &quot;Fira Mono&quot;, monospace;"><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">from</block><block class=" token"> sparknlp</block><block class="punctuation token">.</block><block class=" token">base </block><block class="keyword token">import</block><block class=" token"> DocumentAssembler</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">from</block><block class=" token"> sparknlp</block><block class="punctuation token">.</block><block class=" token">annotator </block><block class="keyword token">import</block><block class=" token"> UniversalSentenceEncoder</block><block class="punctuation token">,</block><block class=" token"> ClassifierDLApproach</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">from</block><block class=" token"> pyspark</block><block class="punctuation token">.</block><block class=" token">ml </block><block class="keyword token">import</block><block class=" token"> Pipeline</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">document </block><block class="operator token">=</block><block class=" token"> </block><block class="punctuation token">(</block><block class=" token">DocumentAssembler</block><block class="punctuation token">(</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">           </block><block class="punctuation token">.</block><block class=" token">setInputCol</block><block class="punctuation token">(</block><block class="string token">"title"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">           </block><block class="punctuation token">.</block><block class=" token">setOutputCol</block><block class="punctuation token">(</block><block class="string token">"document"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">           </block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">encoder </block><block class="operator token">=</block><block class=" token"> </block><block class="punctuation token">(</block><block class=" token">UniversalSentenceEncoder</block><block class="punctuation token">.</block><block class=" token">pretrained</block><block class="punctuation token">(</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">          </block><block class="punctuation token">.</block><block class=" token">setInputCols</block><block class="punctuation token">(</block><block class="punctuation token">[</block><block class="string token">"document"</block><block class="punctuation token">]</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">          </block><block class="punctuation token">.</block><block class=" token">setOutputCol</block><block class="punctuation token">(</block><block class="string token">"sentence_embeddings"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">          </block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">text_classifier </block><block class="operator token">=</block><block class=" token"> </block><block class="punctuation token">(</block><block class=" token">ClassifierDLApproach</block><block class="punctuation token">(</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                   </block><block class="punctuation token">.</block><block class=" token">setInputCols</block><block class="punctuation token">(</block><block class="punctuation token">[</block><block class="string token">"sentence_embeddings"</block><block class="punctuation token">]</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                   </block><block class="punctuation token">.</block><block class=" token">setOutputCol</block><block class="punctuation token">(</block><block class="string token">"class"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                   </block><block class="punctuation token">.</block><block class=" token">setLabelColumn</block><block class="punctuation token">(</block><block class="string token">"topic"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                   </block><block class="punctuation token">.</block><block class=" token">setMaxEpochs</block><block class="punctuation token">(</block><block class="number token">3</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                  </block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">classifier_pipeline </block><block class="operator token">=</block><block class=" token"> </block><block class="punctuation token">(</block><block class=" token">Pipeline</block><block class="punctuation token">(</block><block class=" token">stages</block><block class="operator token">=</block><block class="punctuation token">[</block><block class=" token">document</block><block class="punctuation token">,</block><block class=" token"> encoder</block><block class="punctuation token">,</block><block class=" token"> text_classifier</block><block class="punctuation token">]</block><block class="punctuation token">)</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Use classifier_pipeline to train the model and name it as pipeline_model.</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">pipeline_model </block><block class="operator token">=</block><block class=" token"> classifier_pipeline</block><block class="punctuation token">.</block><block class=" token">fit</block><block class="punctuation token">(</block><block class=" token">train_df</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># Model inference</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">display</block><block class="punctuation token">(</block><block class=" token">test_df</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">import</block><block class=" token"> pyspark</block><block class="punctuation token">.</block><block class=" token">sql</block><block class="punctuation token">.</block><block class=" token">functions </block><block class="keyword token">as</block><block class=" token"> F</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">prediction_df </block><block class="operator token">=</block><block class=" token"> pipeline_model</block><block class="punctuation token">.</block><block class=" token">transform</block><block class="punctuation token">(</block><block class=" token">test_df</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">display</block><block class="punctuation token">(</block><block class=" token">prediction_df</block><block class="punctuation token">.</block><block class=" token">select</block><block class="punctuation token">(</block><block class="string token">"title"</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"topic"</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"class.result"</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"class.metadata"</block><block class="punctuation token">)</block><block class="punctuation token">)</block></blocks></line></editarea></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix style=""></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 680.561px; height: 243.9px; position: relative;"><img src="image-resources/b9cb8f40-54b1-4856-bb81-7388a42cfe3b.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold; background-color: rgb(255, 254, 0);">Note:</block><block> Notice that the </block><block style="font-family: &quot;Computer Modern Typewriter&quot;, serif; color: rgb(231, 55, 61);">result</block><block> column is an array because SparkNLP allows you to have multiple sentences in each row. Let's extract the prediction from the array below.</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix style=""></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item full-line-block-inside" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="code-section-symbol inline" style="display: block;"><div class="code-section theme-tomorrow-night" style="display: block; border: 1px solid lightgray; background: rgb(45, 45, 45); padding: 10px; font-size: 10px;"><editarea class="text-mode code-section-edit-area" style="font-family: &quot;Fira code&quot;, &quot;Fira Mono&quot;, monospace;"><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">prediction_df </block><block class="operator token">=</block><block class=" token"> </block><block class="punctuation token">(</block><block class=" token">prediction_df</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                 </block><block class="punctuation token">.</block><block class=" token">select</block><block class="punctuation token">(</block><block class="string token">"title"</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"topic"</block><block class="punctuation token">,</block><block class=" token"> </block><block class="string token">"class.result"</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                 </block><block class="punctuation token">.</block><block class=" token">withColumn</block><block class="punctuation token">(</block><block class="string token">"result"</block><block class="punctuation token">,</block><block class=" token"> F</block><block class="punctuation token">.</block><block class=" token">col</block><block class="punctuation token">(</block><block class="string token">"result"</block><block class="punctuation token">)</block><block class="punctuation token">[</block><block class="number token">0</block><block class="punctuation token">]</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">                </block><block class="punctuation token">)</block><block class=" token">   </block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">display</block><block class="punctuation token">(</block><block class=" token">prediction_df</block><block class="punctuation token">)</block></blocks></line></editarea></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix style=""></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode full-line-block-inside" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="image-container no-cursor-selected no-editor"><image-viewer class=""><image-container class="center"><div class="image-content" style="width: 682.795px; height: 157.37px; position: relative;"><img src="image-resources/353492d0-f546-411d-9093-02a63be3a34f.png" style="width: 100%; height: 100%; box-sizing: border-box; border-radius: 0px;"></div></image-container></image-viewer><div style="display: none;"></div></compositeblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; font-weight: bold;"> </prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-weight: bold;">Evaluation</block></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix style=""></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode indent-0 has-indent list-item full-line-block-inside" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><compositeblock dir="ltr" class="code-section-symbol inline" style="display: block;"><div class="code-section theme-tomorrow-night" style="display: block; border: 1px solid lightgray; background: rgb(45, 45, 45); padding: 10px; font-size: 10px;"><editarea class="text-mode code-section-edit-area" style="font-family: &quot;Fira code&quot;, &quot;Fira Mono&quot;, monospace;"><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">from</block><block class=" token"> sklearn</block><block class="punctuation token">.</block><block class=" token">metrics </block><block class="keyword token">import</block><block class=" token"> classification_report</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class=" token">prediction_pdf </block><block class="operator token">=</block><block class=" token"> prediction_df</block><block class="punctuation token">.</block><block class=" token">toPandas</block><block class="punctuation token">(</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="keyword token">print</block><block class="punctuation token">(</block><block class=" token">classification_report</block><block class="punctuation token">(</block><block class=" token">prediction_pdf</block><block class="punctuation token">[</block><block class="string token">"result"</block><block class="punctuation token">]</block><block class="punctuation token">,</block><block class=" token"> prediction_pdf</block><block class="punctuation token">[</block><block class="string token">"topic"</block><block class="punctuation token">]</block><block class="punctuation token">)</block><block class="punctuation token">)</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#                precision    recall  f1-score   support</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#      BUSINESS       0.72      0.76      0.74      2785</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token"># ENTERTAINMENT       0.87      0.81      0.84      3145</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#        HEALTH       0.81      0.67      0.74      3639</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#        NATION       0.57      0.61      0.59      2797</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#       SCIENCE       0.77      0.76      0.76       737</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#        SPORTS       0.91      0.92      0.91      2909</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#    TECHNOLOGY       0.87      0.86      0.87      3029</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#         WORLD       0.55      0.67      0.61      2524</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#      accuracy                           0.76     21565</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#     macro avg       0.76      0.76      0.76     21565</block></blocks></line><line class="text-mode code-section-line"><prefix></prefix><blocks class="code-line-blocks-container"><baselineblock></baselineblock><block class="comment token">#  weighted avg       0.77      0.76      0.76     21565</block></blocks></line></editarea></div></compositeblock></blocks></line><line class="root text-mode indent-0 has-indent list-item" style="line-height: 1.4;" role="listitem" aria-level="1"><prefix style="flex-shrink: 0; min-width: 1em; text-align: left; visibility: hidden;"> </prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode" style="line-height: 1.4;"><prefix style=""></prefix><blocks><baselineblock class="inline"></baselineblock><emptyblock aria-label="empty line"> </emptyblock></blocks></line><line class="root text-mode selected" style="line-height: 1.4;"><prefix></prefix><blocks><baselineblock class="inline"></baselineblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">[</block><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><compositeblock dir="ltr" class="anchor-tag-ref inline" style="font-family: &quot;Computer Modern Serif&quot;, serif; background-color: rgba(155, 155, 155, 0.2);"><a href="#n0.3715415633810799" style="color: inherit; text-decoration: inherit;">Back To Top</a></compositeblock><block style="font-family: &quot;Computer Modern Serif&quot;, serif;"> </block><block style="font-family: &quot;Computer Modern Serif&quot;, serif; color: rgb(231, 55, 61);">]</block></blocks></line></area-container></editarea><div></div></math-edit-container></math-type></editor-container></body></html>